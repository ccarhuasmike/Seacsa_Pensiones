VERSION 5.00
Object = "{5E9E78A0-531B-11CF-91F6-C2863C385E30}#1.0#0"; "msflxgrd.ocx"
Object = "{BDC217C8-ED16-11CD-956C-0000C04E4C0A}#1.1#0"; "tabctl32.ocx"
Object = "{00025600-0000-0000-C000-000000000046}#5.2#0"; "Crystl32.OCX"
Begin VB.Form Frm_EndosoPol 
   BorderStyle     =   1  'Fixed Single
   Caption         =   "Mantenedor de Endosos Simples y Actuariales."
   ClientHeight    =   13155
   ClientLeft      =   2100
   ClientTop       =   1395
   ClientWidth     =   11925
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   MDIChild        =   -1  'True
   MinButton       =   0   'False
   ScaleHeight     =   13155
   ScaleWidth      =   11925
   Begin VB.Frame Fra_Poliza 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00800000&
      Height          =   975
      Left            =   120
      TabIndex        =   151
      Top             =   0
      Width           =   9975
      Begin VB.CommandButton Cmd_BuscarPol 
         Height          =   345
         Left            =   7920
         Picture         =   "Frm_EndosoPol.frx":0000
         Style           =   1  'Graphical
         TabIndex        =   4
         ToolTipText     =   "Buscar Póliza"
         Top             =   180
         Width           =   615
      End
      Begin VB.CommandButton Cmd_Buscar 
         BackColor       =   &H00000000&
         Caption         =   "?"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   14.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   345
         Left            =   7920
         Picture         =   "Frm_EndosoPol.frx":0102
         TabIndex        =   5
         ToolTipText     =   "Buscar"
         Top             =   520
         Width           =   615
      End
      Begin VB.TextBox Txt_PenPoliza 
         Height          =   285
         Left            =   840
         MaxLength       =   10
         TabIndex        =   0
         Top             =   240
         Width           =   1185
      End
      Begin VB.TextBox Txt_PenNumIdent 
         Height          =   285
         Left            =   4560
         MaxLength       =   16
         TabIndex        =   2
         Top             =   240
         Width           =   1635
      End
      Begin VB.ComboBox Cmb_PenNumIdent 
         BackColor       =   &H00E0FFFF&
         Height          =   315
         Left            =   2880
         Style           =   2  'Dropdown List
         TabIndex        =   1
         Top             =   240
         Width           =   1635
      End
      Begin VB.CommandButton Cmd_BuscarPendiente 
         Caption         =   "PRE"
         Height          =   680
         Left            =   8640
         Picture         =   "Frm_EndosoPol.frx":0204
         Style           =   1  'Graphical
         TabIndex        =   7
         ToolTipText     =   "Buscar Póliza"
         Top             =   180
         Width           =   615
      End
      Begin VB.Label Lbl_Nombre 
         Caption         =   "N° Póliza"
         Height          =   255
         Index           =   80
         Left            =   120
         TabIndex        =   192
         Top             =   240
         Width           =   855
      End
      Begin VB.Label Lbl_PenNombre 
         BackColor       =   &H00E0FFFF&
         BorderStyle     =   1  'Fixed Single
         Enabled         =   0   'False
         Height          =   255
         Left            =   840
         TabIndex        =   190
         Top             =   600
         Width           =   6975
      End
      Begin VB.Label Lbl_Nombre 
         Caption         =   "N° Ident."
         Height          =   255
         Index           =   0
         Left            =   2160
         TabIndex        =   189
         Top             =   240
         Width           =   855
      End
      Begin VB.Label Lbl_Nombre 
         AutoSize        =   -1  'True
         Caption         =   "N° End. Actual"
         Height          =   195
         Index           =   42
         Left            =   6240
         TabIndex        =   188
         Top             =   240
         Width           =   1050
      End
      Begin VB.Label Lbl_End 
         BackColor       =   &H80000018&
         BorderStyle     =   1  'Fixed Single
         Enabled         =   0   'False
         Height          =   285
         Left            =   7320
         TabIndex        =   3
         Top             =   240
         Width           =   480
      End
      Begin VB.Label Label8 
         Caption         =   " Póliza que se desea Endosar"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   255
         Left            =   120
         TabIndex        =   152
         Top             =   0
         Width           =   2655
      End
      Begin VB.Label Lbl_Nombre 
         Caption         =   "Nombre"
         Height          =   255
         Index           =   43
         Left            =   120
         TabIndex        =   191
         Top             =   600
         Width           =   855
      End
   End
   Begin TabDlg.SSTab SSTab_EndosoPoliza 
      Height          =   12015
      Left            =   105
      TabIndex        =   6
      Top             =   1035
      Width           =   10335
      _ExtentX        =   18230
      _ExtentY        =   21193
      _Version        =   393216
      Tabs            =   2
      Tab             =   1
      TabsPerRow      =   1
      TabHeight       =   520
      ForeColor       =   8388608
      TabCaption(0)   =   "Antecedentes de Póliza Original"
      TabPicture(0)   =   "Frm_EndosoPol.frx":0306
      Tab(0).ControlEnabled=   0   'False
      Tab(0).Control(0)=   "SSTab_PolizaOriginal"
      Tab(0).ControlCount=   1
      TabCaption(1)   =   "Modificación de Antecedentes de Póliza a Endosar"
      TabPicture(1)   =   "Frm_EndosoPol.frx":0322
      Tab(1).ControlEnabled=   -1  'True
      Tab(1).Control(0)=   "SSTab_PolizaModificada"
      Tab(1).Control(0).Enabled=   0   'False
      Tab(1).Control(1)=   "Fra_Endoso"
      Tab(1).Control(1).Enabled=   0   'False
      Tab(1).Control(2)=   "Frame1"
      Tab(1).Control(2).Enabled=   0   'False
      Tab(1).ControlCount=   3
      Begin VB.Frame Frame1 
         Height          =   1560
         Left            =   6705
         TabIndex        =   294
         Top             =   600
         Width           =   3255
         Begin VB.TextBox txt_EndMtoPensionCalcGar 
            Height          =   285
            Left            =   1320
            MaxLength       =   10
            TabIndex        =   298
            Top             =   1200
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.TextBox txt_EndMtoPensionOrigGar 
            Height          =   285
            Left            =   1320
            MaxLength       =   10
            TabIndex        =   297
            Top             =   560
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.TextBox txt_EndMtoPensionOrig 
            Height          =   285
            Left            =   1320
            MaxLength       =   10
            TabIndex        =   296
            Top             =   240
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.TextBox txt_EndMtoPensionCalc 
            Height          =   285
            Left            =   1320
            MaxLength       =   10
            TabIndex        =   295
            Top             =   915
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.Line Line4 
            BorderColor     =   &H80000010&
            X1              =   120
            X2              =   2760
            Y1              =   840
            Y2              =   840
         End
         Begin VB.Label Lbl_EndMtoPensionOrig 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   1320
            TabIndex        =   308
            Top             =   240
            Width           =   855
         End
         Begin VB.Label Lbl_EndMtoPensionCalc 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   1320
            TabIndex        =   307
            Top             =   915
            Width           =   855
         End
         Begin VB.Label lbl_EndMtoPensionCalcGar 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   1320
            TabIndex        =   306
            Top             =   1200
            Width           =   855
         End
         Begin VB.Label lbl_EndMtoPensionOrigGar 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   1320
            TabIndex        =   305
            Top             =   560
            Width           =   855
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Pensión Ori."
            Height          =   255
            Index           =   70
            Left            =   120
            TabIndex        =   304
            Top             =   285
            Width           =   1275
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Pensión Actual"
            Height          =   255
            Index           =   56
            Left            =   120
            TabIndex        =   303
            Top             =   960
            Width           =   1215
         End
         Begin VB.Label Lbl_MonPension 
            Caption         =   "(TM)"
            Height          =   285
            Index           =   2
            Left            =   2520
            TabIndex        =   302
            Top             =   360
            Width           =   495
         End
         Begin VB.Label Lbl_MonPension 
            Caption         =   "(TM)"
            Height          =   285
            Index           =   3
            Left            =   2520
            TabIndex        =   301
            Top             =   1080
            Width           =   375
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Pens. Gar. Ori."
            Height          =   255
            Index           =   104
            Left            =   120
            TabIndex        =   300
            Top             =   600
            Width           =   1155
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "PensGar. Act."
            Height          =   255
            Index           =   105
            Left            =   120
            TabIndex        =   299
            Top             =   1245
            Width           =   1215
         End
      End
      Begin VB.Frame Fra_Endoso 
         Caption         =   "  Características del Endoso"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00808000&
         Height          =   1560
         Left            =   240
         TabIndex        =   127
         Top             =   600
         Width           =   6375
         Begin VB.CommandButton Cmd_BuscarFecEfe 
            Caption         =   ".FE."
            Height          =   285
            Left            =   2520
            TabIndex        =   9
            Top             =   915
            Width           =   450
         End
         Begin VB.TextBox Txt_EndFecEfecto 
            BackColor       =   &H80000018&
            Enabled         =   0   'False
            Height          =   285
            Left            =   1320
            TabIndex        =   8
            Top             =   915
            Width           =   1215
         End
         Begin VB.TextBox Txt_EndObs 
            Height          =   525
            Left            =   4080
            MaxLength       =   50
            MultiLine       =   -1  'True
            TabIndex        =   13
            Top             =   960
            Width           =   2175
         End
         Begin VB.TextBox Txt_EndFecEnd 
            Height          =   285
            Left            =   1320
            MaxLength       =   10
            TabIndex        =   10
            Top             =   1200
            Width           =   1215
         End
         Begin VB.ComboBox Cmb_EndCauEnd 
            BackColor       =   &H00E0FFFF&
            Height          =   315
            ItemData        =   "Frm_EndosoPol.frx":033E
            Left            =   720
            List            =   "Frm_EndosoPol.frx":0340
            Style           =   2  'Dropdown List
            TabIndex        =   12
            Top             =   540
            Width           =   5535
         End
         Begin VB.ComboBox Cmb_EndTipoEnd 
            BackColor       =   &H00E0FFFF&
            Height          =   315
            ItemData        =   "Frm_EndosoPol.frx":0342
            Left            =   720
            List            =   "Frm_EndosoPol.frx":0344
            Style           =   2  'Dropdown List
            TabIndex        =   11
            Top             =   240
            Width           =   3135
         End
         Begin VB.Label Lbl_Nombre 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Observación"
            Height          =   195
            Index           =   88
            Left            =   3120
            TabIndex        =   183
            Top             =   960
            Width           =   900
         End
         Begin VB.Label Lbl_Nombre 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Fecha Efecto"
            Height          =   195
            Index           =   87
            Left            =   120
            TabIndex        =   182
            Top             =   960
            Width           =   1080
         End
         Begin VB.Label Lbl_EndCrear 
            BackColor       =   &H80000018&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   5640
            TabIndex        =   59
            Top             =   240
            Width           =   600
         End
         Begin VB.Label Lbl_Nombre 
            AutoSize        =   -1  'True
            Caption         =   "Nº Endoso a Crear"
            Height          =   195
            Index           =   79
            Left            =   4200
            TabIndex        =   150
            Top             =   285
            Width           =   1440
         End
         Begin VB.Label Lbl_Nombre 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Tipo"
            Height          =   195
            Index           =   20
            Left            =   120
            TabIndex        =   130
            Top             =   285
            Width           =   315
         End
         Begin VB.Label Lbl_Nombre 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Causa "
            Height          =   195
            Index           =   19
            Left            =   120
            TabIndex        =   129
            Top             =   600
            Width           =   495
         End
         Begin VB.Label Lbl_Nombre 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Fecha Solicitud"
            Height          =   195
            Index           =   18
            Left            =   120
            TabIndex        =   128
            Top             =   1245
            Width           =   1215
         End
      End
      Begin TabDlg.SSTab SSTab_PolizaOriginal 
         Height          =   6615
         Left            =   -74400
         TabIndex        =   14
         Top             =   1200
         Width           =   8775
         _ExtentX        =   15478
         _ExtentY        =   11668
         _Version        =   393216
         Tabs            =   2
         TabsPerRow      =   2
         TabHeight       =   520
         ForeColor       =   8421376
         TabCaption(0)   =   "Póliza Original"
         TabPicture(0)   =   "Frm_EndosoPol.frx":0346
         Tab(0).ControlEnabled=   -1  'True
         Tab(0).Control(0)=   "Lbl_POMod"
         Tab(0).Control(0).Enabled=   0   'False
         Tab(0).Control(1)=   "Lbl_POTipRta"
         Tab(0).Control(1).Enabled=   0   'False
         Tab(0).Control(2)=   "Lbl_POTipPen"
         Tab(0).Control(2).Enabled=   0   'False
         Tab(0).Control(3)=   "Lbl_POTasaPerGar"
         Tab(0).Control(3).Enabled=   0   'False
         Tab(0).Control(4)=   "Lbl_POTasaVta"
         Tab(0).Control(4).Enabled=   0   'False
         Tab(0).Control(5)=   "Lbl_POTasaCto"
         Tab(0).Control(5).Enabled=   0   'False
         Tab(0).Control(6)=   "Lbl_POMtoPen"
         Tab(0).Control(6).Enabled=   0   'False
         Tab(0).Control(7)=   "Lbl_POMtoPri"
         Tab(0).Control(7).Enabled=   0   'False
         Tab(0).Control(8)=   "Lbl_POTerVig"
         Tab(0).Control(8).Enabled=   0   'False
         Tab(0).Control(9)=   "Lbl_POIniVig"
         Tab(0).Control(9).Enabled=   0   'False
         Tab(0).Control(10)=   "Lbl_PONumCar"
         Tab(0).Control(10).Enabled=   0   'False
         Tab(0).Control(11)=   "Lbl_Nombre(38)"
         Tab(0).Control(11).Enabled=   0   'False
         Tab(0).Control(12)=   "Lbl_Nombre(36)"
         Tab(0).Control(12).Enabled=   0   'False
         Tab(0).Control(13)=   "Lbl_Nombre(35)"
         Tab(0).Control(13).Enabled=   0   'False
         Tab(0).Control(14)=   "Lbl_Nombre(32)"
         Tab(0).Control(14).Enabled=   0   'False
         Tab(0).Control(15)=   "Lbl_Nombre(26)"
         Tab(0).Control(15).Enabled=   0   'False
         Tab(0).Control(16)=   "Lbl_Nombre(29)"
         Tab(0).Control(16).Enabled=   0   'False
         Tab(0).Control(17)=   "Lbl_Nombre(27)"
         Tab(0).Control(17).Enabled=   0   'False
         Tab(0).Control(18)=   "Lbl_Nombre(34)"
         Tab(0).Control(18).Enabled=   0   'False
         Tab(0).Control(19)=   "Lbl_Nombre(33)"
         Tab(0).Control(19).Enabled=   0   'False
         Tab(0).Control(20)=   "Lbl_Nombre(31)"
         Tab(0).Control(20).Enabled=   0   'False
         Tab(0).Control(21)=   "Lbl_Nombre(30)"
         Tab(0).Control(21).Enabled=   0   'False
         Tab(0).Control(22)=   "Lbl_Nombre(25)"
         Tab(0).Control(22).Enabled=   0   'False
         Tab(0).Control(23)=   "Lbl_Nombre(24)"
         Tab(0).Control(23).Enabled=   0   'False
         Tab(0).Control(24)=   "Lbl_Nombre(28)"
         Tab(0).Control(24).Enabled=   0   'False
         Tab(0).Control(25)=   "Lbl_POEstVig"
         Tab(0).Control(25).Enabled=   0   'False
         Tab(0).Control(26)=   "Lbl_Nombre(1)"
         Tab(0).Control(26).Enabled=   0   'False
         Tab(0).Control(27)=   "Lbl_Nombre(2)"
         Tab(0).Control(27).Enabled=   0   'False
         Tab(0).Control(28)=   "Lbl_Nombre(3)"
         Tab(0).Control(28).Enabled=   0   'False
         Tab(0).Control(29)=   "Lbl_POCtaInd"
         Tab(0).Control(29).Enabled=   0   'False
         Tab(0).Control(30)=   "Lbl_POIngBase"
         Tab(0).Control(30).Enabled=   0   'False
         Tab(0).Control(31)=   "Lbl_POPrcCubierto"
         Tab(0).Control(31).Enabled=   0   'False
         Tab(0).Control(32)=   "Lbl_Nombre(4)"
         Tab(0).Control(32).Enabled=   0   'False
         Tab(0).Control(33)=   "Lbl_POMesGar"
         Tab(0).Control(33).Enabled=   0   'False
         Tab(0).Control(34)=   "Lbl_POMesDif"
         Tab(0).Control(34).Enabled=   0   'False
         Tab(0).Control(35)=   "Lbl_POFecDevengue"
         Tab(0).Control(35).Enabled=   0   'False
         Tab(0).Control(36)=   "Lbl_POFecEmision"
         Tab(0).Control(36).Enabled=   0   'False
         Tab(0).Control(37)=   "Lbl_Nombre(83)"
         Tab(0).Control(37).Enabled=   0   'False
         Tab(0).Control(38)=   "Lbl_Nombre(92)"
         Tab(0).Control(38).Enabled=   0   'False
         Tab(0).Control(39)=   "Lbl_MonPension(0)"
         Tab(0).Control(39).Enabled=   0   'False
         Tab(0).Control(40)=   "Lbl_MonPrima"
         Tab(0).Control(40).Enabled=   0   'False
         Tab(0).Control(41)=   "Lbl_Nombre(9)"
         Tab(0).Control(41).Enabled=   0   'False
         Tab(0).Control(42)=   "Lbl_POCuspp"
         Tab(0).Control(42).Enabled=   0   'False
         Tab(0).Control(43)=   "Lbl_Nombre(95)"
         Tab(0).Control(43).Enabled=   0   'False
         Tab(0).Control(44)=   "Lbl_POIndCobertura"
         Tab(0).Control(44).Enabled=   0   'False
         Tab(0).Control(45)=   "Lbl_Nombre(96)"
         Tab(0).Control(45).Enabled=   0   'False
         Tab(0).Control(46)=   "Lbl_POCoberCon"
         Tab(0).Control(46).Enabled=   0   'False
         Tab(0).Control(47)=   "Lbl_Nombre(97)"
         Tab(0).Control(47).Enabled=   0   'False
         Tab(0).Control(48)=   "Lbl_PODerCrecer"
         Tab(0).Control(48).Enabled=   0   'False
         Tab(0).Control(49)=   "Lbl_Nombre(98)"
         Tab(0).Control(49).Enabled=   0   'False
         Tab(0).Control(50)=   "Lbl_PODerGratificacion"
         Tab(0).Control(50).Enabled=   0   'False
         Tab(0).Control(51)=   "lblFecTerPerGar"
         Tab(0).Control(51).Enabled=   0   'False
         Tab(0).ControlCount=   52
         TabCaption(1)   =   "Beneficiarios Originales"
         TabPicture(1)   =   "Frm_EndosoPol.frx":0362
         Tab(1).ControlEnabled=   0   'False
         Tab(1).Control(0)=   "Msf_BOGrilla"
         Tab(1).Control(1)=   "Fra_Personales"
         Tab(1).ControlCount=   2
         Begin VB.Frame Fra_Personales 
            Caption         =   "Antecedentes Personales"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00800000&
            Height          =   4425
            Left            =   -74760
            TabIndex        =   96
            Top             =   2040
            Width           =   8295
            Begin VB.Label Lbl_BOCodTipoIden 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   208
               Top             =   600
               Width           =   2055
            End
            Begin VB.Label Lbl_MonPension 
               Caption         =   "(TM)"
               Enabled         =   0   'False
               Height          =   300
               Index           =   1
               Left            =   5760
               TabIndex        =   204
               Top             =   3840
               Width           =   495
            End
            Begin VB.Label Lbl_BOFecMat 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   186
               Top             =   3480
               Width           =   1335
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha Fall."
               Height          =   195
               Index           =   89
               Left            =   120
               TabIndex        =   185
               Top             =   3840
               Width           =   1020
            End
            Begin VB.Label Lbl_BOFecInv 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   4320
               TabIndex        =   147
               Top             =   2400
               Width           =   1335
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha Inv."
               Height          =   195
               Index           =   78
               Left            =   3300
               TabIndex        =   146
               Top             =   2400
               Width           =   765
            End
            Begin VB.Label Lbl_BOCauInv 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   145
               Top             =   2760
               Width           =   7095
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Causal Inv."
               Height          =   195
               Index           =   77
               Left            =   120
               TabIndex        =   144
               Top             =   2760
               Width           =   795
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "%"
               Height          =   255
               Index           =   17
               Left            =   5400
               TabIndex        =   126
               Top             =   3480
               Width           =   255
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Porc. Pensión"
               Height          =   195
               Index           =   16
               Left            =   3300
               TabIndex        =   125
               Top             =   3480
               Width           =   990
            End
            Begin VB.Label Lbl_BOPrcLegal 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   4320
               TabIndex        =   124
               Top             =   3480
               Width           =   855
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha NHM"
               Height          =   195
               Index           =   15
               Left            =   3300
               TabIndex        =   123
               Top             =   3120
               Width           =   975
            End
            Begin VB.Label Lbl_BOFecNHM 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   4320
               TabIndex        =   122
               Top             =   3120
               Width           =   1335
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha Mat."
               Height          =   195
               Index           =   14
               Left            =   120
               TabIndex        =   121
               Top             =   3480
               Width           =   810
            End
            Begin VB.Label Lbl_BOFecFall 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   120
               Top             =   3840
               Width           =   1335
            End
            Begin VB.Label Lbl_BODerAcrecer 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   4320
               TabIndex        =   119
               Top             =   2040
               Width           =   615
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Dº Crecer"
               Height          =   255
               Index           =   13
               Left            =   3300
               TabIndex        =   118
               Top             =   2040
               Width           =   975
            End
            Begin VB.Label Lbl_BODerPen 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   4320
               TabIndex        =   117
               Top             =   1680
               Width           =   615
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Dº Pensión"
               Height          =   255
               Index           =   12
               Left            =   3300
               TabIndex        =   116
               Top             =   1680
               Width           =   975
            End
            Begin VB.Label Lbl_BOSexo 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   115
               Top             =   2040
               Width           =   615
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Sexo"
               Height          =   195
               Index           =   11
               Left            =   120
               TabIndex        =   114
               Top             =   2040
               Width           =   960
            End
            Begin VB.Label Lbl_BOGrupFam 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   113
               Top             =   1680
               Width           =   615
            End
            Begin VB.Label Lbl_BOPar 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   112
               Top             =   1320
               Width           =   7095
            End
            Begin VB.Label Lbl_BONomBen 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   111
               Top             =   960
               Width           =   7095
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Nro. Ident."
               Height          =   255
               Index           =   10
               Left            =   120
               TabIndex        =   109
               Top             =   600
               Width           =   855
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Nombre"
               Height          =   255
               Index           =   6
               Left            =   120
               TabIndex        =   108
               Top             =   960
               Width           =   975
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Nº Orden"
               Height          =   255
               Index           =   5
               Left            =   120
               TabIndex        =   107
               Top             =   240
               Width           =   975
            End
            Begin VB.Label Lbl_BONumOrd 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   106
               Top             =   240
               Width           =   615
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Parentesco"
               Height          =   255
               Index           =   7
               Left            =   120
               TabIndex        =   105
               Top             =   1320
               Width           =   975
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Grupo Fam."
               Height          =   255
               Index           =   8
               Left            =   120
               TabIndex        =   104
               Top             =   1680
               Width           =   975
            End
            Begin VB.Label Lbl_BONumIden 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   3240
               TabIndex        =   103
               Top             =   600
               Width           =   1815
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha Nac."
               Height          =   195
               Index           =   39
               Left            =   120
               TabIndex        =   102
               Top             =   3120
               Width           =   840
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Sit. de Inv."
               Height          =   195
               Index           =   40
               Left            =   120
               TabIndex        =   101
               Top             =   2400
               Width           =   1005
            End
            Begin VB.Label Lbl_BOFecNac 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   100
               Top             =   3120
               Width           =   1335
            End
            Begin VB.Label Lbl_BOSitInv 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   99
               Top             =   2400
               Width           =   615
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Mto. Pensión"
               Height          =   195
               Index           =   41
               Left            =   3300
               TabIndex        =   98
               Top             =   3840
               Width           =   1050
            End
            Begin VB.Label Lbl_BOMtoPension 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   4320
               TabIndex        =   97
               Top             =   3840
               Width           =   1335
            End
         End
         Begin MSFlexGridLib.MSFlexGrid Msf_BOGrilla 
            Height          =   1530
            Left            =   -74760
            TabIndex        =   110
            Top             =   480
            Width           =   8295
            _ExtentX        =   14631
            _ExtentY        =   2699
            _Version        =   393216
            Rows            =   1
            Cols            =   6
            FixedCols       =   0
            BackColor       =   14745599
            FormatString    =   $"Frm_EndosoPol.frx":037E
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Serif"
               Size            =   6.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
         End
         Begin VB.Label lblFecTerPerGar 
            BorderStyle     =   1  'Fixed Single
            Height          =   255
            Left            =   6360
            TabIndex        =   293
            Top             =   5400
            Width           =   1935
         End
         Begin VB.Label Lbl_PODerGratificacion 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   218
            Top             =   6000
            Width           =   975
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Gratificación"
            Height          =   255
            Index           =   98
            Left            =   240
            TabIndex        =   217
            Top             =   6000
            Width           =   1455
         End
         Begin VB.Label Lbl_PODerCrecer 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   216
            Top             =   5640
            Width           =   975
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Der. Crecer"
            Height          =   255
            Index           =   97
            Left            =   240
            TabIndex        =   215
            Top             =   5640
            Width           =   1575
         End
         Begin VB.Label Lbl_POCoberCon 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   214
            Top             =   5280
            Width           =   1095
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Cobertura a la Cónyuge"
            Height          =   255
            Index           =   96
            Left            =   240
            TabIndex        =   213
            Top             =   5280
            Width           =   2175
         End
         Begin VB.Label Lbl_POIndCobertura 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   212
            Top             =   4920
            Width           =   1095
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Ind. Cobertura"
            Height          =   255
            Index           =   95
            Left            =   240
            TabIndex        =   211
            Top             =   4920
            Width           =   2175
         End
         Begin VB.Label Lbl_POCuspp 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   6360
            TabIndex        =   210
            Top             =   5040
            Visible         =   0   'False
            Width           =   1935
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "CUSPP"
            Height          =   255
            Index           =   9
            Left            =   4440
            TabIndex        =   209
            Top             =   5040
            Visible         =   0   'False
            Width           =   2175
         End
         Begin VB.Label Lbl_MonPrima 
            Caption         =   "S/."
            Enabled         =   0   'False
            Height          =   285
            Left            =   4200
            TabIndex        =   198
            Top             =   3195
            Width           =   495
         End
         Begin VB.Label Lbl_MonPension 
            Caption         =   "(TM)"
            Enabled         =   0   'False
            Height          =   285
            Index           =   0
            Left            =   4200
            TabIndex        =   197
            Top             =   3540
            Width           =   495
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Fecha de Emisión"
            Height          =   255
            Index           =   92
            Left            =   4440
            TabIndex        =   196
            Top             =   4320
            Visible         =   0   'False
            Width           =   2175
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Fecha de Devengue"
            Height          =   255
            Index           =   83
            Left            =   240
            TabIndex        =   195
            Top             =   4560
            Width           =   2175
         End
         Begin VB.Label Lbl_POFecEmision 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   6840
            TabIndex        =   194
            Top             =   4320
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.Label Lbl_POFecDevengue 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   193
            Top             =   4560
            Width           =   1095
         End
         Begin VB.Label Lbl_POMesDif 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   74
            Top             =   2180
            Width           =   855
         End
         Begin VB.Label Lbl_POMesGar 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   73
            Top             =   2860
            Width           =   855
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "%"
            Height          =   255
            Index           =   4
            Left            =   7440
            TabIndex        =   95
            Top             =   3840
            Visible         =   0   'False
            Width           =   375
         End
         Begin VB.Label Lbl_POPrcCubierto 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   6480
            TabIndex        =   94
            Top             =   3840
            Visible         =   0   'False
            Width           =   855
         End
         Begin VB.Label Lbl_POIngBase 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   6480
            TabIndex        =   93
            Top             =   3480
            Visible         =   0   'False
            Width           =   1455
         End
         Begin VB.Label Lbl_POCtaInd 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   6480
            TabIndex        =   92
            Top             =   3120
            Visible         =   0   'False
            Width           =   1455
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Porc. Cubierto"
            Height          =   255
            Index           =   3
            Left            =   5040
            TabIndex        =   91
            Top             =   3840
            Visible         =   0   'False
            Width           =   2415
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Ingreso Base"
            Height          =   255
            Index           =   2
            Left            =   5040
            TabIndex        =   90
            Top             =   3480
            Visible         =   0   'False
            Width           =   2415
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Cta. Individual"
            Height          =   255
            Index           =   1
            Left            =   5040
            TabIndex        =   89
            Top             =   3120
            Visible         =   0   'False
            Width           =   2415
         End
         Begin VB.Label Lbl_POEstVig 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   63
            Top             =   1500
            Width           =   4095
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Modalidad"
            Height          =   255
            Index           =   28
            Left            =   240
            TabIndex        =   88
            Top             =   2565
            Width           =   1980
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Tipo de Pensión "
            Height          =   255
            Index           =   24
            Left            =   240
            TabIndex        =   87
            Top             =   530
            Width           =   1635
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Estado de Vigencia"
            Height          =   255
            Index           =   25
            Left            =   240
            TabIndex        =   86
            Top             =   1545
            Width           =   2175
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Nº Beneficiarios"
            Height          =   255
            Index           =   30
            Left            =   240
            TabIndex        =   85
            Top             =   870
            Width           =   2055
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Periodo de Vigencia"
            Height          =   255
            Index           =   31
            Left            =   240
            TabIndex        =   84
            Top             =   1210
            Width           =   1695
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Monto Prima"
            Height          =   255
            Index           =   33
            Left            =   240
            TabIndex        =   83
            Top             =   3255
            Width           =   1935
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Monto Pensión"
            Height          =   255
            Index           =   34
            Left            =   240
            TabIndex        =   82
            Top             =   3540
            Width           =   1935
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Meses Dif."
            Height          =   255
            Index           =   27
            Left            =   240
            TabIndex        =   81
            Top             =   2235
            Width           =   1935
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Meses Gar."
            Height          =   255
            Index           =   29
            Left            =   240
            TabIndex        =   80
            Top             =   2910
            Width           =   2175
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Tipo de Renta"
            Height          =   255
            Index           =   26
            Left            =   240
            TabIndex        =   79
            Top             =   1890
            Width           =   2055
         End
         Begin VB.Label Lbl_Nombre 
            Alignment       =   2  'Center
            Caption         =   "-"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   9.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Index           =   32
            Left            =   3960
            TabIndex        =   78
            Top             =   1160
            Width           =   255
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Tasa Cto. Equivalente"
            Height          =   255
            Index           =   35
            Left            =   240
            TabIndex        =   77
            Top             =   3880
            Width           =   1935
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Tasa de Venta"
            Height          =   255
            Index           =   36
            Left            =   240
            TabIndex        =   76
            Top             =   4220
            Width           =   2175
         End
         Begin VB.Label Lbl_Nombre 
            Caption         =   "Tasa de Int. Per. Garantizado"
            Height          =   255
            Index           =   38
            Left            =   5040
            TabIndex        =   75
            Top             =   2925
            Visible         =   0   'False
            Width           =   2295
         End
         Begin VB.Label Lbl_PONumCar 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   72
            Top             =   820
            Width           =   735
         End
         Begin VB.Label Lbl_POIniVig 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   71
            Top             =   1160
            Width           =   1215
         End
         Begin VB.Label Lbl_POTerVig 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   4320
            TabIndex        =   70
            Top             =   1160
            Width           =   1215
         End
         Begin VB.Label Lbl_POMtoPri 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   69
            Top             =   3200
            Width           =   1455
         End
         Begin VB.Label Lbl_POMtoPen 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   68
            Top             =   3540
            Width           =   1455
         End
         Begin VB.Label Lbl_POTasaCto 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   67
            Top             =   3880
            Width           =   1095
         End
         Begin VB.Label Lbl_POTasaVta 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   66
            Top             =   4220
            Width           =   1095
         End
         Begin VB.Label Lbl_POTasaPerGar 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   7440
            TabIndex        =   65
            Top             =   2880
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.Label Lbl_POTipPen 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   64
            Top             =   480
            Width           =   5295
         End
         Begin VB.Label Lbl_POTipRta 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   62
            Top             =   1840
            Width           =   4095
         End
         Begin VB.Label Lbl_POMod 
            BackColor       =   &H00E0FFFF&
            BorderStyle     =   1  'Fixed Single
            Enabled         =   0   'False
            Height          =   285
            Left            =   2640
            TabIndex        =   61
            Top             =   2520
            Width           =   4095
         End
      End
      Begin TabDlg.SSTab SSTab_PolizaModificada 
         Height          =   9705
         Left            =   240
         TabIndex        =   15
         Top             =   2160
         Width           =   9735
         _ExtentX        =   17171
         _ExtentY        =   17119
         _Version        =   393216
         Tabs            =   2
         Tab             =   1
         TabsPerRow      =   2
         TabHeight       =   520
         ForeColor       =   128
         TabCaption(0)   =   "Póliza a Endosar"
         TabPicture(0)   =   "Frm_EndosoPol.frx":042F
         Tab(0).ControlEnabled=   0   'False
         Tab(0).Control(0)=   "Fra_PM"
         Tab(0).ControlCount=   1
         TabCaption(1)   =   "Beneficiarios a Endosar"
         TabPicture(1)   =   "Frm_EndosoPol.frx":044B
         Tab(1).ControlEnabled=   -1  'True
         Tab(1).Control(0)=   "frmDatosGen"
         Tab(1).Control(0).Enabled=   0   'False
         Tab(1).Control(1)=   "Msf_BMGrilla"
         Tab(1).Control(1).Enabled=   0   'False
         Tab(1).Control(2)=   "Cmd_BMSumar"
         Tab(1).Control(2).Enabled=   0   'False
         Tab(1).Control(3)=   "Cmd_BMRestar"
         Tab(1).Control(3).Enabled=   0   'False
         Tab(1).Control(4)=   "Cmd_BMCalcular"
         Tab(1).Control(4).Enabled=   0   'False
         Tab(1).Control(5)=   "Fra_BM"
         Tab(1).Control(5).Enabled=   0   'False
         Tab(1).ControlCount=   6
         Begin VB.Frame Fra_BM 
            Caption         =   "  Antecedentes Personales  "
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00800000&
            Height          =   2535
            Left            =   120
            TabIndex        =   131
            Top             =   6960
            Width           =   9135
            Begin VB.CommandButton cmdCausaFac 
               Caption         =   "Causa Fallecimiento"
               Height          =   375
               Left            =   7080
               Picture         =   "Frm_EndosoPol.frx":0467
               TabIndex        =   319
               Top             =   1800
               Width           =   1935
            End
            Begin VB.ComboBox cmbExcluesion 
               BackColor       =   &H00E0FFFF&
               Enabled         =   0   'False
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":1331
               Left            =   5880
               List            =   "Frm_EndosoPol.frx":133E
               Style           =   2  'Dropdown List
               TabIndex        =   275
               Top             =   1170
               Width           =   3135
            End
            Begin VB.TextBox txt_BMMtoPension 
               Height          =   285
               Left            =   1080
               TabIndex        =   273
               Top             =   1470
               Visible         =   0   'False
               Width           =   975
            End
            Begin VB.TextBox txt_BMPrcGar 
               Height          =   285
               Left            =   3480
               TabIndex        =   272
               Top             =   1755
               Width           =   735
            End
            Begin VB.TextBox txt_BMPrc 
               Height          =   285
               Left            =   3480
               TabIndex        =   271
               Top             =   1470
               Width           =   735
            End
            Begin VB.CommandButton cmdIngNombres 
               Caption         =   "Nombres >>"
               Height          =   375
               Left            =   8640
               TabIndex        =   266
               Top             =   2880
               Visible         =   0   'False
               Width           =   495
            End
            Begin VB.ComboBox Cmb_BMDerPen 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":1394
               Left            =   5880
               List            =   "Frm_EndosoPol.frx":1396
               Style           =   2  'Dropdown List
               TabIndex        =   37
               Top             =   855
               Width           =   3135
            End
            Begin VB.ComboBox Cmb_BMGrupFam 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":1398
               Left            =   5880
               List            =   "Frm_EndosoPol.frx":139A
               Style           =   2  'Dropdown List
               TabIndex        =   36
               Top             =   555
               Width           =   3135
            End
            Begin VB.ComboBox Cmb_BMSitInv 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":139C
               Left            =   1080
               List            =   "Frm_EndosoPol.frx":139E
               Style           =   2  'Dropdown List
               TabIndex        =   30
               Top             =   555
               Width           =   3135
            End
            Begin VB.ComboBox Cmb_BMSexo 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":13A0
               Left            =   5880
               List            =   "Frm_EndosoPol.frx":13A2
               Style           =   2  'Dropdown List
               TabIndex        =   35
               Top             =   240
               Width           =   3135
            End
            Begin VB.TextBox Txt_BMNomBen 
               Height          =   285
               Left            =   1080
               MaxLength       =   25
               TabIndex        =   26
               Top             =   2760
               Width           =   3135
            End
            Begin VB.TextBox Txt_BMNomSegBen 
               Height          =   285
               Left            =   1080
               MaxLength       =   25
               TabIndex        =   27
               Top             =   3120
               Width           =   3135
            End
            Begin VB.CommandButton Cmd_CauInv 
               Caption         =   "..."
               BeginProperty Font 
                  Name            =   "Arial"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   3840
               TabIndex        =   33
               Top             =   1200
               Width           =   285
            End
            Begin VB.TextBox Txt_BMFecMat 
               Height          =   285
               Left            =   5760
               MaxLength       =   10
               TabIndex        =   40
               Top             =   2520
               Visible         =   0   'False
               Width           =   975
            End
            Begin VB.TextBox Txt_BMFecFall 
               Height          =   285
               Left            =   5880
               MaxLength       =   10
               TabIndex        =   39
               Top             =   1800
               Width           =   1095
            End
            Begin VB.TextBox Txt_BMMtoPensionGar 
               Height          =   285
               Left            =   1080
               TabIndex        =   41
               Top             =   1755
               Width           =   975
            End
            Begin VB.TextBox Txt_BMFecNac 
               Height          =   285
               Left            =   5880
               MaxLength       =   10
               TabIndex        =   38
               Top             =   1500
               Width           =   1095
            End
            Begin VB.TextBox Txt_BMMatBen 
               Height          =   285
               Left            =   5280
               MaxLength       =   20
               TabIndex        =   29
               Top             =   3120
               Width           =   3135
            End
            Begin VB.TextBox Txt_BMPatBen 
               Height          =   285
               Left            =   5280
               MaxLength       =   20
               TabIndex        =   28
               Top             =   2760
               Width           =   3135
            End
            Begin VB.TextBox Txt_BMFecInv 
               Height          =   285
               Left            =   1080
               MaxLength       =   10
               TabIndex        =   31
               Top             =   855
               Width           =   1095
            End
            Begin VB.ComboBox Cmb_BMPar 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":13A4
               Left            =   1080
               List            =   "Frm_EndosoPol.frx":13A6
               Style           =   2  'Dropdown List
               TabIndex        =   34
               Top             =   240
               Width           =   3135
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Exclusion"
               Height          =   255
               Index           =   103
               Left            =   4920
               TabIndex        =   276
               Top             =   1170
               Width           =   975
            End
            Begin VB.Line Line3 
               X1              =   4560
               X2              =   4560
               Y1              =   480
               Y2              =   2640
            End
            Begin VB.Label lbl_BMPrcGar 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   3480
               TabIndex        =   270
               Top             =   1755
               Width           =   735
            End
            Begin VB.Label Label18 
               Caption         =   "% Pen. Gar."
               Height          =   255
               Left            =   2520
               TabIndex        =   269
               Top             =   1755
               Width           =   855
            End
            Begin VB.Label lbl_BMPrc 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   3480
               TabIndex        =   268
               Top             =   1470
               Width           =   735
            End
            Begin VB.Label Label16 
               Caption         =   "% Pensión"
               Height          =   255
               Left            =   2520
               TabIndex        =   267
               Top             =   1470
               Width           =   855
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "2do. Nombre"
               Height          =   195
               Index           =   69
               Left            =   120
               TabIndex        =   207
               Top             =   3120
               Width           =   915
            End
            Begin VB.Label Lbl_MonPension 
               Caption         =   "(TM)"
               Enabled         =   0   'False
               Height          =   285
               Index           =   5
               Left            =   2040
               TabIndex        =   206
               Top             =   1755
               Width           =   495
            End
            Begin VB.Label Lbl_MonPension 
               Caption         =   "(TM)"
               Enabled         =   0   'False
               Height          =   285
               Index           =   4
               Left            =   2040
               TabIndex        =   205
               Top             =   1470
               Width           =   495
            End
            Begin VB.Label Lbl_BMCauInv 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Height          =   285
               Left            =   1080
               TabIndex        =   32
               Top             =   1185
               Width           =   2775
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Pensión Gar."
               Height          =   195
               Index           =   91
               Left            =   120
               TabIndex        =   187
               Top             =   1755
               Width           =   1035
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha Mat."
               Height          =   195
               Index           =   90
               Left            =   4920
               TabIndex        =   184
               Top             =   2640
               Visible         =   0   'False
               Width           =   810
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Ap. Materno"
               Height          =   255
               Index           =   86
               Left            =   4320
               TabIndex        =   155
               Top             =   3120
               Width           =   915
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Ap. Paterno"
               Height          =   255
               Index           =   85
               Left            =   4320
               TabIndex        =   154
               Top             =   2760
               Width           =   915
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "1er. Nombre"
               Height          =   195
               Index           =   84
               Left            =   120
               TabIndex        =   153
               Top             =   2760
               Width           =   870
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Causal Inv."
               Height          =   195
               Index           =   82
               Left            =   120
               TabIndex        =   149
               Top             =   1185
               Width           =   975
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha Inv."
               Height          =   195
               Index           =   81
               Left            =   120
               TabIndex        =   148
               Top             =   855
               Width           =   1005
            End
            Begin VB.Label Lbl_BMFecNHM 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   8040
               TabIndex        =   55
               Top             =   1500
               Width           =   975
            End
            Begin VB.Label Lbl_BMMtoPension 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   1080
               TabIndex        =   58
               Top             =   1470
               Width           =   975
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Pensión"
               Height          =   195
               Index           =   76
               Left            =   120
               TabIndex        =   143
               Top             =   1470
               Width           =   930
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Sit. de Inv."
               Height          =   195
               Index           =   75
               Left            =   120
               TabIndex        =   142
               Top             =   555
               Width           =   1005
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha Nac."
               Height          =   195
               Index           =   74
               Left            =   4920
               TabIndex        =   141
               Top             =   1500
               Width           =   840
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Grupo Fam."
               Height          =   255
               Index           =   73
               Left            =   4920
               TabIndex        =   140
               Top             =   555
               Width           =   975
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Parentesco"
               Height          =   255
               Index           =   72
               Left            =   120
               TabIndex        =   139
               Top             =   240
               Width           =   975
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Sexo"
               Height          =   255
               Index           =   67
               Left            =   4920
               TabIndex        =   138
               Top             =   240
               Width           =   975
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Dº Pensión"
               Height          =   255
               Index           =   66
               Left            =   4920
               TabIndex        =   137
               Top             =   855
               Width           =   975
            End
            Begin VB.Label Lbl_Nombre 
               Alignment       =   2  'Center
               BackStyle       =   0  'Transparent
               Caption         =   "Dº Crecer"
               Height          =   255
               Index           =   65
               Left            =   3480
               TabIndex        =   136
               Top             =   2520
               Visible         =   0   'False
               Width           =   855
            End
            Begin VB.Label Lbl_BMDerAcrecer 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   4320
               TabIndex        =   56
               Top             =   2520
               Visible         =   0   'False
               Width           =   495
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha Fall."
               Height          =   195
               Index           =   64
               Left            =   4920
               TabIndex        =   135
               Top             =   1800
               Width           =   945
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Fecha NHM"
               Height          =   195
               Index           =   63
               Left            =   7080
               TabIndex        =   134
               Top             =   1500
               Width           =   975
            End
            Begin VB.Label Lbl_BMPrcLegal 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   300
               Left            =   5880
               TabIndex        =   57
               Top             =   2160
               Width           =   735
            End
            Begin VB.Label Lbl_Nombre 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Porc. Legal"
               Height          =   195
               Index           =   62
               Left            =   4680
               TabIndex        =   133
               Top             =   2160
               Width           =   930
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "%"
               Height          =   210
               Index           =   61
               Left            =   5640
               TabIndex        =   132
               Top             =   2160
               Width           =   255
            End
         End
         Begin VB.CommandButton Cmd_BMCalcular 
            Height          =   450
            Left            =   9165
            Picture         =   "Frm_EndosoPol.frx":13A8
            Style           =   1  'Graphical
            TabIndex        =   265
            ToolTipText     =   "Calcular Porcentajes"
            Top             =   3120
            Width           =   495
         End
         Begin VB.CommandButton Cmd_BMRestar 
            Height          =   450
            Left            =   9165
            Picture         =   "Frm_EndosoPol.frx":196A
            Style           =   1  'Graphical
            TabIndex        =   264
            ToolTipText     =   "Quitar Beneficiario"
            Top             =   2640
            Width           =   495
         End
         Begin VB.CommandButton Cmd_BMSumar 
            Height          =   450
            Left            =   9165
            Picture         =   "Frm_EndosoPol.frx":1AF4
            Style           =   1  'Graphical
            TabIndex        =   263
            ToolTipText     =   "Agregar Beneficiario"
            Top             =   2160
            Width           =   495
         End
         Begin VB.Frame Fra_PM 
            Caption         =   " Antecedentes de la Póliza "
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00800000&
            Height          =   5115
            Left            =   -74640
            TabIndex        =   156
            Top             =   480
            Width           =   8655
            Begin VB.ComboBox Cmb_PMTipPen 
               BackColor       =   &H00E0FFFF&
               Enabled         =   0   'False
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":1C7E
               Left            =   1680
               List            =   "Frm_EndosoPol.frx":1C80
               Style           =   2  'Dropdown List
               TabIndex        =   16
               Top             =   1080
               Width           =   3375
            End
            Begin VB.TextBox Txt_PMIniVig 
               BackColor       =   &H80000018&
               Enabled         =   0   'False
               Height          =   285
               Left            =   1680
               MaxLength       =   10
               TabIndex        =   165
               Top             =   2160
               Width           =   1065
            End
            Begin VB.ComboBox Cmb_PMEstVig 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":1C82
               Left            =   1680
               List            =   "Frm_EndosoPol.frx":1C84
               Style           =   2  'Dropdown List
               TabIndex        =   17
               Top             =   1800
               Width           =   2775
            End
            Begin VB.ComboBox Cmb_PMTipRta 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":1C86
               Left            =   1680
               List            =   "Frm_EndosoPol.frx":1C88
               Style           =   2  'Dropdown List
               TabIndex        =   18
               Top             =   2520
               Width           =   2775
            End
            Begin VB.ComboBox Cmb_PMMod 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               ItemData        =   "Frm_EndosoPol.frx":1C8A
               Left            =   1680
               List            =   "Frm_EndosoPol.frx":1C8C
               Style           =   2  'Dropdown List
               TabIndex        =   20
               Top             =   3240
               Width           =   2655
            End
            Begin VB.TextBox Txt_PMMesDif 
               Height          =   285
               Left            =   1680
               MaxLength       =   3
               TabIndex        =   19
               Top             =   2880
               Width           =   585
            End
            Begin VB.TextBox Txt_PMMesGar 
               Height          =   285
               Left            =   1680
               MaxLength       =   3
               TabIndex        =   21
               Top             =   3600
               Width           =   585
            End
            Begin VB.TextBox Txt_PMTasaCto 
               Height          =   285
               Left            =   6720
               MaxLength       =   6
               TabIndex        =   23
               Top             =   1800
               Width           =   585
            End
            Begin VB.TextBox Txt_PMTasaVta 
               Height          =   285
               Left            =   6720
               MaxLength       =   6
               TabIndex        =   24
               Top             =   2160
               Width           =   585
            End
            Begin VB.TextBox Txt_PMTasaPerGar 
               Height          =   285
               Left            =   4440
               MaxLength       =   6
               TabIndex        =   42
               Top             =   3000
               Visible         =   0   'False
               Width           =   585
            End
            Begin VB.TextBox Txt_PMMtoPrima 
               Height          =   285
               Left            =   6720
               MaxLength       =   13
               TabIndex        =   22
               Top             =   1440
               Width           =   1185
            End
            Begin VB.TextBox Txt_PMTerVig 
               BackColor       =   &H80000018&
               Enabled         =   0   'False
               Height          =   285
               Left            =   3000
               MaxLength       =   10
               TabIndex        =   164
               Top             =   2160
               Width           =   1065
            End
            Begin VB.TextBox Txt_PMCtaInd 
               Height          =   285
               Left            =   4440
               MaxLength       =   10
               TabIndex        =   159
               Top             =   3720
               Visible         =   0   'False
               Width           =   465
            End
            Begin VB.TextBox Txt_PMIngBase 
               Height          =   285
               Left            =   4200
               MaxLength       =   10
               TabIndex        =   158
               Top             =   4080
               Visible         =   0   'False
               Width           =   465
            End
            Begin VB.TextBox Txt_PMPrcCub 
               Height          =   285
               Left            =   2520
               MaxLength       =   10
               TabIndex        =   157
               Top             =   3960
               Visible         =   0   'False
               Width           =   585
            End
            Begin VB.Label lblTC 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   1680
               TabIndex        =   292
               Top             =   4320
               Width           =   735
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "TC"
               Height          =   255
               Index           =   110
               Left            =   240
               TabIndex        =   291
               Top             =   4320
               Width           =   1095
            End
            Begin VB.Label Lbl_PMPrcFacPenElla 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   7560
               TabIndex        =   228
               Top             =   3240
               Visible         =   0   'False
               Width           =   855
            End
            Begin VB.Label Lbl_PMMtoFacPenElla 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   7560
               TabIndex        =   227
               Top             =   2880
               Visible         =   0   'False
               Width           =   855
            End
            Begin VB.Label Lbl_PMDerGratificacion 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   6720
               TabIndex        =   225
               Top             =   3600
               Width           =   735
            End
            Begin VB.Label Lbl_PMDerCrecer 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   6720
               TabIndex        =   223
               Top             =   3240
               Width           =   735
            End
            Begin VB.Label Lbl_PMCoberCon 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   6720
               TabIndex        =   221
               Top             =   2880
               Width           =   735
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Gratificación"
               Height          =   255
               Index           =   102
               Left            =   5160
               TabIndex        =   226
               Top             =   3600
               Width           =   1575
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Derecho Crecer"
               Height          =   255
               Index           =   101
               Left            =   5160
               TabIndex        =   224
               Top             =   3240
               Width           =   1575
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Cob. Cónyuge"
               Height          =   255
               Index           =   100
               Left            =   5160
               TabIndex        =   222
               Top             =   2880
               Width           =   1575
            End
            Begin VB.Label Lbl_PMIndCobertura 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   1680
               TabIndex        =   220
               Top             =   3960
               Width           =   735
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Ind. Cobertura"
               Height          =   255
               Index           =   99
               Left            =   240
               TabIndex        =   219
               Top             =   3960
               Width           =   1335
            End
            Begin VB.Label Lbl_PMMonedaPrima 
               Caption         =   "S/."
               Height          =   285
               Left            =   7920
               TabIndex        =   203
               Top             =   1440
               Width           =   495
            End
            Begin VB.Label Lbl_PMFecDevengue 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   6720
               TabIndex        =   202
               Top             =   2520
               Width           =   1095
            End
            Begin VB.Label Lbl_PMFecEmision 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   6720
               TabIndex        =   201
               Top             =   3960
               Visible         =   0   'False
               Width           =   1095
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Fecha de Devengue"
               Height          =   255
               Index           =   94
               Left            =   5160
               TabIndex        =   200
               Top             =   2520
               Width           =   1575
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Fecha de Emisión"
               Height          =   255
               Index           =   93
               Left            =   5160
               TabIndex        =   199
               Top             =   3960
               Visible         =   0   'False
               Width           =   1575
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Tipo de Pensión "
               Height          =   255
               Index           =   21
               Left            =   240
               TabIndex        =   181
               Top             =   1080
               Width           =   1335
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Nº Beneficiarios"
               Height          =   255
               Index           =   22
               Left            =   240
               TabIndex        =   180
               Top             =   1440
               Width           =   1335
            End
            Begin VB.Label Lbl_Nombre 
               Alignment       =   2  'Center
               Caption         =   "-"
               BeginProperty Font 
                  Name            =   "MS Sans Serif"
                  Size            =   9.75
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   255
               Index           =   23
               Left            =   2760
               TabIndex        =   179
               Top             =   1560
               Width           =   255
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Periodo Vigencia"
               Height          =   255
               Index           =   37
               Left            =   240
               TabIndex        =   178
               Top             =   2160
               Width           =   1335
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Estado Vigencia"
               Height          =   255
               Index           =   44
               Left            =   240
               TabIndex        =   177
               Top             =   1800
               Width           =   1335
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Tipo de Renta"
               Height          =   255
               Index           =   49
               Left            =   240
               TabIndex        =   176
               Top             =   2520
               Width           =   1455
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Meses Gar."
               Height          =   255
               Index           =   50
               Left            =   240
               TabIndex        =   175
               Top             =   3600
               Width           =   975
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Meses Dif."
               Height          =   255
               Index           =   51
               Left            =   240
               TabIndex        =   174
               Top             =   2880
               Width           =   1095
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Modalidad"
               Height          =   255
               Index           =   52
               Left            =   240
               TabIndex        =   173
               Top             =   3240
               Width           =   1380
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Tasa Per. Gar."
               Height          =   255
               Index           =   53
               Left            =   4200
               TabIndex        =   172
               Top             =   2880
               Visible         =   0   'False
               Width           =   1095
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Tasa de Venta"
               Height          =   255
               Index           =   54
               Left            =   5160
               TabIndex        =   171
               Top             =   2160
               Width           =   1095
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Tasa Cto. Equiv."
               Height          =   255
               Index           =   55
               Left            =   5160
               TabIndex        =   170
               Top             =   1815
               Width           =   1335
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Monto Prima"
               Height          =   255
               Index           =   57
               Left            =   5160
               TabIndex        =   169
               Top             =   1440
               Width           =   1095
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "%"
               Height          =   255
               Index           =   58
               Left            =   7440
               TabIndex        =   168
               Top             =   1800
               Width           =   375
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "%"
               Height          =   255
               Index           =   59
               Left            =   7440
               TabIndex        =   167
               Top             =   2160
               Width           =   375
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "%"
               Height          =   255
               Index           =   60
               Left            =   4560
               TabIndex        =   166
               Top             =   2640
               Visible         =   0   'False
               Width           =   375
            End
            Begin VB.Label Lbl_PMNumCar 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   1680
               TabIndex        =   54
               Top             =   1440
               Width           =   735
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Cta. Individual"
               Height          =   255
               Index           =   45
               Left            =   3600
               TabIndex        =   163
               Top             =   3720
               Visible         =   0   'False
               Width           =   1095
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Ingreso Base"
               Height          =   255
               Index           =   46
               Left            =   3240
               TabIndex        =   162
               Top             =   4080
               Visible         =   0   'False
               Width           =   1455
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "Porc. Cubierto"
               Height          =   255
               Index           =   47
               Left            =   2400
               TabIndex        =   161
               Top             =   3720
               Visible         =   0   'False
               Width           =   1215
            End
            Begin VB.Label Lbl_Nombre 
               Caption         =   "%"
               Height          =   255
               Index           =   48
               Left            =   2760
               TabIndex        =   160
               Top             =   3600
               Visible         =   0   'False
               Width           =   375
            End
         End
         Begin MSFlexGridLib.MSFlexGrid Msf_BMGrilla 
            Height          =   1635
            Left            =   120
            TabIndex        =   25
            Top             =   360
            Width           =   9495
            _ExtentX        =   16748
            _ExtentY        =   2884
            _Version        =   393216
            Rows            =   1
            Cols            =   6
            FixedCols       =   0
            BackColor       =   14745599
            BorderStyle     =   0
            FormatString    =   $"Frm_EndosoPol.frx":1C8E
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Serif"
               Size            =   6.75
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
         End
         Begin VB.Frame frmDatosGen 
            Caption         =   "Datos Generales"
            Enabled         =   0   'False
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00800000&
            Height          =   4575
            Left            =   0
            TabIndex        =   229
            Top             =   2280
            Width           =   9135
            Begin VB.Frame FrameCtaBan 
               Caption         =   "Forma de Pago de Pensión"
               BeginProperty Font 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00800000&
               Height          =   4335
               Left            =   4200
               TabIndex        =   282
               Top             =   120
               Visible         =   0   'False
               Width           =   4980
               Begin VB.ComboBox Cmb_TipDoc 
                  BackColor       =   &H00E0FFFF&
                  Enabled         =   0   'False
                  Height          =   315
                  Left            =   1560
                  TabIndex        =   324
                  Text            =   "Cmb_TipDoc"
                  Top             =   2880
                  Width           =   3255
               End
               Begin VB.ComboBox Cmb_ModTipCta 
                  BackColor       =   &H00E0FFFF&
                  Height          =   315
                  Left            =   1560
                  Style           =   2  'Dropdown List
                  TabIndex        =   323
                  Top             =   2520
                  Width           =   3255
               End
               Begin VB.TextBox Txt_NroDocSecundario 
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   1560
                  TabIndex        =   322
                  Top             =   3240
                  Width           =   3255
               End
               Begin VB.TextBox Txt_NombreSecundario 
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   1560
                  TabIndex        =   321
                  Top             =   3600
                  Width           =   3255
               End
               Begin VB.TextBox Txt_ApellidosSecundario 
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   1560
                  TabIndex        =   320
                  Top             =   3960
                  Width           =   3255
               End
               Begin VB.ComboBox Cmb_Sucursal 
                  BackColor       =   &H00E0FFFF&
                  Height          =   315
                  ItemData        =   "Frm_EndosoPol.frx":1D3D
                  Left            =   1560
                  List            =   "Frm_EndosoPol.frx":1D3F
                  Style           =   2  'Dropdown List
                  TabIndex        =   313
                  Top             =   600
                  Width           =   3225
               End
               Begin VB.ComboBox Cmb_ViaPago 
                  BackColor       =   &H00E0FFFF&
                  Height          =   315
                  Left            =   1560
                  Style           =   2  'Dropdown List
                  TabIndex        =   312
                  Top             =   240
                  Width           =   3225
               End
               Begin VB.TextBox txt_CCI 
                  Height          =   285
                  Left            =   1560
                  MaxLength       =   25
                  TabIndex        =   310
                  Top             =   2180
                  Width           =   3225
               End
               Begin VB.ComboBox cmbBancoCtaBen 
                  BackColor       =   &H00E0FFFF&
                  Height          =   315
                  Left            =   1560
                  Style           =   2  'Dropdown List
                  TabIndex        =   286
                  Top             =   1540
                  Width           =   3225
               End
               Begin VB.ComboBox cmbMonctaBen 
                  BackColor       =   &H00E0FFFF&
                  Height          =   315
                  ItemData        =   "Frm_EndosoPol.frx":1D41
                  Left            =   1560
                  List            =   "Frm_EndosoPol.frx":1D43
                  Style           =   2  'Dropdown List
                  TabIndex        =   285
                  Top             =   1220
                  Width           =   3225
               End
               Begin VB.ComboBox cmbTipoCtaBen 
                  BackColor       =   &H00E0FFFF&
                  Height          =   315
                  Left            =   1560
                  Style           =   2  'Dropdown List
                  TabIndex        =   284
                  Top             =   910
                  Width           =   3225
               End
               Begin VB.TextBox txtNumctaBen 
                  Height          =   285
                  Left            =   1560
                  MaxLength       =   25
                  TabIndex        =   283
                  Top             =   1880
                  Width           =   3225
               End
               Begin VB.Label Label17 
                  Caption         =   "Mod Tip Cuenta"
                  Height          =   255
                  Left            =   120
                  TabIndex        =   329
                  Top             =   2520
                  Width           =   1335
               End
               Begin VB.Label lblTipDoc 
                  Caption         =   "Tip.Documento"
                  Height          =   255
                  Left            =   120
                  TabIndex        =   328
                  Top             =   2880
                  Width           =   1215
               End
               Begin VB.Label lbl_NroDocSecundario 
                  Caption         =   "Nro Doc."
                  Height          =   255
                  Left            =   120
                  TabIndex        =   327
                  Top             =   3240
                  Width           =   1095
               End
               Begin VB.Label lbl_NombreSecundario 
                  Caption         =   "Nombres"
                  Height          =   255
                  Left            =   120
                  TabIndex        =   326
                  Top             =   3600
                  Width           =   855
               End
               Begin VB.Label lbl_ApellidosSecundario 
                  Caption         =   "Apellidos"
                  Height          =   255
                  Left            =   120
                  TabIndex        =   325
                  Top             =   3960
                  Width           =   975
               End
               Begin VB.Label Lbl_Nombre 
                  Caption         =   "Vía Pago"
                  Height          =   255
                  Index           =   112
                  Left            =   135
                  TabIndex        =   315
                  Top             =   240
                  Width           =   810
               End
               Begin VB.Label lblTipmonCab 
                  Caption         =   "Sucursal"
                  Height          =   255
                  Left            =   120
                  TabIndex        =   314
                  Top             =   580
                  Width           =   975
               End
               Begin VB.Label Lbl_Nombre 
                  Caption         =   "N°CCI"
                  Height          =   255
                  Index           =   111
                  Left            =   130
                  TabIndex        =   311
                  Top             =   2180
                  Width           =   795
               End
               Begin VB.Label Lbl_Nombre 
                  Caption         =   "Mon. Cta."
                  Height          =   255
                  Index           =   109
                  Left            =   135
                  TabIndex        =   290
                  Top             =   1275
                  Width           =   810
               End
               Begin VB.Label Lbl_Nombre 
                  Caption         =   "N°Cuenta"
                  Height          =   255
                  Index           =   108
                  Left            =   135
                  TabIndex        =   289
                  Top             =   1850
                  Width           =   795
               End
               Begin VB.Label Lbl_Nombre 
                  Caption         =   "Banco"
                  Height          =   255
                  Index           =   107
                  Left            =   135
                  TabIndex        =   288
                  Top             =   1570
                  Width           =   825
               End
               Begin VB.Label Lbl_Nombre 
                  Caption         =   "Tipo Cta."
                  Height          =   255
                  Index           =   106
                  Left            =   120
                  TabIndex        =   287
                  Top             =   940
                  Width           =   825
               End
            End
            Begin VB.CommandButton cmdDirec 
               Caption         =   "+"
               Height          =   255
               Left            =   8195
               TabIndex        =   318
               Top             =   1080
               Width           =   255
            End
            Begin VB.CheckBox chkConUsoDatosCom_Ben 
               Caption         =   "Consentimiento de uso de datos para fines comerciales"
               Height          =   375
               Left            =   4320
               TabIndex        =   317
               Top             =   2040
               Width           =   4215
            End
            Begin VB.CheckBox chkConTratDatos_Ben 
               Caption         =   "Consentimiento de Tratamiento de Datos"
               Height          =   375
               Left            =   4320
               TabIndex        =   316
               Top             =   1680
               Width           =   3255
            End
            Begin VB.CheckBox chkEnvioBolElec 
               Caption         =   "Enviar Boletas Electrónicas"
               Height          =   255
               Left            =   1680
               TabIndex        =   309
               Top             =   180
               Width           =   2325
            End
            Begin VB.TextBox Txt_BMNumIden 
               Height          =   285
               Left            =   6360
               MaxLength       =   10
               TabIndex        =   278
               Top             =   195
               Width           =   1815
            End
            Begin VB.ComboBox Cmb_BMNumIdent 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               Left            =   4920
               Style           =   2  'Dropdown List
               TabIndex        =   277
               Top             =   180
               Width           =   1395
            End
            Begin VB.TextBox txtBenEmail 
               Height          =   285
               Left            =   4920
               TabIndex        =   262
               Top             =   765
               Width           =   3255
            End
            Begin VB.TextBox txtDistritoBen 
               Height          =   285
               Left            =   4920
               TabIndex        =   260
               Top             =   1350
               Width           =   3255
            End
            Begin VB.TextBox txtcodDirBen 
               Height          =   285
               Left            =   4200
               TabIndex        =   259
               Top             =   4560
               Visible         =   0   'False
               Width           =   975
            End
            Begin VB.CommandButton Cmd_BuscarDir 
               Caption         =   "?"
               BeginProperty Font 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Left            =   8160
               Style           =   1  'Graphical
               TabIndex        =   258
               ToolTipText     =   "Efectuar Busqueda de Dirección"
               Top             =   1350
               Width           =   300
            End
            Begin VB.TextBox txtTelfon2 
               Height          =   285
               Left            =   6840
               TabIndex        =   254
               Top             =   480
               Width           =   1335
            End
            Begin VB.TextBox txtFecdevBen 
               BackColor       =   &H80000004&
               Height          =   285
               Left            =   10320
               TabIndex        =   253
               Top             =   1920
               Width           =   1215
            End
            Begin VB.ComboBox cmbSexoBen 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               Left            =   9600
               TabIndex        =   251
               Top             =   2760
               Width           =   1575
            End
            Begin VB.TextBox txtFecnacBen 
               Height          =   285
               Left            =   4440
               TabIndex        =   249
               Top             =   4680
               Width           =   1215
            End
            Begin VB.ComboBox cmbTipoPreBen 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               Left            =   9600
               TabIndex        =   247
               Top             =   3360
               Width           =   3015
            End
            Begin VB.ComboBox cmbAfpBen 
               BackColor       =   &H00E0FFFF&
               Height          =   315
               Left            =   5760
               TabIndex        =   245
               Top             =   4560
               Width           =   2655
            End
            Begin VB.TextBox txtCusspBen 
               Height          =   285
               Left            =   6360
               TabIndex        =   243
               Top             =   4680
               Width           =   1335
            End
            Begin VB.TextBox txtTelBen 
               Height          =   285
               Left            =   4920
               TabIndex        =   241
               Top             =   480
               Width           =   1335
            End
            Begin VB.TextBox txt_dirben 
               Height          =   285
               Left            =   4920
               MaxLength       =   120
               TabIndex        =   239
               Top             =   1050
               Width           =   3255
            End
            Begin VB.TextBox txtApematBen 
               Height          =   285
               Left            =   1080
               MaxLength       =   50
               TabIndex        =   237
               Top             =   1350
               Width           =   2985
            End
            Begin VB.TextBox txtApepatBen 
               Height          =   285
               Left            =   1080
               MaxLength       =   50
               TabIndex        =   235
               Top             =   1050
               Width           =   2985
            End
            Begin VB.TextBox txtNomsegBen 
               Height          =   285
               Left            =   1080
               MaxLength       =   50
               TabIndex        =   233
               Top             =   765
               Width           =   2985
            End
            Begin VB.TextBox txtNomben 
               Height          =   285
               Left            =   1080
               MaxLength       =   50
               TabIndex        =   231
               Top             =   480
               Width           =   2985
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Nº Orden"
               Height          =   255
               Index           =   71
               Left            =   120
               TabIndex        =   281
               Top             =   195
               Width           =   975
            End
            Begin VB.Label Lbl_BMNumOrd 
               BackColor       =   &H00E0FFFF&
               BorderStyle     =   1  'Fixed Single
               Enabled         =   0   'False
               Height          =   285
               Left            =   1080
               TabIndex        =   280
               Top             =   195
               Width           =   495
            End
            Begin VB.Label Lbl_Nombre 
               BackStyle       =   0  'Transparent
               Caption         =   "Nº Ident."
               Height          =   255
               Index           =   68
               Left            =   4200
               TabIndex        =   279
               Top             =   195
               Width           =   735
            End
            Begin VB.Label Label15 
               Caption         =   "E-mail"
               Height          =   255
               Left            =   4200
               TabIndex        =   261
               Top             =   765
               Width           =   615
            End
            Begin VB.Label Lbl_Distrito 
               BackColor       =   &H80000018&
               BorderStyle     =   1  'Fixed Single
               Height          =   285
               Left            =   120
               TabIndex        =   257
               Top             =   4680
               Visible         =   0   'False
               Width           =   2895
            End
            Begin VB.Label Lbl_Afiliado 
               Caption         =   "Distrito"
               Height          =   255
               Index           =   12
               Left            =   4200
               TabIndex        =   256
               Top             =   1350
               Width           =   615
            End
            Begin VB.Label Label14 
               Caption         =   "/"
               Height          =   255
               Left            =   6480
               TabIndex        =   255
               Top             =   480
               Width           =   255
            End
            Begin VB.Line Line2 
               X1              =   120
               X2              =   8400
               Y1              =   4440
               Y2              =   4440
            End
            Begin VB.Label Label13 
               Caption         =   "Fech.Dev."
               Height          =   255
               Left            =   9600
               TabIndex        =   252
               Top             =   1920
               Width           =   735
            End
            Begin VB.Label Label12 
               Caption         =   "Sexo"
               Height          =   255
               Left            =   9600
               TabIndex        =   250
               Top             =   2280
               Width           =   615
            End
            Begin VB.Label Label11 
               Caption         =   "Fech.Nac."
               Height          =   255
               Left            =   3600
               TabIndex        =   248
               Top             =   4680
               Width           =   735
            End
            Begin VB.Label Label10 
               Caption         =   "Tipo de Pens."
               Height          =   255
               Left            =   9480
               TabIndex        =   246
               Top             =   3360
               Width           =   1095
            End
            Begin VB.Label Label9 
               Caption         =   "AFP"
               Height          =   255
               Left            =   5400
               TabIndex        =   244
               Top             =   4560
               Width           =   495
            End
            Begin VB.Label Label7 
               Caption         =   "Cuspp"
               Height          =   255
               Left            =   5640
               TabIndex        =   242
               Top             =   4680
               Width           =   855
            End
            Begin VB.Label Label6 
               Caption         =   "Telf 1."
               Height          =   255
               Left            =   4200
               TabIndex        =   240
               Top             =   480
               Width           =   615
            End
            Begin VB.Label Label5 
               Caption         =   "Direccion"
               Height          =   255
               Left            =   4200
               TabIndex        =   238
               Top             =   1050
               Width           =   855
            End
            Begin VB.Label Label4 
               Caption         =   "Apellido Mat."
               Height          =   255
               Left            =   120
               TabIndex        =   236
               Top             =   1350
               Width           =   1095
            End
            Begin VB.Label Label3 
               Caption         =   "Apellido Pat."
               Height          =   255
               Left            =   120
               TabIndex        =   234
               Top             =   1050
               Width           =   1095
            End
            Begin VB.Label Label2 
               Caption         =   "Seg. Nom"
               Height          =   255
               Left            =   120
               TabIndex        =   232
               Top             =   765
               Width           =   855
            End
            Begin VB.Label Label1 
               Caption         =   "Nombre "
               Height          =   255
               Left            =   120
               TabIndex        =   230
               Top             =   480
               Width           =   1095
            End
         End
      End
   End
   Begin VB.Frame Fra_Operacion 
      Height          =   9375
      Left            =   10560
      TabIndex        =   60
      Top             =   0
      Width           =   1215
      Begin VB.CommandButton cmd_ActivaCertif 
         Caption         =   "&Activar"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":1D45
         Style           =   1  'Graphical
         TabIndex        =   274
         ToolTipText     =   "Activar "
         Top             =   2570
         Width           =   720
      End
      Begin VB.CommandButton Cmd_Aprobar 
         Caption         =   "&Aprobar"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":2C0F
         Style           =   1  'Graphical
         TabIndex        =   49
         ToolTipText     =   "Grabar Datos"
         Top             =   5640
         Width           =   720
      End
      Begin VB.CommandButton Cmd_ImprimirPRE 
         Caption         =   "Pre End"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":32C9
         Style           =   1  'Graphical
         TabIndex        =   48
         Top             =   4920
         Visible         =   0   'False
         Width           =   720
      End
      Begin VB.CommandButton Cmd_Eliminar 
         Caption         =   "&Eliminar"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":3983
         Style           =   1  'Graphical
         TabIndex        =   47
         Top             =   4200
         Width           =   720
      End
      Begin VB.CommandButton Cmd_Grabar 
         Caption         =   "&Grabar"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":3CC5
         Style           =   1  'Graphical
         TabIndex        =   46
         ToolTipText     =   "Grabar Datos"
         Top             =   3480
         Width           =   720
      End
      Begin VB.CommandButton Cmd_Salir 
         Caption         =   "&Salir"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":437F
         Style           =   1  'Graphical
         TabIndex        =   53
         ToolTipText     =   "Salir del Formulario"
         Top             =   8640
         Width           =   720
      End
      Begin VB.CommandButton Cmd_Cancelar 
         Caption         =   "&Cancelar"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":4479
         Style           =   1  'Graphical
         TabIndex        =   52
         Top             =   7800
         Width           =   720
      End
      Begin VB.CommandButton Cmd_Modificar 
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":4A53
         Style           =   1  'Graphical
         TabIndex        =   45
         ToolTipText     =   "Modificar lo Calculado"
         Top             =   1870
         Width           =   720
      End
      Begin VB.CommandButton Cmd_Cargar 
         Caption         =   "&Cargar"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":4E95
         Style           =   1  'Graphical
         TabIndex        =   43
         ToolTipText     =   "Carga de Datos de Póliza Original"
         Top             =   240
         Width           =   720
      End
      Begin VB.CommandButton Cmd_Calcular 
         Caption         =   "&Calcular"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":56B7
         Style           =   1  'Graphical
         TabIndex        =   44
         ToolTipText     =   "Calcular Monto de Pensión"
         Top             =   1200
         Width           =   720
      End
      Begin VB.CommandButton Cmd_Limpiar 
         Caption         =   "&Limpiar"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":5B59
         Style           =   1  'Graphical
         TabIndex        =   51
         ToolTipText     =   "Limpiar Formulario"
         Top             =   7080
         Width           =   720
      End
      Begin Crystal.CrystalReport Rpt_Reporte 
         Left            =   120
         Top             =   240
         _ExtentX        =   741
         _ExtentY        =   741
         _Version        =   348160
         WindowState     =   2
         PrintFileLinesPerPage=   60
      End
      Begin VB.CommandButton Cmd_Imprimir 
         Caption         =   "Endoso"
         Height          =   675
         Left            =   240
         Picture         =   "Frm_EndosoPol.frx":6213
         Style           =   1  'Graphical
         TabIndex        =   50
         Top             =   6360
         Width           =   720
      End
      Begin VB.Line Lin_Borde 
         BorderColor     =   &H00808080&
         Index           =   1
         X1              =   240
         X2              =   960
         Y1              =   1050
         Y2              =   1050
      End
      Begin VB.Line Lin_Borde 
         BorderColor     =   &H00808080&
         Index           =   2
         X1              =   240
         X2              =   960
         Y1              =   3360
         Y2              =   3360
      End
   End
End
Attribute VB_Name = "Frm_EndosoPol"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
'Option Explicit

Const clMonedaEndOri_Poliza As Integer = 0
Const clMonedaEndOri_BenPension As Integer = 1
Const clMonedaEndMod_Poliza As Integer = 2
Const clMonedaEndMod_PolizaCal As Integer = 3
Const clMonedaEndMod_BenPension As Integer = 4
Const clMonedaEndMod_BenPensionGar As Integer = 5

Dim vlNumBen As Integer 'Cantidad de Beneficiarios de la Poliza
Dim vlTipoPen As String 'Cod-Gls Tipo de Pension Poliza
Dim vlEstVigencia As String 'Cod-Gls Estado de Vigencia de Poliza
Dim vlTipoRta As String 'Cod-Gls Tipo de Renta Poliza
Dim vlModalidad As String 'Cod-Gls Modalidad Poliza

Dim vlPar As String 'Cod_Gls Parentesco de Beneficiario
Dim vlCauInv As String 'Cod_Gls Causal de Invalidez de Beneficiario

Dim vlArchivo As String
Dim vlCodTipoIdenAux As String
Dim vlNumIdenAux As String
Dim vlPos As Integer
Dim vlTablaPoliza As String
Dim vlTablaBen As String
Dim vlTipoBuscar As String * 1
Dim vlPalabraAux As String
Dim vlNumero As Integer
Dim vlOpcion As String
Dim vlAnno As String
Dim vlMes As String
Dim vlDia As String
Dim vlSwValidaOK As Boolean
Dim vlSwAprobar As Boolean
Dim vlSwGrabar As Boolean
Dim vlSwCalIntOK As Boolean 'Sw de boton de calculo interior
Dim vlSwCalExtOK As Boolean 'Sw de boton de calculo exterior

Dim vlcobertura As String
Dim vlRptCodInsSalud As String 'Código Institución de Salud
Dim vlRptCodAfp As String 'Código de AFP
Dim vlRptCodTipRen As String 'Código de Tipo de Renta (Cobertura)
Dim vlRptCodTipPension As String 'Código de Tipo de Pensión
Dim vlRptNomInter As String 'Nombre Intermediario
Dim vlRptRutInter As String 'Rut Intermediario
Dim vlRptComInter As String 'Comisión Intermediario
Dim vlRptNumEndosoEnd As Integer
Dim vlRptNumEndosoPol As Integer
Dim vlRptRutBen As String
Dim vlRptNomBen As String
Dim vlRptGlsDirBen As String
Dim vlRptFonoBen As String
Dim vlRptComuna As String
Dim vlRptRegion As String
Dim vlRptProvincia As String
Dim vlRptGlsCauEndoso As String
Dim vlRptGlsCauEndoso2 As String
Dim vlRptFechaVigEndoso As String
Dim vlRptMtoPension As Double
Dim vlRptMtoPensionOri As Double
Dim vlRptMtoRtaMod As Double
Dim vlRptGlsFactorEndoso As String 'Texto Aumenta o Disminuye
'RRR
Dim vlRptNomBeNue As String
Dim vlRptGlsDirBenNue As String
Dim vlRptFonoBenNue As String
Dim vlRptCodDireccionNue As String
Dim vlRptCorreo As String
Dim vlRptDocNum As String

'Beneficiario
Dim vlNumOrden As Integer
Dim vlCodTipoIdenBen As String
Dim vlNomTipoIdenBen As String
Dim vlNumIdenBen As String
Dim vlNombreCompleto As String
'INICIO GCP-FRACTAL 16042019
Dim vl_CONS_TRAINFO_rpt As String
Dim vl_CONS_DATCOMER_rpt As String
'FIN GCP-FRACTAL 16042019

Dim vlNomBen As String
Dim vlNomSegBen As String
Dim vlPaternoBen As String
Dim vlMaternoBen As String
Dim vlCodPar As String
Dim vlCodGruFam As String
Dim vlCodSexo As String
Dim vlCodSitInv As String
Dim vlCodEstPension As String
Dim vlCodDerpen As String
Dim vlCodDerCre As String
Dim vlNumPoliza As String
Dim vlNumEndoso As Integer
Dim vlCodCauInv As String
Dim vlFecNacBen As String
Dim vlFecNacHM As String
Dim vlFecInvBen As String
Dim vlCodMotReqPen As String
Dim vlMtoPensionGar As Double
Dim vlPrcPension As Double
Dim vlFecFallBen As String
Dim vlCodCauSusBen As String
Dim vlFecSusBen As String
Dim vlFecIniPagoPen As String
Dim vlFecTerPagoPenGar As String
Dim vlFecTerPagoPenDif As String
Dim vlFecIngreso As String
Dim vlGlsDirBen As String
Dim vlCodDireccion As Integer
Dim vlGlsFonoBen As String
Dim vlGlsCorreoBen As String
Dim vlGlsTelben2 As String 'RRR 08/05/2013
Dim vlCodInsSalud As String
Dim vlCodModSalud As String
Dim vlMtoPlanSalud As Double
Dim vlCodCajaCompen As String
Dim vlCodViaPago As String
Dim vlCodBanco As String
Dim vlCodTipCuenta As String
Dim vlNumCuenta As String
Dim vlCodSucursal As String
Dim vlFecMatrimonio As String
Dim vlPrcPensionGar As Double
Dim vlPrcPensionLeg As Double
Dim vlBenefNuevo  As Boolean
Dim vlCodTipcta, vlcodmonbco, vlnumctabco, vlnumctacci, vlSucursal, vlViaPago  As String 'RRR 24/01/2014
Dim vl_ConTratDatos_Ben As String
Dim vl_ConUsoDatosCom_Ben As String

Dim vl_COD_MODTIPOCUENTA_MANC As String
Dim vl_COD_TIPODOC_MANC As String
Dim vl_NUM_DOC_MANC As String
Dim vl_NOMBRE_MANC As String
Dim vl_APELLIDO_MANC As String


Dim vlMtoPensionB As Double      'RRR 24/01/2014
Dim vlMtoPensionGarB As Double   'RRR 24/01/2014
Dim vlFecIniPago As String       'RRR 24/01/2014
Dim vlFecDevSol As String        'RRR 17/02/2015
Dim vliEstDsco As String         'RRR 28/09/2016
Dim vliEstBelc As String         'RRR 13/11/2018

'Poliza
Dim vlCodTipPension As String
Dim vlCodEstado As String
Dim vlCodTipRen As String
Dim vlCodModalidad As String
Dim vlNumCargas As Integer
Dim vlFecVigencia As String
Dim vlFecTerVigencia As String
Dim vlMtoPrima As String
Dim vlMtoPension As Double
Dim vlNumMesDif As Integer
Dim vlNumMesGar As Integer
Dim vlPrcTasaCe As Double
Dim vlPrcTasaVta As Double
Dim vlPrcTasaIntPerGar As Double
Dim vlCodAFP As String
Dim vlPrcTasaCtoRea As Double
Dim vlCodMoneda As String
Dim vlValMoneda As Double
Dim vlFecDevengue As String
Dim vlFecEmision As String
Dim vlFecIniPenCia As String
Dim vlIndCobertura As String
Dim vlCobCoberCon As String
Dim vlMtoFacPenElla As Double
Dim vlPrcFacPenElla As Double
Dim vlCodDerCrecer As String
Dim vlCodDerGratificacion As String
Dim vlCodDerGra As String
Dim vlCodCuspp As String
Dim vlFecPriPago As String
Dim vlPrcTasaTir As Double
Dim vlMtoPensionActOriginal   As Double
Dim vlMtoPensionActModificada As Double
Dim vlFecCotizacion As String
Dim vlCodTipReajuste As String 'hqr 13/01/2011
Dim vlMtoValReajusteTri As Double 'hqr 13/01/2011
Dim vlMtoValReajusteMen As Double 'hqr 22/02/2011

'Endoso
Dim vlFecSolEndoso As String
Dim vlFecEndoso As String
Dim vlCodCauEndoso As String
Dim vlCodTipEndoso As String
Dim vlMtoDiferencia As Double
Dim vlFecEfectoEnd As String
Dim vlObsEndoso As String
Dim vlMtoPensionOri As Double
Dim vlMtoPensionCal As Double
Dim vlPrcFactor As Double
Dim vlPorcentaje As Double

Dim vlGlsUsuarioCrea As Variant
Dim vlFecCrea As Variant
Dim vlHorCrea As Variant
Dim vlGlsUsuarioModi As Variant
Dim vlFecModi As Variant
Dim vlHorModi As Variant

Const clTablaPolizaOri As String = "PP_TMAE_POLIZA"
Const clTablaPolizaTmp As String = "PP_TMAE_ENDPOLIZA"
Const clTablaBenOri As String = "PP_TMAE_BEN"
Const clTablaBenTmp As String = "PP_TMAE_ENDBEN"
Const clCodParCau As String * 2 = "99"
Const clMesesMax As Integer = 1200
Const clMtoTope As Double = 999999999.99
Const clFechaTopeTer As String * 8 = "99991231"
Const clTipPenSob As String = "01,03,08,09,10,11,12,13,15"
Const clCodConDerPen As String * 2 = "99"
Const clCodSinDerPen As String * 2 = "10"
Const clCCAFSinInfo As String * 2 = "00"
'Constantes Reportes
Const clRptOrigen As String = "Privada ó Previsional"
Const clRptAumenta As String = "Aumenta en "
Const clRptDisminuye As String = "Disminuye en "
Const clRptMantiene As String = "Se Mantiene en "

'I--- ABV 13/04/2005 ---
Dim vlMontoPensionFinal As Double
Dim vlReservaOriginal   As Double
Dim vlReservaCalculada  As Double
Dim vlValor             As Long
Dim vlFactor            As Double
Dim vlPenBenef          As Double
Dim vlPenGarBenef       As Double
Dim vlPorcBenef         As Double
Dim vlSwEncontrado      As Boolean 'Sw de boton restar beneficiario
Dim vlPorcGarBenef      As Double

Const clPensionInvVejez  As String = "02,04,05,06,07,14"
Const clPensionSobOrigen As String = "08,13"
Const clPensionSobTransf As String = "01,03,09,10,11,12,15"

Const clParConyugeMadre  As String = "10,11,20,21"
Const clCodTablaSaludPrc As String = "PSM"

'Causas de Suspensión
Const clCodCauSusSin    As String = "00" 'Sin motivo
Const clCodCauSusNoCert As String = "01" 'No presenta Certificado Estudio
Const clCodCauSusFall   As String = "02" 'Fallecimiento
Const clCodCauSusMatHij As String = "03" 'Matrimonio de Hijo
Const clCodCauSusNulMat As String = "04" 'Nulidad del Matrimonio
Const clCodCauSusRenBen As String = "05" 'Renuncia a solicitud de Benef.
'Motivos de Requisito Pensión
Const clCodMotReqNoCons   As String = "1"  'No Constituye Excepción
Const clCodMotReqExCony   As String = "2"  'Ex Cónyuge
Const clCodMotReqExMadre  As String = "3"  'Ex MHN
Const clCodMotReqHijSinD  As String = "4"  'Hijo Sin Derecho
Const clCodMotReqConyPos  As String = "5"  'Cónyuge Post Póliza
Const clCodMotReqExBenDes As String = "6"  'Ex Beneficiario Designado


'Tipos de Pensiones Individualizadas
Const clTipPension04 As String * 2 = "04" 'Vejez Normal
Const clTipPension05 As String * 2 = "05" 'Vejez Anticipada
Const clTipPension06 As String * 2 = "06" 'Invalidez Total
Const clTipPension07 As String * 2 = "07" 'Invalidez Parcial
Const clTipPension09 As String * 2 = "09" 'Sobrevivencia de Vejez Normal
Const clTipPension10 As String * 2 = "10" 'Sobrevivencia de Vejez Anticipada
Const clTipPension11 As String * 2 = "11" 'Sobrevivencia de Invalidez Total
Const clTipPension12 As String * 2 = "12" 'Sobrevivencia de Invalidez Parcial

Dim vlMontoPensionPrima As Double
Dim vlTablaPolizaOriginal As String
Dim vlTablaBenOriginal As String

'Variables que registran valores por Defecto
Dim vlDefCodDireccion As String
Dim vlDefGlsDirBen    As String
Dim vlDefGlsFonoBen   As String
Dim vlDefGlsCorreoBen As String
Dim vlDefglsTelben2   As String
Dim vlDefCodInsSalud  As String
Dim vlDefCodModSalud  As String
Dim vlDefMtoPlanSalud As Double
Dim vlDefCodViaPago   As String
Dim vlDefCodBanco     As String
Dim vlDefCodTipCuenta As String
Dim vlDefNumCuenta    As String
Dim vlDefCodSucursal  As String
Dim vlDefCodCajaCompen As String

Dim vlGlobalNumPoliza      As String
Dim vlGlobalNumEndoso      As String
Dim vlGlobalNumEndosoCrear As String

Dim vlRptCodDireccion As String

Dim vlSeCalculaPension As Boolean
'F--- ABV 13/04/2005 ---

'CMV-20051024 I
Dim vlFecFinEfecto As String
Dim vlCodEstadoEndoso As String
Const clFechaTope As String = "99991231"
Const clCodEstadoP As String * 1 = "P"
Const clCodEstadoE As String * 1 = "E"
'CMV-20051024 F

'CMV-20051103 I
Dim vlValCodSitInv As String

Const clCodCauInvNoInv As String * 1 = "0"
Const clCodSitInvNoInv As String * 1 = "N"
'CMV-20051103 F

Dim vlLargoTipoIden    As Integer 'sirve para llenar la grilla
Dim vlPosicionTipoIden As Integer 'sirve para llenar la grilla

'Parámetros de Impresión
Dim vlNombre As String, vlNombreSeg As String
Dim vlPaterno As String, vlMaterno As String
Dim vlNombreTipoIden As String
Dim vlImpCodMoneda As String, vlImpNomMoneda As String
Dim vlMantPerGar As String
'CORPTEC
Dim num_log_Tabla  As Integer
Dim vlLog_tabla As String
Dim vlLog_idtabla As String
Dim vlLog_valtabla As String
Dim vlLog_trans As String

'Implementacion GobiernoDeDatos(Se crean las variables)
Dim vgCodDireccion As String
Dim codComuna As String
Dim codRegion As String
Dim codProvincia As String
Public pgCodDireccion As String
Public pTipoTelefono As String
Public pNumTelefono As String
Public pCodigoTelefono As String
Public pTipoTelefono2 As String
Public pNumTelefono2 As String
Public pCodigoTelefono2 As String
Public pTipoVia As String
Public pDireccion As String
Public pNumero As String
Public pTipoPref As String
Public pInterior As String
Public pManzana As String
Public pLote As String
Public pEtapa As String
Public pTipoConj As String
Public pConjHabit As String
Public pTipoBlock As String
Public pNumBlock As String
Public pReferencia As String
Public pConcatDirec As String
'fin Implementacion GobiernoDeDatos

Public cnnConexion As ADODB.Connection

Dim vlBolelec As String
Dim vlheren As String 'RRR 15112018
Dim edad_mes_ben, fecha_sin, fecha_eda, vlEsEdadLeg As Integer
Dim sfechaE, sfechaN As String
Dim SwActivacion As Boolean
Dim VlcodCausaFac As String
Dim Vl_numOrdCausaFac As Integer
Dim VSw_Pruebas As Boolean


Private Type Struc_Cert
    pnum_poliza As String
    pnum_orden As Integer
    PENDFECEFECTO As String
    PCODUSUARIO As String
End Type



 'CORPTEC
'FUNCION PARA REGISTRAR EL INICIO DEL LOG DE PROCESO :CARGA DE ARCHIVO 11-08-2017

Function flLog_Tabla() As Boolean
     Dim objCommand As ADODB.Command
   Dim objRs As ADODB.Recordset
    Dim sistema, modulo, opcion, origen, tipo As String
    sistema = "SEACSA"
    modulo = "PENSIONES"
    opcion = "ENDOSOS"
    origen = "A"
    tipo = "T"
    
   Set objCommand = New ADODB.Command
   Set objRs = New ADODB.Recordset
   
  ' vgConexionBD.Open
    'vgConexionBD.BeginTrans
    objCommand.ActiveConnection = vgConexionBD
    objCommand.CommandText = "SP_LOG_TABLAS"
    objCommand.CommandType = adCmdStoredProc
    
    objCommand.Parameters.Append objCommand.CreateParameter("TRANS", adChar, adParamInput, 3, vlLog_trans)
    objCommand.Parameters.Append objCommand.CreateParameter("TABLA", adVarChar, adParamInput, 50, vlLog_tabla)
    objCommand.Parameters.Append objCommand.CreateParameter("IDTABLA", adVarChar, adParamInput, 50, vlLog_idtabla)
    objCommand.Parameters.Append objCommand.CreateParameter("VALTABLA", adVarChar, adParamInput, 50, vlLog_valtabla)
    objCommand.Parameters.Append objCommand.CreateParameter("USUARIO", adVarChar, adParamInput, 10, vgLogin)
    objCommand.Parameters.Append objCommand.CreateParameter("SISTEMA", adVarChar, adParamInput, 50, sistema)
    objCommand.Parameters.Append objCommand.CreateParameter("MODULO", adVarChar, adParamInput, 50, modulo)
    objCommand.Parameters.Append objCommand.CreateParameter("OPCION", adVarChar, adParamInput, 50, opcion)
    objCommand.Parameters.Append objCommand.CreateParameter("ORIGEN", adChar, adParamInput, 1, origen)
    objCommand.Parameters.Append objCommand.CreateParameter("TIPO", adChar, adParamInput, 1, tipo)
    objCommand.Parameters.Append objCommand.CreateParameter("IDLOG", adDouble, adParamInput, 2, 0)
   ' com.Parameters.Append com.CreateParameter("Retorno", adTinyInt, adParamReturnValue)
    Set objRs = objCommand.Execute
   ' vgConexionBD.CommitTrans
   'vgConexionBD.Close
   Set objRs = Nothing
   Set objCommand = Nothing
 
End Function

'''************************ F U N C I O N E S ******************

Function flLimpiarVariables()

    vlNumBen = 0
    vlTipoPen = ""
    vlEstVigencia = ""
    vlTipoRta = ""
    vlModalidad = ""
    vlPar = ""
    vlCauInv = ""
    
'    vlMtoPensionActOriginal = 0
'    vlMtoPensionActModificada = 0
    
    vlCodTipoIdenAux = ""
    vlPos = 0
'    vlTablaPoliza = ""
'    vlTablaBen = ""
'    vlTipoBuscar = ""
    vlTipoBuscar = "N"
    vlTablaPoliza = clTablaPolizaOri
    vlTablaBen = clTablaBenOri

    vlPalabraAux = ""
    vlNumero = 0
    vlOpcion = ""
    
    vlSwValidaOK = False
    vlSwCalIntOK = False
    vlSwCalExtOK = False
    
    vlSwGrabar = False
    vlSwAprobar = False
    
    'Beneficiario
    vlNumOrden = 0
    vlCodTipoIdenBen = ""
    vlNumIdenBen = ""
    vlNomBen = ""
    vlPaternoBen = ""
    vlMaternoBen = ""
    vlCodPar = ""
    vlCodGruFam = ""
    vlCodSexo = ""
    vlCodSitInv = ""
    vlCodEstPension = ""
    vlCodDerpen = ""
    vlCodDerCre = ""
    vlNumPoliza = ""
    vlNumEndoso = 0
    vlCodCauInv = ""
    vlFecNacBen = ""
    vlFecNacHM = ""
    vlFecInvBen = ""
    vlCodMotReqPen = ""
    vlMtoPensionGar = 0
    vlPrcPension = 0
    vlFecFallBen = ""
    vlCodCauSusBen = ""
    vlFecSusBen = ""
    vlFecIniPagoPen = ""
    vlFecTerPagoPenGar = ""
    vlFecMatrimonio = ""
    vlPrcPensionLeg = 0
    vlPrcPensionGar = 0
    
    'Poliza
    vlCodTipPension = ""
    vlCodEstado = ""
    vlCodTipRen = ""
    vlCodModalidad = ""
    vlNumCargas = 0
    vlFecVigencia = ""
    vlFecTerVigencia = ""
    vlMtoPrima = ""
    vlMtoPension = 0
    vlNumMesDif = 0
    vlNumMesGar = 0
    vlPrcTasaCe = 0
    vlPrcTasaVta = 0
    vlPrcTasaIntPerGar = 0
    vlPrcPensionLeg = 0
    vlPrcPensionGar = 0
    vlFecDevengue = ""
    vlFecEmision = ""
    vlIndCobertura = ""
    vlCobCoberCon = ""
    vlCodDerCrecer = ""
    vlCodDerGratificacion = ""
    
    'Endoso
    vlFecSolEndoso = ""
    vlFecEndoso = ""
    vlCodCauEndoso = ""
    vlCodTipEndoso = ""
    vlMtoDiferencia = 0
    
    vlGlsUsuarioCrea = ""
    vlFecCrea = 0
    vlHorCrea = 0
    vlGlsUsuarioModi = 0
    vlFecModi = 0
    vlHorModi = 0
    
      vlCodCauEndoso = ""
      Vl_numOrdCausaFac = 0
      VlcodCausaFac = ""
      vlCodMoneda = ""

End Function


''Function flCargaEstructuraPoliza(iNombreTabla As String, ipoliza As String, iEndoso As Integer, istPoliza As TyPoliza)
''On Error GoTo Err_flCargaEstructuraPoliza
''
''    vgSql = ""
''    vgSql = "SELECT num_poliza,num_endoso,cod_tippension,cod_estado, "
''    vgSql = vgSql & "cod_tipren,cod_modalidad,num_cargas,fec_vigencia, "
''    vgSql = vgSql & "fec_tervigencia,mto_prima,mto_pension,num_mesdif, "
''    vgSql = vgSql & "num_mesgar,prc_tasace,prc_tasavta,prc_tasaintpergar "
''    vgSql = vgSql & "FROM " & iNombreTabla & " WHERE "
''    vgSql = vgSql & "num_poliza = '" & Trim(ipoliza) & "' AND "
''    vgSql = vgSql & "num_endoso = " & iEndoso & " "
''    vgSql = vgSql & " ORDER BY num_endoso DESC"
''    Set vgRegistro = vgConexionBD.Execute(vgSql)
''    If Not vgRegistro.EOF Then
''       With istPoliza
''            .Num_Poliza = (vgRegistro!Num_Poliza)
''            .num_endoso = (vgRegistro!num_endoso)
''            .Cod_TipPension = (vgRegistro!Cod_TipPension)
''            .Cod_Estado = (vgRegistro!Cod_Estado)
''            .Cod_TipRen = (vgRegistro!Cod_TipRen)
''            .Cod_Modalidad = (vgRegistro!Cod_Modalidad)
''            .Num_Cargas = (vgRegistro!Num_Cargas)
''            .Fec_Vigencia = (vgRegistro!Fec_Vigencia)
''            .Fec_TerVigencia = (vgRegistro!Fec_TerVigencia)
''            .Mto_Prima = (vgRegistro!Mto_Prima)
''            .Mto_Pension = (vgRegistro!Mto_Pension)
''            .Num_MesDif = (vgRegistro!Num_MesDif)
''            .Num_MesGar = (vgRegistro!Num_MesGar)
''            .Prc_TasaCe = (vgRegistro!Prc_TasaCe)
''            .Prc_TasaVta = (vgRegistro!Prc_TasaVta)
''            .Prc_TasaIntPerGar = (vgRegistro!Prc_TasaIntPerGar)
''       End With
''    End If
''
''Exit Function
''Err_flCargaEstructuraPoliza:
''    Screen.MousePointer = 0
''    Select Case Err
''        Case Else
''        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
''    End Select
''
''End Function
''
''Function flCargaEstructuraBeneficiarios(iNombreTabla As String, ipoliza As String, iEndoso As Integer, istBeneficiarios As TyBeneficiarios)
''On Error GoTo Err_flCargaEstructuraBeneficiarios
''
''    vgSql = ""
''    vgSql = "SELECT COUNT (num_orden) as numero "
''    vgSql = vgSql & "FROM " & iNombreTabla & " WHERE "
''    vgSql = vgSql & "num_poliza = '" & Trim(ipoliza) & "' AND "
''    vgSql = vgSql & "num_endoso = " & iEndoso & " "
''    Set vgRegistro = vgConexionBD.Execute(vgSql)
''    If Not vgRegistro.EOF Then
''       vlNumBen = (vgRegistro!numero)
''    End If
''
''    ReDim istBeneficiarios(vlNumBen) As TyBeneficiarios
''
''    vgSql = ""
''    vgSql = "SELECT num_poliza,num_endoso,num_orden,Cod_TipoIdenben,Num_Idenben, "
''    vgSql = vgSql & "gls_nomben,gls_patben,gls_matben,cod_grufam, "
''    vgSql = vgSql & "cod_par,cod_sexo,cod_sitinv,cod_dercre,cod_derpen, "
''    vgSql = vgSql & "cod_cauinv,fec_nacben,fec_nachm,fec_invben, "
''    vgSql = vgSql & "mto_pension,prc_pension,fec_fallben "
''    vgSql = vgSql & "FROM " & iNombreTabla & " WHERE "
''    vgSql = vgSql & "num_poliza = '" & Trim(ipoliza) & "' AND "
''    vgSql = vgSql & "num_endoso = " & iEndoso & " "
''    vgSql = vgSql & " ORDER BY num_orden ASC"
''    Set vgRegistro = vgConexionBD.Execute(vgSql)
''    If Not vgRegistro.EOF Then
''       punt = 0
''       While Not vgRegistro.EOF
''             punt = punt + 1
''             With istBeneficiarios(punt)
''                  .Num_Poliza = (vgRegistro!Num_Poliza)
''                  .num_endoso = (vgRegistro!num_endoso)
''                  .Num_Orden = (vgRegistro!Num_Orden)
''                  .Cod_TipoIdenben = (vgRegistro!Cod_TipoIdenben)
''                  .Num_Idenben = (vgRegistro!Num_Idenben)
''                  .Gls_NomBen = (vgRegistro!Gls_NomBen)
''                  .Gls_PatBen = (vgRegistro!Gls_PatBen)
''                  .Gls_MatBen = (vgRegistro!Gls_MatBen)
''                  .Cod_GruFam = (vgRegistro!Cod_GruFam)
''                  .Cod_Par = (vgRegistro!Cod_Par)
''                  .Cod_Sexo = (vgRegistro!Cod_Sexo)
''                  .Cod_SitInv = (vgRegistro!Cod_SitInv)
''                  .Cod_DerCre = (vgRegistro!Cod_DerCre)
''                  .Cod_EstPension = (vgRegistro!Cod_EstPension)
''                  .Cod_CauInv = (vgRegistro!Cod_CauInv)
''                  .Fec_NacBen = (vgRegistro!Fec_NacBen)
''                  .Fec_NacHM = (vgRegistro!Fec_NacHM)
''                  .Fec_InvBen = (vgRegistro!Fec_InvBen)
''                  .Mto_Pension = (vgRegistro!Mto_Pension)
''                  .Prc_Pension = (vgRegistro!Prc_Pension)
''                  .Fec_FallBen = (vgRegistro!Fec_FallBen)
''             End With
''       Wend
''    End If
''
''Exit Function
''Err_flCargaEstructuraBeneficiarios:
''    Screen.MousePointer = 0
''    Select Case Err
''        Case Else
''        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
''    End Select
''
''End Function
''
Function flInicializaGrillaBenef(iGrilla As MSFlexGrid)

On Error GoTo Err_flInicializaGrillaBenef
    
    iGrilla.Clear
    'mvg 20170904
    iGrilla.Cols = 54
    iGrilla.rows = 1
    iGrilla.RowHeight(0) = 250
    iGrilla.row = 0

    iGrilla.Col = 0
    iGrilla.Text = "Nº Orden"
    iGrilla.ColWidth(0) = 700

    iGrilla.Col = 1
    iGrilla.Text = "Tipo Ident."
    iGrilla.ColWidth(1) = 1000

    iGrilla.Col = 2
    iGrilla.Text = "N° Ident."
    iGrilla.ColWidth(2) = 1200

    iGrilla.Col = 3
    iGrilla.Text = "Nombre"
    iGrilla.ColWidth(3) = 1500

    iGrilla.Col = 4
    iGrilla.Text = " 2do. Nombre"
    iGrilla.ColWidth(4) = 1500

    iGrilla.Col = 5
    iGrilla.Text = "Ap. Paterno"
    iGrilla.ColWidth(5) = 1000

    iGrilla.Col = 6
    iGrilla.Text = "Ap. Materno"
    iGrilla.ColWidth(6) = 1000

    iGrilla.Col = 7
    iGrilla.Text = "Par."
    iGrilla.ColWidth(7) = 500

    iGrilla.Col = 8
    iGrilla.Text = "Gru.Fam."
    iGrilla.ColWidth(8) = 700

    iGrilla.Col = 9
    iGrilla.Text = "Sexo"
    iGrilla.ColWidth(9) = 500

    iGrilla.Col = 10
    iGrilla.Text = "Sit. Inv."
    iGrilla.ColWidth(10) = 600

    iGrilla.Col = 11
    iGrilla.Text = "Dº Pen."
    iGrilla.ColWidth(11) = 600

    iGrilla.Col = 12
    iGrilla.Text = "Dº Crecer"
    iGrilla.ColWidth(12) = 800

    iGrilla.Col = 13
    iGrilla.Text = "num_poliza"
    iGrilla.ColWidth(13) = 0

    iGrilla.Col = 14
    iGrilla.Text = "num_endoso"
    iGrilla.ColWidth(14) = 0

    iGrilla.Col = 15
    iGrilla.Text = "cod_cauinv"
    iGrilla.ColWidth(15) = 0

    iGrilla.Col = 16
    iGrilla.Text = "Fec.Nac."
    iGrilla.ColWidth(16) = 900

    iGrilla.Col = 17
    iGrilla.Text = "Fec.Nac.HM"
    iGrilla.ColWidth(17) = 900

    iGrilla.Col = 18
    iGrilla.Text = "fec_invben"
    iGrilla.ColWidth(18) = 0

    iGrilla.Col = 19
    iGrilla.Text = "Mto.Pensión"
    iGrilla.ColWidth(19) = 900

    iGrilla.Col = 20
    iGrilla.Text = "Prc. Pensión"
    iGrilla.ColWidth(20) = 900

    iGrilla.Col = 21
    iGrilla.Text = "Fec.Fallec."
    iGrilla.ColWidth(21) = 900

    iGrilla.Col = 22
    iGrilla.Text = "cod_derpen" 'cod_estpension
    iGrilla.ColWidth(22) = 600

    iGrilla.Col = 23
    iGrilla.Text = "cod_motreqpen"
    iGrilla.ColWidth(23) = 0

    iGrilla.Col = 24
    iGrilla.Text = "Mto.Pen.Gar."
    iGrilla.ColWidth(24) = 900

    iGrilla.Col = 25
    iGrilla.Text = "cod_caususben"
    iGrilla.ColWidth(25) = 0

    iGrilla.Col = 26
    iGrilla.Text = "fec_susben"
    iGrilla.ColWidth(26) = 0

    iGrilla.Col = 27
    iGrilla.Text = "fec_inipagopen"
    iGrilla.ColWidth(27) = 0

    iGrilla.Col = 28
    iGrilla.Text = "fec_terpagopengar"
    iGrilla.ColWidth(28) = 0

    iGrilla.Col = 29
    iGrilla.Text = "fec_matrimonio"
    iGrilla.ColWidth(29) = 0

    iGrilla.Col = 30
    iGrilla.Text = "prc_pensiongar"
    iGrilla.ColWidth(30) = 900

    iGrilla.Col = 31
    iGrilla.Text = "prc_pensionleg"
    iGrilla.ColWidth(31) = 900
    
    iGrilla.Col = 32
    iGrilla.Text = "cod_direccion"
    iGrilla.ColWidth(32) = 500
    
    iGrilla.Col = 33
    iGrilla.Text = "gls_direccion"
    iGrilla.ColWidth(33) = 3000
    
    iGrilla.Col = 34
    iGrilla.Text = "gls_fonoben"
    iGrilla.ColWidth(34) = 1000
    
    iGrilla.Col = 35
    iGrilla.Text = "gls_correoben"
    iGrilla.ColWidth(35) = 2500
    
    iGrilla.Col = 36
    iGrilla.Text = "gls_telben2"
    iGrilla.ColWidth(36) = 1000

    iGrilla.Col = 37
    iGrilla.Text = "cod_banco"
    iGrilla.ColWidth(37) = 1000
    
    iGrilla.Col = 38
    iGrilla.Text = "cod_tipcta"
    iGrilla.ColWidth(38) = 1000
    
    iGrilla.Col = 39
    iGrilla.Text = "cod_monbco"
    iGrilla.ColWidth(39) = 1000
    
    iGrilla.Col = 40
    iGrilla.Text = "num_ctabco"
    iGrilla.ColWidth(40) = 1000

    'mvg 20170904
    iGrilla.Col = 41
    iGrilla.Text = "Bol_Elec"
    iGrilla.ColWidth(41) = 500


   'Inicio GCP-Fractal 25032019
    iGrilla.Col = 42
    iGrilla.Text = "num_cuenta_cci"
    iGrilla.ColWidth(42) = 1000
    
    
    iGrilla.Col = 43
    iGrilla.Text = "cod_via_pago"
    iGrilla.ColWidth(43) = 1000
    
    
    iGrilla.Col = 44
    iGrilla.Text = "cod_sucursal"
    iGrilla.ColWidth(44) = 1000
  
   'Fin GCP-Fractal 25032019
    
    
    iGrilla.Col = 45
    iGrilla.Text = "CONS_TRAINFO"
    iGrilla.ColWidth(45) = 1000
    
    
    iGrilla.Col = 46
    iGrilla.Text = "CONS_DATCOMER"
    iGrilla.ColWidth(46) = 1000
    
  
    iGrilla.Col = 47
    iGrilla.Text = "Activacion"
    iGrilla.ColWidth(47) = 1000
    
    iGrilla.Col = 48
    iGrilla.Text = "Modificado"
    iGrilla.ColWidth(48) = 1000
    
    
    iGrilla.Col = 49
    iGrilla.Text = "COD_MODTIPOCUENTA_MANC"
    iGrilla.ColWidth(49) = 1000
    
    iGrilla.Col = 50
    iGrilla.Text = "COD_TIPODOC_MANC"
    iGrilla.ColWidth(50) = 1000
    
    iGrilla.Col = 51
    iGrilla.Text = "NUM_DOC_MANC"
    iGrilla.ColWidth(51) = 1000
    
    iGrilla.Col = 52
    iGrilla.Text = "NOMBRE_MANC"
    iGrilla.ColWidth(52) = 1000
    
    iGrilla.Col = 53
    iGrilla.Text = "APELLIDO_MANC"
    iGrilla.ColWidth(53) = 1000
   
   'Fin GCP-Fractal 25032019
   
Exit Function
Err_flInicializaGrillaBenef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

''Function flCargaGrillaBeneficiarios(iGrilla As MSFlexGrid, istBeneficiarios)
''On Error GoTo Err_flCargaGrillaBeneficiarios
''
''    punt = 0
''    Call flInicializaGrillaBenef(iGrilla)
''    While punt <= vlNumBen
''          punt = punt + 1
''          With istBeneficiarios(punt)
''               'vlCodPar = " " & Trim(vgRegistro!Cod_Par) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_Par, Trim(vgRegistro!Cod_Par)))
''               iGrilla.AddItem (.Num_Orden) & vbTab _
''               & (vlCodPar) & vbTab _
''               & (" " & Format((Trim(.Cod_TipoIdenben)), "##,###,##0") & " - " & (Trim(.Num_Idenben))) & vbTab _
''               & (Trim(.Gls_NomBen)) & (Trim(.Gls_PatBen)) & (Trim(.Gls_MatBen)) & vbTab _
''               & (Trim(.Cod_Par)) & vbTab _
''               & (Trim(.Cod_GruFam)) & vbTab _
''               & (Trim(.Cod_Sexo)) & vbTab _
''               & (Trim(.Cod_SitInv)) & vbTab _
''               & (Trim(.Cod_DerPen)) & vbTab _
''               & (Trim(.Cod_DerCre)) & vbTab _
''               & (Trim(.Num_Poliza)) & vbTab _
''               & (Trim(.num_endoso)) & vbTab _
''               & (Trim(.Cod_CauInv)) & vbTab _
''               & (Trim(.Fec_NacBen)) & vbTab _
''               & (Trim(.Fec_NacHM)) & vbTab _
''               & (Trim(.Fec_InvBen)) & vbTab _
''               & (Trim(.Mto_Pension)) & vbTab _
''               & (Trim(.Prc_Pension)) & vbTab _
''               & (Trim(.Fec_FallBen))
''
''          End With
''    Wend
''
''Exit Function
''Err_flCargaGrillaBeneficiarios:
''    Screen.MousePointer = 0
''    Select Case Err
''        Case Else
''        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
''    End Select
''
''End Function

Function flCargaDatosPolizaOri()
On Error GoTo Err_flCargaDatosPolizaOri

Cmb_ViaPago.Clear
fgComboGeneral vgCodTabla_ViaPago, Cmb_ViaPago

    With stPolizaOri
        'Buscar Glosas
        vlTipoPen = " " & Trim(.Cod_TipPension) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_TipPen, Trim(.Cod_TipPension)))
        vlEstVigencia = " " & Trim(.Cod_Estado) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_TipVigPol, Trim(.Cod_Estado)))
        vlTipoRta = " " & Trim(.Cod_TipRen) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_TipRen, Trim(.Cod_TipRen)))
        vlModalidad = " " & Trim(.Cod_Modalidad) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_AltPen, Trim(.Cod_Modalidad)))
        'Mostrar Datos
        Lbl_POTipPen = Trim(vlTipoPen)
        Lbl_PONumCar = .Num_Cargas
        Lbl_POIniVig = DateSerial(Mid((.Fec_Vigencia), 1, 4), Mid((.Fec_Vigencia), 5, 2), Mid((.Fec_Vigencia), 7, 2))
        Lbl_POTerVig = DateSerial(Mid((.Fec_TerVigencia), 1, 4), Mid((.Fec_TerVigencia), 5, 2), Mid((.Fec_TerVigencia), 7, 2))
        Lbl_POEstVig = Trim(vlEstVigencia)
        Lbl_POTipRta = Trim(vlTipoRta)
        Lbl_POMesDif = .Num_MesDif
        Lbl_POMod = Trim(vlModalidad)
        Lbl_POMesGar = .Num_MesGar
        Lbl_POMtoPri = Format(.Mto_Prima, "###,###,##0.00")
        Lbl_POMtoPen = Format(.Mto_Pension, "###,###,##0.00")
        Lbl_POTasaCto = Format(.Prc_TasaCe, "##0.000")
        Lbl_POTasaVta = Format(.Prc_TasaVta, "##0.000")
        Lbl_POTasaPerGar = Format(.Prc_TasaIntPerGar, "##0.00")
        'Lbl_POFecEmision = DateSerial(Mid((.Fec_Emision), 1, 4), Mid((.Fec_Emision), 5, 2), Mid((.Fec_Emision), 7, 2))
        Lbl_POFecDevengue = DateSerial(Mid((.Fec_Devengue), 1, 4), Mid((.Fec_Devengue), 5, 2), Mid((.Fec_Devengue), 7, 2))
        Lbl_POCuspp = .Cod_Cuspp
        Lbl_POIndCobertura = .Ind_Cob
        Lbl_POCoberCon = .Cod_CoberCon
        Lbl_PODerCrecer = .Cod_DerCre
        Lbl_PODerGratificacion = .Cod_DerGra
        Lbl_MonPension(clMonedaEndOri_Poliza) = .Cod_Moneda
        Lbl_MonPension(clMonedaEndOri_BenPension) = .Cod_Moneda
        vlCodMoneda = .Cod_Moneda
        lblFecTerPerGar = .Fec_TerPerGar
    End With

Exit Function
Err_flCargaDatosPolizaOri:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flCargaDatosPolizaMod()
On Error GoTo Err_flCargaDatosPolizaMod

    'I--- ABV 25/04/2005 ---
    'With stPolizaOri
    With stPolizaMod
    'F--- ABV 25/04/2005 ---
        Cmb_PMTipPen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(.Cod_TipPension), Cmb_PMTipPen)
        Cmb_PMEstVig.ListIndex = fgBuscarPosicionCodigoCombo(Trim(.Cod_Estado), Cmb_PMEstVig)
        Cmb_PMTipRta.ListIndex = fgBuscarPosicionCodigoCombo(Trim(.Cod_TipRen), Cmb_PMTipRta)
        Cmb_PMMod.ListIndex = fgBuscarPosicionCodigoCombo(Trim(.Cod_Modalidad), Cmb_PMMod)
        Lbl_PMNumCar = (Msf_BMGrilla.rows - 1) '.Num_Cargas
        Txt_PMIniVig = DateSerial(Mid((.Fec_Vigencia), 1, 4), Mid((.Fec_Vigencia), 5, 2), Mid((.Fec_Vigencia), 7, 2))
        Txt_PMTerVig = DateSerial(Mid((.Fec_TerVigencia), 1, 4), Mid((.Fec_TerVigencia), 5, 2), Mid((.Fec_TerVigencia), 7, 2))
        Txt_PMMesDif = .Num_MesDif
        Txt_PMMesGar = .Num_MesGar
        Txt_PMMtoPrima = Format(.Mto_Prima, "###,###,##0.00")
        Txt_PMTasaCto = Format(.Prc_TasaCe, "##0.000")
        Txt_PMTasaVta = Format(.Prc_TasaVta, "##0.000")
        Txt_PMTasaPerGar = Format(.Prc_TasaIntPerGar, "##0.00")
        'Lbl_PMFecEmision = DateSerial(Mid((.Fec_Emision), 1, 4), Mid((.Fec_Emision), 5, 2), Mid((.Fec_Emision), 7, 2))
        Lbl_PMFecDevengue = DateSerial(Mid((.Fec_Devengue), 1, 4), Mid((.Fec_Devengue), 5, 2), Mid((.Fec_Devengue), 7, 2))
        Lbl_PMIndCobertura = .Ind_Cob
        Lbl_PMCoberCon = .Cod_CoberCon
        Lbl_PMDerCrecer = .Cod_DerCre
        Lbl_PMDerGratificacion = .Cod_DerGra
        Lbl_PMMtoFacPenElla = .Mto_FacPenElla
        Lbl_PMPrcFacPenElla = .Prc_FacPenElla
        Lbl_MonPension(clMonedaEndMod_Poliza) = .Cod_Moneda
        Lbl_MonPension(clMonedaEndMod_PolizaCal) = .Cod_Moneda
        Lbl_MonPension(clMonedaEndMod_BenPension) = .Cod_Moneda
        Lbl_MonPension(clMonedaEndMod_BenPensionGar) = .Cod_Moneda
        lblTC = Format(.Mto_ValMoneda, "##0.00")
        'Habilitar o Deshabilitar Tipo de Renta
        If Len(Cmb_PMTipRta) <> 0 Then
            If (Trim(Mid(Cmb_PMTipRta, 1, (InStr(1, Cmb_PMTipRta, "-") - 1))) = "1") Then
                'Txt_PMMesDif = 0
                Txt_PMMesDif.Enabled = False
            Else
                'Txt_PMMesDif = ""
                Txt_PMMesDif.Enabled = True
            End If
        End If
        
        'Habilitar o Deshabilitar Tipo de Modalidad
        If Len(Trim(Cmb_PMMod)) = 0 Then
            If (Trim(Mid(Cmb_PMMod, 1, (InStr(1, Cmb_PMMod, "-") - 1))) = "1") Then
                'Txt_PMMesGar = 0
                Txt_PMMesGar.Enabled = False
            Else
                'Txt_PMMesGar = ""
                Txt_PMMesGar.Enabled = True
            End If
        End If
        
        Cmb_PMTipPen.Enabled = False
        
    End With
        
Exit Function
Err_flCargaDatosPolizaMod:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flCargaDatosBeneficiariosOri(iPosicion As Integer)
On Error GoTo Err_flCargaDatosBeneficiariosOri

    With stBeneficiariosOri(iPosicion)
        'Buscar Glosas
        vlPar = " " & Trim(.Cod_Par) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_Par, Trim(.Cod_Par)))
        vlCauInv = " " & Trim(.Cod_CauInv) & " - " & Trim(flBuscarGlosaCauInv(Trim(.Cod_CauInv)))
        'Mostrar Datos
        Lbl_BONumOrd = .Num_Orden
        
        vlNomTipoIdenBen = fgBuscarNombreTipoIden(.Cod_TipoIdenBen, False)
        Lbl_BOCodTipoIden = .Cod_TipoIdenBen & " - " & vlNomTipoIdenBen
        Lbl_BONumIden = .Num_IdenBen
        vlNombreCompleto = fgFormarNombreCompleto(.Gls_NomBen, .Gls_NomSegBen, .Gls_PatBen, .Gls_MatBen)
        Lbl_BONomBen = vlNombreCompleto
        Lbl_BOPar = vlPar
        Lbl_BOGrupFam = Trim(.Cod_GruFam)
        Lbl_BODerPen = Trim(.Cod_EstPension)
        Lbl_BOSexo = Trim(.Cod_Sexo)
        Lbl_BODerAcrecer = Trim(.Cod_DerCre)
        Lbl_BOSitInv = Trim(.Cod_SitInv)
        If (.Fec_InvBen) = "" Then
           Lbl_BOFecInv = ""
        Else
            Lbl_BOFecInv = DateSerial(Mid((.Fec_InvBen), 1, 4), Mid((.Fec_InvBen), 5, 2), Mid((.Fec_InvBen), 7, 2))
        End If
        Lbl_BOCauInv = vlCauInv
        Lbl_BOFecNac = DateSerial(Mid((.Fec_NacBen), 1, 4), Mid((.Fec_NacBen), 5, 2), Mid((.Fec_NacBen), 7, 2))
        If (.Fec_FallBen) = "" Then
           Lbl_BOFecFall = ""
        Else
            Lbl_BOFecFall = DateSerial(Mid((.Fec_FallBen), 1, 4), Mid((.Fec_FallBen), 5, 2), Mid((.Fec_FallBen), 7, 2))
        End If
        If (.Fec_Matrimonio) = "" Then
           Lbl_BOFecMat = ""
        Else
            Lbl_BOFecMat = DateSerial(Mid((.Fec_Matrimonio), 1, 4), Mid((.Fec_Matrimonio), 5, 2), Mid((.Fec_Matrimonio), 7, 2))
        End If
        Lbl_BOPrcLegal = Format(.Prc_PensionLeg, "##0.00")
        lbl_BMPrc = Format(.Prc_Pension, "##0.00")
        txt_BMPrc = Format(.Prc_Pension, "##0.00")
        lbl_BMPrcGar = Format(.Prc_PensionGar, "##0.00")
        txt_BMPrcGar = Format(.Prc_PensionGar, "##0.00")
        If (.Fec_NacHM) = "" Then
           Lbl_BOFecNHM = ""
        Else
            Lbl_BOFecNHM = DateSerial(Mid((.Fec_NacHM), 1, 4), Mid((.Fec_NacHM), 5, 2), Mid((.Fec_NacHM), 7, 2))
        End If
        Lbl_BOMtoPension = Format(.Mto_Pension, "###,###,##0.00")
    
        'mvg 20170904
        chkEnvioBolElec.Value = IIf((.ind_bolelec = "N"), 0, 1)
        chkConTratDatos_Ben = IIf(IsNull(.CONS_TRAINFO), "0", IsNull(.CONS_TRAINFO))
        chkConUsoDatosCom_Ben = IIf(IsNull(.CONS_DATCOMER), "0", IsNull(.CONS_DATCOMER))
    
    End With

Exit Function
Err_flCargaDatosBeneficiariosOri:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flCargaDatosBeneficiariosMod(iPosicion As Integer)
On Error GoTo Err_flCargaDatosBeneficiariosMod
    
    'Posicionar Combos
    Msf_BMGrilla.row = iPosicion
    Msf_BMGrilla.Col = 7
    Cmb_BMPar.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMPar)
    Msf_BMGrilla.Col = 8
    Cmb_BMGrupFam.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMGrupFam)
    Msf_BMGrilla.Col = 9
    Cmb_BMSexo.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMSexo)
    Msf_BMGrilla.Col = 10
    Cmb_BMSitInv.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMSitInv)
    Msf_BMGrilla.Col = 15
'    Cmb_BMCauInv.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMCauInv)
    Lbl_BMCauInv = Trim(Msf_BMGrilla.Text) & " - " & Trim(flBuscarGlosaCauInv(Trim(Msf_BMGrilla.Text)))
    Msf_BMGrilla.Col = 22
    Cmb_BMDerPen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMDerPen)
    
    Msf_BMGrilla.Col = 11
    cmbExcluesion.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), cmbExcluesion)
    
    
    'Mostrar Datos
    Msf_BMGrilla.Col = 0
    Lbl_BMNumOrd = Msf_BMGrilla.Text
    
    Msf_BMGrilla.Col = 1
''    Cmb_BMNumIdent = (Msf_BMGrilla.Text)
    Cmb_BMNumIdent.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Mid(Msf_BMGrilla.Text, 1, (InStr(1, Msf_BMGrilla.Text, "-") - 1))), Cmb_BMNumIdent)
    
    Msf_BMGrilla.Col = 2
    Txt_BMNumIden = Trim(Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 3
    Txt_BMNomBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 4
    Txt_BMNomSegBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 5
    Txt_BMPatBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 6
    Txt_BMMatBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 18
       
    'I--- ABV 16/04/2005 ---
    'Las Fechas se encuentran formateadas de acuerdo a la configuración del PC
    'Por ende solo se deben traspasar las Fechas directamente
    If (Msf_BMGrilla.Text) = "" Then
       Txt_BMFecInv = ""
    Else
        Txt_BMFecInv = Trim(Msf_BMGrilla.Text)
        'Txt_BMFecInv = DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    End If
    Msf_BMGrilla.Col = 16

    Txt_BMFecNac = Trim(Msf_BMGrilla.Text)
    'Txt_BMFecNac = DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    
    Msf_BMGrilla.Col = 21
    If (Msf_BMGrilla.Text) = "" Then
       Txt_BMFecFall = ""
    Else
        Txt_BMFecFall = Trim(Msf_BMGrilla.Text)
        'Txt_BMFecFall = DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    End If
    
    Msf_BMGrilla.Col = 17
    If (Msf_BMGrilla.Text) = "" Then
       Lbl_BMFecNHM = ""
    Else
        Lbl_BMFecNHM = Trim(Msf_BMGrilla.Text)
        'Lbl_BMFecNHM = DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    End If
    Msf_BMGrilla.Col = 12
    Lbl_BMDerAcrecer = Trim(Msf_BMGrilla.Text)
'    Msf_BMGrilla.Col = 20
'    Lbl_BMPrcLegal = Format(Msf_BMGrilla.Text, "##0.00")
    
    Msf_BMGrilla.Col = 20
    lbl_BMPrc = Format(Msf_BMGrilla.Text, "##0.00")
    txt_BMPrc = Format(Msf_BMGrilla.Text, "##0.00")
    
    Msf_BMGrilla.Col = 30
    lbl_BMPrcGar = Format(Msf_BMGrilla.Text, "##0.00")
    txt_BMPrcGar = Format(Msf_BMGrilla.Text, "##0.00")
    
    Msf_BMGrilla.Col = 31
    Lbl_BMPrcLegal = Format(Msf_BMGrilla.Text, "##0.00")
    
    
    Msf_BMGrilla.Col = 19
    Lbl_BMMtoPension = Format(Msf_BMGrilla.Text, "###,###,##0.00")
    
    Msf_BMGrilla.Col = 13
    vlNumPoliza = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 14
    vlNumEndoso = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 22
    vlCodDerpen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 23
    vlCodMotReqPen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 24
    vlMtoPensionGar = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 25
    vlCodCauSusBen = Trim(Msf_BMGrilla.Text)
    
    'vlNumOrden = vlNumOrden
    
    Msf_BMGrilla.Col = 26
    vlFecSusBen = Trim(Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 27
    vlFecIniPagoPen = Trim(Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 28
    vlFecTerPagoPenGar = Trim(Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 29
    If (Msf_BMGrilla.Text) = "" Then
        Txt_BMFecMat = ""
    Else
        Txt_BMFecMat = Trim(Msf_BMGrilla.Text)
        'Txt_BMFecMat = DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    End If
    
    'I--- ABV 20/04/2005 ---
    'Call flHabilitarPenGar
    If flObtenerDerechoPeriodoGarantizado(fgObtenerCodigo_TextoCompuesto(Cmb_PMTipPen), fgObtenerCodigo_TextoCompuesto(Cmb_BMPar)) = True Then
        Txt_BMMtoPensionGar.Enabled = True
    Else
        Txt_BMMtoPensionGar.Enabled = False
    End If
    'F--- ABV 20/04/2005 ---
    
    Msf_BMGrilla.Col = 24
    vlMtoPensionGar = IIf(Trim(Msf_BMGrilla.Text) = "", 0, Trim(Msf_BMGrilla.Text))
    Txt_BMMtoPensionGar = Format(vlMtoPensionGar, "#,#0.00")
    'F--- ABV 19/04/2005 ---
    
    Msf_BMGrilla.Col = 30
    vlPrcPensionGar = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 31
    vlPrcPensionLeg = Trim(Msf_BMGrilla.Text)
    
    
    
    
Exit Function
Err_flCargaDatosBeneficiariosMod:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flBuscarGlosaCauInv(iElemento) As String

On Error GoTo Err_flBuscarGlosaCauInv

    flBuscarGlosaCauInv = ""
    
    vgSql = ""
    vgSql = "SELECT gls_patologia "
    vgSql = vgSql & "FROM MA_TPAR_PATOLOGIA WHERE "
    vgSql = vgSql & "cod_patologia = '" & iElemento & "' "
    Set vgRegistro = vgConexionBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        flBuscarGlosaCauInv = (vgRegistro!gls_patologia)
    End If
    vgRegistro.Close
    
Exit Function
Err_flBuscarGlosaCauInv:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flLimpiarPolizaOri()
On Error GoTo Err_flLimpiarPolizaOri

    Lbl_POTipPen = ""
    Lbl_PONumCar = ""
    Lbl_POIniVig = ""
    Lbl_POTerVig = ""
    Lbl_POEstVig = ""
    Lbl_POTipRta = ""
    Lbl_POMesDif = ""
    Lbl_POMod = ""
    Lbl_POMesGar = ""
    Lbl_POMtoPri = ""
    Lbl_POMtoPen = ""
    Lbl_POTasaCto = ""
    Lbl_POTasaVta = ""
    Lbl_POTasaPerGar = ""
    Lbl_POFecEmision = ""
    Lbl_POFecDevengue = ""
    Lbl_CUSPP = ""
    Lbl_POIndCobertura = ""
    Lbl_POCoberCon = ""
    Lbl_PODerCrecer = ""
    Lbl_PODerGratificacion = ""

    Lbl_MonPension(clMonedaEndOri_Poliza) = ""
    Lbl_MonPension(clMonedaEndOri_BenPension) = ""
    Lbl_MonPension(clMonedaEndMod_Poliza) = ""
    Lbl_MonPension(clMonedaEndMod_PolizaCal) = ""
    Lbl_MonPension(clMonedaEndMod_BenPension) = ""
    Lbl_MonPension(clMonedaEndMod_BenPensionGar) = ""


Exit Function
Err_flLimpiarPolizaOri:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flLimpiarPolizaMod()
On Error GoTo Err_flLimpiarPolizaMod
    
    Call flHabilitarPolMod
    Call flHabilitarBenMod
    
    Cmb_PMTipPen.ListIndex = 0
    Lbl_PMNumCar = ""
    Cmb_PMEstVig.ListIndex = 0
    Txt_PMIniVig = ""
    Txt_PMTerVig = ""
    Cmb_PMTipRta.ListIndex = 0
    Cmb_PMMod.ListIndex = 0
    Txt_PMMesDif = ""
    Txt_PMMesGar = ""
    Txt_PMMtoPrima = ""
    Txt_PMTasaCto = ""
    Txt_PMTasaVta = ""
    Txt_PMTasaPerGar = ""
    Lbl_PMIndCobertura = ""
    Lbl_PMFecDevengue = ""
    Lbl_PMFecEmision = ""
    Lbl_PMCoberCon = ""
    Lbl_PMMtoFacPenElla = ""
    Lbl_PMPrcFacPenElla = ""
    Lbl_PMDerCrecer = ""
    Lbl_PMDerGratificacion = ""

Exit Function
Err_flLimpiarPolizaMod:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flLimpiarBeneficiariosOri()
On Error GoTo Err_flLimpiarBeneficiariosOri

    Lbl_BONumOrd = ""
    Lbl_BONomBen = ""
    Lbl_BOPar = ""
    Lbl_BOGrupFam = ""
    Lbl_BOSexo = ""
    Lbl_BOSitInv = ""
    Lbl_BOCauInv = ""
    Lbl_BOFecNac = ""
    Lbl_BOFecFall = ""
    Lbl_BOFecMat = ""
    Lbl_BOFecNHM = ""
    Lbl_BOCodTipoIden = ""
    Lbl_BONumIden = ""
    Lbl_BODerPen = ""
    Lbl_BODerAcrecer = ""
    Lbl_BOFecInv = ""
    Lbl_BOPrcLegal = ""
    Lbl_BOMtoPension = ""

Exit Function
Err_flLimpiarBeneficiariosOri:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flLimpiarBeneficiariosMod()
On Error GoTo Err_flLimpiarBeneficiariosMod

    Call flHabilitarPolMod
    Call flHabilitarBenMod

    Lbl_BMNumOrd = ""
    Cmb_BMNumIdent.ListIndex = 0
    Txt_BMNumIden = ""
    Txt_BMNomBen = ""
    Txt_BMNomSegBen = ""
    Txt_BMPatBen = ""
    Txt_BMMatBen = ""
    Cmb_BMPar.ListIndex = 0
    Cmb_BMGrupFam.ListIndex = 0
    Cmb_BMSexo.ListIndex = 0
    Cmb_BMSitInv.ListIndex = 0
    Txt_BMFecInv = ""
'    Cmb_BMCauInv.ListIndex = 0
    Lbl_BMCauInv = ""
    'CMV-20051103 I
    'Permite asignar ina causal de invalidez por defecto a un nuevo beneficiario
    Lbl_BMCauInv = flBuscarCauInv
    'CMV-20051103 F
    Cmb_BMDerPen.ListIndex = 0
    vlNumero = InStr(Cmb_EndCauEnd.Text, "-")
    vlCodCauEndoso = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))
    If vlCodCauEndoso = "07" Then
        If vlNumCargas = 1 Then
            Cmb_BMDerPen.ListIndex = 0
            cmbExcluesion.ListIndex = 1
        End If
    End If
    Txt_BMFecNac = ""
    Txt_BMFecMat = ""
    Txt_BMFecFall = ""
    Lbl_BMFecNHM = ""
    Lbl_BMDerAcrecer = ""
    Lbl_BMPrcLegal = ""
    Lbl_BMMtoPension = ""
    
    'I--- ABV 20/04/2005 ---
    Txt_BMMtoPensionGar = ""
    Txt_BMMtoPensionGar.Enabled = False
    'F--- ABV 20/04/2005 ---
    
Exit Function
Err_flLimpiarBeneficiariosMod:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

'CMV-20051103 I
Function flBuscarCauInv() As String
'Permite asignar la causal de Invalidez por defecto a un nuevo beneficirio.
On Error GoTo Err_flBuscarCauInv

    flBuscarCauInv = ""

    vgSql = ""
    vgSql = "SELECT p.cod_patologia,p.gls_patologia "
    vgSql = vgSql & " FROM ma_tpar_patologia p "
    vgSql = vgSql & " WHERE p.cod_patologia = '" & Trim(clCodCauInvNoInv) & "' "
    Set vgRs = vgConexionBD.Execute(vgSql)
    If Not vgRs.EOF Then
        flBuscarCauInv = Trim(vgRs!cod_patologia) & " - " & Trim(vgRs!gls_patologia)
    End If

Exit Function
Err_flBuscarCauInv:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function
'CMV-20051103 F

Function flLimpiarFraPenPoliza()
On Error GoTo Err_flLimpiarFraPenPoliza

    Txt_PenPoliza = ""
    Cmb_PenNumIdent.ListIndex = 0
    Txt_PenNumIdent = ""
    Lbl_End = ""
    Lbl_PenNombre = ""
    
    vlTipoBuscar = "N"
    vlTablaPoliza = clTablaPolizaOri
    vlTablaBen = clTablaBenOri

Exit Function
Err_flLimpiarFraPenPoliza:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flLimpiarFraEndoso()
On Error GoTo Err_flLimpiarFraEndoso

    Lbl_EndMtoPensionOrig = ""
    Lbl_EndMtoPensionCalc = ""
    Lbl_EndCrear = ""
    Txt_EndFecEnd = ""
    Txt_EndFecEfecto = ""
    Txt_EndObs = ""
        
    Cmb_EndTipoEnd.ListIndex = 0
    Cmb_EndCauEnd.ListIndex = 0
    
Exit Function
Err_flLimpiarFraEndoso:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

'Function flComboCauInv()
'Dim vlRsCombo As ADODB.Recordset
'On Error GoTo Err_flComboCauInv
'
'    Cmb_BMCauInv.Clear
'    vgSql = "SELECT cod_patologia AS codigo, gls_patologia AS glosa "
'    vgSql = vgSql & "FROM MA_TPAR_PATOLOGIA "
'    vgSql = vgSql & "ORDER BY cod_patologia "
'    Set vlRsCombo = vgConexionBD.Execute(vgSql)
'    Do While Not vlRsCombo.EOF
'        If (Trim(vlRsCombo!Codigo) = "0") Then
'            Cmb_BMCauInv.AddItem ((Trim(vlRsCombo!Codigo) & " - " & Trim(vlRsCombo!glosa))), 0
'        Else
'            Cmb_BMCauInv.AddItem ((Trim(vlRsCombo!Codigo) & " - " & Trim(vlRsCombo!glosa)))
'        End If
'        vlRsCombo.MoveNext
'    Loop
'    vlRsCombo.Close
'
'    If Cmb_BMCauInv.ListCount <> 0 Then
'        Cmb_BMCauInv.ListIndex = 0
'    End If
'
'Exit Function
'Err_flComboCauInv:
'    Screen.MousePointer = 0
'    Select Case Err
'        Case Else
'        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
'    End Select
'End Function

Function flRecibe(vlNumPoliza, vlRut, vlDigito, vlNumEndoso)
    Txt_PenPoliza = vlNumPoliza
    Txt_PenRut = vlRut
    Txt_PenDigito = vlDigito
'    Lbl_End = vlNumEndoso
    Cmd_BuscarPol_Click
End Function

Function flIngresarBenef()
    vlCodDerpen = "99"
    
    Msf_BMGrilla.AddItem (vlNumOrden) & vbTab _
    & " " & (vlCodTipoIdenBen) & vbTab & (vlNumIdenBen) & vbTab _
    & (vlNomBen) & vbTab & (vlNomSegBen) & vbTab & (vlPaternoBen) & vbTab & (vlMaternoBen) & vbTab _
    & (vlCodPar) & vbTab & (vlCodGruFam) & vbTab _
    & (vlCodSexo) & vbTab & (vlCodSitInv) & vbTab _
    & (vlCodDerpen) & vbTab & (vlCodDerCre) & vbTab _
    & (vlNumPoliza) & vbTab & (vlNumEndoso) & vbTab _
    & (vlCodCauInv) & vbTab & (vlFecNacBen) & vbTab _
    & (vlFecNacHM) & vbTab & (vlFecInvBen) & vbTab _
    & (vlMtoPension) & vbTab & (vlPrcPension) & vbTab _
    & (vlFecFallBen) & vbTab & (vlCodEstPension) & vbTab _
    & (vlCodMotReqPen) & vbTab & (vlMtoPensionGar) & vbTab _
    & (vlCodCauSusBen) & vbTab & (vlFecSusBen) & vbTab _
    & (vlFecIniPagoPen) & vbTab & (vlFecTerPagoPenGar) & vbTab _
    & (vlFecMatrimonio) & vbTab & (vlPrcPensionGar) & vbTab _
    & (vlPrcPensionLeg) & vbTab & (vlCodDireccion) & vbTab _
    & (vlGlsDirBen) & vbTab & (vlGlsFonoBen) & vbTab _
    & (vlGlsCorreoBen) & vbTab & (vlGlsTelben2) & vbTab _
    & (vlCodBanco) & vbTab & (vlCodTipcta) & vbTab _
    & (vlcodmonbco) & vbTab & (vlnumctabco) & vbTab _
    & (vlBolelec) & vbTab & (vlnumctacci) & vbTab _
    & (vlViaPago) & vbTab & (vlSucursal) & vbTab _
    & (vl_ConTratDatos_Ben) & vbTab & (vl_ConUsoDatosCom_Ben) & vbTab _
    & (vl_COD_MODTIPOCUENTA_MANC) & vbTab & (vl_COD_TIPODOC_MANC) & vbTab _
    & (vl_NUM_DOC_MANC) & vbTab & (vl_NOMBRE_MANC) & vbTab & (vl_APELLIDO_MANC) & vbTab & " "
    
End Function

Function flModificarBenef()
    
    Msf_BMGrilla.row = vlNumOrden
    Msf_BMGrilla.Col = 1
    Msf_BMGrilla.Text = " " & vlCodTipoIdenBen
    Msf_BMGrilla.Col = 2
    Msf_BMGrilla.Text = vlNumIdenBen
    Msf_BMGrilla.Col = 3
    Msf_BMGrilla.Text = vlNomBen
    Msf_BMGrilla.Col = 4
    Msf_BMGrilla.Text = vlNomSegBen
    Msf_BMGrilla.Col = 5
    Msf_BMGrilla.Text = vlPaternoBen
    Msf_BMGrilla.Col = 6
    Msf_BMGrilla.Text = vlMaternoBen
    Msf_BMGrilla.Col = 7
    Msf_BMGrilla.Text = vlCodPar
    Msf_BMGrilla.Col = 8
    Msf_BMGrilla.Text = vlCodGruFam
    Msf_BMGrilla.Col = 9
    Msf_BMGrilla.Text = vlCodSexo
    Msf_BMGrilla.Col = 10
    Msf_BMGrilla.Text = vlCodSitInv
    Msf_BMGrilla.Col = 11
    Msf_BMGrilla.Text = vlCodDerpen
    Msf_BMGrilla.Col = 12
    Msf_BMGrilla.Text = vlCodDerCre
    'Msf_BMGrilla.Col = 13
    'Msf_BMGrilla.Text = vlNumPoliza
    'Msf_BMGrilla.Col = 14
    'Msf_BMGrilla.Text = vlNumEndoso
    Msf_BMGrilla.Col = 15
    Msf_BMGrilla.Text = vlCodCauInv
    Msf_BMGrilla.Col = 16
    Msf_BMGrilla.Text = vlFecNacBen
    Msf_BMGrilla.Col = 17
    Msf_BMGrilla.Text = vlFecNacHM
    Msf_BMGrilla.Col = 18
    Msf_BMGrilla.Text = vlFecInvBen
    Msf_BMGrilla.Col = 19
    Msf_BMGrilla.Text = vlMtoPension
    Msf_BMGrilla.Col = 20
    Msf_BMGrilla.Text = vlPrcPension
    Msf_BMGrilla.Col = 21
    Msf_BMGrilla.Text = vlFecFallBen
    Msf_BMGrilla.Col = 22
    Msf_BMGrilla.Text = vlCodEstPension
    Msf_BMGrilla.Col = 24
    Msf_BMGrilla.Text = vlMtoPensionGar
    Msf_BMGrilla.Col = 29
    Msf_BMGrilla.Text = vlFecMatrimonio
    Msf_BMGrilla.Col = 30
    Msf_BMGrilla.Text = vlPrcPensionGar
    Msf_BMGrilla.Col = 31
    Msf_BMGrilla.Text = vlPrcPensionLeg
    Msf_BMGrilla.Col = 32
    Msf_BMGrilla.Text = vlCodDireccion
    Msf_BMGrilla.Col = 33
    Msf_BMGrilla.Text = vlGlsDirBen
    Msf_BMGrilla.Col = 34
    Msf_BMGrilla.Text = vlGlsFonoBen
    Msf_BMGrilla.Col = 35
    Msf_BMGrilla.Text = vlGlsCorreoBen
    Msf_BMGrilla.Col = 36
    Msf_BMGrilla.Text = vlGlsTelben2
    'RRR
    Msf_BMGrilla.Col = 37
    Msf_BMGrilla.Text = vlCodBanco
    Msf_BMGrilla.Col = 38
    Msf_BMGrilla.Text = vlCodTipcta
    Msf_BMGrilla.Col = 39
    Msf_BMGrilla.Text = vlcodmonbco
    Msf_BMGrilla.Col = 40
    Msf_BMGrilla.Text = vlnumctabco
    
    
    'mvg 20170904
    Msf_BMGrilla.Col = 41
    Msf_BMGrilla.Text = vlBolelec
    
    'Inicio GCP-FRACTAL 25032019
    Msf_BMGrilla.Col = 42
    Msf_BMGrilla.Text = vlnumctacci
    
    Msf_BMGrilla.Col = 43
    Msf_BMGrilla.Text = vlViaPago

    Msf_BMGrilla.Col = 44
    Msf_BMGrilla.Text = vlSucursal
        
    Msf_BMGrilla.Col = 45
    Msf_BMGrilla.Text = vl_ConTratDatos_Ben
    
    Msf_BMGrilla.Col = 46
    Msf_BMGrilla.Text = vl_ConUsoDatosCom_Ben
    
    
    'Flag de Modificacion
     Msf_BMGrilla.Col = 48
     Msf_BMGrilla.Text = "1"
       

    Msf_BMGrilla.Col = 49
    Msf_BMGrilla.Text = vl_COD_MODTIPOCUENTA_MANC
    
    Msf_BMGrilla.Col = 50
    Msf_BMGrilla.Text = vl_COD_TIPODOC_MANC
    
    Msf_BMGrilla.Col = 51
    Msf_BMGrilla.Text = vl_NUM_DOC_MANC
    
    Msf_BMGrilla.Col = 52
    Msf_BMGrilla.Text = vl_NOMBRE_MANC
    
    Msf_BMGrilla.Col = 53
    Msf_BMGrilla.Text = vl_APELLIDO_MANC
        
    'Fin GCP-FRACTAL 25032019
 
    
End Function

Function flObtenerDatosBenef()
    
    vlCodTipoIdenBen = (Cmb_BMNumIdent)
    vlNumIdenBen = Trim(Txt_BMNumIden)
    vlNomBen = Trim(txtNomben)
    vlNomSegBen = Trim(txtNomsegBen)
    vlPaternoBen = Trim(txtApepatBen)
    vlMaternoBen = Trim(txtApematBen)
    vlCodPar = Trim(Mid(Cmb_BMPar, 1, (InStr(1, Cmb_BMPar, "-") - 1)))
    vlCodGruFam = Trim(Mid(Cmb_BMGrupFam, 1, (InStr(1, Cmb_BMGrupFam, "-") - 1)))
    vlCodSexo = Trim(Mid(Cmb_BMSexo, 1, (InStr(1, Cmb_BMSexo, "-") - 1)))
    vlCodSitInv = Trim(Mid(Cmb_BMSitInv, 1, (InStr(1, Cmb_BMSitInv, "-") - 1)))
    vlCodDerpen = Trim(Mid(cmbExcluesion, 1, (InStr(1, cmbExcluesion, "-") - 1)))
    vlCodEstPension = Trim(Mid(Cmb_BMDerPen, 1, (InStr(1, Cmb_BMDerPen, "-") - 1)))
    vlCodDerCre = "N" 'Trim(Lbl_BMDerAcrecer)
    
    
     If Mid(Cmb_EndTipoEnd, 1, 1) <> "O" Then
        vlMtoPension = IIf(Trim(txt_BMMtoPension) = "", 0, Trim(txt_BMMtoPension))
        vlPrcPension = IIf(Trim(lbl_BMPrc) = "", 0, Trim(lbl_BMPrc))
        
        'INI GCP 15102021 Correccion: El campo Porcentaje legal se esta cambiando a CERO
            'vlPrcPensionLeg = IIf(Trim(txt_BMPrcleg) = "", 0, Trim(txt_BMPrcleg))
             vlPrcPensionLeg = IIf(Trim(Lbl_BMPrcLegal) = "", 0, Trim(Lbl_BMPrcLegal))
        'FIN GCP 15102021 Correccion: El campo Porcentaje legal se esta cambiando a CERO
        
        
        vlPrcPensionGar = IIf(Trim(txt_BMPrcGar) = "", 0, Trim(txt_BMPrcGar))
     Else
        vlMtoPension = IIf(Trim(Lbl_BMMtoPension) = "", 0, Trim(Lbl_BMMtoPension))
        vlPrcPension = IIf(Trim(lbl_BMPrc) = "", 0, Trim(lbl_BMPrc))
        vlPrcPensionLeg = IIf(Trim(Lbl_BMPrcLegal) = "", 0, Trim(Lbl_BMPrcLegal))
        vlPrcPensionGar = IIf(Trim(lbl_BMPrcGar) = "", 0, Trim(lbl_BMPrcGar))
     End If
     
     'Exit Function
'    vlNumPoliza = Trim(Txt_PenPoliza)
'    vlNumEndoso = Trim(Lbl_End)
    'vlCodCauInv = Trim(Mid(Cmb_BMCauInv, 1, (InStr(1, Cmb_BMCauInv, "-") - 1)))
    'CMV-20051102 I
    If Lbl_BMCauInv <> "" Then
        vlCodCauInv = Trim(Mid(Lbl_BMCauInv, 1, (InStr(1, Lbl_BMCauInv, "-") - 1)))
    Else
        vlCodCauInv = ""
    End If
    'CMV-20051102 F
    
    'I--- ABV 16/04/2005 ---
    'Cambiar los formatos de las Fechas de acuerdo a la Configuración del PC
    'vlFecNacBen = Format(CDate(Trim(Txt_BMFecNac)), "yyyymmdd")
    vlFecNacBen = CDate(Trim(Txt_BMFecNac))
    
    If Lbl_BMFecNHM <> "" Then
        'vlFecNacHM = Format(CDate(Trim(Lbl_BMFecNHM)), "yyyymmdd")
        vlFecNacHM = CDate(Trim(Lbl_BMFecNHM))
    Else
        vlFecNacHM = ""
    End If
    
    If Txt_BMFecInv <> "" Then
        'vlFecInvBen = Format(CDate(Trim(Txt_BMFecInv)), "yyyymmdd")
        vlFecInvBen = CDate(Trim(Txt_BMFecInv))
    Else
        vlFecInvBen = ""
    End If
    
    
    
    If Txt_BMFecFall <> "" Then
        'vlFecFallBen = Format(CDate(Trim(Txt_BMFecFall)), "yyyymmdd")
        vlFecFallBen = CDate(Trim(Txt_BMFecFall))
    Else
        vlFecFallBen = ""
    End If
    
    If Txt_BMFecMat <> "" Then
        'vlFecMatrimonio = Format(CDate(Trim(Txt_BMFecMat)), "yyyymmdd")
        vlFecMatrimonio = CDate(Trim(Txt_BMFecMat))
    Else
        vlFecMatrimonio = ""
    End If
    'F--- ABV 16/04/2005 ---
   
   If Txt_EndFecEnd = "" Then
        MsgBox "Debe Ingresar una Fecha de efecto del endoso.", vbCritical, "Error de Datos"
       Txt_EndFecEnd.SetFocus
       Exit Function
   End If
   
    'I--- ABV 19/04/2005 ---
    If (vlFecFallBen <> "") Then
        'vlMtoPensionGar = 0 'vlMtoPension
        '***30/11/2016 mvg pone And Mid(Cmb_BMPar.Text, 1, 2) = "99")
        If (Txt_BMMtoPensionGar <> "" And lblFecTerPerGar > Format(CDate(Trim(Txt_EndFecEnd)), "yyyymmdd")) Then
            vlMtoPensionGar = Trim(Txt_BMMtoPensionGar)
        Else
            vlMtoPensionGar = 0
        End If
        
    Else
        If (Txt_BMMtoPensionGar <> "") Then
            vlMtoPensionGar = Trim(Txt_BMMtoPensionGar)
        Else
            vlMtoPensionGar = 0
        End If
    End If
    'F--- ABV 19/04/2005 ---
    
    'RRR
    
    If Mid(Cmb_EndTipoEnd, 1, 1) <> "O" Then
    
        If vlMtoPension <> 0 Then
            vlMtoPension = Trim(txt_BMMtoPension)
        Else
            vlMtoPension = 0
        End If
        
        If vlPrcPension <> 0 Then
           vlPrcPension = Trim(txt_BMPrc)
        Else
            vlPrcPension = 0
        End If
    
        If vlPrcPensionLeg <> 0 Then
           vlPrcPensionLeg = Trim(Lbl_BMPrcLegal)
        Else
            vlPrcPensionLeg = 0
        End If
    
        If (vlFecFallBen <> "") Then
        '*****30/11/2016 marco pone 'And Mid(Cmb_BMPar.Text, 1, 2) = "99")'
            If (vlPrcPensionGar <> 0 And lblFecTerPerGar > Format(CDate(Trim(Txt_EndFecEnd)), "yyyymmdd")) Then
               vlPrcPensionGar = Trim(txt_BMPrcGar)
               vlMtoPension = 0
               vlPrcPension = 0
               vlPrcPensionLeg = 0
            Else
                vlPrcPensionGar = 0
                vlMtoPension = 0
                vlPrcPension = 0
            End If
        Else
           If vlPrcPensionGar <> 0 Then
               vlPrcPensionGar = Trim(txt_BMPrcGar)
            Else
                vlPrcPensionGar = 0
            End If
        End If
    Else
        If vlMtoPension <> 0 Then
            vlMtoPension = Trim(Lbl_BMMtoPension)
        Else
            vlMtoPension = 0
        End If
        
        If vlPrcPension <> 0 Then
           vlPrcPension = Trim(lbl_BMPrc)
        Else
            vlPrcPension = 0
        End If
    
        'vlPrcPensionLeg = 0
        'vlPrcPensionGar = 0
    End If
    
'RRR 22/04/2013
    vlGlsDirBen = Trim(txt_dirben)
    vlCodDireccion = Trim(IIf(txtcodDirBen = "", 0, txtcodDirBen))
    vlGlsFonoBen = Trim(txtTelBen)
    vlGlsCorreoBen = Trim(txtBenEmail)
    vlGlsTelben2 = Trim(txtTelfon2)
    
    vlCodBanco = Trim(Mid(cmbBancoCtaBen, 1, (InStr(1, cmbBancoCtaBen, "-") - 1)))
    vlCodTipcta = Trim(Mid(cmbTipoCtaBen, 1, (InStr(1, cmbTipoCtaBen, "-") - 1)))
    vlcodmonbco = Trim(Mid(cmbMonctaBen, 1, (InStr(1, cmbMonctaBen, "-") - 1)))
    vlnumctabco = Trim(txtNumctaBen)
    vlSucursal = Trim(Mid(Cmb_Sucursal, 1, (InStr(1, Cmb_Sucursal, "-") - 1)))
    vlViaPago = Trim(Mid(Cmb_ViaPago, 1, (InStr(1, Cmb_ViaPago, "-") - 1)))


    vl_COD_MODTIPOCUENTA_MANC = Trim(Mid(Cmb_ModTipCta, 1, (InStr(1, Cmb_ModTipCta, "-") - 1)))
    vl_COD_TIPODOC_MANC = Trim(Mid(Cmb_TipDoc, 1, (InStr(1, Cmb_TipDoc, "-") - 1)))
    vl_NUM_DOC_MANC = Trim(Txt_NroDocSecundario)
    vl_NOMBRE_MANC = Trim(Txt_NombreSecundario)
    vl_APELLIDO_MANC = Trim(Txt_ApellidosSecundario)
    
    'INICIO GCP-FRACTAL 15042019
    vlnumctacci = Trim(txt_CCI)
    
    vl_ConTratDatos_Ben = IIf(chkConTratDatos_Ben.Value = 1, "1", "0")
    vl_ConUsoDatosCom_Ben = IIf(chkConUsoDatosCom_Ben.Value = 1, "1", "0")
   
    'FIN GCP-FRACTAL 15042019
    
    'mvg 20170904
    vlBolelec = IIf(chkEnvioBolElec.Value = 1, "S", "N")
    
End Function

Function flValidarPolizaMod()
On Error GoTo Err_flValidarPolizaMod

    'Validaciones de Poliza Modificada
    
    'Validar Fecha de Inicio de Vigencia de la Poliza
    If (Trim(Txt_PMIniVig) = "") Then
       MsgBox "Debe Ingresar una Fecha de Inicio de Vigencia", vbCritical, "Error de Datos"
       Txt_PMIniVig.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    If Not IsDate(Txt_PMIniVig.Text) Then
       MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
       Txt_PMIniVig.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    If (CDate(Txt_PMIniVig) > CDate(Date)) Then
       MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
       Txt_PMIniVig.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    If (Year(Txt_PMIniVig) < 1900) Then
       MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
       Txt_PMIniVig.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    
    Txt_PMIniVig.Text = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
    Txt_PMIniVig.Text = DateSerial(Mid((Txt_PMIniVig.Text), 1, 4), Mid((Txt_PMIniVig.Text), 5, 2), Mid((Txt_PMIniVig.Text), 7, 2))
    
    'Valida Vigencia de la poliza según fecha ingresafda en Inicio de Vigencia
    If Not fgValidaVigenciaPoliza(Trim(Txt_PenPoliza.Text), Txt_PMIniVig.Text) Then
       MsgBox " La Fecha Ingresada es Anterior a la Fecha de Vigencia de la Póliza ", vbInformation, "Información"
       Txt_PMIniVig.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
     
'    If Not fgValidaPagoPension(Txt_PMIniVig, Trim(Txt_PenPoliza), vlNumOrden) Then
'       MsgBox " Ya se ha Realizado el Proceso de Cálculo de Pensión a la Fecha de Inicio de Vigencia Ingresada", vbCritical, "Operación Cancelada"
'       Txt_PMIniVig.SetFocus
'       vlSwValidaOK = False
'       Exit Function
'    End If
    'Validar Número de Meses Diferidos
    If Txt_PMMesDif.Text = "" Then
       MsgBox "Debe Ingresar Número de Meses.", vbCritical, "Error de Datos"
       Txt_PMMesDif.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    If CDbl(Txt_PMMesDif.Text) > clMesesMax Then
       MsgBox "El Número de Meses Ingresado Excede el Máximo Permitido de 1200.", vbCritical, "Error de Datos"
       Txt_PMMesDif.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
   'Validar Número de Meses Garantizados
    If Txt_PMMesGar.Text = "" Then
       MsgBox "Debe Ingresar Número de Meses.", vbCritical, "Error de Datos"
       Txt_PMMesGar.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    If CDbl(Txt_PMMesGar.Text) > clMesesMax Then
       MsgBox "El Número de Meses Ingresado Excede el Máximo Permitido de 1200.", vbCritical, "Error de Datos"
       Txt_PMMesGar.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    'Validar Monto Prima
    If Txt_PMMtoPrima.Text = "" Then
       MsgBox "Debe Ingresar Monto de la Prima.", vbCritical, "Error de Datos"
       Txt_PMMtoPrima.SetFocus
       vlSwValidaOK = False
       Exit Function
    Else
        Txt_PMMtoPrima.Text = Format(Txt_PMMtoPrima.Text, "###,###,##0.00")
    End If
    If CDbl(Txt_PMMtoPrima.Text) = 0 Then
       MsgBox "Debe Ingresar un Valor Mayor que Cero para Monto Prima.", vbCritical, "Error de Datos"
       Txt_PMMtoPrima.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    If CDbl(Txt_PMMtoPrima.Text) > clMtoTope Then
       MsgBox "El Valor Ingresado en Monto Prima Excede el Máximo Permitido de " & Format(clMtoTope, "###,###,##0.00") & "  .", vbExclamation, "Información"
       Txt_PMMtoPrima.Text = Format(clMtoTope, "###,###,##0.00")
       Txt_PMMtoPrima.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    'Validar Tasa Cto. Equiv.
    If (Trim(Txt_PMTasaCto.Text)) = "" Then
       MsgBox "Debe Ingresar Porcentaje Tasa Cto. Equiv.", vbCritical, "Error de Datos"
       Txt_PMTasaCto.SetFocus
       vlSwValidaOK = False
       Exit Function
    Else
        Txt_PMTasaCto = Format(Txt_PMTasaCto, "###,##0.000")
    End If
    'Validar Tasa de Venta
    If (Trim(Txt_PMTasaVta.Text)) = "" Then
       MsgBox "Debe Ingresar Porcentaje Tasa de Venta", vbCritical, "Error de Datos"
       Txt_PMTasaVta.SetFocus
       vlSwValidaOK = False
       Exit Function
    Else
        Txt_PMTasaVta = Format(Txt_PMTasaVta, "###,##0.000")
    End If
    'Validar Tasa Periodo Garantizado
    If (Trim(Txt_PMTasaPerGar.Text)) = "" Then
       MsgBox "Debe Ingresar Porcentaje Tasa de Venta", vbCritical, "Error de Datos"
       Txt_PMTasaPerGar.SetFocus
       vlSwValidaOK = False
       Exit Function
    Else
        Txt_PMTasaPerGar = Format(Txt_PMTasaPerGar, "###,##0.00")
    End If

Exit Function
Err_flValidarPolizaMod:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flValidarBeneficiariosMod()
On Error GoTo Err_flValidarBeneficiariosMod

'    If Msf_BMGrilla.Rows > 1 Then
'       vlPos = 1
'       Msf_BMGrilla.Col = 0
'       While vlPos <= (Msf_GrillaCargas.Rows - 1)
'             vlPos = vlPos + 1
'       Wend
'    End If

Exit Function
Err_flValidarBeneficiariosMod:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flFormatearDatosPoliza()
'*On Error GoTo Err_flFormatearDatosPoliza

    vlNumPoliza = Trim(Txt_PenPoliza)
    vlNumEndoso = Trim(Lbl_End)
    
    vlNumero = InStr(Cmb_PMTipPen.Text, "-")
    vlCodTipPension = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
    vlNumCargas = Lbl_PMNumCar
    vlNumero = InStr(Cmb_PMEstVig.Text, "-")
    vlCodEstado = Trim(Mid(Cmb_PMEstVig.Text, 1, vlNumero - 1))
    vlFecVigencia = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
    vlFecTerVigencia = Format(CDate(Trim(Txt_PMTerVig)), "yyyymmdd")
    vlNumero = InStr(Cmb_PMTipRta.Text, "-")
    vlCodTipRen = Trim(Mid(Cmb_PMTipRta.Text, 1, vlNumero - 1))
    vlNumero = InStr(Cmb_PMMod.Text, "-")
    vlCodModalidad = Trim(Mid(Cmb_PMMod.Text, 1, vlNumero - 1))
    vlNumMesDif = Txt_PMMesDif
    vlNumMesGar = Txt_PMMesGar
    vlMtoPrima = Txt_PMMtoPrima
    vlPrcTasaCe = Txt_PMTasaCto
    vlPrcTasaVta = Txt_PMTasaVta
    vlPrcTasaIntPerGar = Txt_PMTasaPerGar
    
    vlMtoPension = Lbl_EndMtoPensionCalc
    
    'RRR 15112018
    Select Case vlCodTipEndoso
        Case "O"
            vlMtoPension = Lbl_EndMtoPensionOrig
            vlMtoPensionGar = lbl_EndMtoPensionOrigGar
            If CInt(Txt_PMMesGar) <> 0 Then
                'If lbl_EndMtoPensionCalcGar <> "" Then
                vlMtoPensionGar = lbl_EndMtoPensionOrigGar
            Else
                vlMtoPensionGar = 0
                'End If
'            Else
'                If Lbl_EndMtoPensionCalc <> "" Then
'                    vlMtoPension = Lbl_EndMtoPensionOrig
'                Else
'                    vlMtoPension = 0
'                End If
            End If
        Case "S"
            vlMtoPension = Lbl_EndMtoPensionOrig
            If CInt(Txt_PMMesGar) <> 0 Then
                'If lbl_EndMtoPensionCalcGar <> "" Then
                vlMtoPensionGar = lbl_EndMtoPensionOrigGar
            Else
                vlMtoPensionGar = 0
                'End If
'            Else
'                If Lbl_EndMtoPensionCalc <> "" Then
'                    vlMtoPension = Lbl_EndMtoPensionOrig
'                Else
'                    vlMtoPension = 0
'                End If
            End If
            Select Case vlCodCauEndoso
                Case "07"
                    'vlNumMesDif = 0
                    vlCodTipRen = "1"
                Case "08"
                Case "09"
                    'vlheren = "1"
                    'vlNumMesDif = 0
                    vlCodTipRen = "1"
                Case "23"
                Case "24"
                Case "26"
            End Select
        Case "A"
             'I--- ABV 25/04/2005 ---
            If Lbl_EndMtoPensionCalc <> "" Then
                vlMtoPension = txt_EndMtoPensionCalc
            Else
                vlMtoPension = 0
            End If
                    'F--- ABV 25/04/2005 ---
                
            'I--- ABV 27/09/2007 ---
            If (vlNumMesGar > 0) Then
                vlMtoPensionGar = txt_EndMtoPensionCalcGar
            Else
                vlMtoPensionGar = 0
            End If
            'F--- ABV 27/09/2007 ---
        
            Select Case vlCodCauEndoso
                Case "01"
                Case "02"
                Case "04"
                Case "05"
                Case "13"
                    vlFecVigencia = Format(CDate(Trim(Txt_EndFecEfecto)), "yyyymmdd")
                    vlCodTipRen = "1"
                    vlNumMesDif = 0
            End Select
    End Select
    
     
'Buscar los Datos desde la Tabla del Endoso Original
    vgSql = ""
    vgSql = "SELECT "
    vgSql = vgSql & "fec_emision,fec_dev,fec_inipencia, "
    vgSql = vgSql & "cod_moneda,mto_valmoneda,mto_pensiongar,"
    vgSql = vgSql & "ind_cob,cod_cobercon,mto_facpenella,prc_facpenella, "
    vgSql = vgSql & "cod_dercre,cod_dergra "
    vgSql = vgSql & ",Fec_IniPagoPen,Fec_finperdif,Fec_finpergar,Fec_PriPago "
    vgSql = vgSql & ",cod_tipreajuste, mto_valreajustetri, mto_valreajustemen " 'hqr 13/01/2011
    vgSql = vgSql & "FROM pp_tmae_poliza WHERE "
    vgSql = vgSql & "num_poliza = '" & vlNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & vlNumEndoso & " "
    vgSql = vgSql & " ORDER BY num_endoso DESC"
    Set vgRegistro = vgConexionBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        vlFecEmision = (vgRegistro!Fec_Emision)
        vlFecDevengue = (vgRegistro!fec_dev)
        vlFecIniPenCia = (vgRegistro!Fec_IniPenCia)
        vlCodMoneda = (vgRegistro!Cod_Moneda)
        vlValMoneda = (vgRegistro!Mto_ValMoneda)
'        vlMtoPensionGar = (vgRegistro!Mto_PensionGar)
        vlIndCobertura = (vgRegistro!Ind_Cob)
        vlCobCoberCon = (vgRegistro!Cod_CoberCon)
        vlMtoFacPenElla = (vgRegistro!Mto_FacPenElla)
        vlPrcFacPenElla = (vgRegistro!Prc_FacPenElla)
        vlCodDerCrecer = (vgRegistro!Cod_DerCre)
        vlCodDerGratificacion = (vgRegistro!Cod_DerGra)
        vlCodTipReajuste = (vgRegistro!Cod_TipReajuste)
        vlMtoValReajusteTri = IIf(IsNull(vgRegistro!Mto_ValReajusteTri), 0, vgRegistro!Mto_ValReajusteTri)
        vlMtoValReajusteMen = IIf(IsNull(vgRegistro!Mto_ValReajusteMen), 0, vgRegistro!Mto_ValReajusteMen)
''I--- ABV 26/09/2007 ---
'        vlFecIniPagoPen = (vgRegistro!Fec_IniPagoPen)
         vlFecPriPago = (vgRegistro!Fec_PriPago)
''F--- ABV 26/09/2007 ---
    End If
    vgRegistro.Close
    
    vlFecIniPenCia = fgCalcularFechaIniPagoPensiones(vlFecDevengue, CLng(vlNumMesDif))
    vlFecTerPagoPenDif = fgCalcularFechaFinPerDiferido(vlFecDevengue, CLng(vlNumMesDif))
    vlFecTerPagoPenGar = fgCalcularFechaFinPerGarantizado(vlFecDevengue, CLng(vlNumMesDif), CLng(vlNumMesGar))

'I--- ABV 01/11/2007 ---
'    vlFecIniPagoPen = vlFecDevengue
'    vlFecPriPago = vlFecDevengue
    If (vlNumMesDif = 0) Then
        vlFecIniPagoPen = Mid(vlFecDevengue, 1, 6) & "01"
        'vlFecPriPago = Mid(vlFecDevengue, 1, 6) & "01"
    Else
        vlFecIniPagoPen = vlFecIniPenCia
        vlFecPriPago = vlFecIniPenCia
    End If
    
    'RRR 13/11/2018
    Dim vliFecha As Date
    
    If vlCodTipEndoso = "A" Then
        If vlCodCauEndoso = "13" Then
            vlFecEmision = Format(CDate(Trim(Txt_EndFecEfecto)), "yyyymmdd")
            vlFecDevengue = Format(CDate(Trim(Txt_EndFecEnd)), "yyyymmdd")
            vlFecIniPenCia = Format(CDate(Trim(Txt_EndFecEfecto)), "yyyymmdd")
            vlFecIniPenCia = fgCalcularFechaIniPagoPensiones(vlFecDevengue, CLng(vlNumMesDif))
            vlFecTerPagoPenDif = fgCalcularFechaFinPerDiferido(vlFecDevengue, CLng(vlNumMesDif))
            vlFecTerPagoPenGar = fgCalcularFechaFinPerGarantizado(vlFecDevengue, CLng(vlNumMesDif), CLng(vlNumMesGar))
            'vlFecPriPago =
            vgSql = "SELECT NUM_PERPAGO,COD_ESTADOREG, FEC_PAGOREG " ',COD_ESTADOPRI
            vgSql = vgSql & "FROM PP_TMAE_PROPAGOPEN "
            vgSql = vgSql & "WHERE "
            vgSql = vgSql & "cod_estadoreg <> 'C' "
            vgSql = vgSql & "ORDER BY num_perpago ASC"
            Set vgRs2 = vgConexionBD.Execute(vgSql)
            If Not vgRs2.EOF Then
                vliFecha = DateSerial(CInt(Mid(vgRs2!Fec_PagoReg, 1, 4)), CInt(Mid(vgRs2!Fec_PagoReg, 5, 2)), CInt(Mid(vgRs2!Fec_PagoReg, 7, 2)))
                
                If CDate(Trim(Txt_EndFecEnd)) <= vliFecha And vgRs2!cod_estadoreg <> "C" Then
                    vlFecIniPagoPen = Format(vliFecha, "yyyymmdd")
                    vlFecPriPago = Format(vliFecha, "yyyymmdd")
                Else
                    vlFecIniPagoPen = Format(DateAdd("m", 1, vliFecha), "yyyymmdd")
                    vlFecPriPago = Format(DateAdd("m", 1, vliFecha), "yyyymmdd")
                End If
            Else
               vlFecIniPagoPen = Format(Txt_EndFecEfecto, "yyyymmdd")
               vlFecPriPago = Format(Txt_EndFecEfecto, "yyyymmdd")
            End If
            vgRs2.Close
            
            
        End If
    End If
    'RRR 13/11/2018

Exit Function
Err_flFormatearDatosPoliza:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flInsertarPoliza()
'*On Error GoTo Err_flInsertarPoliza

    vgSql = ""
    vgSql = "INSERT INTO PP_TMAE_ENDPOLIZA "
    vgSql = vgSql & "(num_poliza,num_endoso,cod_tippension,cod_estado, "
    vgSql = vgSql & "cod_tipren,cod_modalidad,num_cargas,fec_vigencia, "
    vgSql = vgSql & "fec_tervigencia,mto_prima,mto_pension,num_mesdif, "
    vgSql = vgSql & "num_mesgar,prc_tasace,prc_tasavta,prc_tasaintpergar "
'****
    'vgSql = vgSql & ",Fec_Emision"
    vgSql = vgSql & ",Fec_dev,Fec_IniPenCia,Cod_Moneda,"
    vgSql = vgSql & "Mto_ValMoneda," 'Mto_PensionGar,"
    vgSql = vgSql & "Ind_Cob,Cod_CoberCon,Mto_FacPenElla,Prc_FacPenElla,"
    vgSql = vgSql & "Cod_DerCre,Cod_DerGra "
    vgSql = vgSql & ",FEC_PRIPAGO,FEC_FINPERDIF,FEC_FINPERGAR "
    vgSql = vgSql & ",COD_TIPREAJUSTE, MTO_VALREAJUSTETRI, MTO_VALREAJUSTEMEN " 'hqr 13/01/2011
'****
    vgSql = vgSql & " ) VALUES ( "
    vgSql = vgSql & "'" & vlNumPoliza & "', "
    vgSql = vgSql & " " & vlNumEndoso & ", "
    vgSql = vgSql & "'" & vlCodTipPension & "', "
    vgSql = vgSql & "'" & vlCodEstado & "', "
    vgSql = vgSql & "'" & vlCodTipRen & "', "
    vgSql = vgSql & "'" & vlCodModalidad & "', "
    vgSql = vgSql & " " & vlNumCargas & ", "
    vgSql = vgSql & "'" & vlFecVigencia & "', "
    vgSql = vgSql & "'" & vlFecTerVigencia & "', "
    vgSql = vgSql & " " & str(vlMtoPrima) & ", "
    vgSql = vgSql & " " & str(vlMtoPension) & ", "
    vgSql = vgSql & " " & str(vlNumMesDif) & ", "
    vgSql = vgSql & " " & str(vlNumMesGar) & ", "
    vgSql = vgSql & " " & str(vlPrcTasaCe) & ", "
    vgSql = vgSql & " " & str(vlPrcTasaVta) & ", "
    vgSql = vgSql & " " & str(vlPrcTasaIntPerGar) & " "
'****
    'vgSql = vgSql & ",'" & vlFecEmision & "', "
    vgSql = vgSql & ",'" & vlFecDevengue & "', "
    vgSql = vgSql & "'" & vlFecIniPenCia & "', "
    vgSql = vgSql & "'" & vlCodMoneda & "', "
    vgSql = vgSql & " " & str(vlValMoneda) & ", "
    'vgSql = vgSql & " " & Str(vlMtoPensionGar) & ", "
    vgSql = vgSql & "'" & vlIndCobertura & "', "
    vgSql = vgSql & "'" & vlCobCoberCon & "', "
    vgSql = vgSql & " " & str(vlMtoFacPenElla) & ", "
    vgSql = vgSql & " " & str(vlPrcFacPenElla) & ", "
    vgSql = vgSql & "'" & vlCodDerCrecer & "', "
    vgSql = vgSql & "'" & vlCodDerGratificacion & "' "
    
    vgSql = vgSql & ",'" & vlFecPriPago & "', "
    If (vlFecTerPagoPenDif <> "") Then
        vgSql = vgSql & "'" & vlFecTerPagoPenDif & "', "
    Else
        vgSql = vgSql & " NULL , "
    End If
    If (vlFecTerPagoPenGar <> "") Then
        vgSql = vgSql & "'" & vlFecTerPagoPenGar & "' "
    Else
        vgSql = vgSql & " NULL "
    End If
    vgSql = vgSql & ",'" & vlCodTipReajuste & "', "
    vgSql = vgSql & str(vlMtoValReajusteTri) & ", "
    vgSql = vgSql & str(vlMtoValReajusteMen)
'****
    vgSql = vgSql & ") "
    vgConectarBD.Execute vgSql

    vlLog_tabla = "PP_TMAE_ENDPOLIZA"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO"
    vlLog_valtabla = "" & vlNumPoliza & "." & vlNumEndoso & ""
    vlLog_trans = "INS"
    Call flLog_Tabla

Exit Function
Err_flInsertarPoliza:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flActualizarPoliza()
'*On Error GoTo Err_flActualizarPoliza

    vgSql = ""
    vgSql = " UPDATE PP_TMAE_ENDPOLIZA SET "
    vgSql = vgSql & " cod_tippension = '" & vlCodTipPension & "', "
    vgSql = vgSql & " cod_estado = '" & vlCodEstado & "', "
    vgSql = vgSql & " cod_tipren = '" & vlCodTipRen & "', "
    vgSql = vgSql & " cod_modalidad = '" & vlCodModalidad & "', "
    vgSql = vgSql & " num_cargas = " & vlNumCargas & ", "
    vgSql = vgSql & " fec_vigencia = '" & vlFecVigencia & "', "
    vgSql = vgSql & " fec_tervigencia = '" & vlFecTerVigencia & "', "
    vgSql = vgSql & " mto_prima = " & str(vlMtoPrima) & ", "
    vgSql = vgSql & " mto_pension = " & str(vlMtoPension) & ", "
    vgSql = vgSql & " num_mesdif = " & str(vlNumMesDif) & ", "
    vgSql = vgSql & " num_mesgar = " & str(vlNumMesGar) & ", "
    vgSql = vgSql & " prc_tasace = " & str(vlPrcTasaCe) & ", "
    vgSql = vgSql & " prc_tasavta = " & str(vlPrcTasaVta) & ", "
    vgSql = vgSql & " prc_tasaintpergar = " & str(vlPrcTasaIntPerGar) & " "
'I--- ABV 26/09/2007 ---
    vgSql = vgSql & ",Fec_pripago = '" & vlFecPriPago & "' "
    If (vlFecTerPagoPenGar = "") Then
        vgSql = vgSql & ",Fec_finpergar = NULL "
    Else
        vgSql = vgSql & ",Fec_finpergar = '" & vlFecTerPagoPenGar & "' "
    End If
    If (vlFecTerPagoPenDif = "") Then
        vgSql = vgSql & ",Fec_finperdif = NULL "
    Else
        vgSql = vgSql & ",Fec_finperdif =  '" & vlFecTerPagoPenDif & "' "
    End If
    vgSql = vgSql & ",Fec_IniPenCia = '" & vlFecIniPenCia & "' "
'F--- ABV 26/09/2007 ---
    vgSql = vgSql & " WHERE "
    vgSql = vgSql & " num_poliza = '" & Trim(Txt_PenPoliza.Text) & "' AND "
    vgSql = vgSql & " num_endoso = " & Trim(Lbl_End) & " "
    
    vgConectarBD.Execute vgSql

    ' CORPTEC
    vlLog_tabla = "PP_TMAE_ENDPOLIZA"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO"
    vlLog_valtabla = "" & Trim(Txt_PenPoliza.Text) & "." & Lbl_End & ""
    vlLog_trans = "UPD"
    Call flLog_Tabla

Exit Function
Err_flActualizarPoliza:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flFormatearDatosBeneficiario(iFila As Integer)
'*On Error GoTo Err_flFormatearDatosBeneficiario

    Msf_BMGrilla.row = iFila
    
    Msf_BMGrilla.Col = 0
    vlNumOrden = Msf_BMGrilla.Text
    Msf_BMGrilla.Col = 1
    vlCodTipoIdenBen = fgObtenerCodigo_TextoCompuesto(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 2
    vlNumIdenBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 3
    vlNomBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 4
    vlNomSegBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 5
    vlPaternoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 6
    vlMaternoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 7
    vlCodPar = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 8
    vlCodGruFam = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 9
    vlCodSexo = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 10
    vlCodSitInv = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 11
    vlCodDerpen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 12
    vlCodDerCre = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 13
    vlNumPoliza = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 14
    vlNumEndoso = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 15
    vlCodCauInv = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 16
    'I--- ABV 25/04/2005 ---
    vlFecNacBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Msf_BMGrilla.Col = 17
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecNacHM = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecNacHM = ""
    End If
    Msf_BMGrilla.Col = 18
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecInvBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecInvBen = ""
    End If
    'F--- ABV 25/04/2005 ---
    
    
    
    Msf_BMGrilla.Col = 20
    vlPrcPension = (Trim(Msf_BMGrilla.Text))
    If Trim(Mid(Cmb_EndTipoEnd.Text, 1, vlNumero - 1)) = "A" Then
        Msf_BMGrilla.Col = 19
        vlMtoPension = (Trim(Msf_BMGrilla.Text))
    Else
        'Msf_BMGrilla.Col = 19
        vlMtoPension = Format(Lbl_EndMtoPensionOrig * (vlPrcPension / 100), "###0.00")
    End If
    
    Msf_BMGrilla.Col = 21
    'I--- ABV 25/04/2005 ---
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecFallBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecFallBen = ""
    End If
    'F--- ABV 25/04/2005 ---
    Msf_BMGrilla.Col = 22
    vlCodEstPension = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 23
    vlCodMotReqPen = Trim(Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 25
    vlCodCauSusBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 26
    'I--- ABV 25/04/2005 ---
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecSusBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecSusBen = ""
    End If
    Msf_BMGrilla.Col = 27
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecIniPagoPen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecIniPagoPen = ""
    End If
    Msf_BMGrilla.Col = 28
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecTerPagoPenGar = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
'        vlFecTerPagoPenGar = Trim(Msf_BMGrilla.Text)
    Else
        vlFecTerPagoPenGar = ""
    End If
    Msf_BMGrilla.Col = 29
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecMatrimonio = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecMatrimonio = ""
    End If
    
    Msf_BMGrilla.Col = 30
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlPrcPensionGar = (Msf_BMGrilla.Text)
    Else
        vlPrcPensionGar = 0
    End If
    If Trim(Mid(Cmb_EndTipoEnd.Text, 1, vlNumero - 1)) = "A" Then
        Msf_BMGrilla.Col = 24
        vlMtoPensionGar = Trim(Msf_BMGrilla.Text)
    Else
        'Msf_BMGrilla.Col = 24
        vlMtoPensionGar = Format(lbl_EndMtoPensionOrigGar * (vlPrcPensionGar / 100), "###0.00")
    End If
    
    Msf_BMGrilla.Col = 31
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlPrcPensionLeg = (Msf_BMGrilla.Text)
    Else
        vlPrcPensionLeg = 0
    End If
    
    'F--- ABV 25/04/2005 ---
    
    'RRR 23/04/2013
    Msf_BMGrilla.Col = 32
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlCodDireccion = (Msf_BMGrilla.Text)
    Else
        vlCodDireccion = 0
    End If
    Msf_BMGrilla.Col = 33
    If (Trim(Msf_BMGrilla.Text) <> "") Then
         vlGlsDirBen = (Msf_BMGrilla.Text)
    Else
         vlGlsDirBen = ""
    End If
    Msf_BMGrilla.Col = 34
    If (Trim(Msf_BMGrilla.Text) <> "") Then
         vlGlsFonoBen = (Msf_BMGrilla.Text)
    Else
         vlGlsFonoBen = ""
    End If
    
    Msf_BMGrilla.Col = 35
    If (Trim(Msf_BMGrilla.Text) <> "") Then
         vlGlsCorreoBen = (Msf_BMGrilla.Text)
    Else
         vlGlsCorreoBen = ""
    End If
    
    Msf_BMGrilla.Col = 36
    If (Trim(Msf_BMGrilla.Text) <> "") Then
         vlGlsTelben2 = (Msf_BMGrilla.Text)
    Else
         vlGlsTelben2 = ""
    End If
    '''''''''''''''''''''''''
    Msf_BMGrilla.Col = 37
    vlCodBanco = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 38
    vlCodTipcta = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 39
    vlcodmonbco = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 40
    vlnumctabco = (Msf_BMGrilla.Text)
    
 
    'mvg 20170904
    Msf_BMGrilla.Col = 41
    vlBolelec = (Msf_BMGrilla.Text)
    
    'Inicion GCP - Fractal 25032019
    Msf_BMGrilla.Col = 42
    vlnumctacci = (Msf_BMGrilla.Text)
    
    
     Msf_BMGrilla.Col = 45
     vl_ConTratDatos_Ben = (Msf_BMGrilla.Text)
  
     Msf_BMGrilla.Col = 46
     vl_ConUsoDatosCom_Ben = (Msf_BMGrilla.Text)
     
     
     Msf_BMGrilla.Col = 49
     vl_COD_MODTIPOCUENTA_MANC = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 50
     vl_COD_TIPODOC_MANC = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 51
     vl_NUM_DOC_MANC = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 52
     vl_NOMBRE_MANC = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 53
     vl_APELLIDO_MANC = (Msf_BMGrilla.Text)
    
        
    'Fin GCP - Fractal 25032019

Exit Function
Err_flFormatearDatosBeneficiario:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

'Implementacion GobiernoDeDatos(Se insertan en las tablas de endosos de direccion y telefono)
Function flInsertarBeneficiarioDirec(Vtabla2 As String, vTabla As String)
'*On Error GoTo Err_flInsertarBeneficiario
    vlGlsUsuarioCrea = vgUsuario
    vlFecCrea = Format(Date, "yyyymmdd")
    vlHorCrea = Format(Time, "hhmmss")
    
    
    vgSql = ""
    vgSql = "INSERT INTO " & vTabla
    vgSql = vgSql & "(num_poliza,num_endoso,num_orden,Cod_TipoIdenben,Num_Idenben, "
    vgSql = vgSql & "cod_tipo_fonoben,cod_area_fonoben,gls_fonoben,cod_tipo_telben2, "
    vgSql = vgSql & "cod_area_telben2,gls_Telben2,cod_usuariocrea,fec_crea,hor_crea"
    vgSql = vgSql & " ) VALUES ( "
    vgSql = vgSql & "'" & vlNumPoliza & "', "
    vgSql = vgSql & " " & str(vlNumEndoso) & ", "
    vgSql = vgSql & " " & str(vlNumOrden) & ", "
    vgSql = vgSql & " " & str(vlCodTipoIdenBen) & ", "
    vgSql = vgSql & "'" & vlNumIdenBen & "', "
    vgSql = vgSql & "'" & pTipoTelefono & "', "
    vgSql = vgSql & "'" & pCodigoTelefono & "', "
    vgSql = vgSql & "'" & pNumTelefono & "', "
    vgSql = vgSql & "'" & pTipoTelefono2 & "', "
    vgSql = vgSql & "'" & pCodigoTelefono2 & "', "
    vgSql = vgSql & "'" & pNumTelefono2 & "', "
    vgSql = vgSql & "'" & vlGlsUsuarioCrea & "', "
    vgSql = vgSql & "'" & vlFecCrea & "', "
    vgSql = vgSql & "'" & vlHorCrea & "'"
    vgSql = vgSql & ")"
    vgConectarBD.Execute vgSql
    'CORPTEC
    vlLog_tabla = vTabla
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.NUM_ORDEN"
    vlLog_valtabla = "" & vlNumPoliza & "." & vlNumEndoso & "." & vlNumOrden & ""
    vlLog_trans = "INS"
    Call flLog_Tabla
    
    
    vgSql = "INSERT INTO " & Vtabla2
    vgSql = vgSql & "(num_poliza,num_endoso,num_orden,Cod_TipoIdenben,Num_Idenben, "
    vgSql = vgSql & "cod_dire_via,gls_direccion,num_direccion,cod_blockchalet,gls_blockchalet, "
    vgSql = vgSql & "cod_interior,num_interior,cod_cjht,gls_nom_cjht,gls_etapa,gls_manzana,gls_lote,gls_referencia,cod_distrito,"
    vgSql = vgSql & "gls_desdirebusq,cod_usuariocrea,fec_crea,hor_crea "
    vgSql = vgSql & " ) VALUES ( "
    vgSql = vgSql & "'" & vlNumPoliza & "', "
    vgSql = vgSql & " " & str(vlNumEndoso) & ", "
    vgSql = vgSql & " " & str(vlNumOrden) & ", "
    vgSql = vgSql & " " & str(vlCodTipoIdenBen) & ", "
    vgSql = vgSql & "'" & vlNumIdenBen & "', "
    vgSql = vgSql & "'" & pTipoVia & "', "
    vgSql = vgSql & "'" & pDireccion & "', "
    vgSql = vgSql & "'" & pNumero & "', "
    vgSql = vgSql & "'" & pTipoBlock & "', "
    vgSql = vgSql & "'" & pNumBlock & "', "
    vgSql = vgSql & "'" & pTipoPref & "', "
    vgSql = vgSql & "'" & pInterior & "', "
    vgSql = vgSql & "'" & pTipoConj & "', "
    vgSql = vgSql & "'" & pConjHabit & "', "
    vgSql = vgSql & "'" & pEtapa & "', "
    vgSql = vgSql & "'" & pManzana & "', "
    vgSql = vgSql & "'" & pLote & "', "
    vgSql = vgSql & "'" & pReferencia & "', "
    vgSql = vgSql & "'" & vgCodDireccion & "', "
    vgSql = vgSql & "'" & "" & "', "
    vgSql = vgSql & "'" & vlGlsUsuarioCrea & "', "
    vgSql = vgSql & "'" & vlFecCrea & "', "
    vgSql = vgSql & "'" & vlHorCrea & "'"
    vgSql = vgSql & ")"
    vgConectarBD.Execute vgSql
    'CORPTEC
    vlLog_tabla = Vtabla2
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.NUM_ORDEN"
    vlLog_valtabla = "" & vlNumPoliza & "." & vlNumEndoso & "." & vlNumOrden & ""
    vlLog_trans = "INS"
    Call flLog_Tabla
    

Exit Function
Err_flInsertarBeneficiario:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function
'Fin Implementacion GobiernoDeDatos()_

Function flInsertarBeneficiario()
'*On Error GoTo Err_flInsertarBeneficiario

    vgSql = ""
    vgSql = "INSERT INTO PP_TMAE_ENDBEN "
    vgSql = vgSql & "(num_poliza,num_endoso,num_orden,Cod_TipoIdenben,Num_Idenben, "
    vgSql = vgSql & "gls_nomben,gls_patben,gls_matben,cod_grufam, "
    vgSql = vgSql & "cod_par,cod_sexo,cod_sitinv,cod_dercre,cod_derpen, "
    vgSql = vgSql & "cod_cauinv,fec_nacben,"
    If (vlFecNacHM <> "") Then vgSql = vgSql & "fec_nachm,"
    If (vlFecInvBen <> "") Then vgSql = vgSql & "fec_invben, "
    vgSql = vgSql & "cod_motreqpen, "
    vgSql = vgSql & "cod_estpension,"
    If (vlFecFallBen <> "") Then vgSql = vgSql & "fec_fallben,"
    vgSql = vgSql & "cod_caususben,"
    If (vlFecSusBen <> "") Then vgSql = vgSql & "fec_susben, "
    vgSql = vgSql & "fec_inipagopen,"
    If (vlFecTerPagoPenGar <> "") And (vlCodEstPension <> clCodSinDerPen) Then vgSql = vgSql & "fec_terpagopengar,"
    If (vlFecMatrimonio <> "") Then vgSql = vgSql & "fec_matrimonio,"
    vgSql = vgSql & "mto_pension,mto_pensiongar,prc_pension "
    vgSql = vgSql & ",prc_pensionleg,prc_pensiongar, cod_direccion, gls_dirben, gls_fonoben, gls_correoben, gls_telben2, cod_banco, cod_tipcta, cod_monbco, num_ctabco "
    If Mid(Cmb_EndCauEnd, 1, 2) = "28" And Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
        vgSql = vgSql & ",COD_MODTIPOCUENTA_MANC"
        vgSql = vgSql & ",COD_TIPODOC_MANC"
        vgSql = vgSql & ",NUM_DOC_MANC"
        vgSql = vgSql & ",NOMBRE_MANC"
        vgSql = vgSql & ",APELLIDO_MANC"
    End If
    'mvg 20170904
    vgSql = vgSql & " ,ind_bolelec, NUM_CUENTA_CCI"
    vgSql = vgSql & " ) VALUES ( "
    vgSql = vgSql & "'" & vlNumPoliza & "', "
    vgSql = vgSql & " " & str(vlNumEndoso) & ", "
    vgSql = vgSql & " " & str(vlNumOrden) & ", "
    vgSql = vgSql & " " & str(vlCodTipoIdenBen) & ", "
    vgSql = vgSql & "'" & vlNumIdenBen & "', "
    vgSql = vgSql & "'" & vlNomBen & "', "
    vgSql = vgSql & "'" & vlPaternoBen & "', "
    vgSql = vgSql & "'" & vlMaternoBen & "', "
    vgSql = vgSql & "'" & vlCodGruFam & "', "
    vgSql = vgSql & "'" & vlCodPar & "', "
    vgSql = vgSql & "'" & vlCodSexo & "', "
    vgSql = vgSql & "'" & vlCodSitInv & "', "
    vgSql = vgSql & "'" & vlCodDerCre & "', "
    vgSql = vgSql & "'" & vlCodDerpen & "', "
    vgSql = vgSql & "'" & vlCodCauInv & "', "
    vgSql = vgSql & "'" & vlFecNacBen & "', "
    If (vlFecNacHM <> "") Then vgSql = vgSql & "'" & vlFecNacHM & "', "
    If (vlFecInvBen <> "") Then vgSql = vgSql & "'" & vlFecInvBen & "', "
    vgSql = vgSql & "'" & vlCodMotReqPen & "', "
    vgSql = vgSql & "'" & vlCodEstPension & "', "
    If (vlFecFallBen <> "") Then vgSql = vgSql & "'" & vlFecFallBen & "', "
    vgSql = vgSql & "'" & vlCodCauSusBen & "', "
    If (vlFecSusBen <> "") Then vgSql = vgSql & "'" & vlFecSusBen & "', "
    vgSql = vgSql & "'" & vlFecIniPagoPen & "', "
    If (vlFecTerPagoPenGar <> "") And (vlCodEstPension <> clCodSinDerPen) Then vgSql = vgSql & "'" & vlFecTerPagoPenGar & "', "
    If (vlFecMatrimonio <> "") Then vgSql = vgSql & "'" & vlFecMatrimonio & "',  "
    vgSql = vgSql & " " & str(vlMtoPension) & ", "
    vgSql = vgSql & " " & str(vlMtoPensionGar) & ", "
    vgSql = vgSql & " " & str(vlPrcPension) & " "
    vgSql = vgSql & "," & str(vlPrcPensionLeg) & " "
    vgSql = vgSql & "," & str(vlPrcPensionGar) & " "
     'RRR 23/04/2013
    vgSql = vgSql & "," & str(vlCodDireccion) & " "
    vgSql = vgSql & ",'" & vlGlsDirBen & "' "
    vgSql = vgSql & ",'" & vlGlsFonoBen & "' "
    vgSql = vgSql & ",'" & vlGlsCorreoBen & "' "
    vgSql = vgSql & ",'" & vlGlsTelben2 & "' "
    
    vgSql = vgSql & ",'" & vlCodBanco & "' "
    vgSql = vgSql & ",'" & vlCodTipcta & "' "
    vgSql = vgSql & ",'" & vlcodmonbco & "' "
    vgSql = vgSql & ",'" & vlnumctabco & "' "
    If Mid(Cmb_EndCauEnd, 1, 2) = "28" And Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
        vgSql = vgSql & ",'" & vl_COD_MODTIPOCUENTA_MANC & "' "
        vgSql = vgSql & ",'" & vl_COD_TIPODOC_MANC & "' "
        vgSql = vgSql & ",'" & vl_NUM_DOC_MANC & "' "
        vgSql = vgSql & ",'" & vl_NOMBRE_MANC & "' "
        vgSql = vgSql & ",'" & vl_APELLIDO_MANC & "' "
    End If
    'mvg 20170904
    vgSql = vgSql & ",'" & vlBolelec & "' "
    'GCP-Fractal 25032019
    vgSql = vgSql & ",'" & vlnumctacci & "' "
    ''''''''
    vgSql = vgSql & ")"
    vgConectarBD.Execute vgSql
    'CORPTEC
    vlLog_tabla = "PP_TMAE_ENDBEN"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.NUM_ORDEN"
    vlLog_valtabla = "" & vlNumPoliza & "." & vlNumEndoso & "." & vlNumOrden & ""
    vlLog_trans = "INS"
    Call flLog_Tabla

Exit Function
Err_flInsertarBeneficiario:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flActualizarBeneficiario()
'*On Error GoTo Err_flActualizarBeneficiario
    
    vgSql = ""
    vgSql = " UPDATE PP_TMAE_ENDBEN SET "
    vgSql = vgSql & " Cod_TipoIdenben = " & vlCodTipoIdenBen & ", "
    vgSql = vgSql & " Num_Idenben = '" & vlNumIdenBen & "', "
    vgSql = vgSql & " gls_nomben = '" & vlNomBen & "', "
    vgSql = vgSql & " gls_patben = '" & vlPaternoBen & "', "
    vgSql = vgSql & " gls_matben = '" & vlMaternoBen & "', "
    vgSql = vgSql & " cod_grufam = '" & vlCodGruFam & "', "
    vgSql = vgSql & " cod_par = '" & vlCodPar & "', "
    vgSql = vgSql & " cod_sexo = '" & vlCodSexo & "', "
    vgSql = vgSql & " cod_sitinv = '" & vlCodSitInv & "', "
    vgSql = vgSql & " cod_dercre = '" & vlCodDerCre & "', "
    vgSql = vgSql & " cod_derpen = '" & vlCodDerpen & "', "
    vgSql = vgSql & " cod_cauinv = '" & vlCodCauInv & "', "
    vgSql = vgSql & " fec_nacben = '" & vlFecNacBen & "', "
    If (vlFecNacHM <> "") Then
        vgSql = vgSql & " fec_nachm  = '" & vlFecNacHM & "', "
    Else
        vgSql = vgSql & " fec_nachm  = NULL , "
    End If
    If (vlFecInvBen <> "") Then
        vgSql = vgSql & " fec_invben = '" & vlFecInvBen & "', "
    Else
        vgSql = vgSql & " fec_invben = NULL , "
    End If
    vgSql = vgSql & " cod_motreqpen = '" & vlCodMotReqPen & "', "
    vgSql = vgSql & " cod_estpension = '" & vlCodEstPension & "', "
    If (vlFecFallBen <> "") Then
        vgSql = vgSql & " fec_fallben = '" & vlFecFallBen & "', "
    Else
        vgSql = vgSql & " fec_fallben = NULL , "
    End If
    vgSql = vgSql & " cod_caususben = '" & vlCodCauSusBen & "', "
    If (vlFecSusBen <> "") Then
        vgSql = vgSql & " fec_susben = '" & vlFecSusBen & "', "
    Else
        vgSql = vgSql & " fec_susben = NULL , "
    End If
    vgSql = vgSql & " fec_inipagopen = '" & vlFecIniPagoPen & "', "
    If (vlFecTerPagoPenGar <> "") Then
        vgSql = vgSql & " fec_terpagopengar = '" & vlFecTerPagoPenGar & "', "
    Else
        vgSql = vgSql & " fec_terpagopengar = NULL , "
    End If
    If (vlFecMatrimonio <> "") Then
        vgSql = vgSql & " fec_matrimonio = '" & vlFecMatrimonio & "', "
    Else
        vgSql = vgSql & " fec_matrimonio = NULL , "
    End If
    vgSql = vgSql & " mto_pension = " & str(vlMtoPension) & ", "
    vgSql = vgSql & " mto_pensiongar = " & str(vlMtoPensionGar) & ", "
    vgSql = vgSql & " prc_pension = " & str(vlPrcPension) & " "
    vgSql = vgSql & ",prc_pensionleg = " & str(vlPrcPensionLeg) & " "
    vgSql = vgSql & ",prc_pensiongar = " & str(vlPrcPensionGar) & " "
    'RRR 23/04/2013
    vgSql = vgSql & ",cod_direccion = " & str(vlCodDireccion) & " "
    vgSql = vgSql & ",gls_dirben = '" & vlGlsDirBen & "' "
    vgSql = vgSql & ",gls_fonoben = '" & vlGlsFonoBen & "' "
    vgSql = vgSql & ",gls_correoben = '" & vlGlsCorreoBen & "' "
    vgSql = vgSql & ",gls_telben2 = '" & vlGlsTelben2 & "' "
    vgSql = vgSql & ",cod_banco = '" & vlCodBanco & "' "
    vgSql = vgSql & ",cod_tipcta = '" & vlCodTipcta & "' "
    vgSql = vgSql & ",cod_monbco = '" & vlcodmonbco & "' "
    vgSql = vgSql & ",num_ctabco = '" & vlnumctabco & "' "
    'mvg 20170904
    vgSql = vgSql & ",ind_bolelec = '" & vlBolelec & "' "
    
    'INICIO GCP-Fractal 25032019
vgSql = vgSql & ",NUM_CUENTA_CCI = '" & vlnumctacci & "' "
vgSql = vgSql & ",CONS_TRAINFO = '" & vl_ConTratDatos_Ben & "' "
vgSql = vgSql & ",CONS_DATCOMER = '" & vl_ConUsoDatosCom_Ben & "' "
   'FIN GCP-Fractal 25032019
    
    ''''''''
    vgSql = vgSql & " WHERE "
    vgSql = vgSql & " num_poliza = '" & Trim(Txt_PenPoliza.Text) & "' AND "
    vgSql = vgSql & " num_endoso = " & Trim(Lbl_End) & " AND "
    vgSql = vgSql & " num_orden = " & vlNumOrden & " "
    vgConectarBD.Execute vgSql

    ' CORPTEC
    vlLog_tabla = "PP_TMAE_ENDBEN"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.NUM_ORDEN"
    vlLog_valtabla = "" & Trim(Txt_PenPoliza.Text) & "." & Trim(Lbl_End) & "." & vlNumOrden & ""
    vlLog_trans = "INS"
    Call flLog_Tabla

Exit Function
Err_flActualizarBeneficiario:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flFormatearDatosEndoso()
'*On Error GoTo Err_flFormatearDatosEndoso

    vlNumPoliza = Trim(Txt_PenPoliza)
    vlNumEndoso = Trim(Lbl_End)
    vlFecSolEndoso = Format(CDate(Trim(Txt_EndFecEnd)), "yyyymmdd")
    vlFecEndoso = fgBuscaFecServ
    vlFecEndoso = Format(CDate(Trim(vlFecEndoso)), "yyyymmdd")
    vlNumero = InStr(Cmb_EndTipoEnd.Text, "-")
    vlCodTipEndoso = Trim(Mid(Cmb_EndTipoEnd.Text, 1, vlNumero - 1))
    vlNumero = InStr(Cmb_EndCauEnd.Text, "-")
    vlCodCauEndoso = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))
    
    
    If vlCodTipEndoso <> "A" Then
        
        If CInt(Txt_PMMesGar) <> 0 Then
            If lbl_EndMtoPensionOrigGar <> "" Then
                vlMtoPensionOri = Lbl_EndMtoPensionOrig
            Else
                vlMtoPensionOri = 0
            End If
            
            If lbl_EndMtoPensionCalcGar <> "" Then
               vlMtoPensionCal = Lbl_EndMtoPensionCalc
            Else
                vlMtoPensionCal = 0
            End If
        Else
            If Lbl_EndMtoPensionOrig <> "" Then
                vlMtoPensionOri = Lbl_EndMtoPensionOrig
            Else
                vlMtoPensionOri = 0
            End If
            
            If Lbl_EndMtoPensionCalc <> "" Then
               vlMtoPensionCal = Lbl_EndMtoPensionCalc
            Else
                vlMtoPensionCal = 0
            End If
        
        End If
    Else
        If Lbl_EndMtoPensionCalc <> "" And Lbl_EndMtoPensionOrig <> "" Then
           vlMtoDiferencia = Format((CDbl(Lbl_EndMtoPensionCalc) - CDbl(Lbl_EndMtoPensionOrig)), "#0.00")
        Else
           vlMtoDiferencia = 0
        End If
        txt_EndMtoPensionOrig = Lbl_EndMtoPensionOrig
        txt_EndMtoPensionOrigGar = lbl_EndMtoPensionOrigGar
        vlMtoPensionOri = txt_EndMtoPensionOrig
        vlMtoPensionCal = txt_EndMtoPensionCalc
    End If
    
   
    'I--- ABV 25/04/2005 ---
    vlPrcFactor = Format(vlFactor, "#0.000000") 'vlPorcentaje
    'F--- ABV 25/04/2005 ---
    vlFecEfectoEnd = Format(CDate(Trim(Txt_EndFecEfecto)), "yyyymmdd")
    vlObsEndoso = Trim(Txt_EndObs)
    
    'CMV-20051024 I
    vlFecFinEfecto = Trim(clFechaTope)
    'CMV-20051024 F
    
    'CMV-20051025 I
    'Estado para PreEndoso
    vlCodEstadoEndoso = Trim(clCodEstadoP)
    'CMV-20051025 F
    
    vlGlsUsuarioCrea = vgUsuario
    vlFecCrea = Format(Date, "yyyymmdd")
    vlHorCrea = Format(Time, "hhmmss")
    vlGlsUsuarioModi = vgUsuario
    vlFecModi = Format(Date, "yyyymmdd")
    vlHorModi = Format(Time, "hhmmss")

Exit Function
Err_flFormatearDatosEndoso:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flInsertarEndoso()
'*On Error GoTo Err_flInsertarEndoso

    vgSql = ""
    vgSql = "INSERT INTO PP_TMAE_ENDOSO "
    vgSql = vgSql & "(num_poliza,num_endoso,fec_solendoso,fec_endoso, "
    vgSql = vgSql & "cod_cauendoso,cod_tipendoso,mto_diferencia, "
    vgSql = vgSql & "mto_pensionori,mto_pensioncal,fec_efecto, "
    vgSql = vgSql & "prc_factor,"
    'I--- ABV 25/04/2005 ---
    If (vlObsEndoso <> "") Then
        vgSql = vgSql & "gls_observacion, "
    End If
    'F--- ABV 25/04/2005 ---
    'CMV-20051024 I
    vgSql = vgSql & "fec_finefecto,cod_moneda,"
    'CMV-20051024 F
    'CMV-20051025 I
    vgSql = vgSql & "cod_estado,"
    
    
    'CMV-20051025 F
    vgSql = vgSql & "cod_usuariocrea,fec_crea,hor_crea "
    vgSql = vgSql & ", cod_tipreajuste, mto_valreajustetri, mto_valreajustemen" 'hqr 13/01/2011
    vgSql = vgSql & " ) VALUES ( "
    vgSql = vgSql & "'" & vlNumPoliza & "', "
    vgSql = vgSql & " " & vlNumEndoso & ", "
    vgSql = vgSql & "'" & vlFecSolEndoso & "', "
    vgSql = vgSql & "'" & vlFecEndoso & "', "
    vgSql = vgSql & "'" & vlCodCauEndoso & "', "
    vgSql = vgSql & "'" & vlCodTipEndoso & "', "
    vgSql = vgSql & " " & str(vlMtoDiferencia) & ", "
    vgSql = vgSql & " " & str(vlMtoPensionOri) & ", "
    vgSql = vgSql & " " & str(vlMtoPensionCal) & ", "
    vgSql = vgSql & "'" & vlFecEfectoEnd & "', "
    vgSql = vgSql & " " & str(vlPrcFactor) & ", "
    'I--- ABV 25/04/2005 ---
    If (vlObsEndoso <> "") Then
        vgSql = vgSql & "'" & vlObsEndoso & "', "
    End If
    'F--- ABV 25/04/2005 ---
    'CMV-20051024 I
    vgSql = vgSql & "'" & Trim(vlFecFinEfecto) & "',"
    vgSql = vgSql & "'" & Trim(vlCodMoneda) & "',"
    'CMV-20051024 F
    'CMV-20051025 I
    vgSql = vgSql & "'" & Trim(vlCodEstadoEndoso) & "',"
    'CMV-20051025 F

    vgSql = vgSql & "'" & vlGlsUsuarioCrea & "', "
    vgSql = vgSql & "'" & vlFecCrea & "', "
    vgSql = vgSql & "'" & vlHorCrea & "', "
    vgSql = vgSql & "'" & vlCodTipReajuste & "', "
    vgSql = vgSql & str(vlMtoValReajusteTri) & ", "
    vgSql = vgSql & str(vlMtoValReajusteMen) & ") "
    vgConectarBD.Execute vgSql
    
    
Exit Function
Err_flInsertarEndoso:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function
Private Sub CreaCertificado()
Dim fechater As Date
Dim RS As ADODB.Recordset
Dim rs2 As ADODB.Recordset
Dim rsRepacto As ADODB.Recordset
Dim rsRepacto2 As ADODB.Recordset
Dim vlNumEndoso2 As Integer
Dim NUltPag As Boolean
Dim vInstitucion As String
Dim vUltimoPago As String
Dim vPrimerPago As String
Dim vlTipCer As String
Dim vlInstitucionEst As String



On Error GoTo mierror

   'Obteniendo el ultimo numero de endoso
    vgSql = "SELECT b.num_poliza,b.num_endoso "
    vgSql = vgSql & "FROM pp_tmae_ben b "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "Num_Poliza ='" & Trim(Txt_PenPoliza.Text) & "'"
    vgSql = vgSql & " AND b.num_endoso = "
    vgSql = vgSql & "(SELECT MAX (num_endoso) as numero FROM pp_tmae_poliza "
    vgSql = vgSql & "WHERE Num_Poliza = b.Num_Poliza) "
    
    Set vgRegistro = vgConexionBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
       'almacenando ultimo numero de endoso
        vlNumEndoso2 = (vgRegistro!num_endoso)
    End If
    
    Set RS = New ADODB.Recordset
    
    'Consulta la edad en meses de los beneficiarios con estado de pension diferente de "10" y "20"
    RS.Open "select DISTINCT num_orden, cod_par, trunc(months_between(sysdate, to_date(fec_nacben,'yyyymmdd'))/12) * 12 edad from pp_tmae_ben where NUM_POLIZA='" & Trim(Txt_PenPoliza.Text) & "' and num_orden> 1 and num_orden=" & Lbl_BMNumOrd.Caption, vgConexionBD, adOpenStatic, adLockReadOnly
    
    'vlCodCauEndoso = "13"==> ADELANTO DE RENTA VITALICIA
    If Not RS.EOF Or vlCodCauEndoso = "13" Then
    
    'vlCodCauEndoso = "08"==> ACTIVACION DE LAS PENSIONES DE SOBREVIVENCIA
    If vlCodCauEndoso = "08" Then
    
        '***********INI GCP SE TRASLADA A STORE PROCEDURE 20211016
        
        
                For x = 1 To Msf_BMGrilla.rows - 1
                    Msf_BMGrilla.row = x
                    Msf_BMGrilla.Col = 47
                   
                   If Len(Trim(Msf_BMGrilla.Text)) > 0 Then
                      Call SP_INS_CERTIFICADO_ACTIVACION(Trim(Txt_PenPoliza.Text), CInt(Msf_BMGrilla.Text), Format(Txt_EndFecEfecto.Text, "yyyymmdd"), vgUsuario)
                   End If
        
                Next
             
           
'        'Obtiene el AFP y la fecha de inicio de pago
'        cadena = "select DISTINCT T.GLS_ELEMENTO, p.FEC_INIPAGOPEN from PP_TMAE_POLIZA p inner join ma_tpar_tabcod t on P.COD_AFP=T.COD_ELEMENTO WHERE t.cod_tabla='AF' AND p.NUM_POLIZA='" & Trim(Txt_PenPoliza.Text) & "'"
'        Set rs2 = New ADODB.Recordset
'        rs2.Open cadena, vgConexionBD, adOpenStatic, adLockReadOnly
'
'        If Not rs2.EOF Then
'            vInstitucion = "AFP " & rs2!GLS_ELEMENTO
'            vPrimerPago = DateSerial(Mid((rs2!Fec_IniPagoPen), 1, 4), Mid((rs2!Fec_IniPagoPen), 5, 2), Mid((rs2!Fec_IniPagoPen), 7, 2))
'
'            'Si la FEC_INIPAGOPEN es antes de la fecha actual se reemplaza por la fecha actual
'            'en caso contrario se mantiene
'            If CDate(vPrimerPago) < CDate(Txt_EndFecEfecto.Text) Then
'                vPrimerPago = Txt_EndFecEfecto.Text
'            End If
'        End If
'
'
'        NUltPag = True
'
'        'Periodo del ultimo pago que se hizo al titular (yyyymm)
'        cadena = "select max(num_perpago)+ 1 as pago from pp_tmae_pagopendef where num_poliza='" & Trim(Txt_PenPoliza.Text) & "' and num_orden=1 and cod_conhabdes='01' and cod_tipreceptor <> 'R'"
'
'
'        Set rs3 = New ADODB.Recordset
'        rs3.Open cadena, vgConexionBD, adOpenStatic, adLockReadOnly
'
'        'Si no es nulo se agrega el dia 01
'        'En caso contrario se coloca el IniPagoPen de la tabla PP_TMAE_POLIZA
'        If Not rs3.EOF Then
'            If Not IsNull(rs3!pago) Then
'                vUltimoPago = rs3!pago & "01"
'            Else
'                vUltimoPago = rs2!Fec_IniPagoPen
'                NUltPag = False
'            End If
'        End If
'
'
'        While Not RS.EOF
'
'            'Se pregunta si se estuvo pagando al titular
'            If NUltPag = True Then
'
'                'crea certificado interno desde el ultimo mes q se pago al titular
'                vgSql = "select num_poliza,fec_tercer from pp_tmae_certificado where "
'                vgSql = vgSql & " NUM_POLIZA = '" & Trim(Txt_PenPoliza.Text) & "' and "
'                vgSql = vgSql & " NUM_ORDEN = " & Trim(RS!Num_Orden) & " and "
'                vgSql = vgSql & " fec_inicer = '" & vUltimoPago & "'"
'
'                'Si existe un certificado con la fecha de inicio igual a PP_TMAE_POLIZA.Fec_IniPagoPen
'                'se actualiza sino se inserta
'
'                Set vlRegistro = vgConexionBD.Execute(vgSql)
'                If vlRegistro.EOF Then
'                    vlOp = "I"
'                Else
'                    vlOp = "A"
'                End If
'                If vlOp = "I" Then
'                    Sql = ""
'                    Sql = "insert into pp_tmae_certificado ("
'                    Sql = Sql & "NUM_POLIZA,NUM_ORDEN,fec_inicer,fec_tercer,NUM_ENDOSO,GLS_NOMINSTITUCION"
'                    Sql = Sql & ",FEC_RECCIA,FEC_INGCIA,FEC_EFECTO,COD_USUARIOCREA,"
'                    Sql = Sql & "FEC_CREA,HOR_CREA,COD_INDRELIQUIDAR,COD_TIPO,EST_ACT"
'                    Sql = Sql & ") values ('" & Trim(Txt_PenPoliza.Text) & "'," & Trim(RS!Num_Orden) & ",'" & vUltimoPago & "',"
'                    Sql = Sql & "'" & Format(DateAdd("d", -1, Txt_EndFecEfecto.Text), "yyyymmdd") & "'," & vlGlobalNumEndosoCrear & ","
'                    If (vInstitucion <> "") Then
'                        Sql = Sql & "'" & vInstitucion & "',"
'                    Else
'                        Sql = Sql & "NULL,"
'                    End If
'                    Sql = Sql & "'" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',"
'                    Sql = Sql & "'" & (vgUsuario) & "','" & Format(Date, "yyyymmdd") & "','" & Format(Time, "hhmmss") & "','S','INT','1')"
'                    vgConexionBD.Execute (Sql)
'                Else
'                    Sql = ""
'                    Sql = "UPDATE pp_tmae_certificado SET fec_tercer='" & Format(DateAdd("d", -1, Txt_EndFecEfecto.Text), "yyyymmdd") & "'"
'                    Sql = Sql & ",NUM_ENDOSO=" & vlGlobalNumEndosoCrear & ",GLS_NOMINSTITUCION='" & IIf(vInstitucion <> "", vInstitucion, Null) & "'"
'                    Sql = Sql & ",FEC_RECCIA='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',FEC_INGCIA='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',FEC_EFECTO='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',COD_USUARIOCREA='" & (vgUsuario) & "'"
'                    Sql = Sql & ",FEC_CREA='" & Format(Date, "yyyymmdd") & "',HOR_CREA='" & Format(Time, "hhmmss") & "',COD_INDRELIQUIDAR='S',COD_TIPO='INT'"
'                    Sql = Sql & " where NUM_POLIZA='" & Trim(Txt_PenPoliza.Text) & "' and NUM_ORDEN=" & Trim(RS!Num_Orden) & " and fec_inicer='" & vUltimoPago & "' "
'
'                    vgConexionBD.Execute (Sql)
'                End If
'            End If
'
'            'crea certificado normal desde la fecha del endoso(fecha de efecto +12 meses mas)
'            vgSql = "select num_poliza,fec_tercer from pp_tmae_certificado where "
'            vgSql = vgSql & " NUM_POLIZA = '" & Trim(Txt_PenPoliza.Text) & "' and "
'            vgSql = vgSql & " NUM_ORDEN = " & Trim(RS!Num_Orden) & " and "
'            vgSql = vgSql & " fec_inicer = '" & vUltimoPago & "'"
'            Set vlRegistro = vgConexionBD.Execute(vgSql)
'            If vlRegistro.EOF Then
'                vlOp = "I"
'            Else
'                vlOp = "A"
'            End If
'            If vlOp = "I" Then
'
'                'En este rango solo está el cod_par=30 "HIJO"
'                If RS!Cod_Par >= 30 And RS!Cod_Par <= 40 Then
'                    Sql = ""
'                    Sql = "update pp_tmae_ben set cod_estpension='10' where "
'                    Sql = Sql & " NUM_POLIZA = '" & Trim(Txt_PenPoliza.Text) & "' and  NUM_ORDEN = " & Trim(RS!Num_Orden) & " and num_endoso=" & vlGlobalNumEndosoCrear & ""
'                    vgConexionBD.Execute (Sql)
'                    ' CORPTEC
'                    vlLog_tabla = "PP_TMAE_ENDBEN"
'                    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.NUM_ORDEN"
'                    vlLog_valtabla = "" & Txt_PenPoliza.Text & "." & vlGlobalNumEndosoCrear & "." & RS!Num_Orden & ""
'                    vlLog_trans = "UPD"
'                    Call flLog_Tabla
'
'                    'Si es menor de 18 años (216 meses)
'                If RS!Edad <= (216) Then
'                        vlTipCer = "SUP"
'                        vlInstitucionEst = vInstitucion
'
''**************************INI - GCP SOLO SE CREARA CERTIFICADO PARA MENORES DE DE 18 Y SERAN DE SUPERVIVENCIA
''                    Else
''                        vlTipCer = "EST"
''                        vlInstitucionEst = "Certificado de Estudios Superiores"
''                    End If
''**************************FIN - GCP SOLO SE CREARA CERTIFICADO PARA MENORES DE DE 18 Y SERAN DE SUPERVIVENCIA
'
'                    Sql = ""
'                    Sql = "insert into pp_tmae_certificado (NUM_POLIZA,NUM_ORDEN,fec_inicer,fec_tercer,NUM_ENDOSO,"
'                    Sql = Sql & "GLS_NOMINSTITUCION,FEC_RECCIA,FEC_INGCIA,FEC_EFECTO,COD_USUARIOCREA,FEC_CREA,HOR_CREA,COD_INDRELIQUIDAR,COD_TIPO,EST_ACT"
'                    Sql = Sql & ") values ("
'                    Sql = Sql & "'" & Trim(Txt_PenPoliza.Text) & "'," & Trim(RS!Num_Orden) & ",'" & Format(vPrimerPago, "yyyymmdd") & "',"
'                    Sql = Sql & "'" & Format(DateAdd("d", -1, DateAdd("m", 12, vPrimerPago)), "yyyymmdd") & "'," & vlGlobalNumEndosoCrear & ","
'                    Sql = Sql & "'" & vlInstitucionEst & "',"
'                    Sql = Sql & "'" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',"
'                    Sql = Sql & "'" & (vgUsuario) & "','" & Format(Date, "yyyymmdd") & "','" & Format(Time, "hhmmss") & "','S','" & vlTipCer & "','1')"
'
'               End If
'
'
'                Else
'                 'SI no es HIJO
'                    Sql = ""
'                    Sql = "insert into pp_tmae_certificado (NUM_POLIZA,NUM_ORDEN,fec_inicer,fec_tercer,NUM_ENDOSO,"
'                    Sql = Sql & "GLS_NOMINSTITUCION,FEC_RECCIA,FEC_INGCIA,FEC_EFECTO,COD_USUARIOCREA,FEC_CREA,HOR_CREA,COD_INDRELIQUIDAR,COD_TIPO,EST_ACT"
'                    Sql = Sql & ") values ("
'                    Sql = Sql & "'" & Trim(Txt_PenPoliza.Text) & "'," & Trim(RS!Num_Orden) & ",'" & Format(vPrimerPago, "yyyymmdd") & "',"
'                    Sql = Sql & "'" & Format(DateAdd("d", -1, DateAdd("m", 12, vPrimerPago)), "yyyymmdd") & "'," & vlGlobalNumEndosoCrear & ","
'                    If (vInstitucion <> "") Then
'                        Sql = Sql & "'" & vInstitucion & "',"
'                    Else
'                        Sql = Sql & "NULL,"
'                    End If
'                    Sql = Sql & "'" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',"
'                    Sql = Sql & "'" & (vgUsuario) & "','" & Format(Date, "yyyymmdd") & "','" & Format(Time, "hhmmss") & "','S','SUP','1')"
'                End If
'                vgConexionBD.Execute (Sql)
'            Else
'
'                'En este rango solo está el cod_par=30 "HIJO"
'                If RS!Cod_Par >= 30 And RS!Cod_Par <= 40 Then
'                    Sql = ""
'                    Sql = "UPDATE pp_tmae_certificado SET fec_tercer='" & Format(DateAdd("d", -1, DateAdd("m", 12, vPrimerPago)), "yyyymmdd") & "',"
'                    Sql = Sql & " NUM_ENDOSO=" & vlGlobalNumEndosoCrear & ""
'                    Sql = Sql & ",FEC_RECCIA='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',FEC_INGCIA='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',FEC_EFECTO='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',COD_USUARIOCREA='" & (vgUsuario) & "'"
'                    Sql = Sql & ",FEC_CREA='" & Format(Date, "yyyymmdd") & "',HOR_CREA='" & Format(Time, "hhmmss") & "',COD_INDRELIQUIDAR='S',COD_TIPO='EST'"
'                    Sql = Sql & " where NUM_POLIZA='" & Trim(Txt_PenPoliza.Text) & "' and NUM_ORDEN=" & Trim(RS!Num_Orden) & " and fec_inicer='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "'"
'                Else
'                   'Si no es Hijo
'                    Sql = ""
'                    Sql = "UPDATE pp_tmae_certificado SET fec_tercer='" & Format(DateAdd("d", -1, DateAdd("m", 12, vPrimerPago)), "yyyymmdd") & "',"
'                    Sql = Sql & " NUM_ENDOSO=" & vlGlobalNumEndosoCrear & ",GLS_NOMINSTITUCION='" & IIf(vInstitucion <> "", vInstitucion, Null) & "'"
'                    Sql = Sql & ",FEC_RECCIA='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',FEC_INGCIA='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',FEC_EFECTO='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',COD_USUARIOCREA='" & (vgUsuario) & "'"
'                    Sql = Sql & ",FEC_CREA='" & Format(Date, "yyyymmdd") & "',HOR_CREA='" & Format(Time, "hhmmss") & "',COD_INDRELIQUIDAR='S',COD_TIPO='SUP'"
'                    Sql = Sql & " where NUM_POLIZA='" & Trim(Txt_PenPoliza.Text) & "' and NUM_ORDEN=" & Trim(RS!Num_Orden) & " and fec_inicer='" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "'"
'                End If
'                vgConexionBD.Execute (Sql)
'            End If
'            RS.MoveNext
'        Wend
'        'vgConexionBD.CommitTrans
'***********FIN GCP SE TRASLADA A STORE PROCEDURE 20211016
    ElseIf vlCodCauEndoso = "13" Then
        
        Dim FechaFin As String
        FechaFin = Format(DateAdd("d", -1, DateAdd("m", 12, Txt_EndFecEnd.Text)), "yyyymmdd")
            
        Sql = ""
        Sql = "select * from pp_tmae_ben a "
        Sql = Sql & " where a.NUM_POLIZA='" & Trim(Txt_PenPoliza.Text) & "' and cod_derpen='99' and cod_estpension='99' and a.num_endoso=(SELECT MAX (num_endoso) as numero FROM pp_tmae_poliza where num_poliza='" & Trim(Txt_PenPoliza.Text) & "')"
        Set rsRepacto = New ADODB.Recordset
        rsRepacto.Open Sql, vgConexionBD, adOpenStatic, adLockReadOnly
        
        Do While Not rsRepacto.EOF
            Sql = "select * from pp_tmae_certificado where NUM_POLIZA='" & Trim(Txt_PenPoliza.Text) & "' and num_orden='" & rsRepacto!Num_Orden & "' and fec_inicer<'" & Format(Txt_EndFecEnd.Text, "yyyymmdd") & "' and fec_tercer>='" & Format(Txt_EndFecEnd.Text, "yyyymmdd") & "'"
            Set rsRepacto2 = New ADODB.Recordset
            rsRepacto2.Open Sql, vgConexionBD, adOpenStatic, adLockReadOnly
            If Not rsRepacto2.EOF Then
                
                Sql = ""
                Sql = "UPDATE pp_tmae_certificado SET fec_tercer='" & Format(DateAdd("d", -1, Txt_EndFecEnd.Text), "yyyymmdd") & "'"
                Sql = Sql & ",COD_USUARIOCREA='" & (vgUsuario) & "'"
                Sql = Sql & ",FEC_MODI='" & Format(Date, "yyyymmdd") & "',HOR_MODI='" & Format(Time, "hhmmss") & "'"
                Sql = Sql & " where NUM_POLIZA='" & Trim(Txt_PenPoliza.Text) & "' AND NUM_ENDOSO=" & rsRepacto!num_endoso & " and NUM_ORDEN=" & Trim(rsRepacto2!Num_Orden) & " and fec_inicer='" & rsRepacto2!fec_inicer & "'"
                vgConexionBD.Execute (Sql)
                
                Sql = ""
                Sql = "insert into pp_tmae_certificado (NUM_POLIZA,NUM_ORDEN,fec_inicer,fec_tercer,NUM_ENDOSO,"
                Sql = Sql & "GLS_NOMINSTITUCION,FEC_RECCIA,FEC_INGCIA,FEC_EFECTO,COD_USUARIOCREA,FEC_CREA,HOR_CREA,COD_INDRELIQUIDAR,COD_TIPO,EST_ACT"
                Sql = Sql & ") values ("
                Sql = Sql & "'" & Trim(Txt_PenPoliza.Text) & "'," & Trim(rsRepacto!Num_Orden) & ",'" & Format(Txt_EndFecEnd.Text, "yyyymmdd") & "',"
                Sql = Sql & "'" & FechaFin & "'," & vlGlobalNumEndosoCrear & ","
                Sql = Sql & "'Repacto',"
                Sql = Sql & "'" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',"
                Sql = Sql & "'" & (vgUsuario) & "','" & Format(Date, "yyyymmdd") & "','" & Format(Time, "hhmmss") & "','S','SUP','1')"
                vgConexionBD.Execute (Sql)
                rsRepacto2.MoveNext
            Else
                Sql = ""
                Sql = "insert into pp_tmae_certificado (NUM_POLIZA,NUM_ORDEN,fec_inicer,fec_tercer,NUM_ENDOSO,"
                Sql = Sql & "GLS_NOMINSTITUCION,FEC_RECCIA,FEC_INGCIA,FEC_EFECTO,COD_USUARIOCREA,FEC_CREA,HOR_CREA,COD_INDRELIQUIDAR,COD_TIPO,EST_ACT"
                Sql = Sql & ") values ("
                Sql = Sql & "'" & Trim(Txt_PenPoliza.Text) & "'," & Trim(rsRepacto!Num_Orden) & ",'" & Format(Txt_EndFecEnd.Text, "yyyymmdd") & "',"
                Sql = Sql & "'" & Format(DateAdd("d", -1, DateAdd("m", 12, Txt_EndFecEnd.Text)), "yyyymmdd") & "'," & vlGlobalNumEndosoCrear & ","
                Sql = Sql & "'Repacto',"

                Sql = Sql & "'" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "','" & Format(Txt_EndFecEfecto.Text, "yyyymmdd") & "',"
                Sql = Sql & "'" & (vgUsuario) & "','" & Format(Date, "yyyymmdd") & "','" & Format(Time, "hhmmss") & "','S','SUP','1')"
                vgConexionBD.Execute (Sql)
            End If
            
            
            rsRepacto.MoveNext
        Loop
        
        
    End If
End If
    
Exit Sub
mierror:
    MsgBox "No se llego a crear el certificado", vbInformation, "Endoso"
    
End Sub
    Private Sub SP_INS_CERTIFICADO_ACTIVACION(ByVal pnum_poliza As String, _
                                              ByVal pnum_orden As Integer, _
                                              ByVal PENDFECEFECTO As String, _
                                              ByVal PCODUSUARIO As String)
                                              
       ' Dim rs      As ADODB.Recordset, cmd As ADODB.Command
                Dim conn    As ADODB.Connection
                Set conn = New ADODB.Connection
                Set RS = New ADODB.Recordset ' CreateObject("ADODB.Recordset")
                Set objCmd = New ADODB.Command ' CreateObject("ADODB.Command")
                
                conn.Provider = "OraOLEDB.Oracle"
                conn.ConnectionString = "PLSQLRSet=1;Data Source=" & vgNombreBaseDatos & ";" & "User ID=" & vgNombreUsuario & ";Password=" & vgPassWord & ";"
                conn.CursorLocation = adUseClient
                conn.Open
                
                Set objCmd = CreateObject("ADODB.Command")
                Set objCmd.ActiveConnection = conn
                
                objCmd.CommandText = "SP_INS_CERTIFICADO_ACTIVACION"
                objCmd.CommandType = adCmdStoredProc
                
                Set param1 = objCmd.CreateParameter("PNUM_POLIZA", adVarChar, adParamInput, 10, Trim(pnum_poliza))
                objCmd.Parameters.Append param1
                
                Set param2 = objCmd.CreateParameter("PNUM_ORDEN", adDouble, adParamInput)
                param2.Value = pnum_orden
                objCmd.Parameters.Append param2
                
                Set param3 = objCmd.CreateParameter("PENDFECEFECTO", adVarChar, adParamInput, 8, PENDFECEFECTO)
                objCmd.Parameters.Append param3
                
                 Set param4 = objCmd.CreateParameter("PCODUSUARIO", adVarChar, adParamInput, 10, PCODUSUARIO)
                objCmd.Parameters.Append param4
                
                Set RS = objCmd.Execute
                
                conn.Close
                
                
                Set conn = Nothing
                Set RS = Nothing
                Set objCmd = Nothing
    End Sub
    

Function flActualizarEndoso()
'*On Error GoTo Err_flActualizarEndoso

    vgSql = ""
    vgSql = " UPDATE PP_TMAE_ENDOSO SET "
    vgSql = vgSql & " fec_solendoso = '" & vlFecSolEndoso & "' , "
    vgSql = vgSql & " fec_endoso    = '" & vlFecEndoso & "' , "
    vgSql = vgSql & " cod_cauendoso = '" & vlCodCauEndoso & "' , "
    vgSql = vgSql & " cod_tipendoso = '" & vlCodTipEndoso & "' , "
    vgSql = vgSql & " mto_diferencia = " & str(vlMtoDiferencia) & " , "
    vgSql = vgSql & " mto_pensionori = " & str(vlMtoPensionOri) & " , "
    vgSql = vgSql & " mto_pensioncal = " & str(vlMtoPensionCal) & " , "
    vgSql = vgSql & " prc_factor     = " & str(vlPrcFactor) & " , "
    'I--- ABV 25/04/2005 ---
    If (vlObsEndoso <> "") Then
        vgSql = vgSql & " gls_observacion = '" & vlObsEndoso & "' , "
    Else
        vgSql = vgSql & " gls_observacion = NULL , "
    End If
    
    
    'F--- ABV 25/04/2005 ---
    vgSql = vgSql & " cod_usuariomodi = '" & vlGlsUsuarioModi & "' , "
    vgSql = vgSql & " fec_modi = '" & vlFecModi & "' , "
    vgSql = vgSql & " hor_modi = '" & vlHorModi & "' "
    vgSql = vgSql & " WHERE "
    vgSql = vgSql & " num_poliza = '" & Trim(Txt_PenPoliza.Text) & "' AND "
    vgSql = vgSql & " num_endoso = " & Trim(Lbl_End) & " "
    
    vgConectarBD.Execute vgSql


Exit Function
Err_flActualizarEndoso:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flCalculaNumNuevoEndoso()
On Error GoTo Err_flCalculaNumNuevoEndoso

    flCalculaNumNuevoEndoso = ""

    vgSql = ""
    vgSql = "SELECT MAX (num_endoso) as numero FROM PP_TMAE_POLIZA "
    vgSql = vgSql & "WHERE num_poliza = '" & Trim(Txt_PenPoliza.Text) & "' "
    Set vgRegistro = vgConexionBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        flCalculaNumNuevoEndoso = (vgRegistro!numero) + 1
    Else
        flCalculaNumNuevoEndoso = 1
    End If
    
Exit Function
Err_flCalculaNumNuevoEndoso:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flValidarEndoso()
On Error GoTo Err_flValidarEndoso

    'Validar Fecha de Solicitud de Endoso
    If (Trim(Txt_EndFecEnd) = "") Then
       MsgBox "Debe ingresar una Fecha de Solicitud del Endoso", vbCritical, "Error de Datos"
       Txt_EndFecEnd.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    If Not IsDate(Txt_EndFecEnd.Text) Then
       MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
       Txt_EndFecEnd.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    If (CDate(Txt_EndFecEnd) > CDate(Date)) Then
       MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
       Txt_EndFecEnd.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    If (Year(Txt_EndFecEnd) < 1900) Then
       MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
       Txt_EndFecEnd.SetFocus
       vlSwValidaOK = False
       Exit Function
    End If
    
    Txt_EndFecEnd.Text = Format(CDate(Trim(Txt_EndFecEnd)), "yyyymmdd")
    Txt_EndFecEnd.Text = DateSerial(Mid((Txt_EndFecEnd.Text), 1, 4), Mid((Txt_EndFecEnd.Text), 5, 2), Mid((Txt_EndFecEnd.Text), 7, 2))
    
    'CMV-20051021 I
    Txt_EndFecEfecto = ""
    Txt_EndFecEfecto = flCalculaFechaEfecto(Txt_EndFecEfecto)
'    Txt_EndFecEfecto = fgValidaFechaEfecto(Trim(Txt_EndFecEnd), vlNumPoliza, vlNumOrden)
    'CMV-20051021 F
    
    vlSwValidaOK = True

Exit Function
Err_flValidarEndoso:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flValidacionPreviaBen()
On Error GoTo Err_flValidacionPreviaBen

    'Validar Código de Identificación del Beneficiario
    If (Cmb_BMNumIdent.Text) = "" Then
        MsgBox "Debe seleccionar el Tipo de Identificación del Beneficiario.", vbCritical, "Error de Datos"
        Cmb_BMNumIdent.SetFocus
        vlSwCalIntOK = False
        Exit Function
    End If
    'Validar Número de Identificación del Beneficiario
    Txt_BMNumIden = Trim(UCase(Txt_BMNumIden))
    If Txt_BMNumIden.Text = "" Then
       MsgBox "Debe Ingresar el Número de Identificación del Beneficiario.", vbCritical, "Error de Datos"
       Txt_BMNumIden.SetFocus
       vlSwCalIntOK = False
       Exit Function
    End If
    
    'Valida Nombre del Beneficiario
    txtNomben.Text = Trim(UCase(txtNomben.Text))
    If txtNomben.Text = "" Then
       MsgBox "Debe Ingresar Nombre.", vbCritical, "Error de Datos"
       'frmDatosGen.Visible = True
       txtNomben.SetFocus
       vlSwCalIntOK = False
       Exit Function
    End If
    'Txt_BMNomSegBen.Text = Trim(UCase(Txt_BMNomSegBen.Text))
    'Valida Apellido Paterno del Beneficiario
    txtApepatBen.Text = Trim(UCase(txtApepatBen.Text))
    If txtApepatBen.Text = "" Then
       MsgBox "Debe Ingresar Apellido Paterno.", vbCritical, "Error de Datos"
       txtApepatBen.SetFocus
       vlSwCalIntOK = False
       Exit Function
    End If
    txtApematBen.Text = Trim(UCase(txtApematBen.Text))
    txtNomsegBen.Text = Trim(UCase(txtNomsegBen.Text))
    
    
'    'Valida Nombre del Beneficiario
'    Txt_BMNomBen.Text = Trim(UCase(Txt_BMNomBen.Text))
'    If Txt_BMNomBen.Text = "" Then
'       MsgBox "Debe Ingresar Nombre.", vbCritical, "Error de Datos"
'       Txt_BMNomBen.SetFocus
'       vlSwCalIntOK = False
'       frmDatosGen.Visible = True
'       Exit Function
'    End If
'    Txt_BMNomSegBen.Text = Trim(UCase(Txt_BMNomSegBen.Text))
'    'Valida Apellido Paterno del Beneficiario
'    Txt_BMPatBen.Text = Trim(UCase(Txt_BMPatBen.Text))
'    If Txt_BMPatBen.Text = "" Then
'       MsgBox "Debe Ingresar Apellido Paterno.", vbCritical, "Error de Datos"
'       Txt_BMPatBen.SetFocus
'       vlSwCalIntOK = False
'       Exit Function
'    End If
    'Valida Apellido Materno del Beneficiario
'    Txt_BMMatBen.Text = Trim(UCase(Txt_BMMatBen.Text))
'    If Txt_BMMatBen.Text = "" Then
'       MsgBox "Debe Ingresar Apellido Materno.", vbCritical, "Error de Datos"
'       Txt_BMMatBen.SetFocus
'       vlSwCalIntOK = False
'       Exit Function
'    End If
'''''    'Validar Datos de Invalidez
'''''
'''''    If (Trim(Txt_BMFecInv) <> "") Or (Cmb_BMCauInv.Text) Then
'''''    End If
    
    'Valida Fecha de Invalidez
    If (Trim(Txt_BMFecInv) <> "") Then
        If Not IsDate(Txt_BMFecInv.Text) Then
           MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
           Txt_BMFecInv.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        If (CDate(Txt_BMFecInv) > CDate(Date)) Then
           MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
           Txt_BMFecInv.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        If (Year(Txt_BMFecInv) < 1900) Then
           MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
           Txt_BMFecInv.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        Txt_BMFecInv.Text = Format(CDate(Trim(Txt_BMFecInv)), "yyyymmdd")
        Txt_BMFecInv.Text = DateSerial(Mid((Txt_BMFecInv.Text), 1, 4), Mid((Txt_BMFecInv.Text), 5, 2), Mid((Txt_BMFecInv.Text), 7, 2))
    End If
    'Valida Fecha de Nacimiento del Beneficiario
    If (Trim(Txt_BMFecNac) = "") Then
       MsgBox "Debe ingresar una Fecha de Nacimiento de Beneficiario", vbCritical, "Error de Datos"
       Txt_BMFecNac.SetFocus
       vlSwCalIntOK = False
       Exit Function
    End If
    If Not IsDate(Txt_BMFecNac.Text) Then
       MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
       Txt_BMFecNac.SetFocus
       vlSwCalIntOK = False
       Exit Function
    End If
    If (CDate(Txt_BMFecNac) > CDate(Date)) Then
       MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
       Txt_BMFecNac.SetFocus
       vlSwCalIntOK = False
       Exit Function
    End If
    If (Year(Txt_BMFecNac) < 1900) Then
       MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
       Txt_BMFecNac.SetFocus
       vlSwCalIntOK = False
       Exit Function
    End If
    Txt_BMFecNac.Text = Format(CDate(Trim(Txt_BMFecNac)), "yyyymmdd")
    Txt_BMFecNac.Text = DateSerial(Mid((Txt_BMFecNac.Text), 1, 4), Mid((Txt_BMFecNac.Text), 5, 2), Mid((Txt_BMFecNac.Text), 7, 2))
    'Valida Fecha de Fallecimiento del Beneficiario
    
    If (Trim(Txt_BMFecFall) <> "") Then
        If Not IsDate(Txt_BMFecFall.Text) Then
           MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
           Txt_BMFecFall.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        If (CDate(Txt_BMFecFall) > CDate(Date)) Then
           MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
           Txt_BMFecFall.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        If (Year(Txt_BMFecFall) < 1900) Then
           MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
           Txt_BMFecFall.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        Txt_BMFecFall.Text = Format(CDate(Trim(Txt_BMFecFall)), "yyyymmdd")
        Txt_BMFecFall.Text = DateSerial(Mid((Txt_BMFecFall.Text), 1, 4), Mid((Txt_BMFecFall.Text), 5, 2), Mid((Txt_BMFecFall.Text), 7, 2))
        
    Else
    'INI GCP 17092021 validacion de fecha de fallecimiento
        If Mid(Cmb_EndCauEnd.Text, 1, 2) = "07" Or Mid(Cmb_EndCauEnd.Text, 1, 2) = "09" Then
         MsgBox "Debe ingresar la fecha de fallecimiento.", vbCritical, "Error de Datos"
           Txt_BMFecFall.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
    'FIN GCP 17092021 validacion de fecha de fallecimiento

    End If
    
     
    'Valida Fecha de Matrimonio del Beneficiario
    If (Trim(Txt_BMFecMat) <> "") Then
        If (Trim(Txt_BMFecMat) = "") Then
           MsgBox "Debe ingresar una Fecha de Matrimonio de Beneficiario", vbCritical, "Error de Datos"
           Txt_BMFecMat.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        If Not IsDate(Txt_BMFecMat.Text) Then
           MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
           Txt_BMFecMat.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        If (CDate(Txt_BMFecMat) > CDate(Date)) Then
           MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
           Txt_BMFecMat.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        If (Year(Txt_BMFecMat) < 1900) Then
           MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
           Txt_BMFecMat.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        Txt_BMFecMat.Text = Format(CDate(Trim(Txt_BMFecMat)), "yyyymmdd")
        Txt_BMFecMat.Text = DateSerial(Mid((Txt_BMFecMat.Text), 1, 4), Mid((Txt_BMFecMat.Text), 5, 2), Mid((Txt_BMFecMat.Text), 7, 2))
    End If
    
    'I--- ABV 20/04/2005 ---
    'Validar la Existencia del Monto de la Pensión Garantizada
    Txt_BMMtoPensionGar = Trim(Txt_BMMtoPensionGar)
    If (Txt_BMMtoPensionGar.Enabled = True) Then
        If Not IsNumeric(Txt_BMMtoPensionGar) Then
            MsgBox "Debe ingresar el Monto de la Pensión Garantizada.", vbCritical, "Error de Datos"
            Txt_BMMtoPensionGar.SetFocus
            vlSwCalIntOK = False
            Exit Function
        End If
    Else
        If Not IsNumeric(Txt_BMMtoPensionGar) Then
            Txt_BMMtoPensionGar = Format(0, "#0.00")
        End If
    End If
    'F--- ABV 20/04/2005 ---
    
    
    'Validación Lógica de los Datos, referente a las Fechas Nac., Inv., Fall.
    'Pendiente
    
    'Valida Derecho a Pensión del Beneficiario
    vlNumero = InStr(Cmb_BMPar.Text, "-")
    vlCodPar = Trim(Mid(Cmb_BMPar.Text, 1, vlNumero - 1))
    vlNumero = InStr(Cmb_PMTipPen.Text, "-")
    vlCodTipPension = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
    vgX = InStr(1, clPensionInvVejez, Trim(vlCodTipPension))
    If (vgX = 0) Then
        'Cuando el Causante se encuentra Muerto
        'I--- ABV 13/06/2005 -- If (vlCodPar <> "99") Then
        If (vlCodPar = "99") Then
            vlNumero = InStr(Cmb_BMDerPen.Text, "-")
            vlCodEstPension = Trim(Mid(Cmb_BMDerPen.Text, 1, vlNumero - 1))
            If (vlCodEstPension <> "10") Then
                'I--- ABV 13/06/2005 -- MsgBox "El Beneficiario ingresado debe estar Sin Derecho a Pensión.", vbCritical, "Error de Datos"
                MsgBox "El Causante ingresado debe estar Sin Derecho a Pensión.", vbCritical, "Error de Datos"
                Cmb_BMDerPen.SetFocus
                vlSwCalIntOK = False
                Exit Function
            End If
        End If
    Else
        If (vlCodPar = "99") Then
        'Cuando el Causante se encuentra Vivo
            vlNumero = InStr(Cmb_BMDerPen.Text, "-")
            vlCodEstPension = Trim(Mid(Cmb_BMDerPen.Text, 1, vlNumero - 1))
            'I--- ABV 13/06/2005 -- If (vlCodEstPension <> "10") Then
            If (vlCodEstPension = "10") Then
                'I--- ABV 13/06/2005 -- MsgBox "El Causante de la Póliza debe estar Sin Derecho a Pensión.", vbCritical, "Error de Datos"
                MsgBox "El Causante de la Póliza debe estar Con Derecho a Pensión.", vbCritical, "Error de Datos"
                If Cmb_BMDerPen.Enabled Then
                         Cmb_BMDerPen.SetFocus
                End If
       
                vlSwCalIntOK = False
                Exit Function
            End If
        End If
    End If
    
    
    
'    'CMV-20051103 I
'    vlNumero = InStr(Cmb_BMSitInv.Text, "-")
'    vlValCodSitInv = Trim(Mid(Cmb_BMSitInv.Text, 1, vlNumero - 1))
'    If vlValCodSitInv <> Trim(clCodSitInvNoInv) Then
'        MsgBox "Debe Ingresar Causal de Invalidez para el Beneficiario o Modificar Situación.", vbCritical, "Error de Datos"
'        Cmd_CauInv.SetFocus
'        vlSwCalIntOK = False
'        Exit Function
'    End If
'
'    If Lbl_BMCauInv = "" Then
'        MsgBox "Debe Ingresar Causal de Invalidez para el Beneficiario.", vbCritical, "Error de Datos"
'        Cmd_CauInv.SetFocus
'        vlSwCalIntOK = False
'        Exit Function
'    End If
'    'CMV-20051103 F

    'CMV-20060410 I
'    vlNumero = InStr(Cmb_BMSitInv.Text, "-")
'    vlValCodSitInv = Trim(Mid(Cmb_BMSitInv.Text, 1, vlNumero - 1))
'    If vlValCodSitInv <> Trim(clCodSitInvNoInv) Then
'        If Lbl_BMCauInv = "" Then
'            MsgBox "Debe Ingresar Causal de Invalidez para el Beneficiario o Modificar Situación.", vbCritical, "Error de Datos"
'            Cmd_CauInv.SetFocus
'            vlSwCalIntOK = False
'            Exit Function
'        End If
'    End If
    'CMV-20060410 F
    
    'mvg 20170904
    If chkEnvioBolElec.Value = 1 And txtBenEmail.Text = "" Then
        MsgBox "Esta poniendo check de envío de boleta electronica pero no ingreso email de la persona.", vbExclamation, ""
        txtBenEmail.SetFocus
        vlSwCalIntOK = False
        Exit Function
    End If
    
    
     'INICIO GCP-FRACTAL [REQUERIMIENTO SD-5041] 21032019
    'Validamos si se ha ingresado nmro de cuenta y cci en el caso que sea deposito a cuenta
    
    If Mid(Cmb_EndCauEnd, 1, 2) = "28" Then
    
          If Left(Trim(Cmb_ViaPago.Text), 2) = "02" Then
    
             If Left(Trim(cmbTipoCtaBen.Text), 2) = "00" Then
                 MsgBox "No se encuentra definido el tipo de cuenta. ", vbCritical, "Error de Datos"
                 If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                    vlSwCalIntOK = False
                    Exit Function
             End If
             
             If Left(Trim(cmbBancoCtaBen.Text), 2) = "00" Then
                MsgBox "No se encuentra definido el banco. ", vbCritical, "Error de Datos"
                    If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                    vlSwCalIntOK = False
                    Exit Function
             End If
        
             If txtNumctaBen = "" Then
                    MsgBox "No se encuentra definido el Nro Cuenta ", vbCritical, "Error de Datos"
                    If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                        vlSwCalIntOK = False
                        Exit Function
             End If
        
           End If
           
           If Left(Trim(Cmb_ViaPago.Text), 2) = "07" Then
           
             If Left(Trim(cmbTipoCtaBen.Text), 2) = "00" Then
                 MsgBox "No se encuentra definido el tipo de cuenta. ", vbCritical, "Error de Datos"
                 If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                    vlSwCalIntOK = False
                    Exit Function
             End If
             
             If Left(Trim(cmbBancoCtaBen.Text), 2) = "00" Then
                MsgBox "No se encuentra definido el banco. ", vbCritical, "Error de Datos"
                    If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                    vlSwCalIntOK = False
                    Exit Function
             End If
           
            If txt_CCI = "" Then
                    MsgBox "No se encuentra definido el Nro CCI ", vbCritical, "Error de Datos"
                    If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                    vlSwCalIntOK = False
                    Exit Function
            End If
        End If
    
    End If
    

    'Ini GCP 17092021
       If Mid(Cmb_EndCauEnd, 1, 2) = "28" Then
       
          If Left(Trim(cmbBancoCtaBen.Text), 2) <> "02" And _
                Left(Trim(cmbBancoCtaBen.Text), 2) <> "03" And _
                Left(Trim(cmbBancoCtaBen.Text), 2) <> "11" And _
                Left(Trim(cmbBancoCtaBen.Text), 2) <> "41" Then
                
                   'BCP = 02
                   'INTERBANK = 03
                   'BBVA = 11
                   'SCOTIABANK = 41
                    
                    If txt_CCI = "" Then
                               MsgBox "Debe indicar el CCI para los bancos no principales.", vbCritical, "Error de Datos"
                               If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                               vlSwCalIntOK = False
                               txt_CCI.SetFocus
                               Exit Function
                       End If
          End If
       
     End If
       
    
  
     'Fin GCP 17092021
    
  
   
  'FIN GCP-FRACTAL [REQUERIMIENTO SD-5041] 21032019

    
   'MAYOR DE EDAD EXCLUSIONES
   
   
   
   If Mid(Cmb_EndCauEnd, 1, 2) = "26" Then
        If vlCodPar = "30" Then
            vlEsEdadLeg = flObtieneEdadNormativa(vgNum_pol)
            vbEsEdadLeg = False
            If vlEsEdadLeg > 216 Then
                vbEsEdadLeg = True
            End If
    
            sfechaE = Format(CDate(Txt_EndFecEfecto), "YYYYMMDD")
            sfechaN = Format(CDate(Txt_BMFecNac), "YYYYMMDD")
            
            fecha_sin = CInt(Mid(sfechaE, 1, 4)) * 12 + CInt(Mid(sfechaE, 5, 2))
            fecha_eda = CInt(Mid(sfechaN, 1, 4)) * 12 + CInt(Mid(sfechaN, 5, 2))
            edad_mes_ben = fecha_sin - fecha_eda
            
            If edad_mes_ben <= 216 Then
                MsgBox "No se puede excluir a un hijo menor de edad. ", vbCritical, "Error de Datos"
                If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                vlSwCalIntOK = False
                Exit Function
            Else
                If vbEsEdadLeg = True Then
                    If flCompletaRequisitos(vgNum_pol, CInt(i)) = True Then
                        MsgBox "No se puede excluir a un hijo que aun esta estudiando. ", vbCritical, "Error de Datos"
                        If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                        vlSwCalIntOK = False
                        Exit Function
                    End If
                End If
            End If
        Else
            MsgBox "Endoso es exclusivo solo para Hijos. ", vbCritical, "Error de Datos"
                        If Screen.MousePointer <> 0 Then Screen.MousePointer = 0
                        vlSwCalIntOK = False
                        Exit Function
        End If
   End If
    
    vlSwCalIntOK = True
    
Exit Function
Err_flValidacionPreviaBen:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flValidacionDefinitivaBen()
On Error GoTo Err_flValidacionDefinitivaBen

Exit Function
Err_flValidacionDefinitivaBen:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flObtenerDerPen(iTipoPen, iEstDerPen, iFecFall As String) As String
'Obtiene y retorna código de derecho a pension (cod_derpen)
On Error GoTo Err_flObtenerDerPen

    flObtenerDerPen = ""
    
   If InStr(1, clTipPenSob, iTipoPen) <> 0 Then
      flObtenerDerPen = iEstDerPen
   Else
       If iFecFall = "" Then
          flObtenerDerPen = clCodSinDerPen
       Else
           flObtenerDerPen = clCodConDerPen
       End If
   End If
   
Exit Function
Err_flObtenerDerPen:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flDeshabilitarBenMod()

    Cmb_BMNumIdent.Enabled = False
    Txt_BMNumIden.Enabled = False
    Txt_BMNomBen.Enabled = False
    Txt_BMNomSegBen.Enabled = False
    Txt_BMPatBen.Enabled = False
    Txt_BMMatBen.Enabled = False
    Cmb_BMDerPen.Enabled = False
    Cmb_BMSexo.Enabled = False
    Cmb_BMSitInv.Enabled = False
    Txt_BMFecInv.Enabled = False
    'Cmb_BMCauInv.Enabled = False
    Lbl_BMCauInv.Enabled = False
    Cmd_CauInv.Enabled = False
    Cmb_BMPar.Enabled = False
    Cmb_BMGrupFam.Enabled = False
    Txt_BMFecNac.Enabled = False
    Txt_BMFecFall.Enabled = False
    Txt_BMFecMat.Enabled = False
    Txt_BMMtoPensionGar.Enabled = False
    
End Function

Function flHabilitarBenMod()

    Cmb_BMNumIdent.Enabled = True
    Txt_BMNumIden.Enabled = True
    Txt_BMNomBen.Enabled = True
    Txt_BMNomSegBen.Enabled = True
    Txt_BMPatBen.Enabled = True
    Txt_BMMatBen.Enabled = True
    Cmb_BMDerPen.Enabled = True
    Cmb_BMSexo.Enabled = True
    Cmb_BMSitInv.Enabled = True
    Txt_BMFecInv.Enabled = True
    'Cmb_BMCauInv.Enabled = True
    Lbl_BMCauInv.Enabled = True
    Cmd_CauInv.Enabled = True
    Cmb_BMPar.Enabled = True
    Cmb_BMGrupFam.Enabled = True
    Txt_BMFecNac.Enabled = True
    Txt_BMFecFall.Enabled = True
    Txt_BMFecMat.Enabled = True
    Txt_BMMtoPensionGar.Enabled = True

End Function

Function flDeshabilitarPolMod()

    Cmb_PMTipPen.Enabled = False
    Cmb_PMEstVig.Enabled = False
    Txt_PMIniVig.Enabled = False
    Txt_PMTerVig.Enabled = False
    Cmb_PMTipRta.Enabled = False
    Txt_PMMesDif.Enabled = False
    Txt_PMMesGar.Enabled = False
    Txt_PMMtoPrima.Enabled = False
    Txt_PMTasaCto.Enabled = False
    Txt_PMTasaVta.Enabled = False
    Txt_PMTasaPerGar.Enabled = False
    
End Function

Function flHabilitarPolMod()

    'Cmb_PMTipPen.Enabled = True
    Cmb_PMEstVig.Enabled = True
    Txt_PMIniVig.Enabled = True
    Txt_PMTerVig.Enabled = True
    Cmb_PMTipRta.Enabled = True
    Txt_PMMesDif.Enabled = True
    Txt_PMMesGar.Enabled = True
    Txt_PMMtoPrima.Enabled = True
    Txt_PMTasaCto.Enabled = True
    Txt_PMTasaVta.Enabled = True
    Txt_PMTasaPerGar.Enabled = True
    
    'Habilitar o Deshabilitar Tipo de Renta
    If Len(Cmb_PMTipRta) <> 0 Then
        If (Trim(Mid(Cmb_PMTipRta, 1, (InStr(1, Cmb_PMTipRta, "-") - 1))) = "1") Then
            'Txt_PMMesDif = 0
            Txt_PMMesDif.Enabled = False
        Else
            'Txt_PMMesDif = ""
            Txt_PMMesDif.Enabled = True
        End If
    End If
    
    'Habilitar o Deshabilitar Tipo de Modalidad
    If Len(Trim(Cmb_PMMod)) = 0 Then
        If (Trim(Mid(Cmb_PMMod, 1, (InStr(1, Cmb_PMMod, "-") - 1))) = "1") Then
            'Txt_PMMesGar = 0
            Txt_PMMesGar.Enabled = False
        Else
            'Txt_PMMesGar = ""
            Txt_PMMesGar.Enabled = True
        End If
    End If
    
    Cmb_PMTipPen.Enabled = False
    
End Function

Function flCalculaFecTerPagoPenGar(iFecha As String, iNumMG As Integer) As String
On Error GoTo Err_flCalculaFecTerPagoPenGar
    'ifecha = Fecha Inicio de Pago de Pensión Beneficiario
    'inummg = Número de Meses Garantizados
    
    flCalculaFecTerPagoPenGar = ""
    
    vlAnno = Mid(Trim(iFecha), 1, 4)
    vlMes = Mid(Trim(iFecha), 5, 2)
    vlDia = Mid(Trim(iFecha), 7, 2)
    
    If (iNumMG > 0) Then
        flCalculaFecTerPagoPenGar = DateSerial(vlAnno, vlMes + (iNumMG), vlDia - 1)
        flCalculaFecTerPagoPenGar = Format(CDate(vlFecTerPagoPenGar), "yyyymmdd")
    Else
        flCalculaFecTerPagoPenGar = ""
    End If

Exit Function
Err_flCalculaFecTerPagoPenGar:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flImprimirPoliza()
On Error GoTo Err_flImprimirPoliza

'Imprimir Reporte de Poliza Original
   Screen.MousePointer = 11

   vlArchivo = strRpt & "PP_Rpt_EndPoliza.rpt"   '\Reportes
   If Not fgExiste(vlArchivo) Then     ', vbNormal
      MsgBox "Archivo de Reporte de Endoso Póliza de Renta Vitalicia no se encuentra en el directorio de la aplicación", 16, "Archivo no encontrado"
      Screen.MousePointer = 0
      Exit Function
   End If
   
   vlRptCodTipPension = ""
   'vlRptNumEndoso = 0
   vlRptCodAfp = ""
   vlRptCodTipRen = ""
   
   vgSql = ""
   vgSql = "SELECT num_endoso,cod_afp,cod_tipren,cod_tippension "
   vgSql = vgSql & ",cod_moneda,mto_valmoneda "
   vgSql = vgSql & "FROM PP_TMAE_POLIZA "
   vgSql = vgSql & "WHERE "
   vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
   vgSql = vgSql & "num_endoso = " & vlRptNumEndosoPol & " "
   'vgSql = vgSql & "ORDER BY num_endoso DESC "
   Set vgRegistro = vgConexionBD.Execute(vgSql)
   If Not vgRegistro.EOF Then
      'vlRptNumEndoso = (vgRegistro!num_endoso)
      vlRptCodAfp = Trim(vgRegistro!cod_afp) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_AFP, Trim(vgRegistro!cod_afp)))
      vlRptCodTipRen = Trim(vgRegistro!Cod_TipRen) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_TipRen, Trim(vgRegistro!Cod_TipRen)))
      vlRptCodTipPension = Trim(vgRegistro!Cod_TipPension) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_TipPen, Trim(vgRegistro!Cod_TipPension)))
      vlImpCodMoneda = vgRegistro!Cod_Moneda
      vlImpNomMoneda = fgBuscarGlosaElemento(vgCodTabla_TipMon, vlImpCodMoneda)
   End If
   vgRegistro.Close
   
   vlRptCodInsSalud = ""
   vlRptNomBen = ""
   vlRptRutBen = ""
   vlRptGlsDirBen = ""
   vlRptFonoBen = ""
   vlRptCodDireccion = "0"
   
   vgSql = ""
   vgSql = "SELECT cod_inssalud,gls_nomben,gls_nomsegben,gls_patben,gls_matben,Cod_TipoIdenben, "
   vgSql = vgSql & "Num_Idenben,cod_direccion,gls_dirben,gls_fonoben "
   vgSql = vgSql & "FROM PP_TMAE_BEN "
   vgSql = vgSql & "WHERE "
   vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
   vgSql = vgSql & "num_endoso = " & (vlRptNumEndosoPol) & " AND "
   vgSql = vgSql & "cod_par = '" & Trim(clCodParCau) & "' "
   Set vgRegistro = vgConexionBD.Execute(vgSql)
   If Not vgRegistro.EOF Then
        If Not IsNull(vgRegistro!Cod_InsSalud) Then
            vlRptCodInsSalud = " " & Trim(vgRegistro!Cod_InsSalud) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_InsSal, Trim(vgRegistro!Cod_InsSalud)))
        End If
        If Not IsNull(vgRegistro!Gls_NomBen) And Not IsNull(vgRegistro!Gls_PatBen) Then
            vlNombre = vgRegistro!Gls_NomBen
            vlNombreSeg = IIf(IsNull(vgRegistro!Gls_NomSegBen), "", vgRegistro!Gls_NomSegBen)
            vlPaterno = vgRegistro!Gls_PatBen
            'I - MC 24/01/2008
            ''vlMaterno = IIf(IsNull(vgRegistro!Gls_PatBen), "", vgRegistro!Gls_PatBen)
            vlMaterno = IIf(IsNull(vgRegistro!Gls_MatBen), "", vgRegistro!Gls_MatBen)
            'F - MC 24/01/2008
            vlNombreCompleto = fgFormarNombreCompleto(vlNombre, vlNombreSeg, vlPaterno, vlMaterno)
            
            vlRptNomBen = vlNombreCompleto
        End If
        If Not IsNull(vgRegistro!Cod_TipoIdenBen) And Not IsNull(vgRegistro!Num_IdenBen) Then
            vlNombreTipoIden = fgBuscarNombreTipoIden(vgRegistro!Cod_TipoIdenBen)
            vlRptRutBen = vlNombreTipoIden & " - " & (Trim(vgRegistro!Num_IdenBen))
        End If
        If Not IsNull(vgRegistro!Gls_DirBen) Then
            vlRptGlsDirBen = Trim(vgRegistro!Gls_DirBen)
        End If
        If Not IsNull(vgRegistro!Gls_FonoBen) Then
            vlRptFonoBen = Trim(vgRegistro!Gls_FonoBen)
        Else
            vlRptFonoBen = " "
        End If
        If Not IsNull(vgRegistro!Cod_Direccion) Then
            vlRptCodDireccion = Trim(vgRegistro!Cod_Direccion)
        End If
   End If
   vgRegistro.Close

   vlRptComuna = ""
   vlRptProvincia = ""
   vlRptRegion = ""
   
    vgSql = ""
    vgSql = "SELECT c.gls_comuna,p.gls_provincia,r.gls_region "
    vgSql = vgSql & "FROM MA_TPAR_COMUNA c,MA_TPAR_PROVINCIA p,MA_TPAR_REGION r "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "c.cod_direccion = '" & vlRptCodDireccion & "' AND "
    vgSql = vgSql & "c.cod_provincia = p.cod_provincia AND "
    vgSql = vgSql & "p.cod_region = r.cod_region AND "
    vgSql = vgSql & "c.cod_region = r.cod_region "
    Set vgRegistro = vgConexionBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        If Not IsNull(vgRegistro!gls_comuna) Then vlRptComuna = Trim(vgRegistro!gls_comuna)
        If Not IsNull(vgRegistro!gls_provincia) Then vlRptProvincia = Trim(vgRegistro!gls_provincia)
        If Not IsNull(vgRegistro!gls_region) Then vlRptRegion = Trim(vgRegistro!gls_region)
    End If
    vgRegistro.Close
    
    vlRptNomInter = "-"
    vlRptRutInter = "-"
    vlRptComInter = "-"
      
    vgQuery = ""
    vgQuery = vgQuery & "{PP_TMAE_POLIZA.num_poliza} = '" & vlGlobalNumPoliza & "' AND "
    vgQuery = vgQuery & "{PP_TMAE_POLIZA.num_endoso} = " & (vlRptNumEndosoPol) & " "
           
   Rpt_Reporte.Reset
   Rpt_Reporte.WindowState = crptMaximized
   Rpt_Reporte.ReportFileName = vlArchivo     'App.Path & "\Rpt_Areas.rpt"
   Rpt_Reporte.Connect = vgRutaDataBase       ' o App.Path & "\Nestle.mdb"
   Rpt_Reporte.SelectionFormula = vgQuery

   Rpt_Reporte.Formulas(0) = ""
   Rpt_Reporte.Formulas(1) = ""
   Rpt_Reporte.Formulas(2) = ""
   Rpt_Reporte.Formulas(3) = ""
   Rpt_Reporte.Formulas(4) = ""
   Rpt_Reporte.Formulas(5) = ""
   Rpt_Reporte.Formulas(6) = ""
   Rpt_Reporte.Formulas(7) = ""
   Rpt_Reporte.Formulas(8) = ""
   Rpt_Reporte.Formulas(9) = ""
   Rpt_Reporte.Formulas(10) = ""
   Rpt_Reporte.Formulas(11) = ""
   Rpt_Reporte.Formulas(12) = ""
   Rpt_Reporte.Formulas(13) = ""
   Rpt_Reporte.Formulas(14) = ""
   Rpt_Reporte.Formulas(15) = ""
   Rpt_Reporte.Formulas(16) = ""
   Rpt_Reporte.Formulas(17) = ""
   Rpt_Reporte.Formulas(18) = ""
   Rpt_Reporte.Formulas(19) = ""
   Rpt_Reporte.Formulas(20) = ""
   Rpt_Reporte.Formulas(21) = ""
   Rpt_Reporte.Formulas(22) = ""
   Rpt_Reporte.Formulas(23) = ""
         
   Rpt_Reporte.Formulas(0) = "NombreCompania = '" & vgNombreCompania & "'"
   Rpt_Reporte.Formulas(1) = "NombreSistema= '" & vgNombreSistema & "'"
   Rpt_Reporte.Formulas(2) = "NombreSubSistema= '" & vgNombreSubSistema & "'"
   Rpt_Reporte.Formulas(3) = "TipPension = '" & vlRptCodTipPension & "'"
   Rpt_Reporte.Formulas(4) = "Afp = '" & vlRptCodAfp & "'"
   Rpt_Reporte.Formulas(5) = "TipRta = '" & vlRptCodTipRen & "'"
   Rpt_Reporte.Formulas(6) = "InstSalud = '" & vlRptCodInsSalud & "'"
   Rpt_Reporte.Formulas(7) = "NombreCausante = '" & vlRptNomBen & "'"
   Rpt_Reporte.Formulas(8) = "RutCausante = '" & vlRptRutBen & "'"
   Rpt_Reporte.Formulas(9) = "Direccion = '" & vlRptGlsDirBen & "'"
   Rpt_Reporte.Formulas(10) = "Fono = '" & vlRptFonoBen & "'"
   Rpt_Reporte.Formulas(11) = "Comuna = '" & vlRptComuna & "'"
   Rpt_Reporte.Formulas(12) = "Provincia = '" & vlRptProvincia & "'"
   Rpt_Reporte.Formulas(13) = "Region = '" & vlRptRegion & "'"
   Rpt_Reporte.Formulas(14) = "NombreInter = '" & vlRptNomInter & "'"
   Rpt_Reporte.Formulas(15) = "RutInter = '" & vlRptRutInter & "'"
   Rpt_Reporte.Formulas(16) = "ComisionInter = '" & vlRptComInter & "'"
   Rpt_Reporte.Formulas(17) = "Origen = '" & clRptOrigen & "'"
   Rpt_Reporte.Formulas(18) = "CodMoneda = '" & vlImpNomMoneda & "'"
   Rpt_Reporte.Formulas(19) = "CodMonedaCor = '" & vlImpCodMoneda & "'"
   Rpt_Reporte.Formulas(20) = "MtoPension = " & str(Lbl_EndMtoPensionOrig) & " "

   Rpt_Reporte.SubreportToChange = ""
   Rpt_Reporte.Destination = crptToWindow
   Rpt_Reporte.WindowState = crptMaximized
   Rpt_Reporte.WindowTitle = "Póliza de Endoso Original"
   'Rpt_Reporte.SelectionFormula = ""
   Rpt_Reporte.Action = 1
   Screen.MousePointer = 0

Exit Function
Err_flImprimirPoliza:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
    
End Function

Function flImprimirPolizaDef()
On Error GoTo Err_flImprimirPoliza

'Imprimir Reporte de Poliza Original
   Screen.MousePointer = 11

   vlArchivo = strRpt & "PP_Rpt_EndDefPoliza.rpt"   '\Reportes
   If Not fgExiste(vlArchivo) Then     ', vbNormal
      MsgBox "Archivo de Reporte de Endoso Póliza de Renta Vitalicia no se encuentra en el directorio de la aplicación", 16, "Archivo no encontrado"
      Screen.MousePointer = 0
      Exit Function
   End If
   
   vlRptCodTipPension = ""
   'vlRptNumEndoso = 0
   vlRptCodAfp = ""
   vlRptCodTipRen = ""
   
   vgSql = ""
   vgSql = "SELECT num_endoso,cod_afp,cod_tipren,cod_tippension "
   vgSql = vgSql & ",cod_moneda,mto_valmoneda "
   vgSql = vgSql & "FROM PP_TMAE_POLIZA "
   vgSql = vgSql & "WHERE "
   vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
   vgSql = vgSql & "num_endoso = " & vlRptNumEndosoPol & " "
   'vgSql = vgSql & "ORDER BY num_endoso DESC "
   Set vgRegistro = vgConexionBD.Execute(vgSql)
   If Not vgRegistro.EOF Then
      'vlRptNumEndoso = (vgRegistro!num_endoso)
      vlRptCodAfp = Trim(vgRegistro!cod_afp) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_AFP, Trim(vgRegistro!cod_afp)))
      vlRptCodTipRen = Trim(vgRegistro!Cod_TipRen) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_TipRen, Trim(vgRegistro!Cod_TipRen)))
      vlRptCodTipPension = Trim(vgRegistro!Cod_TipPension) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_TipPen, Trim(vgRegistro!Cod_TipPension)))
      vlImpCodMoneda = vgRegistro!Cod_Moneda
      vlImpNomMoneda = fgBuscarGlosaElemento(vgCodTabla_TipMon, vlImpCodMoneda)
   End If
   vgRegistro.Close
   
   vlRptCodInsSalud = ""
   vlRptNomBen = ""
   vlRptRutBen = ""
   vlRptGlsDirBen = ""
   vlRptFonoBen = ""
   vlRptCodDireccion = "0"
   
   vgSql = ""
   vgSql = "SELECT cod_inssalud,gls_nomben,gls_nomsegben,gls_patben,gls_matben,Cod_TipoIdenben, "
   vgSql = vgSql & "Num_Idenben,cod_direccion,gls_dirben,gls_fonoben "
   vgSql = vgSql & "FROM PP_TMAE_BEN "
   vgSql = vgSql & "WHERE "
   vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
   vgSql = vgSql & "num_endoso = " & (vlRptNumEndosoPol) & " AND "
   vgSql = vgSql & "cod_par = '" & Trim(clCodParCau) & "' "
   Set vgRegistro = vgConexionBD.Execute(vgSql)
   If Not vgRegistro.EOF Then
        If Not IsNull(vgRegistro!Cod_InsSalud) Then
            vlRptCodInsSalud = " " & Trim(vgRegistro!Cod_InsSalud) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_InsSal, Trim(vgRegistro!Cod_InsSalud)))
        End If
        If Not IsNull(vgRegistro!Gls_NomBen) And Not IsNull(vgRegistro!Gls_PatBen) Then
            vlNombre = vgRegistro!Gls_NomBen
            vlNombreSeg = IIf(IsNull(vgRegistro!Gls_NomSegBen), "", vgRegistro!Gls_NomSegBen)
            vlPaterno = vgRegistro!Gls_PatBen
            'I - MC 24/01/2008
            ''vlMaterno = IIf(IsNull(vgRegistro!gls_patben), "", vgRegistro!gls_patben)
            vlMaterno = IIf(IsNull(vgRegistro!Gls_MatBen), "", vgRegistro!Gls_MatBen)
            'I - MC 24/01/2008
            vlNombreCompleto = fgFormarNombreCompleto(vlNombre, vlNombreSeg, vlPaterno, vlMaterno)
            
            vlRptNomBen = vlNombreCompleto
        End If
        If Not IsNull(vgRegistro!Cod_TipoIdenBen) And Not IsNull(vgRegistro!Num_IdenBen) Then
            vlNombreTipoIden = fgBuscarNombreTipoIden(vgRegistro!Cod_TipoIdenBen)
            vlRptRutBen = vlNombreTipoIden & " - " & (Trim(vgRegistro!Num_IdenBen))
        End If
        If Not IsNull(vgRegistro!Gls_DirBen) Then
            vlRptGlsDirBen = Trim(vgRegistro!Gls_DirBen)
        End If
        If Not IsNull(vgRegistro!Gls_FonoBen) Then
            vlRptFonoBen = Trim(vgRegistro!Gls_FonoBen)
        Else
            vlRptFonoBen = " "
        End If
        If Not IsNull(vgRegistro!Cod_Direccion) Then
            vlRptCodDireccion = Trim(vgRegistro!Cod_Direccion)
        End If
   End If
   vgRegistro.Close

   vlRptComuna = ""
   vlRptProvincia = ""
   vlRptRegion = ""
   
    vgSql = ""
    vgSql = "SELECT c.gls_comuna,p.gls_provincia,r.gls_region "
    vgSql = vgSql & "FROM MA_TPAR_COMUNA c,MA_TPAR_PROVINCIA p,MA_TPAR_REGION r "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "c.cod_direccion = '" & vlRptCodDireccion & "' AND "
    vgSql = vgSql & "c.cod_provincia = p.cod_provincia AND "
    vgSql = vgSql & "p.cod_region = r.cod_region AND "
    vgSql = vgSql & "c.cod_region = r.cod_region "
    Set vgRegistro = vgConexionBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        If Not IsNull(vgRegistro!gls_comuna) Then vlRptComuna = Trim(vgRegistro!gls_comuna)
        If Not IsNull(vgRegistro!gls_provincia) Then vlRptProvincia = Trim(vgRegistro!gls_provincia)
        If Not IsNull(vgRegistro!gls_region) Then vlRptRegion = Trim(vgRegistro!gls_region)
    End If
    vgRegistro.Close
    
    vlRptNomInter = "-"
    vlRptRutInter = "-"
    vlRptComInter = "-"
      
    vgQuery = ""
    vgQuery = vgQuery & "{PP_TMAE_POLIZA.num_poliza} = '" & vlGlobalNumPoliza & "' AND "
    vgQuery = vgQuery & "{PP_TMAE_POLIZA.num_endoso} = " & (vlRptNumEndosoPol) & " "
           
   Rpt_Reporte.Reset
   Rpt_Reporte.WindowState = crptMaximized
   Rpt_Reporte.ReportFileName = vlArchivo     'App.Path & "\Rpt_Areas.rpt"
   Rpt_Reporte.Connect = vgRutaDataBase       ' o App.Path & "\Nestle.mdb"
   Rpt_Reporte.SelectionFormula = vgQuery

   Rpt_Reporte.Formulas(0) = ""
   Rpt_Reporte.Formulas(1) = ""
   Rpt_Reporte.Formulas(2) = ""
   Rpt_Reporte.Formulas(3) = ""
   Rpt_Reporte.Formulas(4) = ""
   Rpt_Reporte.Formulas(5) = ""
   Rpt_Reporte.Formulas(6) = ""
   Rpt_Reporte.Formulas(7) = ""
   Rpt_Reporte.Formulas(8) = ""
   Rpt_Reporte.Formulas(9) = ""
   Rpt_Reporte.Formulas(10) = ""
   Rpt_Reporte.Formulas(11) = ""
   Rpt_Reporte.Formulas(12) = ""
   Rpt_Reporte.Formulas(13) = ""
   Rpt_Reporte.Formulas(14) = ""
   Rpt_Reporte.Formulas(15) = ""
   Rpt_Reporte.Formulas(16) = ""
   Rpt_Reporte.Formulas(17) = ""
   Rpt_Reporte.Formulas(18) = ""
   Rpt_Reporte.Formulas(19) = ""
   Rpt_Reporte.Formulas(20) = ""
   Rpt_Reporte.Formulas(21) = ""
   Rpt_Reporte.Formulas(22) = ""
   Rpt_Reporte.Formulas(23) = ""
         
   Rpt_Reporte.Formulas(0) = "NombreCompania = '" & vgNombreCompania & "'"
   Rpt_Reporte.Formulas(1) = "NombreSistema= '" & vgNombreSistema & "'"
   Rpt_Reporte.Formulas(2) = "NombreSubSistema= '" & vgNombreSubSistema & "'"
   Rpt_Reporte.Formulas(3) = "TipPension = '" & vlRptCodTipPension & "'"
   Rpt_Reporte.Formulas(4) = "Afp = '" & vlRptCodAfp & "'"
   Rpt_Reporte.Formulas(5) = "TipRta = '" & vlRptCodTipRen & "'"
   Rpt_Reporte.Formulas(6) = "InstSalud = '" & vlRptCodInsSalud & "'"
   Rpt_Reporte.Formulas(7) = "NombreCausante = '" & vlRptNomBen & "'"
   Rpt_Reporte.Formulas(8) = "RutCausante = '" & vlRptRutBen & "'"
   Rpt_Reporte.Formulas(9) = "Direccion = '" & vlRptGlsDirBen & "'"
   Rpt_Reporte.Formulas(10) = "Fono = '" & vlRptFonoBen & "'"
   Rpt_Reporte.Formulas(11) = "Comuna = '" & vlRptComuna & "'"
   Rpt_Reporte.Formulas(12) = "Provincia = '" & vlRptProvincia & "'"
   Rpt_Reporte.Formulas(13) = "Region = '" & vlRptRegion & "'"
   Rpt_Reporte.Formulas(14) = "NombreInter = '" & vlRptNomInter & "'"
   Rpt_Reporte.Formulas(15) = "RutInter = '" & vlRptRutInter & "'"
   Rpt_Reporte.Formulas(16) = "ComisionInter = '" & vlRptComInter & "'"
   Rpt_Reporte.Formulas(17) = "Origen = '" & clRptOrigen & "'"
   Rpt_Reporte.Formulas(18) = "CodMoneda = '" & vlImpNomMoneda & "'"
   Rpt_Reporte.Formulas(19) = "CodMonedaCor = '" & vlImpCodMoneda & "'"

   Rpt_Reporte.SubreportToChange = ""
   Rpt_Reporte.Destination = crptToWindow
   Rpt_Reporte.WindowState = crptMaximized
   Rpt_Reporte.WindowTitle = "Póliza de Endoso Original"
   'Rpt_Reporte.SelectionFormula = ""
   Rpt_Reporte.Action = 1
   Screen.MousePointer = 0

Exit Function
Err_flImprimirPoliza:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
    
End Function

Function flImprimirEndosoDef()
On Error GoTo Err_flImprimirEndosoDef

    Dim rsLiq As ADODB.Recordset
    Dim objRep As New ClsReporte
    Dim LNGa As Long
    
    'Imprimir Reporte de Poliza Original
    Screen.MousePointer = 11

   vlArchivo = strRpt & "PP_Rpt_EndDefEndoso_2.rpt"   '\Reportes
   If Not fgExiste(vlArchivo) Then     ', vbNormal
      MsgBox "Archivo de Reporte de Endoso de Renta Vitalicia no se encuentra en el directorio de la aplicación", 16, "Archivo no encontrado"
      Screen.MousePointer = 0
      Exit Function
   End If
      
     vlRptCodTipPension = ""
   'vlRptNumEndoso = 0
   vlRptCodAfp = ""
   vlRptCodTipRen = ""
   
   vgSql = ""
   vgSql = "SELECT num_endoso,cod_afp,cod_tipren,cod_tippension "
   vgSql = vgSql & ",cod_moneda,mto_valmoneda "
   vgSql = vgSql & "FROM PP_TMAE_POLIZA "
   vgSql = vgSql & "WHERE "
   vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
   vgSql = vgSql & "num_endoso = " & vlRptNumEndosoPol & " "
   'vgSql = vgSql & "ORDER BY num_endoso DESC "
   Set vgRegistro = vgConexionBD.Execute(vgSql)
   If Not vgRegistro.EOF Then
      'vlRptNumEndoso = (vgRegistro!num_endoso)
      vlRptCodAfp = Trim(vgRegistro!cod_afp) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_AFP, Trim(vgRegistro!cod_afp)))
      vlRptCodTipRen = Trim(vgRegistro!Cod_TipRen) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_TipRen, Trim(vgRegistro!Cod_TipRen)))
      vlRptCodTipPension = Trim(vgRegistro!Cod_TipPension) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_TipPen, Trim(vgRegistro!Cod_TipPension)))
      vlImpCodMoneda = vgRegistro!Cod_Moneda
      vlImpNomMoneda = fgBuscarGlosaElemento(vgCodTabla_TipMon, vlImpCodMoneda)
   End If
   vgRegistro.Close
   
   vlRptCodInsSalud = ""
   vlRptNomBen = ""
   vlRptRutBen = ""
   vlRptGlsDirBen = ""
   vlRptFonoBen = ""
   vlRptCodDireccion = "0"
   
   vgSql = ""
   vgSql = "SELECT cod_inssalud,gls_nomben,gls_nomsegben,gls_patben,gls_matben,Cod_TipoIdenben, "
   vgSql = vgSql & "Num_Idenben,cod_direccion,gls_dirben,gls_fonoben,GLS_TELBEN2,  cons_trainfo, cons_datcomer  "
   vgSql = vgSql & "FROM PP_TMAE_BEN "
   vgSql = vgSql & "WHERE "
   vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
   vgSql = vgSql & "num_endoso = " & (vlRptNumEndosoPol) & " AND "
   vgSql = vgSql & "cod_par = '" & Trim(clCodParCau) & "' "
   
   'vgSql = "SELECT cod_inssalud,gls_nomben,gls_nomsegben,gls_patben,gls_matben,Cod_TipoIdenben, Num_Idenben,cod_direccion,gls_dirben,gls_fonoben"
   'vgSql = vgSql & " FROM PP_TMAE_BEN a"
   'vgSql = vgSql & " WHERE num_poliza = '" & vlGlobalNumPoliza & "'"
   'vgSql = vgSql & " AND num_endoso = (select max(num_endoso) from pp_tmae_poliza where num_poliza=a.num_poliza)"
   'vgSql = vgSql & " AND cod_derpen=99 order by num_orden"

   Set vgRegistro = vgConexionBD.Execute(vgSql)
   If Not vgRegistro.EOF Then
        If Not IsNull(vgRegistro!Cod_InsSalud) Then
            vlRptCodInsSalud = " " & Trim(vgRegistro!Cod_InsSalud) & " - " & Trim(fgBuscarGlosaElemento(vgCodTabla_InsSal, Trim(vgRegistro!Cod_InsSalud)))
        End If
        If Not IsNull(vgRegistro!Gls_NomBen) And Not IsNull(vgRegistro!Gls_PatBen) Then
            vlNombre = vgRegistro!Gls_NomBen
            vlNombreSeg = IIf(IsNull(vgRegistro!Gls_NomSegBen), "", vgRegistro!Gls_NomSegBen)
            vlPaterno = vgRegistro!Gls_PatBen
            'I - MC 24/01/2008
            ''vlMaterno = IIf(IsNull(vgRegistro!Gls_PatBen), "", vgRegistro!Gls_PatBen)
            vlMaterno = IIf(IsNull(vgRegistro!Gls_MatBen), "", vgRegistro!Gls_MatBen)
            'F - MC 24/01/2008
            vlNombreCompleto = fgFormarNombreCompleto(vlNombre, vlNombreSeg, vlPaterno, vlMaterno)
            
            vlRptNomBen = vlNombreCompleto
        End If
        If Not IsNull(vgRegistro!Cod_TipoIdenBen) And Not IsNull(vgRegistro!Num_IdenBen) Then
            vlNombreTipoIden = fgBuscarNombreTipoIden(vgRegistro!Cod_TipoIdenBen)
            vlRptRutBen = vlNombreTipoIden & " - " & (Trim(vgRegistro!Num_IdenBen))
        End If
        If Not IsNull(vgRegistro!Gls_DirBen) Then
            vlRptGlsDirBen = Trim(vgRegistro!Gls_DirBen)
        End If
        If Not IsNull(vgRegistro!Gls_FonoBen) Then
            vlRptFonoBen = Trim(vgRegistro!Gls_FonoBen)
        Else
            vlRptFonoBen = " "
        End If
        If Not IsNull(vgRegistro!Cod_Direccion) Then
            vlRptCodDireccion = Trim(vgRegistro!Cod_Direccion)
        End If
        
        'INICIO GCP-FRACTAL 16042019
          If Not IsNull(vgRegistro!CONS_TRAINFO) Then
            vl_CONS_TRAINFO_rpt = IIf(Trim(vgRegistro!CONS_TRAINFO) = "1", "SI", "NO")
        End If
        
        If Not IsNull(vgRegistro!CONS_DATCOMER) Then
            vl_CONS_DATCOMER_rpt = IIf(Trim(vgRegistro!CONS_DATCOMER) = "1", "SI", "NO")
        End If
         'INICIO GCP-FRACTAL 16042019
        
        
        
   End If
   vgRegistro.Close


'RRR DATOS DEL ULTIMO ENDOSO

   vlRptNomBenNue = ""
   vlRptGlsDirBenNue = ""
   vlRptFonoBenNue = ""
   vlRptCodDireccionNue = "0"
   vlRptNomBeNue = ""
   
   vgSql = ""
   vgSql = "SELECT cod_inssalud,gls_nomben,gls_nomsegben,gls_patben,gls_matben,Cod_TipoIdenben, "
   vgSql = vgSql & "Num_Idenben,cod_direccion,gls_dirben,gls_fonoben, gls_correoben "
   vgSql = vgSql & "FROM PP_TMAE_BEN "
   vgSql = vgSql & "WHERE "
   vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
   vgSql = vgSql & "num_endoso = " & (vlRptNumEndosoEnd) & " AND "
   'vgSql = vgSql & "cod_derpen = '" & Trim(clCodParCau) & "' AND " 'MateriaGris-JRios 11/01/2018
   vgSql = vgSql & "num_orden = " & Trim(Lbl_BMNumOrd) & ""
   Set vgRegistro = vgConexionBD.Execute(vgSql)
   If Not vgRegistro.EOF Then
       
        'While Not vgRegistro.EOF
        
            If Not IsNull(vgRegistro!Gls_NomBen) And Not IsNull(vgRegistro!Gls_PatBen) Then
                vlNombre = vgRegistro!Gls_NomBen
                vlNombreSeg = IIf(IsNull(vgRegistro!Gls_NomSegBen), "", vgRegistro!Gls_NomSegBen)
                vlPaterno = vgRegistro!Gls_PatBen
                'I - MC 24/01/2008
                ''vlMaterno = IIf(IsNull(vgRegistro!Gls_PatBen), "", vgRegistro!Gls_PatBen)
                vlMaterno = IIf(IsNull(vgRegistro!Gls_MatBen), "", vgRegistro!Gls_MatBen)
                'F - MC 24/01/2008
                vlNombreCompleto = fgFormarNombreCompleto(vlNombre, vlNombreSeg, vlPaterno, vlMaterno)
                
                vlRptNomBeNue = vlNombreCompleto 'vlRptNomBeNue & vbCrLf & vlNombreCompleto
            End If
            'vgRegistro.MoveNext
        'Wend
        'vgRegistro.MoveFirst
          
        If Not IsNull(vgRegistro!Gls_DirBen) Then
            vlRptGlsDirBenNue = Trim(vgRegistro!Gls_DirBen)
        End If
        If Not IsNull(vgRegistro!Gls_FonoBen) Then
            vlRptFonoBenNue = Trim(vgRegistro!Gls_FonoBen)
        Else
            vlRptFonoBenNue = " "
        End If
        If Not IsNull(vgRegistro!Cod_Direccion) Then
            vlRptCodDireccionNue = Trim(vgRegistro!Cod_Direccion)
        End If
        If Not IsNull(vgRegistro!Gls_CorreoBen) Then
            vlRptCorreo = Trim(vgRegistro!Gls_CorreoBen)
        End If
        If Not IsNull(vgRegistro!Num_IdenBen) Then
            vlRptDocNum = Trim(vgRegistro!Num_IdenBen)
        End If
 
   End If
   vgRegistro.Close

    vgSql = ""
    vgSql = "SELECT c.gls_comuna,p.gls_provincia,r.gls_region "
    vgSql = vgSql & "FROM MA_TPAR_COMUNA c,MA_TPAR_PROVINCIA p,MA_TPAR_REGION r "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "c.cod_direccion = '" & vlRptCodDireccionNue & "' AND "
    vgSql = vgSql & "c.cod_provincia = p.cod_provincia AND "
    vgSql = vgSql & "p.cod_region = r.cod_region AND "
    vgSql = vgSql & "c.cod_region = r.cod_region "
    Set vgRegistro = vgConexionBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
         If Not IsNull(vgRegistro!gls_comuna) Then vlRptComuna = Trim(vgRegistro!gls_comuna)
         If Not IsNull(vgRegistro!gls_provincia) Then vlRptProvincia = Trim(vgRegistro!gls_provincia)
         If Not IsNull(vgRegistro!gls_region) Then vlRptRegion = Trim(vgRegistro!gls_region)
         vlRptGlsDirBenNue = vlRptGlsDirBenNue & " - " & vlRptComuna & "/" & vlRptProvincia & "/" & vlRptRegion
    End If
    vgRegistro.Close

'RRR

   vlRptComuna = ""
   vlRptProvincia = ""
   vlRptRegion = ""
   
    vgSql = ""
    vgSql = "SELECT c.gls_comuna,p.gls_provincia,r.gls_region "
    vgSql = vgSql & "FROM MA_TPAR_COMUNA c,MA_TPAR_PROVINCIA p,MA_TPAR_REGION r "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "c.cod_direccion = '" & vlRptCodDireccion & "' AND "
    vgSql = vgSql & "c.cod_provincia = p.cod_provincia AND "
    vgSql = vgSql & "p.cod_region = r.cod_region AND "
    vgSql = vgSql & "c.cod_region = r.cod_region "
    Set vgRegistro = vgConexionBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        If Not IsNull(vgRegistro!gls_comuna) Then vlRptComuna = Trim(vgRegistro!gls_comuna)
        If Not IsNull(vgRegistro!gls_provincia) Then vlRptProvincia = Trim(vgRegistro!gls_provincia)
        If Not IsNull(vgRegistro!gls_region) Then vlRptRegion = Trim(vgRegistro!gls_region)
        'vlRptGlsDirBenNue = vlRptGlsDirBenNue & "-" & vlRptComuna & "/" & vlRptProvincia & "/" & vlRptRegion
    End If
    vgRegistro.Close
    
    vlRptNomInter = "-"
    vlRptRutInter = "-"
    vlRptComInter = "-"
   
      
      
   vlRptGlsCauEndoso = ""
   vlRptGlsCauEndoso2 = ""
   vlRptGlsFactorEndoso = ""
   vlRptMtoRtaMod = 0
   vlRptMtoPension = 0
      
   vgSql = ""
   vgSql = "SELECT mto_pensionori,mto_pensioncal,fec_efecto, "
   vgSql = vgSql & "cod_cauendoso,cod_tipendoso "
   vgSql = vgSql & "FROM PP_TMAE_ENDOSO "
   vgSql = vgSql & "WHERE "
   vgSql = vgSql & "num_poliza = '" & Trim(Txt_PenPoliza) & "' AND "
   'I--- ABV
   'vgSql = vgSql & "num_endoso = " & vlRptNumEndosoEnd & " "
   vgSql = vgSql & "num_endoso = " & vlRptNumEndosoEnd - 1 & " "
   'F--- ABV
   Set vgRegistro = vgConexionBD.Execute(vgSql)
   
   Dim strCauEnd As String
   If Not vgRegistro.EOF Then
      'vlRptNumEndoso = (vgRegistro!num_endoso)
      '****mvg agrego la ultima else
      If vgRegistro!cod_cauendoso = "14" Then
            vlRptGlsCauEndoso = Trim(fgBuscarGlosaElemento(vgCodTabla_CauEnd, Trim(vgRegistro!cod_cauendoso))) & vbCrLf & "Nombres Actualizados: " & vlRptNomBeNue
      ElseIf vgRegistro!cod_cauendoso = "15" Then
            vlRptGlsCauEndoso = Trim(fgBuscarGlosaElemento(vgCodTabla_CauEnd, Trim(vgRegistro!cod_cauendoso))) & vbCrLf & "Nombre    : " & vlRptNomBeNue & vbCrLf & "La nueva direccion es: " & vlRptGlsDirBenNue 'MateriaGris-JRios 12/12/2018
      ElseIf vgRegistro!cod_cauendoso = "16" Then
            vlRptGlsCauEndoso = Trim(fgBuscarGlosaElemento(vgCodTabla_CauEnd, Trim(vgRegistro!cod_cauendoso))) & vbCrLf & "Nombre    : " & vlRptNomBeNue & vbCrLf & "El nuevo Nùmero Telefonico es: " & vlRptFonoBenNue 'MateriaGris-JRios 12/12/2018
      ElseIf vgRegistro!cod_cauendoso = "17" Then
            vlRptGlsCauEndoso = Trim(fgBuscarGlosaElemento(vgCodTabla_CauEnd, Trim(vgRegistro!cod_cauendoso))) & vbCrLf & "Nombre    : " & vlRptNomBeNue & vbCrLf & "El nuevo DNI es: " & vlRptDocNum 'MateriaGris-JRios 12/12/2018
      ElseIf vgRegistro!cod_cauendoso = "27" Then
            vlRptGlsCauEndoso = Trim(fgBuscarGlosaElemento(vgCodTabla_CauEnd, Trim(vgRegistro!cod_cauendoso))) & vbCrLf & "Nombre    : " & vlRptNomBeNue
            vlRptGlsCauEndoso = vlRptGlsCauEndoso & vbCrLf & "Nro. documento : " & vlRptDocNum & vbCrLf & "E-mail       : " & vlRptCorreo
            vlRptGlsCauEndoso = vlRptGlsCauEndoso & vbCrLf & "Direccion : " & vlRptGlsDirBenNue & vbCrLf & "Telèfono   : " & vlRptFonoBenNue
            vlRptGlsCauEndoso2 = vlRptGlsCauEndoso2 & vbCrLf & "Tratamiento de Datos: " & vl_CONS_TRAINFO_rpt
            vlRptGlsCauEndoso2 = vlRptGlsCauEndoso2 & vbCrLf & "Uso de datos para fines comerciales: " & vl_CONS_DATCOMER_rpt
      Else
            vlRptGlsCauEndoso = Trim(fgBuscarGlosaElemento(vgCodTabla_CauEnd, Trim(vgRegistro!cod_cauendoso)))
      End If
      
      
      vlRptFechaVigEndoso = DateSerial(Mid((vgRegistro!FEC_EFECTO), 1, 4), Mid((vgRegistro!FEC_EFECTO), 5, 2), Mid((vgRegistro!FEC_EFECTO), 7, 2))
      vlRptMtoPension = Format((vgRegistro!mto_pensioncal), "###,###,##0.00")
      vlRptMtoPensionOri = Format((vgRegistro!mto_pensionori), "###,###,##0.00")
      If vlRptMtoPensionOri <> vlRptMtoPension Then
         If vlRptMtoPensionOri > vlRptMtoPension Then
            vlRptMtoRtaMod = Format((vlRptMtoPensionOri - vlRptMtoPension), "#0.00")
            vlRptGlsFactorEndoso = Trim(clRptDisminuye)
         End If
         If vlRptMtoPensionOri < vlRptMtoPension Then
            vlRptMtoRtaMod = Format((vlRptMtoPension - vlRptMtoPensionOri), "#0.00")
            vlRptGlsFactorEndoso = Trim(clRptAumenta)
         End If
      Else
          'CMV 20050928 I
          'Modificado para que en el informe muestre: "La Renta se mantiene en"
          'junto al valor de la renta original y no : "La Renta se mantiene en"
          'junto al valor de la modificación que sería 0.
          'vlRptMtoRtaMod = 0
          vlRptMtoRtaMod = vlRptMtoPensionOri
          'CMV 20050928 F
          vlRptGlsFactorEndoso = Trim(clRptMantiene)
      End If
      strCauEnd = Trim(vgRegistro!cod_cauendoso)
   End If
      

    vgSql = ""
'    vgSql = " select a.num_poliza, a.num_endoso, b.num_idenben, a.fec_vigencia, a.mto_prima, a.mto_pension, a.num_mesdif, a.num_mesgar,"
'    vgSql = vgSql & " Gls_NomBen , Gls_NomSegBen, b.Gls_PatBen, b.Gls_MatBen, Cod_Par, Cod_Sexo, Cod_SitInv, b.Mto_Pension as Mto_ben, c.gls_elemento, d.gls_tipoiden, b.fec_nacben,e.cod_tipendoso, b.gls_dirben"
'    ',f.gls_elemento AS tipoendoso
'    vgSql = vgSql & " from pp_tmae_poliza a"
'    vgSql = vgSql & " join pp_tmae_ben b on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso"
'    vgSql = vgSql & " join ma_tpar_tabcod c on b.cod_par=c.cod_elemento and c.cod_tabla='PA'"
'    vgSql = vgSql & " join ma_tpar_tipoiden d on b.cod_tipoidenben=d.cod_tipoiden"
'    vgSql = vgSql & " join pp_tmae_endoso e on a.num_poliza=e.num_poliza and a.num_endoso=(e.num_endoso + 1) "
'    'vgSql = vgSql & " JOIN ma_tpar_tabcod F on e.cod_cauendoso=f.cod_elemento and f.cod_tabla='CE'"
'    vgSql = vgSql & " Where a.num_poliza = '" & vlGlobalNumPoliza & "' And a.num_endoso = " & (vlRptNumEndosoEnd) & ""
'    vgSql = vgSql & " order by b.num_orden"
    
'    vgSql = " select a.num_poliza, a.num_endoso, b.num_idenben, a.fec_vigencia, a.mto_prima, a.mto_pension, a.num_mesdif, a.num_mesgar, "
'    vgSql = vgSql & " Gls_NomBen , Gls_NomSegBen, b.Gls_PatBen, b.Gls_MatBen, Cod_Par, Cod_Sexo, Cod_SitInv "
'    vgSql = vgSql & ", case when b.cod_derpen='10' then 0.00 else "
'    vgSql = vgSql & " case when nvl(b.Fec_TerPagoPenGar,TO_CHAR(SYSDATE-1,'yyyymmdd'))>=TO_CHAR(SYSDATE,'yyyymmdd') then "
'    vgSql = vgSql & " x.pension_act * (b.Prc_PensionGar/100) "
'    vgSql = vgSql & " else x.pension_act * (b.prc_pension) end end Mto_ben "
'    vgSql = vgSql & ", c.gls_elemento, d.gls_tipoiden, b.fec_nacben,e.cod_tipendoso, b.gls_dirben "
'    vgSql = vgSql & " from pp_tmae_poliza a"
'    vgSql = vgSql & " join pp_tmae_ben b on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso"
'    vgSql = vgSql & " join ma_tpar_tabcod c on b.cod_par=c.cod_elemento and c.cod_tabla='PA'"
'    vgSql = vgSql & " join ma_tpar_tipoiden d on b.cod_tipoidenben=d.cod_tipoiden"
'    vgSql = vgSql & " join pp_tmae_endoso e on a.num_poliza=e.num_poliza and a.num_endoso=(e.num_endoso + 1) "
'    vgSql = vgSql & " join (select x.num_poliza, x.num_endoso, x.mto_pension pension_act, max(x.fec_desde) from pp_tmae_pensionact x where fec_desde=(select max(fec_desde) from pp_tmae_pensionact where num_poliza=x.num_poliza) group by num_poliza, num_endoso, mto_pension) "
'    vgSql = vgSql & " x on x.num_poliza=a.num_poliza and x.num_endoso=a.num_endoso "
'    vgSql = vgSql & " Where a.num_poliza = '" & vlGlobalNumPoliza & "' And a.num_endoso = " & (vlRptNumEndosoEnd) & ""
'    vgSql = vgSql & " order by b.num_orden"


vgSql = " select a.num_poliza, a.num_endoso, b.num_idenben, a.fec_vigencia, a.mto_prima, a.mto_pension, a.num_mesdif, a.num_mesgar,  Gls_NomBen , Gls_NomSegBen, b.Gls_PatBen, b.Gls_MatBen, Cod_Par,"
vgSql = vgSql & " Cod_Sexo, Cod_SitInv , case when b.cod_derpen='10' then 0.00 else  case when nvl(b.Fec_TerPagoPenGar,TO_CHAR(SYSDATE-1,'yyyymmdd'))>=TO_CHAR(SYSDATE,'yyyymmdd') then  nvl(x.pension_act,a.mto_pension) * (b.Prc_PensionGar/100)  else nvl(x.pension_act,a.mto_pension) * (b.prc_pension / 100) end end Mto_ben ,"
vgSql = vgSql & " c.gls_elemento , d.gls_tipoiden, b.Fec_NacBen, e.cod_tipendoso, b.Gls_DirBen"
vgSql = vgSql & " from pp_tmae_poliza a"
vgSql = vgSql & " join pp_tmae_ben b on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso"
vgSql = vgSql & " join ma_tpar_tabcod c on b.cod_par=c.cod_elemento and c.cod_tabla='PA'"
vgSql = vgSql & " join ma_tpar_tipoiden d on b.cod_tipoidenben=d.cod_tipoiden"
vgSql = vgSql & " join pp_tmae_endoso e on a.num_poliza=e.num_poliza and a.num_endoso=(e.num_endoso + 1)"
vgSql = vgSql & " left join (select x.num_poliza, x.num_endoso, x.mto_pension pension_act, max(x.fec_desde)"
vgSql = vgSql & "       from pp_tmae_pensionact x where fec_desde=(select max(fec_desde) from pp_tmae_pensionact where num_poliza=x.num_poliza)"
vgSql = vgSql & "       group by x.num_poliza, x.num_endoso, x.mto_pension)  x on x.num_poliza=a.num_poliza and x.num_endoso=a.num_endoso"
vgSql = vgSql & " Where a.num_poliza = '" & vlGlobalNumPoliza & "' And a.num_endoso = " & (vlRptNumEndosoEnd) & ""
vgSql = vgSql & " order by b.num_orden"


    Set rsLiq = New ADODB.Recordset
    rsLiq.CursorLocation = adUseClient
    rsLiq.Open vgSql, vgConexionBD, adOpenForwardOnly, adLockReadOnly
    
    vlRutCliente = flRutCliente 'vgRutCliente + " - " + vgDgvCliente
    
    LNGa = CreateFieldDefFile(rsLiq, Replace(UCase(strRpt & "Estructura\PP_Rpt_EndDefEndoso.rpt"), ".RPT", ".TTX"), 1)
    
    Dim intFlgSRpt As Integer
    intFlgSRpt = 0
    Dim RsSrpt As New ADODB.Recordset
    
    If strCauEnd = "28" Then
        Dim strSrpt As String
        
        If Mid(vlRptCodTipPension, 1, 2) = "04" Or Mid(vlRptCodTipPension, 1, 2) = "05" Or Mid(vlRptCodTipPension, 1, 2) = "06" Or Mid(vlRptCodTipPension, 1, 2) = "07" Then
            strSrpt = "select a.num_poliza, b.num_endoso, a.num_orden, a.gls_nomben||' '||a.gls_patben Benef, a.parentesco, a.viapago viapago_old, a.banco banco_old, a.tipocta tipocta_old, a.num_cuenta numcta_old, a.gls_sucursal suc_old, a.MonBco MonBco_Old, b.viapago viapago_new, b.banco banco_new, b.tipocta tipocta_new, b.num_cuenta numcta_new, b.gls_sucursal suc_new, b.MonBco MonBco_New, a.num_cuenta_cci numctacci_old, b.num_cuenta_cci numctacci_new "
            strSrpt = strSrpt & "from ("
            strSrpt = strSrpt & "    select a.num_poliza, b.num_endoso, b.num_orden, b.Gls_NomBen , b.Gls_NomSegBen, b.Gls_PatBen, b.Gls_MatBen,  c.gls_elemento Parentesco, nvl(g.gls_elemento,'-') ViaPago, nvl(f.gls_elemento,'-') Banco, nvl(h.gls_elemento,'-') TipoCta, nvl(b.num_ctabco,'-') Num_Cuenta, nvl(s.gls_sucursal,'-') gls_sucursal, nvl(b.cod_monbco,'-') MonBco, nvl(b.num_cuenta_cci, '-') num_cuenta_cci "
            strSrpt = strSrpt & "    from pp_tmae_poliza a "
            strSrpt = strSrpt & "    inner join pp_tmae_ben b on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso "
            strSrpt = strSrpt & "    inner join ma_tpar_tabcod c on b.cod_par=c.cod_elemento and c.cod_tabla='PA' "
            strSrpt = strSrpt & "    left join ma_tpar_tabcod f on b.cod_banco=f.cod_elemento and f.cod_tabla='BCO' "
            strSrpt = strSrpt & "    left join ma_tpar_tabcod g on b.cod_viapago=g.cod_elemento and g.cod_tabla='VPG'"
            strSrpt = strSrpt & "    left join ma_tpar_tabcod h on b.cod_tipcta=h.cod_elemento and h.cod_tabla='TCT'"
            strSrpt = strSrpt & "    left join MA_TPAR_SUCURSAL s on s.cod_sucursal=b.cod_sucursal"
            strSrpt = strSrpt & "    Where a.num_poliza = '" & vlGlobalNumPoliza & "'  And Num_Orden = 1 And a.num_endoso = " & (vlRptNumEndosoEnd - 1)
            strSrpt = strSrpt & ") a "
            strSrpt = strSrpt & " inner join ("
            strSrpt = strSrpt & "    select a.num_poliza, b.num_endoso, b.num_orden, b.Gls_NomBen , b.Gls_NomSegBen, b.Gls_PatBen, b.Gls_MatBen,  c.gls_elemento Parentesco, nvl(g.gls_elemento,'-') ViaPago, nvl(f.gls_elemento,'-') Banco, nvl(h.gls_elemento,'-') TipoCta, nvl(b.num_ctabco,'-') Num_Cuenta, nvl(s.gls_sucursal,'-') gls_sucursal, nvl(b.cod_monbco,'-') MonBco, nvl(b.num_cuenta_cci, '-') num_cuenta_cci "
            strSrpt = strSrpt & "    from pp_tmae_poliza a"
            strSrpt = strSrpt & "    inner join pp_tmae_ben b on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso"
            strSrpt = strSrpt & "    inner join ma_tpar_tabcod c on b.cod_par=c.cod_elemento and c.cod_tabla='PA'"
            strSrpt = strSrpt & "    left join ma_tpar_tabcod f on b.cod_banco=f.cod_elemento and f.cod_tabla='BCO'"
            strSrpt = strSrpt & "    left join ma_tpar_tabcod g on b.cod_viapago=g.cod_elemento and g.cod_tabla='VPG'"
            strSrpt = strSrpt & "    left join ma_tpar_tabcod h on b.cod_tipcta=h.cod_elemento and h.cod_tabla='TCT'"
            strSrpt = strSrpt & "    left join MA_TPAR_SUCURSAL s on s.cod_sucursal=b.cod_sucursal"
            strSrpt = strSrpt & "    Where a.num_poliza = '" & vlGlobalNumPoliza & "'  And Num_Orden = 1 And a.num_endoso = " & vlRptNumEndosoEnd
            strSrpt = strSrpt & ") b on b.num_poliza=a.num_poliza and a.num_orden=b.num_orden "
            strSrpt = strSrpt & " where a.viapago<>b.viapago or a.banco<>b.banco or a.tipocta<>b.tipocta or a.num_cuenta<>b.num_cuenta  or a.gls_sucursal<>b.gls_sucursal or a.monbco<>b.monbco "
            strSrpt = strSrpt & " order by a.num_orden"
        Else
            strSrpt = "select a.num_poliza, b.num_endoso, a.num_orden, a.gls_nomben||' '||a.gls_patben Benef, a.parentesco, a.viapago viapago_old, a.banco banco_old, a.tipocta tipocta_old, a.num_cuenta numcta_old, a.gls_sucursal suc_old, a.MonBco MonBco_Old, b.viapago viapago_new, b.banco banco_new, b.tipocta tipocta_new, b.num_cuenta numcta_new, b.gls_sucursal suc_new, b.MonBco MonBco_New, a.num_cuenta_cci numctacci_old, b.num_cuenta_cci numctacci_new "
            strSrpt = strSrpt & "from ("
            strSrpt = strSrpt & "    select a.num_poliza, b.num_endoso, b.num_orden, b.Gls_NomBen , b.Gls_NomSegBen, b.Gls_PatBen, b.Gls_MatBen,  c.gls_elemento Parentesco, nvl(g.gls_elemento,'-') ViaPago, nvl(f.gls_elemento,'-') Banco, nvl(h.gls_elemento,'-') TipoCta, nvl(b.num_ctabco,'-') Num_Cuenta, nvl(s.gls_sucursal,'-') gls_sucursal, nvl(b.cod_monbco,'-') MonBco, nvl(b.num_cuenta_cci, '-') num_cuenta_cci "
            strSrpt = strSrpt & "    from pp_tmae_poliza a "
            strSrpt = strSrpt & "    inner join pp_tmae_ben b on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso "
            strSrpt = strSrpt & "    inner join ma_tpar_tabcod c on b.cod_par=c.cod_elemento and c.cod_tabla='PA' "
            strSrpt = strSrpt & "    left join ma_tpar_tabcod f on b.cod_banco=f.cod_elemento and f.cod_tabla='BCO' "
            strSrpt = strSrpt & "    left join ma_tpar_tabcod g on b.cod_viapago=g.cod_elemento and g.cod_tabla='VPG'"
            strSrpt = strSrpt & "    left join ma_tpar_tabcod h on b.cod_tipcta=h.cod_elemento and h.cod_tabla='TCT'"
            strSrpt = strSrpt & "    left join MA_TPAR_SUCURSAL s on s.cod_sucursal=b.cod_sucursal"
            strSrpt = strSrpt & "    Where a.num_poliza = '" & vlGlobalNumPoliza & "' And Num_Orden <> 1 and a.num_endoso = " & (vlRptNumEndosoEnd - 1)
            strSrpt = strSrpt & ") a "
            strSrpt = strSrpt & " inner join ("
            strSrpt = strSrpt & "    select a.num_poliza, b.num_endoso, b.num_orden, b.Gls_NomBen , b.Gls_NomSegBen, b.Gls_PatBen, b.Gls_MatBen,  c.gls_elemento Parentesco, nvl(g.gls_elemento,'-') ViaPago, nvl(f.gls_elemento,'-') Banco, nvl(h.gls_elemento,'-') TipoCta, nvl(b.num_ctabco,'-') Num_Cuenta, nvl(s.gls_sucursal,'-') gls_sucursal, nvl(b.cod_monbco,'-') MonBco, nvl(b.num_cuenta_cci, '-') num_cuenta_cci "
            strSrpt = strSrpt & "    from pp_tmae_poliza a"
            strSrpt = strSrpt & "    inner join pp_tmae_ben b on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso"
            strSrpt = strSrpt & "    inner join ma_tpar_tabcod c on b.cod_par=c.cod_elemento and c.cod_tabla='PA'"
            strSrpt = strSrpt & "    left join ma_tpar_tabcod f on b.cod_banco=f.cod_elemento and f.cod_tabla='BCO'"
            strSrpt = strSrpt & "    left join ma_tpar_tabcod g on b.cod_viapago=g.cod_elemento and g.cod_tabla='VPG'"
            strSrpt = strSrpt & "    left join ma_tpar_tabcod h on b.cod_tipcta=h.cod_elemento and h.cod_tabla='TCT'"
            strSrpt = strSrpt & "    left join MA_TPAR_SUCURSAL s on s.cod_sucursal=b.cod_sucursal"
            strSrpt = strSrpt & "    Where a.num_poliza = '" & vlGlobalNumPoliza & "' And Num_Orden <> 1 and a.num_endoso = " & vlRptNumEndosoEnd
            strSrpt = strSrpt & ") b on b.num_poliza=a.num_poliza and a.num_orden=b.num_orden "
            strSrpt = strSrpt & " where a.viapago<>b.viapago or a.banco<>b.banco or a.tipocta<>b.tipocta or a.num_cuenta<>b.num_cuenta  or a.gls_sucursal<>b.gls_sucursal or a.monbco<>b.monbco "
            strSrpt = strSrpt & " order by a.num_orden"
        End If
        
        
        
        
        
        
        Set RsSrpt = vgConexionBD.Execute(strSrpt)
        LNGa = CreateFieldDefFile(RsSrpt, Replace(UCase(strRpt & "Estructura\PP_Rpt_EndDefEndoso_SR.rpt"), ".RPT", ".TTX"), 1)
        
        intFlgSRpt = 0
        If Not RsSrpt.EOF Then
            intFlgSRpt = 1
        End If
    End If
    
    'If objRep.EjecutaReporte(strRpt & "", "PP_Rpt_EndDefEndoso_2.rpt", "Pruebas", rsLiq, intFlgSRpt, RsSrpt, _
                            ArrFormulas("NombreCompania", vgNombreCompania), _
                            ArrFormulas("NombreSistema", vgNombreSistema), _
                            ArrFormulas("NombreSubSistema", vgNombreSubSistema), _
                            ArrFormulas("TipPension", vlRptCodTipPension), _
                            ArrFormulas("Afp", vlRptCodAfp), _
                            ArrFormulas("TipRta", vlRptCodTipRen), _
                            ArrFormulas("NombreCausante", vlRptNomBen), _
                            ArrFormulas("RutCausante", vlRptRutBen), _
                            ArrFormulas("Direccion", vlRptGlsDirBen), _
                            ArrFormulas("Fono", vlRptFonoBen), _
                            ArrFormulas("Comuna", vlRptComuna), _
                            ArrFormulas("Provincia", vlRptProvincia), _
                            ArrFormulas("Region", vlRptRegion), _
                            ArrFormulas("Origen", clRptOrigen), _
                            ArrFormulas("CodMoneda", cgCodTipMonedaUF), _
                            ArrFormulas("MotivoEndoso", vlRptGlsCauEndoso), _
                            ArrFormulas("GlsFactorEndoso", vlRptGlsFactorEndoso), _
                            ArrFormulas("MtoRtaMod", str(vlRptMtoRtaMod)), _
                            ArrFormulas("MtoPension", str(vlRptMtoPension)), _
                            ArrFormulas("FechaVigEndoso", vlRptFechaVigEndoso), _
                            ArrFormulas("MtoRtaOri", str(vlRptMtoPensionOri)), _
                            ArrFormulas("CodMonedaCor", vlImpCodMoneda), _
                            ArrFormulas("MotivoEndoso2", vlRptGlsCauEndoso2)) Then
                            
 If objRep.EjecutaReporte(strRpt & "", "PP_Rpt_EndDefEndoso_2.rpt", "Pruebas", rsLiq, intFlgSRpt, RsSrpt, _
                            ArrFormulas("NombreCompania", vgNombreCompania), _
                            ArrFormulas("NombreSistema", vgNombreSistema), _
                            ArrFormulas("NombreSubSistema", vgNombreSubSistema), _
                            ArrFormulas("TipPension", vlRptCodTipPension), _
                            ArrFormulas("Afp", vlRptCodAfp), _
                            ArrFormulas("TipRta", vlRptCodTipRen), _
                            ArrFormulas("NombreCausante", vlRptNomBen), _
                            ArrFormulas("RutCausante", vlRptRutBen), _
                            ArrFormulas("Direccion", vlRptGlsDirBen), _
                            ArrFormulas("Fono", vlRptFonoBen), _
                            ArrFormulas("Comuna", vlRptComuna), _
                            ArrFormulas("Provincia", vlRptProvincia), _
                            ArrFormulas("Region", vlRptRegion), _
                            ArrFormulas("Origen", "clRptOrigen"), _
                            ArrFormulas("CodMoneda", cgCodTipMonedaUF), _
                            ArrFormulas("MotivoEndoso", vlRptGlsCauEndoso), _
                            ArrFormulas("GlsFactorEndoso", vlRptGlsFactorEndoso), _
                            ArrFormulas("MtoRtaMod", str(vlRptMtoRtaMod)), _
                            ArrFormulas("MtoPension", str(vlRptMtoPension)), _
                            ArrFormulas("FechaVigEndoso", vlRptFechaVigEndoso), _
                            ArrFormulas("MtoRtaOri", str(vlRptMtoPensionOri)), _
                            ArrFormulas("CodMonedaCor", vlImpCodMoneda), _
                            ArrFormulas("MotivoEndoso2", vlRptGlsCauEndoso2)) Then
                            
    Else
        MsgBox "No se pudo abrir el reporte", vbInformation
        Exit Function
    End If
    
   'vgQuery = ""
   'vgQuery = vgQuery & "{PP_TMAE_POLIZA.num_poliza} = '" & vlGlobalNumPoliza & "' AND "
   'vgQuery = vgQuery & "{PP_TMAE_POLIZA.num_endoso} = " & (vlRptNumEndosoEnd) & " "
           
  ' Rpt_Reporte.Reset
  ' Rpt_Reporte.WindowState = crptMaximized
  ' Rpt_Reporte.ReportFileName = vlArchivo     'App.Path & "\Rpt_Areas.rpt"
  ' Rpt_Reporte.Connect = vgRutaDataBase       ' o App.Path & "\Nestle.mdb"
  ' Rpt_Reporte.SelectionFormula = vgQuery

  ' Rpt_Reporte.Formulas(0) = ""
  ' Rpt_Reporte.Formulas(1) = ""
  ' Rpt_Reporte.Formulas(2) = ""
  ' Rpt_Reporte.Formulas(3) = ""
  ' Rpt_Reporte.Formulas(4) = ""
  ' Rpt_Reporte.Formulas(5) = ""
  ' Rpt_Reporte.Formulas(6) = ""
  ' Rpt_Reporte.Formulas(7) = ""
  ' Rpt_Reporte.Formulas(8) = ""
  ' Rpt_Reporte.Formulas(9) = ""
  ' Rpt_Reporte.Formulas(10) = ""
  ' Rpt_Reporte.Formulas(11) = ""
  ' Rpt_Reporte.Formulas(12) = ""
  ' Rpt_Reporte.Formulas(13) = ""
  ' Rpt_Reporte.Formulas(14) = ""
  ' Rpt_Reporte.Formulas(15) = ""
  ' Rpt_Reporte.Formulas(16) = ""
  ' Rpt_Reporte.Formulas(17) = ""
  ' Rpt_Reporte.Formulas(18) = ""
  ' Rpt_Reporte.Formulas(19) = ""
  ' Rpt_Reporte.Formulas(20) = ""
  ' Rpt_Reporte.Formulas(21) = ""
  ' Rpt_Reporte.Formulas(22) = ""
  ' Rpt_Reporte.Formulas(23) = ""
  ' Rpt_Reporte.Formulas(24) = ""
  ' Rpt_Reporte.Formulas(25) = ""
  ' Rpt_Reporte.Formulas(26) = ""
         
 '  Rpt_Reporte.Formulas(0) = "NombreCompania = '" & vgNombreCompania & "'"
 '  Rpt_Reporte.Formulas(1) = "NombreSistema= '" & vgNombreSistema & "'"
 '  Rpt_Reporte.Formulas(2) = "NombreSubSistema= '" & vgNombreSubSistema & "'"
 '  Rpt_Reporte.Formulas(3) = "TipPension = '" & vlRptCodTipPension & "'"
 '  Rpt_Reporte.Formulas(4) = "Afp = '" & vlRptCodAfp & "'"
 '  Rpt_Reporte.Formulas(5) = "TipRta = '" & vlRptCodTipRen & "'"
 '  Rpt_Reporte.Formulas(6) = "InstSalud = '" & vlRptCodInsSalud & "'"
 '  Rpt_Reporte.Formulas(7) = "NombreCausante = '" & vlRptNomBen & "'"
 '  Rpt_Reporte.Formulas(8) = "RutCausante = '" & vlRptRutBen & "'"
 '  Rpt_Reporte.Formulas(9) = "Direccion = '" & vlRptGlsDirBen & "'"
 '  Rpt_Reporte.Formulas(10) = "Fono = '" & vlRptFonoBen & "'"
 '  Rpt_Reporte.Formulas(11) = "Comuna = '" & vlRptComuna & "'"
 '  Rpt_Reporte.Formulas(12) = "Provincia = '" & vlRptProvincia & "'"
 '  Rpt_Reporte.Formulas(13) = "Region = '" & vlRptRegion & "'"
 '  Rpt_Reporte.Formulas(14) = "NombreInter = '" & vlRptNomInter & "'"
 '  Rpt_Reporte.Formulas(15) = "RutInter = '" & vlRptRutInter & "'"
 '  Rpt_Reporte.Formulas(16) = "ComisionInter = '" & vlRptComInter & "'"
 '  Rpt_Reporte.Formulas(17) = "Origen = '" & clRptOrigen & "'"
 '  'Rpt_Reporte.Formulas(18) = "CodMoneda = '" & cgCodTipMonedaUF & "'"
 '  Rpt_Reporte.Formulas(19) = "MotivoEndoso = '" & vlRptGlsCauEndoso & "'"
 '  Rpt_Reporte.Formulas(20) = "GlsFactorEndoso = '" & vlRptGlsFactorEndoso & "'"
 '  Rpt_Reporte.Formulas(21) = "MtoRtaMod = " & Str(vlRptMtoRtaMod) & ""
 '  Rpt_Reporte.Formulas(22) = "MtoPension = " & Str(vlRptMtoPension) & ""
 '  Rpt_Reporte.Formulas(23) = "FechaVigEndoso = '" & vlRptFechaVigEndoso & "'"
 '  Rpt_Reporte.Formulas(24) = "MtoRtaOri = " & Str(vlRptMtoPensionOri) & ""
 '  Rpt_Reporte.Formulas(25) = "CodMoneda = '" & vlImpNomMoneda & "'"
 '  Rpt_Reporte.Formulas(26) = "CodMonedaCor = '" & vlImpCodMoneda & "'"

 '  Rpt_Reporte.SubreportToChange = ""
 '  Rpt_Reporte.Destination = crptToWindow
 '  Rpt_Reporte.WindowState = crptMaximized
 '  Rpt_Reporte.WindowTitle = "Póliza de Endoso Aprobado"
 '  'Rpt_Reporte.SelectionFormula = ""
 '  Rpt_Reporte.Action = 1
   Screen.MousePointer = 0

Exit Function
Err_flImprimirEndosoDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flImprimirEndosoPrev()
On Error GoTo Err_flImprimirEndosoPrev

'Imprimir Reporte de Poliza Original
   Screen.MousePointer = 11

   vlArchivo = strRpt & "PP_Rpt_EndPreEndoso.rpt"   '\Reportes
   If Not fgExiste(vlArchivo) Then     ', vbNormal
      MsgBox "Archivo de Reporte de Endoso de Renta Vitalicia Preliminar no se encuentra en el directorio de la aplicación", 16, "Archivo no encontrado"
      Screen.MousePointer = 0
      Exit Function
   End If
    
    vlcobertura = ""
    
    'Buscar Antecedentes para formar la Cobertura
    vgSql = "SELECT  p.num_poliza,p.cod_tippension,"
    vgSql = vgSql & "p.cod_tipren,p.num_mesdif,p.cod_modalidad,p.num_mesgar,"
    vgSql = vgSql & "p.mto_pension,t.gls_elemento as gls_pension,"
    vgSql = vgSql & "r.gls_elemento as gls_renta,m.gls_elemento as gls_modalidad,"
    vgSql = vgSql & "p.cod_moneda, "
    vgSql = vgSql & "p.cod_cobercon, b.gls_cobercon,p.cod_dercre, p.cod_dergra "
    vgSql = vgSql & "FROM "
    vgSql = vgSql & "pp_tmae_endpoliza p, ma_tpar_tabcod t, ma_tpar_tabcod r, "
    vgSql = vgSql & "ma_tpar_tabcod m, ma_tpar_cobercon b "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "p.num_poliza = '" & vlGlobalNumPoliza & "' AND "
    vgSql = vgSql & "t.cod_tabla = '" & Trim(vgCodTabla_TipPen) & "' AND "
    vgSql = vgSql & "t.cod_elemento = p.cod_tippension AND "
    vgSql = vgSql & "r.cod_tabla = '" & Trim(vgCodTabla_TipRen) & "' AND "
    vgSql = vgSql & "r.cod_elemento = p.cod_tipren AND "
    vgSql = vgSql & "m.cod_tabla = '" & Trim(vgCodTabla_AltPen) & "' AND "
    vgSql = vgSql & "m.cod_elemento = p.cod_modalidad AND "
    vgSql = vgSql & "p.cod_cobercon = b.cod_cobercon"
    Set vlRegistro = vgConexionBD.Execute(vgSql)
    If Not (vlRegistro.EOF) Then
        vlcobertura = vlRegistro!Gls_Renta
        If vlRegistro!Cod_Modalidad = 1 Then
            If Not IsNull(vlRegistro!gls_modalidad) Then
                vlcobertura = vlcobertura & " " & vlRegistro!gls_modalidad
            End If
        Else
            If Not IsNull(vlRegistro!gls_modalidad) Then
                vlcobertura = vlcobertura & " CON P. " & vlRegistro!gls_modalidad
            End If
        End If
        If vlRegistro!Cod_CoberCon <> 0 Then
            If Not IsNull(vlRegistro!GLS_COBERCON) Then
                vlcobertura = vlcobertura & " CON " & vlRegistro!GLS_COBERCON
            End If
        End If
        If vlRegistro!Cod_DerCre = "S" Then
            vlcobertura = vlcobertura & " CON D.CRECER"
        End If
        
        If vlRegistro!Cod_DerGra = "S" Then
            vlcobertura = vlcobertura & " Y CON GRATIFICACIÓN"
        End If
    End If
    vlRegistro.Close
    

   vlRptGlsCauEndoso = ""
   vlRptGlsFactorEndoso = ""
   vlRptMtoRtaMod = 0
   vlRptMtoPension = 0
      
   vgSql = ""
   vgSql = "SELECT mto_pensionori,mto_pensioncal,fec_efecto, "
   vgSql = vgSql & "cod_cauendoso,cod_tipendoso "
   vgSql = vgSql & "FROM PP_TMAE_ENDOSO "
   vgSql = vgSql & "WHERE "
   vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
   vgSql = vgSql & "num_endoso = " & vlRptNumEndosoEnd & " "
   Set vgRegistro = vgConexionBD.Execute(vgSql)
   If Not vgRegistro.EOF Then
      'vlRptNumEndoso = (vgRegistro!num_endoso)
      vlRptGlsCauEndoso = Trim(fgBuscarGlosaElemento(vgCodTabla_CauEnd, Trim(vgRegistro!cod_cauendoso)))
      vlRptFechaVigEndoso = DateSerial(Mid((vgRegistro!FEC_EFECTO), 1, 4), Mid((vgRegistro!FEC_EFECTO), 5, 2), Mid((vgRegistro!FEC_EFECTO), 7, 2))
      vlRptMtoPension = Format((vgRegistro!mto_pensioncal), "#,#0.00")
      vlRptMtoPensionOri = Format((vgRegistro!mto_pensionori), "#,#0.00")
      If vlRptMtoPensionOri <> vlRptMtoPension Then
         If vlRptMtoPensionOri > vlRptMtoPension Then
            vlRptMtoRtaMod = Format((vlRptMtoPensionOri - vlRptMtoPension), "#0.00")
            vlRptGlsFactorEndoso = Trim(clRptDisminuye)
         End If
         If vlRptMtoPensionOri < vlRptMtoPension Then
            vlRptMtoRtaMod = Format((vlRptMtoPension - vlRptMtoPensionOri), "#0.00")
            vlRptGlsFactorEndoso = Trim(clRptAumenta)
         End If
      Else
          'CMV 20050928 I
          'Modificado para que en el informe muestre: "La Renta se mantiene en"
          'junto al valor de la renta original y no : "La Renta se mantiene en"
          'junto al valor de la modificación que sería 0.
          'vlRptMtoRtaMod = 0
          vlRptMtoRtaMod = vlRptMtoPensionOri
          'CMV 20050928 F
          vlRptGlsFactorEndoso = Trim(clRptMantiene)
      End If
   End If
   vgRegistro.Close
      
   vgQuery = ""
   vgQuery = vgQuery & "{PP_TMAE_ENDPOLIZA.num_poliza} = '" & vlGlobalNumPoliza & "' AND "
   vgQuery = vgQuery & "{PP_TMAE_ENDPOLIZA.num_endoso} = " & (vlRptNumEndosoEnd) & " "
           
   Rpt_Reporte.Reset
   Rpt_Reporte.WindowState = crptMaximized
   Rpt_Reporte.ReportFileName = vlArchivo     'App.Path & "\Rpt_Areas.rpt"
   Rpt_Reporte.Connect = vgRutaDataBase       ' o App.Path & "\Nestle.mdb"
   Rpt_Reporte.SelectionFormula = vgQuery

   Rpt_Reporte.Formulas(0) = ""
   Rpt_Reporte.Formulas(1) = ""
   Rpt_Reporte.Formulas(2) = ""
   Rpt_Reporte.Formulas(3) = ""
   Rpt_Reporte.Formulas(4) = ""
   Rpt_Reporte.Formulas(5) = ""
   Rpt_Reporte.Formulas(6) = ""
   Rpt_Reporte.Formulas(7) = ""
   Rpt_Reporte.Formulas(8) = ""
   Rpt_Reporte.Formulas(9) = ""
   Rpt_Reporte.Formulas(10) = ""
   Rpt_Reporte.Formulas(11) = ""
   Rpt_Reporte.Formulas(12) = ""
   Rpt_Reporte.Formulas(13) = ""
   Rpt_Reporte.Formulas(14) = ""
   Rpt_Reporte.Formulas(15) = ""
   Rpt_Reporte.Formulas(16) = ""
   Rpt_Reporte.Formulas(17) = ""
   Rpt_Reporte.Formulas(18) = ""
   Rpt_Reporte.Formulas(19) = ""
   Rpt_Reporte.Formulas(20) = ""
   Rpt_Reporte.Formulas(21) = ""
   Rpt_Reporte.Formulas(22) = ""
   Rpt_Reporte.Formulas(23) = ""
   Rpt_Reporte.Formulas(24) = ""
         
   Rpt_Reporte.Formulas(0) = "NombreCompania = '" & vgNombreCompania & "'"
   Rpt_Reporte.Formulas(1) = "NombreSistema= '" & vgNombreSistema & "'"
   Rpt_Reporte.Formulas(2) = "NombreSubSistema= '" & vgNombreSubSistema & "'"
   Rpt_Reporte.Formulas(3) = "TipPension = '" & vlRptCodTipPension & "'"
   Rpt_Reporte.Formulas(4) = "Afp = '" & vlRptCodAfp & "'"
'   Rpt_Reporte.Formulas(5) = "TipRta = '" & vlRptCodTipRen & "'"
   Rpt_Reporte.Formulas(5) = "Concatenar = '" & vlcobertura & "'"
   Rpt_Reporte.Formulas(6) = "InstSalud = '" & vlRptCodInsSalud & "'"
   Rpt_Reporte.Formulas(7) = "NombreCausante = '" & vlRptNomBen & "'"
   Rpt_Reporte.Formulas(8) = "RutCausante = '" & vlRptRutBen & "'"
   Rpt_Reporte.Formulas(9) = "Direccion = '" & vlRptGlsDirBen & "'"
   Rpt_Reporte.Formulas(10) = "Fono = '" & vlRptFonoBen & "'"
   Rpt_Reporte.Formulas(11) = "Comuna = '" & vlRptComuna & "'"
   Rpt_Reporte.Formulas(12) = "Provincia = '" & vlRptProvincia & "'"
   Rpt_Reporte.Formulas(13) = "Region = '" & vlRptRegion & "'"
   Rpt_Reporte.Formulas(14) = "NombreInter = '" & vlRptNomInter & "'"
   Rpt_Reporte.Formulas(15) = "RutInter = '" & vlRptRutInter & "'"
   Rpt_Reporte.Formulas(16) = "ComisionInter = '" & vlRptComInter & "'"
'   Rpt_Reporte.Formulas(17) = "Origen = '" & clRptOrigen & "'"
'   Rpt_Reporte.Formulas(18) = "CodMoneda = '" & cgCodTipMonedaUF & "'"
   Rpt_Reporte.Formulas(19) = "MotivoEndoso = '" & vlRptGlsCauEndoso & "'"
   Rpt_Reporte.Formulas(20) = "GlsFactorEndoso = '" & vlRptGlsFactorEndoso & "'"
   Rpt_Reporte.Formulas(21) = "MtoRtaMod = '" & (Format(vlRptMtoRtaMod, "###,###,##0.00")) & "'"
   Rpt_Reporte.Formulas(22) = "MtoPension = '" & (Format(vlRptMtoPension, "###,###,##0.00")) & "'"
   Rpt_Reporte.Formulas(23) = "FechaVigEndoso = '" & (vlRptFechaVigEndoso) & "'"
   Rpt_Reporte.Formulas(24) = "MtoRtaOri = '" & (Format(vlRptMtoPensionOri, "###,###,##0.00")) & "'"
   Rpt_Reporte.Formulas(18) = "CodMoneda = '" & vlImpNomMoneda & "'"
   'Rpt_Reporte.Formulas(25) = "CodMonedaCor = '" & vlImpCodMoneda & "'"

   Rpt_Reporte.SubreportToChange = ""
   Rpt_Reporte.Destination = crptToWindow
   Rpt_Reporte.WindowState = crptMaximized
   Rpt_Reporte.WindowTitle = "Póliza de Endoso Preliminar"
   'Rpt_Reporte.SelectionFormula = ""
   Rpt_Reporte.Action = 1
   Screen.MousePointer = 0

Exit Function
Err_flImprimirEndosoPrev:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
    
End Function

Function flFormatearDatosPolizaDef() As Boolean
Dim vlSwPoliza As Boolean
'*On Error GoTo Err_flFormatearDatosPolizaDef
    
    vlSwPoliza = False
    
    flFormatearDatosPolizaDef = False
    
    'Obtener los Datos Faltantes de la Póliza Anterior
'    vgSql = ""
'    vgSql = "SELECT num_poliza,num_endoso,cod_afp,mto_pension,mto_pension, mto_pensiongar "
'    vgSql = vgSql & ",prc_tasactorea,fec_inipagopen "
'    vgSql = vgSql & ",cod_cuspp,ind_cob,cod_moneda,mto_valmoneda,"
'    vgSql = vgSql & "cod_cobercon,mto_facpenella,prc_facpenella, "
'    vgSql = vgSql & "cod_dercre,cod_dergra,prc_tasatir,fec_emision,"
'    vgSql = vgSql & "fec_dev,fec_inipencia,fec_pripago,Fec_finperdif,Fec_finpergar "
'    vgSql = vgSql & ", cod_tipreajuste, mto_valreajustetri, mto_valreajustemen, fec_devsol, ind_bendes, ind_bolelec " 'hqr 13/01/2011
'    vgSql = vgSql & "FROM PP_TMAE_ENDPOLIZA "
'    vgSql = vgSql & "WHERE "
'    vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
'    vgSql = vgSql & "num_endoso = " & vlGlobalNumEndoso & " "
'    vgSql = vgSql & "ORDER BY num_endoso DESC "
    
   
    vgSql = ""
    vgSql = "SELECT a.num_poliza,a.num_endoso,b.cod_afp,a.mto_pension,a.mto_pension, B.mto_pensiongar ,B.prc_tasactorea, substr(a.fec_pripago,1,6) || '01' fec_inipagopen ,B.cod_cuspp,a.ind_cob,a.cod_moneda,a.mto_valmoneda,a.cod_cobercon,a.mto_facpenella,"
    vgSql = vgSql & " a.prc_facpenella, a.Cod_DerCre , a.Cod_DerGra, B.prc_tasatir, B.Fec_Emision, a.fec_dev, a.Fec_IniPenCia, a.Fec_PriPago, a.Fec_finperdif, a.Fec_finpergar, a.Cod_TipReajuste, a.Mto_ValReajusteTri, a.Mto_ValReajusteMen, B.fec_devsol, B.ind_bendes, B.ind_bolelec"
    vgSql = vgSql & " FROM PP_TMAE_ENDPOLIZA a"
    vgSql = vgSql & " JOIN PP_TMAE_POLIZA B on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso"
    vgSql = vgSql & " WHERE a.num_poliza = '" & vlGlobalNumPoliza & "' AND a.num_endoso = " & vlGlobalNumEndoso & " ORDER BY a.num_endoso DESC"
    
    Select Case vlCodTipEndoso
        Case "A"
            Select Case vlCodCauEndoso
                Case "13"
                    vgSql = ""
                    vgSql = " SELECT a.num_poliza,a.num_endoso,b.cod_afp,a.mto_pension,a.mto_pension, b.mto_pensiongar ,b.prc_tasactorea, substr(a.fec_pripago,1,6) || '01' fec_inipagopen ,b.cod_cuspp,a.ind_cob,a.cod_moneda,a.mto_valmoneda,a.cod_cobercon,a.mto_facpenella,a.prc_facpenella,"
                    vgSql = vgSql & " a.Cod_DerCre , a.Cod_DerGra, B.prc_tasatir, B.Fec_Emision, a.fec_dev, a.Fec_IniPenCia, a.Fec_PriPago, a.Fec_finperdif, a.Fec_finpergar, a.Cod_TipReajuste, a.Mto_ValReajusteTri, a.Mto_ValReajusteMen, B.fec_devsol, B.ind_bendes, B.ind_bolelec"
                    vgSql = vgSql & " FROM PP_TMAE_ENDPOLIZA a"
                    vgSql = vgSql & " JOIN PP_TMAE_POLIZA B on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso"
                    vgSql = vgSql & " WHERE a.num_poliza = '" & vlGlobalNumPoliza & "' AND a.num_endoso = " & vlGlobalNumEndoso & " ORDER BY a.num_endoso DESC"
            End Select
        Case "O"
        
        Case "S"
            Select Case vlCodCauEndoso
                Case "09", "07"
                    vgSql = ""
                    vgSql = " SELECT a.num_poliza,a.num_endoso,b.cod_afp,a.mto_pension,a.mto_pension, b.mto_pensiongar ,b.prc_tasactorea, substr(a.fec_pripago,1,6) || '01' fec_inipagopen ,b.cod_cuspp,a.ind_cob,a.cod_moneda,a.mto_valmoneda,a.cod_cobercon,a.mto_facpenella,a.prc_facpenella,"
                    vgSql = vgSql & " a.Cod_DerCre , a.Cod_DerGra, B.prc_tasatir, B.Fec_Emision, a.fec_dev, a.Fec_IniPenCia, a.Fec_PriPago, a.Fec_finperdif, a.Fec_finpergar, a.Cod_TipReajuste, a.Mto_ValReajusteTri, a.Mto_ValReajusteMen, B.fec_devsol, B.ind_bendes, B.ind_bolelec"
                    vgSql = vgSql & " FROM PP_TMAE_ENDPOLIZA a"
                    vgSql = vgSql & " JOIN PP_TMAE_POLIZA B on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso"
                    vgSql = vgSql & " WHERE a.num_poliza = '" & vlGlobalNumPoliza & "' AND a.num_endoso = " & vlGlobalNumEndoso & " ORDER BY a.num_endoso DESC"
            End Select
        
    End Select
      
    Set vgRegistro = vgConectarBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
    
        vlCodTipPension = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
    
        vlNumPoliza = Trim(vgRegistro!num_poliza)
        vlNumEndoso = ((vgRegistro!num_endoso) + 1)
        vlCodAFP = (vgRegistro!cod_afp)
        vlPrcTasaCtoRea = IIf(IsNull(vgRegistro!prc_tasactorea), 0, (vgRegistro!prc_tasactorea))
        vlPrcTasaIntPerGar = (Txt_PMTasaPerGar)
        vlFecIniPagoPen = (vgRegistro!Fec_IniPagoPen)
        
        vlCodCuspp = vgRegistro!Cod_Cuspp
        vlIndCobertura = vgRegistro!Ind_Cob
        vlCodMoneda = vgRegistro!Cod_Moneda
        vlValMoneda = vgRegistro!Mto_ValMoneda
        vlCobCoberCon = vgRegistro!Cod_CoberCon
        vlMtoFacPenElla = vgRegistro!Mto_FacPenElla
        vlPrcFacPenElla = vgRegistro!Prc_FacPenElla
        vlCodDerCrecer = vgRegistro!Cod_DerCre
        vlCodDerGratificacion = vgRegistro!Cod_DerGra
        vlFecEmision = vgRegistro!Fec_Emision
        vlFecDevengue = vgRegistro!fec_dev
        vlFecIniPenCia = vgRegistro!Fec_IniPenCia
        vlFecPriPago = vgRegistro!Fec_PriPago
        vlPrcTasaTir = vgRegistro!prc_tasatir
        vlCodTipReajuste = vgRegistro!Cod_TipReajuste
        vlMtoValReajusteTri = IIf(IsNull(vgRegistro!Mto_ValReajusteTri), 0, vgRegistro!Mto_ValReajusteTri)
        vlMtoValReajusteMen = IIf(IsNull(vgRegistro!Mto_ValReajusteMen), 0, vgRegistro!Mto_ValReajusteMen)
        vlGlobalNumEndosoCrear = vlNumEndoso
        vlMtoPension = vgRegistro!Mto_Pension
        vlMtoPensionGar = vgRegistro!Mto_PensionGar
        vlFecDevSol = IIf(IsNull(vgRegistro!FEC_DEVSOL), "", vgRegistro!FEC_DEVSOL)
        vliEstDsco = IIf(IsNull(vgRegistro!IND_BENDES), "", vgRegistro!IND_BENDES)
        vliEstBelc = IIf(IsNull(vgRegistro!ind_bolelec), "", vgRegistro!ind_bolelec)
        vlSwPoliza = True
    End If
    vgRegistro.Close
    
    If (vlSwPoliza = True) Then
        vlNumero = InStr(Cmb_PMTipPen.Text, "-")
        vlCodTipPension = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
        vlNumero = InStr(Cmb_PMEstVig.Text, "-")
        vlCodEstado = Trim(Mid(Cmb_PMEstVig.Text, 1, vlNumero - 1))
        vlNumero = InStr(Cmb_PMTipRta.Text, "-")
        vlCodTipRen = Trim(Mid(Cmb_PMTipRta.Text, 1, vlNumero - 1))
        vlNumero = InStr(Cmb_PMMod.Text, "-")
        vlCodModalidad = Trim(Mid(Cmb_PMMod.Text, 1, vlNumero - 1))
        vlNumCargas = (Msf_BMGrilla.rows - 1)
        vlFecVigencia = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
        vlFecTerVigencia = Format(CDate(Trim(Txt_PMTerVig)), "yyyymmdd")
        vlMtoPrima = (Txt_PMMtoPrima)
        
        If Cmd_Calcular.Enabled = True Then
            If vlCodTipEndoso <> "A" Then
                vlMtoPension = (Lbl_EndMtoPensionOrig)
            Else
                vlMtoPension = (txt_EndMtoPensionCalc)
            End If
        End If
        
        If Cmd_Calcular.Enabled = True Then
            If vlCodTipEndoso <> "A" Then
                vlMtoPensionGar = (lbl_EndMtoPensionOrigGar)
            Else
                vlMtoPensionGar = (txt_EndMtoPensionCalcGar)
            End If
        End If
        
        'vlMtoPension = (Lbl_EndMtoPensionCalc)
        vlNumMesDif = Txt_PMMesDif
        vlNumMesGar = Txt_PMMesGar
        vlPrcTasaCe = (Txt_PMTasaCto)
        vlPrcTasaVta = (Txt_PMTasaVta)
        vlPrcTasaIntPerGar = (Txt_PMTasaPerGar)
        vlGlsUsuarioCrea = vgUsuario
        vlFecCrea = Format(Date, "yyyymmdd")
        vlHorCrea = Format(Time, "hhmmss")

        vlFecIniPenCia = fgCalcularFechaIniPagoPensiones(vlFecDevengue, CLng(vlNumMesDif))
        'Determinar la fecha de Fin del Periodo Diferido
        vlFecTerPagoPenDif = fgCalcularFechaFinPerDiferido(vlFecDevengue, CLng(vlNumMesDif))
        'Determinar la fecha de Fin del Periodo Garantizado
        vlFecTerPagoPenGar = fgCalcularFechaFinPerGarantizado(vlFecDevengue, CLng(vlNumMesDif), CLng(vlNumMesGar))

'I--- ABV 01/11/2007 ---
'        vlFecIniPagoPen = vlFecDevengue
'        vlFecPriPago = vlFecDevengue
'        If (vlNumMesDif = 0) Then
'            'vlFecIniPagoPen = Mid(vlFecDevengue, 1, 6) & "01"
'            'vlFecPriPago = Mid(vlFecDevengue, 1, 6) & "01"
'        Else
'            vlFecIniPagoPen = vlFecIniPenCia
'            vlFecPriPago = vlFecIniPenCia
'        End If
'F--- ABV 01/11/2007 ---
        vlheren = 0
        If vlCodModalidad = 3 Then
            vgSql = "SELECT * FROM PP_TMAE_ENDBEN WHERE NUM_POLIZA='" & vlGlobalNumPoliza & "' AND COD_DERPEN=99 "
            Set vgRegistro = vgConectarBD.Execute(vgSql)
            If vgRegistro.EOF Then
               'vlMtoPension = 0
               'vlNumMesDif = 0
               vlCodTipRen = "1"
               vlheren = 1
            End If
            vgRegistro.Close
        End If

        
        flFormatearDatosPolizaDef = True
        
    End If
    
Exit Function
Err_flFormatearDatosPolizaDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

''Function flActualizarPolizaDef()
''On Error GoTo Err_flActualizarPolizaDef
''
''    vgSql = ""
''    vgSql = " UPDATE PP_TMAE_POLIZA SET "
''    vgSql = vgSql & " cod_tippension = '" & vlCodTipPension & "' , "
''    vgSql = vgSql & " cod_estado = '" & vlCodEstado & "' , "
''    vgSql = vgSql & " cod_tipren = '" & vlCodTipRen & "' , "
''    vgSql = vgSql & " num_cargas = " & vlNumCargas & " , "
''    vgSql = vgSql & " cod_modalidad = '" & vlCodModalidad & "' , "
''    vgSql = vgSql & " fec_vigencia = '" & vlFecVigencia & "' , "
''    vgSql = vgSql & " fec_tervigencia = '" & vlFecTerVigencia & "' , "
''    vgSql = vgSql & " mto_prima = " & vlMtoPrima & " , "
''    vgSql = vgSql & " num_mesdif = " & vlNumMesDif & " , "
''    vgSql = vgSql & " num_mesgar = " & vlNumMesGar & " , "
''    vgSql = vgSql & " prc_tasace = " & vlPrcTasaCE & " , "
''    vgSql = vgSql & " prc_tasavta = " & vlPrcTasaVta & " , "
''    vgSql = vgSql & " prc_tasaintpergar = " & vlPrcTasaIntPerGar & "  "
''    vgSql = vgSql & " WHERE num_poliza = '" & Trim(Txt_PenPoliza.Text) & "' AND "
''    vgSql = vgSql & " num_endoso = " & Trim(Lbl_End) & " "
''
''    vgConexionBD.Execute vgSql
''
''Exit Function
''Err_flActualizarPolizaDef:
''    Screen.MousePointer = 0
''    Select Case Err
''        Case Else
''        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
''    End Select
''
''End Function




Function flInsertaPolizasProdDef()

vgSql = ""
vgSql = "Insert into PD_TMAE_POLIZA"
  vgSql = vgSql & " (NUM_POLIZA, NUM_ENDOSO, NUM_COT, NUM_CORRELATIVO, NUM_OPERACION,"
  vgSql = vgSql & "  NUM_ARCHIVO, COD_TRAPAGOPEN, FEC_TRAPAGOPEN, COD_AFP, COD_ISAPRE,"
  vgSql = vgSql & "  COD_TIPPENSION, COD_VEJEZ, COD_ESTCIVIL, COD_CUSPP, COD_TIPOIDENAFI,"
  vgSql = vgSql & "  NUM_IDENAFI, GLS_DIRECCION, COD_DIRECCION, GLS_FONO, GLS_CORREO,"
  vgSql = vgSql & "  COD_VIAPAGO, COD_TIPCUENTA, COD_BANCO, NUM_CUENTA, COD_SUCURSAL,"
  vgSql = vgSql & "  FEC_SOLICITUD, FEC_INGVIGENCIA, FEC_VIGENCIA, FEC_DEV, FEC_ACEPTA,"
  vgSql = vgSql & "  FEC_PRIPAGO, COD_MONEDAFON, MTO_MONEDAFON, MTO_PRIUNIFON, MTO_CTAINDFON,"
  vgSql = vgSql & "  MTO_BONOFON, MTO_APOADI, MTO_PRIUNI, MTO_CTAIND, MTO_BONO,"
  vgSql = vgSql & "  PRC_TASARPRT, COD_TIPOIDENCOR, NUM_IDENCOR, PRC_CORCOM, MTO_CORCOM,"
  vgSql = vgSql & "  PRC_CORCOMREAL, NUM_ANNOJUB, NUM_CARGAS, IND_COB, COD_BENSOCIAL,"
  vgSql = vgSql & "  COD_MONEDA, MTO_VALMONEDA, MTO_PRIUNIMOD, MTO_CTAINDMOD, MTO_BONOMOD,"
  vgSql = vgSql & "  COD_TIPREN, NUM_MESDIF, COD_MODALIDAD, NUM_MESGAR, COD_COBERCON,"
  vgSql = vgSql & "  MTO_FACPENELLA, PRC_FACPENELLA, COD_DERCRE, COD_DERGRA, PRC_RENTAAFP,"
  vgSql = vgSql & "  PRC_RENTAAFPORI, PRC_RENTATMP, MTO_CUOMOR, PRC_TASACE, PRC_TASAVTA,"
  vgSql = vgSql & "  PRC_TASATIR, PRC_TASAPERGAR, MTO_CNU, MTO_PRIUNISIM, MTO_PRIUNIDIF,"
  vgSql = vgSql & "  MTO_PENSION, MTO_PENSIONGAR, MTO_CTAINDAFP, MTO_RENTATMPAFP, MTO_RESMAT,"
  vgSql = vgSql & "  MTO_VALPREPENTMP, MTO_PERCON, PRC_PERCON, MTO_SUMPENSION, MTO_PENANUAL,"
  vgSql = vgSql & "  MTO_RMPENSION, MTO_RMGTOSEP, COD_TIPCOT, COD_ESTCOT, COD_USUARIO,"
  vgSql = vgSql & "  COD_SUCURSALUSU, FEC_INIPAGOPEN, COD_USUARIOCREA, FEC_CREA, HOR_CREA,"
  vgSql = vgSql & "  COD_USUARIOMODI, FEC_MODI, HOR_MODI, COD_SUCCORREDOR, FEC_FINPERDIF,"
  vgSql = vgSql & "  FEC_FINPERGAR, GLS_NACIONALIDAD, IND_RECALCULO, FEC_EMISION, FEC_INIPENCIA,"
  vgSql = vgSql & "  MTO_RMGTOSEPRV, FEC_CALCULO, MTO_AJUSTEIPC, MTO_APOADIFON, MTO_APOADIMOD,"
  vgSql = vgSql & "  COD_TIPVIA, GLS_NOMVIA, GLS_NUMDMC, GLS_INTDMC, COD_TIPZON,"
  vgSql = vgSql & "  GLS_NOMZON, GLS_REFERENCIA, COD_TIPREAJUSTE, MTO_VALREAJUSTETRI, MTO_VALREAJUSTEMEN, GLS_TELBEN2, IND_BENDES, NUM_CUENTA_CCI)"
   vgSql = vgSql & " select  '" & vlGlobalNumPoliza & "', "
   vgSql = vgSql & vlGlobalNumEndosoCrear & " , NUM_COT, NUM_CORRELATIVO, NUM_OPERACION, NUM_ARCHIVO,"
   vgSql = vgSql & " COD_TRAPAGOPEN, FEC_TRAPAGOPEN, '" & vlCodAFP & "', COD_ISAPRE, COD_TIPPENSION,"
   vgSql = vgSql & " COD_VEJEZ, COD_ESTCIVIL, COD_CUSPP, COD_TIPOIDENAFI, NUM_IDENAFI,"
   vgSql = vgSql & " '" & vlDefGlsDirBen & "', '" & vlDefCodDireccion & "', '" & vlDefGlsFonoBen & "', '" & vlDefGlsCorreoBen & "', COD_VIAPAGO,"
   vgSql = vgSql & " COD_TIPCUENTA, COD_BANCO, NUM_CUENTA, COD_SUCURSAL, FEC_SOLICITUD, FEC_INGVIGENCIA,"
   vgSql = vgSql & " FEC_VIGENCIA, FEC_DEV, FEC_ACEPTA, FEC_PRIPAGO, COD_MONEDAFON, MTO_MONEDAFON,"
   vgSql = vgSql & " MTO_PRIUNIFON, MTO_CTAINDFON, MTO_BONOFON, MTO_APOADI, MTO_PRIUNI, MTO_CTAIND,"
   vgSql = vgSql & " MTO_BONO, PRC_TASARPRT, COD_TIPOIDENCOR, NUM_IDENCOR, PRC_CORCOM, MTO_CORCOM, PRC_CORCOMREAL,"
   vgSql = vgSql & " NUM_ANNOJUB, NUM_CARGAS, IND_COB, COD_BENSOCIAL, COD_MONEDA, MTO_VALMONEDA, MTO_PRIUNIMOD,"
   vgSql = vgSql & " MTO_CTAINDMOD, MTO_BONOMOD, COD_TIPREN, NUM_MESDIF, COD_MODALIDAD, NUM_MESGAR,"
   vgSql = vgSql & " COD_COBERCON, MTO_FACPENELLA, PRC_FACPENELLA, COD_DERCRE, COD_DERGRA, PRC_RENTAAFP,"
   vgSql = vgSql & " PRC_RENTAAFPORI, PRC_RENTATMP, MTO_CUOMOR, PRC_TASACE, PRC_TASAVTA, PRC_TASATIR,"
   vgSql = vgSql & " PRC_TASAPERGAR, MTO_CNU,MTO_PRIUNISIM, MTO_PRIUNIDIF, MTO_PENSION, MTO_PENSIONGAR,"
   vgSql = vgSql & " MTO_CTAINDAFP, MTO_RENTATMPAFP, MTO_RESMAT, MTO_VALPREPENTMP, MTO_PERCON,"
   vgSql = vgSql & " PRC_PERCON, MTO_SUMPENSION, MTO_PENANUAL, MTO_RMPENSION, MTO_RMGTOSEP, COD_TIPCOT,"
   vgSql = vgSql & " COD_ESTCOT, COD_USUARIO, COD_SUCURSALUSU, FEC_INIPAGOPEN, COD_USUARIOCREA,FEC_CREA,"
   vgSql = vgSql & " HOR_CREA, '" & vlGlsUsuarioCrea & "', '" & vlFecCrea & "', '" & vlHorCrea & "', COD_SUCCORREDOR, FEC_FINPERDIF,"
   vgSql = vgSql & " FEC_FINPERGAR, GLS_NACIONALIDAD, IND_RECALCULO, FEC_EMISION, FEC_INIPENCIA,"
   vgSql = vgSql & " MTO_RMGTOSEPRV, FEC_CALCULO, MTO_AJUSTEIPC, MTO_APOADIFON, MTO_APOADIMOD, COD_TIPVIA,"
   vgSql = vgSql & " GLS_NOMVIA, GLS_NUMDMC, GLS_INTDMC, COD_TIPZON, GLS_NOMZON, GLS_REFERENCIA, COD_TIPREAJUSTE,"
   vgSql = vgSql & " Mto_ValReajusteTri , Mto_ValReajusteMen, '" & vlDefglsTelben2 & "', IND_BENDES, NUM_CUENTA_CCI "
   vgSql = vgSql & " From PD_TMAE_POLIZA"
   vgSql = vgSql & " Where num_poliza =  '" & vlGlobalNumPoliza & "' and num_endoso=(select max(num_endoso) from pd_tmae_poliza where num_poliza='" & vlGlobalNumPoliza & "')"
   vgConectarBD.Execute vgSql

Exit Function
Err_flInsertarPolizaDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flActualizaPensionAct() 'As Boolean
    
    If vlCodTipEndoso = "A" Then
        vgSql = ""
        vgSql = "UPDATE PP_TMAE_PENSIONACT SET MTO_PENSION=" & str(vlMtoPensionCal) & ",MTO_PENSIONGAR=" & IIf(vlNumMesGar > 0, str(vlMtoPensionGar), 0) & " "
        vgSql = vgSql & " WHERE NUM_POLIZA='" & vlGlobalNumPoliza & "' AND num_endoso = " & vlGlobalNumEndosoCrear & ""
        vgSql = vgSql & " AND FEC_DESDE=(SELECT MAX(FEC_DESDE) FROM PP_TMAE_PENSIONACT WHERE num_poliza='" & vlGlobalNumPoliza & "')"
        vgConectarBD.Execute vgSql
        
    'COPRTEC
    Dim fec_desde As String
    
    
 
    vgSql = "SELECT MAX(FEC_DESDE)as FEC_DESDE FROM PP_TMAE_PENSIONACT WHERE num_poliza='" & vlGlobalNumPoliza & "' "
    Set vgRegistro = vgConexionBD.Execute(vgSql)
    If Not IsNull(vgRegistro!fec_desde) Then
    'mvg 20171024
       'fec_desde = (vgRegistro!numero)
       fec_desde = "" & (vgRegistro!fec_desde)
       
    End If
    
    vlLog_tabla = "PP_TMAE_PENSIONACT"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.FEC_DESDE"
    vlLog_valtabla = "" & vlGlobalNumPoliza & "," & vlGlobalNumEndosoCrear & "," & fec_desde & ""
    vlLog_trans = "UPD"
    Call flLog_Tabla
    
    End If

Exit Function
Err_flInsertarPolizaDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function


Function flInsertarPolizaDef() 'As Boolean
'*On Error GoTo Err_flInsertarPolizaDef
    
    'flInsertarPolizaDef = False
    
    vgSql = ""
    vgSql = "INSERT INTO PP_TMAE_POLIZA "
    vgSql = vgSql & "(num_poliza,num_endoso,cod_afp,cod_tippension, "
    vgSql = vgSql & "cod_estado,cod_tipren,cod_modalidad,num_cargas, "
    vgSql = vgSql & "fec_vigencia,fec_tervigencia,mto_prima,mto_pension, "
    vgSql = vgSql & "mto_pensiongar, "
    vgSql = vgSql & "num_mesdif,num_mesgar,prc_tasace,prc_tasavta, "
    vgSql = vgSql & "prc_tasactorea,prc_tasaintpergar,fec_inipagopen, "
    vgSql = vgSql & "cod_usuariocrea,fec_crea,hor_crea "
    vgSql = vgSql & ",Cod_Cuspp,Ind_Cob,Cod_Moneda,Mto_ValMoneda,"
    vgSql = vgSql & "Cod_CoberCon,Mto_FacPenElla,Prc_FacPenElla,"
    vgSql = vgSql & "Cod_DerCre,Cod_DerGra,Fec_Emision,fec_dev,"
    vgSql = vgSql & "Fec_IniPenCia,Fec_PriPago,prc_tasatir "
    If (vlFecTerPagoPenGar <> "") Then vgSql = vgSql & ",Fec_finpergar"
    If (vlFecTerPagoPenDif <> "") Then vgSql = vgSql & ",Fec_finperdif"
    vgSql = vgSql & ",Fec_efecto "
    vgSql = vgSql & ",cod_tipreajuste, mto_valreajustetri, mto_valreajustemen "
    If vlFecDevSol <> "" Then
        vgSql = vgSql & ",fec_devsol" '& Str(fec_devsol)
    End If
    If vliEstDsco <> "" Then
        vgSql = vgSql & ", ind_bendes"
    End If
    If vliEstBelc <> "" Then
        vgSql = vgSql & ", ind_bolelec"
    End If
    If vlheren = 1 Then
        vgSql = vgSql & ", ind_heren"
    End If
    vgSql = vgSql & " ) VALUES ( "
    vgSql = vgSql & "'" & vlGlobalNumPoliza & "', "
    vgSql = vgSql & " " & vlGlobalNumEndosoCrear & ", "
    vgSql = vgSql & "'" & vlCodAFP & "', "
    vgSql = vgSql & "'" & vlCodTipPension & "', "
    vgSql = vgSql & "'" & vlCodEstado & "', "
    vgSql = vgSql & "'" & vlCodTipRen & "', "
    vgSql = vgSql & "'" & vlCodModalidad & "', "
    vgSql = vgSql & " " & vlNumCargas & ", "
    vgSql = vgSql & "'" & vlFecVigencia & "', "
    vgSql = vgSql & "'" & vlFecTerVigencia & "', "
    vgSql = vgSql & " " & str(vlMtoPrima) & ", "
    vgSql = vgSql & " " & str(vlMtoPension) & ", "
    If (vlNumMesGar > 0) Then vgSql = vgSql & " " & str(vlMtoPensionGar) & ", " Else vgSql = vgSql & " 0, "
    vgSql = vgSql & " " & vlNumMesDif & ", "
    vgSql = vgSql & " " & vlNumMesGar & ", "
    vgSql = vgSql & " " & str(vlPrcTasaCe) & ", "
    vgSql = vgSql & " " & str(vlPrcTasaVta) & ", "
    vgSql = vgSql & " " & str(vlPrcTasaCtoRea) & ", "
    vgSql = vgSql & " " & str(vlPrcTasaIntPerGar) & ", "
    vgSql = vgSql & "'" & Trim(vlFecIniPagoPen) & "', "
    vgSql = vgSql & "'" & Trim(vlGlsUsuarioCrea) & "', "
    vgSql = vgSql & "'" & Trim(vlFecCrea) & "', "
    vgSql = vgSql & "'" & Trim(vlHorCrea) & "'"
    vgSql = vgSql & ",'" & Trim(vlCodCuspp) & "',"
    vgSql = vgSql & "'" & Trim(vlIndCobertura) & "', "
    vgSql = vgSql & "'" & Trim(vlCodMoneda) & "', "
    vgSql = vgSql & " " & str(vlValMoneda) & ", "
    vgSql = vgSql & "'" & Trim(vlCobCoberCon) & "', "
    vgSql = vgSql & " " & str(vlMtoFacPenElla) & ", "
    vgSql = vgSql & " " & str(vlPrcFacPenElla) & ", "
    vgSql = vgSql & "'" & Trim(vlCodDerCrecer) & "', "
    vgSql = vgSql & "'" & Trim(vlCodDerGratificacion) & "', "
    vgSql = vgSql & "'" & Trim(vlFecEmision) & "', "
    vgSql = vgSql & "'" & Trim(vlFecDevengue) & "', "
    vgSql = vgSql & "'" & Trim(vlFecIniPenCia) & "', "
    vgSql = vgSql & "'" & Trim(vlFecPriPago) & "', "
    vgSql = vgSql & " " & str(vlPrcTasaTir) & " "
    If (vlFecTerPagoPenGar <> "") Then vgSql = vgSql & ",'" & Trim(vlFecTerPagoPenGar) & "' "
    If (vlFecTerPagoPenDif <> "") Then vgSql = vgSql & ",'" & Trim(vlFecTerPagoPenDif) & "' "
    vgSql = vgSql & ",'" & Trim(vlFecEfectoEnd) & "' "
    vgSql = vgSql & ",'" & Trim(vlCodTipReajuste) & "' "
    vgSql = vgSql & "," & str(vlMtoValReajusteTri)
    vgSql = vgSql & "," & str(vlMtoValReajusteMen)
    If vlFecDevSol <> "" Then
        vgSql = vgSql & "," & str(vlFecDevSol)
    End If
    If vliEstDsco <> "" Then
        vgSql = vgSql & ",'" & vliEstDsco & "'"
    End If
    If vliEstBelc <> "" Then
        vgSql = vgSql & ",'" & vliEstBelc & "'"
    End If
    If vlheren = 1 Then
        vgSql = vgSql & ",'" & vlheren & "'"
    End If
    vgSql = vgSql & ")"
    
    vgConectarBD.Execute vgSql

    'flInsertarPolizaDef = True
    
Exit Function
Err_flInsertarPolizaDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function
         
Function flFormatearDatosBeneficiarioDef(iFila As Integer) As Boolean
'*On Error GoTo Err_flFormatearDatosBeneficiarioDef

    flFormatearDatosBeneficiarioDef = False
    vlBenefNuevo = False
    
    Msf_BMGrilla.row = iFila
    
    Msf_BMGrilla.Col = 0
    vlNumOrden = Msf_BMGrilla.Text
    Msf_BMGrilla.Col = 1
    vlCodTipoIdenBen = fgObtenerCodigo_TextoCompuesto(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 2
    vlNumIdenBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 3
    vlNomBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 4
    vlNomSegBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 5
    vlPaternoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 6
    vlMaternoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 7
    vlCodPar = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 8
    vlCodGruFam = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 9
    vlCodSexo = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 10
    vlCodSitInv = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 11
    vlCodDerpen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 12
    vlCodDerCre = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 13
    vlNumPoliza = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 14
    vlNumEndoso = (Msf_BMGrilla + 1)
    Msf_BMGrilla.Col = 15
    vlCodCauInv = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 16
    vlFecNacBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Msf_BMGrilla.Col = 17
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecNacHM = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecNacHM = ""
    End If
    Msf_BMGrilla.Col = 18
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecInvBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecInvBen = ""
    End If
    
  
    
    Msf_BMGrilla.Col = 21
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecFallBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecFallBen = ""
    End If
    Msf_BMGrilla.Col = 22
    vlCodEstPension = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 23
    vlCodMotReqPen = Trim(Msf_BMGrilla.Text)
  
    Msf_BMGrilla.Col = 25
    vlCodCauSusBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 26
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecSusBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecSusBen = ""
    End If
    Msf_BMGrilla.Col = 27
    vlFecIniPagoPen = Format(Trim(Msf_BMGrilla.Text), "yyyymmdd")
    Msf_BMGrilla.Col = 28
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecTerPagoPenGar = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecTerPagoPenGar = ""
    End If
    Msf_BMGrilla.Col = 29
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecMatrimonio = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecMatrimonio = ""
    End If
    
    ' Obtiene el Pension gar
    Msf_BMGrilla.Col = 30
    vlPrcPensionGar = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 24
    vlMtoPensionGarB = Format(CDbl(vlMtoPensionGar) * (vlPrcPensionGar / 100), "###0.00") ' Trim(Msf_BMGrilla.Text)
    '*************
    
    ' Obtiene Pension
    Msf_BMGrilla.Col = 20
    vlPrcPension = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 19
    vlMtoPensionB = Format(CDbl(vlMtoPension) * (vlPrcPension / 100), "###0.00")  'Trim(Msf_BMGrilla.Text)
    '*******************
    
    Msf_BMGrilla.Col = 31
    vlPrcPensionLeg = (Msf_BMGrilla.Text)
    
    'Variables a completar, de acuerdo a si se trata de un nvo.
    'Beneficiario o uno ya existente
    'vlCodDireccion = ""
    'vlGlsDirBen = ""
    'vlGlsFonoBen = ""
    'vlGlsCorreoBen = ""
    '
    'vlCodInsSalud = ""
    'vlCodModSalud = ""
    'vlMtoPlanSalud = 0
    '
    'vlCodViaPago = ""
    'vlCodBanco = ""
    'vlCodTipCuenta = ""
    'vlNumCuenta = ""
    'vlCodSucursal = ""
    'vlCodCajaCompen = ""
    
    Msf_BMGrilla.Col = 32
    vlCodDireccion = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 33
    vlGlsDirBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 34
    vlGlsFonoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 35
    vlGlsCorreoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 36
    vlGlsTelben2 = Trim(Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 37
    vlCodBanco = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 38
    vlCodTipcta = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 39
    vlcodmonbco = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 40
    vlnumctabco = (Msf_BMGrilla.Text)
    'mvg 20170904
    Msf_BMGrilla.Col = 41
    vlBolelec = (Msf_BMGrilla.Text)
    
    'GCP-FRACTAL 25032019
     Msf_BMGrilla.Col = 42
     vlnumctacci = (Msf_BMGrilla.Text)
  
     Msf_BMGrilla.Col = 43
     vlCodViaPago = (Msf_BMGrilla.Text)
                
     Msf_BMGrilla.Col = 44
     vlCodSucursal = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 45
     vl_ConTratDatos_Ben = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 46
     vl_ConUsoDatosCom_Ben = (Msf_BMGrilla.Text)
    
     
     Msf_BMGrilla.Col = 49
     vl_COD_MODTIPOCUENTA_MANC = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 50
     vl_COD_TIPODOC_MANC = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 51
     vl_NUM_DOC_MANC = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 52
     vl_NOMBRE_MANC = (Msf_BMGrilla.Text)
     
     Msf_BMGrilla.Col = 53
     vl_APELLIDO_MANC = (Msf_BMGrilla.Text)
    
    
    vlCodInsSalud = vlDefCodInsSalud
    vlCodModSalud = vlDefCodModSalud
    vlMtoPlanSalud = vlDefMtoPlanSalud
    
    'vlCodViaPago = vlDefCodViaPago
    'vlcodbanco = vlDefCodBanco
    'vlCodTipCuenta = vlDefCodTipCuenta
    'vlNumCuenta = vlDefNumCuenta
    'vlCodSucursal = vlDefCodSucursal
    vlCodCajaCompen = vlDefCodCajaCompen
    
    'Verificar si se trata de un nuevo Beneficiario para asignarles los valores por defecto
    'o si se deben obtener los datos del Beneficiario desde el Endoso anterior
    If (iFila < (Msf_BOGrilla.rows)) Then
        
        'Obtener los datos de la Tabla de Beneficiarios
        vgSql = "SELECT "
        vgSql = vgSql & "GLS_DIRBEN,Cod_Direccion,GLS_FONOBEN,GLS_CORREOBEN,"
        vgSql = vgSql & "Cod_InsSalud,COD_MODSALUD,MTO_PLANSALUD," 'Cod_CajaCompen,"
        vgSql = vgSql & "Cod_ViaPago,Cod_Banco,Cod_TipCuenta,Num_Cuenta,"
        vgSql = vgSql & "Cod_Sucursal "
        vgSql = vgSql & "FROM PP_TMAE_BEN WHERE "
        vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' "
        vgSql = vgSql & "and num_endoso = " & vlGlobalNumEndoso & " "
        vgSql = vgSql & "and num_orden = " & vlNumOrden & " "
        Set vgRs4 = vgConectarBD.Execute(vgSql)
        If Not vgRs4.EOF Then
'            vlCodDireccion = IIf(IsNull(vgRs4!Cod_Direccion), vlDefCodDireccion, vgRs4!Cod_Direccion)
'            vlGlsDirBen = IIf(IsNull(vgRs4!Gls_DirBen), vlDefGlsDirBen, vgRs4!Gls_DirBen)
'            vlGlsFonoBen = IIf(IsNull(vgRs4!Gls_FonoBen), vlDefGlsFonoBen, vgRs4!Gls_FonoBen)
'            vlGlsCorreoBen = IIf(IsNull(vgRs4!Gls_CorreoBen), vlDefGlsCorreoBen, vgRs4!Gls_CorreoBen)
            
            vlCodInsSalud = IIf(IsNull(vgRs4!Cod_InsSalud), vlDefCodInsSalud, vgRs4!Cod_InsSalud)
            vlCodModSalud = IIf(IsNull(vgRs4!Cod_ModSalud), vlDefCodModSalud, vgRs4!Cod_ModSalud)
            vlMtoPlanSalud = IIf(IsNull(vgRs4!Mto_PlanSalud), vlDefMtoPlanSalud, vgRs4!Mto_PlanSalud)
            
            vlCodViaPago = IIf(IsNull(vgRs4!Cod_ViaPago), vlDefCodViaPago, vgRs4!Cod_ViaPago)
            'vlcodbanco = IIf(IsNull(vgRs4!Cod_Banco), vlDefCodBanco, vgRs4!Cod_Banco)
            vlCodTipCuenta = IIf(IsNull(vgRs4!Cod_TipCuenta), vlDefCodTipCuenta, vgRs4!Cod_TipCuenta)
            vlNumCuenta = IIf(IsNull(vgRs4!Num_Cuenta), vlDefNumCuenta, vgRs4!Num_Cuenta)
            vlCodSucursal = IIf(IsNull(vgRs4!Cod_Sucursal), vlDefCodSucursal, vgRs4!Cod_Sucursal)
            
            'vlCodCajaCompen = IIf(IsNull(vgRs4!Cod_CajaCompen), vlDefCodCajaCompen, vgRs4!Cod_CajaCompen)
        End If
        vgRs4.Close
    Else
        vlBenefNuevo = True
    End If
    
    flFormatearDatosBeneficiarioDef = True
    
Exit Function
Err_flFormatearDatosBeneficiarioDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flActualizarBeneficiarioDef()
On Error GoTo Err_flActualizarBeneficiarioDef
    
    vgSql = ""
    vgSql = " UPDATE PP_TMAE_BEN SET "
    vgSql = vgSql & " Cod_TipoIdenben = " & vlCodTipoIdenBen & " , "
    vgSql = vgSql & " Num_Idenben = '" & vlNumIdenBen & "' , "
    vgSql = vgSql & " gls_nomben = '" & vlNomBen & "' , "
    vgSql = vgSql & " gls_patben = '" & vlPaternoBen & "' , "
    vgSql = vgSql & " gls_matben = '" & vlMaternoBen & "' , "
    vgSql = vgSql & " cod_grufam = '" & vlCodGruFam & "' , "
    vgSql = vgSql & " cod_par = '" & vlCodPar & "' , "
    vgSql = vgSql & " cod_sexo = '" & vlCodSexo & "' , "
    vgSql = vgSql & " cod_sitinv = '" & vlCodSitInv & "' , "
    vgSql = vgSql & " cod_dercre= '" & vlCodDerCre & "' , "
    vgSql = vgSql & " cod_derpen = '" & vlCodDerpen & "' , "
    vgSql = vgSql & " cod_cauinv = '" & vlCodCauInv & "' , "
    vgSql = vgSql & " fec_nacben = '" & vlFecNacBen & "' , "
    If (vlFecNacHM <> "") Then
        vgSql = vgSql & " fec_nachm = '" & vlFecNacHM & "' , "
    Else
        vgSql = vgSql & " fec_nachm = NULL , "
    End If
    If (vlFecInvBen <> "") Then
        vgSql = vgSql & " fec_invben = '" & vlFecInvBen & "' , "
    Else
        vgSql = vgSql & " fec_invben = NULL , "
    End If
    vgSql = vgSql & " cod_motreqpen = '" & vlCodMotReqPen & "' , "
    vgSql = vgSql & " mto_pension = " & vlMtoPension & " , "
    vgSql = vgSql & " mto_pensiongar = " & vlMtoPensionGar & " , "
    vgSql = vgSql & " prc_pension = " & vlPrcPension & " , "
    vgSql = vgSql & " cod_estpension = '" & vlCodEstPension & "' , "
    If (vlFecFallBen <> "") Then
        vgSql = vgSql & " fec_fallben = '" & vlFecFallBen & "' , "
    Else
        vgSql = vgSql & " fec_fallben = NULL , "
    End If
    vgSql = vgSql & " cod_caususben = '" & vlCodCauSusBen & "' , "
    If (vlFecSusBen <> "") Then
        vgSql = vgSql & " fec_susben = '" & vlFecSusBen & "' , "
    Else
        vgSql = vgSql & " fec_susben = NULL , "
    End If
    If (vlFecTerPagoPenGar <> "") Then
        vgSql = vgSql & " fec_terpagopengar = '" & vlFecTerPagoPenGar & "', "
    Else
        vgSql = vgSql & " fec_terpagopengar = NULL , "
    End If
    If (vlFecMatrimonio <> "") Then
        vgSql = vgSql & " fec_matrimonio = '" & vlFecMatrimonio & "' , "
    Else
        vgSql = vgSql & " fec_matrimonio = NULL , "
    End If
    vgSql = vgSql & " fec_inipagopen = '" & vlFecIniPagoPen & "' "
    vgSql = vgSql & " WHERE "
    vgSql = vgSql & " num_poliza = '" & Trim(Txt_PenPoliza.Text) & "' AND "
    vgSql = vgSql & " num_endoso = " & Trim(Lbl_End) & " AND "
    'Msf_BMGrilla.Col = 0
    vgSql = vgSql & " num_orden = " & vlNumOrden & " "
    
    vgConexionBD.Execute vgSql

    'corptec
    vlLog_tabla = "PP_TMAE_BEN"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.NUM_ORDEN"
    vlLog_valtabla = "" & Trim(Txt_PenPoliza.Text) & "." & Trim(Lbl_End) & "." & vlNumOrden & ""
    vlLog_trans = "UPD"
    Call flLog_Tabla
    
Exit Function
Err_flActualizarBeneficiarioDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flInsertarBeneficiarioProdDef()

    vgSql = "Insert into PD_TMAE_POLBEN"
    vgSql = vgSql & " (NUM_POLIZA, NUM_ENDOSO, NUM_ORDEN, COD_PAR, COD_GRUFAM,"
    vgSql = vgSql & " COD_SEXO, COD_SITINV, FEC_INVBEN, COD_CAUINV, COD_DERPEN,"
    vgSql = vgSql & " COD_DERCRE, COD_TIPOIDENBEN, NUM_IDENBEN, GLS_NOMBEN, GLS_NOMSEGBEN,"
    vgSql = vgSql & " GLS_PATBEN, GLS_MATBEN, FEC_NACBEN, FEC_FALLBEN, FEC_NACHM,"
    vgSql = vgSql & " PRC_PENSION, PRC_PENSIONLEG, PRC_PENSIONREP, MTO_PENSION, MTO_PENSIONGAR,"
    vgSql = vgSql & " COD_USUARIOCREA, FEC_CREA, HOR_CREA, COD_USUARIOMODI, FEC_MODI,"
    'MVG 20170904
    vgSql = vgSql & " HOR_MODI, COD_ESTPENSION, PRC_PENSIONGAR,IND_BOLELEC,CONS_TRAINFO, CONS_DATCOMER,GLS_FONO, GLS_FONO2 )"
    vgSql = vgSql & " select '" & vlGlobalNumPoliza & "', " & vlGlobalNumEndosoCrear & ", NUM_ORDEN, COD_PAR, COD_GRUFAM,"
    vgSql = vgSql & " COD_SEXO, COD_SITINV, FEC_INVBEN, COD_CAUINV, COD_DERPEN,"
    vgSql = vgSql & " COD_DERCRE, COD_TIPOIDENBEN, NUM_IDENBEN, "
    vgSql = vgSql & "'" & vlNomBen & "', "
    If (vlNomSegBen <> "") Then vgSql = vgSql & "'" & vlNomSegBen & "', " Else vgSql = vgSql & "NULL,"
    vgSql = vgSql & "'" & vlPaternoBen & "', "
    If (vlMaternoBen <> "") Then vgSql = vgSql & "'" & vlMaternoBen & "', " Else vgSql = vgSql & "NULL,"
    vgSql = vgSql & " Fec_NacBen , Fec_FallBen, Fec_NacHM, "
    vgSql = vgSql & " PRC_PENSION, PRC_PENSIONLEG, PRC_PENSIONREP, MTO_PENSION, MTO_PENSIONGAR,"
    vgSql = vgSql & " COD_USUARIOCREA, FEC_CREA, HOR_CREA, COD_USUARIOMODI, FEC_MODI,"
    vgSql = vgSql & " HOR_MODI, COD_ESTPENSION, PRC_PENSIONGAR "
    'MVG 20170904
    vgSql = vgSql & " ,IND_BOLELEC ,'" & vl_ConTratDatos_Ben & "','" & vl_ConUsoDatosCom_Ben & "','" & vlGlsFonoBen & "','" & vlGlsTelben2 & "'"
    vgSql = vgSql & " from PD_TMAE_POLBEN "
    vgSql = vgSql & " WHERE NUM_POLIZA='" & vlGlobalNumPoliza & "' AND NUM_ORDEN=" & vlNumOrden & ""
    vgSql = vgSql & " AND NUM_ENDOSO= (select max(num_endoso) from pd_tmae_polben where num_poliza='" & vlGlobalNumPoliza & "' and num_orden=" & vlNumOrden & ") "
    vgConectarBD.Execute vgSql

Exit Function
Err_flInsertarBeneficiarioDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flInsertarBeneficiarioDef()
'*On Error GoTo Err_flInsertarBeneficiarioDef

    vgSql = "INSERT INTO PP_TMAE_BEN "
    vgSql = vgSql & "(num_poliza,num_endoso,num_orden,fec_ingreso,Cod_TipoIdenben,Num_Idenben, "
    vgSql = vgSql & "gls_nomben,gls_nomsegben,gls_patben,gls_matben,gls_dirben,cod_direccion,"
    If (Trim(vlGlsFonoBen) <> "") Then vgSql = vgSql & "gls_fonoben,"
    If (Trim(vlGlsCorreoBen) <> "") Then vgSql = vgSql & "gls_correoben,"
    vgSql = vgSql & "cod_grufam, "
    vgSql = vgSql & "cod_par,cod_sexo,cod_sitinv,cod_dercre,cod_derpen, "
    vgSql = vgSql & "cod_cauinv,fec_nacben,"
    If (Trim(vlFecNacHM) <> "") Then vgSql = vgSql & "fec_nachm,"
    If (Trim(vlFecInvBen) <> "") Then vgSql = vgSql & "fec_invben, "
    vgSql = vgSql & "cod_motreqpen,mto_pension,mto_pensiongar,prc_pension, "
    vgSql = vgSql & "cod_inssalud,cod_modsalud,mto_plansalud, "
    vgSql = vgSql & "cod_estpension,"
    'vgSql = vgSql & "cod_cajacompen,"
    vgSql = vgSql & "cod_viapago,cod_banco,"
    vgSql = vgSql & "cod_tipcuenta,"
    If (Trim(vlNumCuenta) <> "") Then vgSql = vgSql & "num_cuenta,"
    vgSql = vgSql & "cod_sucursal,"
    If (Trim(vlFecFallBen) <> "") Then vgSql = vgSql & "fec_fallben,"
    If (Trim(vlFecMatrimonio) <> "") Then vgSql = vgSql & "fec_matrimonio,"
    vgSql = vgSql & "cod_caususben,"
    If (Trim(vlFecSusBen) <> "") Then vgSql = vgSql & "fec_susben, "
    vgSql = vgSql & "fec_inipagopen,"
    If (Trim(vlFecTerPagoPenGar) <> "") Then vgSql = vgSql & "fec_terpagopengar, "
    vgSql = vgSql & "cod_usuariocrea,fec_crea,hor_crea "
    vgSql = vgSql & ",prc_pensiongar, prc_pensionleg "
    If (Trim(vlGlsTelben2) <> "") Then vgSql = vgSql & ",gls_telben2" '--RRR 08/05/2013
    If (Trim(vlCodBanco) <> "00") Then vgSql = vgSql & ",cod_tipcta, cod_monbco, num_ctabco " '--RRR 24/01/2013
    If Mid(Cmb_EndCauEnd, 1, 2) = "28" And Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
        vgSql = vgSql & ",COD_MODTIPOCUENTA_MANC"
        vgSql = vgSql & ",COD_TIPODOC_MANC"
        vgSql = vgSql & ",NUM_DOC_MANC"
        vgSql = vgSql & ",NOMBRE_MANC"
        vgSql = vgSql & ",APELLIDO_MANC"
    End If
    'mvg 20170904
    'INICIO GCP-FRACTAL 16042019
    vgSql = vgSql & ",ind_bolelec, NUM_CUENTA_CCI "
    vgSql = vgSql & ",CONS_TRAINFO "
    vgSql = vgSql & ",CONS_DATCOMER "
    'FIN GCP-FRACTAL 16042019
    vgSql = vgSql & " ) VALUES ( "
    vgSql = vgSql & "'" & vlGlobalNumPoliza & "', "
    vgSql = vgSql & " " & vlGlobalNumEndosoCrear & ", "
    vgSql = vgSql & " " & vlNumOrden & ", "
    vgSql = vgSql & "'" & Trim(vlFecIngreso) & "', "
    vgSql = vgSql & " " & str(vlCodTipoIdenBen) & ", "
    vgSql = vgSql & "'" & vlNumIdenBen & "', "
    vgSql = vgSql & "'" & vlNomBen & "', "
    If (vlNomSegBen <> "") Then vgSql = vgSql & "'" & vlNomSegBen & "', " Else vgSql = vgSql & "NULL,"
    vgSql = vgSql & "'" & vlPaternoBen & "', "
    If (vlMaternoBen <> "") Then vgSql = vgSql & "'" & vlMaternoBen & "', " Else vgSql = vgSql & "NULL,"
    vgSql = vgSql & "'" & Trim(vlGlsDirBen) & "', "
    vgSql = vgSql & " " & str(vlCodDireccion) & ", "
    If (Trim(vlGlsFonoBen) <> "") Then vgSql = vgSql & "'" & Trim(vlGlsFonoBen) & "', "
    If (Trim(vlGlsCorreoBen) <> "") Then vgSql = vgSql & "'" & Trim(vlGlsCorreoBen) & "', "
    vgSql = vgSql & "'" & vlCodGruFam & "', "
    vgSql = vgSql & "'" & vlCodPar & "', "
    vgSql = vgSql & "'" & vlCodSexo & "', "
    vgSql = vgSql & "'" & vlCodSitInv & "', "
    vgSql = vgSql & "'" & vlCodDerCre & "', "
    vgSql = vgSql & "'" & vlCodDerpen & "', "
    vgSql = vgSql & "'" & vlCodCauInv & "', "
    vgSql = vgSql & "'" & vlFecNacBen & "', "
    If (Trim(vlFecNacHM) <> "") Then vgSql = vgSql & "'" & vlFecNacHM & "', "
    If (Trim(vlFecInvBen) <> "") Then vgSql = vgSql & "'" & vlFecInvBen & "', "
    vgSql = vgSql & "'" & vlCodMotReqPen & "', "
    vgSql = vgSql & " " & str(vlMtoPensionB) & ", "
    vgSql = vgSql & " " & str(vlMtoPensionGarB) & ", "
    vgSql = vgSql & " " & str(vlPrcPension) & ", "
    vgSql = vgSql & "'" & Trim(vlCodInsSalud) & "', "
    vgSql = vgSql & "'" & Trim(vlCodModSalud) & "', "
    vgSql = vgSql & " " & str(vlMtoPlanSalud) & ", "
    vgSql = vgSql & "'" & vlCodEstPension & "', "
    'vgSql = vgSql & "'" & Trim(vlCodCajaCompen) & "', "
    vgSql = vgSql & "'" & Trim(vlViaPago) & "', "
    vgSql = vgSql & "'" & Trim(vlCodBanco) & "', "
    vgSql = vgSql & "'" & Trim(vlCodTipCuenta) & "', "
    If (Trim(vlNumCuenta) <> "") Then vgSql = vgSql & "'" & Trim(vlNumCuenta) & "', "
    vgSql = vgSql & "'" & Trim(vlSucursal) & "', "
    If (Trim(vlFecFallBen) <> "") Then vgSql = vgSql & "'" & vlFecFallBen & "', "
    If (Trim(vlFecMatrimonio) <> "") Then vgSql = vgSql & "'" & Trim(vlFecMatrimonio) & "', "
    vgSql = vgSql & "'" & vlCodCauSusBen & "', "
    If (Trim(vlFecSusBen) <> "") Then vgSql = vgSql & "'" & vlFecSusBen & "', "
    vgSql = vgSql & "'" & vlFecIniPagoPen & "', "
    If (Trim(vlFecTerPagoPenGar) <> "") Then vgSql = vgSql & "'" & vlFecTerPagoPenGar & "', "
    vgSql = vgSql & "'" & Trim(vlGlsUsuarioCrea) & "', "
    vgSql = vgSql & "'" & Trim(vlFecCrea) & "', "
    vgSql = vgSql & "'" & Trim(vlHorCrea) & "'"
    vgSql = vgSql & "," & str(vlPrcPensionGar) & ","
    vgSql = vgSql & " " & str(vlPrcPensionLeg) & ""
    If (Trim(vlGlsTelben2) <> "") Then vgSql = vgSql & ",'" & Trim(vlGlsTelben2) & "'"
    If (Trim(vlCodBanco) <> "00") Then vgSql = vgSql & ",'" & Trim(vlCodTipcta) & "', '" & Trim(vlcodmonbco) & "', '" & Trim(vlnumctabco) & "'" '--RRR 24/01/2013
    
    If Mid(Cmb_EndCauEnd, 1, 2) = "28" And Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
        vgSql = vgSql & ",'" & vl_COD_MODTIPOCUENTA_MANC & "'"
        vgSql = vgSql & ",'" & vl_COD_TIPODOC_MANC & "'"
        vgSql = vgSql & ",'" & vl_NUM_DOC_MANC & "'"
        vgSql = vgSql & ",'" & vl_NOMBRE_MANC & "'"
        vgSql = vgSql & ",'" & vl_APELLIDO_MANC & "'"
    End If

    
    'mvg 20170904
    vgSql = vgSql & ",'" & vlBolelec & "'"
    
    'INICIO GCP-FRACTAL 25032019
    vgSql = vgSql & ",'" & vlnumctacci & "'"
    vgSql = vgSql & ",'" & vl_ConTratDatos_Ben & "'"
    vgSql = vgSql & ",'" & vl_ConUsoDatosCom_Ben & "'"
     
     'FIN GCP-FRACTAL 25032019
    
    vgSql = vgSql & ") "
    vgConectarBD.Execute vgSql

        ' CORPTEC
    vlLog_tabla = "PP_TMAE_ENDBEN"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO"
    vlLog_valtabla = "" & vlGlobalNumPoliza & "." & vlGlobalNumEndosoCrear & ""
    vlLog_trans = "INS"
    Call flLog_Tabla
    

Exit Function
Err_flInsertarBeneficiarioDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

'Implementacion GobiernoDeDatos(Se eliminan las tablas de endosos de direccion y telefono)
Function flEliminarRegistrosTempEndDirc(iNumPoliza As String, inumendoso As String)
'*On Error GoTo Err_flEliminarRegistrosTempEnd
    
    vgSql = ""
    vgSql = "DELETE PP_TMAE_ENDBEN_DIRECCION "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    vgConectarBD.Execute (vgSql)

    ' CORPTEC
    vlLog_tabla = "PP_TMAE_ENDBEN_DIRECCION"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO"
    vlLog_valtabla = "" & iNumPoliza & "." & inumendoso & ""
    vlLog_trans = "DLT"
    Call flLog_Tabla
    
    vgSql = ""
    vgSql = "DELETE PP_TMAE_ENDBEN_TELEFONO "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    vgConectarBD.Execute (vgSql)

    
        ' CORPTEC
    vlLog_tabla = "PP_TMAE_ENDBEN_TELEFONO"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO"
    vlLog_valtabla = "" & iNumPoliza & "." & inumendoso & ""
    vlLog_trans = "DLT"
    Call flLog_Tabla

Exit Function
Err_flEliminarRegistrosTempEnd:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function
'Fin Implementacion GobiernoDeDatos()__


Function flEliminarRegistrosTempEnd(iNumPoliza As String, inumendoso As String)
'*On Error GoTo Err_flEliminarRegistrosTempEnd
    
    vgSql = ""
    vgSql = "DELETE PP_TMAE_ENDBEN "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    vgConectarBD.Execute (vgSql)

    ' CORPTEC
    vlLog_tabla = "PP_TMAE_ENDBEN"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO"
    vlLog_valtabla = "" & iNumPoliza & "." & inumendoso & ""
    vlLog_trans = "DLT"
    Call flLog_Tabla
    
    vgSql = ""
    vgSql = "DELETE PP_TMAE_ENDPOLIZA "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    vgConectarBD.Execute (vgSql)

    
        ' CORPTEC
    vlLog_tabla = "PP_TMAE_ENDPOLIZA"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO"
    vlLog_valtabla = "" & iNumPoliza & "." & inumendoso & ""
    vlLog_trans = "DLT"
    Call flLog_Tabla

Exit Function
Err_flEliminarRegistrosTempEnd:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Private Sub Cmb_BMDerPen_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Txt_BMFecNac.SetFocus
    End If
End Sub

Private Sub Cmb_BMGrupFam_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Cmb_BMDerPen.SetFocus
    End If
End Sub

Private Sub Cmb_BMNumIdent_Click()
If (Cmb_BMNumIdent <> "") Then
    vlPosicionTipoIden = Cmb_BMNumIdent.ListIndex
    vlLargoTipoIden = Cmb_BMNumIdent.ItemData(vlPosicionTipoIden)
    If (vlLargoTipoIden = 0) Then
        Txt_BMNumIden.Text = "0"
        Txt_BMNumIden.Enabled = False
    Else
        Txt_BMNumIden = ""
        Txt_BMNumIden.Enabled = True
        Txt_BMNumIden.MaxLength = vlLargoTipoIden
        If (Txt_BMNumIden <> "") Then Txt_BMNumIden.Text = Mid(Txt_BMNumIden, 1, vlLargoTipoIden)
    End If
End If
End Sub

Private Sub Cmb_BMNumIdent_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Txt_BMNumIden.SetFocus
    End If
End Sub

Private Sub Cmb_BMPar_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Cmb_BMSexo.SetFocus
    End If
End Sub

Private Sub Cmb_BMPar_LostFocus()
    'I--- ABV 19/04/2005 ---
    If IsNumeric(Txt_BMMtoPensionGar) Then
        Exit Sub
    End If
    
    vlMtoPensionGar = 0
    
    Call flHabilitarPenGar
    
    Txt_BMMtoPensionGar = Format(vlMtoPensionGar, "#,#0.00")
    'F--- ABV 19/04/2005 ---
End Sub

Private Sub Cmb_BMSexo_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Cmb_BMGrupFam.SetFocus
    End If
End Sub

Private Sub Cmb_BMSitInv_Click()
    vlNumero = InStr(Cmb_BMSitInv.Text, "-")
    vlValCodSitInv = Trim(Mid(Cmb_BMSitInv.Text, 1, vlNumero - 1))
    If vlValCodSitInv = Trim(clCodSitInvNoInv) Then
        Lbl_BMCauInv = flBuscarCauInv
    Else
        Lbl_BMCauInv = ""
    End If
End Sub

Private Sub Cmb_BMSitInv_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Txt_BMFecInv.SetFocus
    End If
End Sub
'RRR 06/05/2013

Sub Habilita()
txtNomben.Enabled = False
txtNomsegBen.Enabled = False
txtApepatBen.Enabled = False
txtApematBen.Enabled = False
txtTelBen.Enabled = False
txtTelfon2.Enabled = False
txtBenEmail.Enabled = False
txt_dirben.Enabled = False
txtDistritoBen.Enabled = False
Cmd_BuscarDir.Enabled = False
'mvg 20170904
'chkEnvioBolElec.Enabled = False
End Sub


Private Sub Cmb_EndCauEnd_Click()

    Call Habilita
    FrameCtaBan.Visible = False
    cmdDirec.Visible = False
    cmbExcluesion.Enabled = False
    Cmb_BMDerPen.Enabled = False
    
    Select Case Mid(Cmb_EndCauEnd, 1, 2)
        Case "01"
            cmdIngNombres.Visible = False
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
        Case "02"
            cmdIngNombres.Visible = True
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
        Case "04"
            cmdIngNombres.Visible = False
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
        Case "05"
            cmdIngNombres.Visible = False
            'cmbExcluesion.Enabled = False
            'Cmb_BMDerPen.Enabled = False
            'Cmb_BMNumIdent.Enabled = False
            'Txt_BMNumIden.Enabled = False
            cmbExcluesion.Enabled = True
            Cmb_BMDerPen.Enabled = True
        Case "06"
            cmdIngNombres.Visible = False
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
        Case "07"
            'cmbExcluesion.Enabled = True
            'cmbExcluesion.Enabled = False
            'Cmb_BMNumIdent.Enabled = False
            'Txt_BMNumIden.Enabled = False
            cmbExcluesion.Enabled = False
            Cmb_BMDerPen.Enabled = False
'            cmbExcluesion.ListIndex = 1
'            Cmb_BMDerPen.ListIndex = 0
        Case "08"
            'Cmd_Calcular.Enabled = False
            Cmd_BMCalcular.Enabled = False
            Cmd_BMRestar.Enabled = False
            Cmd_BMSumar.Enabled = False
            Cmd_Calcular.Enabled = False
            Lbl_EndCrear = flCalculaNumNuevoEndoso
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
        Case "09"
            cmbExcluesion.Enabled = True
            Cmb_BMDerPen.Enabled = True
        Case "13"
            cmdIngNombres.Visible = False
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
        Case "14"
            txtNomben.Enabled = True
            txtNomsegBen.Enabled = True
            txtApepatBen.Enabled = True
            txtApematBen.Enabled = True
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
        Case "15"
            txt_dirben.Enabled = True
            txtDistritoBen.Enabled = True
            Cmd_BuscarDir.Enabled = True
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
            'Implementacion GobiernoDeDatos()
            cmdDirec.Visible = True
            'Fin Implementacion GobiernoDeDatos()
        Case "16"
            txtTelBen.Enabled = True
            txtTelfon2.Enabled = True
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
            'Implementacion GobiernoDeDatos()
            cmdDirec.Visible = True
            'Fin Implementacion GobiernoDeDatos()
        Case "17"
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = True
            Txt_BMNumIden.Enabled = True
        Case "18"
            cmbExcluesion.Enabled = False
            Cmb_BMNumIdent.Enabled = False
            Txt_BMNumIden.Enabled = False
        Case "25"
            FrameCtaBan.Visible = True
        Case "26"
            cmbExcluesion.Enabled = True
            Cmb_BMDerPen.Enabled = True
            'cmbExcluesion.ListIndex = 1
            'Cmb_BMDerPen.ListIndex = 0
        Case "27"
            txtNomben.Enabled = True
            txtNomsegBen.Enabled = True
            txtApepatBen.Enabled = True
            txtApematBen.Enabled = True
            txt_dirben.Enabled = True
            txtDistritoBen.Enabled = True
            txtTelBen.Enabled = True
            txtTelfon2.Enabled = True
            Cmb_BMNumIdent.Enabled = True
            Txt_BMNumIden.Enabled = True
            txtBenEmail.Enabled = True
            cmbExcluesion.Enabled = False
            '20170904
            'chkEnvioBolElec.Enabled = True
            'Implementacion GobiernoDeDatos(Se muestra el boton que invoca al formulario para editar la direccion y telefono)
            cmdDirec.Visible = True
            'Fin Implementacion GobiernoDeDatos()
       Case "28"
            FrameCtaBan.Visible = True
            Cmd_BMRestar.Enabled = True
            Cmd_BMSumar.Enabled = True
    End Select
    
    
End Sub



Private Sub Cmb_EndCauEnd_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
       Txt_EndObs.SetFocus
    End If

End Sub


Private Sub Cmb_EndTipoEnd_Click()

'Txt_EndFecEfecto
'Txt_EndFecEnd

    If Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
        Cmd_Calcular.Enabled = False
        Cmd_BMCalcular.Enabled = False
        Cmd_BMRestar.Enabled = False
        frmDatosGen.Enabled = True
        Fra_BM.Enabled = False
        Txt_BMMtoPensionGar.Enabled = False
        txt_BMMtoPension.Enabled = False
        
        Lbl_EndCrear = flCalculaNumNuevoEndoso
        If Txt_EndFecEnd = "" Then
            'CMV - 20051021 I
            Txt_EndFecEnd = fgBuscaFecServ
            Txt_EndFecEfecto = ""
            Txt_EndFecEfecto = flCalculaFechaEfecto(Txt_EndFecEfecto)
        End If
        'Lbl_EndMtoPensionOrig = Lbl_POMtoPen
        'Lbl_EndMtoPensionCalc = Lbl_POMtoPen
        Call flCargaDatosBeneficiariosModDatGen(Msf_BMGrilla.row)
        
        cmdIngNombres.Visible = False
        lbl_BMPrc.Visible = True
        lbl_BMPrcGar.Visible = True
        txt_BMPrc.Visible = False
        txt_BMPrcGar.Visible = False
        txt_BMMtoPension.Visible = False
        cmd_ActivaCertif.Enabled = False
        txt_EndMtoPensionCalc.Visible = False
        txt_EndMtoPensionOrig.Visible = False
        txt_EndMtoPensionCalcGar.Visible = False
        txt_EndMtoPensionCalc.Visible = False
        vgTipoCauEnd = "O"
    ElseIf Mid(Cmb_EndTipoEnd, 1, 1) = "A" Then
        'Cmd_Calcular.Enabled = False
        txt_BMMtoPension.Enabled = True
        Txt_BMMtoPensionGar.Enabled = True
        lbl_BMPrc.Visible = False
        lbl_BMPrcGar.Visible = False
        txt_BMPrc.Visible = True
        txt_BMPrcGar.Visible = True
        txt_BMMtoPension.Visible = True
        Fra_BM.Enabled = True
        Cmd_Calcular.Enabled = True
        Cmd_BMCalcular.Enabled = True
        Cmd_BMRestar.Enabled = True
        frmDatosGen.Enabled = False
        'Lbl_EndMtoPensionOrig = Lbl_POMtoPen
        'Lbl_EndMtoPensionCalc = Lbl_POMtoPen
        cmd_ActivaCertif.Enabled = False
        txt_EndMtoPensionCalcGar.Visible = True
        txt_EndMtoPensionCalc.Visible = True
        'txt_EndMtoPensionOrig.Visible = True
        'txt_EndMtoPensionCalc.Text = Lbl_POMtoPen
        'txt_EndMtoPensionOrig.Text = Lbl_POMtoPen
        vgTipoCauEnd = "A"
        
    Else
        Lbl_BMMtoPension.Enabled = True
        Txt_BMMtoPensionGar.Enabled = False
        lbl_BMPrc.Visible = True
        lbl_BMPrcGar.Visible = True
        txt_BMMtoPension.Visible = True
        Fra_BM.Enabled = True
        Cmd_Calcular.Enabled = True
        Cmd_BMCalcular.Enabled = True
        Cmd_BMRestar.Enabled = True
        frmDatosGen.Enabled = False
        txt_BMMtoPension.Visible = False
        txt_BMPrc.Visible = False
        txt_BMPrcGar.Visible = False
        'Lbl_EndMtoPensionOrig = Lbl_POMtoPen
        'Lbl_EndMtoPensionCalc = Lbl_POMtoPen
        cmd_ActivaCertif.Enabled = True
        Cmd_BMSumar.Enabled = True
        txt_EndMtoPensionCalc.Visible = False
        txt_EndMtoPensionOrig.Visible = False
        txt_EndMtoPensionOrigGar.Visible = False
        txt_EndMtoPensionCalcGar.Visible = False
        
        If Len(Trim(Txt_PenPoliza.Text)) > 0 Then
        
         Call flCargaDatosBeneficiariosModDatGen(Msf_BMGrilla.row)
        End If
        
    
        vgTipoCauEnd = "S"
    End If

    fgComboCausaEndosos vgCodTabla_CauEnd, Cmb_EndCauEnd, Mid(Cmb_EndTipoEnd, 1, 1)
    
    
    
    

End Sub

Private Sub Cmb_EndTipoEnd_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
       'Txt_EndFecEnd.SetFocus
       Cmb_EndCauEnd.SetFocus
    End If

End Sub



Private Sub Cmb_ModTipCta_Click()
  If Left(Trim(Cmb_ModTipCta.Text), 2) = "01" Then
    Cmb_TipDoc.Enabled = True
    Txt_NroDocSecundario.Enabled = True
    Txt_NombreSecundario.Enabled = True
    Txt_ApellidosSecundario.Enabled = True
  Else
    Cmb_TipDoc.Enabled = False
    Txt_NroDocSecundario.Enabled = False
    Txt_NombreSecundario.Enabled = False
    Txt_ApellidosSecundario.Enabled = False
  End If
End Sub

Private Sub Cmb_PenNumIdent_Click()
If (Cmb_PenNumIdent <> "") Then
    vlPosicionTipoIden = Cmb_PenNumIdent.ListIndex
    vlLargoTipoIden = Cmb_PenNumIdent.ItemData(vlPosicionTipoIden)
    If (vlLargoTipoIden = 0) Then
        Txt_PenNumIdent.Text = "0"
        Txt_PenNumIdent.Enabled = False
    Else
        Txt_PenNumIdent = ""
        Txt_PenNumIdent.Enabled = True
        Txt_PenNumIdent.MaxLength = vlLargoTipoIden
        If (Txt_PenNumIdent <> "") Then Txt_PenNumIdent.Text = Mid(Txt_PenNumIdent, 1, vlLargoTipoIden)
    End If
End If
End Sub

Private Sub Cmb_PenNumIdent_KeyPress(KeyAscii As Integer)
    If (KeyAscii = 13) Then
        Txt_PenNumIdent.SetFocus
    End If
End Sub

Private Sub Cmb_PMEstVig_KeyPress(KeyAscii As Integer)
    
    If KeyAscii = 13 Then
       Cmb_PMTipRta.SetFocus
    End If
    
End Sub

Private Sub Cmb_PMMod_Click()
If Len(Trim(Cmb_PMMod)) = 0 Then
   Exit Sub
End If

If (Trim(Mid(Cmb_PMMod, 1, (InStr(1, Cmb_PMMod, "-") - 1))) = "1") Then
    Txt_PMMesGar = 0
    Txt_PMMesGar.Enabled = False
Else
    Txt_PMMesGar = ""
    Txt_PMMesGar.Enabled = True
End If
End Sub

Private Sub Cmb_PMMod_KeyPress(KeyAscii As Integer)
If KeyAscii = 13 Then
   Txt_PMMesDif.SetFocus
End If
End Sub

Private Sub Cmb_PMMod_Validate(Cancel As Boolean)
If Len(Trim(Cmb_PMMod)) = 0 Then
   Exit Sub
End If

If (Trim(Mid(Cmb_PMMod, 1, (InStr(1, Cmb_PMMod, "-") - 1))) = "1") Then
    Txt_PMMesGar = 0
    Txt_PMMesGar.Enabled = False
Else
    Txt_PMMesGar = ""
    Txt_PMMesGar.Enabled = True
End If
End Sub

Private Sub Cmb_PMTipPen_KeyPress(KeyAscii As Integer)
If KeyAscii = 13 Then
   Cmb_PMEstVig.SetFocus
End If
End Sub

Private Sub Cmb_PMTipRta_Click()
If Len(Cmb_PMTipRta) = 0 Then
    Exit Sub
End If

If (Trim(Mid(Cmb_PMTipRta, 1, (InStr(1, Cmb_PMTipRta, "-") - 1))) = "1") Then
    Txt_PMMesDif = 0
    Txt_PMMesDif.Enabled = False
Else
    'If (Trim(Mid(Cmb_Modalidad, 1, (InStr(1, Cmb_Modalidad, "-") - 1))) = "2") Then
        Txt_PMMesDif = ""
        Txt_PMMesDif.Enabled = True
    'End If
End If
End Sub

Private Sub Cmb_PMTipRta_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Cmb_PMMod.SetFocus
    End If
End Sub

Private Sub Cmb_PMTipRta_Validate(Cancel As Boolean)
If (Trim(Mid(Cmb_PMTipRta, 1, (InStr(1, Cmb_PMTipRta, "-") - 1))) = "1") Then
    Txt_PMMesDif = 0
    Txt_PMMesDif.Enabled = False
Else
    'If (Trim(Mid(Cmb_Modalidad, 1, (InStr(1, Cmb_Modalidad, "-") - 1))) = "2") Then
        Txt_PMMesDif = ""
        Txt_PMMesDif.Enabled = True
    'End If
End If

End Sub




Private Sub Cmb_ViaPago_Click()
       
  On Error GoTo Err_CmbViaPagoClick

    Call VerificaViapago


'If Cmb_ViaPago.Enabled = True Then
'
'    vlNumero = InStr(Cmb_ViaPago.Text, "-")
'    vlOpcion = Trim(Mid(Cmb_ViaPago.Text, 1, vlNumero - 1))
''Opción 01 = Via de Pago CAJA
'    If vlSw = False Then
'
'        If vlOpcion = "00" Or vlOpcion = "05" Or vlOpcion = "08" Then
'            Cmb_Sucursal.Enabled = False
'            cmbTipoCtaBen.Enabled = False
'            cmbBancoCtaBen.Enabled = False
'            cmbMonctaBen.Enabled = False
'            txtNumctaBen.Enabled = False
'            txt_CCI.Enabled = False
'            Cmb_Sucursal.ListIndex = 0
'            cmbTipoCtaBen.ListIndex = 0
'            cmbBancoCtaBen.ListIndex = 0
'            txtNumctaBen.Text = ""
'            txt_CCI.Text = ""
'        Else
'            If vlOpcion = "01" Or vlOpcion = "04" Then
'                If (vlOpcion = "04") Then
'                    vgTipoSucursal = cgTipoSucursalAfp
'                Else
'                    vgTipoSucursal = cgTipoSucursalSuc
'                End If
'                fgComboSucursal Cmb_Sucursal, vgTipoSucursal
'
'                Cmb_Sucursal.Enabled = True
'                cmbTipoCtaBen.Enabled = False
'                cmbBancoCtaBen.Enabled = False
'                cmbMonctaBen.Enabled = False
'                txtNumctaBen.Enabled = False
'                cmbTipoCtaBen.ListIndex = 0
'                cmbBancoCtaBen.ListIndex = 0
'                If (vlOpcion = "04") Then
'                  '  vgPalabra = fgObtenerCodigo_TextoCompuesto(vlAfp)
'                  '  Call fgBuscarPosicionCodigoCombo(vgPalabra, Cmb_Sucursal)
'                End If
'               ' txtNumctaBen.Text = ""
'            Else
'                If (vlOpcion = "02") Then
'                   Cmb_Sucursal.Enabled = False
'                   cmbTipoCtaBen.Enabled = True
'                   cmbBancoCtaBen.Enabled = True
'                   cmbMonctaBen.Enabled = True
'                   txtNumctaBen.Enabled = True
'                   txt_CCI.Enabled = True
'                   Cmb_Sucursal.ListIndex = 0
''                   Txt_NumCuenta.Text = ""
'                ElseIf (vlOpcion = "07") Then
'                   Cmb_Sucursal.Enabled = False
'                   cmbTipoCtaBen.Enabled = True
'                   cmbBancoCtaBen.Enabled = True
'                   cmbMonctaBen.Enabled = True
'                   txtNumctaBen.Enabled = True
'                   txt_CCI.Enabled = True
'                   Cmb_Sucursal.ListIndex = 0
''                   Txt_NumCuenta.Text = ""
'                ElseIf (vlOpcion = "06") Then
'                    Cmb_Sucursal.Enabled = False
'                    cmbTipoCtaBen.Enabled = False
'                    Call DejarBcoPrinicipales(cmbBancoCtaBen)
'                    cmbBancoCtaBen.Enabled = True
'                    cmbMonctaBen.Enabled = False
'                    cmbMonctaBen.ListIndex = fgBuscarPosicionCodigoCombo(Lbl_MonPension(2).Caption, cmbMonctaBen)
'                    txtNumctaBen.Enabled = False
'                    Cmb_Sucursal.ListIndex = 0
'                    cmbTipoCtaBen.ListIndex = 0
'                    cmbBancoCtaBen.ListIndex = 0
'                    txtNumctaBen.Text = ""
''                Else
''                    Cmb_Sucursal.Enabled = False
''                    cmbTipoCtaBen.Enabled = False
''                    cmbBancoCtaBen.Enabled = False
''                    cmbMonctaBen.Enabled = False
''                    txtNumctaBen.Enabled = False
''                    Cmb_Sucursal.ListIndex = 0
''                    cmbTipoCtaBen.ListIndex = 0
''                    cmbBancoCtaBen.ListIndex = 0
''                    txtNumctaBen.Text = ""
''                    txt_CCI.Text = ""
'                End If
'            End If
'        End If
'
''    'INICIO GCP - FRACTAL 13052019
''    If vlOpcion = "06" Then
''           'Pago ventanilla debe quedar solo bancos princiales
''            Call DejarBcoPrinicipales(cmbBancoCtaBen)
''            'Deshabilitar Sucursal, tipcta, nrcci
''            'Habilitar Banco, Nro Cuenta.
''            Cmb_Sucursal.Enabled = False
''            cmbTipoCtaBen.Enabled = False
''
''            txt_CCI.Enabled = False
''            cmbBancoCtaBen.Enabled = True
''            txtNumctaBen.Enabled = False
''
''      ElseIf vlOpcion = "05" Then
''
''            Cmb_Sucursal.Enabled = False
''            cmbTipoCtaBen.Enabled = False
''
''            txt_CCI.Enabled = False
''            cmbBancoCtaBen.Enabled = True
''            txtNumctaBen.Enabled = False
''
''      Else
''        cmbBancoCtaBen.Clear
''        fgComboGeneral vgCodTabla_Bco, cmbBancoCtaBen
''    End If
''
''    'FIN GCP - FRACTAL 13052019
'
'
'    End If
'
'
'End If
    
Exit Sub
Err_CmbViaPagoClick:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Sub
'FIN GCP-FRACTAL 10052019
  Sub DejarBcoPrinicipales(ByRef gCombo As ComboBox)
        'Dejar en el combo solo estos Bancos
        '02  BANCO DE CREDITO DEL PERU
        '11' BANCO CONTINENTAL
        '41' SCOTIABANK PERU
        '03' INTERBANK
        
        Dim Bancos(5) As String
        Dim SwBorra As Boolean
        
    
        
        
        Bancos(0) = "02"
        Bancos(1) = "03"
        Bancos(2) = "11"
        Bancos(3) = "41"
        Bancos(4) = "00"
        
        
        For i = gCombo.ListCount - 1 To 0 Step -1
            gCombo.ListIndex = i
             SwBorra = True
            
            vPosicion = InStr(1, gCombo.Text, "-")
            vCodigo = Trim(Mid(gCombo.Text, 1, vPosicion - 1))
            
            For j = 0 To UBound(Bancos)
               
                If vCodigo = Bancos(j) Then
                        SwBorra = False
                End If
            Next
            
            If SwBorra Then
              gCombo.RemoveItem i
            End If
            
                  
        Next
  
 End Sub


Private Sub cmbExcluesion_Click()
Select Case cmbExcluesion.ListIndex
    Case 0
        Cmb_BMDerPen.ListIndex = 1
    Case 1
        Cmb_BMDerPen.ListIndex = 0
    Case 2
        Cmb_BMDerPen.ListIndex = 2
End Select
End Sub

Private Sub cmd_ActivaCertif_Click()
'    Lbl_End = CInt(flCalculaNumNuevoEndoso) - 1

    
   ' Call Cmd_BuscarPol_Click
    Lbl_EndCrear = flCalculaNumNuevoEndoso
'    Msf_BMGrilla.Col = 14
'    Trim(Msf_BMGrilla.Text) = flCalculaNumNuevoEndoso - 1
    Call ActivarPension
    SSTab_EndosoPoliza.Tab = 1

    Cmb_EndCauEnd.ListIndex = 1
    
  
  
    
   
    

End Sub

Private Sub ActivarPension()


  vgRes = MsgBox("¿ Está seguro que desea Modificar los Datos del Beneficiario?", 4 + 32 + 256, "Operación de Actualización")
            If vgRes <> 6 Then
                Screen.MousePointer = 0
                SwActivacion = False
                
                Exit Sub
                vlSwCalIntOK = False
            Else
                  SwActivacion = True
            End If
            
            
    Dim vlCodExclusion As String
    Dim VlCodDerPension As String
    
    vlNumero = InStr(Cmb_EndCauEnd.Text, "-")
    vlCodCauEndoso = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))
    'Cmb_BMDerPen
    vlNumero = InStr(cmbExcluesion.Text, "-")
    vlCodExclusion = Trim(Mid(cmbExcluesion.Text, 1, vlNumero - 1))
    
    vlNumero = InStr(Cmb_BMDerPen.Text, "-")
    VlCodDerPension = Trim(Mid(Cmb_BMDerPen.Text, 1, vlNumero - 1))
   
        'Preguntamos si es Activacion de endoso
        If vlCodCauEndoso = "08" Then
            'Verificamos que no sea el titular
             If Lbl_BMNumOrd <> "1" Then
                     'Verificamos que no tenga fecha de fallecimiento
                     If Len(Trim(Txt_BMFecFall.Text)) = 0 Then
                     
                             'Verificamos que CodEstPension sea 99
                             If vlCodExclusion = "99" Then
                             
                                If Not VlCodDerPension = "99" Then
                                    Cmb_BMDerPen.ListIndex = fgBuscarPosicionCodigoCombo("99", Cmb_BMDerPen)
                                    Call Cmd_BMSumar_Click
                                        MsgBox "Se activó correctamente al beneficiario.", vbInformation, "Proceso Finalizado"
                                        Msf_BMGrilla.row = Lbl_BMNumOrd
                                        Msf_BMGrilla.Col = 47
                                        Msf_BMGrilla.Text = Lbl_BMNumOrd.Caption
                                Else
                                       MsgBox "El beneficiario ya está activo y tiene derecho a la póliza. no se puede realizar la activación.", vbCritical, "Error de Datos"
                                        Exit Sub
                                
                                End If
                                
                            Else
                                MsgBox "El beneficiario está excluido de la póliza. no se puede realizar la activación.", vbCritical, "Error de Datos"
                               Exit Sub
                              End If
                    Else
                          MsgBox "El beneficiario tiene fecha de fallecimiento, no se puede realizar la activación.", vbCritical, "Error de Datos"
                           Exit Sub
                     End If
            Else
                MsgBox "Debe seleccionar un beneficiario, no se puede realizar la activación.", vbCritical, "Error de Datos"
                Exit Sub
         End If
     End If
        
        


End Sub

Private Sub Cmd_Aprobar_Click()
On Error GoTo Err_Cmd_Aprobar_Click

Dim V_CodEndoso As String
  V_CodEndoso = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))

    vlSwAprobar = False
    
    If vlSwValidaOK = False Then
        MsgBox "Debe Realizar el Procedimiento de Grabación", vbInformation, "Estado del Proceso"
        Cmd_Grabar.SetFocus
        Exit Sub
    End If
    
    'Validar que se haya ingresado toda la información del Endoso
    
    If (Trim(Txt_PenPoliza) = "") Then
        MsgBox "Debe indicar el Número de Póliza sobre la cual se quiere realizar la Operación.", vbCritical, "Error de Datos"
        Exit Sub
    End If
    
    If Not IsNumeric(Trim(Lbl_End)) Then
        MsgBox "Debe indicar el Número de Endoso sobre el cual se quiere realizar la Operación.", vbCritical, "Erroe de Datos"
        Exit Sub
    End If
    
    
'    'INICIO GCP-FRACTAL [REQUERIMIENTO SD-5041] 21032019
'    'Validamos si se ha ingresado nmro de cuenta y cci en el caso que sea deposito a cuenta
'    If Left(Trim(Cmb_ViaPago.Text), 2) = "02" Then
'      If Left(Trim(Me.cmbTipoCtaBen.Text), 2) = "00" Then
'         MsgBox "No se encuentra definido el tipo de cuenta. ", vbCritical, "Error de Datos"
'            Screen.MousePointer = 0
'            Cmb_TipoCta.SetFocus
'            Exit Sub
'     End If
'
'     If Left(Trim(Me.cmbBancoCtaBen), 2) = "00" Then
'        MsgBox "No se encuentra definido el banco. ", vbCritical, "Error de Datos"
'            Screen.MousePointer = 0
'            Cmb_Banco.SetFocus
'            Exit Sub
'     End If
'
'
'
'   End If
'
'   If Left(Trim(Cmb_ViaPago.Text), 2) = "07" Then
'         If Left(Trim(Me.cmbTipoCtaBen.Text), 2) = "00" Then
'         MsgBox "No se encuentra definido el tipo de cuenta. ", vbCritical, "Error de Datos"
'            Screen.MousePointer = 0
'            Cmb_TipoCta.SetFocus
'            Exit Sub
'         End If
'
'         If Left(Trim(Me.cmbBancoCtaBen), 2) = "00" Then
'            MsgBox "No se encuentra definido el banco. ", vbCritical, "Error de Datos"
'                Screen.MousePointer = 0
'                Cmb_Banco.SetFocus
'                Exit Sub
'         End If
'   End If
'
'  'FIN GCP-FRACTAL [REQUERIMIENTO SD-5041] 21032019
  
    vlGlobalNumPoliza = Trim(Txt_PenPoliza)
    vlGlobalNumEndoso = Trim(Lbl_End)
    vlGlobalNumEndosoCrear = ""
    
    'CMV-20051021 I
    Txt_EndFecEfecto = ""
    Txt_EndFecEfecto = flCalculaFechaEfecto(Txt_EndFecEfecto)
'    Txt_EndFecEfecto = fgValidaFechaEfecto(Trim(Txt_EndFecEnd), vlNumPoliza, vlNumOrden)
    'CMV-20051021 F
    
    'Ratificar el Proceso de Aprobación
    If vlSwGrabar = True Then
        vgRes = MsgBox(" ¿ Está seguro que desea Aprobar Definitivamente el Endoso ?", 4 + 32 + 256, "Operación de Aprobación Endoso")
        If vgRes <> 6 Then
            Cmd_Salir.SetFocus
            Screen.MousePointer = 0
            Exit Sub
        End If
    
'        vlSwValidaOK = True
        If vlSwValidaOK = True Then
            
        If (flGrabarAprobacionPoliza(vlGlobalNumPoliza, vlGlobalNumEndoso) = True) Then
                vlSwAprobar = True
                
                ''Limpiar el contenido de la Pantalla con la opción Limpiar
                'Call Cmd_Cancelar_Click
                
    'IMPLEMENTACION GESTOR CLIENTE
   '15052019 Envia al servicio de gestor de cliente
'   Dim vlCodCauEndos As String
'  vlCodCauEndos = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))
'  If Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
'    If vlCodCauEndoso = "27" Then
'            Dim RpstServicio As Boolean
'            If Msf_BMGrilla.rows > 1 Then
'               vlPos = 1
'               Msf_BMGrilla.Col = 0
'               While vlPos <= (Msf_BMGrilla.rows - 1)
'                    Msf_BMGrilla.row = vlPos
'                    If (flFormatearDatosBeneficiarioDefDirc(Msf_BMGrilla.row) = False) Then
'                        Cmd_Salir.SetFocus
'                        Screen.MousePointer = 0
'                        RpstServicio = False
'                    End If
'                    Msf_BMGrilla.Col = 0
'                    Call flCargarDatosBeneficiariosModDirec(Msf_BMGrilla.row)
'                    Dim MsgResponse As String
'                    RpstServicio = EnviarGestorCliente(MsgResponse, "Grabar")
'                    If (RpstServicio = False) Then
'                     Screen.MousePointer = 0
'                    MsgBox MsgResponse & " Benef #" & vlPos
'                    Exit Sub
'                    End If
'                 vlPos = vlPos + 1
'            Wend
'            End If
'         End If
'      End If
     'FIN IMPLEMENTACION GESTOR CLIENTE

                MsgBox "El Procedimiento de Aprobación se realizó Correctamente.", vbInformation, "Proceso Finalizado"
            
            If V_CodEndoso = "08" Then
                 MsgBox "Se ha aprobado una activación de sobrevivencia, verifique que se haya creado los certificado correspondientes", vbInformation, "Proceso Finalizado"
            End If
            
            
            Else
                vlSwAprobar = False
                
                MsgBox "El Procedimiento de Aprobación no ha podido realizarse.", vbCritical, "Proceso Cancelado"
            End If
        Else
            vlSwValidaOK = True
            Exit Sub
        End If
    Else
        MsgBox "Debe Realizar el Procedimiento de Grabación", vbInformation, "Estado del Proceso"
    End If
    
Exit Sub
Err_Cmd_Aprobar_Click:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub



Private Sub Cmd_BMCalcular_Click()
On Error GoTo Err_Cmd_BMCalcular_Click
        
        'I--- ABV 15/04/2005 ---
        'Modifique la Fecha a utilizar para determinar los Porcentajes de
        'Pensión - Igualmente debo preguntar a Daniela si está bien o no
        '-----------------------------------------------------------
        'vlFecVigencia = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
        'Validar el ingreso de la Fecha de Efecto del Endoso
        If (Txt_EndFecEfecto = "") Then
            MsgBox "Debe ingresar la Fecha de Efecto sobre la cual se realizarán los cálculos.", vbCritical, "Operación Cancelada"
            Cmd_BuscarFecEfe.SetFocus
            Exit Sub
        End If
        If Not IsDate(Txt_EndFecEfecto) Then
            MsgBox "La Fecha de Efecto ingresada no es una fecha válida.", vbCritical, "Operación Cancelada"
            Txt_EndFecEfecto.SetFocus
            Exit Sub
        End If
        vgPalabraAux = Format(flCalculaFechaEfecto(Trim("")), "yyyymmdd")
        If vgPalabraAux = "" Then Exit Sub
        
        vgPalabra = Format(Txt_EndFecEfecto, "yyyymmdd")
        If (vgPalabra < vgPalabraAux) Then
            MsgBox "La Fecha de Efecto ingresada es menor a la Fecha de Cierre de la Póliza.", vbCritical, "Operación Cancelada"
            Txt_EndFecEfecto.SetFocus
            Exit Sub
        End If
        
        vlFecVigencia = Format(Txt_EndFecEfecto, "yyyymmdd")
        
        'Datos de calculo
        Call fgCargaEstBenGrilla(Msf_BMGrilla, stBeneficiariosMod)
        vlNumCargas = (Msf_BMGrilla.rows - 1)
        
        ''I--- ABV 15/04/2005 ---
        ''Modifique la Fecha a utilizar para determinar los Porcentajes de
        ''Pensión - Igualmente debo preguntar a Daniela si está bien o no
        ''-----------------------------------------------------------
        ''vlFecVigencia = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
        'If Txt_EndFecEnd = "" Then
        '    vlFecVigencia = fgBuscaFecServ
        '    vlFecVigencia = Format(fgValidaFechaEfecto(Trim(vlFecVigencia), vlNumPoliza, vlNumOrden), "yyyymmdd")
        'Else
        '    vlFecVigencia = Format(Txt_EndFecEfecto, "yyyymmdd")
        'End If
        ''I--- ABV 15/04/2005 ---
        
        vgError = 0
        
Dim vlCodTipPension As String
Dim vlMtoPensionRef As Double
Dim vlCodDerCrecerCot As String
Dim vlIndCobertura As String
Dim vlIsGar As Long

vlCodTipPension = fgObtenerCodigo_TextoCompuesto(Cmb_PMTipPen)
vlMtoPensionRef = 0
vlCodDerCrecerCot = Mid(Lbl_PMDerCrecer, 1, 1)
'vlIndCobertura = Mid(Lbl_PMDerGratificacion, 1, 1)
vlIndCobertura = Trim(Lbl_PMIndCobertura)
vgCodCauEndos = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))
vlIsGar = Txt_PMMesGar.Text

'I--- ABV 19/10/2007 ---
        Call flLimpiarBeneficiariosMod
'F--- ABV 19/10/2007 ---
        vgNum_pol = Trim(Txt_PenPoliza.Text)
        vgCausaEndoso = fgObtenerCodigo_TextoCompuesto(Cmb_EndCauEnd.Text)
'        Call fgCalcularPorcentajeBenef(vlFecVigencia, vlNumCargas, stBeneficiariosMod)
        
        If vlNumCargas <> 1 Then
            Call fgCalcularPorcentajeBenef(vlFecVigencia, vlNumCargas, stBeneficiariosMod, vlCodTipPension, vlMtoPensionRef, False, vlCodDerCrecerCot, vlIndCobertura, True, vlIsGar)
        End If
        
        If (vgError = 0) Then
            Call flInicializaGrillaBenef(Msf_BMGrilla)
            Call flCargaGrillaBeneficiarios(Msf_BMGrilla, stBeneficiariosMod)
    '        Lbl_BMFecNHM = 99991231
    '        Lbl_BMFecNHM = DateSerial(Mid((Lbl_BMFecNHM), 1, 4), Mid((Lbl_BMFecNHM), 5, 2), Mid((Lbl_BMFecNHM), 7, 2))
    '        Lbl_BMDerAcrecer = "99"
    '        Lbl_BMPrcLegal = "1"
    '        Lbl_BMMtoPension = "1"
            
            'flCalculaFechasBeneficiarios
            ''para titulares unicos beneficiarios
            
           
            Lbl_PMNumCar = (Msf_BMGrilla.rows - 1)
            
            
            vlSwCalIntOK = True
            
            MsgBox "El cálculo ha finalizado Correctamente.", vbInformation, "Operación Realizada"
        Else
            MsgBox "El Cálculo no ha podido llevarse a cabo correctamente.", vbCritical, "Operación Cancelada"
        End If
        
        Cmd_BMSumar.SetFocus
        
'    End If
    
Exit Sub
Err_Cmd_BMCalcular_Click:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_BMRestar_Click()
On Error GoTo Err_Cmd_BMRestar

    If Lbl_BMNumOrd.Caption <> "" Then
        Msf_BOGrilla.row = 1
        Msf_BOGrilla.Col = 0
        vlPos = Msf_BOGrilla.row
        vlSwEncontrado = False
        While vlPos <= Msf_BOGrilla.rows - 1
            If Trim(Lbl_BMNumOrd.Caption) = Trim(Msf_BOGrilla.Text) Then
                'Si el beneficiario es encontrado, NO puede ser eliminado
                vlSwEncontrado = True
                MsgBox "El Beneficiario Seleccionado No puede ser Eliminado.", vbInformation, "Información"
                Exit Sub
            Else
                'Si el beneficiario es encontrado, SI puede ser eliminado
                vlSwEncontrado = False
            End If
            vlPos = vlPos + 1
            If Msf_BOGrilla.row < Msf_BOGrilla.rows - 1 Then
                Msf_BOGrilla.row = vlPos
            End If
        Wend
    Else
        MsgBox "Debe Seleccionar el Beneficiario que Desea Eliminar.", vbInformation, "Información"
        Exit Sub
    End If
    
    If vlSwEncontrado = False Then
        vgRes = MsgBox(" ¿ Está seguro que desea Eliminar este Beneficiario ?", 4 + 32 + 256, "Operación de Ingreso")
        If vgRes <> 6 Then
            Cmd_Salir.SetFocus
            Screen.MousePointer = 0
            Exit Sub
        End If
    End If
    
    Msf_BMGrilla.RemoveItem Msf_BMGrilla.row
    
    'ReAsignar Números de Orden a Registros Nuevos
    Msf_BMGrilla.row = 1
    Msf_BMGrilla.Col = 0
    vlPos = Msf_BMGrilla.row
    While vlPos <= Msf_BMGrilla.rows - 1
        If Trim(Msf_BMGrilla.Text) <> vlPos Then
            'Si el número de línea es distinto al número de orden
            Msf_BMGrilla.Text = vlPos
        End If
        vlPos = vlPos + 1
        If Msf_BMGrilla.row < Msf_BMGrilla.rows - 1 Then
            Msf_BMGrilla.row = vlPos
        End If
    Wend
    
    Msf_BMGrilla.row = 1
    Call flCargaDatosBeneficiariosMod(Msf_BMGrilla.row)
    
Exit Sub
Err_Cmd_BMRestar:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_BMSumar_Click()
On Error GoTo Err_CmdSumarClick
           
    vlSwCalIntOK = True
    
    Call flValidacionPreviaBen
    
    If vlSwCalIntOK = False Then
        Exit Sub
    End If
    
    Call flBenefConFecFall
    
    If vlSwCalIntOK = False Then
        Exit Sub
    End If
    
    If vlSwCalIntOK = True Then
        
'        Call flDeshabilitarPolMod
'        Call flDeshabilitarBenMod
            
        If Lbl_BMNumOrd = "" Then
        'Si es un Beneficiario Nuevo
            vlNumero = InStr(Cmb_PMTipPen.Text, "-")
            vlCodTipPension = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
            vlNumero = InStr(Cmb_BMDerPen.Text, "-")
            vlCodEstPension = Trim(Mid(Cmb_BMDerPen.Text, 1, vlNumero - 1))
            
            vlCodDerpen = flObtenerDerPen(vlCodTipPension, vlCodEstPension, Trim(Txt_BMFecFall))
            vlCodMotReqPen = "1"
            vlMtoPensionGar = 0
            
            vlNumPoliza = Trim(Txt_PenPoliza)
            vlNumEndoso = Trim(Lbl_End)
                        
            vlCodCauSusBen = ""
            vlFecSusBen = ""
            vlFecIniPagoPen = ""
            vlFecTerPagoPenGar = ""
            
        End If
           
           
           
'    If vlSwCalIntOK = True Then
           
    '    vlNumero = InStr(Cmb_TipoRetencion.Text, "-")
    '    vlOpcion = Trim(Mid(Cmb_TipoRetencion.Text, 1, vlNumero - 1))
    '
    
        If Mid(Cmb_EndCauEnd.Text, 1, 2) = "07" And Msf_BMGrilla.row <> 1 Then
                MsgBox "Solo el titular puede excluirse por fallecimiento.", vbInformation, "Información"
                Exit Sub
                Msf_BMGrilla.row = 1
        End If
    
        'Ingresar Nuevo Beneficiario
        If Lbl_BMNumOrd.Caption = "" Then
            vgRes = MsgBox(" ¿ Está seguro que desea Ingresar este Beneficiario ?", 4 + 32 + 256, "Operación de Ingreso")
            If vgRes <> 6 Then
                Cmd_Salir.SetFocus
                Screen.MousePointer = 0
                Exit Sub
                vlSwCalIntOK = False
            End If
            
            vlNumero = InStr(Cmb_BMPar.Text, "-")
            vlOpcion = Trim(Mid(Cmb_BMPar.Text, 1, vlNumero - 1))
            If vlOpcion = clCodParCau Then
               MsgBox "No Puede Ingresar un Beneficiario con Parentesco Causante", vbInformation, "Información"
               vlSwCalIntOK = False
               Exit Sub
            End If
            
            vlNumOrden = Trim(Msf_BMGrilla.rows)
            Lbl_BMNumOrd = Trim(vlNumOrden)
            Call flObtenerDatosBenef
            Call flIngresarBenef
            Call flHabilitarPolMod
            Call flHabilitarBenMod
            
            'I--- ABV 20/04/2005 ---
            'Call flHabilitarPenGar
            If flObtenerDerechoPeriodoGarantizado(fgObtenerCodigo_TextoCompuesto(Cmb_PMTipPen), fgObtenerCodigo_TextoCompuesto(Cmb_BMPar)) = True Then
                Txt_BMMtoPensionGar.Enabled = True
            Else
                Txt_BMMtoPensionGar.Enabled = False
            End If
  
            'F--- ABV 20/04/2005 ---
            'RRR 10/06/2013
            'frmDatosGen.Visible = False
        Else
            'Modificar Beneficiario
            
            If Not SwActivacion Then 'Para no preguntar nuevamente si viene por activacion de beneficiario
                vgRes = MsgBox("¿ Está seguro que desea Modificar los Datos del Beneficiario?", 4 + 32 + 256, "Operación de Actualización")
                If vgRes <> 6 Then
                    Screen.MousePointer = 0
                    SwActivacion = False
                    
                    Exit Sub
                    vlSwCalIntOK = False
                End If
            
            End If
            
            vlNumOrden = Trim(Lbl_BMNumOrd)
            Call flObtenerDatosBenef
            Call flModificarBenef
            Call flHabilitarPolMod
            Call flHabilitarBenMod
            
            'I--- ABV 20/04/2005 ---
            'Call flHabilitarPenGar
            If flObtenerDerechoPeriodoGarantizado(fgObtenerCodigo_TextoCompuesto(Cmb_PMTipPen), fgObtenerCodigo_TextoCompuesto(Cmb_BMPar)) = True Then
                Txt_BMMtoPensionGar.Enabled = True
            Else
                Txt_BMMtoPensionGar.Enabled = False
            End If
            'F--- ABV 20/04/2005 ---
        End If
        Lbl_PMNumCar = (Msf_BMGrilla.rows - 1)
        
        'If Lbl_BMNumOrd = 1 Then
        '    Lbl_EndMtoPensionOrig = txt_BMMtoPension
        '    Lbl_EndMtoPensionCalc = txt_BMMtoPension
        'End If
        
        
'        Call flDeshabilitarPolMod
'        Call flDeshabilitarBenMod




    Else
        'MsgBox "Debe Realizar el Procedimiento de Cálculo", vbInformation, "Información"
        MsgBox "Existen problemas en el Ingreso de la Información.", vbCritical, "Proceso Cancelado"
        vlSwCalIntOK = False
    End If
    
    vlSwCalIntOK = False
    
Exit Sub
Err_CmdSumarClick:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
        
    End Select

End Sub

Private Sub Cmd_Buscar_Click()
On Error GoTo Err_CmdBuscarClick

    Frm_Busqueda.flInicio ("Frm_EndosoPol")
    
Exit Sub
Err_CmdBuscarClick:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_BuscarDir_Click()
On Error GoTo Err_Buscar

    Frm_BusDireccion.flInicio ("Frm_EndosoPol")
    
Exit Sub
Err_Buscar:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Sub

Private Sub Cmd_BuscarFecEfe_Click()
    
    Txt_EndFecEfecto = ""
    Txt_EndFecEfecto = flCalculaFechaEfecto(Txt_EndFecEfecto)

End Sub

Private Sub Cmd_BuscarPendiente_Click()
On Error GoTo Err_Cmd_BuscarPendiente_Click

    'Validar ingreso de Número de Póliza
    Txt_PenPoliza = Trim(Txt_PenPoliza)
    If (Txt_PenPoliza = "") Then
        MsgBox "Debe indicar el N° de Póliza a buscar.", vbCritical, "Error de Datos"
        Exit Sub
    End If
    
'Buscar Monto de la Pensión Original y Modificada registrada en el Endoso
    vgQuery = "SELECT mto_diferencia,mto_pensionori,mto_pensioncal "
    vgQuery = vgQuery & "FROM PP_TMAE_ENDOSO "
    vgQuery = vgQuery & "WHERE "
    vgQuery = vgQuery & "num_poliza = '" & Trim(Txt_PenPoliza) & "' "
'    vgQuery = vgQuery & " AND num_endoso = " & inumendoso & " "
    Set vgRs = vgConexionBD.Execute(vgQuery)
    If Not vgRs.EOF Then
        vlMtoPensionActOriginal = vgRs!mto_pensionori
        vlMtoPensionActModificada = vgRs!mto_pensioncal
    End If
    vgRs.Close

    vlTipoBuscar = "P"
    vlTablaPoliza = clTablaPolizaTmp
    vlTablaBen = clTablaBenTmp
    Call Cmd_BuscarPol_Click
    vlTipoBuscar = "N"
    vlTablaPoliza = clTablaPolizaOri
    vlTablaBen = clTablaBenOri
    
    If (Trim(Txt_PenPoliza) <> "") And (Trim(Lbl_End) <> "") Then
        'Buscar Datos del Endoso
        If (flBuscarDatosEndosoPreliminar(Trim(Txt_PenPoliza), Trim(Lbl_End)) = False) Then
            'Enviar mensaje de Error en la muestra de los datos registrados
        Else
            vlSwCalIntOK = True
            vlSwCalExtOK = True
            vlSwGrabar = True
            vlSwAprobar = False
            
            Fra_PM.Enabled = False
            Fra_BM.Enabled = False
            Fra_Endoso.Enabled = False
        End If
    End If
    
Exit Sub
Err_Cmd_BuscarPendiente_Click:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_BuscarPol_Click()
Dim vlRegistro As ADODB.Recordset
Dim vlMontoPensionAux As Double
Dim vlFechaEndosoAux As String
Dim vlMontoPensionGar, vlMontoPensionBas As Double

On Error GoTo Err_CmdBuscarPolClick
        
    'I--- ABV 25/04/2005 ---
    vlTablaPolizaOriginal = clTablaPolizaOri
    vlTablaBenOriginal = clTablaBenOri
    'F--- ABV 25/04/2005 ---
    
'    vlMtoPensionActOriginal = 0
'    vlMtoPensionActModificada = 0
    
    vgPalabraAux = ""
    If vlTipoBuscar = "N" Then
       vlTablaPoliza = clTablaPolizaOri
       vlTablaBen = clTablaBenOri
    Else
        vlTablaPoliza = clTablaPolizaTmp
        vlTablaBen = clTablaBenTmp
    End If
    
    Txt_PenPoliza = Trim(Txt_PenPoliza)
    Txt_PenNumIdent = Trim(UCase(Txt_PenNumIdent))
    
    'Formateando los datos de num_poliza y Cod_TipoIdenben ingresados
    'para realizar la busqueda
    If Txt_PenPoliza.Text = "" Then
       If (Cmb_PenNumIdent.Text <> "") And (Txt_PenNumIdent.Text <> "") Then
'          Or _ (Not ValiRut(Txt_PenRut.Text, Txt_PenDigito.Text)) Then
'           MsgBox "Debe Ingresar el Número de Póliza o Rut del Pensionado.", vbCritical, "Error de Datos"
'           Txt_PenPoliza.SetFocus
'           Exit Sub
'       Else
           vlCodTipoIdenAux = fgObtenerCodigo_TextoCompuesto(Cmb_PenNumIdent)
           vlNumIdenAux = Txt_PenNumIdent
       End If
    Else
        Txt_PenPoliza.Text = Trim(Txt_PenPoliza.Text)
    End If
    
    vgPalabra = ""
'SE INGRESO POLIZA Y RUT
'Seleccionar beneficiario, según número de póliza y rut de beneficiario.
    If (Txt_PenPoliza.Text <> "") And (Cmb_PenNumIdent.Text <> "") And (Txt_PenNumIdent.Text <> "") Then
        vlCodTipoIdenAux = fgObtenerCodigo_TextoCompuesto(Cmb_PenNumIdent)
        vlNumIdenAux = Txt_PenNumIdent
        vgPalabra = "num_poliza = '" & Txt_PenPoliza.Text & "' AND "
        vgPalabra = vgPalabra & "cod_tipoidenben = " & vlCodTipoIdenAux & " "
        vgPalabra = vgPalabra & "AND num_idenben = '" & vlNumIdenAux & "' "
    Else
'SE INGRESO POLIZA
'Seleccionar, según número de póliza, el primer beneficiario con derecho a pensión.
'En caso de no existir, seleccionar sólo el primer beneficiario sin derecho.
        If Txt_PenPoliza.Text <> "" Then
            'CMV-20051107 I
'           vgSql = ""
'           vgSql = "SELECT COUNT(num_orden) as NumeroBen "
'           vgSql = vgSql & "FROM " & vlTablaBen & " WHERE "
'           vgSql = vgSql & "num_poliza = '" & Txt_PenPoliza.Text & "' "
'           If vlTipoBuscar = "N" Then
'              vgSql = vgSql & "AND cod_estpension <> '" & clCodSinDerPen & "' "
'           End If
'           vgSql = vgSql & "ORDER BY num_endoso DESC, num_orden ASC "
'           Set vgRegistro = vgConexionBD.Execute(vgSql)
'           If (vgRegistro!numeroben) <> 0 Then
'              vgPalabra = "num_poliza = '" & Txt_PenPoliza.Text & "' "
'              If vlTipoBuscar = "N" Then
'                 vgPalabraAux = vgPalabra & "AND cod_estpension <> '" & clCodSinDerPen & "' "
'              End If
'           Else
               vgPalabra = "num_poliza = '" & Txt_PenPoliza.Text & "' "
'           End If
            'CMV-20051107 F
        Else
'SE INGRESO RUT
'Seleccionar beneficiario, según rut beneficiario. (Datos de primera póliza encontrada.)
            If (Cmb_PenNumIdent.Text <> "") And (Txt_PenNumIdent.Text <> "") Then
                vlCodTipoIdenAux = fgObtenerCodigo_TextoCompuesto(Cmb_PenNumIdent)
                vlNumIdenAux = Txt_PenNumIdent
                vgPalabra = "cod_tipoidenben = " & vlCodTipoIdenAux & " "
                vgPalabra = vgPalabra & "AND num_idenben = '" & vlNumIdenAux & "' "
            End If
        End If
    End If
    
'Ejecutar selección según los parámetros correspondientes, contenidos en
'variable vgpalabra
    
    'Confirmar existencia de PREENDOSO
    If vlTipoBuscar = "N" Then
        vgSql = ""
        vgSql = "SELECT num_poliza "
        vgSql = vgSql & "FROM " & clTablaBenTmp & " "
        If (vgPalabra <> "") Then
            vgSql = vgSql & "WHERE "
            vgSql = vgSql & vgPalabra
        End If
        vgSql = vgSql & " ORDER BY num_endoso DESC,num_orden ASC "
        Set vgRs2 = vgConexionBD.Execute(vgSql)
        If Not vgRs2.EOF Then
           MsgBox "El Beneficiario o la Póliza Ingresada, tienen un registro de Endoso Pendiente. No es posible crear un nuevo Endoso hasta finalizar el que se encuentra en Etapa Preliminar.", vbCritical, "Existencia de Póliza Preliminar"
           Txt_PenPoliza.SetFocus
           vlTipoBuscar = "N"
           vlTablaPoliza = clTablaPolizaOri
           vlTablaBen = clTablaBenOri
           Exit Sub
        End If
        If vgPalabraAux <> "" Then
           vgPalabra = vgPalabraAux
        End If
    End If
    
    If (vgPalabra <> "") Then vgPalabra = vgPalabra & " AND "
    'Ejecutar Consulta
    vgSql = ""
    vgSql = "SELECT num_endoso,num_orden,gls_nomben,gls_nomsegben,gls_patben,gls_matben, "
    vgSql = vgSql & "cod_estpension,cod_tipoidenben,num_idenben,num_poliza "
    vgSql = vgSql & "FROM " & vlTablaBen & " b WHERE "
    vgSql = vgSql & vgPalabra & " "
    'CMV-20051107 I
    vgSql = vgSql & " "
    vgSql = vgSql & " num_endoso = (SELECT MAX (num_endoso) as numero "
    vgSql = vgSql & "FROM " & vlTablaPoliza & " "
    vgSql = vgSql & "WHERE num_poliza = b.num_poliza) "
    'CMV-20051107 F
    vgSql = vgSql & " ORDER BY num_endoso DESC,num_orden ASC "
    Set vgRs2 = vgConexionBD.Execute(vgSql)
    If Not vgRs2.EOF Then
     
'       If Trim(vgRs2!Cod_EstPension) = Trim(clCodSinDerPen) Then
'          MsgBox " El Beneficiario Seleccionado No Tiene Derecho a Pensión " & Chr(13) & _
'                 "          Sólo podrá Consultar los Datos del Registro", vbInformation, "Información"
'
'          'Desactivar Todos los Controles del Formulario
'
'
'       Else
                 
            If Txt_PenPoliza.Text <> "" Then
               vlCodTipoIdenAux = vgRs2!Cod_TipoIdenBen
               vlNumIdenAux = vgRs2!Num_IdenBen
               Call fgBuscarPosicionCodigoCombo(vlCodTipoIdenAux, Cmb_PenNumIdent)
               Txt_PenNumIdent = vlNumIdenAux
            Else
                Txt_PenPoliza.Text = Trim(vgRs2!num_poliza)
            End If
                 
'           If Not fgValidaVigenciaPoliza(Trim(Txt_PenPoliza.Text), fgBuscaFecServ) Then
'              MsgBox " La Póliza Ingresada no se Encuentra Vigente en el Sistema " & Chr(13) & _
'                     "      Sólo podrá Consultar los Datos del Registro", vbInformation, "Información"
'
'              'Desactivar Todos los Controles del Formulario
'
'
'           Else
''               Fra_Grupo.Enabled = True
''               SSTab_Consulta.Enabled = True
''               SSTab_Consulta.Tab = 0
'           End If
          
       'End If

       If Txt_PenPoliza.Text <> "" Then
            vlCodTipoIdenAux = vgRs2!Cod_TipoIdenBen
            vlNumIdenAux = vgRs2!Num_IdenBen
            Call fgBuscarPosicionCodigoCombo(vlCodTipoIdenAux, Cmb_PenNumIdent)
            Txt_PenNumIdent = vlNumIdenAux
       Else
           Txt_PenPoliza.Text = Trim(vgRs2!num_poliza)
       End If
              
        vlNomBen = Trim(vgRs2!Gls_NomBen)
        vlNomSegBen = IIf(IsNull(vgRs2!Gls_NomSegBen), "", vgRs2!Gls_NomSegBen)
        vlPaternoBen = Trim(vgRs2!Gls_PatBen)
        vlMaternoBen = IIf(IsNull(vgRs2!Gls_MatBen), "", vgRs2!Gls_MatBen)
    
        vlNombreCompleto = fgFormarNombreCompleto(vlNomBen, vlNomSegBen, vlPaternoBen, vlMaternoBen)
              
        Lbl_PenNombre.Caption = vlNombreCompleto
        Lbl_End.Caption = (vgRs2!num_endoso)
        vlNumPoliza = (vgRs2!num_poliza)
        vlNumEndoso = (vgRs2!num_endoso)
        vlNumOrden = (vgRs2!Num_Orden)
        
        'Carga Estructura para Carpeta Poliza Original
        Call flCargaEstructuraPoliza(vlTablaPolizaOriginal, vlNumPoliza, vlNumEndoso, stPolizaOri)
        'Carga Estructura para Carpeta Poliza Modificada
        Call flCargaEstructuraPoliza(vlTablaPoliza, vlNumPoliza, vlNumEndoso, stPolizaMod)
        'Carga Estructura para Carpeta Beneficiarios Original
        Call flCargaEstructuraBeneficiarios(vlTablaBenOriginal, vlNumPoliza, vlNumEndoso, stBeneficiariosOri)
        
        Call flInicializaGrillaBenef(Msf_BOGrilla)
        Call flCargaGrillaBeneficiarios(Msf_BOGrilla, stBeneficiariosOri())
        
        'Carga Estructura para Carpeta Beneficiarios Modificado
        Call flCargaEstructuraBeneficiarios(vlTablaBen, vlNumPoliza, vlNumEndoso, stBeneficiariosMod)
        
        'Implementacion GobiernoDeDatos(Se cargan los datos de direccion y telefono de la tablas nuevas creadas de endosos)
        
        Dim texto As String
        'Agregado para enviar la trama anterior en el Json del servicio 15052019_
        Call flCargaEstructuraBeneficiariosDirec(vlTablaBen, vlNumPoliza, vlNumEndoso, stPolizaBenDirecOri, "BEN", texto)
        'Carga estructura de direccion de beneficiarios Original
        Call flCargaEstructuraBeneficiariosDirec(vlTablaBen, vlNumPoliza, vlNumEndoso, stPolizaBenDirecMod, "BEN", texto)
        
        'Carga estructura de direccion de beneficiarios Modificado
        Call flCargaEstructuraBeneficiariosDirec(vlTablaBen, vlNumPoliza, vlNumEndoso, stPolizaBenDirec, "ENDBEN", texto)
        vgSql = ""
        vgSql = "SELECT num_poliza FROM PP_TMAE_ENDBEN "
        vgSql = vgSql & "WHERE num_poliza = " & Txt_PenPoliza.Text & " ORDER BY num_endoso DESC,num_orden ASC "
        'txtprueba.Text = vgSql
        Set vgRs2 = vgConexionBD.Execute(vgSql)
        If Not vgRs2.EOF Then
        stPolizaBenDirecMod = stPolizaBenDirec
        End If
        
        'fin Implementacion GobiernoDeDatos()_



        Call flInicializaGrillaBenef(Msf_BMGrilla)
        Call flCargaGrillaBeneficiarios(Msf_BMGrilla, stBeneficiariosMod())
        
        Call flCargaDatosPolizaOri
        Call flCargaDatosPolizaMod
        
        Msf_BMGrilla.row = 1
        'I--- ABV 25/04/2005 ---
        'Call flCargaDatosBeneficiariosOri(Msf_BMGrilla.Row)
        Call flCargaDatosBeneficiariosOri(Msf_BOGrilla.row)
        'F--- ABV 25/04/2005 ---
        Msf_BMGrilla.row = 1
        Call flCargaDatosBeneficiariosMod(Msf_BMGrilla.row)
        
        Call flCargaDatosBeneficiariosModDatGen(1)
        'Exit Sub
'I--- ABV 27/09/2007 ---
        If (vlTipoBuscar <> "P") Then
            If IsDate(Txt_EndFecEfecto) Then
                vlFechaEndosoAux = Format(Txt_EndFecEfecto, "yyyymmdd")
            Else
                vlFechaEndosoAux = Format(flCalculaFechaEfecto(""), "yyyymmdd")
            End If
    

            
            vlMtoPensionActOriginal = flBuscarPensionBase(vlTablaPolizaOriginal, vlFechaEndosoAux, vlNumPoliza, 1, "O")
            vlMtoPensionActModificada = flBuscarPensionBase(vlTablaPoliza, vlFechaEndosoAux, vlNumPoliza, 1, "G")
            
            Lbl_EndMtoPensionOrig = Format(vlMtoPensionActOriginal, "#0.00")
            lbl_EndMtoPensionOrigGar = Format(vlMtoPensionActModificada, "#0.00")
            
            vlMtoPensionActOriginal = flBuscarPensionActual(vlFechaEndosoAux, vlNumPoliza, CInt(Lbl_End), "O")
            vlMtoPensionActModificada = flBuscarPensionActual(vlFechaEndosoAux, vlNumPoliza, CInt(Lbl_End), "G")
            
            Lbl_EndMtoPensionCalc = Format(vlMtoPensionActOriginal, "#0.00")
            lbl_EndMtoPensionCalcGar = Format(vlMtoPensionActModificada, "#0.00")
            
            txt_EndMtoPensionCalc = Format(vlMtoPensionActOriginal, "#0.00")
            txt_EndMtoPensionCalcGar = Format(vlMtoPensionActModificada, "#0.00")
            

            vlI = 1
            If (Msf_BMGrilla.rows > 1) Then
                While vlI <= (Msf_BMGrilla.rows - 1)
                    
                    vlPorcBenef = 0
                    vlPenBenef = 0
                    vlPenGarBenef = 0
                    vlSwDerPerGar = False
                            
'                    If (CInt(Txt_PMMesGar) > 0) Then
'                        vlMontoPensionFinal = lbl_EndMtoPensionCalcGar
'                    Else
'                        vlMontoPensionFinal = Lbl_EndMtoPensionCalc
'                    End If
                            
                    vlMontoPensionGar = lbl_EndMtoPensionCalcGar
                    vlMontoPensionBas = Lbl_EndMtoPensionCalc
                            
                            
        '            'Verificar el Estado de Derecho a Pensión (Cod_EstPension)
        '            If (Msf_BMGrilla.TextMatrix(vlI, 11) <> "10") Then
                    'Verificar el Estado de Derecho a Pensión (Cod_DerPen)
                    If (Msf_BMGrilla.TextMatrix(vlI, 11) <> "10") Then
                        vlPorcBenef = IIf(Msf_BMGrilla.TextMatrix(vlI, 20) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 20))
                        'Determinar el monto de la Pensión del Beneficiario
                        'Penben(i) = IIf(Msf_BMGrilla.TextMatrix(vlI, 17) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 17))
                        vlPenBenef = vlMontoPensionBas * (vlPorcBenef / 100)
                        'F--- ABV 19/04/2005 ---
                    '*************************************
                    Else
                    
                    End If
                    
                    'Actualizar el Monto de la Pensión
                    Msf_BMGrilla.TextMatrix(vlI, 19) = Format(vlPenBenef, "#,#0.00")
                    
                    'Actualizar el Monto de la Pensión Garantizada
                    'Calcular el Porcentaje del Periodo Garantizado
                    'If (vlMesesGar > 0) Then
                    If (CInt(Txt_PMMesGar) > 0) Then
                        vlPorcGarBenef = IIf(Msf_BMGrilla.TextMatrix(vlI, 30) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 30))
                        vlPenGarBenef = vlMontoPensionGar * (vlPorcGarBenef / 100)
                        Msf_BMGrilla.TextMatrix(vlI, 24) = Format(vlPenGarBenef, "#,#0.00")
        '                Msf_BMGrilla.TextMatrix(vlI, 24) = Format(vlPenGarBenef, "#,#0.00")
        '                vlPorcGarBenef = Format((vlPenGarBenef * 100) / vlPension, "#0.000000000")
        '                Msf_BMGrilla.TextMatrix(vlI, 30) = vlPorcGarBenef
                    Else
                        Msf_BMGrilla.TextMatrix(vlI, 24) = Format(0, "#,#0.00")
                        Msf_BMGrilla.TextMatrix(vlI, 30) = 0
                    End If
                    
                    vlI = vlI + 1
                Wend
            Else
                'Error ya que deben existir beneficiarios en la Grilla de Modificación
                
            End If
 
        Else
        
            vlMtoPensionActOriginal = flBuscarPensionBase(vlTablaPolizaOriginal, vlFechaEndosoAux, vlNumPoliza, 1, "O")
            vlMtoPensionActModificada = flBuscarPensionBase("PP_TMAE_POLIZA", vlFechaEndosoAux, vlNumPoliza, 1, "G")
            
            Lbl_EndMtoPensionOrig = Format(vlMtoPensionActOriginal, "#0.00")
            lbl_EndMtoPensionOrigGar = Format(vlMtoPensionActModificada, "#0.00")
            
            vlMtoPensionActOriginal = flBuscarPensionActual(vlFechaEndosoAux, vlNumPoliza, CInt(Lbl_End), "O")
            vlMtoPensionActModificada = flBuscarPensionActual(vlFechaEndosoAux, vlNumPoliza, CInt(Lbl_End), "G")
            
            Lbl_EndMtoPensionCalc = Format(vlMtoPensionActOriginal, "#0.00")
            lbl_EndMtoPensionCalcGar = Format(vlMtoPensionActModificada, "#0.00")
            
            txt_EndMtoPensionCalc = Format(vlMtoPensionActOriginal, "#0.00")
            txt_EndMtoPensionCalcGar = Format(vlMtoPensionActModificada, "#0.00")
        
        
            'If (stPolizaOri.Cod_Moneda = vgMonedaCodOfi) Then
            If stPolizaOri.Cod_TipReajuste <> cgSINAJUSTE Then 'hqr 13/01/2011
                'Corregir los Datos de la Póliza Original
                Lbl_POMtoPen = Format(vlMtoPensionActOriginal, "#0.00")
                'Corregir la información de la Pensión de Referencia en la Estructura que recibe la Pensión
                stPolizaOri.Mto_Pension = vlMtoPensionActOriginal
                If (stPolizaOri.Num_MesGar > 0) Then
                    stPolizaOri.Mto_PensionGar = vlMtoPensionActOriginal
                Else
                    stPolizaOri.Mto_PensionGar = 0
                End If
                
                vlMtoPensionAct = vlMtoPensionActOriginal
                
                For vgI = 1 To Msf_BOGrilla.rows - 1
                    
                    vlDerechoPerGar = False
                    If (stPolizaOri.Num_MesGar > 0) Then
                        If (flObtenerDerechoPeriodoGarantizado(stPolizaOri.Cod_TipPension, Msf_BOGrilla.TextMatrix(vgI, 7)) = True) Then
                            vlDerechoPerGar = True
                        End If
                    End If
                    
                    vlPrcPensionBenef = Msf_BOGrilla.TextMatrix(vgI, 20)
                    vlPrcPensionGarBenef = Msf_BOGrilla.TextMatrix(vgI, 31)
                    vlMtoPensionActBenef = Format((vlPrcPensionBenef / 100) * vlMtoPensionAct, "#0.00")
                    
        'I--- ABV 19/10/2007
                    If (stPolizaOri.Num_MesGar > 0) Then
        '            If (vlDerechoPerGar = True) Then
        'F--- ABV 19/10/2007
                        If (CDbl(Msf_BOGrilla.TextMatrix(vgI, 24)) <> 0) Then
                            vlMtoPensionActGarBenef = Format((vlPrcPensionGarBenef / 100) * vlMtoPensionAct, "#0.00")
                        Else
                            vlMtoPensionActGarBenef = 0
                        End If
                    Else
                        vlMtoPensionActGarBenef = 0
                    End If
                    
                    'Arregla la información en la Grilla
                    Msf_BOGrilla.TextMatrix(vgI, 19) = vlMtoPensionActBenef
                    Msf_BOGrilla.TextMatrix(vgI, 24) = vlMtoPensionActGarBenef
                    'Arregla la información en la Estructura
                    stBeneficiariosOri(vgI).Mto_Pension = vlMtoPensionActBenef
                    stBeneficiariosOri(vgI).Mto_PensionGar = vlMtoPensionActGarBenef
                    
    '                If (Msf_BOGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BOGrilla.TextMatrix(vgI, 22) <> "10") Then
    '                    vlSumaPension = vlSumaPension + vlMtoPensionActBenef
    '                    vlSumaPensionGar = vlSumaPensionGar + vlMtoPensionActGarBenef
    '                End If
                Next
            End If
            
            
            
'            'Corregir los Datos de la Póliza Modificada
'            'Lbl_EndMtoPensionOrig = Format(vlMtoPensionAct, "#0.00")
'            'Corregir la información de la Pensión de Referencia en la Estructura que recibe la Pensión
'            stPolizaMod.Mto_Pension = vlMtoPensionActModificada
'            If (stPolizaMod.Num_MesGar > 0) Then
'                stPolizaMod.Mto_PensionGar = vlMtoPensionActModificada
'            Else
'                stPolizaMod.Mto_PensionGar = 0
'            End If
'
'            vlMtoPensionActOriginal = stPolizaOri.Mto_Pension
'            vlMtoPensionActModificada = stPolizaMod.Mto_Pension
        End If
'F--- ABV 27/09/2007 ---
        
'       Call flCargaDatosBeneficiariosOri
'       Call flCargaDatosBeneficiariosMod
        
        Fra_Poliza.Enabled = False
        SSTab_EndosoPoliza.Enabled = True
        SSTab_EndosoPoliza.Tab = 0
        SSTab_PolizaModificada.Enabled = True
        SSTab_PolizaOriginal.Enabled = True
        SSTab_PolizaOriginal.Tab = 0
        SSTab_PolizaOriginal.SetFocus
        
        vlTipoBuscar = "N"
        vlTablaPoliza = clTablaPolizaOri
        vlTablaBen = clTablaBenOri
        
        vlSwAprobar = True
  
        'txt_BMMtoPension = Format(0, "#0.00")
        'Txt_BMMtoPensionGar = Format(0, "#0.00")
        'txt_BMPrc = Format(0, "#0.00")
        'txt_BMPrcGar = Format(0, "#0.00")
  
    Else
        If vlTipoBuscar = "N" Then
            MsgBox "El Beneficiario o la Póliza Ingresados, No Existen en la Base de Datos", vbInformation, "Información"
        Else
            MsgBox "El Beneficiario o la Póliza Ingresados, No Tienen Registro de Endoso Preliminar", vbCritical, "Inexistencia de Endoso Preliminar"
        End If
        Txt_PenPoliza.SetFocus
        vlTipoBuscar = "N"
        vlTablaPoliza = clTablaPolizaOri
        vlTablaBen = clTablaBenOri
  
        Exit Sub
    End If
'    vgRs2.Close
    If vgNivel = 11 Then
        Cmb_EndTipoEnd.ListIndex = 1
        Cmb_EndTipoEnd.Enabled = False
    Else
        Cmb_EndTipoEnd.Enabled = True
    End If
    'Cmb_EndTipoEnd_Click
    
      
    Txt_EndFecEnd = fgBuscaFecServ
    Txt_EndFecEfecto = flCalculaFechaEfecto(Txt_EndFecEfecto)
       
Exit Sub
Err_CmdBuscarPolClick:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_Calcular_Click()
On Error GoTo Err_Calcular
    
'I--- ABV 17/11/2005 ---
    vgUtilizarNormativa = "N"
'F--- ABV 17/11/2005 ---

    If (vlSwCalIntOK = False) Then
        MsgBox "Debe relizar el proceso de cálculo de Porcentajes del Grupo Familiar.", vbCritical, "Proceso Cancelado"
        Exit Sub
    End If
    
    'Verificar cálculo a realizar
    vgRes = MsgBox("¿ Está seguro que desea realizar el Proceso de Cálculo ?", 4 + 32 + 256, "Confirmación")
    If vgRes <> 6 Then
        Screen.MousePointer = 0
        Exit Sub
    End If
    
    'Falta realizar la validación del ingreso de TODOS los datos
    
    'Permite realizar la validación de Consistencia de los datos
    Call flValidacionDefinitivaBen

    'En el monto de la Pensión Original debe ir el del endoso Oficial
    'Lbl_EndMtoPensionOrig = ""
    'Lbl_EndMtoPensionCalc = ""
    
    'I--- ABV 14/04/2005 ---
    'CMV - 20051021 I
'    Txt_EndFecEnd = ""
    'CMV - 20051021 F
    'F--- ABV 14/04/2005 ---
    
    'Guardar el Código de la Causal del Endoso
     vlCodCauEndoso = fgObtenerCodigo_TextoCompuesto(Cmb_EndCauEnd.Text)
     vlFecDevengue = Format(CDate(Lbl_PMFecDevengue), "yyyymmdd")
    
    vlPorcentaje = 0
    Lbl_EndCrear = flCalculaNumNuevoEndoso
    If Txt_EndFecEnd = "" Then
        'CMV - 20051021 I
        Txt_EndFecEnd = fgBuscaFecServ
        Txt_EndFecEfecto = ""
        Txt_EndFecEfecto = flCalculaFechaEfecto(Txt_EndFecEfecto)

'        Txt_EndFecEfecto = fgValidaFechaEfecto(Trim(Txt_EndFecEnd), vlNumPoliza, vlNumOrden)
'        If (Txt_EndFecEfecto = "") Then
'            Txt_EndFecEfecto = fgValidaFechaEfecto(Trim(Txt_EndFecEnd), vlNumPoliza, vlNumOrden)
'        Else
'            Txt_EndFecEfecto = fgValidaFechaEfecto(Trim(Txt_EndFecEfecto), vlNumPoliza, vlNumOrden)
'        End If
        'CMV - 20051021 F
    Else
       'Validar que la Fecha de Efecto se encuentre abierta para hacer el endoso
    End If
    
    'Cargar las Tablas de Mortalidad en la Estructura Existente
    Call fgCargarTablaMortalidad(vgTipoPeriodo)
    
    If IsDate(Txt_EndFecEnd) Then
        
        'Buscar el Número Correlativo de las Tablas de Mortalidad
        'Mujeres - RV
        vgPalabra_MortalVit_F = fgComboMortalNombre(Txt_EndFecEnd, vgTipoTablaRentista, vgTipoPeriodo, "F")
        'Mujeres - IT
        vgPalabra_MortalTot_F = fgComboMortalNombre(Txt_EndFecEnd, vgTipoTablaTotal, vgTipoPeriodo, "F")
        'Mujeres - IP
        vgPalabra_MortalPar_F = fgComboMortalNombre(Txt_EndFecEnd, vgTipoTablaParcial, vgTipoPeriodo, "F")
        'Mujeres - BEN
        vgPalabra_MortalBen_F = fgComboMortalNombre(Txt_EndFecEnd, vgTipoTablaBeneficiario, vgTipoPeriodo, "F")
        
        'Hombres - RV
        vgPalabra_MortalVit_M = fgComboMortalNombre(Txt_EndFecEnd, vgTipoTablaRentista, vgTipoPeriodo, "M")
        'Hombres - IT
        vgPalabra_MortalTot_M = fgComboMortalNombre(Txt_EndFecEnd, vgTipoTablaTotal, vgTipoPeriodo, "M")
        'Hombres - IP
        vgPalabra_MortalPar_M = fgComboMortalNombre(Txt_EndFecEnd, vgTipoTablaParcial, vgTipoPeriodo, "M")
        'Hombres - BEN
        vgPalabra_MortalBen_M = fgComboMortalNombre(Txt_EndFecEnd, vgTipoTablaBeneficiario, vgTipoPeriodo, "M")
    End If
    
    If (flCalcularPrimaPension(Lbl_POMtoPri, Txt_PMMtoPrima, Lbl_POMtoPen) = False) Then
        vlSwCalExtOK = False
        
        Fra_PM.Enabled = True
        Fra_BM.Enabled = True
        Fra_Endoso.Enabled = True
        
        MsgBox "La Operación de Cálculo no se ha Realizado. Problemas en los Montos de Prima Original y Modificada.", vbCritical, "Operación Cancelada"
        Exit Sub
    End If
    
    'Validar y Obtener la Fecha de Cotización de la Póliza
    If (fgObtenerFechaCotizacion(Trim(Txt_PenPoliza), vlFecCotizacion) = False) Then
        vlSwCalExtOK = False
        
        Fra_PM.Enabled = True
        Fra_BM.Enabled = True
        Fra_Endoso.Enabled = True
        
        MsgBox "La Fecha de Cotización de la Póliza no se encuentra Registrada.", vbCritical, "Proceso Cancelado"
        Exit Sub
    End If

    'Verificar si existen Diferencias para hacer recálculo de Pensiones
    'vlNumPol = UCase(Trim(Txt_PenPoliza))
    'vlNumEndoso = UCase(Trim(Lbl_End))
    
    If (vlCodCauEndoso = cgCodCausalEndPagoDif) Then
        'Validación cuando se trata de un Adelanto de Pensión Diferida
        vlNumEndoso = UCase(Trim(Lbl_End))
        Dim vlValFecPagoCia As String
        Dim vlValTipRen     As String
        Dim vlValFecEfecto  As String
        
        vlValFecEfecto = Format(Txt_EndFecEfecto, "yyyymmdd")
        
        'Validar que si se trata de un adelanto de la Pensión, realmente se encuentre antes del Pago definido
        'Determinar las Pólizas a calcular
        vgSql = "SELECT num_poliza,num_endoso,cod_tippension,"
        vgSql = vgSql & "Cod_Estado,Fec_Vigencia,Cod_TipRen,"
        vgSql = vgSql & "Cod_Modalidad,Num_MesDif,Num_MesGar,"
        vgSql = vgSql & "fec_inipencia "
        vgSql = vgSql & "FROM PP_TMAE_POLIZA "
        vgSql = vgSql & "WHERE "
        vgSql = vgSql & "num_poliza = '" & Trim(Txt_PenPoliza) & "' "
        vgSql = vgSql & "AND num_endoso = " & vlNumEndoso & " "
        Set vgRs = vgConexionBD.Execute(vgSql)
        If Not vgRs.EOF Then
            vlValFecPagoCia = vgRs!Fec_IniPenCia
            vlValTipRen = vgRs!Cod_TipRen
        End If
        vgRs.Close
        
        If (vlValTipRen <> "1") Then
            If (Mid(vlValFecPagoCia, 1, 6) <= Mid(vlValFecEfecto, 1, 6)) And Mid(Cmb_EndCauEnd.Text, 1, 2) <> "13" Then
                vlSwCalExtOK = False
                
                Fra_PM.Enabled = True
                Fra_BM.Enabled = True
                Fra_Endoso.Enabled = True
                
                MsgBox "La Operación de Cálculo no se ha Realizado, debido a que el adelanto de" & Chr(13) & _
                "de la pensión ya comezó o comienza este mes de Efecto a ser pagada.", vbCritical, "Operación Cancelada"
                Exit Sub
            End If
            
'I--- ABV 01/11/2007 ---
            'Recalcular el Número de Meses Diferidos para generar el Adelanto
            
            If CDate(Txt_EndFecEnd) <> CDate(Lbl_PMFecDevengue) Then
                Txt_PMMesDif = 0
            Else
                Txt_PMMesDif = (CInt(Mid(vlValFecEfecto, 1, 4)) * 12 + CInt(Mid(vlValFecEfecto, 5, 2))) - _
                           (CInt(Mid(vlFecDevengue, 1, 4)) * 12 + CInt(Mid(vlFecDevengue, 5, 2)))
            End If
            
            
'F--- ABV 01/11/2007 ---
        Else
            vlSwCalExtOK = False
            
            Fra_PM.Enabled = True
            Fra_BM.Enabled = True
            Fra_Endoso.Enabled = True

            MsgBox "La Operación de Cálculo no se ha Realizado ya que el adelanto" & Chr(13) & _
            "de una Pensión debe tener Periodo Diferido.", vbCritical, "Operación Cancelada"
            Exit Sub
        
        End If
    End If
    
    If (flValidarDifCalculoPension(Trim(Txt_PenPoliza), Trim(Lbl_End), vlSeCalculaPension) = False) Then
        vlSwCalExtOK = False
        
        Fra_PM.Enabled = True
        Fra_BM.Enabled = True
        Fra_Endoso.Enabled = True
        
        MsgBox "La Operación de Cálculo no se ha Realizado. Problemas en la determinación de las diferencias entre la Póliza Original y la Modificada.", vbCritical, "Operación Cancelada"
        Exit Sub
    End If
    
    
    If Mid(Cmb_EndTipoEnd, 1, 1) = "A" Then
        vlSeCalculaPension = True
    End If
    
    
    
    If (vlSeCalculaPension = False) Then
        If (flCalcularPensionSinDif(Txt_EndFecEfecto) = True) Then
            
            GoTo CalculoNormal
            
            ''I--- ABV 20/04/2005 ---
            ''Las Pensiones Garantizadas no serán calculadas
            ''If (CLng(Txt_PMMesGar) <> 0) Then
            ''    If (flCalcularPensionGarantizada(Txt_EndFecEfecto) = False) Then
            ''        vlSwCalExtOK = False
            ''
            ''        Fra_PM.Enabled = True
            ''        Fra_BM.Enabled = True
            ''        Fra_Endoso.Enabled = True
            ''
            ''        MsgBox "La Operación de Cálculo no se ha Realizado.", vbCritical, "Operación Cancelada"
            ''
            ''    End If
            ''End If
            ''F--- ABV 20/04/2005 ---
            '
            ''Obtener el Tipo de Pensión
            'vlNumero = InStr(Cmb_PMTipPen.Text, "-")
            'vgPalabra = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
            '
            'If (flCalcularDatosAsignarMatriz(Txt_PenPoliza, Format(Txt_EndFecEfecto, "yyyymmdd"), _
            'Format(Txt_PMIniVig, "yyyymmdd"), CInt(Txt_PMMesDif), CInt(Txt_PMMesGar), vgPalabra) = True) Then
            '
            '    Lbl_EndMtoPensionOrig = Lbl_POMtoPen.Caption 'Format("0", "#,#0.00")
            '    Lbl_EndMtoPensionCalc = Format(vlMontoPensionFinal, "#,#0.00") 'Format("0", "#,#0.00")
            '
            '    vlSwCalExtOK = True
            '
            '    Fra_PM.Enabled = False
            '    Fra_BM.Enabled = False
            '    Fra_Endoso.Enabled = False
            '
            '    MsgBox "La Operación de Cálculo se ha Realizado Correctamente.", vbInformation, "Operación Realizada"
            'Else
            '    vlSwCalExtOK = False
            '
            '    Fra_PM.Enabled = True
            '    Fra_BM.Enabled = True
            '    Fra_Endoso.Enabled = True
            '
            '    MsgBox "La Operación de Cálculo no se ha Realizado.", vbCritical, "Operación Cancelada"
            'End If
        Else
            vlSwCalExtOK = False
            
            Fra_PM.Enabled = True
            Fra_BM.Enabled = True
            Fra_Endoso.Enabled = True
            
            MsgBox "La Operación de Cálculo no se ha Realizado.", vbCritical, "Operación Cancelada"
        End If
        
    Else
        If (flCalcularPension(Txt_EndFecEfecto, vlCodCauEndoso) = True) Then
            
CalculoNormal:

            'I--- ABV 20/04/2005 ---
            'Las Pensiones Garantizadas no serán calculadas
            'If (CLng(Txt_PMMesGar) <> 0) Then
            '    If (flCalcularPensionGarantizada(Txt_EndFecEfecto) = False) Then
            '        vlSwCalExtOK = False
            '
            '        Fra_PM.Enabled = True
            '        Fra_BM.Enabled = True
            '        Fra_Endoso.Enabled = True
            '
            '        MsgBox "La Operación de Cálculo no se ha Realizado.", vbCritical, "Operación Cancelada"
            '
            '    End If
            'End If
            'F--- ABV 20/04/2005 ---
            
            'Obtener el Tipo de Pensión
            vlNumero = InStr(Cmb_PMTipPen.Text, "-")
            vgPalabra = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
            
            If (flCalcularDatosAsignarMatriz(Txt_PenPoliza, Format(Txt_EndFecEfecto, "yyyymmdd"), _
            Format(Txt_PMIniVig, "yyyymmdd"), CInt(Txt_PMMesDif), CInt(Txt_PMMesGar), vgPalabra _
            , vlCodCauEndoso, vlFecDevengue) = True) Then
            
                If Mid(Cmb_EndTipoEnd, 1, 1) <> "A" Then
                    Lbl_EndMtoPensionOrig = Format(Lbl_POMtoPen.Caption, "#,#0.00") 'Format("0", "#,#0.00")
                    Lbl_EndMtoPensionCalc = Format(vlMontoPensionFinal, "#,#0.00") 'Format("0", "#,#0.00")
                End If
                vlSwCalExtOK = True
                
                Fra_PM.Enabled = False
                Fra_BM.Enabled = False
                Fra_Endoso.Enabled = False
                
                MsgBox "La Operación de Cálculo se ha Realizado Correctamente.", vbInformation, "Operación Realizada"
            Else
                vlSwCalExtOK = False
                
                Fra_PM.Enabled = True
                Fra_BM.Enabled = True
                Fra_Endoso.Enabled = True
                
                MsgBox "La Operación de Cálculo no se ha Realizado.", vbCritical, "Operación Cancelada"
            End If
        Else
            vlSwCalExtOK = False
            
            Fra_PM.Enabled = True
            Fra_BM.Enabled = True
            Fra_Endoso.Enabled = True
            
            MsgBox "La Operación de Cálculo no se ha Realizado.", vbCritical, "Operación Cancelada"
        End If
    End If
    Call flCargaDatosBeneficiariosModDatGen(Msf_BMGrilla.row)
Exit Sub
Err_Calcular:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_Cancelar_Click()
On Error GoTo Err_Cmd_Cancelar_Click

  Cmb_ViaPago.Clear
  fgComboGeneral vgCodTabla_ViaPago, Cmb_ViaPago

    vlMtoPensionActOriginal = 0
    vlMtoPensionActModificada = 0

    Call flLimpiarFraPenPoliza
    Call flLimpiarPolizaOri
    Call flLimpiarBeneficiariosOri
    Call flLimpiarPolizaMod
    Call flLimpiarBeneficiariosMod
    Call flLimpiarFraEndoso
        
    Call flLimpiarVariables
    
    Fra_Poliza.Enabled = True
    SSTab_EndosoPoliza.Tab = 0
    SSTab_PolizaModificada.Tab = 0
    SSTab_PolizaOriginal.Tab = 0
    SSTab_EndosoPoliza.Enabled = False
    SSTab_PolizaModificada.Enabled = False
    SSTab_PolizaOriginal.Enabled = False
        
    Fra_PM.Enabled = True
    Fra_BM.Enabled = True
    Fra_Endoso.Enabled = True
        
    Txt_PenPoliza.SetFocus
    Me.txt_EndMtoPensionCalc.Text = 0
    Me.txt_EndMtoPensionOrig.Text = 0
    Me.Refresh
    
Exit Sub
Err_Cmd_Cancelar_Click:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_Cargar_Click()
On Error GoTo Err_Cargar

'    If SSTab_PolizaModificada.Tab = 1 Then
    Call flInicializaGrillaBenef(Msf_BMGrilla)
    vgNumBen = Msf_BOGrilla.rows - 1
    Call flCargaGrillaBeneficiarios(Msf_BMGrilla, stBeneficiariosOri())
    Msf_BMGrilla.row = 1
    Call flCargaDatosBeneficiariosMod(Msf_BMGrilla.row)
'    Else
    Call flCargaDatosPolizaMod
'    End If
    
    'Implementacion GobiernoDeDatos(Se cargan los datos de direccion y telefono de la tablas nuevas creadas de endosos)
    
        Dim texto As String
        
        'Agregado para enviar la trama anterior en el Json del servicio 15052019_
        
        Call flCargaEstructuraBeneficiariosDirec(vlTablaBen, vlNumPoliza, vlNumEndoso, stPolizaBenDirecOri, "BEN", texto)
        'Carga estructura de direccion de beneficiarios Original
        Call flCargaEstructuraBeneficiariosDirec(vlTablaBen, vlNumPoliza, vlNumEndoso, stPolizaBenDirecMod, "BEN", texto)
        
        'Carga estructura de direccion de beneficiarios Modificado
        Call flCargaEstructuraBeneficiariosDirec(vlTablaBen, vlNumPoliza, vlNumEndoso, stPolizaBenDirec, "ENDBEN", texto)
        vgSql = ""
        vgSql = "SELECT num_poliza FROM PP_TMAE_ENDBEN "
        vgSql = vgSql & "WHERE num_poliza = " & Txt_PenPoliza.Text & " ORDER BY num_endoso DESC,num_orden ASC "
        'txtprueba.Text = vgSql
        Set vgRs2 = vgConexionBD.Execute(vgSql)
        If Not vgRs2.EOF Then
        stPolizaBenDirecMod = stPolizaBenDirec
        End If
        
     'Fin Implementacion GobiernoDeDatos()_
     
    
    vlSwCalIntOK = True
    vlSwCalExtOK = False
    vlSwGrabar = False
    vlSwAprobar = False
    
    Fra_PM.Enabled = True
    Fra_BM.Enabled = True
    Fra_Endoso.Enabled = True
    
Exit Sub
Err_Cargar:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_CauInv_Click()

    Screen.MousePointer = 11
    Frm_EndosoPol.Enabled = False
'    vgFormulario = "P"  'indica al formulario frm_buscacoti que fue llamado por el boton de Cotizaciones
    Frm_BuscaCauInv.Show
    Screen.MousePointer = 0

End Sub

Private Sub Cmd_CauInv_KeyPress(KeyAscii As Integer)
If KeyAscii = 13 Then
    Cmb_BMPar.SetFocus
End If
End Sub

Private Sub Cmd_Eliminar_Click()
On Error GoTo Err_Cmd_Eliminar_Click

    If (Trim(Txt_PenPoliza) = "") Then
        MsgBox "Debe indicar el Número de Póliza sobre la cual se quiere realizar la Operación.", vbCritical, "Error de Datos"
        Exit Sub
    End If
    
    If Not IsNumeric(Trim(Lbl_End)) Then
        MsgBox "Debe indicar el Número de Endoso sobre el cual se quiere realizar la Operación.", vbCritical, "Erroe de Datos"
        Exit Sub
    End If

    vgRes = MsgBox(" ¿ Está seguro que desea eliminar el Endoso Preliminar creado ?", 4 + 32 + 256, "Operación de Eliminación")
    If vgRes <> 6 Then
        Cmd_Salir.SetFocus
        Screen.MousePointer = 0
        Exit Sub
    End If
    
    vlGlobalNumPoliza = Trim(Txt_PenPoliza)
    vlGlobalNumEndoso = Trim(Lbl_End)
    
    'Validar que se encuentre como un Endoso Preliminar
    vgSql = "SELECT num_poliza "
    vgSql = vgSql & "FROM " & clTablaPolizaTmp & " WHERE "
    vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' "
    'vgSql = vgSql & "ORDER BY num_endoso DESC,num_orden ASC "
    Set vgRs2 = vgConexionBD.Execute(vgSql)
    If vgRs2.EOF Then
        MsgBox "La Póliza no tiene ningún registro de Endoso Preliminar, no es posible realizar la Eliminación.", vbCritical, "Proceso Cancelado"
        vgRs2.Close
        Exit Sub
    End If
    vgRs2.Close
    
    Screen.MousePointer = 11
    
    'Verificar el Estado de la Eliminación
    If (flEliminarPreliminar = False) Then
        MsgBox "El Proceso de Eliminación ha sido cancelado.", vbCritical, "Estado del Proceso"
    Else
        'Limpiar el contenido de la Pantalla con la opción Limpiar
        Call Cmd_Cancelar_Click
    
        MsgBox "El Proceso de Eliminación ha finalizado exitosamente.", vbInformation, "Estado del Proceso"
    End If
    
    Screen.MousePointer = 0
    
Exit Sub
Err_Cmd_Eliminar_Click:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub


Private Sub cmd_grabar_Click()
On Error GoTo Err_Cmd_Grabar_Click

    vlSwGrabar = False
    
          If Mid(Cmb_EndCauEnd.Text, 1, 2) = "07" Then
            Vl_numOrdCausaFac = 1
          End If
          
          If Mid(Cmb_EndCauEnd.Text, 1, 2) = "09" Then
              Vl_numOrdCausaFac = Lbl_BMNumOrd.Caption
          End If
          
  
    If Cmd_Calcular.Enabled = False Then vlSwCalExtOK = True
    
    If Mid(Cmb_EndTipoEnd, 1, 1) = "A" Then vlSwCalExtOK = True
    
  
    
    If vlSwCalExtOK = True Then
    
        vlSwValidaOK = True
        'Validar Endoso
        If vlSwValidaOK = True Then
           Call flValidarEndoso
        Else
            vlSwCalExtOK = False
            Exit Sub
        End If
            
        'Validar Poliza
        If vlSwValidaOK = True Then
           Call flValidarPolizaMod
        Else
            vlSwCalExtOK = False
            Exit Sub
        End If
        
        If vlSwValidaOK = True Then
            'Validar Beneficiarios
            Call flValidarBeneficiariosMod
        Else
            vlSwCalExtOK = False
            Exit Sub
        End If
        
        If vlSwValidaOK = True Then
        
            If (Trim(Txt_PenPoliza) = "") Then
                MsgBox "Debe indicar el Número de Póliza sobre la cual se quiere realizar la Operación.", vbCritical, "Error de Datos"
                Exit Sub
            End If
            
            If Not IsNumeric(Trim(Lbl_End)) Then
                MsgBox "Debe indicar el Número de Endoso sobre el cual se quiere realizar la Operación.", vbCritical, "Erroe de Datos"
                Exit Sub
            End If

            vlGlobalNumPoliza = Trim(Txt_PenPoliza)
            vlGlobalNumEndoso = Trim(Lbl_End)
            vlGlobalNumEndosoCrear = ""

            vgRes = MsgBox(" ¿ Está seguro que desea grabar el Endoso como Preliminar ?", 4 + 32 + 256, "Operación de Grabación Endoso")
            If vgRes <> 6 Then
                'Cmd_Salir.SetFocus
                Screen.MousePointer = 0
                Exit Sub
            End If
        
            Screen.MousePointer = 11
If Not VSw_Pruebas Then

'Implementacion GobiernoDeDatos(Se invoca el servicio de validacion del gestor)
  Dim vlCodCauEndos As String
  vlCodCauEndos = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))
  If Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
    If vlCodCauEndos <> "28" Then
      Dim RpstServicio As Boolean
            If Msf_BMGrilla.rows > 1 Then
               vlPos = 1
              
               While vlPos <= (Msf_BMGrilla.rows - 1)
              
                            Msf_BMGrilla.row = vlPos
                            Msf_BMGrilla.Col = 0
                    
                            If (flFormatearDatosBeneficiarioDefDirc(Msf_BMGrilla.row) = False) Then
                                Cmd_Salir.SetFocus
                                Screen.MousePointer = 0
                                RpstServicio = False
                            End If
                            Msf_BMGrilla.Col = 0
                            Call flCargarDatosBeneficiariosModDirec(Msf_BMGrilla.row)
                            
                            If Msf_BMGrilla.TextMatrix(vlPos, 48) = "1" Then 'Se envia solo si se ha modificado
                            
                                Dim MsgResponse As String
                                RpstServicio = EnviarGestorCliente(MsgResponse, "Validar")
                                If (RpstServicio = False) Then
                                    Screen.MousePointer = 0
                                    MsgBox MsgResponse & " Benef #" & vlPos
                                    Exit Sub
                                End If
                            
                            
                             End If
                      
                     vlPos = vlPos + 1
                  
            Wend
            End If
      End If
 End If
 
End If
'Implementacion GobiernoDeDatos()_

 'Validacion para ingresar la causa de fallecimiento
  If Mid(Cmb_EndCauEnd.Text, 1, 2) = "07" Or Mid(Cmb_EndCauEnd.Text, 1, 2) = "09" Then
    If VlcodCausaFac = "" Then
         Screen.MousePointer = 0
          MsgBox "Debe ingresar la causa del fallecimiento.", vbInformation, "Estado del Proceso"
         Fra_PM.Enabled = True
        Fra_BM.Enabled = True
        Fra_Endoso.Enabled = True
       cmdCausaFac.SetFocus
       
   
       
          Exit Sub
    End If
  End If
            
          
  
    If (flGrabarPreliminarPoliza(vlGlobalNumPoliza, vlGlobalNumEndoso) = True) Then
        MsgBox "El proceso de Grabación ha finalizado Correctamente.", vbInformation, "Estado del Proceso"
    Else
        MsgBox "El proceso de Grabación ha sido cancelado por Problemas en el Proceso.", vbCritical, "Estado del Proceso"
    End If

    Screen.MousePointer = 0
Else
    vlSwValidaOK = True
    Exit Sub
End If
        
        
        
        
        
        
    Else
        MsgBox "Debe Realizar el Procedimiento de Cálculo", vbInformation, "Información"
    
        Fra_PM.Enabled = True
        Fra_BM.Enabled = True
        Fra_Endoso.Enabled = True
    
    End If

    vlSwCalExtOK = False
    
Exit Sub
Err_Cmd_Grabar_Click:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_Imprimir_Click()
On Error GoTo Err_Imprimir

    'Verificar el Número de Póliza
    If (Trim(Txt_PenPoliza) = "") Then
        MsgBox "Debe indicar el Número de Póliza sobre la cual se quiere realizar la Operación.", vbCritical, "Error de Datos"
        Exit Sub
    End If
    'Verificar el Número de Endoso
    If Not IsNumeric(Trim(Lbl_End)) Then
        MsgBox "Debe indicar el Número de Endoso sobre el cual se quiere realizar la Operación.", vbCritical, "Error de Datos"
        Exit Sub
    End If
    
    'Validar que Exista más de un Endoso en la Tabla
    
    
    vlRptNumEndosoPol = 0
    vlRptNumEndosoEnd = 0
    
    vlGlobalNumPoliza = Trim(Txt_PenPoliza)
    vlGlobalNumEndoso = Trim(Lbl_End)
    
    If vlSwAprobar = True Then
    
        'Obtener el último Endoso creado
        vgSql = "SELECT num_endoso "
        vgSql = vgSql & "FROM PP_TMAE_POLIZA "
        vgSql = vgSql & "WHERE "
        vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' "
        vgSql = vgSql & "ORDER BY num_endoso DESC "
        Set vgRegistro = vgConexionBD.Execute(vgSql)
        If Not vgRegistro.EOF Then
           'Ultimo Endoso
           vlRptNumEndosoEnd = (vgRegistro!num_endoso)
        Else
            vgRegistro.Close
            MsgBox "No existen endosos para la Póliza indicada.", vbCritical, "Operación Cancelada"
            Exit Sub
        End If
        vgRegistro.Close
        
        'Obtener el Penúltimo Endoso
        vgSql = "SELECT num_endoso "
        vgSql = vgSql & "FROM PP_TMAE_POLIZA "
        vgSql = vgSql & "WHERE "
        vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' "
        vgSql = vgSql & "and num_endoso = " & vlRptNumEndosoEnd & " "
        vgSql = vgSql & "ORDER BY num_endoso DESC "
        Set vgRegistro = vgConexionBD.Execute(vgSql)
        If Not vgRegistro.EOF Then
            'Penultimo Endoso
            vlRptNumEndosoPol = (vgRegistro!num_endoso) - 1
        Else
            vgRegistro.Close
            MsgBox "No existe endoso anterior al " & CStr(vlRptNumEndosoEnd) & " para la Póliza indicada.", vbCritical, "Operación Cancelada"
            Exit Sub
        End If
        vgRegistro.Close
    
        'Call flImprimirPolizaDef
        Call flImprimirEndosoDef
        
    Else
        MsgBox "Debe Realizar el Procedimiento de Aprobación.", vbInformation, "Información"
    End If

Exit Sub
Err_Imprimir:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_ImprimirPRE_Click()
On Error GoTo Err_ImprimirPre

    vlRptNumEndosoPol = 0
    vlRptNumEndosoEnd = 0
    
    'Verificar el Número de Póliza
    If (Trim(Txt_PenPoliza) = "") Then
        MsgBox "Debe indicar el Número de Póliza sobre la cual se quiere realizar la Operación.", vbCritical, "Error de Datos"
        Exit Sub
    End If
    'Verificar el Número de Endoso
    If Not IsNumeric(Trim(Lbl_End)) Then
        MsgBox "Debe indicar el Número de Endoso sobre el cual se quiere realizar la Operación.", vbCritical, "Error de Datos"
        Exit Sub
    End If
    
    vlGlobalNumPoliza = Trim(Txt_PenPoliza)
    vlGlobalNumEndoso = Trim(Lbl_End)
    vlGlobalNumEndosoCrear = CLng(vlGlobalNumEndoso) + 1
    
    vlNombre = ""
    vlNombreSeg = ""
    vlPaterno = ""
    vlMaterno = ""
    vlNombreTipoIden = ""
    vlImpCodMoneda = ""
    vlImpNomMoneda = ""
    
    If vlSwGrabar = True Then
    
        vgSql = ""
        vgSql = "SELECT num_endoso "
        vgSql = vgSql & "FROM PP_TMAE_ENDPOLIZA "
        vgSql = vgSql & "WHERE "
        vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' "
        vgSql = vgSql & "ORDER BY num_endoso DESC "
        Set vgRegistro = vgConexionBD.Execute(vgSql)
        If Not vgRegistro.EOF Then
           'Ultimo Endoso
           vlRptNumEndosoPol = (vgRegistro!num_endoso)
           vlRptNumEndosoEnd = (vgRegistro!num_endoso)
        End If
        vgRegistro.Close
        
        Call flImprimirPoliza
        Call flImprimirEndosoPrev
            
    Else
        MsgBox "Debe Realizar el Procedimiento de Grabación, antes de imprimir la Póliza Preliminar.", vbInformation, "Información"
    End If

Exit Sub
Err_ImprimirPre:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Cmd_Limpiar_Click()
On Error GoTo Err_Cmd_Limpiar_Click

  
    If SSTab_EndosoPoliza.Tab = 1 Then
       If SSTab_PolizaModificada.Tab = 0 Then
          
            'I--- ABV 20/04/2005 ---
            'Call flLimpiarPolizaMod
            'Txt_PMTerVig = Format(CDate(Trim(clFechaTopeTer)), "yyyymmdd")
            
            'Limpiar campos de la Póliza
            Call flHabilitarPolMod
            Call flHabilitarBenMod
            
            'Cmb_PMTipPen.ListIndex = 0
            'Lbl_PMNumCar = ""
            'Cmb_PMEstVig.ListIndex = 0
            'Txt_PMIniVig = ""
            'Txt_PMTerVig = ""
            Cmb_PMTipRta.ListIndex = 0
            Cmb_PMMod.ListIndex = 0
            'Txt_PMMesDif = ""
            'Txt_PMMesGar = ""
            Txt_PMMtoPrima = ""
            Txt_PMTasaCto = ""
            Txt_PMTasaVta = ""
            Txt_PMTasaPerGar = ""
          
            Lbl_PMNumCar = (Msf_BMGrilla.rows - 1)
            If Cmb_PMTipRta.Enabled = True Then
                Cmb_PMTipRta.SetFocus
            End If
            'F--- ABV 20/04/2005 ---
       Else
           If SSTab_PolizaModificada.Tab = 1 Then
              Call flLimpiarBeneficiariosMod
'I--- ABV 17/11/2005 ---
              If (Fra_BM.Enabled = True) Then
                'Cmb_BMNumIdent.SetFocus
              End If
'F--- ABV 17/11/2005 ---
           End If
       End If
    End If
    
  
    Call flLimpiarVariables
    
    'I--- ABV 20/04/2005 ---
    If SSTab_PolizaModificada.Tab = 0 Then
        Call flLimpiarFraEndoso
    End If
    'F--- ABV 20/04/2005 ---
    
    Fra_PM.Enabled = True
    Fra_BM.Enabled = True
    Fra_Endoso.Enabled = True

    txtNomben = ""
    txtNomsegBen = ""
    txtApepatBen = ""
    txtApematBen = ""
    txtTelBen.Enabled = True
    txtTelfon2 = ""
    txtBenEmail = ""
    txt_dirben.Enabled = True
    txtDistritoBen.Enabled = True
    txt_BMMtoPension = Format(0, "#0.00")
    Txt_BMMtoPensionGar = Format(0, "#0.00")
    txt_BMPrc = Format(0, "#0.00")
    txt_BMPrcGar = Format(0, "#0.00")

    txtNomben.Enabled = True
    txtNomsegBen.Enabled = True
    txtApepatBen.Enabled = True
    txtApematBen.Enabled = True
    frmDatosGen.Enabled = True
    txtTelBen.Enabled = True
    txtTelfon2.Enabled = True
    txtBenEmail.Enabled = True
    txt_dirben.Enabled = True
    txtDistritoBen.Enabled = True
    Cmd_BuscarDir.Enabled = True
    
Exit Sub
Err_Cmd_Limpiar_Click:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Sub

Private Sub Cmd_Modificar_Click()
'si en el caso en que yo calculara, y luego me diera cuenta que me falto
'un beneficiario o cambiar algún dato para el nuevo endoso, debe existir
'este botón que permita modificar lo que ingrese por otra cosa, sin que
'necesariamente tenga que volver a cargar la información original , ya
'que puedo perder tiempo en eso.
'Se supone que si hago clic en esta opción, los valores que se muestran
'en los casilleros del Endoso deben quedar en blanco, como si estuviera
'o lo hubiera levantado recién para hacer las modificaciones

'Que te vaya LINDO !!!!!!    :-P
On Error GoTo Err_Modificar

    Fra_PM.Enabled = True
    Fra_BM.Enabled = True
    Fra_Endoso.Enabled = True

    Call flHabilitarBenMod
    'Call flLimpiarFraEndoso
    Lbl_EndMtoPensionOrig = ""
    Lbl_EndMtoPensionCalc = ""
    Lbl_EndCrear = ""
    
    vlSwCalIntOK = True
    vlSwCalExtOK = False
    vlSwGrabar = False
    vlSwAprobar = False
    
    Msf_BMGrilla.row = 1
    Call flCargaDatosBeneficiariosMod(Msf_BMGrilla.row)

Exit Sub
Err_Modificar:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub cmd_salir_Click()
On Error GoTo Err_Salir

    vlTipoBuscar = "N"
    vlTablaPoliza = clTablaPolizaOri
    vlTablaBen = clTablaBenOri


    Screen.MousePointer = 11
    Unload Me
    Screen.MousePointer = 0
            
Exit Sub
Err_Salir:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub


Private Sub cmdExcluyeBen_Click()

End Sub

Private Sub cmdCausaFac_Click()

      Frm_CauSiniestro.pnum_poliza = vlNumPoliza
        Frm_CauSiniestro.pCOD_CAUENDOSO = vlCodCauEndoso
        Frm_CauSiniestro.pnum_endoso = vlNumEndoso
        Frm_CauSiniestro.pCOD_CAUSINIESTRO = VlcodCausaFac
        Frm_CauSiniestro.Show
End Sub
Public Sub RecibeCausaFac(ByVal codCausaFac As String)
    VlcodCausaFac = codCausaFac
  
End Sub

'Implementacion GobiernoDeDatos(se invoca al nuevo formulario)
Private Sub cmdDirec_Click()
If Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
Dim vlCodCauEndos As String
vlCodCauEndos = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))

Screen.MousePointer = 11
Msf_BMGrilla.Col = 0
   If (Msf_BMGrilla.Text = "") Or (Msf_BMGrilla.row = 0) Then
       MsgBox "No existen Detalles", vbExclamation, "Información"
       Exit Sub
   Else
          ' Call flCargaDatosBeneficiariosModDatGen(Msf_BMGrilla.row)_
           Call flCargarDatosBeneficiariosModDirec(Msf_BMGrilla.row)
           'vgCodDireccion_
           Call Frm_EditCamposPoliza.flIniciarValores(Mid(Cmb_EndTipoEnd, 1, 1), vlCodCauEndos, Msf_BMGrilla.row, Trim(IIf(txtcodDirBen = "", 0, txtcodDirBen)), pTipoTelefono, pNumTelefono, pCodigoTelefono, pTipoTelefono2, pNumTelefono2, pCodigoTelefono2, pTipoVia, pDireccion, pNumero, pTipoPref, pInterior, pManzana, pLote, pEtapa, pTipoConj, pConjHabit, pTipoBlock, pNumBlock, pReferencia, txt_dirben.Text)
           
   Frm_EndosoPol.Enabled = False
   Frm_EditCamposPoliza.Show
   Screen.MousePointer = 0
    End If
End If
End Sub
'Fin Implementacion GobiernoDeDatos()





Private Sub Form_Load()
On Error GoTo Err_Cargar


    
    Frm_EndosoPol.Top = 0
    Frm_EndosoPol.Left = 0
    'frmDatosGen.Visible = False
    vlMtoPensionActOriginal = 0
    vlMtoPensionActModificada = 0
    
    Call flLimpiarVariables
    Lbl_MonPension(clMonedaEndOri_Poliza) = ""
    Lbl_MonPension(clMonedaEndOri_BenPension) = ""
    Lbl_MonPension(clMonedaEndMod_Poliza) = ""
    Lbl_MonPension(clMonedaEndMod_PolizaCal) = ""
    Lbl_MonPension(clMonedaEndMod_BenPension) = ""
    Lbl_MonPension(clMonedaEndMod_BenPensionGar) = ""
    
    vlTipoBuscar = "N"
    vlTablaPoliza = clTablaPolizaOri
    vlTablaBen = clTablaBenOri
    
    'Call flLimpiar
    'Call flDeshabilitarConsulta
    'Call flCargarListaConHabDes
   
   'Carga Combo de Tipo de Identificación Causante
    fgComboTipoIdentificacion Cmb_PenNumIdent
    fgComboTipoIdentificacion Cmb_BMNumIdent
    
    fgComboGeneral vgCodTabla_TipPen, Cmb_PMTipPen
    'fgComboGeneral vgCodTabla_EstPol, Cmb_PMEstVig
    fgComboGeneral vgCodTabla_TipVigPol, Cmb_PMEstVig
    fgComboGeneral vgCodTabla_TipRen, Cmb_PMTipRta
    fgComboGeneral vgCodTabla_AltPen, Cmb_PMMod
'    fgComboGeneral vgCodTabla_ViaPago, Cmb_ViaPago
    fgComboSucursal Cmb_Sucursal, "A"
    Call fgComboGeneral(vgCodTabla_ModTipCta, Cmb_ModTipCta)
    Call fgComboTipoIdentificacion(Cmb_TipDoc)
    
    fgComboGeneral vgCodTabla_Par, Cmb_BMPar
    fgComboGeneral vgCodTabla_GruFam, Cmb_BMGrupFam
    fgComboGeneral vgCodTabla_Sexo, Cmb_BMSexo
    fgComboGeneral vgCodTabla_SitInv, Cmb_BMSitInv
    
    fgComboGeneral vgCodTabla_TipEnd, Cmb_EndTipoEnd
    fgComboCausaEndosos vgCodTabla_CauEnd, Cmb_EndCauEnd, Mid(Cmb_EndTipoEnd, 1, 1)
    
   
    
'    Call flComboCauInv
    
    fgComboGeneral vgCodTabla_DerPen, Cmb_BMDerPen
    fgComboGeneral vgCodTabla_TipPen, cmbTipoPreBen
    fgComboGeneral vgCodTabla_AFP, cmbAfpBen
    
'    Call flCargaEstructuraPoliza("Tabla", "0001", 2, stPolizaOri)
    
    'RRR
    
    fgComboGeneral vgCodTabla_Sexo, cmbSexoBen
    
     'RRR 26122013
    Call fgComboGeneral(vgCodTabla_TipCta, cmbTipoCtaBen)
    Call fgComboGeneral(vgCodTabla_Bco, cmbBancoCtaBen)
    Call fgComboGeneral("MP", cmbMonctaBen)
    
    
    Call Habilita
    
    
    Fra_Poliza.Enabled = True
    SSTab_EndosoPoliza.Enabled = False
    SSTab_EndosoPoliza.Tab = 0
    SSTab_PolizaModificada.Enabled = False
    SSTab_PolizaOriginal.Enabled = False
    SSTab_PolizaOriginal.Tab = 0
'    SSTab_PolizaOriginal.SetFocus
    
    vlSwCalIntOK = True
    
        Cmb_EndTipoEnd.ListIndex = 2
    
    
    cmbExcluesion.ListIndex = 1
 'Implementacion GobiernoDeDatos(se bloquean los campos que se editaran en el nuevo formulario)
    txtTelBen.Locked = True
    txtTelfon2.Locked = True
    txt_dirben.Locked = True
    Call LimpiarVariables
  'Fin Implementacion GobiernoDeDatos()
  
  
  
    Txt_EndFecEnd = fgBuscaFecServ
    Txt_EndFecEfecto = flCalculaFechaEfecto(Txt_EndFecEfecto)
    
    VSw_Pruebas = True

Exit Sub
Err_Cargar:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Sub
'Implementacion GobiernoDeDatos(limpia las variables creadas)
Private Sub LimpiarVariables()
vgCodDireccion = ""
codComuna = ""
codRegion = ""
codProvincia = ""
pgCodDireccion = ""
pTipoTelefono = ""
pNumTelefono = ""
pCodigoTelefono = ""
pTipoVia = ""
pDireccion = ""
pNumero = ""
pTipoPref = ""
pInterior = ""
pManzana = ""
pLote = ""
pEtapa = ""
pTipoConj = ""
pConjHabit = ""
pTipoBlock = ""
pNumBlock = ""
pReferencia = ""
End Sub
Private Sub flCargarDatosBeneficiariosModDirec(row As String)
0
For vgI = 1 To Msf_BOGrilla.rows - 1
If CStr(vgI) = row Then
pConcatDirec = IIf(IsNull(stPolizaBenDirecMod(vgI).pConcatDirec), "", stPolizaBenDirecMod(vgI).pConcatDirec)
 vgCodDireccion = IIf(IsNull(stPolizaBenDirecMod(vgI).Cod_Direccion), "", stPolizaBenDirecMod(vgI).Cod_Direccion)
 pTipoTelefono = IIf(IsNull(stPolizaBenDirecMod(vgI).cod_tip_fonoben), "", stPolizaBenDirecMod(vgI).cod_tip_fonoben)
 
 'If txtTelBen.Text <> "" Then
 'pNumTelefono = txtTelBen.Text
 'Else
 'pNumTelefono = IIf(IsNull(stPolizaBenDirecMod(vgI).gls_fonoben), "", stPolizaBenDirecMod(vgI).gls_fonoben)
 'End If
 pNumTelefono = IIf(IsNull(stPolizaBenDirecMod(vgI).Gls_FonoBen), "", stPolizaBenDirecMod(vgI).Gls_FonoBen)
 
 pCodigoTelefono = IIf(IsNull(stPolizaBenDirecMod(vgI).cod_area_fonoben), "", stPolizaBenDirecMod(vgI).cod_area_fonoben)
 pTipoTelefono2 = IIf(IsNull(stPolizaBenDirecMod(vgI).cod_tipo_telben2), "", stPolizaBenDirecMod(vgI).cod_tipo_telben2)
 
 'If txtTelfon2.Text <> "" Then
 'pNumTelefono2 = txtTelfon2.Text
 'Else
 'pNumTelefono2 = IIf(IsNull(stPolizaBenDirecMod(vgI).gls_telben2), "", stPolizaBenDirecMod(vgI).gls_telben2)
 'End If
 pNumTelefono2 = IIf(IsNull(stPolizaBenDirecMod(vgI).Gls_Telben2), "", stPolizaBenDirecMod(vgI).Gls_Telben2)
 
 pCodigoTelefono2 = IIf(IsNull(stPolizaBenDirecMod(vgI).cod_area_telben2), "", stPolizaBenDirecMod(vgI).cod_area_telben2)
 pTipoVia = IIf(IsNull(stPolizaBenDirecMod(vgI).pTipoVia), "", stPolizaBenDirecMod(vgI).pTipoVia)
 pDireccion = IIf(IsNull(stPolizaBenDirecMod(vgI).pDireccion), "", stPolizaBenDirecMod(vgI).pDireccion)
 pNumero = IIf(IsNull(stPolizaBenDirecMod(vgI).pNumero), "", stPolizaBenDirecMod(vgI).pNumero)
 pTipoPref = IIf(IsNull(stPolizaBenDirecMod(vgI).pTipoPref), "", stPolizaBenDirecMod(vgI).pTipoPref)
 pInterior = IIf(IsNull(stPolizaBenDirecMod(vgI).pInterior), "", stPolizaBenDirecMod(vgI).pInterior)
 pManzana = IIf(IsNull(stPolizaBenDirecMod(vgI).pManzana), "", stPolizaBenDirecMod(vgI).pManzana)
 pLote = IIf(IsNull(stPolizaBenDirecMod(vgI).pLote), "", stPolizaBenDirecMod(vgI).pLote)
 pEtapa = IIf(IsNull(stPolizaBenDirecMod(vgI).pEtapa), "", stPolizaBenDirecMod(vgI).pEtapa)
 pTipoConj = IIf(IsNull(stPolizaBenDirecMod(vgI).pTipoConj), "", stPolizaBenDirecMod(vgI).pTipoConj)
 pConjHabit = IIf(IsNull(stPolizaBenDirecMod(vgI).pConjHabit), "", stPolizaBenDirecMod(vgI).pConjHabit)
 pTipoBlock = IIf(IsNull(stPolizaBenDirecMod(vgI).pTipoBlock), "", stPolizaBenDirecMod(vgI).pTipoBlock)
 pNumBlock = IIf(IsNull(stPolizaBenDirecMod(vgI).pNumBlock), "", stPolizaBenDirecMod(vgI).pNumBlock)
 pReferencia = IIf(IsNull(stPolizaBenDirecMod(vgI).pReferencia), "", stPolizaBenDirecMod(vgI).pReferencia)
End If
Next
End Sub

Function flRecibeParametrosEditDirc(vNumOrden As String, pgCodDireccion As String, pTipoTelefono As String, pNumTelefono As String, pCodigoTelefono As String, pTipoTelefono2 As String, pNumTelefono2 As String, pCodigoTelefono2 As String, pTipoVia As String, pDireccion As String, pNumero As String, pTipoPref As String, pInterior As String, pManzana As String, pLote As String, pEtapa As String, pTipoConj As String, pConjHabit As String, pTipoBlock As String, pNumBlock As String, pReferencia As String, pConcatDirec As String)
For vgI = 1 To Msf_BOGrilla.rows - 1
If vgI = vNumOrden Then
stPolizaBenDirecMod(vgI).Cod_Direccion = pgCodDireccion
stPolizaBenDirecMod(vgI).cod_tip_fonoben = pTipoTelefono
stPolizaBenDirecMod(vgI).cod_area_fonoben = pCodigoTelefono
stPolizaBenDirecMod(vgI).Gls_FonoBen = pNumTelefono
stPolizaBenDirecMod(vgI).cod_tipo_telben2 = pTipoTelefono2
stPolizaBenDirecMod(vgI).Gls_Telben2 = pNumTelefono2
stPolizaBenDirecMod(vgI).cod_area_telben2 = pCodigoTelefono2
stPolizaBenDirecMod(vgI).pTipoVia = pTipoVia
stPolizaBenDirecMod(vgI).pDireccion = pDireccion
stPolizaBenDirecMod(vgI).pNumero = pNumero
stPolizaBenDirecMod(vgI).pTipoPref = pTipoPref
stPolizaBenDirecMod(vgI).pInterior = pInterior
stPolizaBenDirecMod(vgI).pManzana = pManzana
stPolizaBenDirecMod(vgI).pLote = pLote
stPolizaBenDirecMod(vgI).pEtapa = pEtapa
stPolizaBenDirecMod(vgI).pTipoConj = pTipoConj
stPolizaBenDirecMod(vgI).pConjHabit = pConjHabit
stPolizaBenDirecMod(vgI).pTipoBlock = pTipoBlock
stPolizaBenDirecMod(vgI).pNumBlock = pNumBlock
stPolizaBenDirecMod(vgI).pReferencia = pReferencia
stPolizaBenDirecMod(vgI).pConcatDirec = pConcatDirec
vlCodDir = pgCodDireccion
txtTelfon2.Text = pNumTelefono2
txtTelBen.Text = pNumTelefono
txt_dirben.Text = pConcatDirec
End If
Next
End Function
'Fin Implementacion GobiernoDeDatos()_








Private Sub Msf_BMGrilla_Click()
On Error GoTo Err_Msf_BMGrilla_Click
    
    Msf_BMGrilla.Col = 0
    If (Msf_BMGrilla.Text = "") Or (Msf_BMGrilla.row = 0) Then
        MsgBox "No existen Detalles", vbExclamation, "Información"
        Exit Sub
    Else
        'If Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
            Call flCargaDatosBeneficiariosModDatGen(Msf_BMGrilla.row)
        'Else
        '    Call flCargaDatosBeneficiariosMod(Msf_BMGrilla.Row)
        'End If

     'Implementacion GobiernoDeDatos()_
     Call flCargarDatosBeneficiariosModDirec(Msf_BMGrilla.row)
     'Fin Implementacion GobiernoDeDatos()_
        
        
'        Cmb_BMNumIdent.SetFocus
                
    End If

Exit Sub
Err_Msf_BMGrilla_Click:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Sub

Private Sub Msf_BOGrilla_Click()
On Error GoTo Err_Msf_BOGrilla_Click
    
    Msf_BOGrilla.Col = 0
    If (Msf_BOGrilla.Text = "") Or (Msf_BOGrilla.row = 0) Then
        MsgBox "No existen Detalles", vbExclamation, "Información"
        Exit Sub
    Else
        
        Call flCargaDatosBeneficiariosOri(Msf_BOGrilla.row)
                
    End If

Exit Sub
Err_Msf_BOGrilla_Click:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub







Private Sub Txt_BMNumIden_KeyPress(KeyAscii As Integer)
On Error GoTo Err_TxtPenDigitoKeyPress
 
    If KeyAscii = 13 Then
        Txt_BMNumIden = Trim(UCase(Txt_BMNumIden))
        If Txt_BMNumIden.Text = "" Then
           MsgBox "Debe Ingresar el Número de Identificación del Beneficiario.", vbCritical, "Error de Datos"
           Txt_BMNumIden.SetFocus
           Exit Sub
        End If
    
        Txt_BMNomBen.SetFocus
    End If
    
Exit Sub
Err_TxtPenDigitoKeyPress:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Txt_BMNumIden_LostFocus()
    Txt_BMNumIden = UCase(Trim(Txt_BMNumIden))
    If Txt_BMNumIden.Text = "" Then
       Exit Sub
    End If
End Sub

Private Sub Txt_BMFecFall_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If (Trim(Txt_BMFecFall) <> "") Then
            If Not IsDate(Txt_BMFecFall.Text) Then
               MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
               Txt_BMFecFall.SetFocus
               Exit Sub
            End If
            If (CDate(Txt_BMFecFall) > CDate(Date)) Then
               MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
               Txt_BMFecFall.SetFocus
               Exit Sub
            End If
            If (Year(Txt_BMFecFall) < 1900) Then
               MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
               Txt_BMFecFall.SetFocus
               Exit Sub
            End If
            Txt_BMFecFall.Text = Format(CDate(Trim(Txt_BMFecFall)), "yyyymmdd")
            Txt_BMFecFall.Text = DateSerial(Mid((Txt_BMFecFall.Text), 1, 4), Mid((Txt_BMFecFall.Text), 5, 2), Mid((Txt_BMFecFall.Text), 7, 2))

        End If
        'I--- ABV 20/04/2005 ---
        If (Txt_BMMtoPensionGar.Enabled = True) Then
            Txt_BMMtoPensionGar.SetFocus
        Else
            Cmd_BMSumar.SetFocus
        End If
        'F--- ABV 20/04/2005 ---
    
     End If
End Sub

Private Sub Txt_BMFecFall_LostFocus()

    If (Trim(Txt_BMFecFall) <> "") Then
        Txt_BMFecFall.Text = Format(CDate(Trim(Txt_BMFecFall)), "yyyymmdd")
        Txt_BMFecFall.Text = DateSerial(Mid((Txt_BMFecFall.Text), 1, 4), Mid((Txt_BMFecFall.Text), 5, 2), Mid((Txt_BMFecFall.Text), 7, 2))
    End If
    
End Sub

Private Sub Txt_BMFecInv_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If (Trim(Txt_BMFecInv) <> "") Then
            If Not IsDate(Txt_BMFecInv.Text) Then
               MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
               Txt_BMFecInv.SetFocus
               Exit Sub
            End If
            If (CDate(Txt_BMFecInv) > CDate(Date)) Then
               MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
               Txt_BMFecInv.SetFocus
               Exit Sub
            End If
            If (Year(Txt_BMFecInv) < 1900) Then
               MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
               Txt_BMFecInv.SetFocus
               Exit Sub
            End If
            Txt_BMFecInv.Text = Format(CDate(Trim(Txt_BMFecInv)), "yyyymmdd")
            Txt_BMFecInv.Text = DateSerial(Mid((Txt_BMFecInv.Text), 1, 4), Mid((Txt_BMFecInv.Text), 5, 2), Mid((Txt_BMFecInv.Text), 7, 2))
        End If
        'Cmb_BMCauInv.SetFocus
        Cmd_CauInv.SetFocus
     End If
End Sub

Private Sub Txt_BMFecInv_LostFocus()

    If (Trim(Txt_BMFecInv) <> "") Then
        Txt_BMFecInv.Text = Format(CDate(Trim(Txt_BMFecInv)), "yyyymmdd")
        Txt_BMFecInv.Text = DateSerial(Mid((Txt_BMFecInv.Text), 1, 4), Mid((Txt_BMFecInv.Text), 5, 2), Mid((Txt_BMFecInv.Text), 7, 2))
    End If
    
End Sub

Private Sub Txt_BMFecMat_KeyPress(KeyAscii As Integer)
If KeyAscii = 13 Then
'        If (Trim(Txt_BMFecMat) = "") Then
'           MsgBox "Debe ingresar una Fecha de Nacimiento de Beneficiario", vbCritical, "Error de Datos"
'           Txt_BMFecMat.SetFocus
'           Exit Sub
'        End If
        
    If (Trim(Txt_BMFecMat) <> "") Then
        
        If Not IsDate(Txt_BMFecMat.Text) Then
           MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
           Txt_BMFecMat.SetFocus
           Exit Sub
        End If
        If (CDate(Txt_BMFecMat) > CDate(Date)) Then
           MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
           Txt_BMFecMat.SetFocus
           Exit Sub
        End If
        If (Year(Txt_BMFecMat) < 1900) Then
           MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
           Txt_BMFecMat.SetFocus
           Exit Sub
        End If
        
        Txt_BMFecMat.Text = Format(CDate(Trim(Txt_BMFecMat)), "yyyymmdd")
        Txt_BMFecMat.Text = DateSerial(Mid((Txt_BMFecMat.Text), 1, 4), Mid((Txt_BMFecMat.Text), 5, 2), Mid((Txt_BMFecMat.Text), 7, 2))
        
    End If
    'I--- ABV 20/04/2005 ---
    If (Txt_BMMtoPensionGar.Enabled = True) Then
        Txt_BMMtoPensionGar.SetFocus
    Else
        Cmd_BMSumar.SetFocus
    End If
    'F--- ABV 20/04/2005 ---
End If
End Sub

Private Sub Txt_BMFecMat_LostFocus()

    If (Trim(Txt_BMFecMat) <> "") Then
        Txt_BMFecMat.Text = Format(CDate(Trim(Txt_BMFecMat)), "yyyymmdd")
        Txt_BMFecMat.Text = DateSerial(Mid((Txt_BMFecMat.Text), 1, 4), Mid((Txt_BMFecMat.Text), 5, 2), Mid((Txt_BMFecMat.Text), 7, 2))
    End If
    
End Sub

Private Sub Txt_BMFecNac_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If (Trim(Txt_BMFecNac) = "") Then
           MsgBox "Debe ingresar una Fecha de Nacimiento de Beneficiario", vbCritical, "Error de Datos"
           Txt_BMFecNac.SetFocus
           Exit Sub
        End If
        If Not IsDate(Txt_BMFecNac.Text) Then
           MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
           Txt_BMFecNac.SetFocus
           Exit Sub
        End If
        If (CDate(Txt_BMFecNac) > CDate(Date)) Then
           MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
           Txt_BMFecNac.SetFocus
           Exit Sub
        End If
        If (Year(Txt_BMFecNac) < 1900) Then
           MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
           Txt_BMFecNac.SetFocus
           Exit Sub
        End If
        
        Txt_BMFecNac.Text = Format(CDate(Trim(Txt_BMFecNac)), "yyyymmdd")
        Txt_BMFecNac.Text = DateSerial(Mid((Txt_BMFecNac.Text), 1, 4), Mid((Txt_BMFecNac.Text), 5, 2), Mid((Txt_BMFecNac.Text), 7, 2))
        
        Txt_BMFecFall.SetFocus
        
     End If
End Sub

Private Sub Txt_BMFecNac_LostFocus()

    If (Trim(Txt_BMFecNac) <> "") Then
        Txt_BMFecNac.Text = Format(CDate(Trim(Txt_BMFecNac)), "yyyymmdd")
        Txt_BMFecNac.Text = DateSerial(Mid((Txt_BMFecNac.Text), 1, 4), Mid((Txt_BMFecNac.Text), 5, 2), Mid((Txt_BMFecNac.Text), 7, 2))
    End If
    
End Sub

Private Sub Txt_BMMatBen_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Txt_BMMatBen.Text = Trim(UCase(Txt_BMMatBen.Text))
       Cmb_BMSitInv.SetFocus
    End If
End Sub

Private Sub Txt_BMMatBen_LostFocus()
    Txt_BMMatBen.Text = Trim(UCase(Txt_BMMatBen.Text))
    If Txt_BMMatBen.Text = "" Then
       Exit Sub
    End If
End Sub

Private Sub Txt_BMMtoPensionGar_Change()
If Not IsNumeric(Txt_BMMtoPensionGar) Then
    Txt_BMMtoPensionGar = ""
End If
End Sub

Private Sub Txt_BMMtoPensionGar_KeyPress(KeyAscii As Integer)
If (KeyAscii = 13) Then
    If (Txt_BMMtoPensionGar = "") Then
        MsgBox "Debe ingresar el Monto de la Pensión Garantizada del Beneficiario.", vbCritical, "Error de Datos"
        Exit Sub
    End If
    Txt_BMMtoPensionGar = Format(Txt_BMMtoPensionGar, "#,#0.00")
    Cmd_BMSumar.SetFocus
End If
End Sub

Private Sub Txt_BMNomBen_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Txt_BMNomBen.Text = Trim(UCase(Txt_BMNomBen.Text))
       If Txt_BMNomBen.Text = "" Then
          MsgBox "Debe Ingresar Nombre.", vbCritical, "Error de Datos"
          Txt_BMNomBen.SetFocus
          Exit Sub
       End If
       Txt_BMNomSegBen.SetFocus
    End If
End Sub

Private Sub Txt_BMNomBen_LostFocus()
    Txt_BMNomBen.Text = Trim(UCase(Txt_BMNomBen.Text))
    If Txt_BMNomBen.Text = "" Then
       Exit Sub
    End If
End Sub

Private Sub Txt_BMNomSegBen_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Txt_BMNomSegBen.Text = Trim(UCase(Txt_BMNomSegBen.Text))
       Txt_BMPatBen.SetFocus
    End If
End Sub

Private Sub Txt_BMNomSegBen_LostFocus()
Txt_BMNomSegBen.Text = Trim(UCase(Txt_BMNomSegBen.Text))
End Sub

Private Sub Txt_BMPatBen_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       Txt_BMPatBen.Text = Trim(UCase(Txt_BMPatBen.Text))
       If Txt_BMPatBen.Text = "" Then
          MsgBox "Debe Ingresar Apellido Paterno.", vbCritical, "Error de Datos"
          Txt_BMPatBen.SetFocus
          Exit Sub
       End If
       Txt_BMMatBen.SetFocus
    End If
End Sub

Private Sub Txt_BMPatBen_LostFocus()
    Txt_BMPatBen.Text = Trim(UCase(Txt_BMPatBen.Text))
    If Txt_BMPatBen.Text = "" Then
       Exit Sub
    End If
End Sub
Private Sub txt_CCI_KeyPress(KeyAscii As Integer)
Dim KeyChar As String
If KeyAscii > 31 Then
    KeyChar = Chr(KeyAscii)
    If Not IsNumeric(KeyChar) Then
        KeyAscii = 0
    End If
End If
End Sub

Private Sub Txt_EndFecEfecto_KeyPress(KeyAscii As Integer)
Dim iFechaCierre As String
Dim iFechaEfecto As String

If (KeyAscii = 13) Then

    Txt_EndFecEfecto = Trim(Txt_EndFecEfecto)
    
    If (Txt_EndFecEfecto) <> "" Then
        If Not IsDate(Txt_EndFecEfecto) Then
            MsgBox "Debe ingresar una Fecha válida para la Fecha de Endoso.", vbCritical, "Error de Datos"
            Exit Sub
        End If
    End If
    
    Txt_EndFecEfecto = flCalculaFechaEfecto(Txt_EndFecEfecto)
    
    Txt_EndFecEnd.SetFocus
    
    'If (Trim(Txt_EndFecEfecto) <> "") Then
    '    If Not IsDate(Txt_EndFecEfecto) Then
    '        Exit Sub
    '    End If
    '    iFechaCierre = Format(fgValidaFechaEfecto(Trim(Txt_EndFecEnd), vlNumPoliza, vlNumOrden), "yyyymmdd")
    '    iFechaEfecto = Format(CDate(Txt_EndFecEfecto), "yyyymmdd")
    '    If (iFechaCierre > iFechaEfecto) Then
    '        MsgBox "La Fecha de Efecto es anterior a la Fecha del último cierre, el cual corresponde a :" & _
    '        DateSerial(CInt(Mid(iFechaCierre, 1, 4)), CInt(Mid(iFechaCierre, 5, 2)), CInt(Mid(iFechaCierre, 7, 2))), vbInformation, "Fecha Errónea"
    '        Exit Sub
    '    End If
    'Else
    '    Txt_EndFecEnd = fgBuscaFecServ
    '    Txt_EndFecEfecto = fgValidaFechaEfecto(Trim(Txt_EndFecEnd), vlNumPoliza, vlNumOrden)
    'End If
    
End If
End Sub

Private Sub Txt_EndFecEnd_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If (Trim(Txt_EndFecEnd) = "") Then
           MsgBox "Debe ingresar una Fecha de Solicitud del Endoso", vbCritical, "Error de Datos"
           Txt_EndFecEnd.SetFocus
           Exit Sub
        End If
        If Not IsDate(Txt_EndFecEnd.Text) Then
           MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
           Txt_EndFecEnd.SetFocus
           Exit Sub
        End If
        If (CDate(Txt_EndFecEnd) > CDate(Date)) Then
           MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
           Txt_EndFecEnd.SetFocus
           Exit Sub
        End If
        If (Year(Txt_EndFecEnd) < 1900) Then
           MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
           Txt_EndFecEnd.SetFocus
           Exit Sub
        End If
        
        Txt_EndFecEnd.Text = Format(CDate(Trim(Txt_EndFecEnd)), "yyyymmdd")
        Txt_EndFecEnd.Text = DateSerial(Mid((Txt_EndFecEnd.Text), 1, 4), Mid((Txt_EndFecEnd.Text), 5, 2), Mid((Txt_EndFecEnd.Text), 7, 2))
        
        'CMV-20051021 I
        'Txt_EndFecEfecto = fgValidaFechaEfecto(Trim(Txt_EndFecEnd), vlNumPoliza, vlNumOrden)
        'CMV-20051021 F
        
        'Cmb_EndCauEnd.SetFocus
        Cmb_EndTipoEnd.SetFocus
        
     End If

End Sub

Private Sub Txt_EndFecEnd_LostFocus()

    If (Trim(Txt_EndFecEnd) <> "") Then
        Txt_EndFecEnd.Text = Format(CDate(Trim(Txt_EndFecEnd)), "yyyymmdd")
        Txt_EndFecEnd.Text = DateSerial(Mid((Txt_EndFecEnd.Text), 1, 4), Mid((Txt_EndFecEnd.Text), 5, 2), Mid((Txt_EndFecEnd.Text), 7, 2))
        'CMV-20051021 I
'        Txt_EndFecEfecto = fgValidaFechaEfecto(Trim(Txt_EndFecEnd), vlNumPoliza, vlNumOrden)
        'CMV-20051021 F
    End If
    
End Sub

Private Sub Txt_EndObs_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
       Cmd_Cargar.SetFocus
    End If

End Sub

Private Sub Txt_PenNumIdent_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If (Trim(Txt_PenNumIdent) <> "") Then
            Txt_PenNumIdent = UCase(Trim(Txt_PenNumIdent))
        End If
        Cmd_BuscarPol.SetFocus
    End If
End Sub

Private Sub Txt_PenPoliza_KeyPress(KeyAscii As Integer)
On Error GoTo Err_TxtPenPolizaKeyPress

    If KeyAscii = 13 Then
       Txt_PenPoliza = UCase(Trim(Txt_PenPoliza))
       Txt_PenPoliza = Format(Txt_PenPoliza, "0000000000")
       Cmb_PenNumIdent.SetFocus
    End If
    
Exit Sub
Err_TxtPenPolizaKeyPress:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Txt_PenPoliza_LostFocus()
    Txt_PenPoliza = UCase(Trim(Txt_PenPoliza))
    Txt_PenPoliza = Format(Txt_PenPoliza, "0000000000")
End Sub

Private Sub Txt_PMIniVig_KeyPress(KeyAscii As Integer)
    
    If KeyAscii = 13 Then
        If (Trim(Txt_PMIniVig) = "") Then
           MsgBox "Debe ingresar una Fecha de Inicio de Vigencia", vbCritical, "Error de Datos"
           Txt_PMIniVig.SetFocus
           Exit Sub
        End If
        If Not IsDate(Txt_PMIniVig.Text) Then
           MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
           Txt_PMIniVig.SetFocus
           Exit Sub
        End If
        If (CDate(Txt_PMIniVig) > CDate(Date)) Then
           MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
           Txt_PMIniVig.SetFocus
           Exit Sub
        End If
        If (Year(Txt_PMIniVig) < 1900) Then
           MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
           Txt_PMIniVig.SetFocus
           Exit Sub
        End If
        
        Txt_PMIniVig.Text = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
        Txt_PMIniVig.Text = DateSerial(Mid((Txt_PMIniVig.Text), 1, 4), Mid((Txt_PMIniVig.Text), 5, 2), Mid((Txt_PMIniVig.Text), 7, 2))
               
        If Not fgValidaPagoPension(Txt_PMIniVig, Trim(Txt_PenPoliza), vlNumOrden) Then
           MsgBox " Ya se ha Realizado el Proceso de Cálculo de Pensión para ésta Fecha ", vbCritical, "Operación Cancelada"
           Txt_PMIniVig.SetFocus
           Exit Sub
        End If
        Txt_PMTerVig.SetFocus
     End If

End Sub

Private Sub Txt_PMIniVig_LostFocus()

    If (Trim(Txt_PMIniVig) <> "") Then
        Txt_PMIniVig.Text = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
        Txt_PMIniVig.Text = DateSerial(Mid((Txt_PMIniVig.Text), 1, 4), Mid((Txt_PMIniVig.Text), 5, 2), Mid((Txt_PMIniVig.Text), 7, 2))
    End If
    
End Sub

Private Sub Txt_PMMesDif_Change()
    If Not IsNumeric(Txt_PMMesDif) Then
       Txt_PMMesDif = ""
    End If
End Sub

Private Sub Txt_PMMesDif_KeyPress(KeyAscii As Integer)
On Error GoTo Err_Txt_PMMesDif_KeyPress

    If KeyAscii = 13 Then
       If Txt_PMMesDif.Text = "" Then
          MsgBox "Debe Ingresar Número de Meses.", vbCritical, "Error de Datos"
          Txt_PMMesDif.SetFocus
          Exit Sub
       End If
       If CDbl(Txt_PMMesDif.Text) > clMesesMax Then
          MsgBox "El Número de Meses Ingresado Excede el Máximo Permitido de 1200.", vbCritical, "Error de Datos"
          Txt_PMMesDif.SetFocus
          Exit Sub
       End If
       Txt_PMMesGar.SetFocus
    End If
    
Exit Sub
Err_Txt_PMMesDif_KeyPress:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Txt_PMMesDif_LostFocus()
On Error GoTo Err_Txt_PMMesDif_LostFocus
      
    Txt_PMMesDif.Text = Trim(Txt_PMMesDif.Text)
    If Trim(Txt_PMMesDif = "") Then
       Exit Sub
    End If
    If CDbl(Txt_PMMesDif.Text > clMesesMax) Then
       Exit Sub
    End If
'    If Not IsDate(Txt_PMMesDif.Text) Then
'       Exit Sub
'    End If
'    If CDate(Txt_PMMesDif) > CDate(Date) Then
'       Exit Sub
'    End If
        
Exit Sub
Err_Txt_PMMesDif_LostFocus:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Txt_PMMesGar_Change()
    If Not IsNumeric(Txt_PMMesGar) Then
       Txt_PMMesGar = ""
    End If
End Sub

Private Sub Txt_PMMesGar_KeyPress(KeyAscii As Integer)
On Error GoTo Err_Txt_PMMesGar_KeyPress

    If KeyAscii = 13 Then
       If Txt_PMMesGar.Text = "" Then
          MsgBox "Debe Ingresar Número de Meses.", vbCritical, "Error de Datos"
          Txt_PMMesGar.SetFocus
          Exit Sub
       End If
       If CDbl(Txt_PMMesGar.Text) > clMesesMax Then
          MsgBox "El Número de Meses Ingresado Excede el Máximo Permitido de 1200.", vbCritical, "Error de Datos"
          Txt_PMMesGar.SetFocus
          Exit Sub
       End If
       Txt_PMMtoPrima.SetFocus
    End If
    
Exit Sub
Err_Txt_PMMesGar_KeyPress:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Txt_PMMesGar_LostFocus()
On Error GoTo Err_Txt_PMMesGar_LostFocus
      
    Txt_PMMesGar.Text = Trim(Txt_PMMesGar.Text)
    If Trim(Txt_PMMesGar = "") Then
       Exit Sub
    End If
    If CDbl(Txt_PMMesGar.Text > clMesesMax) Then
       Exit Sub
    End If
'    If Not IsDate(Txt_PMMesGar.Text) Then
'       Exit Sub
'    End If
'    If CDate(Txt_PMMesGar) > CDate(Date) Then
'       Exit Sub
'    End If
        
Exit Sub
Err_Txt_PMMesGar_LostFocus:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Sub

Private Sub Txt_PMMtoPrima_Change()
On Error GoTo Err_Txt_PMMtoPrima_Change

    If Not IsNumeric(Txt_PMMtoPrima) Then
       Txt_PMMtoPrima = ""
    End If
    
Exit Sub
Err_Txt_PMMtoPrima_Change:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Sub

Private Sub Txt_PMMtoPrima_KeyPress(KeyAscii As Integer)
On Error GoTo Err_Txt_PMMtoPrima_KeyPress

    If KeyAscii = 13 Then
        If Txt_PMMtoPrima.Text = "" Then
           MsgBox "Debe Ingresar Monto de la Prima.", vbCritical, "Error de Datos"
           Txt_PMMtoPrima.SetFocus
           Exit Sub
        Else
            Txt_PMMtoPrima.Text = Format(Txt_PMMtoPrima.Text, "###,###,##0.00")
        End If
        If CDbl(Txt_PMMtoPrima.Text) = 0 Then
           MsgBox "Debe Ingresar un Valor Mayor que Cero para Monto Prima.", vbCritical, "Error de Datos"
           Txt_PMMtoPrima.SetFocus
           Exit Sub
        End If
        If CDbl(Txt_PMMtoPrima.Text) > clMtoTope Then
           MsgBox "El Valor Ingresado en Monto Prima Excede el Máximo Permitido de " & Format(clMtoTope, "###,###,##0.00") & "  .", vbExclamation, "Información"
           Txt_PMMtoPrima.Text = Format(clMtoTope, "###,###,##0.00")
           Txt_PMMtoPrima.SetFocus
           Exit Sub
        End If
        Txt_PMTasaCto.SetFocus
    End If
    
Exit Sub
Err_Txt_PMMtoPrima_KeyPress:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
    
End Sub

Private Sub Txt_PMMtoPrima_LostFocus()

    If Txt_PMMtoPrima.Text = "" Then
       Exit Sub
    Else
        Txt_PMMtoPrima.Text = Format(Txt_PMMtoPrima.Text, "###,###,##0.00")
    End If
    If CDbl(Txt_PMMtoPrima.Text) = 0 Then
       Exit Sub
    End If
    If CDbl(Txt_PMMtoPrima.Text) > clMtoTope Then
       Txt_PMMtoPrima.Text = Format(clMtoTope, "###,###,##0.00")
       Exit Sub
    End If
End Sub

Private Sub Txt_PMTasaCto_Change()
    If Not IsNumeric(Txt_PMTasaCto) Then
       Txt_PMTasaCto = ""
    End If
End Sub

Private Sub Txt_PMTasaCto_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       If (Trim(Txt_PMTasaCto.Text)) = "" Then
          MsgBox "Debe Ingresar Porcentaje Tasa Cto. Equiv.", vbCritical, "Error de Datos"
          Txt_PMTasaCto.SetFocus
          Exit Sub
       Else
           Txt_PMTasaCto = Format(Txt_PMTasaCto, "###,##0.000")
       End If
       Txt_PMTasaVta.SetFocus
    End If
End Sub

Private Sub Txt_PMTasaCto_LostFocus()
    Txt_PMTasaCto.Text = Format(Trim(Txt_PMTasaCto.Text), "###,##0.000")
    If (Txt_PMTasaCto.Text) = "" Then
       Exit Sub
    End If
End Sub

Private Sub Txt_PMTasaPerGar_Change()
    If Not IsNumeric(Txt_PMTasaPerGar) Then
       Txt_PMTasaPerGar = ""
    End If
End Sub

Private Sub Txt_PMTasaPerGar_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       If (Trim(Txt_PMTasaPerGar.Text)) = "" Then
          MsgBox "Debe Ingresar Porcentaje Tasa de Venta", vbCritical, "Error de Datos"
          Txt_PMTasaPerGar.SetFocus
          Exit Sub
       Else
           Txt_PMTasaPerGar = Format(Txt_PMTasaPerGar, "###,##0.00")
       End If
       SSTab_PolizaModificada.Tab = 1
       Cmb_BMNumIdent.SetFocus
    End If
End Sub

Private Sub Txt_PMTasaPerGar_LostFocus()
    Txt_PMTasaPerGar.Text = Format(Trim(Txt_PMTasaPerGar.Text), "###,##0.00")
    If (Txt_PMTasaPerGar.Text) = "" Then
       Exit Sub
    End If
End Sub

Private Sub Txt_PMTasaVta_Change()
    If Not IsNumeric(Txt_PMTasaVta) Then
       Txt_PMTasaVta = ""
    End If
End Sub

Private Sub Txt_PMTasaVta_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
       If (Trim(Txt_PMTasaVta.Text)) = "" Then
          MsgBox "Debe Ingresar Porcentaje Tasa de Venta", vbCritical, "Error de Datos"
          Txt_PMTasaVta.SetFocus
          Exit Sub
       Else
           Txt_PMTasaVta = Format(Txt_PMTasaVta, "###,##0.000")
       End If
       'Txt_PMTasaPerGar.SetFocus
    End If
End Sub

Private Sub Txt_PMTasaVta_LostFocus()
    Txt_PMTasaVta.Text = Format(Trim(Txt_PMTasaVta.Text), "###,##0.000")
    If (Txt_PMTasaVta.Text) = "" Then
       Exit Sub
    End If
End Sub

Private Sub Txt_PMTerVig_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        If (Trim(Txt_PMTerVig) = "") Then
           MsgBox "Debe ingresar una Fecha de Término de Vigencia", vbCritical, "Error de Datos"
           Txt_PMTerVig.SetFocus
           Exit Sub
        End If
        If Not IsDate(Txt_PMTerVig.Text) Then
           MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
           Txt_PMTerVig.SetFocus
           Exit Sub
        End If
        If (Year(Txt_PMTerVig) < 1900) Then
           MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
           Txt_PMTerVig.SetFocus
           Exit Sub
        End If
        
        Txt_PMTerVig.Text = Format(CDate(Trim(Txt_PMTerVig)), "yyyymmdd")
        Txt_PMTerVig.Text = DateSerial(Mid((Txt_PMTerVig.Text), 1, 4), Mid((Txt_PMTerVig.Text), 5, 2), Mid((Txt_PMTerVig.Text), 7, 2))
               
        If Not fgValidaPagoPension(Txt_PMTerVig, Trim(Txt_PenPoliza), vlNumOrden) Then
           MsgBox " Ya se ha Realizado el Proceso de Cálculo de Pensión para ésta Fecha ", vbCritical, "Operación Cancelada"
           Txt_PMIniVig.SetFocus
           Exit Sub
        End If
        Cmb_PMTipRta.SetFocus
     End If
End Sub

Private Sub Txt_PMTerVig_LostFocus()

    If (Trim(Txt_PMTerVig) <> "") Then
        Txt_PMTerVig.Text = Format(CDate(Trim(Txt_PMTerVig)), "yyyymmdd")
        Txt_PMTerVig.Text = DateSerial(Mid((Txt_PMTerVig.Text), 1, 4), Mid((Txt_PMTerVig.Text), 5, 2), Mid((Txt_PMTerVig.Text), 7, 2))
    End If
    
End Sub


'********************************************************
'********************************************************
'********************************************************
'********************************************************
'********************************************************
'********************************************************
'********************************************************
'********************************************************


Function fgBasDos(iCartera, Npolca, Numend, Nap, Nmp, Ndp, Nben, Cober, vigpen, _
                  Navig, Nmvig, Ndvig, SalCta, penbase, Indi, Mesdif, Alt, Mesgar, _
                  Nciare, oprea, modore, Iare, Imre, Idre, fare, fmre, fdre, Porret, tce, Tvta, Tcrj, _
                  GtoFun, IVigrea_d, IVigrea_m, IVigrea_a, Vuelta, iCodCausalEndoso As String _
, iPolDerCre As String _
, iPolDerGra As String, iPolCoberCon As String, iMtoFacPenElla As Double, _
iPrcFacPenElla As Double _
, NaCot As Integer, NmCot As Integer, NdCot As Integer)
                  

' I M P O R T A N T E !!!
' DANI : usar esta constante para que puedas identificar los casos en que se adelanta el Pago de una Diferida
' cgCodCausalEndPagoDif ' = 13

'RESERVA TECNICA BASE DE RENTAS VITALICIAS
'TASA BASE PARA CADA UNA DE LAS POLIZAS

Dim Numor(1 To 20)  As Integer, Ncorbe(1 To 20) As Integer
Dim Nanbe(1 To 20) As Integer, Nmnbe(1 To 20) As Integer, Ndnbe(1 To 20) As Integer
Dim Sexobe(1 To 20) As String
Dim Coinbe(1 To 20) As String, Codcbe(1 To 20) As String
Dim Ijam(1 To 20) As Integer, Ijmn(1 To 20) As Integer, ijdn(1 To 20) As Integer

Dim FactorPorRet As Double
Dim igfh(1 To 20) As Integer
Dim derpen(1 To 20) As Integer
Dim porceb(1 To 20) As Double, Porcbe(1 To 20) As Double, Penben(1 To 20) As Double
Dim Npolbe(1 To 20) As String, swg As String

Dim Ecadif As Long, edcadi As Long, nmdifi As Long, kdif As Long
Dim edbedi As Long, limite3 As Long, edacai As Long, edacas As Long
Dim edaca As Long, edabe As Long, edalca As Long, edalbe As Long

Dim Fechan As Long, Fechap As Long
Dim perdif As Long, diftem  As Long, difdia As Long
Dim TmTcr As Double, tmtce As Double
Dim Rmcob(1 To 3, 1 To 3, 1 To 5, 1 To 3) As Double
Dim iagno As Long, idbis As Integer, idp As Integer
Dim numrec As Long, Nubenp As Long, NuBenL As Long, NumPro As Long
Dim Npnv As Long
Dim MesesReaTemporal As Long
Dim mesnocRea  As Long

Dim ncobe   As Integer, nv As Integer
Dim nmdiga  As Long, mescon As Long, mesnoc As Long

Dim icont10 As Integer, icont20 As Integer, icont30 As Integer
Dim icont35 As Integer, icont40 As Integer, icont77 As Integer

Dim nrel As Integer, nibe As Integer, nsbe As Integer, ns As Integer, ni As Integer
Dim limite1 As Long, edhm As Long, mdif As Long, nmdif As Long

Dim limite2 As Long, limite As Long, Ebedif As Long, inmdif As Long
Dim limite4 As Long, Nbpr As Long, imas1 As Long, ll As Long
Dim i As Long, j As Long, k As Long, l As Long
Dim igf As Integer, j1 As Long, ixx As Long, ia As Long, ib As Long

Dim limgar As Long, i1 As Long, i2 As Long

Dim topobe As Double
Dim tmin  As Double, tobe As Double, repa1 As Double, repa2 As Double

Dim RmTot As Double, Rmben As Double
Dim RmBenT As Double, RmbenR As Double, RmbenC As Double
Dim rmpol As Double, RmpolC As Double, RmpolR As Double
Dim paso As Double
Dim Factor As Double, factorr As Double, factorc As Double
Dim factoa As Double, factoar  As Double, factoac As Double
Dim facgratif() As Double

Dim Reser As Double, ReserR As Double, ReserC As Double
Dim Cmcau As Double, CmcauR As Double, CmcauC As Double
Dim Rmcau  As Double, RmcauC As Double, RmcauR As Double
Dim sumapx As Double, sumapxr As Double, sumapxc As Double
Dim Supxpy As Double, Supxpyr As Double, Supxpyc As Double
Dim sumaqx As Double, Sumaqxr As Double, Sumaqxc As Double
Dim rmb1 As Double, rmb1r As Double, rmb1c As Double
Dim rmb2 As Double, rmb2r As Double, rmb2c As Double
Dim vipen As Double, px1 As Double, py1  As Double
Dim Qx As Double, px As Double, py As Double
Dim Pension As Double
Dim FacReaseg(0 To 1332) As Double
Dim vlBenCed As Long, vlBenRet As Long
Dim vlPolCed As Long, vlPolRet As Long
Dim Tcrj1 As Double
Dim flumax() As Double
'I---- ABV 15-03-2005 ----
Dim vlFechaNacCausante As String
Dim vlSexoCausante     As String
Dim vlRegistro         As ADODB.Recordset
Dim fecha1             As String
Dim vlI  As Long
Dim contcausante As Long

Dim vlFechaFallecimiento As String
Dim vlFechaMatrimonio    As String
Dim vlFechaAux           As String
'I---- ABV 15-03-2005 ----
  
'I--- ABV 17/11/2005 ---
Dim nmrea As Long
'F--- ABV 17/11/2005 ---

    
On Error GoTo Err_Base
    
ReDim flumax(1 To Fintab) As Double
ReDim facgratif(0 To Fintab) As Double
    
    Fechap = Nap * 12 + Nmp
    'idp = fgBisiestro(Nap, Nmp)         'Año bisietro - modulo 4

    'Inicializacion de variables
    numrec = -1
    Nubenp = 0
    NuBenL = 0
    NumPro = 0
    Npnv = 0
    For i = 1 To 3
        For j = 1 To 3
            For k = 1 To 5
                For l = 1 To 3
                    Rmcob(i, j, k, l) = 0
                Next l
            Next k
        Next j
    Next i
    'Inicio de proceso de calculo
    topobe = 0
'    If (Cober <= 3 Or (Cober >= 13 And Cober <= 15)) And (Navig = 0 Or Nmvig = 0 Or Ndvig = 0) Then
'        Navig = 1985
'        Nmvig = 12
'        Ndvig = 28
'        Indi = 1
'        Mesdif = 0
'        Alt = 1
'        Mesgar = 0
'    End If
    
    'ISTA = 1 'NUPEN0
    'Vigencia de la poliza
    '6 -> Vigente          7 -> Vigente con Benef. designados
    '8 -> Vigente Difer.   9 -> no vigente
    If vigpen = 9 Then
        Npnv = Npnv + 1
        Exit Function
    End If
        vlFechaNacCausante = ""
    
''    'Daniela 08/05/2004
''    'Poliza con retroaceptacion Operacion de Reaseguro = "B"
''    'Por lo tanto no se realiza calculo de Reserva
''    If oprea = "B" Then
''        Npnv_B = Npnv_B + 1
''        Exit Function
''    End If
''    'Fin daniela
    i = 1
    'Datos de los Beneficiarios
    'Datos de los Beneficiarios
    If (Vuelta = 1) Then
    
        vgSql = "SELECT "
        vgSql = vgSql & "num_poliza,Num_Orden,Cod_Sexo,Cod_Par,Cod_SitInv,"
        vgSql = vgSql & "Fec_NacBen,cod_estpension,Cod_DerPen,Fec_NacHM,"
        vgSql = vgSql & "PRC_pension as prc_legal,Mto_Pension,Cod_DerCre,Cod_GruFam "
        vgSql = vgSql & ",fec_fallben, fec_matrimonio "
        vgSql = vgSql & "FROM PP_TMAE_BEN WHERE "
        vgSql = vgSql & "num_poliza = '" & Npolca & "' and "
        'vgSql = vgSql & "cod_cliente = " & vgCliente & "  and "
        vgSql = vgSql & "num_endoso = " & Numend & " "
        vgSql = vgSql & "order by num_orden "
        Set vlRegistro = vgConexionBD.Execute(vgSql)
        While Not (vlRegistro.EOF)
            Numor(i) = Trim(vlRegistro!Num_Orden)
            Sexobe(i) = Trim(vlRegistro!Cod_Sexo)
            Ncorbe(i) = Trim(vlRegistro!Cod_Par)
            If (Ncorbe(i) = 99) Or (Ncorbe(i) = 0) Then
                vlFechaNacCausante = vlRegistro!Fec_NacBen
                vlSexoCausante = Trim(vlRegistro!Cod_Sexo)
            End If
            
            Coinbe(i) = Trim(vlRegistro!Cod_SitInv)
            fecha1 = DateSerial(Mid(vlRegistro!Fec_NacBen, 1, 4), Mid(vlRegistro!Fec_NacBen, 5, 2), Mid(vlRegistro!Fec_NacBen, 7, 2))
            If Not IsNull(vlRegistro!Fec_NacBen) Then
                Nanbe(i) = Mid(vlRegistro!Fec_NacBen, 1, 4)
                Nmnbe(i) = Mid(vlRegistro!Fec_NacBen, 5, 2)
                Ndnbe(i) = Mid(vlRegistro!Fec_NacBen, 7, 2)
            End If
            
            If Not IsNull(vlRegistro!Fec_NacHM) Then
                Ijam(i) = Mid(vlRegistro!Fec_NacHM, 1, 4)
                Ijmn(i) = Mid(vlRegistro!Fec_NacHM, 5, 2)
                ijdn(i) = Mid(vlRegistro!Fec_NacHM, 7, 2)
            End If
            Porcbe(i) = Trim(vlRegistro!PRC_LEGAL)
            'Penben(i) = Trim(vlRegistro!Mto_Pension)
            Penben(i) = CDbl(Format(penbase * (Porcbe(i) / 100), "#0.00"))
            Codcbe(i) = Trim(vlRegistro!Cod_DerCre)
            igfh(i) = Trim(vlRegistro!Cod_GruFam)
            
            NuBenL = NuBenL + 1
            
            
            'I--- ABV 14/04/2005 ---
            'Dº Potencial a Pensión de Sobrevivencia
            'Se debería considerar el campo de Estado Pensión, sin embargo, se debe
            'considerar el potencial Dº a recibir, por ende sería correcto determinar
            'dicho Derecho desde el cálculo
            'Derpen(i) = Trim(vlRegistro!Cod_DerPen)
            vlFechaFallecimiento = IIf(IsNull(vlRegistro!Fec_FallBen), "", Trim(vlRegistro!Fec_FallBen))
            vlFechaMatrimonio = IIf(IsNull(vlRegistro!Fec_Matrimonio), "", Trim(vlRegistro!Fec_Matrimonio))
            If (Ncorbe(i) >= 30 And Ncorbe(i) <= 39) Then
                'Si se trata de Hijos, se debe validar la fecha de Nacimiento
                'por si son mayores de 24 años
                
                If (vlFechaFallecimiento <> "") Or (vlFechaMatrimonio <> "") Then
                    derpen(i) = clCodSinDerPen
                Else
                    nrel = 0
                    nibe = 0
                    Select Case (Coinbe(i))
                        Case "S", "T": nibe = 1
                        Case "N": nibe = 2
                        Case "P": nibe = 3
                        Case Else
                            vgError = 1017
                            Exit Function
                    End Select
                    nsbe = 0
                    Select Case (Sexobe(i))
                        Case "M", "T": nsbe = 1
                        Case "F": nsbe = 2
                        Case Else
                            vgError = 1018
                            Exit Function
                    End Select
'                    Fechan = Nanbe(i) * 12 + Nmnbe(i)
'                    edabe = Fechap - Fechan
'                    difdia = Ndp - Ndnbe(i)
'                    If difdia > 15 Then edabe = edabe + 1
'                    If edabe < 1 Then edabe = 1
                    edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(i), Nmnbe(i), Ndnbe(i), Ncorbe(i))

                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If (edabe > L24) Then
                        If (nibe = 2) Then
                            derpen(i) = clCodSinDerPen
                        Else
                            derpen(i) = clCodConDerPen
                        End If
                    Else
                        derpen(i) = clCodConDerPen
                    End If
                End If
                
            Else
                If (vlFechaFallecimiento <> "" Or vlFechaMatrimonio <> "") Then
                    derpen(i) = clCodSinDerPen
                Else
                    derpen(i) = clCodConDerPen
                End If
            End If
            
            If derpen(i) <> 10 Then topobe = topobe + Porcbe(i)
            If Ncorbe(i) = 77 Then
                If vigpen <> 7 Then vigpen = 7
            End If
            Porcbe(i) = Porcbe(i) / 100
            i = i + 1
            vlRegistro.MoveNext
        Wend
        vlRegistro.Close
    Else
        If (Msf_BMGrilla.rows > 1) Then
            i = 1
            While i <= (Msf_BMGrilla.rows - 1)
                Numor(i) = Trim(Msf_BMGrilla.TextMatrix(i, 0))
                Sexobe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 9))
                Ncorbe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 7))
                
                'I--- ABV 15/03/2005 ---
                If (Ncorbe(i) = 99) Or (Ncorbe(i) = 0) Then
                    'vlFechaNacCausante = Trim(Msf_BMGrilla.TextMatrix(i, 14))
                    vlFechaNacCausante = Format(Trim(Msf_BMGrilla.TextMatrix(i, 16)), "yyyymmdd")
                    vlSexoCausante = Trim(Msf_BMGrilla.TextMatrix(i, 9))
                End If
                'F--- ABV 15/03/2005 ---
                        
                Coinbe(i) = Msf_BMGrilla.TextMatrix(i, 10)
                'fecha1 = DateSerial(Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4), Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2), Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2))
                vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 16)), "yyyymmdd")
                'If Trim(Msf_BMGrilla.TextMatrix(i, 14)) <> "" Then
                If Trim(vlFechaAux) <> "" Then
                    'Nanbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4)
                    'Nmnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2)
                    'Ndnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2)
                    Nanbe(i) = Mid(vlFechaAux, 1, 4)
                    Nmnbe(i) = Mid(vlFechaAux, 5, 2)
                    Ndnbe(i) = Mid(vlFechaAux, 7, 2)
                End If
                
                
                'If Not IsNull(Msf_BMGrilla.TextMatrix(i, 15)) And ((Msf_BMGrilla.TextMatrix(i, 15)) <> "") Then
                If (Trim(Msf_BMGrilla.TextMatrix(i, 17)) <> "") Then
                    'Ijam(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 1, 4)
                    'Ijmn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 5, 2)
                    'ijdn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 7, 2)
                    vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 17)), "yyyymmdd")
                    
                    Ijam(i) = Mid(vlFechaAux, 1, 4)
                    Ijmn(i) = Mid(vlFechaAux, 5, 2)
                    ijdn(i) = Mid(vlFechaAux, 7, 2)
                End If
                Porcbe(i) = IIf(Msf_BMGrilla.TextMatrix(i, 20) = "", 0, Msf_BMGrilla.TextMatrix(i, 20))
                'Determinar el monto de la Pensión del Beneficiario
                'Penben(i) = IIf(Msf_BMGrilla.TextMatrix(vlI, 17) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 17))
                Penben(i) = CDbl(Format(penbase * (Porcbe(i) / 100), "#0.00"))
                
                Codcbe(i) = Msf_BMGrilla.TextMatrix(i, 12)
                igfh(i) = Msf_BMGrilla.TextMatrix(i, 8)
                
                NuBenL = NuBenL + 1
                
                
                'I--- ABV 14/04/2005 ---
                'Dº Potencial a Pensión de Sobrevivencia
                'Se debería considerar el campo de Estado Pensión, sin embargo, se debe
                'considerar el potencial Dº a recibir, por ende sería correcto determinar
                'dicho Derecho desde el cálculo
                ''Derpen(i) = Msf_BMGrilla.TextMatrix(i, 9)
                'Derpen(i) = Msf_BMGrilla.TextMatrix(i, 20)
                
                'vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 19) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 19)))
                'vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 27) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 27)))
                vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 21) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 21)), "yyyymmdd"))
                vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 29) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 29)), "yyyymmdd"))
                
                If (Ncorbe(i) >= 30 And Ncorbe(i) <= 39) Then
                    'Si se trata de Hijos, se debe validar la fecha de Nacimiento
                    'por si son mayores de 18 años
                    
                    If (vlFechaFallecimiento <> "") Or (vlFechaMatrimonio <> "") Then
                        derpen(i) = clCodSinDerPen
                    Else
                        nrel = 0
                        nibe = 0
                        Select Case (Coinbe(i))
                            Case "S", "T": nibe = 1
                            Case "N": nibe = 2
                            Case "P": nibe = 3
                            Case Else
                                vgError = 1017
                                Exit Function
                        End Select
                        nsbe = 0
                        Select Case (Sexobe(i))
                            Case "M", "T": nsbe = 1
                            Case "F": nsbe = 2
                            Case Else
                                vgError = 1018
                                Exit Function
                        End Select
                        Fechan = Nanbe(i) * 12 + Nmnbe(i)
                        edabe = Fechap - Fechan
                        difdia = Ndp - Ndnbe(i)
                        If difdia > 15 Then edabe = edabe + 1
                        If edabe > Fintab Then
                            vgError = 1023
                            Exit Function
                        End If
                        If edabe < 1 Then edabe = 1
                        If (edabe > L24) Then
                            If (nibe = 2) Then
                                derpen(i) = clCodSinDerPen
                            Else
                                derpen(i) = clCodConDerPen
                            End If
                        Else
                            derpen(i) = clCodConDerPen
                        End If
                    End If
                    
                Else
                    'El resto de los Beneficiarios que no sean Hijos, solo se dejan como
                    'Sin Derecho a Pensión cuando están fallecidos
                    'If (vlFechaFallecimiento <> "" Or vlFechaMatrimonio <> "") Then
                    If (vlFechaFallecimiento <> "") Then
                        derpen(i) = clCodSinDerPen
                    Else
                        derpen(i) = clCodConDerPen
                    End If
                End If
                
                'Modificar el estado de Derecho a Pensión en la Grilla
                'De acuerdo a lo calculado
                Msf_BMGrilla.TextMatrix(i, 22) = derpen(i)
                
                'F--- ABV 14/04/2005 ---
                
                
                If derpen(i) <> 10 Then topobe = topobe + Porcbe(i)
                If Ncorbe(i) = 77 Then
                    If vigpen <> 7 Then vigpen = 7
                End If
                Porcbe(i) = Porcbe(i) / 100
                i = i + 1
            Wend
        Else
            'Error ya que deben existir beneficiarios en la Grilla de Modificación
            
        End If
    End If
    
    'Validar el Número de Beneficiarios
    If NuBenL = 0 Then
        vgError = 1003
        Exit Function         'Registrarlo como un Error de la Póliza
    End If
    Nben = i - 1
    fecha1 = DateSerial(Nap, Nmp, 1)
    For i = 1 To Fintab
        facgratif(i) = 1
        If (Month(fecha1) = 7 Or Month(fecha1) = 12) And iPolDerGra = "S" Then facgratif(i) = 2
        fecha1 = DateSerial(Nap, Nmp + 1, 1)
    Next i
    'cobertura conyuge
    If iMtoFacPenElla = 0 Then
        iMtoFacPenElla = 1
    End If
    'Se calculan igualmente todas las Pólizas, las cuales se distinguen por
    'el Código del Tipo de Reserva al cual pertenecen (COD_RESERVA)
    'If (Cober <= 3)
    '-------------------------------------------------
    'Leer Tabla de Mortalidad
    '-------------------------------------------------
'I--- ABV 1/11/2007 ---
'    If (fgBuscarMortalidadNormativa(Navig, Nmvig, Ndvig, Nap, Nmp, Ndp, vlSexoCausante, vlFechaNacCausante) = False) Then
    If (fgBuscarMortalidadNormativa(NaCot, NmCot, NdCot, Nap, Nmp, Ndp, vlSexoCausante, vlFechaNacCausante) = False) Then
'F--- ABV 1/11/2007 ---
        'Se produjeron errores en la obtención de una de las Tablas de Mortalidad
        Exit Function
    End If
    
    'Validacion de pension de referencia y de pension de beneficiarios
    'de sobrevivencia
    If penbase = 0 Then
        vgError = 1033
        Exit Function
    End If
    If vigpen = 6 Or vigpen = 8 Then
        If Cober = 8 Or Cober = 9 Or Cober = 10 Or Cober = 11 Then
            For i = 1 To Nben
                If Ncorbe(i) <> 99 Then
                    If derpen(i) <> 10 And Penben(i) = 0 Then
                        vgError = 1034
                        Exit Function
                    End If
                End If
            Next i
        End If
        If Cober = 4 Or Cober = 5 Or Cober = 6 Or Cober = 7 Then
                For i = 1 To Nben
                    If Ncorbe(i) = 99 And derpen(i) = 10 Then
                        vgError = 1074
                        Exit Function
                    End If
                Next i
        End If
        If Cober = 4 Or Cober = 5 Or Cober = 6 Or Cober = 7 Then
            'I - Inicio Daj 13/08/2004
            contcausante = 0
            For i = 1 To Nben
                If Ncorbe(i) = 99 Then contcausante = contcausante + 1
            Next i
            If contcausante = 0 Then
                vgError = 1075
                Exit Function
            End If
            'F - Fin Daj 13/08/2004
        End If

    End If
    'Inicializacion de variables por poliza
    Porret = Porret / 100
    FactorPorRet = Porret
    'If Porret > 0 Then FactorPorRet = Porret
    
    rmpol = 0: RmpolC = 0: RmpolR = 0
    vlPolCed = 0: vlPolRet = 0
    vlBenCed = 0: vlBenRet = 0

    'Tasa minima entra la tasa de venta y la tasa de costo equivalente
'    If Cober = 1 Or Cober = 2 Or Cober = 3 Or Cober > 12 Then
'        tmin = tce
'    Else
        If Tvta <= 0 Then
            tmin = tce
        Else
            tmin = fgMinimo(tce, Tvta)
        End If
'    End If
'    If oprea = "C" And modore = "N" And IVigrea_a <= 1993 Then
'        If Tcrj = 0 Then Tcrj = fgMinimo(tce, Tvta)
'    End If
    'Mensualizacion de tasas
    'Tasa mensual de reserva base
    tmtce = (1 + tmin / 100) ^ (1 / 12)
    'Tasa mensual a TCRj
    If fgMinimo(Tvta, tce) = tce Then Tcrj1 = Tcrj
    If fgMinimo(Tvta, tce) = Tvta Then Tcrj1 = Tvta
    If Tvta = tce Then Tcrj1 = Tvta
    
    TmTcr = (1 + Tcrj1 / 100) ^ (1 / 12)

    'Circular Nº 528
    '---------------
    'Coberturas -->
    '01 --> Sobrevivencia, 02 --> Invalidez, 03 --> Sobrevivencia de invalidez
    'Rentas Vitalicias
    '-----------------
    '04 --> Vejez Normal        05 --> Vejez Anticipada
    '06 --> Invalidez Total     07 --> Invalidez Parcial
    '08 --> Sobrevivencia
    '09 --> Sobrevivencia de 04 (VN),   10 --> Sobrevivencia de 05 (VA)
    '11 --> Sobrevivencia de 06 (IT),   12 --> Sobrevivencia de 07 (IP)
    '13 --> Sobrevivencia por traspaso o compra de cartera
    '14 --> Invalidez por traspaso o compra de cartera
    '15 --> Sobrevivencia de invalidez por traspaso o compra de cartera de 14
    
    'Tipo de cobertura o riesgo
    ncobe = 0
    ncobe = fgNCobe(Cober)
    If ncobe = 0 Then
        vgError = 1015
        Exit Function
    End If
    'Polizas del mes y de meses anteriores
    nv = 1
    If Navig = Nap And Nmvig = Nmp Then nv = 2
    'Definicion del periodo garantizado en 0 para las alternativas Simple o pensiones con distinto porcentaje legal
    'If Alt = 1 Or Alt = 4 Then Mesgar = 0 --RRR lo comente ya que no utiliza la funcion esete proceso
'I--- ABV 01/11/2007 ---
'    If iCodCausalEndoso = "13" Then
'        Mesdif = ((Nap * 12 + Nmp) - (Navig * 12 + Nmvig))
'    End If
'F--- ABV 01/11/2007 ---
    'Cobertura Inmediata
    If Indi = 1 Then
        perdif = 0
        If Mesdif > 0 Then
            vgError = 1030
            Exit Function
        End If
        If Alt = 3 Or Alt = 4 Then
            Mesgar = Mesgar - ((Nap * 12 + Nmp) - (Navig * 12 + Nmvig))
            Mesgar = fgMaximo(Mesgar, 0)
        End If
    Else
    'Cobertura diferida
        If Indi = 2 Then
            perdif = ((Navig * 12) + Nmvig) + Mesdif - Fechap - 1
            If perdif <= 0 Then
                If Alt = 3 Or Alt = 4 Then
                    Mesgar = Mesgar + perdif
                    Mesgar = fgMaximo(Mesgar, 0)
                End If
                perdif = 0
            End If
        End If
    End If
    nmdiga = perdif + Mesgar
    'Periodo no consumido para reaseguros no proporcionales
    mesnoc = fgMesNoC(Iare, Imre, Navig, Nmvig, Nap, Nmp)
    MesesReaTemporal = 0
    mesnocRea = 0
    nmrea = 0
    If fare <> 0 Then
        MesesReaTemporal = (CLng(fare) * 12 + CLng(fmre)) - (Iare * 12 + Imre)
        nmrea = MesesReaTemporal + mesnoc
        nmrea = fgMaximo(0, nmrea)
    End If
    
    For i = 0 To Fintab
        FacReaseg(i) = FactorPorRet
        If i < mesnoc Then
            FacReaseg(i) = 1
        Else
            If i > nmrea Then
                FacReaseg(i) = 1
            Else
                FacReaseg(i) = FactorPorRet
            End If
        End If
    Next i
    Cober = CInt(Cober)
    'Impresion de datos basicos de la poliza
    
'''    'RESERVA DE SOBREVIVENCIA
    If Cober = 8 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Then
        
        'Calculo valor presente de pensiones garantizadas de sobrevivencia de vejez o invalidez
        'Calculo de Beneficiarios Designados
        'Vigencia de la poliza: 7 -> Vigente con Benef. designados
        If vigpen = 7 And nmdiga > 0 Then
            RmTot = 0: RmpolR = 0: Rmben = 0
            RmBenT = 0: RmbenR = 0: RmbenC = 0
            For j = 1 To Nben
                Factor = 0: factoa = 0: edabe = 0
                RmBenT = 0: Rmben = 0: RmbenR = 0: RmbenC = 0
                sumapx = 0: sumapxr = 0: sumapxc = 0
                If Ncorbe(j) = 77 And derpen(j) = 99 Then
                    Nubenp = Nubenp + 1
'                    RmbenR = (Penben(j) * ((1 - (tmtce) ^ (-1 * Mesgar)) / (tmtce - 1)) * tmtce)
                    'I - Daj 02/04/2005
                    limite1 = nmdiga - 1
                    For i = 0 To limite1
                        imas1 = i + 1
                        py = 1
                        If i < perdif Then py = 0
                        Pension = Penben(j)
'                        If Nciare > 0 Then
'                            'ACEPTACION
'                            If oprea = "A" Or oprea = "D" Then
'                                If modore = "N" Then
'                                     If i >= mesnoc And i < nmrea Then
'                                        sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * pension
'                                    End If
'                                Else
'                                    If modore = "P" Then
'                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py * Porret / tmtce ^ i) * pension
'                                    End If
'                                End If
'                            Else
'                                If modore = "N" Then
'                                    sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * pension
'                                    sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * pension
'                                    sumapx = sumapxc + sumapxr
'                                Else
'                                    If modore = "P" Then
'                                        sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * pension
'                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py / tmtce ^ i) * pension
'                                    End If
'                                End If
'                            End If
'                        Else
'                            If Nciare = 0 Then
                                sumapxr = sumapxr + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
                                sumapx = sumapx + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
'                            End If
'                        End If
                    Next i
                    Factor = sumapx / Pension
                    factorr = sumapxr / Pension
                    factorc = sumapxc / Pension
                    Rmben = sumapx
                    RmbenR = sumapxr
                    RmbenC = sumapxc
                    'F - Daj 02/04/2005
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
                    RmBenT = RmbenR + RmbenC
                    RmTot = RmTot + RmBenT
                    'I--- ABV 25/01/2005 ---
                    RmpolR = RmpolR + RmbenR
                    'F--- ABV 25/01/2005 ---
                    'Ani - Daj
                    If Nciare = 0 Then
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlBenRet = vlBenRet + 1
                        Else
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(RmBenT, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(RmBenT, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(1) & ""
                    'vgConexionBD.Execute (vgQuery)
                End If
            Next j
            If Nciare = 0 Then
                Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                Else
                    Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
                End If
            End If
            NumPro = NumPro + 1
            If Nciare = 0 Then
                vlPolRet = vlPolRet + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    vlPolRet = vlPolRet + 1
                Else
                    vlPolCed = vlPolCed + 1
                End If
            End If
            
            ''Grabar los Totales en la Póliza
            'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
            'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
            'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
            'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
            'vgQuery = vgQuery & "mto_resEND = " & Str(Format(RmBenT, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmbenC, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(RmBenT, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & " "
            'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
            'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
            'vgQuery = vgQuery & "num_endoso = " & Numend & " "
            'vgConexionBD.Execute (vgQuery)
            
            If (Vuelta = 1) Then
                vlReservaOriginal = Format(RmBenT, "#0.00")
            Else
                vlReservaCalculada = Format(RmBenT, "#0.00")
            End If
            
            Exit Function
        End If
        'Calculo de Pension de Sobrevivencia
        rmpol = 0: RmpolR = 0: RmpolC = 0
        For j = 1 To Nben
            swg = "N"
            Factor = 0: factorr = 0: factorc = 0
            factoa = 0: factoar = 0: factoac = 0
            Rmben = 0: edabe = 0
            RmbenR = 0: RmbenC = 0: RmBenT = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            rmb1 = 0: rmb1r = 0: rmb1c = 0
            rmb2 = 0: rmb2r = 0: rmb2c = 0
            If derpen(j) <> 10 And Ncorbe(j) <> 99 Then
                Nubenp = Nubenp + 1
                nrel = 0
                nibe = 0
                nibe = fgCodInvalidez(Coinbe(j))
                If nibe = 0 Then
                    vgError = 1017
                    Exit Function
                End If
                nsbe = 0
                nsbe = fgSexo(Sexobe(j))
                If nsbe = 0 Then
                    vgError = 1018
                    Exit Function
                End If
                Fechan = Nanbe(j) * 12 + Nmnbe(j)
                edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                If edabe < 1 Then edabe = 1
                If edabe > Fintab Then
                    vgError = 1023
                    Exit Function
                End If
                If edabe < 1 Then edabe = 1
                If Ncorbe(j) = 10 Or Ncorbe(j) = 20 Then nrel = 1
                If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then nrel = 2
                'RESERVA SOBREVIVENCIA VITALICIA
                If Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or _
                    Ncorbe(j) = 11 Or Ncorbe(j) = 21 Or _
                    Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                    ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                    Pension = Penben(j)
                    limite1 = Fintab - edabe - 1
                    For i = 0 To limite1
                        imas1 = i + 1
                        edalbe = edabe + i
                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                        If i < nmdiga And nrel = 1 Then py = 1
                        If i < perdif Then py = 0
                        If i > nmdiga Then Pension = penbase * Porcbe(j)
'                        If Nciare > 0 Then
'                            'ACEPTACION
'                            If oprea = "A" Or oprea = "D" Then
'                                If modore = "N" Then
'                                    If i >= mesnoc And i < nmrea Then
'                                        sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * pension
'                                    End If
'                                Else
'                                    If modore = "P" Then
'                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py * Porret / tmtce ^ i) * pension
'                                    End If
'                                End If
'                            Else
'                                If modore = "N" Then
'                                    sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * pension
'                                    sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * pension
'                                    sumapx = sumapxc + sumapxr
'                                Else
'                                    If modore = "P" Then
'                                        sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * pension
'                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py / tmtce ^ i) * pension
'                                    End If
'                                End If
'                            End If
'                        Else
'                            If Nciare = 0 Then
                                sumapxr = sumapxr + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
                                sumapx = sumapx + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
'                            End If
'                        End If
                    Next i
                    Factor = sumapx / Pension
                    factorr = sumapxr / Pension
                    factorc = sumapxc / Pension
                    Rmben = sumapx
                    RmbenR = sumapxr
                    RmbenC = sumapxc
                    rmb1 = sumapx
                    rmb1r = sumapxr
                    rmb1c = sumapxc
                    
'                Else
'                    'BENEFICIARIOS PENSION VITALICIA
'                    If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
'                        edhm = fgEdad(Fechap, idp, Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
'                        limite1 = Fintab - edabe - 1
'                        pension = Penben(j)
'                        For i = 0 To limite1
'                            imas1 = i + 1
'                            edalbe = edabe + i
'                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                            If i < nmdiga And nrel = 2 Then py = 1
'                            If i < perdif Then py = 0
'                            If i > nmdiga Then pension = penbase * Porcbe(j)
''                            If Nciare > 0 Then
''                                'ACEPTACION
''                                If oprea = "A" Or oprea = "D" Then
''                                    If modore = "N" Then
''                                        If i >= mesnoc And i < nmrea Then
''                                            sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * pension
''                                            sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * pension
''                                        End If
''                                    Else
''                                        If modore = "P" Then
''                                            sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
''                                            sumapx = sumapx + (py * Porret / tmtce ^ i) * pension
''                                        End If
''                                    End If
''                                Else
''                                    If modore = "N" Then
''                                        sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * pension
''                                        sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * pension
''                                        sumapx = sumapxc + sumapxr
''                                    Else
''                                        If modore = "P" Then
''                                            sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * pension
''                                            sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
''                                            sumapx = sumapx + (py / tmtce ^ i) * pension
''                                        End If
''                                    End If
''                                End If
''                            Else
''                                If Nciare = 0 Then
'                                    sumapxr = sumapxr + (py / tmtce ^ i) * pension * facgratif(imas1) * iMtoFacPenElla
'                                    sumapx = sumapx + (py / tmtce ^ i) * pension * facgratif(imas1) * iMtoFacPenElla
''                                End If
''                            End If
'                        Next i
'                        factor = sumapx / pension
'                        factorr = sumapxr / pension
'                        factorc = sumapxc / pension
'                        rmb1 = sumapx
'                        rmb1r = sumapxr
'                        rmb1c = sumapxc
'                        Rmben = sumapx
'                        RmbenR = sumapxr
'                        RmbenC = sumapxc
                        'DERECHO A ACRECER DE PENSIONES VITALICIAS
                        If (Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or Ncorbe(j) = 11 Or Ncorbe(j) = 21) And iPolDerCre <> "N" Then
                            If edhm > L18 Then
                                mdif = 0
                            Else
                                mdif = L18 - edhm
                            End If
                            nmdif = mdif
                            If Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Then
                                nmdif = fgMaximo(mdif, nmdiga)
                            End If
                            sumapx = 0
                            sumapxr = 0
                            sumapxc = 0
                            Ecadif = edabe + nmdif
                            limite1 = Fintab - Ecadif - 1
                            Pension = Penben(j) * 0.2
                            If Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Then
                                If nmdiga > 0 Then Pension = 0
                            End If
                            For i = 0 To limite1
                                imas1 = nmdifi + i + 1
                                edcadi = Ecadif + i
                                py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
                                nmdifi = nmdif + i
                                If nmdifi < nmdiga And nrel = 2 Then py = 1
                                If nmdifi < perdif Then py = 0
                                If nmdifi >= nmdiga Then Pension = penbase * Porcbe(j) * 0.2
'                                If Nciare > 0 Then
'                                    'ACEPTACION
'                                    If oprea = "A" Or oprea = "D" Then
'                                        If modore = "N" Then
'                                            If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ nmdifi) * pension
'                                                sumapx = sumapx + (py * FactorPorRet / tmtce ^ nmdifi) * pension
'                                            End If
'                                        Else
'                                            If modore = "P" Then
'                                                sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * pension
'                                                sumapx = sumapx + (py * Porret / tmtce ^ nmdifi) * pension
'                                            End If
'                                        End If
'                                    Else
'                                        If modore = "N" Then
'                                            sumapxr = sumapxr + (py * FacReaseg(nmdifi) / TmTcr ^ nmdifi) * pension
'                                            sumapxc = sumapxc + (py * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi) * pension
'                                            sumapx = sumapxc + sumapxr
'                                        Else
'                                            If modore = "P" Then
'                                                sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ nmdifi) * pension
'                                                sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * pension
'                                                sumapx = sumapx + (py / tmtce ^ nmdifi) * pension
'                                            End If
'                                        End If
'                                    End If
'                                Else
'                                    If Nciare = 0 Then
                                        sumapxr = sumapxr + (py / tmtce ^ nmdifi) * Pension * facgratif(imas1) * iMtoFacPenElla
                                        sumapx = sumapx + (py / tmtce ^ nmdifi) * Pension * facgratif(imas1) * iMtoFacPenElla
'                                    End If
'                                End If
                            Next i
                            rmb2 = sumapx
                            rmb2r = sumapxr
                            rmb2c = sumapxc
                    
                            factoa = sumapx / Pension
                            factoar = sumapxr / Pension
                            factoac = sumapxc / Pension
                    
                            Rmben = rmb1 + rmb2
                            RmbenR = rmb1r + rmb2r
                            RmbenC = rmb1c + rmb2c
                        End If
                    Else
                        'RESERVA DE PENSIONES TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                        If edabe <= L18 Or (Mesgar > 0 And edabe > L18) Then 'GoTo 216
                            If Mesgar > 0 And edabe > L18 Then
                                mdif = Mesgar
                            Else
                                mdif = fgMaximo(Mesgar, L18 - edabe)
                            End If
'                            If edabe < L24 Then
'                                If edabe >= L18 Then
'                                    mdif = L24 - edabe
'                                Else
'                                    mdif = L21 - edabe
'                                End If
                            nmdif = mdif - 1
                            If Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Then
                                nmdif = fgMaximo(mdif, nmdiga)
                                If nmdiga > 0 Then swg = "S"
                            End If
                            Pension = Penben(j)
                            For i = 0 To nmdif
                                imas1 = i + 1
                                edalbe = edabe + i
                                py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                If swg = "S" And i < nmdiga Then py = 1
                                If i < perdif Then py = 0
                                If i >= nmdiga Then Pension = penbase * Porcbe(j)
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If i >= mesnoc And i < nmrea Then
'                                                    sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * pension
'                                                    sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * pension
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                                    sumapx = sumapx + (py * Porret / tmtce ^ i) * pension
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * pension
'                                                sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * pension
'                                                sumapx = sumapxc + sumapxr
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * pension
'                                                    sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                                    sumapx = sumapx + (py / tmtce ^ i) * pension
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                sumapxr = sumapxr + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
                                sumapx = sumapx + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
'                                        End If
'                                    End If
                            Next i
                            Factor = sumapx / Pension
                            factorr = sumapxr / Pension
                            factorc = sumapxc / Pension

                            rmb1 = sumapx
                            rmb1r = sumapxr
                            rmb1c = sumapxc

                            Reser = sumapx
                            ReserR = sumapxr
                            ReserC = sumapxc
                            'RESERVA DE HIJOS INVALIDOS
                            If Coinbe(j) <> "N" Then
                                kdif = mdif
                                If Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Then
                                    kdif = fgMaximo(mdif, nmdiga)
                                End If
                                edbedi = edabe + kdif
                                limite3 = Fintab - edbedi - 1
                                sumapx = 0
                                sumapxr = 0
                                sumapxc = 0
                                Pension = Penben(j)
'                                paso = 0.15
                                paso = Pension
                                For i = 0 To limite3
                                    edalbe = edbedi + i
                                    nmdifi = i + kdif
                                    imas1 = nmdifi + 1
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    If nmdifi < perdif Then py = 0
                                    If nmdifi >= nmdiga Then Pension = penbase * paso
'                                        If Nciare > 0 Then
'                                            'ACEPTACION
'                                            If oprea = "A" Or oprea = "D" Then
'                                                If modore = "N" Then
'                                                    If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                        sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ nmdifi) * pension
'                                                        sumapx = sumapx + (py * FactorPorRet / tmtce ^ nmdifi) * pension
'                                                    End If
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * pension
'                                                        sumapx = sumapx + (py * Porret / tmtce ^ nmdifi) * pension
'                                                    End If
'                                                End If
'                                            Else
'                                                If modore = "N" Then
'                                                    sumapxc = sumapxc + (py * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi) * pension
'                                                    sumapxr = sumapxr + (py * FacReaseg(nmdifi) / TmTcr ^ nmdifi) * pension
'                                                    sumapx = sumapxc + sumapxr
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ nmdifi) * pension
'                                                        sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * pension
'                                                        sumapx = sumapx + (py / tmtce ^ nmdifi) * pension
'                                                    End If
'                                                End If
'                                            End If
'                                        Else
'                                            If Nciare = 0 Then
                                            sumapxr = sumapxr + (py / tmtce ^ nmdifi) * Pension * facgratif(imas1) * iMtoFacPenElla
                                            sumapx = sumapx + (py / tmtce ^ nmdifi) * Pension * facgratif(imas1) * iMtoFacPenElla
'                                            End If
'                                        End If
                                Next i
                                rmb2 = sumapx
                                rmb2r = sumapxr
                                rmb2c = sumapxc
                                factoa = sumapx / Pension
                                factoar = sumapxr / Pension
                                factoac = sumapxc / Pension
                                Rmben = rmb1 + rmb2
                                RmbenR = rmb1r + rmb2r
                                RmbenC = rmb1c + rmb2c
                            Else
                                If Coinbe(j) = "N" Then
                                    Rmben = rmb1
                                    RmbenR = rmb1r
                                    RmbenC = rmb1c
                                End If
                            End If
                        End If  'Fin    EDABE < L24
                    End If  'Fin ncorbe(j) >= 30 And ncorbe(j) < 40
                End If  'Fin    ncorbe(j) = 11 Or ncorbe(j) = 21
            End If  'Fin DERPEN(j) <> 10 and ncorbe(j) <>99
            RmBenT = RmbenR + RmbenC
            If Nciare = 0 Then
                Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                Else
                    Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                End If
            End If
            Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
            Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
    
            rmpol = rmpol + RmBenT
            RmpolR = RmpolR + RmbenR
            RmpolC = RmpolC + RmbenC
            'Ani - Daj
            ''Grabar los datos de los Beneficiarios calculados
            'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
            'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
            'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
            'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
            ''vgQuery = vgQuery & "mto_cnREND = " & Str(Format(RMBEN - RMBENC, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
            'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(Rmben, "#0.00")) & " "
            'vgQuery = vgQuery & "where "
            'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
            'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
            'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
            'vgConexionBD.Execute (vgQuery)
            If Nciare = 0 Then
                vlBenRet = vlBenRet + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    vlBenRet = vlBenRet + 1
                Else
                    vlBenCed = vlBenCed + 1
                End If
            End If
        Next j
        If Nciare = 0 Then
            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
        Else
            If oprea = "A" Or oprea = "D" Then
                Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
            Else
                Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
            End If
        End If
        NumPro = NumPro + 1
        If Nciare = 0 Then
            vlPolRet = vlPolRet + 1
        Else
            If oprea = "A" Or oprea = "D" Then
                vlPolRet = vlPolRet + 1
            Else
                vlPolCed = vlPolCed + 1
            End If
        End If
        
        'Ani - Daj
'        vlPolRet = vlPolRet + 1
        
        ''Grabar los Totales en la Póliza
        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
        'vgConexionBD.Execute (vgQuery)
        
        If (Vuelta = 1) Then
            vlReservaOriginal = Format(rmpol, "#0.00")
        Else
            vlReservaCalculada = Format(rmpol, "#0.00")
        End If
        
        Exit Function
    Else
        'RESERVA MATEMATICA PARA VEJEZ E INVALIDEZ
        If Alt = 3 Or Alt = 4 Then
            If topobe > 200 And Mesgar > 0 Then GoTo 1000
        End If
        For j = 1 To Nben
            'Definicion de pension del beneficiario
            'como pension de referencia por porcentaje de pension
            Penben(j) = penbase * Porcbe(j)
            RmBenT = 0: edabe = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            sumaqx = 0: Sumaqxr = 0: Sumaqxc = 0
            Rmcau = 0: RmcauC = 0: RmcauR = 0
            Cmcau = 0: CmcauR = 0: CmcauC = 0
            Factor = 0: factorr = 0: factorc = 0
            factoa = 0: factoar = 0: factoac = 0
            Rmben = 0: RmbenR = 0: RmbenC = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            Supxpy = 0: Supxpyr = 0: Supxpyc = 0
            rmb1 = 0: rmb1r = 0: rmb1c = 0
            rmb2 = 0: rmb2r = 0: rmb2c = 0
            If derpen(j) <> 10 Then
                Nubenp = Nubenp + 1
                'CALCULO DE LA RESERVA DEL AFILIADO
                If Ncorbe(j) = 99 And j = 1 Then
                    ni = 0
                    ni = fgCodInvalidez(Coinbe(j))
                    If ni = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    ns = 0
                    ns = fgSexo(Sexobe(j))
                    If ns = 0 Then
                        vgError = 1018
                        Exit Function
                    End If

                    'Calculo de edad del causante
                    edaca = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edaca <= 216 And Coinbe(j) = "N" Then edaca = 216
                    If edaca > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    limite1 = Fintab - edaca - 1
                    For i = 0 To limite1
                        edacai = edaca + i
                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
                        If i < nmdiga Then px = 1
                        If i < perdif Then px = 0
                        edacas = edacai + 1
                        Qx = ((Lx(ns, ni, edacai) - Lx(ns, ni, edacas))) / Lx(ns, ni, edaca)
                        If i < perdif Then Qx = 0
'                        If Nciare > 0 Then
'                            'ACEPTACION
'                            If oprea = "A" Or oprea = "D" Then
'                                If modore = "N" Then
'                                    If i >= mesnoc And i < nmrea Then
'                                        sumapxr = (sumapxr + px * FactorPorRet / tmtce ^ i)
'                                        Sumaqxr = (Sumaqxr + Qx * FactorPorRet / tmtce ^ (0.5 + i))
'                                        sumapx = (sumapx + px * FactorPorRet / tmtce ^ i)
'                                        sumaqx = (sumaqx + Qx * FactorPorRet / tmtce ^ (0.5 + i))
'                                    End If
'                                Else
'                                    If modore = "P" Then
'                                        sumapxr = sumapxr + px * Porret / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px * Porret / tmtce ^ i
'                                        sumaqx = sumaqx + Qx * Porret / tmtce ^ (0.5 + i)
'                                    End If
'                                End If
'                            Else
'                                If modore = "N" Then
'                                    sumapxr = sumapxr + px * FacReaseg(i) / TmTcr ^ i
'                                    Sumaqxr = Sumaqxr + Qx * FacReaseg(i) / TmTcr ^ (0.5 + i)
'                                    sumapxc = sumapxc + px * (1 - FacReaseg(i)) / tmtce ^ i
'                                    Sumaqxc = Sumaqxc + Qx * (1 - FacReaseg(i)) / tmtce ^ (0.5 + i)
'                                    sumapx = sumapxc + sumapxr
'                                    sumaqx = Sumaqxc + Sumaqxr
'                                Else
'                                    If modore = "P" Then
'                                        sumapxc = sumapxc + px * (1 - Porret) / tmtce ^ i
'                                        Sumaqxc = Sumaqxc + Qx * (1 - Porret) / tmtce ^ (0.5 + i)
'                                        sumapxr = sumapxr + px * Porret / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px / tmtce ^ i
'                                        sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                                    End If
'                                End If
'                            End If
'                        Else
'                            If Nciare = 0 Then
                                sumapxr = sumapxr + px / tmtce ^ i
                                Sumaqxr = Sumaqxr + Qx / tmtce ^ (0.5 + i)
                                sumapx = sumapx + px / tmtce ^ i
                                sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                            End If
'                        End If
                    Next i
                    Cmcau = GtoFun * sumaqx
                    CmcauR = GtoFun * Sumaqxr
                    CmcauC = GtoFun * Sumaqxc
                    RmcauR = sumapxr * Penben(j) + CmcauR
                    RmcauC = sumapxc * Penben(j) + CmcauC
                    Rmcau = sumapx * Penben(j) + Cmcau
                    rmpol = Rmcau
                    RmpolR = RmcauR
                    RmpolC = RmcauC
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmcauR
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmcauC
                    RmBenT = RmcauR + RmcauC
                    If Nciare = 0 Then
                        vlPolRet = vlPolRet + 1
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlPolRet = vlPolRet + 1
                            vlBenRet = vlBenRet + 1
                        Else
                            vlPolCed = vlPolCed + 1
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                    'NUMOR(J),NCORBE(J),SEXOBE(J),COINBE(J),NANBE(J),NMNBE(J),EDACA,PENBEN(J),SUMAPX,CMCAU,RMCAU
                    'Ani - Daj
                    
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edaca, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format((sumapx + sumapx_g), "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(Cmcau, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmcauC, "#0.00")) & ", "
                    ''vgQuery = vgQuery & "mto_cnREND = " & Str(Format(Rmcau - RMCAUC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmcau, "#0.00")) - CDbl(Format(RmcauC, "#0.00"))) & ", "
                    ''vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(Rmcau, "#0.00")) & " "
                    'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(rmpol, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                Else
                    'RESERVA DE LOS BENEFICIARIOS
                    nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de la edad del beneficiario
                    edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or Ncorbe(j) = 20 Or Ncorbe(j) = 21 Or _
                        Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                        'RESERVA VIDAS CONJUNTAS VITALICIAS
                        'Probabilidad del beneficiario solo
                        limite1 = Fintab - edabe - 1
                        For i = 0 To limite1
                            imas1 = i + 1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            If i < nmdiga Then py = 0
                            If i < perdif Then py = 0
'                            If Nciare > 0 Then
'                                'ACEPTACION
'                                If oprea = "A" Or oprea = "D" Then
'                                    If modore = "N" Then
'                                        If i >= mesnoc And i < nmrea Then
'                                            sumapxr = (sumapxr + py * FactorPorRet / tmtce ^ i)
'                                            sumapx = (sumapx + py * FactorPorRet / tmtce ^ i)
'                                        End If
'                                    Else
'                                        If modore = "P" Then
'                                            sumapxr = sumapxr + py * Porret / tmtce ^ i
'                                            sumapx = sumapx + py * Porret / tmtce ^ i
'                                        End If
'                                    End If
'                                Else
'                                    If modore = "N" Then
'                                        sumapxr = sumapxr + py * FacReaseg(i) / TmTcr ^ i
'                                        sumapxc = sumapxc + py * (1 - FacReaseg(i)) / tmtce ^ i
'                                        sumapx = sumapxc + sumapxr
'                                    Else
'                                        If modore = "P" Then
'                                            sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ i
'                                            sumapxr = sumapxr + py * Porret / tmtce ^ i
'                                            sumapx = sumapxc + sumapxr
'                                        End If
'                                    End If
'                                End If
'                            Else
'                                If Nciare = 0 Then
                                    sumapxr = sumapxr + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                    sumapx = sumapx + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                End If
'                            End If
                        Next i
                        'Probabilidad conjunta de causante y beneficiario
                        limite2 = Fintab - edaca - 1
                        limite = fgMinimo(limite1, limite2)
                        For i = 0 To limite
                            imas1 = i + 1
                            edalca = edaca + i
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                            If i < nmdiga Then py = 0
                            If i < perdif Then py = 0
'                            If Nciare > 0 Then
'                                'ACEPTACION
'                                If oprea = "A" Or oprea = "D" Then
'                                    If modore = "N" Then
'                                        If i >= mesnoc And i < nmrea Then
'                                            Supxpyr = (Supxpyr + (py * px * FactorPorRet) / tmtce ^ i)
'                                            Supxpy = (Supxpy + (py * px * FactorPorRet) / tmtce ^ i)
'                                        End If
'                                    Else
'                                        If modore = "P" Then
'                                            Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
'                                            Supxpy = Supxpy + (py * px) * Porret / tmtce ^ i
'                                        End If
'                                    End If
'                                Else
'                                    If modore = "N" Then
'                                        Supxpyr = Supxpyr + (py * px) * FacReaseg(i) / TmTcr ^ i
'                                        Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(i)) / tmtce ^ i
'                                        Supxpy = Supxpyr + Supxpyc
'                                    Else
'                                        If modore = "P" Then
'                                            Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ i
'                                            Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
'                                            Supxpy = Supxpy + (py * px) / tmtce ^ i
'                                        End If
'                                    End If
'                                End If
'                            Else
'                                If Nciare = 0 Then
                                    Supxpyr = Supxpyr + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                    Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                End If
'                            End If
                        Next i
                        Factor = sumapx - Supxpy
                        factorr = sumapxr - Supxpyr
                        factorc = sumapxc - Supxpyc
                        rmb1 = Factor * Penben(j)
                        rmb1r = factorr * Penben(j)
                        rmb1c = factorc * Penben(j)
                        Rmben = rmb1
                        RmbenR = rmb1r
                        RmbenC = rmb1c
                        'If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
                        'iPolDerCre = ""
                        If (Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or Ncorbe(j) = 11 Or Ncorbe(j) = 21) And (iPolDerCre <> "N" And iPolDerCre <> "") Then
                            'RESERVA POR DERECHO A ACRECER
                            edhm = fgEdad(Fechap, CInt(Ndp), Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
                            If edhm > L24 Then
                                nmdif = 0
                            Else
                                If edhm >= L18 Then
                                    nmdif = L24 - edhm
                                Else
                                    nmdif = L21 - edhm
                                End If
                            End If
                            Ebedif = edabe + nmdif
                            sumapx = 0: sumapxr = 0: sumapxc = 0
                            Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                            'Probabilidad del beneficiario solo
                            limite1 = Fintab - Ebedif - 1
                            For i = 0 To limite1
                                imas1 = nmdif + i + 1
                                edcadi = Ebedif + i
                                py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
                                inmdif = i + nmdif
                                If inmdif < nmdiga Then py = 0
                                If inmdif < perdif Then py = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If inmdif >= mesnoc And inmdif < nmrea Then
'                                                    sumapxr = (sumapxr + py * FactorPorRet / tmtce ^ inmdif)
'                                                    sumapx = (sumapx + py * FactorPorRet / tmtce ^ inmdif)
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + py * Porret / tmtce ^ inmdif
'                                                    sumapx = sumapx + py * Porret / tmtce ^ inmdif
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + py * FacReaseg(inmdif) / TmTcr ^ inmdif
'                                                sumapxc = sumapxc + py * (1 - FacReaseg(inmdif)) / tmtce ^ inmdif
'                                                sumapx = sumapxr + sumapxc
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ inmdif
'                                                    sumapxr = sumapxr + py * Porret / tmtce ^ inmdif
'                                                    sumapx = sumapx + py / tmtce ^ inmdif
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                        sumapxr = sumapxr + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ inmdif
                                        sumapx = sumapx + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ inmdif
'                                        End If
'                                    End If
                            Next i
                            'Probabilidad conjunta del causante y beneficiario
                            Ecadif = edaca + nmdif
                            limite4 = Fintab - Ecadif - 1
                            limite = fgMinimo(limite1, limite4)
                            For i = 0 To limite
                                imas1 = nmdif + i + 1
                                edalca = Ecadif + i
                                edalbe = Ebedif + i
                                nmdifi = nmdif + i
                                py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                If nmdifi < nmdiga Then py = 0
                                If nmdifi < perdif Then py = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                    Supxpyr = Supxpyr + (py * px * FactorPorRet) / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py * px * FactorPorRet) / (tmtce ^ nmdifi)
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py * px) * Porret / (tmtce ^ nmdifi)
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                Supxpyr = Supxpyr + (py * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                Supxpy = Supxpyr + Supxpyc
'                                            Else
'                                                If modore = "P" Then
'                                                    Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ nmdifi
'                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
'                                                End If
'                                            End If
'                                        End If
'                                    Else
                                Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
                                Supxpyr = Supxpyr + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
'                                        End If
'                                    End If
                            Next i
                            vipen = 0.2 * Penben(j)
                            factoa = sumapx - Supxpy
                            factoar = sumapxr - Supxpyr
                            factoac = sumapxc - Supxpyc
                            rmb2 = factoa * vipen
                            rmb2r = factoar * vipen
                            rmb2c = factoac * vipen
                            Rmben = rmb1 + rmb2
                            RmbenR = rmb1r + rmb2r
                            RmbenC = rmb1c + rmb2c
'                            End If  'Fin Codcbe(j) <> "N"
                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
                    Else
                        'RESERVA RENTAS TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe <= L18 Or (edabe > L18 And Mesgar > 0) Then 'GoTo 206
'                            If edabe < L24 Then
                                If edabe >= L18 Then
                                    mdif = 0
                                Else
                                    mdif = L18 - edabe
                                End If
                                nmdif = mdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad conjunta del causante y beneficiario
                                limite2 = Fintab - edaca
                                limite = fgMinimo(nmdif, limite2) - 1
                                For i = 0 To limite
                                    imas1 = i + 1
                                    edalca = edaca + i
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If i < nmdiga Then py = 0
                                    If i < perdif Then py = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If i >= mesnoc And i < nmrea Then
'                                                    sumapxr = sumapxr + py * FactorPorRet / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py * px * FactorPorRet) / tmtce ^ i
'                                                    sumapx = sumapx + py * FactorPorRet / tmtce ^ i
'                                                    Supxpy = Supxpy + (py * px * FactorPorRet) / (tmtce ^ i)
'
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + py * Porret / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
'                                                    sumapx = sumapx + py * Porret / tmtce ^ i
'                                                    Supxpy = Supxpy + (py * px) * Porret / (tmtce ^ i)
'
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + py * FacReaseg(i) / TmTcr ^ i
'                                                Supxpyr = Supxpyr + (py * px) * FacReaseg(i) / TmTcr ^ i
'                                                sumapxc = sumapxc + py * (1 - FacReaseg(i)) / tmtce ^ i
'                                                Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(i)) / tmtce ^ i
'                                                sumapx = sumapxr + sumapxc
'                                                Supxpy = Supxpyr + Supxpyc
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ i
'                                                    Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ i
'                                                    sumapxr = sumapxr + py * Porret / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
'                                                    sumapx = sumapx + py / tmtce ^ i
'                                                    Supxpy = Supxpy + (py * px) / (tmtce ^ i)
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            Supxpyr = Supxpyr + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            sumapx = sumapx + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ i)
'                                        End If
'                                    End If
                                Next i
                                Factor = sumapx - Supxpy
                                factorr = sumapxr - Supxpyr
                                factorc = sumapxc - Supxpyc
                                rmb1 = Factor * Penben(j)
                                rmb1r = factorr * Penben(j)
                                rmb1c = factorc * Penben(j)
                                'RESERVA DEL HIJO INVALIDO
                                If Coinbe(j) <> "N" Then
                                    sumapx = 0: sumapxr = 0: sumapxc = 0
                                    Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                    'Probabilidad conjunta del causante y beneficiario
                                    edbedi = edabe + nmdif
                                    limite3 = Fintab - edbedi - 1
                                    limite4 = Fintab - (edaca + nmdif) - 1
                                    For i = 0 To limite3
                                        nmdifi = nmdif + i
                                        imas1 = nmdifi + 1
                                        edalca = edaca + nmdif + i
                                        edalbe = edbedi + i
                                        edalca = fgMinimo(edalca, Fintab)
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                        If nmdifi < nmdiga Then py = 0
                                        If nmdifi < perdif Then py = 0
'                                        If Nciare > 0 Then
'                                            'ACEPTACION
'                                            If oprea = "A" Or oprea = "D" Then
'                                                If modore = "N" Then
'                                                    If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                        sumapxr = sumapxr + py * FactorPorRet / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py * px * FactorPorRet) / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py * FactorPorRet / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py * px * FactorPorRet) / (tmtce ^ nmdifi)
'                                                    End If
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxr = sumapxr + py * Porret / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py * Porret / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py * px) * Porret / (tmtce ^ nmdifi)
'                                                    End If
'                                                End If
'                                            Else
'                                                If modore = "N" Then
'                                                    sumapxr = sumapxr + py * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                    Supxpyr = Supxpyr + (py * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                    sumapxc = sumapxc + py * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                    Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                    sumapx = sumapxr + sumapxc
'                                                    Supxpy = Supxpyr + Supxpyc
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ nmdifi
'                                                        Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ nmdifi
'                                                        sumapxr = sumapxr + py * Porret / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
'                                                    End If
'                                                End If
'                                            End If
'                                        Else
'                                            If Nciare = 0 Then
                                        sumapxr = sumapxr + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                        Supxpyr = Supxpyr + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                        sumapx = sumapx + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                        Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
'                                            End If
'                                        End If
                                    Next i
                                    factoa = sumapx - Supxpy
                                    factoar = sumapxr - Supxpyr
                                    factoac = sumapxc - Supxpyc
                                    vipen = Penben(j)
                                    Rmben = rmb1 + factoa * vipen
                                    RmbenR = rmb1r + factoar * vipen
                                    RmbenC = rmb1c + factoac * vipen
                                Else
                                    If Coinbe(j) = "N" Then
                                        Rmben = rmb1
                                        RmbenR = rmb1r
                                        RmbenC = rmb1c
                                    End If
                                End If  'Fin    coinbe(j) <> "N"
                            End If  'Fin    Edabe < L24
                        End If  'Fin    ncorbe(j) >= 30 And ncorbe(j) < 40
                    End If  'Fin ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
                    rmpol = rmpol + Rmben
                    RmpolR = RmpolR + RmbenR
                    RmpolC = RmpolC + RmbenC
                    RmBenT = RmbenR + RmbenC
                    'Ani - Dani
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                    If Nciare = 0 Then
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlBenRet = vlBenRet + 1
                        Else
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                End If  'Fin Ncorbe(j) = 99 And j = 1
            End If  'Fin
        Next j
        NumPro = NumPro + 1
        'Ani - Dani
            
        ''Grabar los Totales en la Póliza
        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
        'vgConexionBD.Execute (vgQuery)
        
        If (Vuelta = 1) Then
            vlReservaOriginal = Format(rmpol, "#0.00")
        Else
            vlReservaCalculada = Format(rmpol, "#0.00")
        End If
        
        Exit Function
        'PORCENTAJE MAYOR AL 100%
1000:
        For ib = 1 To Fintab
            flumax(ib) = 0
        Next ib
        'FLUJOS DE RENTAS VITALICIAS DE VEJEZ E INVALIDEZ
        For j = 1 To Nben
            If derpen(j) <> 10 Then
                Penben(j) = penbase * Porcbe(j)
                Nbpr = Nbpr + 1
                'CALCULO DE LA RESERVA DEL AFILIADO
                If Ncorbe(j) = 99 And j = 1 Then
                    ni = 0
                    ni = fgCodInvalidez(Coinbe(j))
                    If ni = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    ns = 0
                    ns = fgSexo(Sexobe(j))
                    If ns = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de edad del causante
                    edaca = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edaca <= 216 Then edaca = 216
                    If edaca > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    limite1 = Fintab - edaca - 1
                    For i = 0 To limite1
                        imas1 = i + 1
                        edacai = edaca + i
                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
                        edacas = edacai + 1
                        flumax(imas1) = flumax(imas1) + (px * Penben(j))
                    Next i
                Else
                    'RESERVA DE LOS BENEFICIARIOS
                    nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de la edad del beneficiario
                    edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or Ncorbe(j) = 20 Or Ncorbe(j) = 21 Or _
                        Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                        'FLUJOS DE VIDAS CONJUNTAS VITALICIAS
                        'Probabilidad del beneficiario solo
                        limite1 = Fintab - edabe - 1
                        For i = 0 To limite1
                            imas1 = i + 1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            flumax(imas1) = flumax(imas1) + (py * Penben(j) * facgratif(imas1) * iMtoFacPenElla)
                        Next i
                        'Probabilidad conjunta de causante y beneficiario
                        limite2 = Fintab - edaca - 1
                        limite = fgMinimo(limite1, limite2)
                        For i = 0 To limite
                            imas1 = i + 1
                            edalca = edaca + i
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                            flumax(imas1) = flumax(imas1) - (py * px * Penben(j) * facgratif(imas1) * iMtoFacPenElla)
                        Next i
                        If (Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or Ncorbe(j) = 11 Or Ncorbe(j) = 21) And iPolDerCre <> "N" Then
                            'FLUJO POR DERECHO A ACRECER
                            edhm = fgEdad(Fechap, CInt(Ndp), Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
                            If Codcbe(j) <> "N" Then
                                If edhm > L18 Then
                                    nmdif = 0
                                Else
                                    nmdif = L18 - edhm
                                End If
                                Ebedif = edabe + nmdif
                                'Probabilidad del beneficiario solo
                                limite1 = Fintab - Ebedif - 1
                                For i = 0 To limite1
                                    edalbe = Ebedif + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    nmdifi = nmdif + i
                                    imas1 = nmdifi + 1
                                    flumax(imas1) = flumax(imas1) + (py * Penben(j) * 0.2 * facgratif(imas1) * iMtoFacPenElla)
                                Next i
                                'Probabilidad conjunta del causante y beneficiario
                                Ecadif = edaca + nmdif
                                limite4 = Fintab - Ecadif - 1
                                limite = fgMinimo(limite1, limite4)
                                For i = 0 To limite
                                    edalca = Ecadif + i
                                    edalbe = Ebedif + i
                                    nmdifi = nmdif + i
                                    imas1 = nmdifi + 1
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    flumax(imas1) = flumax(imas1) - (py * px * Penben(j) * 0.2 * facgratif(imas1) * iMtoFacPenElla)
                                Next i
                            End If  'Fin    codcbe(j) <> "N"
                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
                    Else
                        'RESERVA RENTAS TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe <= L18 Or (edabe > L18 And Mesgar > 0) Then 'GoTo 206
'                            If edabe < L24 Then
                                If edabe >= L18 Then
                                    mdif = L18 - edabe
                                Else
                                    mdif = L18 - edabe
                                End If
                                nmdif = mdif
                                'Probabilidad conjunta del causante y beneficiario
                                limite2 = Fintab - edaca
                                limite = fgMinimo(nmdif, limite2) - 1
                                For i = 0 To limite
                                    imas1 = i + 1
                                    edalca = edaca + i
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    flumax(imas1) = flumax(imas1) + (py - py * px) * Penben(j) * facgratif(imas1) * iMtoFacPenElla
                                Next i
                                'RESERVA DEL HIJO INVALIDO
                                If Coinbe(j) <> "N" Then
                                    'Probabilidad conjunta del causante y beneficiario
                                    edbedi = edabe + nmdif
                                    limite3 = Fintab - edbedi - 1
                                    limite4 = Fintab - (edaca + nmdif) - 1
                                    For i = 0 To limite3
                                        nmdifi = nmdif + i
                                        imas1 = nmdifi + 1
                                        edalca = edaca + nmdif + i
                                        edalbe = edbedi + i
                                        edalca = fgMinimo(edalca, Fintab)
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                        vipen = Penben(j)
                                        flumax(imas1) = flumax(imas1) + (py - py * px) * vipen * facgratif(imas1) * iMtoFacPenElla
                                    Next i
                                End If  'Fin    coinbe(j) <> "N"
                            End If  'Fin    Edabe < L24
                        End If  'Fin    (ncorbe(j) >= 30 And ncorbe(j) < 40)
                    End If  'Fin    ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or
                End If  'Fin    ncorbe(j) = 99 And j = 1
            End If  'fIN DERECHO A PENSION
        Next j
        If topobe > 200 Then
            For ll = 1 To nmdiga
                If (penbase > flumax(ll)) Then GoTo 1003
            Next ll
1003:       limgar = ll
        End If
        
        'CALCULO DE RESERVA BASE A POLIZAS CON PORCENTAJE MAYOR AL 100%
        'RESERVA MATEMATICA PARA VEJEZ E INVALIDEZ
        For j = 1 To Nben
            Penben(j) = penbase * Porcbe(j)
            edabe = 0: RmBenT = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            sumaqx = 0: Sumaqxr = 0: Sumaqxc = 0
            Rmcau = 0: RmcauC = 0: RmcauR = 0
            Cmcau = 0: CmcauR = 0: CmcauC = 0
            Factor = 0: factorr = 0: factorc = 0
            factoa = 0: factoar = 0: factoac = 0
            Rmben = 0: RmbenR = 0: RmbenC = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            Supxpy = 0: Supxpyr = 0: Supxpyc = 0
            rmb1 = 0: rmb1r = 0: rmb1c = 0
            rmb2 = 0: rmb2r = 0: rmb2c = 0
            If derpen(j) <> 10 Then
                Nubenp = Nubenp + 1
                'CALCULO DE LA RESERVA DEL AFILIADO
                If Ncorbe(j) = 99 And j = 1 Then
                    ni = 0
                    ni = fgCodInvalidez(Coinbe(j))
                    If ni = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    ns = 0
                    ns = fgSexo(Sexobe(j))
                    If ns = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de edad del causante
                    edaca = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edaca <= 216 And Coinbe(j) = "N" Then edaca = 216
                    If edaca > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    limite1 = Fintab - edaca - 1
                    For i = 0 To limite1
                        edacai = edaca + i
                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
                        If i < limgar Then
                            px1 = px
                        Else
                            If i >= limgar And i < nmdiga Then
                                px1 = 1
                            Else
                                px1 = px
                            End If
                        End If
                        If i < perdif Then px1 = 0
                        edacas = edacai + 1
                        Qx = ((Lx(ns, ni, edacai) - Lx(ns, ni, edacas))) / Lx(ns, ni, edaca)
                        If i < perdif Then Qx = 0
'                        If Nciare > 0 Then
'                            'ACEPTACION
'                            If oprea = "A" Or oprea = "D" Then
'                                If modore = "N" Then
'                                    If i >= mesnoc And i < nmrea Then
'                                        sumapxr = sumapxr + px1 * FactorPorRet / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * FactorPorRet / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px1 * FactorPorRet / tmtce ^ i
'                                        sumaqx = sumaqx + Qx * FactorPorRet / tmtce ^ (0.5 + i)
'                                    End If
'                                Else
'                                    If modore = "P" Then
'                                        sumapxr = sumapxr + px1 * Porret / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px1 * Porret / tmtce ^ i
'                                        sumaqx = sumaqx + Qx * Porret / tmtce ^ (0.5 + i)
'                                    End If
'                                End If
'                            Else
'                                If modore = "N" Then
'                                    sumapxr = sumapxr + px1 * FacReaseg(i) / TmTcr ^ i
'                                    Sumaqxr = Sumaqxr + Qx * FacReaseg(i) / TmTcr ^ (0.5 + i)
'                                    sumapxc = sumapxc + px1 * (1 - FacReaseg(i)) / tmtce ^ i
'                                    Sumaqxc = Sumaqxc + Qx * (1 - FacReaseg(i)) / tmtce ^ (0.5 + i)
'                                    sumapx = sumapxr + sumapxc
'                                    sumaqx = Sumaqxr + Sumaqxc
'                                Else
'                                    If modore = "P" Then
'                                        sumapxc = sumapxc + px1 * (1 - Porret) / tmtce ^ i
'                                        Sumaqxc = Sumaqxc + Qx * (1 - Porret) / tmtce ^ (0.5 + i)
'                                        sumapxr = sumapxr + px1 * Porret / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px1 / tmtce ^ i
'                                        sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                                    End If
'                                End If
'                            End If
'                        Else
'                            If Nciare = 0 Then
                                sumapxr = sumapxr + px1 / tmtce ^ i
                                Sumaqxr = Sumaqxr + Qx / tmtce ^ (0.5 + i)
                                sumapx = sumapx + px1 / tmtce ^ i
                                sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                            End If
'                        End If
                    Next i
                    Cmcau = GtoFun * sumaqx
                    CmcauR = GtoFun * Sumaqxr
                    CmcauC = GtoFun * Sumaqxc
                    RmcauR = sumapxr * Penben(j) + CmcauR
                    RmcauC = sumapxc * Penben(j) + CmcauC
                    Rmcau = sumapx * Penben(j) + Cmcau
                    rmpol = Rmcau
                    RmpolR = RmcauR
                    RmpolC = RmcauC
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmcauR
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmcauC
                    RmBenT = RmcauR + RmcauC
                    If Nciare = 0 Then
                        vlPolRet = vlPolRet + 1
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlPolRet = vlPolRet + 1
                            vlBenRet = vlBenRet + 1
                        Else
                            vlPolCed = vlPolCed + 1
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                Else
                    'RESERVA DE LOS BENEFICIARIOS
                    nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de la edad del beneficiario
                    edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or _
                        Ncorbe(j) = 20 Or Ncorbe(j) = 21 Or _
                        Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                        'RESERVA VIDAS CONJUNTAS VITALICIAS
                        'Probabilidad del beneficiario solo
                        limite1 = Fintab - edabe - 1
                        For i = 0 To limite1
                            imas1 = i + 1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            If i < limgar Then
                              py1 = py
                            Else
                                If (i >= limgar And i < nmdiga) Then
                                    py1 = 0
                                Else
                                    py1 = py
                                End If
                            End If
                            If i < perdif Then py1 = 0
'                            If Nciare > 0 Then
'                                'ACEPTACION
'                                If oprea = "A" Or oprea = "D" Then
'                                    If modore = "N" Then
'                                        If i >= mesnoc And i < nmrea Then
'                                            sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ i
'                                            sumapx = sumapx + py1 * FactorPorRet / tmtce ^ i
'                                        End If
'                                    Else
'                                        If modore = "P" Then
'                                            sumapxr = sumapxr + py1 * Porret / tmtce ^ i
'                                            sumapx = sumapx + py1 * Porret / tmtce ^ i
'                                        End If
'                                    End If
'                                Else
'                                    If modore = "N" Then
'                                        sumapxr = sumapxr + py1 * FacReaseg(i) / TmTcr ^ i
'                                        sumapxc = sumapxc + py1 * (1 - FacReaseg(i)) / tmtce ^ i
'                                        sumapx = sumapxr + sumapxc
'                                    Else
'                                        If modore = "P" Then
'                                            sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ i
'                                            sumapxr = sumapxr + py1 * Porret / tmtce ^ i
'                                            sumapx = sumapx + py1 / tmtce ^ i
'                                        End If
'                                    End If
'                                End If
'                            Else
'                                If Nciare = 0 Then
                                    sumapxr = sumapxr + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                    sumapx = sumapx + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                End If
'                            End If
                        Next i
                        'Probabilidad conjunta de causante y beneficiario
                        limite2 = Fintab - edaca - 1
                        limite = fgMinimo(limite1, limite2)
                        For i = 0 To limite
                            imas1 = i + 1
                            edalca = edaca + i
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                    
                            If i < limgar Then
                                py1 = py
                            Else
                                If i >= limgar And i < nmdiga Then
                                    py1 = 0
                                Else
                                    py1 = py
                                End If
                            End If
                            If i < perdif Then py1 = 0
'                            If Nciare > 0 Then
'                                'ACEPTACION
'                                If oprea = "A" Or oprea = "D" Then
'                                    If modore = "N" Then
'                                        If i >= mesnoc And i < nmrea Then
'                                            Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ i
'                                            Supxpy = Supxpy + (py1 * px * FactorPorRet) / tmtce ^ i
'                                        End If
'                                    Else
'                                        If modore = "P" Then
'                                            Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
'                                            Supxpy = Supxpy + (py1 * px) * Porret / tmtce ^ i
'                                        End If
'                                    End If
'                                Else
'                                    If modore = "N" Then
'                                        Supxpyr = Supxpyr + (py1 * px) * FacReaseg(i) / TmTcr ^ i
'                                        Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(i)) / tmtce ^ i
'                                        Supxpy = Supxpyr + Supxpyc
'                                    Else
'                                        If modore = "P" Then
'                                            Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ i
'                                            Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
'                                            Supxpy = Supxpy + (py1 * px) / tmtce ^ i
'                                        End If
'                                    End If
'                                End If
'                            Else
'                                If Nciare = 0 Then
                                    Supxpyr = Supxpyr + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                    Supxpy = Supxpy + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                End If
'                            End If
                        Next i
                        Factor = sumapx - Supxpy
                        factorr = sumapxr - Supxpyr
                        factorc = sumapxc - Supxpyc
                        rmb1 = Factor * Penben(j)
                        rmb1r = factorr * Penben(j)
                        rmb1c = factorc * Penben(j)
                        Rmben = rmb1: RmbenR = rmb1r: RmbenC = rmb1c
                        'RESERVA POR DERECHO A ACRECER
                        'If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
                        If (Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or Ncorbe(j) = 11 Or Ncorbe(j) = 21) And iPolDerCre <> "N" Then
                            edhm = fgEdad(Fechap, CInt(Ndp), Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
                            If Codcbe(j) <> "N" Then
                                If edhm > L18 Then
                                    nmdif = 0
                                Else
                                    nmdif = L18 - edhm
                                End If
                                Ebedif = edabe + nmdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad del beneficiario solo
                                limite1 = Fintab - Ebedif - 1
                                For i = 0 To limite1
                                    edcadi = Ebedif + i
                                    py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
                                    inmdif = i + nmdif
                                    If inmdif < limgar Then
                                        py1 = py
                                    Else
                                        If inmdif >= limgar And inmdif < nmdiga Then
                                            py1 = 0
                                        Else
                                            py1 = py
                                        End If
                                    End If
                                    If inmdif < perdif Then py1 = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If inmdif >= mesnoc And inmdif < nmrea Then
'                                                    sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ inmdif
'                                                    sumapx = sumapx + py1 * FactorPorRet / tmtce ^ inmdif
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ inmdif
'                                                    sumapx = sumapx + py1 * Porret / tmtce ^ inmdif
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + py1 * FacReaseg(inmdif) / TmTcr ^ inmdif
'                                                sumapxc = sumapxc + py1 * (1 - FacReaseg(inmdif)) / tmtce ^ inmdif
'                                                sumapx = sumapxc + sumapxr
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ inmdif
'                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ inmdif
'                                                    sumapx = sumapx + py1 / tmtce ^ inmdif
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ inmdif
                                            sumapx = sumapx + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ inmdif
'                                        End If
'                                    End If
                                Next i
                                'Probabilidad conjunta del causante y beneficiario
                                Ecadif = edaca + nmdif
                                limite4 = Fintab - Ecadif - 1
                                limite = fgMinimo(limite1, limite4)
                                For i = 0 To limite
                                    edalca = Ecadif + i
                                    edalbe = Ebedif + i
                                    nmdifi = nmdif + i
                                    imas1 = imdifi + 1
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If nmdifi < limgar Then
                                        py1 = py
                                    Else
                                        If nmdifi >= limgar And nmdifi < nmdiga Then
                                            py1 = 0
                                        Else
                                            py1 = py
                                        End If
                                    End If
                                    If nmdifi < perdif Then py1 = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                    Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py1 * px * FactorPorRet) / (tmtce ^ nmdifi)
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py1 * px) * Porret / (tmtce ^ nmdifi)
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                Supxpyr = Supxpyr + (py1 * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                Supxpy = Supxpyr + Supxpyc
'                                            Else
'                                                If modore = "P" Then
'                                                    Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ nmdifi
'                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py1 * px) / tmtce ^ nmdifi
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                            Supxpyr = Supxpyr + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                            Supxpy = Supxpy + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
'                                        End If
'                                    End If
                                Next i
                                vipen = 0.2 * Penben(j)
                                factoa = sumapx - Supxpy
                                factoar = sumapxr - Supxpyr
                                factoac = sumapxc - Supxpyc
                                rmb2 = factoa * vipen
                                rmb2r = factoar * vipen
                                rmb2c = factoac * vipen
                                Rmben = rmb1 + rmb2
                                RmbenR = rmb1r + rmb2r
                                RmbenC = rmb1c + rmb2c
                            End If  'Fin CODCBE(j) <> "N"
                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
                    Else
                        'RESERVA RENTAS TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe <= L18 Or (edabe > L18 And Mesgar > 0) Then 'GoTo 206
                                If edabe >= L18 Then
                                    mdif = 0
                                Else
                                    mdif = L18 - edabe
                                End If
                                nmdif = mdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad conjunta del causante y beneficiario
                                limite2 = Fintab - edaca
                                limite = fgMinimo(nmdif, limite2) - 1
                                For i = 0 To limite
                                    imas1 = i + 1
                                    edalca = edaca + i
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If i < limgar Then
                                      py1 = py
                                    Else
                                        If i >= limgar And i < nmdiga Then
                                            py1 = 0
                                        Else
                                            py1 = py
                                        End If
                                    End If
                                    If i < perdif Then py1 = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If i >= mesnoc And i < nmrea Then
'                                                    sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ i
'                                                    sumapx = sumapx + py1 * FactorPorRet / tmtce ^ i
'                                                    Supxpy = Supxpy + (py1 * px * FactorPorRet) / (tmtce ^ i)
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
'                                                    sumapx = sumapx + py1 * Porret / tmtce ^ i
'                                                    Supxpy = Supxpy + (py1 * px) * Porret / (tmtce ^ i)
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + py1 * FacReaseg(i) / TmTcr ^ i
'                                                Supxpyr = Supxpyr + (py1 * px) * FacReaseg(i) / TmTcr ^ i
'                                                sumapxc = sumapxc + py1 * (1 - FacReaseg(i)) / tmtce ^ i
'                                                Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(i)) / tmtce ^ i
'                                                sumapx = sumapxr + sumapxc
'                                                Supxpy = Supxpyr + Supxpyc
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ i
'                                                    Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ i
'                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
'                                                    sumapx = sumapx + py1 / tmtce ^ i
'                                                    Supxpy = Supxpy + (py1 * px) / tmtce ^ i
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            Supxpyr = Supxpyr + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            sumapx = sumapx + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            Supxpy = Supxpy + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                        End If
'                                    End If
                                Next i
                                Factor = sumapx - Supxpy
                                factorr = sumapxr - Supxpyr
                                factorc = sumapxc - Supxpyc
                                rmb1 = Factor * Penben(j)
                                rmb1r = factorr * Penben(j)
                                rmb1c = factorc * Penben(j)
                                'RESERVA DEL HIJO INVALIDO
                                If Coinbe(j) <> "N" Then
                                    sumapx = 0: sumapxr = 0: sumapxc = 0
                                    Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                    'Probabilidad conjunta del causante y beneficiario
                                    edbedi = edabe + nmdif
                                    limite3 = Fintab - edbedi - 1
                                    limite4 = Fintab - (edaca + nmdif) - 1
                                    For i = 0 To limite3
                                        nmdifi = nmdif + i
                                        imas1 = nmdifi + 1
                                        edalca = edaca + nmdif + i
                                        edalbe = edbedi + i
                                        edalca = fgMinimo(edalca, Fintab)
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                        If nmdifi < limgar Then
                                            py1 = py
                                        Else
                                            If nmdifi >= limgar And nmdifi < nmdiga Then
                                                py1 = 0
                                            Else
                                                py1 = py
                                            End If
                                        End If
                                        If nmdifi < perdif Then py1 = 0
'                                        If Nciare > 0 Then
'                                            'ACEPTACION
'                                            If oprea = "A" Or oprea = "D" Then
'                                                If modore = "N" Then
'                                                    If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                        sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py1 * FactorPorRet / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py1 * px * FactorPorRet) / (tmtce ^ nmdifi)
'                                                    End If
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxr = sumapxr + py1 * Porret / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py1 * Porret / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py1 * px) * Porret / (tmtce ^ nmdifi)
'                                                    End If
'                                                End If
'                                            Else
'                                                If modore = "N" Then
'                                                    sumapxr = sumapxr + py1 * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                    Supxpyr = Supxpyr + (py1 * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                    sumapxc = sumapxc + py1 * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                    Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                    sumapx = sumapxr + sumapxc
'                                                    Supxpy = Supxpyr + Supxpyc
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ nmdifi
'                                                        Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ nmdifi
'                                                        sumapxr = sumapxr + py1 * Porret / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py1 / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py1 * px) / tmtce ^ nmdifi
'                                                    End If
'                                                End If
'                                            End If
'                                        Else
'                                            If Nciare = 0 Then
                                                sumapxr = sumapxr + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                                Supxpyr = Supxpyr + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                                sumapx = sumapx + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                                Supxpy = Supxpy + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
'                                            End If
'                                        End If
                                    Next i
                                    factoa = sumapx - Supxpy
                                    factoar = sumapxr - Supxpyr
                                    factoac = sumapxc - Supxpyc
                                    vipen = Penben(j)
                                    Rmben = rmb1 + factoa * vipen
                                    RmbenR = rmb1r + factoar * vipen
                                    RmbenC = rmb1c + factoac * vipen
                                Else
                                    If Coinbe(j) = "N" Then
                                        Rmben = rmb1
                                        RmbenR = rmb1r
                                        RmbenC = rmb1c
                                    End If
                                End If
                            End If  'Fin EDABE < L24
                        End If  'Fin ncorbe(j) >= 30 And ncorbe(j) < 40
                    End If  'Fin ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or _
                    RmBenT = RmbenR + RmbenC
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
                    rmpol = rmpol + Rmben
                    RmpolR = RmpolR + RmbenR
                    RmpolC = RmpolC + RmbenC
                    'Ani - Dani
                    
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                    If Nciare = 0 Then
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlBenRet = vlBenRet + 1
                        Else
                            vlBenCed = vlBenCed + 1
                    End If
                    End If
                End If  'Fin    ncorbe(j) = 99 And j = 1
            End If  'FIN    If derpen(j) = 10 Then
        Next j
        NumPro = NumPro + 1
        'Ani - Dani
        ''Grabar los Totales en la Póliza
        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
        'vgConexionBD.Execute (vgQuery)
    
        If (Vuelta = 1) Then
            vlReservaOriginal = Format(rmpol, "#0.00")
        Else
            vlReservaCalculada = Format(rmpol, "#0.00")
        End If
    
    End If  'Fin Sob/Vejez/inval
Exit Function
Err_Base:
    'Screen.MousePointer = 0
    Select Case Err
        Case Else
        'ProgressBar.Value = 0
        MsgBox "Error Grave en la Póliza '" & Npolca & "' : [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
        vgError = 5000
    End Select
End Function


Function fgBasDos_20071019(iCartera, Npolca, Numend, Nap, Nmp, Ndp, Nben, Cober, vigpen, _
                  Navig, Nmvig, Ndvig, SalCta, penbase, Indi, Mesdif, Alt, Mesgar, _
                  Nciare, oprea, modore, Iare, Imre, Idre, fare, fmre, fdre, Porret, tce, Tvta, Tcrj, _
                  GtoFun, IVigrea_d, IVigrea_m, IVigrea_a, Vuelta, iCodCausalEndoso As String)
                  
                  
' I M P O R T A N T E !!!
' DANI : usar esta constante para que puedas identificar los casos en que se adelanta el Pago de una Diferida
' cgCodCausalEndPagoDif ' = 13

'RESERVA TECNICA BASE DE RENTAS VITALICIAS
'TASA BASE PARA CADA UNA DE LAS POLIZAS

Dim Numor(1 To 20)  As Integer, Ncorbe(1 To 20) As Integer
Dim Nanbe(1 To 20) As Integer, Nmnbe(1 To 20) As Integer, Ndnbe(1 To 20) As Integer
Dim Sexobe(1 To 20) As String
Dim Coinbe(1 To 20) As String, Codcbe(1 To 20) As String
Dim Ijam(1 To 20) As Integer, Ijmn(1 To 20) As Integer, ijdn(1 To 20) As Integer

Dim FactorPorRet As Double
Dim igfh(1 To 20) As Integer
Dim derpen(1 To 20) As Integer
Dim porceb(1 To 20) As Double, Porcbe(1 To 20) As Double, Penben(1 To 20) As Double
Dim Npolbe(1 To 20) As String, swg As String

Dim Ecadif As Long, edcadi As Long, nmdifi As Long, kdif As Long
Dim edbedi As Long, limite3 As Long, edacai As Long, edacas As Long
Dim edaca As Long, edabe As Long, edalca As Long, edalbe As Long

Dim Fechan As Long, Fechap As Long
Dim perdif As Long, diftem  As Long, difdia As Long
Dim TmTcr As Double, tmtce As Double
Dim Rmcob(1 To 3, 1 To 3, 1 To 5, 1 To 3) As Double
Dim iagno As Long, idbis As Integer, idp As Integer
Dim numrec As Long, Nubenp As Long, NuBenL As Long, NumPro As Long
Dim Npnv As Long
Dim MesesReaTemporal As Long
Dim mesnocRea  As Long

Dim ncobe   As Integer, nv As Integer
Dim nmdiga  As Long, mescon As Long, mesnoc As Long

Dim icont10 As Integer, icont20 As Integer, icont30 As Integer
Dim icont35 As Integer, icont40 As Integer, icont77 As Integer

Dim nrel As Integer, nibe As Integer, nsbe As Integer, ns As Integer, ni As Integer
Dim limite1 As Long, edhm As Long, mdif As Long, nmdif As Long

Dim limite2 As Long, limite As Long, Ebedif As Long, inmdif As Long
Dim limite4 As Long, Nbpr As Long, imas1 As Long, ll As Long
Dim i As Long, j As Long, k As Long, l As Long
Dim igf As Integer, j1 As Long, ixx As Long, ia As Long, ib As Long

Dim limgar As Long, i1 As Long, i2 As Long

Dim topobe As Double
Dim tmin  As Double, tobe As Double, repa1 As Double, repa2 As Double

Dim RmTot As Double, Rmben As Double
Dim RmBenT As Double, RmbenR As Double, RmbenC As Double
Dim rmpol As Double, RmpolC As Double, RmpolR As Double
Dim paso As Double
Dim Factor As Double, factorr As Double, factorc As Double
Dim factoa As Double, factoar  As Double, factoac As Double
Dim facgratif(1 To 1332) As Double

Dim Reser As Double, ReserR As Double, ReserC As Double
Dim Cmcau As Double, CmcauR As Double, CmcauC As Double
Dim Rmcau  As Double, RmcauC As Double, RmcauR As Double
Dim sumapx As Double, sumapxr As Double, sumapxc As Double
Dim Supxpy As Double, Supxpyr As Double, Supxpyc As Double
Dim sumaqx As Double, Sumaqxr As Double, Sumaqxc As Double
Dim rmb1 As Double, rmb1r As Double, rmb1c As Double
Dim rmb2 As Double, rmb2r As Double, rmb2c As Double
Dim vipen As Double, px1 As Double, py1  As Double
Dim Qx As Double, px As Double, py As Double
Dim Pension As Double
Dim FacReaseg(0 To 1332) As Double
Dim vlBenCed As Long, vlBenRet As Long
Dim vlPolCed As Long, vlPolRet As Long
Dim Tcrj1 As Double
Dim flumax() As Double
'I---- ABV 15-03-2005 ----
Dim vlFechaNacCausante As String
Dim vlSexoCausante     As String
Dim vlRegistro         As ADODB.Recordset
Dim fecha1             As String
Dim vlI  As Long
Dim contcausante As Long

Dim vlFechaFallecimiento As String
Dim vlFechaMatrimonio    As String
Dim vlFechaAux           As String
'I---- ABV 15-03-2005 ----
  
'I--- ABV 17/11/2005 ---
Dim nmrea As Long
'F--- ABV 17/11/2005 ---

    
On Error GoTo Err_Base
    
ReDim flumax(1 To Fintab) As Double
    Fechap = Nap * 12 + Nmp
    'idp = fgBisiestro(Nap, Nmp)         'Año bisietro - modulo 4

    'Inicializacion de variables
    numrec = -1
    Nubenp = 0
    NuBenL = 0
    NumPro = 0
    Npnv = 0
    For i = 1 To 3
        For j = 1 To 3
            For k = 1 To 5
                For l = 1 To 3
                    Rmcob(i, j, k, l) = 0
                Next l
            Next k
        Next j
    Next i
    'Inicio de proceso de calculo
    topobe = 0
'    If (Cober <= 3 Or (Cober >= 13 And Cober <= 15)) And (Navig = 0 Or Nmvig = 0 Or Ndvig = 0) Then
'        Navig = 1985
'        Nmvig = 12
'        Ndvig = 28
'        Indi = 1
'        Mesdif = 0
'        Alt = 1
'        Mesgar = 0
'    End If
    
    'ISTA = 1 'NUPEN0
    'Vigencia de la poliza
    '6 -> Vigente          7 -> Vigente con Benef. designados
    '8 -> Vigente Difer.   9 -> no vigente
    If vigpen = 9 Then
        Npnv = Npnv + 1
        Exit Function
    End If
        vlFechaNacCausante = ""
    
''    'Daniela 08/05/2004
''    'Poliza con retroaceptacion Operacion de Reaseguro = "B"
''    'Por lo tanto no se realiza calculo de Reserva
''    If oprea = "B" Then
''        Npnv_B = Npnv_B + 1
''        Exit Function
''    End If
''    'Fin daniela
    i = 1
    'Datos de los Beneficiarios
    'Datos de los Beneficiarios
    If (Vuelta = 1) Then
    
        vgSql = "SELECT "
        vgSql = vgSql & "num_poliza,Num_Orden,Cod_Sexo,Cod_Par,Cod_SitInv,"
        vgSql = vgSql & "Fec_NacBen,cod_estpension,Cod_DerPen,Fec_NacHM,"
        vgSql = vgSql & "PRC_pension as prc_legal,Mto_Pension,Cod_DerCre,Cod_GruFam "
        vgSql = vgSql & ",fec_fallben, fec_matrimonio "
        vgSql = vgSql & "FROM PP_TMAE_BEN WHERE "
        vgSql = vgSql & "num_poliza = '" & Npolca & "' and "
        'vgSql = vgSql & "cod_cliente = " & vgCliente & "  and "
        vgSql = vgSql & "num_endoso = " & Numend & " "
        vgSql = vgSql & "order by num_orden "
        Set vlRegistro = vgConexionBD.Execute(vgSql)
        While Not (vlRegistro.EOF)
            Numor(i) = Trim(vlRegistro!Num_Orden)
            Sexobe(i) = Trim(vlRegistro!Cod_Sexo)
            Ncorbe(i) = Trim(vlRegistro!Cod_Par)
            'I--- ABV 15/03/2005 ---
            If (Ncorbe(i) = 99) Or (Ncorbe(i) = 0) Then
                vlFechaNacCausante = vlRegistro!Fec_NacBen
                vlSexoCausante = Trim(vlRegistro!Cod_Sexo)
            End If
            'F--- ABV 15/03/2005 ---
            
            Coinbe(i) = Trim(vlRegistro!Cod_SitInv)
            fecha1 = DateSerial(Mid(vlRegistro!Fec_NacBen, 1, 4), Mid(vlRegistro!Fec_NacBen, 5, 2), Mid(vlRegistro!Fec_NacBen, 7, 2))
            If Not IsNull(vlRegistro!Fec_NacBen) Then
                Nanbe(i) = Mid(vlRegistro!Fec_NacBen, 1, 4)
                Nmnbe(i) = Mid(vlRegistro!Fec_NacBen, 5, 2)
                Ndnbe(i) = Mid(vlRegistro!Fec_NacBen, 7, 2)
            End If
            
            If Not IsNull(vlRegistro!Fec_NacHM) Then
                Ijam(i) = Mid(vlRegistro!Fec_NacHM, 1, 4)
                Ijmn(i) = Mid(vlRegistro!Fec_NacHM, 5, 2)
                ijdn(i) = Mid(vlRegistro!Fec_NacHM, 7, 2)
            End If
            Porcbe(i) = Trim(vlRegistro!PRC_LEGAL)
            'I--- ABV 21/06/2005 ---
            'Penben(i) = Trim(vlRegistro!Mto_Pension)
            Penben(i) = CDbl(Format(penbase * (Porcbe(i) / 100), "#0.00"))
            'I--- ABV 21/06/2005 ---
            Codcbe(i) = Trim(vlRegistro!Cod_DerCre)
            igfh(i) = Trim(vlRegistro!Cod_GruFam)
            
            NuBenL = NuBenL + 1
            
            
            'I--- ABV 14/04/2005 ---
            'Dº Potencial a Pensión de Sobrevivencia
            'Se debería considerar el campo de Estado Pensión, sin embargo, se debe
            'considerar el potencial Dº a recibir, por ende sería correcto determinar
            'dicho Derecho desde el cálculo
            'Derpen(i) = Trim(vlRegistro!Cod_DerPen)
            vlFechaFallecimiento = IIf(IsNull(vlRegistro!Fec_FallBen), "", Trim(vlRegistro!Fec_FallBen))
            vlFechaMatrimonio = IIf(IsNull(vlRegistro!Fec_Matrimonio), "", Trim(vlRegistro!Fec_Matrimonio))
            If (Ncorbe(i) >= 30 And Ncorbe(i) <= 39) Then
                'Si se trata de Hijos, se debe validar la fecha de Nacimiento
                'por si son mayores de 24 años
                
                If (vlFechaFallecimiento <> "") Or (vlFechaMatrimonio <> "") Then
                    derpen(i) = clCodSinDerPen
                Else
                    nrel = 0
                    nibe = 0
                    Select Case (Coinbe(i))
                        Case "S", "T": nibe = 1
                        Case "N": nibe = 2
                        Case "P": nibe = 3
                        Case Else
                            vgError = 1017
                            Exit Function
                    End Select
                    nsbe = 0
                    Select Case (Sexobe(i))
                        Case "M", "T": nsbe = 1
                        Case "F": nsbe = 2
                        Case Else
                            vgError = 1018
                            Exit Function
                    End Select
'                    Fechan = Nanbe(i) * 12 + Nmnbe(i)
'                    edabe = Fechap - Fechan
'                    difdia = Ndp - Ndnbe(i)
'                    If difdia > 15 Then edabe = edabe + 1
'                    If edabe < 1 Then edabe = 1
                    edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(i), Nmnbe(i), Ndnbe(i), Ncorbe(i))

                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If (edabe > L24) Then
                        If (nibe = 2) Then
                            derpen(i) = clCodSinDerPen
                        Else
                            derpen(i) = clCodConDerPen
                        End If
                    Else
                        derpen(i) = clCodConDerPen
                    End If
                End If
                
            Else
                If (vlFechaFallecimiento <> "" Or vlFechaMatrimonio <> "") Then
                    derpen(i) = clCodSinDerPen
                Else
                    derpen(i) = clCodConDerPen
                End If
            End If
            
            If derpen(i) <> 10 Then topobe = topobe + Porcbe(i)
            If Ncorbe(i) = 77 Then
                If vigpen <> 7 Then vigpen = 7
            End If
            Porcbe(i) = Porcbe(i) / 100
            i = i + 1
            vlRegistro.MoveNext
        Wend
        vlRegistro.Close
    Else
        If (Msf_BMGrilla.rows > 1) Then
            i = 1
            While i <= (Msf_BMGrilla.rows - 1)
                Numor(i) = Trim(Msf_BMGrilla.TextMatrix(i, 0))
                Sexobe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 9))
                Ncorbe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 7))
                
                'I--- ABV 15/03/2005 ---
                If (Ncorbe(i) = 99) Or (Ncorbe(i) = 0) Then
                    'vlFechaNacCausante = Trim(Msf_BMGrilla.TextMatrix(i, 14))
                    vlFechaNacCausante = Format(Trim(Msf_BMGrilla.TextMatrix(i, 16)), "yyyymmdd")
                    vlSexoCausante = Trim(Msf_BMGrilla.TextMatrix(i, 9))
                End If
                'F--- ABV 15/03/2005 ---
                        
                Coinbe(i) = Msf_BMGrilla.TextMatrix(i, 10)
                'fecha1 = DateSerial(Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4), Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2), Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2))
                vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 16)), "yyyymmdd")
                'If Trim(Msf_BMGrilla.TextMatrix(i, 14)) <> "" Then
                If Trim(vlFechaAux) <> "" Then
                    'Nanbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4)
                    'Nmnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2)
                    'Ndnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2)
                    Nanbe(i) = Mid(vlFechaAux, 1, 4)
                    Nmnbe(i) = Mid(vlFechaAux, 5, 2)
                    Ndnbe(i) = Mid(vlFechaAux, 7, 2)
                End If
                
                
                'If Not IsNull(Msf_BMGrilla.TextMatrix(i, 15)) And ((Msf_BMGrilla.TextMatrix(i, 15)) <> "") Then
                If (Trim(Msf_BMGrilla.TextMatrix(i, 17)) <> "") Then
                    'Ijam(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 1, 4)
                    'Ijmn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 5, 2)
                    'ijdn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 7, 2)
                    vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 17)), "yyyymmdd")
                    
                    Ijam(i) = Mid(vlFechaAux, 1, 4)
                    Ijmn(i) = Mid(vlFechaAux, 5, 2)
                    ijdn(i) = Mid(vlFechaAux, 7, 2)
                End If
                Porcbe(i) = IIf(Msf_BMGrilla.TextMatrix(i, 20) = "", 0, Msf_BMGrilla.TextMatrix(i, 20))
                'Determinar el monto de la Pensión del Beneficiario
                'Penben(i) = IIf(Msf_BMGrilla.TextMatrix(vlI, 17) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 17))
                Penben(i) = CDbl(Format(penbase * (Porcbe(i) / 100), "#0.00"))
                
                Codcbe(i) = Msf_BMGrilla.TextMatrix(i, 12)
                igfh(i) = Msf_BMGrilla.TextMatrix(i, 8)
                
                NuBenL = NuBenL + 1
                
                
                'I--- ABV 14/04/2005 ---
                'Dº Potencial a Pensión de Sobrevivencia
                'Se debería considerar el campo de Estado Pensión, sin embargo, se debe
                'considerar el potencial Dº a recibir, por ende sería correcto determinar
                'dicho Derecho desde el cálculo
                ''Derpen(i) = Msf_BMGrilla.TextMatrix(i, 9)
                'Derpen(i) = Msf_BMGrilla.TextMatrix(i, 20)
                
                'vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 19) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 19)))
                'vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 27) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 27)))
                vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 21) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 21)), "yyyymmdd"))
                vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 29) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 29)), "yyyymmdd"))
                
                If (Ncorbe(i) >= 30 And Ncorbe(i) <= 39) Then
                    'Si se trata de Hijos, se debe validar la fecha de Nacimiento
                    'por si son mayores de 24 años
                    
                    If (vlFechaFallecimiento <> "") Or (vlFechaMatrimonio <> "") Then
                        derpen(i) = clCodSinDerPen
                    Else
                        nrel = 0
                        nibe = 0
                        Select Case (Coinbe(i))
                            Case "S", "T": nibe = 1
                            Case "N": nibe = 2
                            Case "P": nibe = 3
                            Case Else
                                vgError = 1017
                                Exit Function
                        End Select
                        nsbe = 0
                        Select Case (Sexobe(i))
                            Case "M", "T": nsbe = 1
                            Case "F": nsbe = 2
                            Case Else
                                vgError = 1018
                                Exit Function
                        End Select
                        Fechan = Nanbe(i) * 12 + Nmnbe(i)
                        edabe = Fechap - Fechan
                        difdia = Ndp - Ndnbe(i)
                        If difdia > 15 Then edabe = edabe + 1
                        If edabe > Fintab Then
                            vgError = 1023
                            Exit Function
                        End If
                        If edabe < 1 Then edabe = 1
                        If (edabe > L24) Then
                            If (nibe = 2) Then
                                derpen(i) = clCodSinDerPen
                            Else
                                derpen(i) = clCodConDerPen
                            End If
                        Else
                            derpen(i) = clCodConDerPen
                        End If
                    End If
                    
                Else
                    'El resto de los Beneficiarios que no sean Hijos, solo se dejan como
                    'Sin Derecho a Pensión cuando están fallecidos
                    'If (vlFechaFallecimiento <> "" Or vlFechaMatrimonio <> "") Then
                    If (vlFechaFallecimiento <> "") Then
                        derpen(i) = clCodSinDerPen
                    Else
                        derpen(i) = clCodConDerPen
                    End If
                End If
                
                'Modificar el estado de Derecho a Pensión en la Grilla
                'De acuerdo a lo calculado
                Msf_BMGrilla.TextMatrix(i, 22) = derpen(i)
                
                'F--- ABV 14/04/2005 ---
                
                
                If derpen(i) <> 10 Then topobe = topobe + Porcbe(i)
                If Ncorbe(i) = 77 Then
                    If vigpen <> 7 Then vigpen = 7
                End If
                Porcbe(i) = Porcbe(i) / 100
                i = i + 1
            Wend
        Else
            'Error ya que deben existir beneficiarios en la Grilla de Modificación
            
        End If
    End If
    
    'Validar el Número de Beneficiarios
    If NuBenL = 0 Then
        vgError = 1003
        Exit Function         'Registrarlo como un Error de la Póliza
    End If
    Nben = i - 1
    fecha1 = DateSerial(Nap, Nmp, 1)
    For i = 1 To Fintab
        facgratif(i) = 1
        If (Month(fecha1) = 7 Or Month(fecha1) = 12) And icodergra = "S" Then facgratif(i) = 2
        fecha1 = DateSerial(Nap, Nmp + 1, 1)
    Next i
    'cobertura conyuge
    If iMtoFacPenElla = 0 Then
        iMtoFacPenElla = 1
    End If
        
    'Se calculan igualmente todas las Pólizas, las cuales se distinguen por
    'el Código del Tipo de Reserva al cual pertenecen (COD_RESERVA)
    'If (Cober <= 3)
    '-------------------------------------------------
    'Leer Tabla de Mortalidad
    '-------------------------------------------------
    If (fgBuscarMortalidadNormativa(Navig, Nmvig, Ndvig, Nap, Nmp, Ndp, vlSexoCausante, vlFechaNacCausante) = False) Then
        'Se produjeron errores en la obtención de una de las Tablas de Mortalidad
        Exit Function
    End If
    
    'Validacion de pension de referencia y de pension de beneficiarios
    'de sobrevivencia
    If penbase = 0 Then
        vgError = 1033
        Exit Function
    End If
    If vigpen = 6 Or vigpen = 8 Then
        If Cober = 3 Or Cober = 8 Or Cober = 9 Or Cober = 10 Or _
            Cober = 11 Or Cober = 1 Or Cober = 13 Then
            For i = 1 To Nben
                If Ncorbe(i) <> 99 Then
                    If derpen(i) <> 10 And Penben(i) = 0 Then
                        vgError = 1034
                        Exit Function
                    End If
                End If
            Next i
        End If
        If Cober = 2 Or Cober = 4 Or Cober = 5 Or Cober = 6 Or Cober = 7 Or Cober = 14 _
            Then
                For i = 1 To Nben
                    If Ncorbe(i) = 99 And derpen(i) = 10 Then
                        vgError = 1074
                        Exit Function
                    End If
                Next i
        End If
        If Cober = 2 Or Cober = 4 Or Cober = 5 Or Cober = 6 Or Cober = 7 Or Cober = 14 Then
            'I - Inicio Daj 13/08/2004
            contcausante = 0
            For i = 1 To Nben
                If Ncorbe(i) = 99 Then contcausante = contcausante + 1
            Next i
            If contcausante = 0 Then
                vgError = 1075
                Exit Function
            End If
            'F - Fin Daj 13/08/2004
        End If

    End If
    'Inicializacion de variables por poliza
    Porret = Porret / 100
    FactorPorRet = Porret
    'If Porret > 0 Then FactorPorRet = Porret
    
    rmpol = 0: RmpolC = 0: RmpolR = 0
    vlPolCed = 0: vlPolRet = 0
    vlBenCed = 0: vlBenRet = 0

    'Tasa minima entra la tasa de venta y la tasa de costo equivalente
'    If Cober = 1 Or Cober = 2 Or Cober = 3 Or Cober > 12 Then
'        tmin = tce
'    Else
        If Tvta <= 0 Then
            tmin = tce
        Else
            tmin = fgMinimo(tce, Tvta)
        End If
'    End If
'    If oprea = "C" And modore = "N" And IVigrea_a <= 1993 Then
'        If Tcrj = 0 Then Tcrj = fgMinimo(tce, Tvta)
'    End If
    'Mensualizacion de tasas
    'Tasa mensual de reserva base
    tmtce = (1 + tmin / 100) ^ (1 / 12)
    'Tasa mensual a TCRj
    If fgMinimo(Tvta, tce) = tce Then Tcrj1 = Tcrj
    If fgMinimo(Tvta, tce) = Tvta Then Tcrj1 = Tvta
    If Tvta = tce Then Tcrj1 = Tvta
    
    TmTcr = (1 + Tcrj1 / 100) ^ (1 / 12)

    'Circular Nº 528
    '---------------
    'Coberturas -->
    '01 --> Sobrevivencia, 02 --> Invalidez, 03 --> Sobrevivencia de invalidez
    'Rentas Vitalicias
    '-----------------
    '04 --> Vejez Normal        05 --> Vejez Anticipada
    '06 --> Invalidez Total     07 --> Invalidez Parcial
    '08 --> Sobrevivencia
    '09 --> Sobrevivencia de 04 (VN),   10 --> Sobrevivencia de 05 (VA)
    '11 --> Sobrevivencia de 06 (IT),   12 --> Sobrevivencia de 07 (IP)
    '13 --> Sobrevivencia por traspaso o compra de cartera
    '14 --> Invalidez por traspaso o compra de cartera
    '15 --> Sobrevivencia de invalidez por traspaso o compra de cartera de 14
    
    'Tipo de cobertura o riesgo
    ncobe = 0
    ncobe = fgNCobe(Cober)
    If ncobe = 0 Then
        vgError = 1015
        Exit Function
    End If
    'Polizas del mes y de meses anteriores
    nv = 1
    If Navig = Nap And Nmvig = Nmp Then nv = 2
    'Definicion del periodo garantizado en 0 para las alternativas Simple o pensiones con distinto porcentaje legal
    If Alt = 1 Or (Alt = 4 And Mesgar = 0) Then Mesgar = 0
    'Cobertura Inmediata
    If Indi = 1 Then
        perdif = 0
        If Mesdif > 0 Then
            vgError = 1030
            Exit Function
        End If
        If Alt = 3 Or Alt = 4 Then
            Mesgar = Mesgar - ((Nap * 12 + Nmp) - (Navig * 12 + Nmvig))
            Mesgar = fgMaximo(Mesgar, 0)
        End If
    Else
    'Cobertura diferida
        If Indi = 2 Then
            perdif = ((Navig * 12) + Nmvig) + Mesdif - Fechap - 1
            If perdif <= 0 Then
                If Alt = 3 Or (Alt = 4 And Mesgar > 0) Then
                    Mesgar = Mesgar + perdif
                    Mesgar = fgMaximo(Mesgar, 0)
                End If
                perdif = 0
            End If
        End If
    End If
    nmdiga = perdif + Mesgar
    'Periodo no consumido para reaseguros no proporcionales
    mesnoc = fgMesNoC(Iare, Imre, Navig, Nmvig, Nap, Nmp)
    MesesReaTemporal = 0
    mesnocRea = 0
    nmrea = 0
    If fare <> 0 Then
        MesesReaTemporal = (CLng(fare) * 12 + CLng(fmre)) - (Iare * 12 + Imre)
        nmrea = MesesReaTemporal + mesnoc
        nmrea = fgMaximo(0, nmrea)
    End If
    
    For i = 0 To Fintab
        FacReaseg(i) = FactorPorRet
        If i < mesnoc Then
            FacReaseg(i) = 1
        Else
            If i > nmrea Then
                FacReaseg(i) = 1
            Else
                FacReaseg(i) = FactorPorRet
            End If
        End If
    Next i
    Cober = CInt(Cober)
    'Impresion de datos basicos de la poliza
    
'''    'RESERVA DE SOBREVIVENCIA
    If Cober = 8 Or Cober = 9 Or _
       Cober = 10 Or Cober = 11 Or Cober = 12 Then
'''
'''        'Calculo porcentajes para beneficiarios
'''        If vigpen <> 9 Then
'''            If Cober = 1 Or Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 13 Then
'''                If vigpen = 7 And topobe = 100 And nmdiga > 0 Then GoTo 543
'''                If nmdiga > 0 Then
'''                    icont10 = 0:  icont20 = 0
'''                    icont30 = 0: icont35 = 0
'''                    icont40 = 0: icont77 = 0
'''                    For j = 1 To Nben
'''                        If derpen(j) <> 10 And Ncorbe(j) <> 99 Then
'''                            nrel = 0: nibe = 0
'''                            nibe = fgCodInvalidez(Coinbe(j))
'''                            If nibe = 0 Then
'''                                vgError = 1017
'''                                Exit Function
'''                            End If
'''                            nsbe = 0
'''                            nsbe = fgSexo(Sexobe(j))
'''                            If nsbe = 0 Then
'''                                vgError = 1018
'''                                Exit Function
'''                            End If
'''                            edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
'''                            If edabe < 1 Then edabe = 1
'''                            If edabe > Fintab Then
'''                                vgError = 1023
'''                                Exit Function
'''                            End If
'''                            If edabe < 1 Then edabe = 1
'''                            If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Then icont10 = icont10 + 1
'''                            If Ncorbe(j) = 20 Or Ncorbe(j) = 21 Then icont20 = icont20 + 1
'''                            If Ncorbe(j) = 30 Then icont30 = icont30 + 1
'''                            If Ncorbe(j) = 35 Then icont35 = icont35 + 1
'''                            If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then icont40 = icont40 + 1
'''                            If Ncorbe(j) = 77 Then icont77 = icont77 + 1
'''                        End If  'Fin (DERPEN(j) <> 10 And ncorbe(j) <> 99)
'''                    Next j
'''
'''                    For igf = 0 To 10
'''                        For j = 1 To Nben
'''                            If (igfh(j) = igf) Then
'''                                If derpen(j) <> 10 And Ncorbe(j) <> 99 Then
'''                                    nrel = 0: nibe = 0
'''                                    nibe = fgCodInvalidez(Coinbe(j))
'''                                    If nibe = 0 Then
'''                                        vgError = 1017
'''                                        Exit Function
'''                                    End If
'''                                    nsbe = 0
'''                                    nsbe = fgSexo(Sexobe(j))
'''                                    If nsbe = 0 Then
'''                                        vgError = 1018
'''                                        Exit Function
'''                                    End If
'''                                    edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
'''                                    If edabe < 1 Then edabe = 1
'''                                    If edabe > Fintab Then
'''                                        vgError = 1023
'''                                        Exit Function
'''                                    End If
'''                                    If edabe < 1 Then edabe = 1
'''                                    If Ncorbe(j) = 10 Then
'''                                        If ((Ncorbe(j) = 10 And nsbe = 2) Or (Ncorbe(j) = 10 And (nsbe = 1 And nibe = 1))) Then
'''                                            If (icont10 > 0) Then porceb(j) = 60 / icont10
'''                                        Else
'''                                            If (Ncorbe(j) = 10 And nsbe = 1 And nibe = 3) Then
'''                                                If (icont10 > 0) Then porceb(j) = 43 / icont10
'''                                            End If
'''                                        End If
'''                                    End If
'''                                    If Ncorbe(j) = 20 Then
'''                                        If icont20 > 0 Then porceb(j) = 36 / icont20
'''                                    End If
'''                                    If Ncorbe(j) = 21 Then
'''                                        If icont20 > 0 Then porceb(j) = 30 / icont20
'''                                    End If
'''                                    If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then porceb(j) = 50
'''                                    If Ncorbe(j) = 77 Then porceb(j) = 100 / icont77
'''                                    If Ncorbe(j) = 11 Then
'''                                        If Ncorbe(j) = 11 And nsbe = 2 Then porceb(j) = 50 / icont10
'''                                        If Ncorbe(j) = 11 And nsbe = 1 And nibe = 1 Then
'''                                           porceb(j) = 50 / icont10
'''                                        Else
'''                                           If (Ncorbe(j) = 11 And nsbe = 1 And nibe = 3) Then porceb(j) = 36 / icont10
'''                                        End If
'''                                    End If
'''                                    If Ncorbe(j) = 30 Then
'''                                        porceb(j) = 15
'''                                        If nibe = 1 And edabe > L24 Then porceb(j) = 15
'''                                        If nibe = 3 And edabe > L24 Then porceb(j) = 11
'''                                    End If
'''                                    If Ncorbe(j) = 35 Then
'''                                        If icont10 = 0 Then
'''                                            porceb(j) = 15 + (50 / (icont35))
'''                                            If (nibe = 3 And edabe > L24) Then porceb(j) = 11 + (50 / icont35)
'''                                        End If
'''                                    End If
'''                                End If  'Fin (DERPEN(j) <> 10 and ncorbe(j) <> 99)
'''                            End If  'Fin (igfh(j) = igf)
'''                        Next j
'''                    Next igf
'''                    tobe = 0
'''                    For j1 = 1 To Nben
'''                        If derpen(j1) <> 10 Then
'''                            tobe = tobe + porceb(j1)
'''                        Else
'''                            If derpen(j1) = 10 Then porceb(j1) = 0
'''                            porceb(j1) = 0
'''                        End If
'''                    Next j1
'''                    If tobe <= 100 Then
'''                        For j = 1 To Nben
'''                            If Porcbe(j) <> 0 Then Porcbe(j) = porceb(j) / 100
'''                            If derpen(j) <> 10 Then Porcbe(j) = porceb(j) / 100
'''                        Next j
'''                    End If
'''                End If
'''            End If
'''        End If
'''        'SOBREVIVENCIAS GARANTIZADAS
'''        ixx = 0
'''        If Cober = 8 And nmdiga > 0 And vigpen <> 9 Then
'''            For j = 1 To Nben
'''                If Ncorbe(j) >= 10 And Ncorbe(j) <= 21 Then
'''                    If derpen(j) = 10 Then ixx = 1
'''                End If
'''            Next j
'''            icont10 = 0: icont20 = 0
'''            icont30 = 0: icont35 = 0
'''            icont40 = 0: icont77 = 0
'''            repa1 = 0
'''            repa2 = 0
'''            For j = 1 To Nben
'''                If derpen(j) = 10 And Ncorbe(j) = 10 Then repa1 = 50
'''                If derpen(j) = 10 And Ncorbe(j) = 11 Then repa1 = 50
'''                If derpen(j) = 10 And Ncorbe(j) = 20 Then repa2 = 30
'''                If derpen(j) = 10 And Ncorbe(j) = 21 Then repa2 = 30
'''                If Ncorbe(j) <> 99 Then
'''                    nrel = 0: nibe = 0
'''                    nibe = fgCodInvalidez(Coinbe(j))
'''                    If nibe = 0 Then
'''                        vgError = 1017
'''                        Exit Function
'''                    End If
'''                    nsbe = 0
'''                    nsbe = fgSexo(Sexobe(j))
'''                    If nsbe = 0 Then
'''                        vgError = 1018
'''                        Exit Function
'''                    End If
'''                    edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
'''                    If edabe < 1 Then edabe = 1
'''                    If edabe > Fintab Then
'''                        vgError = 1023
'''                        Exit Function
'''                    End If
'''                    If edabe < 1 Then edabe = 1
'''                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Then icont10 = icont10 + 1
'''                    If Ncorbe(j) = 20 Or Ncorbe(j) = 21 Then icont20 = icont20 + 1
'''                    If Ncorbe(j) = 30 Then icont30 = icont30 + 1
'''                    If Ncorbe(j) = 35 Then icont35 = icont35 + 1
'''                    If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then icont40 = icont40 + 1
'''                    If Ncorbe(j) = 77 Then icont77 = icont77 + 1
'''                End If  'Fin ncorbe(j) <> 99
'''            Next j
'''            For igf = 0 To 10
'''                For j = 1 To Nben
'''                    If igfh(j) = igf And derpen(j) <> 10 And Ncorbe(j) <> 99 Then
'''                        nrel = 0: nibe = 0
'''                        nibe = fgCodInvalidez(Coinbe(j))
'''                        If nibe = 0 Then
'''                            vgError = 1017
'''                            Exit Function
'''                        End If
'''                        nsbe = 0
'''                        nsbe = fgSexo(Sexobe(j))
'''                        If nsbe = 0 Then
'''                            vgError = 1018
'''                            Exit Function
'''                        End If
'''                        edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
'''                        If edabe < 1 Then edabe = 1
'''                        If edabe > Fintab Then
'''                            vgError = 1023
'''                            Exit Function
'''                        End If
'''                        If edabe < 1 Then edabe = 1
'''                        If Ncorbe(j) = 10 Then
'''                            If ((Ncorbe(j) = 10 And nsbe = 2) Or (Ncorbe(j) = 10 And (nsbe = 1 And nibe = 1))) Then
'''                                If icont10 > 0 Then porceb(j) = 60 / icont10
'''                            Else
'''                                If (Ncorbe(j) = 10 And nsbe = 1 And nibe = 3) Then
'''                                    If icont10 > 0 Then porceb(j) = 43 / icont10
'''                                End If
'''                            End If
'''                        End If
'''                        If Ncorbe(j) = 20 Then
'''                            If icont20 > 0 Then porceb(j) = 36 / icont20
'''                        End If
'''                        If (Ncorbe(j) = 21) Then
'''                            If (icont20 > 0) Then porceb(j) = 30 / icont20
'''                        End If
'''                        If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then porceb(j) = 50
'''                        If Ncorbe(j) = 77 Then porceb(j) = 100 / icont77
'''                        If Ncorbe(j) = 11 Then
'''                            If Ncorbe(j) = 11 And nsbe = 2 Then porceb(j) = 50 / icont10
'''                            If Ncorbe(j) = 11 And nsbe = 1 And nibe = 1 Then
'''                                porceb(j) = 50 / icont10
'''                            Else
'''                                If Ncorbe(j) = 11 And nsbe = 1 And nibe = 3 Then porceb(j) = 36 / icont10
'''                            End If
'''                        End If
'''                        If Ncorbe(j) = 30 Then
'''                            porceb(j) = 15
'''                            If nibe = 1 And edabe > L24 Then porceb(j) = 15
'''                            If nibe = 3 And edabe > L24 Then porceb(j) = 11
'''                        End If
'''                        If Ncorbe(j) = 35 Then
'''                            If icont10 = 0 Then
'''                                porceb(j) = 15 + (50 / icont35)
'''                                If nibe = 3 And edabe > L24 Then porceb(j) = 11 + (50 / icont35)
'''                            End If
'''                        End If
'''                    End If  'Fin igfh(j) = igf And DERPEN(j) <> 10 And ncorbe(j) <> 99
'''                Next j
'''            Next igf
'''            tobe = 0
'''            For j1 = 1 To Nben
'''                If derpen(j1) <> 10 Then
'''                    tobe = tobe + porceb(j1)
'''                Else
'''                    If derpen(j1) = 10 Then porceb(j1) = 0
'''                    porceb(j1) = 0
'''                End If
'''            Next j1
'''            If tobe <= 100 And ixx = 1 Then
'''                For j = 1 To Nben
'''                    If Porcbe(j) <> 0 Then Porcbe(j) = porceb(j) / 100
'''                    If derpen(j) <> 10 Then Porcbe(j) = porceb(j) / 100
'''                Next j
'''            End If
'''        End If
'''        'FIN CICLO PORCENTAJE DE PENSIONES LEGALES
'''543:
'''    'Inicio Distribucion de Pensiones - Daniela 20050818
'''        If Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Then
'''            If nmdiga > 0 Then
'''                tobe = 0
'''                tobepension = 0
'''                For j1 = 1 To Nben
'''                    If derpen(j1) <> 10 Then
'''                        tobe = tobe + porceb(j1)
'''                        tobepension = tobepension + Penben(j1)
'''                    End If
'''                Next j1
'''                If tobepension < penbase Then
'''                    difpension = penbase - tobepension
'''                    If tobe > 0 Then
'''                        newpension = difpension / (tobe / 100)
'''                    Else
'''                        newpension = 0
'''                    End If
'''                    For j1 = 1 To Nben
'''                        If derpen(j1) <> 10 Then
'''                            Penben(j1) = Penben(j1) + (porceb(j1) / 100 * newpension)
'''                        End If
'''                    Next j1
'''                End If
'''            End If
'''        End If
'''        'Fin Distribucion de Pensiones - Daniela 20050818
'''
'''        'Inicio Distribucion de Pensiones - Daniela 20050903
'''        If Cober = 8 Then
'''            icontcony_mhn_muertas = 0
'''            For j1 = 1 To Nben
'''                If derpen(j1) = 10 And _
'''                    (Ncorbe(j1) = 10 Or Ncorbe(j1) = 11) Then
'''                    icontcony_mhn_muertas = icontcony_mhn_muertas + 1
'''                End If
'''            Next j1
'''
'''            If nmdiga > 0 And icontcony_mhn_muertas > 0 Then
'''                tobe = 0: tobepension = 0
'''                For j1 = 1 To Nben
'''                    If derpen(j1) <> 10 Then
'''                        tobe = tobe + porceb(j1)
'''                        tobepension = tobepension + Penben(j1)
'''                    End If
'''                Next j1
'''                newpension = 0
'''                If icont35 > 0 Then
'''                    porcedistr = 0.5
'''                Else
'''                    porcedistr = 0.6
'''                End If
'''                difpension = penbase * porcedistr
'''                If tobe > 0 Then newpension = difpension / (tobe / 100)
'''                 If tobepension > (penbase * porcedistr) Then
'''                    For j1 = 1 To Nben
'''                        If derpen(j1) <> 10 Then
'''                            If icont35 > 0 Or icont77 > 0 Then
'''                                Penben(j1) = (porceb(j1) / 100 * newpension)
'''                            Else
'''
'''                                Penben(j1) = (penbase * porceb(j1) / 100) + (porceb(j1) / 100 * newpension)
'''                            End If
'''                        End If
'''                    Next j1
'''                Else
''''                    difpension = penbase * 0.5
''''                    newpension = 0
''''                    If tobe > 0 Then newpension = difpension / (tobe / 100)
'''                    For j1 = 1 To Nben
'''                        If derpen(j1) <> 10 Then
'''                            If icont35 > 0 Or icont77 > 0 Then
'''                                Penben(j1) = (porceb(j1) / 100 * newpension)
'''                            Else
'''                                Penben(j1) = Penben(j1) + (porceb(j1) / 100 * newpension)
'''                            End If
'''                        End If
'''                    Next j1
'''                End If
'''            End If
'''        End If
'''        'Fin Distribucion de Pensiones - Daniela 20050903
        'Calculo valor presente de pensiones garantizadas de sobrevivencia de vejez o invalidez
        'Calculo de Beneficiarios Designados
        'Vigencia de la poliza: 7 -> Vigente con Benef. designados
        If vigpen = 7 And nmdiga > 0 Then
            RmTot = 0: RmpolR = 0: Rmben = 0
            RmBenT = 0: RmbenR = 0: RmbenC = 0
            For j = 1 To Nben
                Factor = 0: factoa = 0: edabe = 0
                RmBenT = 0: Rmben = 0: RmbenR = 0: RmbenC = 0
                sumapx = 0: sumapxr = 0: sumapxc = 0
                If Ncorbe(j) = 77 And derpen(j) = 99 Then
                    Nubenp = Nubenp + 1
'                    RmbenR = (Penben(j) * ((1 - (tmtce) ^ (-1 * Mesgar)) / (tmtce - 1)) * tmtce)
                    'I - Daj 02/04/2005
                    limite1 = nmdiga - 1
                    For i = 0 To limite1
                        py = 1
                        If i < perdif Then py = 0
                        Pension = Penben(j)
'                        If Nciare > 0 Then
'                            'ACEPTACION
'                            If oprea = "A" Or oprea = "D" Then
'                                If modore = "N" Then
'                                     If i >= mesnoc And i < nmrea Then
'                                        sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * pension
'                                    End If
'                                Else
'                                    If modore = "P" Then
'                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py * Porret / tmtce ^ i) * pension
'                                    End If
'                                End If
'                            Else
'                                If modore = "N" Then
'                                    sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * pension
'                                    sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * pension
'                                    sumapx = sumapxc + sumapxr
'                                Else
'                                    If modore = "P" Then
'                                        sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * pension
'                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py / tmtce ^ i) * pension
'                                    End If
'                                End If
'                            End If
'                        Else
'                            If Nciare = 0 Then
                                sumapxr = sumapxr + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
                                sumapx = sumapx + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
'                            End If
'                        End If
                    Next i
                    Factor = sumapx / Pension
                    factorr = sumapxr / Pension
                    factorc = sumapxc / Pension
                    Rmben = sumapx
                    RmbenR = sumapxr
                    RmbenC = sumapxc
                    'F - Daj 02/04/2005
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
                    RmBenT = RmbenR + RmbenC
                    RmTot = RmTot + RmBenT
                    'I--- ABV 25/01/2005 ---
                    RmpolR = RmpolR + RmbenR
                    'F--- ABV 25/01/2005 ---
                    'Ani - Daj
                    If Nciare = 0 Then
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlBenRet = vlBenRet + 1
                        Else
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(RmBenT, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(RmBenT, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(1) & ""
                    'vgConexionBD.Execute (vgQuery)
                End If
            Next j
            If Nciare = 0 Then
                Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                Else
                    Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
                End If
            End If
            NumPro = NumPro + 1
            If Nciare = 0 Then
                vlPolRet = vlPolRet + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    vlPolRet = vlPolRet + 1
                Else
                    vlPolCed = vlPolCed + 1
                End If
            End If
            
            ''Grabar los Totales en la Póliza
            'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
            'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
            'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
            'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
            'vgQuery = vgQuery & "mto_resEND = " & Str(Format(RmBenT, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmbenC, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(RmBenT, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & " "
            'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
            'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
            'vgQuery = vgQuery & "num_endoso = " & Numend & " "
            'vgConexionBD.Execute (vgQuery)
            
            If (Vuelta = 1) Then
                vlReservaOriginal = Format(RmBenT, "#0.00")
            Else
                vlReservaCalculada = Format(RmBenT, "#0.00")
            End If
            
            Exit Function
        End If
        'Calculo de Pension de Sobrevivencia
        rmpol = 0: RmpolR = 0: RmpolC = 0
        For j = 1 To Nben
            swg = "N"
            Factor = 0: factorr = 0: factorc = 0
            factoa = 0: factoar = 0: factoac = 0
            Rmben = 0: edabe = 0
            RmbenR = 0: RmbenC = 0: RmBenT = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            rmb1 = 0: rmb1r = 0: rmb1c = 0
            rmb2 = 0: rmb2r = 0: rmb2c = 0
            If derpen(j) <> 10 And Ncorbe(j) <> 99 Then
                Nubenp = Nubenp + 1
                nrel = 0
                nibe = 0
                nibe = fgCodInvalidez(Coinbe(j))
                If nibe = 0 Then
                    vgError = 1017
                    Exit Function
                End If
                nsbe = 0
                nsbe = fgSexo(Sexobe(j))
                If nsbe = 0 Then
                    vgError = 1018
                    Exit Function
                End If
                Fechan = Nanbe(j) * 12 + Nmnbe(j)
                edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                If edabe < 1 Then edabe = 1
                If edabe > Fintab Then
                    vgError = 1023
                    Exit Function
                End If
                If edabe < 1 Then edabe = 1
                If Ncorbe(j) = 10 Or Ncorbe(j) = 20 Then nrel = 1
                If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then nrel = 2
                'RESERVA SOBREVIVENCIA VITALICIA
                If Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or _
                    Ncorbe(j) = 11 Or Ncorbe(j) = 21 Or _
                    Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                    ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And _
                    (Coinbe(j) <> "N")) Then
                    Pension = Penben(j)
                    limite1 = Fintab - edabe - 1
                    For i = 0 To limite1
                        edalbe = edabe + i
                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                        If i < nmdiga And nrel = 1 Then py = 1
                        If i < perdif Then py = 0
                        If i > nmdiga Then Pension = penbase * Porcbe(j)
'                        If Nciare > 0 Then
'                            'ACEPTACION
'                            If oprea = "A" Or oprea = "D" Then
'                                If modore = "N" Then
'                                    If i >= mesnoc And i < nmrea Then
'                                        sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * pension
'                                    End If
'                                Else
'                                    If modore = "P" Then
'                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py * Porret / tmtce ^ i) * pension
'                                    End If
'                                End If
'                            Else
'                                If modore = "N" Then
'                                    sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * pension
'                                    sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * pension
'                                    sumapx = sumapxc + sumapxr
'                                Else
'                                    If modore = "P" Then
'                                        sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * pension
'                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                        sumapx = sumapx + (py / tmtce ^ i) * pension
'                                    End If
'                                End If
'                            End If
'                        Else
'                            If Nciare = 0 Then
                                sumapxr = sumapxr + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
                                sumapx = sumapx + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
'                            End If
'                        End If
                    Next i
                    Factor = sumapx / Pension
                    factorr = sumapxr / Pension
                    factorc = sumapxc / Pension
                    Rmben = sumapx
                    RmbenR = sumapxr
                    RmbenC = sumapxc
                    rmb1 = sumapx
                    rmb1r = sumapxr
                    rmb1c = sumapxc
                    
'                Else
'                    'BENEFICIARIOS PENSION VITALICIA
'                    If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
'                        edhm = fgEdad(Fechap, idp, Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
'                        limite1 = Fintab - edabe - 1
'                        pension = Penben(j)
'                        For i = 0 To limite1
'                            imas1 = i + 1
'                            edalbe = edabe + i
'                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                            If i < nmdiga And nrel = 2 Then py = 1
'                            If i < perdif Then py = 0
'                            If i > nmdiga Then pension = penbase * Porcbe(j)
''                            If Nciare > 0 Then
''                                'ACEPTACION
''                                If oprea = "A" Or oprea = "D" Then
''                                    If modore = "N" Then
''                                        If i >= mesnoc And i < nmrea Then
''                                            sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * pension
''                                            sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * pension
''                                        End If
''                                    Else
''                                        If modore = "P" Then
''                                            sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
''                                            sumapx = sumapx + (py * Porret / tmtce ^ i) * pension
''                                        End If
''                                    End If
''                                Else
''                                    If modore = "N" Then
''                                        sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * pension
''                                        sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * pension
''                                        sumapx = sumapxc + sumapxr
''                                    Else
''                                        If modore = "P" Then
''                                            sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * pension
''                                            sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
''                                            sumapx = sumapx + (py / tmtce ^ i) * pension
''                                        End If
''                                    End If
''                                End If
''                            Else
''                                If Nciare = 0 Then
'                                    sumapxr = sumapxr + (py / tmtce ^ i) * pension * facgratif(imas1) * iMtoFacPenElla
'                                    sumapx = sumapx + (py / tmtce ^ i) * pension * facgratif(imas1) * iMtoFacPenElla
''                                End If
''                            End If
'                        Next i
'                        factor = sumapx / pension
'                        factorr = sumapxr / pension
'                        factorc = sumapxc / pension
'                        rmb1 = sumapx
'                        rmb1r = sumapxr
'                        rmb1c = sumapxc
'                        Rmben = sumapx
'                        RmbenR = sumapxr
'                        RmbenC = sumapxc
                        'DERECHO A ACRECER DE PENSIONES VITALICIAS
                        If (Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or Ncorbe(j) = 11 Or Ncorbe(j) = 21) And iPolDerCre <> "N" Then
                            If edhm > L24 Then
                                mdif = 0
                            Else
                                If edhm >= L18 Then
                                    mdif = L24 - edhm
                                Else
                                    mdif = L21 - edhm
                                End If
                            End If
                            nmdif = mdif
                            If Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 15 Then
                                nmdif = fgMaximo(mdif, nmdiga)
                            End If
                            sumapx = 0
                            sumapxr = 0
                            sumapxc = 0
                            Ecadif = edabe + nmdif
                            limite1 = Fintab - Ecadif - 1
                            Pension = Penben(j) * 0.2
                            If Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 15 Then
                                If nmdiga > 0 Then Pension = 0
                            End If
                            For i = 0 To limite1
                                imas1 = nmdifi + i + 1
                                edcadi = Ecadif + i
                                py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
                                nmdifi = nmdif + i
                                If nmdifi < nmdiga And nrel = 2 Then py = 1
                                If nmdifi < perdif Then py = 0
                                If nmdifi >= nmdiga Then Pension = penbase * Porcbe(j) * 0.2
'                                If Nciare > 0 Then
'                                    'ACEPTACION
'                                    If oprea = "A" Or oprea = "D" Then
'                                        If modore = "N" Then
'                                            If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ nmdifi) * pension
'                                                sumapx = sumapx + (py * FactorPorRet / tmtce ^ nmdifi) * pension
'                                            End If
'                                        Else
'                                            If modore = "P" Then
'                                                sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * pension
'                                                sumapx = sumapx + (py * Porret / tmtce ^ nmdifi) * pension
'                                            End If
'                                        End If
'                                    Else
'                                        If modore = "N" Then
'                                            sumapxr = sumapxr + (py * FacReaseg(nmdifi) / TmTcr ^ nmdifi) * pension
'                                            sumapxc = sumapxc + (py * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi) * pension
'                                            sumapx = sumapxc + sumapxr
'                                        Else
'                                            If modore = "P" Then
'                                                sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ nmdifi) * pension
'                                                sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * pension
'                                                sumapx = sumapx + (py / tmtce ^ nmdifi) * pension
'                                            End If
'                                        End If
'                                    End If
'                                Else
'                                    If Nciare = 0 Then
                                        sumapxr = sumapxr + (py / tmtce ^ nmdifi) * Pension * facgratif(imas1) * iMtoFacPenElla
                                        sumapx = sumapx + (py / tmtce ^ nmdifi) * Pension * facgratif(imas1) * iMtoFacPenElla
'                                    End If
'                                End If
                            Next i
                            rmb2 = sumapx
                            rmb2r = sumapxr
                            rmb2c = sumapxc
                    
                            factoa = sumapx / Pension
                            factoar = sumapxr / Pension
                            factoac = sumapxc / Pension
                    
                            Rmben = rmb1 + rmb2
                            RmbenR = rmb1r + rmb2r
                            RmbenC = rmb1c + rmb2c
                        End If
                    Else
                        'RESERVA DE PENSIONES TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                        If edabe <= L18 Or (Mesgar > 0 And edabe > L18) Then 'GoTo 216
                            If Mesgar > 0 And edabe > L18 Then
                                mdif = Mesgar
                            Else
                                    mdif = fgMaximo(Mesgar, L18 - edabe)
                            End If
'                            If edabe < L24 Then
'                                If edabe >= L18 Then
'                                    mdif = L24 - edabe
'                                Else
'                                    mdif = L21 - edabe
'                                End If
                            nmdif = mdif - 1
                            If Cober = 3 Or Cober = 9 Or Cober = 10 Or _
                                Cober = 11 Or Cober = 12 Or Cober = 15 Then
                                nmdif = fgMaximo(mdif, nmdiga)
                                If nmdiga > 0 Then swg = "S"
                            End If
                            Pension = Penben(j)
                            For i = 0 To nmdif
                                imas1 = i + 1
                                edalbe = edabe + i
                                py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                If swg = "S" And i < nmdiga Then py = 1
                                If i < perdif Then py = 0
                                If i >= nmdiga Then Pension = penbase * Porcbe(j)
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If i >= mesnoc And i < nmrea Then
'                                                    sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * pension
'                                                    sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * pension
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                                    sumapx = sumapx + (py * Porret / tmtce ^ i) * pension
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * pension
'                                                sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * pension
'                                                sumapx = sumapxc + sumapxr
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * pension
'                                                    sumapxr = sumapxr + (py * Porret / tmtce ^ i) * pension
'                                                    sumapx = sumapx + (py / tmtce ^ i) * pension
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                sumapxr = sumapxr + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
                                sumapx = sumapx + (py / tmtce ^ i) * Pension * facgratif(imas1) * iMtoFacPenElla
'                                        End If
'                                    End If
                            Next i
                            Factor = sumapx / Pension
                            factorr = sumapxr / Pension
                            factorc = sumapxc / Pension

                            rmb1 = sumapx
                            rmb1r = sumapxr
                            rmb1c = sumapxc

                            Reser = sumapx
                            ReserR = sumapxr
                            ReserC = sumapxc
                            'RESERVA DE HIJOS INVALIDOS
                            If Coinbe(j) <> "N" Then
                                kdif = mdif
                                If Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 15 Then
                                    kdif = fgMaximo(mdif, nmdiga)
                                End If
                                edbedi = edabe + kdif
                                limite3 = Fintab - edbedi - 1
                                sumapx = 0
                                sumapxr = 0
                                sumapxc = 0
                                Pension = Penben(j)
'                                paso = 0.15
                                paso = Pension
                                For i = 0 To limite3
                                    edalbe = edbedi + i
                                    nmdifi = i + kdif
                                    imas1 = nmdifi + 1
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    If nmdifi < perdif Then py = 0
'                                    If Navig > 1990 Then paso = Porcbe(j)
'                                    If Navig = 1990 And Nmvig >= 8 Then paso = Porcbe(j)
                                    If nmdifi >= nmdiga Then Pension = penbase * paso
'                                        If Nciare > 0 Then
'                                            'ACEPTACION
'                                            If oprea = "A" Or oprea = "D" Then
'                                                If modore = "N" Then
'                                                    If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                        sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ nmdifi) * pension
'                                                        sumapx = sumapx + (py * FactorPorRet / tmtce ^ nmdifi) * pension
'                                                    End If
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * pension
'                                                        sumapx = sumapx + (py * Porret / tmtce ^ nmdifi) * pension
'                                                    End If
'                                                End If
'                                            Else
'                                                If modore = "N" Then
'                                                    sumapxc = sumapxc + (py * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi) * pension
'                                                    sumapxr = sumapxr + (py * FacReaseg(nmdifi) / TmTcr ^ nmdifi) * pension
'                                                    sumapx = sumapxc + sumapxr
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ nmdifi) * pension
'                                                        sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * pension
'                                                        sumapx = sumapx + (py / tmtce ^ nmdifi) * pension
'                                                    End If
'                                                End If
'                                            End If
'                                        Else
'                                            If Nciare = 0 Then
                                            sumapxr = sumapxr + (py / tmtce ^ nmdifi) * Pension * facgratif(imas1) * iMtoFacPenElla
                                            sumapx = sumapx + (py / tmtce ^ nmdifi) * Pension * facgratif(imas1) * iMtoFacPenElla
'                                            End If
'                                        End If
                                Next i
                                rmb2 = sumapx
                                rmb2r = sumapxr
                                rmb2c = sumapxc
                                factoa = sumapx / Pension
                                factoar = sumapxr / Pension
                                factoac = sumapxc / Pension
                                Rmben = rmb1 + rmb2
                                RmbenR = rmb1r + rmb2r
                                RmbenC = rmb1c + rmb2c
                            Else
                                If Coinbe(j) = "N" Then
                                    Rmben = rmb1
                                    RmbenR = rmb1r
                                    RmbenC = rmb1c
                                End If
                            End If
                        End If  'Fin    EDABE < L24
                    End If  'Fin ncorbe(j) >= 30 And ncorbe(j) < 40
                End If  'Fin    ncorbe(j) = 11 Or ncorbe(j) = 21
            End If  'Fin DERPEN(j) <> 10 and ncorbe(j) <>99
            RmBenT = RmbenR + RmbenC
            If Nciare = 0 Then
                Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                Else
                    Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                End If
            End If
            Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
            Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
    
            rmpol = rmpol + RmBenT
            RmpolR = RmpolR + RmbenR
            RmpolC = RmpolC + RmbenC
            'Ani - Daj
            ''Grabar los datos de los Beneficiarios calculados
            'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
            'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
            'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
            'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
            ''vgQuery = vgQuery & "mto_cnREND = " & Str(Format(RMBEN - RMBENC, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
            'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(Rmben, "#0.00")) & " "
            'vgQuery = vgQuery & "where "
            'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
            'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
            'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
            'vgConexionBD.Execute (vgQuery)
            If Nciare = 0 Then
                vlBenRet = vlBenRet + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    vlBenRet = vlBenRet + 1
                Else
                    vlBenCed = vlBenCed + 1
                End If
            End If
        Next j
        If Nciare = 0 Then
            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
        Else
            If oprea = "A" Or oprea = "D" Then
                Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
            Else
                Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
            End If
        End If
        NumPro = NumPro + 1
        If Nciare = 0 Then
            vlPolRet = vlPolRet + 1
        Else
            If oprea = "A" Or oprea = "D" Then
                vlPolRet = vlPolRet + 1
            Else
                vlPolCed = vlPolCed + 1
            End If
        End If
        
        'Ani - Daj
'        vlPolRet = vlPolRet + 1
        
        ''Grabar los Totales en la Póliza
        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
        'vgConexionBD.Execute (vgQuery)
        
        If (Vuelta = 1) Then
            vlReservaOriginal = Format(rmpol, "#0.00")
        Else
            vlReservaCalculada = Format(rmpol, "#0.00")
        End If
        
        Exit Function
    Else
        'RESERVA MATEMATICA PARA VEJEZ E INVALIDEZ
        If Alt = 3 Or Alt = 4 Then
            If topobe > 200 And Mesgar > 0 Then GoTo 1000
        End If
        For j = 1 To Nben
            'Definicion de pension del beneficiario
            'como pension de referencia por porcentaje de pension
            Penben(j) = penbase * Porcbe(j)
            RmBenT = 0: edabe = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            sumaqx = 0: Sumaqxr = 0: Sumaqxc = 0
            Rmcau = 0: RmcauC = 0: RmcauR = 0
            Cmcau = 0: CmcauR = 0: CmcauC = 0
            Factor = 0: factorr = 0: factorc = 0
            factoa = 0: factoar = 0: factoac = 0
            Rmben = 0: RmbenR = 0: RmbenC = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            Supxpy = 0: Supxpyr = 0: Supxpyc = 0
            rmb1 = 0: rmb1r = 0: rmb1c = 0
            rmb2 = 0: rmb2r = 0: rmb2c = 0
            If derpen(j) <> 10 Then
                Nubenp = Nubenp + 1
                'CALCULO DE LA RESERVA DEL AFILIADO
                If Ncorbe(j) = 99 And j = 1 Then
                    ni = 0
                    ni = fgCodInvalidez(Coinbe(j))
                    If ni = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    ns = 0
                    ns = fgSexo(Sexobe(j))
                    If ns = 0 Then
                        vgError = 1018
                        Exit Function
                    End If

                    'Calculo de edad del causante
                    edaca = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edaca <= 216 Then edaca = 216
                    If edaca > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    limite1 = Fintab - edaca - 1
                    For i = 0 To limite1
                        edacai = edaca + i
                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
                        If i < nmdiga Then px = 1
                        If i < perdif Then px = 0
                        edacas = edacai + 1
                        Qx = ((Lx(ns, ni, edacai) - Lx(ns, ni, edacas))) / Lx(ns, ni, edaca)
                        If i < perdif Then Qx = 0
'                        If Nciare > 0 Then
'                            'ACEPTACION
'                            If oprea = "A" Or oprea = "D" Then
'                                If modore = "N" Then
'                                    If i >= mesnoc And i < nmrea Then
'                                        sumapxr = (sumapxr + px * FactorPorRet / tmtce ^ i)
'                                        Sumaqxr = (Sumaqxr + Qx * FactorPorRet / tmtce ^ (0.5 + i))
'                                        sumapx = (sumapx + px * FactorPorRet / tmtce ^ i)
'                                        sumaqx = (sumaqx + Qx * FactorPorRet / tmtce ^ (0.5 + i))
'                                    End If
'                                Else
'                                    If modore = "P" Then
'                                        sumapxr = sumapxr + px * Porret / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px * Porret / tmtce ^ i
'                                        sumaqx = sumaqx + Qx * Porret / tmtce ^ (0.5 + i)
'                                    End If
'                                End If
'                            Else
'                                If modore = "N" Then
'                                    sumapxr = sumapxr + px * FacReaseg(i) / TmTcr ^ i
'                                    Sumaqxr = Sumaqxr + Qx * FacReaseg(i) / TmTcr ^ (0.5 + i)
'                                    sumapxc = sumapxc + px * (1 - FacReaseg(i)) / tmtce ^ i
'                                    Sumaqxc = Sumaqxc + Qx * (1 - FacReaseg(i)) / tmtce ^ (0.5 + i)
'                                    sumapx = sumapxc + sumapxr
'                                    sumaqx = Sumaqxc + Sumaqxr
'                                Else
'                                    If modore = "P" Then
'                                        sumapxc = sumapxc + px * (1 - Porret) / tmtce ^ i
'                                        Sumaqxc = Sumaqxc + Qx * (1 - Porret) / tmtce ^ (0.5 + i)
'                                        sumapxr = sumapxr + px * Porret / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px / tmtce ^ i
'                                        sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                                    End If
'                                End If
'                            End If
'                        Else
'                            If Nciare = 0 Then
                                sumapxr = sumapxr + px / tmtce ^ i
                                Sumaqxr = Sumaqxr + Qx / tmtce ^ (0.5 + i)
                                sumapx = sumapx + px / tmtce ^ i
                                sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                            End If
'                        End If
                    Next i
                    Cmcau = GtoFun * sumaqx
                    CmcauR = GtoFun * Sumaqxr
                    CmcauC = GtoFun * Sumaqxc
                    RmcauR = sumapxr * Penben(j) + CmcauR
                    RmcauC = sumapxc * Penben(j) + CmcauC
                    Rmcau = sumapx * Penben(j) + Cmcau
                    rmpol = Rmcau
                    RmpolR = RmcauR
                    RmpolC = RmcauC
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmcauR
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmcauC
                    RmBenT = RmcauR + RmcauC
                    If Nciare = 0 Then
                        vlPolRet = vlPolRet + 1
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlPolRet = vlPolRet + 1
                            vlBenRet = vlBenRet + 1
                        Else
                            vlPolCed = vlPolCed + 1
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                    'NUMOR(J),NCORBE(J),SEXOBE(J),COINBE(J),NANBE(J),NMNBE(J),EDACA,PENBEN(J),SUMAPX,CMCAU,RMCAU
                    'Ani - Daj
                    
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edaca, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format((sumapx + sumapx_g), "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(Cmcau, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmcauC, "#0.00")) & ", "
                    ''vgQuery = vgQuery & "mto_cnREND = " & Str(Format(Rmcau - RMCAUC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmcau, "#0.00")) - CDbl(Format(RmcauC, "#0.00"))) & ", "
                    ''vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(Rmcau, "#0.00")) & " "
                    'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(rmpol, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                Else
                    'RESERVA DE LOS BENEFICIARIOS
                    nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de la edad del beneficiario
                    edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or Ncorbe(j) = 20 Or Ncorbe(j) = 21 Or _
                        Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                        'RESERVA VIDAS CONJUNTAS VITALICIAS
                        'Probabilidad del beneficiario solo
                        limite1 = Fintab - edabe - 1
                        For i = 0 To limite1
                            imas1 = i + 1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            If i < nmdiga Then py = 0
                            If i < perdif Then py = 0
'                            If Nciare > 0 Then
'                                'ACEPTACION
'                                If oprea = "A" Or oprea = "D" Then
'                                    If modore = "N" Then
'                                        If i >= mesnoc And i < nmrea Then
'                                            sumapxr = (sumapxr + py * FactorPorRet / tmtce ^ i)
'                                            sumapx = (sumapx + py * FactorPorRet / tmtce ^ i)
'                                        End If
'                                    Else
'                                        If modore = "P" Then
'                                            sumapxr = sumapxr + py * Porret / tmtce ^ i
'                                            sumapx = sumapx + py * Porret / tmtce ^ i
'                                        End If
'                                    End If
'                                Else
'                                    If modore = "N" Then
'                                        sumapxr = sumapxr + py * FacReaseg(i) / TmTcr ^ i
'                                        sumapxc = sumapxc + py * (1 - FacReaseg(i)) / tmtce ^ i
'                                        sumapx = sumapxc + sumapxr
'                                    Else
'                                        If modore = "P" Then
'                                            sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ i
'                                            sumapxr = sumapxr + py * Porret / tmtce ^ i
'                                            sumapx = sumapxc + sumapxr
'                                        End If
'                                    End If
'                                End If
'                            Else
'                                If Nciare = 0 Then
                                    sumapxr = sumapxr + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                    sumapx = sumapx + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                End If
'                            End If
                        Next i
                        'Probabilidad conjunta de causante y beneficiario
                        limite2 = Fintab - edaca - 1
                        limite = fgMinimo(limite1, limite2)
                        For i = 0 To limite
                            imas1 = i + 1
                            edalca = edaca + i
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                            If i < nmdiga Then py = 0
                            If i < perdif Then py = 0
'                            If Nciare > 0 Then
'                                'ACEPTACION
'                                If oprea = "A" Or oprea = "D" Then
'                                    If modore = "N" Then
'                                        If i >= mesnoc And i < nmrea Then
'                                            Supxpyr = (Supxpyr + (py * px * FactorPorRet) / tmtce ^ i)
'                                            Supxpy = (Supxpy + (py * px * FactorPorRet) / tmtce ^ i)
'                                        End If
'                                    Else
'                                        If modore = "P" Then
'                                            Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
'                                            Supxpy = Supxpy + (py * px) * Porret / tmtce ^ i
'                                        End If
'                                    End If
'                                Else
'                                    If modore = "N" Then
'                                        Supxpyr = Supxpyr + (py * px) * FacReaseg(i) / TmTcr ^ i
'                                        Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(i)) / tmtce ^ i
'                                        Supxpy = Supxpyr + Supxpyc
'                                    Else
'                                        If modore = "P" Then
'                                            Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ i
'                                            Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
'                                            Supxpy = Supxpy + (py * px) / tmtce ^ i
'                                        End If
'                                    End If
'                                End If
'                            Else
'                                If Nciare = 0 Then
                                    Supxpyr = Supxpyr + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                    Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                End If
'                            End If
                        Next i
                        Factor = sumapx - Supxpy
                        factorr = sumapxr - Supxpyr
                        factorc = sumapxc - Supxpyc
                        rmb1 = Factor * Penben(j)
                        rmb1r = factorr * Penben(j)
                        rmb1c = factorc * Penben(j)
                        Rmben = rmb1
                        RmbenR = rmb1r
                        RmbenC = rmb1c
                        'If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
                        'iPolDerCre = ""
                        If (Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or Ncorbe(j) = 11 Or Ncorbe(j) = 21) And (iPolDerCre <> "N" And iPolDerCre <> "") Then
                            'RESERVA POR DERECHO A ACRECER
                            edhm = fgEdad(Fechap, CInt(Ndp), Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
'                           If Codcbe(j) <> "N" Then
                            If edhm > L24 Then
                                nmdif = 0
                            Else
                                If edhm >= L18 Then
                                    nmdif = L24 - edhm
                                Else
                                    nmdif = L21 - edhm
                                End If
                            End If
                            Ebedif = edabe + nmdif
                            sumapx = 0: sumapxr = 0: sumapxc = 0
                            Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                            'Probabilidad del beneficiario solo
                            limite1 = Fintab - Ebedif - 1
                            For i = 0 To limite1
                                imas1 = nmdif + i + 1
                                edcadi = Ebedif + i
                                py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
                                inmdif = i + nmdif
                                If inmdif < nmdiga Then py = 0
                                If inmdif < perdif Then py = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If inmdif >= mesnoc And inmdif < nmrea Then
'                                                    sumapxr = (sumapxr + py * FactorPorRet / tmtce ^ inmdif)
'                                                    sumapx = (sumapx + py * FactorPorRet / tmtce ^ inmdif)
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + py * Porret / tmtce ^ inmdif
'                                                    sumapx = sumapx + py * Porret / tmtce ^ inmdif
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + py * FacReaseg(inmdif) / TmTcr ^ inmdif
'                                                sumapxc = sumapxc + py * (1 - FacReaseg(inmdif)) / tmtce ^ inmdif
'                                                sumapx = sumapxr + sumapxc
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ inmdif
'                                                    sumapxr = sumapxr + py * Porret / tmtce ^ inmdif
'                                                    sumapx = sumapx + py / tmtce ^ inmdif
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                        sumapxr = sumapxr + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ inmdif
                                        sumapx = sumapx + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ inmdif
'                                        End If
'                                    End If
                            Next i
                            'Probabilidad conjunta del causante y beneficiario
                            Ecadif = edaca + nmdif
                            limite4 = Fintab - Ecadif - 1
                            limite = fgMinimo(limite1, limite4)
                            For i = 0 To limite
                                imas1 = nmdif + i + 1
                                edalca = Ecadif + i
                                edalbe = Ebedif + i
                                nmdifi = nmdif + i
                                py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                If nmdifi < nmdiga Then py = 0
                                If nmdifi < perdif Then py = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                    Supxpyr = Supxpyr + (py * px * FactorPorRet) / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py * px * FactorPorRet) / (tmtce ^ nmdifi)
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py * px) * Porret / (tmtce ^ nmdifi)
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                Supxpyr = Supxpyr + (py * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                Supxpy = Supxpyr + Supxpyc
'                                            Else
'                                                If modore = "P" Then
'                                                    Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ nmdifi
'                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
'                                                End If
'                                            End If
'                                        End If
'                                    Else
                                Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
                                Supxpyr = Supxpyr + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
'                                        End If
'                                    End If
                            Next i
                            vipen = 0.2 * Penben(j)
                            factoa = sumapx - Supxpy
                            factoar = sumapxr - Supxpyr
                            factoac = sumapxc - Supxpyc
                            rmb2 = factoa * vipen
                            rmb2r = factoar * vipen
                            rmb2c = factoac * vipen
                            Rmben = rmb1 + rmb2
                            RmbenR = rmb1r + rmb2r
                            RmbenC = rmb1c + rmb2c
'                            End If  'Fin Codcbe(j) <> "N"
                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
                    Else
                        'RESERVA RENTAS TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe <= L18 Or (edabe > L18 And Mesgar > 0) Then 'GoTo 206
'                            If edabe < L24 Then
                                If edabe >= L18 Then
                                    mdif = L24 - edabe
                                Else
                                    mdif = L21 - edabe
                                End If
                                nmdif = mdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad conjunta del causante y beneficiario
                                limite2 = Fintab - edaca
                                limite = fgMinimo(nmdif, limite2) - 1
                                For i = 0 To limite
                                    imas1 = i + 1
                                    edalca = edaca + i
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If i < nmdiga Then py = 0
                                    If i < perdif Then py = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If i >= mesnoc And i < nmrea Then
'                                                    sumapxr = sumapxr + py * FactorPorRet / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py * px * FactorPorRet) / tmtce ^ i
'                                                    sumapx = sumapx + py * FactorPorRet / tmtce ^ i
'                                                    Supxpy = Supxpy + (py * px * FactorPorRet) / (tmtce ^ i)
'
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + py * Porret / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
'                                                    sumapx = sumapx + py * Porret / tmtce ^ i
'                                                    Supxpy = Supxpy + (py * px) * Porret / (tmtce ^ i)
'
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + py * FacReaseg(i) / TmTcr ^ i
'                                                Supxpyr = Supxpyr + (py * px) * FacReaseg(i) / TmTcr ^ i
'                                                sumapxc = sumapxc + py * (1 - FacReaseg(i)) / tmtce ^ i
'                                                Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(i)) / tmtce ^ i
'                                                sumapx = sumapxr + sumapxc
'                                                Supxpy = Supxpyr + Supxpyc
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ i
'                                                    Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ i
'                                                    sumapxr = sumapxr + py * Porret / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
'                                                    sumapx = sumapx + py / tmtce ^ i
'                                                    Supxpy = Supxpy + (py * px) / (tmtce ^ i)
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            Supxpyr = Supxpyr + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            sumapx = sumapx + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ i)
'                                        End If
'                                    End If
                                Next i
                                Factor = sumapx - Supxpy
                                factorr = sumapxr - Supxpyr
                                factorc = sumapxc - Supxpyc
                                rmb1 = Factor * Penben(j)
                                rmb1r = factorr * Penben(j)
                                rmb1c = factorc * Penben(j)
                                'RESERVA DEL HIJO INVALIDO
                                If Coinbe(j) <> "N" Then
                                    sumapx = 0: sumapxr = 0: sumapxc = 0
                                    Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                    'Probabilidad conjunta del causante y beneficiario
                                    edbedi = edabe + nmdif
                                    limite3 = Fintab - edbedi - 1
                                    limite4 = Fintab - (edaca + nmdif) - 1
                                    For i = 0 To limite3
                                        nmdifi = nmdif + i
                                        imas1 = nmdifi + 1
                                        edalca = edaca + nmdif + i
                                        edalbe = edbedi + i
                                        edalca = fgMinimo(edalca, Fintab)
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                        If nmdifi < nmdiga Then py = 0
                                        If nmdifi < perdif Then py = 0
'                                        If Nciare > 0 Then
'                                            'ACEPTACION
'                                            If oprea = "A" Or oprea = "D" Then
'                                                If modore = "N" Then
'                                                    If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                        sumapxr = sumapxr + py * FactorPorRet / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py * px * FactorPorRet) / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py * FactorPorRet / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py * px * FactorPorRet) / (tmtce ^ nmdifi)
'                                                    End If
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxr = sumapxr + py * Porret / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py * Porret / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py * px) * Porret / (tmtce ^ nmdifi)
'                                                    End If
'                                                End If
'                                            Else
'                                                If modore = "N" Then
'                                                    sumapxr = sumapxr + py * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                    Supxpyr = Supxpyr + (py * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                    sumapxc = sumapxc + py * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                    Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                    sumapx = sumapxr + sumapxc
'                                                    Supxpy = Supxpyr + Supxpyc
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ nmdifi
'                                                        Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ nmdifi
'                                                        sumapxr = sumapxr + py * Porret / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
'                                                    End If
'                                                End If
'                                            End If
'                                        Else
'                                            If Nciare = 0 Then
                                        sumapxr = sumapxr + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                        Supxpyr = Supxpyr + (py * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                        sumapx = sumapx + py * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                        Supxpy = Supxpy + (py * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
'                                            End If
'                                        End If
                                    Next i
                                    factoa = sumapx - Supxpy
                                    factoar = sumapxr - Supxpyr
                                    factoac = sumapxc - Supxpyc
                                    vipen = penbase * 0.15
'                                    If Navig = 1990 And Nmvig >= 8 Then vipen = Penben(j)
'                                    If Navig > 1990 Then vipen = Penben(j)
                                    Rmben = rmb1 + factoa * vipen
                                    RmbenR = rmb1r + factoar * vipen
                                    RmbenC = rmb1c + factoac * vipen
                                Else
                                    If Coinbe(j) = "N" Then
                                        Rmben = rmb1
                                        RmbenR = rmb1r
                                        RmbenC = rmb1c
                                    End If
                                End If  'Fin    coinbe(j) <> "N"
                            End If  'Fin    Edabe < L24
                        End If  'Fin    ncorbe(j) >= 30 And ncorbe(j) < 40
                    End If  'Fin ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
                    rmpol = rmpol + Rmben
                    RmpolR = RmpolR + RmbenR
                    RmpolC = RmpolC + RmbenC
                    RmBenT = RmbenR + RmbenC
                    'Ani - Dani
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                    If Nciare = 0 Then
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlBenRet = vlBenRet + 1
                        Else
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                End If  'Fin Ncorbe(j) = 99 And j = 1
            End If  'Fin
        Next j
        NumPro = NumPro + 1
        'Ani - Dani
            
        ''Grabar los Totales en la Póliza
        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
        'vgConexionBD.Execute (vgQuery)
        
        If (Vuelta = 1) Then
            vlReservaOriginal = Format(rmpol, "#0.00")
        Else
            vlReservaCalculada = Format(rmpol, "#0.00")
        End If
        
        Exit Function
        'PORCENTAJE MAYOR AL 100%
1000:
        For ib = 1 To Fintab
            flumax(ib) = 0
        Next ib
        'FLUJOS DE RENTAS VITALICIAS DE VEJEZ E INVALIDEZ
        For j = 1 To Nben
            If derpen(j) <> 10 Then
                Penben(j) = penbase * Porcbe(j)
                Nbpr = Nbpr + 1
                'CALCULO DE LA RESERVA DEL AFILIADO
                If Ncorbe(j) = 99 And j = 1 Then
                    ni = 0
                    ni = fgCodInvalidez(Coinbe(j))
                    If ni = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    ns = 0
                    ns = fgSexo(Sexobe(j))
                    If ns = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de edad del causante
                    edaca = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edaca <= 216 Then edaca = 216
                    If edaca > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    limite1 = Fintab - edaca - 1
                    For i = 0 To limite1
                        imas1 = i + 1
                        edacai = edaca + i
                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
                        edacas = edacai + 1
                        flumax(imas1) = flumax(imas1) + (px * Penben(j))
                    Next i
                Else
                    'RESERVA DE LOS BENEFICIARIOS
                    nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de la edad del beneficiario
                    edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or Ncorbe(j) = 20 Or Ncorbe(j) = 21 Or _
                        Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                        'FLUJOS DE VIDAS CONJUNTAS VITALICIAS
                        'Probabilidad del beneficiario solo
                        limite1 = Fintab - edabe - 1
                        For i = 0 To limite1
                            imas1 = i + 1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            flumax(imas1) = flumax(imas1) + (py * Penben(j) * facgratif(imas1) * iMtoFacPenElla)
                        Next i
                        'Probabilidad conjunta de causante y beneficiario
                        limite2 = Fintab - edaca - 1
                        limite = fgMinimo(limite1, limite2)
                        For i = 0 To limite
                            imas1 = i + 1
                            edalca = edaca + i
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                            flumax(imas1) = flumax(imas1) - (py * px * Penben(j) * facgratif(imas1) * iMtoFacPenElla)
                        Next i
                        If (Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or Ncorbe(j) = 11 Or Ncorbe(j) = 21) And iPolDerCre <> "N" Then
                            'FLUJO POR DERECHO A ACRECER
                            edhm = fgEdad(Fechap, CInt(Ndp), Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
                            If Codcbe(j) <> "N" Then
                                If edhm > L24 Then
                                    nmdif = 0
                                Else
                                    If edhm >= L18 Then
                                        nmdif = L24 - edhm
                                    Else
                                        nmdif = L21 - edhm
                                    End If
                                End If
                                Ebedif = edabe + nmdif
                                'Probabilidad del beneficiario solo
                                limite1 = Fintab - Ebedif - 1
                                For i = 0 To limite1
                                    edalbe = Ebedif + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    nmdifi = nmdif + i
                                    imas1 = nmdifi + 1
                                    flumax(imas1) = flumax(imas1) + (py * Penben(j) * 0.2 * facgratif(imas1) * iMtoFacPenElla)
                                Next i
                                'Probabilidad conjunta del causante y beneficiario
                                Ecadif = edaca + nmdif
                                limite4 = Fintab - Ecadif - 1
                                limite = fgMinimo(limite1, limite4)
                                For i = 0 To limite
                                    edalca = Ecadif + i
                                    edalbe = Ebedif + i
                                    nmdifi = nmdif + i
                                    imas1 = nmdifi + 1
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    flumax(imas1) = flumax(imas1) - (py * px * Penben(j) * 0.2 * facgratif(imas1) * iMtoFacPenElla)
                                Next i
                            End If  'Fin    codcbe(j) <> "N"
                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
                    Else
                        'RESERVA RENTAS TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe <= L18 Or (edabe > L18 And Mesgar > 0) Then 'GoTo 206
'                            If edabe < L24 Then
                                If edabe >= L18 Then
                                    mdif = L24 - edabe
                                Else
                                    mdif = L21 - edabe
                                End If
                                nmdif = mdif
                                'Probabilidad conjunta del causante y beneficiario
                                limite2 = Fintab - edaca
                                limite = fgMinimo(nmdif, limite2) - 1
                                For i = 0 To limite
                                    imas1 = i + 1
                                    edalca = edaca + i
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    flumax(imas1) = flumax(imas1) + (py - py * px) * Penben(j) * facgratif(imas1) * iMtoFacPenElla
                                Next i
                                'RESERVA DEL HIJO INVALIDO
                                If Coinbe(j) <> "N" Then
                                    'Probabilidad conjunta del causante y beneficiario
                                    edbedi = edabe + nmdif
                                    limite3 = Fintab - edbedi - 1
                                    limite4 = Fintab - (edaca + nmdif) - 1
                                    For i = 0 To limite3
                                        nmdifi = nmdif + i
                                        imas1 = nmdifi + 1
                                        edalca = edaca + nmdif + i
                                        edalbe = edbedi + i
                                        edalca = fgMinimo(edalca, Fintab)
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                        vipen = penbase * 0.15
'                                        If Navig = 1990 And Nmvig >= 8 Then vipen = penbase * Porcbe(j)
'                                        If Navig > 1990 Then vipen = penbase * Porcbe(j)
                                        flumax(imas1) = flumax(imas1) + (py - py * px) * vipen * facgratif(imas1) * iMtoFacPenElla
                                    Next i
                                End If  'Fin    coinbe(j) <> "N"
                            End If  'Fin    Edabe < L24
                        End If  'Fin    (ncorbe(j) >= 30 And ncorbe(j) < 40)
                    End If  'Fin    ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or
                End If  'Fin    ncorbe(j) = 99 And j = 1
            End If  'fIN DERECHO A PENSION
        Next j
        If topobe > 200 Then
            For ll = 1 To nmdiga
                If (penbase > flumax(ll)) Then GoTo 1003
            Next ll
1003:       limgar = ll
        End If
        
        'CALCULO DE RESERVA BASE A POLIZAS CON PORCENTAJE MAYOR AL 100%
        'RESERVA MATEMATICA PARA VEJEZ E INVALIDEZ
        For j = 1 To Nben
            Penben(j) = penbase * Porcbe(j)
            edabe = 0: RmBenT = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            sumaqx = 0: Sumaqxr = 0: Sumaqxc = 0
            Rmcau = 0: RmcauC = 0: RmcauR = 0
            Cmcau = 0: CmcauR = 0: CmcauC = 0
            Factor = 0: factorr = 0: factorc = 0
            factoa = 0: factoar = 0: factoac = 0
            Rmben = 0: RmbenR = 0: RmbenC = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            Supxpy = 0: Supxpyr = 0: Supxpyc = 0
            rmb1 = 0: rmb1r = 0: rmb1c = 0
            rmb2 = 0: rmb2r = 0: rmb2c = 0
            If derpen(j) <> 10 Then
                Nubenp = Nubenp + 1
                'CALCULO DE LA RESERVA DEL AFILIADO
                If Ncorbe(j) = 99 And j = 1 Then
                    ni = 0
                    ni = fgCodInvalidez(Coinbe(j))
                    If ni = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    ns = 0
                    ns = fgSexo(Sexobe(j))
                    If ns = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de edad del causante
                    edaca = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edaca <= 216 Then edaca = 216
                    If edaca > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    limite1 = Fintab - edaca - 1
                    For i = 0 To limite1
                        edacai = edaca + i
                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
                        If i < limgar Then
                            px1 = px
                        Else
                            If i >= limgar And i < nmdiga Then
                                px1 = 1
                            Else
                                px1 = px
                            End If
                        End If
                        If i < perdif Then px1 = 0
                        edacas = edacai + 1
                        Qx = ((Lx(ns, ni, edacai) - Lx(ns, ni, edacas))) / Lx(ns, ni, edaca)
                        If i < perdif Then Qx = 0
'                        If Nciare > 0 Then
'                            'ACEPTACION
'                            If oprea = "A" Or oprea = "D" Then
'                                If modore = "N" Then
'                                    If i >= mesnoc And i < nmrea Then
'                                        sumapxr = sumapxr + px1 * FactorPorRet / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * FactorPorRet / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px1 * FactorPorRet / tmtce ^ i
'                                        sumaqx = sumaqx + Qx * FactorPorRet / tmtce ^ (0.5 + i)
'                                    End If
'                                Else
'                                    If modore = "P" Then
'                                        sumapxr = sumapxr + px1 * Porret / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px1 * Porret / tmtce ^ i
'                                        sumaqx = sumaqx + Qx * Porret / tmtce ^ (0.5 + i)
'                                    End If
'                                End If
'                            Else
'                                If modore = "N" Then
'                                    sumapxr = sumapxr + px1 * FacReaseg(i) / TmTcr ^ i
'                                    Sumaqxr = Sumaqxr + Qx * FacReaseg(i) / TmTcr ^ (0.5 + i)
'                                    sumapxc = sumapxc + px1 * (1 - FacReaseg(i)) / tmtce ^ i
'                                    Sumaqxc = Sumaqxc + Qx * (1 - FacReaseg(i)) / tmtce ^ (0.5 + i)
'                                    sumapx = sumapxr + sumapxc
'                                    sumaqx = Sumaqxr + Sumaqxc
'                                Else
'                                    If modore = "P" Then
'                                        sumapxc = sumapxc + px1 * (1 - Porret) / tmtce ^ i
'                                        Sumaqxc = Sumaqxc + Qx * (1 - Porret) / tmtce ^ (0.5 + i)
'                                        sumapxr = sumapxr + px1 * Porret / tmtce ^ i
'                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
'                                        sumapx = sumapx + px1 / tmtce ^ i
'                                        sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                                    End If
'                                End If
'                            End If
'                        Else
'                            If Nciare = 0 Then
                                sumapxr = sumapxr + px1 / tmtce ^ i
                                Sumaqxr = Sumaqxr + Qx / tmtce ^ (0.5 + i)
                                sumapx = sumapx + px1 / tmtce ^ i
                                sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                            End If
'                        End If
                    Next i
                    Cmcau = GtoFun * sumaqx
                    CmcauR = GtoFun * Sumaqxr
                    CmcauC = GtoFun * Sumaqxc
                    RmcauR = sumapxr * Penben(j) + CmcauR
                    RmcauC = sumapxc * Penben(j) + CmcauC
                    Rmcau = sumapx * Penben(j) + Cmcau
                    rmpol = Rmcau
                    RmpolR = RmcauR
                    RmpolC = RmcauC
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmcauR
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmcauC
                    RmBenT = RmcauR + RmcauC
                    If Nciare = 0 Then
                        vlPolRet = vlPolRet + 1
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlPolRet = vlPolRet + 1
                            vlBenRet = vlBenRet + 1
                        Else
                            vlPolCed = vlPolCed + 1
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                Else
                    'RESERVA DE LOS BENEFICIARIOS
                    nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de la edad del beneficiario
                    edabe = fgEdad(Fechap, CInt(Ndp), Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or _
                        Ncorbe(j) = 20 Or Ncorbe(j) = 21 Or _
                        Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                        'RESERVA VIDAS CONJUNTAS VITALICIAS
                        'Probabilidad del beneficiario solo
                        limite1 = Fintab - edabe - 1
                        For i = 0 To limite1
                            imas1 = i + 1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            If i < limgar Then
                              py1 = py
                            Else
                                If (i >= limgar And i < nmdiga) Then
                                    py1 = 0
                                Else
                                    py1 = py
                                End If
                            End If
                            If i < perdif Then py1 = 0
'                            If Nciare > 0 Then
'                                'ACEPTACION
'                                If oprea = "A" Or oprea = "D" Then
'                                    If modore = "N" Then
'                                        If i >= mesnoc And i < nmrea Then
'                                            sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ i
'                                            sumapx = sumapx + py1 * FactorPorRet / tmtce ^ i
'                                        End If
'                                    Else
'                                        If modore = "P" Then
'                                            sumapxr = sumapxr + py1 * Porret / tmtce ^ i
'                                            sumapx = sumapx + py1 * Porret / tmtce ^ i
'                                        End If
'                                    End If
'                                Else
'                                    If modore = "N" Then
'                                        sumapxr = sumapxr + py1 * FacReaseg(i) / TmTcr ^ i
'                                        sumapxc = sumapxc + py1 * (1 - FacReaseg(i)) / tmtce ^ i
'                                        sumapx = sumapxr + sumapxc
'                                    Else
'                                        If modore = "P" Then
'                                            sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ i
'                                            sumapxr = sumapxr + py1 * Porret / tmtce ^ i
'                                            sumapx = sumapx + py1 / tmtce ^ i
'                                        End If
'                                    End If
'                                End If
'                            Else
'                                If Nciare = 0 Then
                                    sumapxr = sumapxr + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                    sumapx = sumapx + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                End If
'                            End If
                        Next i
                        'Probabilidad conjunta de causante y beneficiario
                        limite2 = Fintab - edaca - 1
                        limite = fgMinimo(limite1, limite2)
                        For i = 0 To limite
                            imas1 = i + 1
                            edalca = edaca + i
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                    
                            If i < limgar Then
                                py1 = py
                            Else
                                If i >= limgar And i < nmdiga Then
                                    py1 = 0
                                Else
                                    py1 = py
                                End If
                            End If
                            If i < perdif Then py1 = 0
'                            If Nciare > 0 Then
'                                'ACEPTACION
'                                If oprea = "A" Or oprea = "D" Then
'                                    If modore = "N" Then
'                                        If i >= mesnoc And i < nmrea Then
'                                            Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ i
'                                            Supxpy = Supxpy + (py1 * px * FactorPorRet) / tmtce ^ i
'                                        End If
'                                    Else
'                                        If modore = "P" Then
'                                            Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
'                                            Supxpy = Supxpy + (py1 * px) * Porret / tmtce ^ i
'                                        End If
'                                    End If
'                                Else
'                                    If modore = "N" Then
'                                        Supxpyr = Supxpyr + (py1 * px) * FacReaseg(i) / TmTcr ^ i
'                                        Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(i)) / tmtce ^ i
'                                        Supxpy = Supxpyr + Supxpyc
'                                    Else
'                                        If modore = "P" Then
'                                            Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ i
'                                            Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
'                                            Supxpy = Supxpy + (py1 * px) / tmtce ^ i
'                                        End If
'                                    End If
'                                End If
'                            Else
'                                If Nciare = 0 Then
                                    Supxpyr = Supxpyr + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                    Supxpy = Supxpy + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                End If
'                            End If
                        Next i
                        Factor = sumapx - Supxpy
                        factorr = sumapxr - Supxpyr
                        factorc = sumapxc - Supxpyc
                        rmb1 = Factor * Penben(j)
                        rmb1r = factorr * Penben(j)
                        rmb1c = factorc * Penben(j)
                        Rmben = rmb1: RmbenR = rmb1r: RmbenC = rmb1c
                        'RESERVA POR DERECHO A ACRECER
                        'If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
                        If (Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or Ncorbe(j) = 11 Or Ncorbe(j) = 21) And iPolDerCre <> "N" Then
                            edhm = fgEdad(Fechap, CInt(Ndp), Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
                            If Codcbe(j) <> "N" Then
                                If edhm > L24 Then
                                    nmdif = 0
                                Else
                                    If edhm >= L18 Then
                                        nmdif = L24 - edhm
                                    Else
                                        nmdif = L21 - edhm
                                    End If
                                End If
                                Ebedif = edabe + nmdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad del beneficiario solo
                                limite1 = Fintab - Ebedif - 1
                                For i = 0 To limite1
                                    edcadi = Ebedif + i
                                    py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
                                    inmdif = i + nmdif
                                    If inmdif < limgar Then
                                        py1 = py
                                    Else
                                        If inmdif >= limgar And inmdif < nmdiga Then
                                            py1 = 0
                                        Else
                                            py1 = py
                                        End If
                                    End If
                                    If inmdif < perdif Then py1 = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If inmdif >= mesnoc And inmdif < nmrea Then
'                                                    sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ inmdif
'                                                    sumapx = sumapx + py1 * FactorPorRet / tmtce ^ inmdif
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ inmdif
'                                                    sumapx = sumapx + py1 * Porret / tmtce ^ inmdif
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + py1 * FacReaseg(inmdif) / TmTcr ^ inmdif
'                                                sumapxc = sumapxc + py1 * (1 - FacReaseg(inmdif)) / tmtce ^ inmdif
'                                                sumapx = sumapxc + sumapxr
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ inmdif
'                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ inmdif
'                                                    sumapx = sumapx + py1 / tmtce ^ inmdif
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ inmdif
                                            sumapx = sumapx + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ inmdif
'                                        End If
'                                    End If
                                Next i
                                'Probabilidad conjunta del causante y beneficiario
                                Ecadif = edaca + nmdif
                                limite4 = Fintab - Ecadif - 1
                                limite = fgMinimo(limite1, limite4)
                                For i = 0 To limite
                                    edalca = Ecadif + i
                                    edalbe = Ebedif + i
                                    nmdifi = nmdif + i
                                    imas1 = imdifi + 1
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If nmdifi < limgar Then
                                        py1 = py
                                    Else
                                        If nmdifi >= limgar And nmdifi < nmdiga Then
                                            py1 = 0
                                        Else
                                            py1 = py
                                        End If
                                    End If
                                    If nmdifi < perdif Then py1 = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                    Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py1 * px * FactorPorRet) / (tmtce ^ nmdifi)
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py1 * px) * Porret / (tmtce ^ nmdifi)
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                Supxpyr = Supxpyr + (py1 * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                Supxpy = Supxpyr + Supxpyc
'                                            Else
'                                                If modore = "P" Then
'                                                    Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ nmdifi
'                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
'                                                    Supxpy = Supxpy + (py1 * px) / tmtce ^ nmdifi
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                            Supxpyr = Supxpyr + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                            Supxpy = Supxpy + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
'                                        End If
'                                    End If
                                Next i
                                vipen = 0.2 * Penben(j)
                                factoa = sumapx - Supxpy
                                factoar = sumapxr - Supxpyr
                                factoac = sumapxc - Supxpyc
                                rmb2 = factoa * vipen
                                rmb2r = factoar * vipen
                                rmb2c = factoac * vipen
                                Rmben = rmb1 + rmb2
                                RmbenR = rmb1r + rmb2r
                                RmbenC = rmb1c + rmb2c
                            End If  'Fin CODCBE(j) <> "N"
                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
                    Else
                        'RESERVA RENTAS TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe <= L18 Or (edabe > L18 And Mesgar > 0) Then 'GoTo 206
                            'If edabe < L24 Then
                                If edabe >= L18 Then
                                    mdif = L24 - edabe
                                Else
                                    mdif = L21 - edabe
                                End If
                                nmdif = mdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad conjunta del causante y beneficiario
                                limite2 = Fintab - edaca
                                limite = fgMinimo(nmdif, limite2) - 1
                                For i = 0 To limite
                                    imas1 = i + 1
                                    edalca = edaca + i
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If i < limgar Then
                                      py1 = py
                                    Else
                                        If i >= limgar And i < nmdiga Then
                                            py1 = 0
                                        Else
                                            py1 = py
                                        End If
                                    End If
                                    If i < perdif Then py1 = 0
'                                    If Nciare > 0 Then
'                                        'ACEPTACION
'                                        If oprea = "A" Or oprea = "D" Then
'                                            If modore = "N" Then
'                                                If i >= mesnoc And i < nmrea Then
'                                                    sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ i
'                                                    sumapx = sumapx + py1 * FactorPorRet / tmtce ^ i
'                                                    Supxpy = Supxpy + (py1 * px * FactorPorRet) / (tmtce ^ i)
'                                                End If
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
'                                                    sumapx = sumapx + py1 * Porret / tmtce ^ i
'                                                    Supxpy = Supxpy + (py1 * px) * Porret / (tmtce ^ i)
'                                                End If
'                                            End If
'                                        Else
'                                            If modore = "N" Then
'                                                sumapxr = sumapxr + py1 * FacReaseg(i) / TmTcr ^ i
'                                                Supxpyr = Supxpyr + (py1 * px) * FacReaseg(i) / TmTcr ^ i
'                                                sumapxc = sumapxc + py1 * (1 - FacReaseg(i)) / tmtce ^ i
'                                                Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(i)) / tmtce ^ i
'                                                sumapx = sumapxr + sumapxc
'                                                Supxpy = Supxpyr + Supxpyc
'                                            Else
'                                                If modore = "P" Then
'                                                    sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ i
'                                                    Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ i
'                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ i
'                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
'                                                    sumapx = sumapx + py1 / tmtce ^ i
'                                                    Supxpy = Supxpy + (py1 * px) / tmtce ^ i
'                                                End If
'                                            End If
'                                        End If
'                                    Else
'                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            Supxpyr = Supxpyr + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            sumapx = sumapx + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
                                            Supxpy = Supxpy + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ i
'                                        End If
'                                    End If
                                Next i
                                Factor = sumapx - Supxpy
                                factorr = sumapxr - Supxpyr
                                factorc = sumapxc - Supxpyc
                                rmb1 = Factor * Penben(j)
                                rmb1r = factorr * Penben(j)
                                rmb1c = factorc * Penben(j)
                                'RESERVA DEL HIJO INVALIDO
                                If Coinbe(j) <> "N" Then
                                    sumapx = 0: sumapxr = 0: sumapxc = 0
                                    Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                    'Probabilidad conjunta del causante y beneficiario
                                    edbedi = edabe + nmdif
                                    limite3 = Fintab - edbedi - 1
                                    limite4 = Fintab - (edaca + nmdif) - 1
                                    For i = 0 To limite3
                                        nmdifi = nmdif + i
                                        imas1 = nmdifi + 1
                                        edalca = edaca + nmdif + i
                                        edalbe = edbedi + i
                                        edalca = fgMinimo(edalca, Fintab)
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                        If nmdifi < limgar Then
                                            py1 = py
                                        Else
                                            If nmdifi >= limgar And nmdifi < nmdiga Then
                                                py1 = 0
                                            Else
                                                py1 = py
                                            End If
                                        End If
                                        If nmdifi < perdif Then py1 = 0
'                                        If Nciare > 0 Then
'                                            'ACEPTACION
'                                            If oprea = "A" Or oprea = "D" Then
'                                                If modore = "N" Then
'                                                    If nmdifi >= mesnoc And nmdifi < nmrea Then
'                                                        sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py1 * FactorPorRet / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py1 * px * FactorPorRet) / (tmtce ^ nmdifi)
'                                                    End If
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxr = sumapxr + py1 * Porret / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py1 * Porret / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py1 * px) * Porret / (tmtce ^ nmdifi)
'                                                    End If
'                                                End If
'                                            Else
'                                                If modore = "N" Then
'                                                    sumapxr = sumapxr + py1 * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                    Supxpyr = Supxpyr + (py1 * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
'                                                    sumapxc = sumapxc + py1 * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                    Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
'                                                    sumapx = sumapxr + sumapxc
'                                                    Supxpy = Supxpyr + Supxpyc
'                                                Else
'                                                    If modore = "P" Then
'                                                        sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ nmdifi
'                                                        Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ nmdifi
'                                                        sumapxr = sumapxr + py1 * Porret / tmtce ^ nmdifi
'                                                        Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
'                                                        sumapx = sumapx + py1 / tmtce ^ nmdifi
'                                                        Supxpy = Supxpy + (py1 * px) / tmtce ^ nmdifi
'                                                    End If
'                                                End If
'                                            End If
'                                        Else
'                                            If Nciare = 0 Then
                                                sumapxr = sumapxr + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                                Supxpyr = Supxpyr + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                                sumapx = sumapx + py1 * facgratif(imas1) * iMtoFacPenElla / tmtce ^ nmdifi
                                                Supxpy = Supxpy + (py1 * px) * facgratif(imas1) * iMtoFacPenElla / (tmtce ^ nmdifi)
'                                            End If
'                                        End If
                                    Next i
                                    factoa = sumapx - Supxpy
                                    factoar = sumapxr - Supxpyr
                                    factoac = sumapxc - Supxpyc
                                    vipen = penbase * 0.15
                                    
'                                    If Navig = 1990 And Nmvig >= 8 Then vipen = Penben(j)
'                                    If Navig > 1990 Then vipen = Penben(j)
                                    
                                    Rmben = rmb1 + factoa * vipen
                                    RmbenR = rmb1r + factoar * vipen
                                    RmbenC = rmb1c + factoac * vipen
                                Else
                                    If Coinbe(j) = "N" Then
                                        Rmben = rmb1
                                        RmbenR = rmb1r
                                        RmbenC = rmb1c
                                    End If
                                End If
                            End If  'Fin EDABE < L24
                        End If  'Fin ncorbe(j) >= 30 And ncorbe(j) < 40
                    End If  'Fin ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or _
                    RmBenT = RmbenR + RmbenC
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
                    rmpol = rmpol + Rmben
                    RmpolR = RmpolR + RmbenR
                    RmpolC = RmpolC + RmbenC
                    'Ani - Dani
                    
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                    If Nciare = 0 Then
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlBenRet = vlBenRet + 1
                        Else
                            vlBenCed = vlBenCed + 1
                    End If
                    End If
                End If  'Fin    ncorbe(j) = 99 And j = 1
            End If  'FIN    If derpen(j) = 10 Then
        Next j
        NumPro = NumPro + 1
        'Ani - Dani
        ''Grabar los Totales en la Póliza
        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
        'vgConexionBD.Execute (vgQuery)
    
        If (Vuelta = 1) Then
            vlReservaOriginal = Format(rmpol, "#0.00")
        Else
            vlReservaCalculada = Format(rmpol, "#0.00")
        End If
    
    End If  'Fin Sob/Vejez/inval
Exit Function
Err_Base:
    'Screen.MousePointer = 0
    Select Case Err
        Case Else
        'ProgressBar.Value = 0
        MsgBox "Error Grave en la Póliza '" & Npolca & "' : [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
        vgError = 5000
    End Select
End Function

Function fgBasDos_Old(iCartera, Npolca, Numend, Nap, Nmp, Ndp, Nben, Cober, vigpen, _
                  Navig, Nmvig, Ndvig, SalCta, penbase, Indi, Mesdif, Alt, Mesgar, _
                  Nciare, oprea, modore, Iare, Imre, Idre, fare, fmre, fdre, Porret, tce, Tvta, Tcrj, _
                  GtoFun, IVigrea_d, IVigrea_m, IVigrea_a, Vuelta)
                  

'RESERVA TECNICA BASE DE RENTAS VITALICIAS
'TASA BASE PARA CADA UNA DE LAS POLIZAS

Dim Numor(1 To 20)  As Integer, Ncorbe(1 To 20) As Integer
Dim Nanbe(1 To 20) As Integer, Nmnbe(1 To 20) As Integer, Ndnbe(1 To 20) As Integer
Dim Sexobe(1 To 20) As String
Dim Coinbe(1 To 20) As String, Codcbe(1 To 20) As String
Dim Ijam(1 To 20) As Integer, Ijmn(1 To 20) As Integer, ijdn(1 To 20) As Integer

Dim FactorPorRet As Double
Dim igfh(1 To 20) As Integer
Dim derpen(1 To 20) As Integer
Dim porceb(1 To 20) As Double, Porcbe(1 To 20) As Double, Penben(1 To 20) As Double
Dim Npolbe(1 To 20) As String, swg As String

Dim Ecadif As Long, edcadi As Long, nmdifi As Long, kdif As Long
Dim edbedi As Long, limite3 As Long, edacai As Long, edacas As Long
Dim edaca As Long, edabe As Long, edalca As Long, edalbe As Long

Dim Fechan As Long, Fechap As Long
Dim perdif As Long, diftem  As Long, difdia As Long
Dim TmTcr As Double, tmtce As Double
Dim Rmcob(1 To 3, 1 To 3, 1 To 5, 1 To 3) As Double
Dim iagno As Long, idbis As Integer, idp As Integer
Dim numrec As Long, Nubenp As Long, NuBenL As Long, NumPro As Long
Dim Npnv As Long
Dim MesesReaTemporal As Long
Dim mesnocRea  As Long

Dim ncobe   As Integer, nv As Integer
Dim nmdiga  As Long, mescon As Long, mesnoc As Long

Dim icont10 As Integer, icont20 As Integer, icont30 As Integer
Dim icont35 As Integer, icont40 As Integer, icont77 As Integer

Dim nrel As Integer, nibe As Integer, nsbe As Integer, ns As Integer, ni As Integer
Dim limite1 As Long, edhm As Long, mdif As Long, nmdif As Long

Dim limite2 As Long, limite As Long, Ebedif As Long, inmdif As Long
Dim limite4 As Long, Nbpr As Long, imas1 As Long, ll As Long
Dim i As Long, j As Long, k As Long, l As Long
Dim igf As Integer, j1 As Long, ixx As Long, ia As Long, ib As Long

Dim limgar As Long, i1 As Long, i2 As Long

Dim topobe As Double
Dim tmin  As Double, tobe As Double, repa1 As Double, repa2 As Double

Dim RmTot As Double, Rmben As Double
Dim RmBenT As Double, RmbenR As Double, RmbenC As Double
Dim rmpol As Double, RmpolC As Double, RmpolR As Double
Dim paso As Double
Dim Factor As Double, factorr As Double, factorc As Double
Dim factoa As Double, factoar  As Double, factoac As Double

Dim Reser As Double, ReserR As Double, ReserC As Double
Dim Cmcau As Double, CmcauR As Double, CmcauC As Double
Dim Rmcau  As Double, RmcauC As Double, RmcauR As Double
Dim sumapx As Double, sumapxr As Double, sumapxc As Double
Dim Supxpy As Double, Supxpyr As Double, Supxpyc As Double
Dim sumaqx As Double, Sumaqxr As Double, Sumaqxc As Double
Dim rmb1 As Double, rmb1r As Double, rmb1c As Double
Dim rmb2 As Double, rmb2r As Double, rmb2c As Double
Dim vipen As Double, px1 As Double, py1  As Double
Dim Qx As Double, px As Double, py As Double
Dim Pension As Double
Dim FacReaseg(0 To 1332) As Double
Dim vlBenCed As Long, vlBenRet As Long
Dim vlPolCed As Long, vlPolRet As Long
Dim Tcrj1 As Double
Dim flumax() As Double
'I---- ABV 15-03-2005 ----
Dim vlFechaNacCausante As String
Dim vlSexoCausante     As String
Dim vlRegistro         As ADODB.Recordset
Dim fecha1             As String
Dim vlI  As Long
Dim contcausante As Long

Dim vlFechaFallecimiento As String
Dim vlFechaMatrimonio    As String
Dim vlFechaAux           As String
'I---- ABV 15-03-2005 ----
  
'I--- ABV 17/11/2005 ---
Dim nmrea As Long
'F--- ABV 17/11/2005 ---

    
On Error GoTo Err_Base
    
ReDim flumax(1 To Fintab) As Double
    Fechap = Nap * 12 + Nmp
    idp = fgBisiestro(Nap, Nmp)         'Año bisietro - modulo 4

    'Inicializacion de variables
    numrec = -1
    Nubenp = 0
    NuBenL = 0
    NumPro = 0
    Npnv = 0
    For i = 1 To 3
        For j = 1 To 3
            For k = 1 To 5
                For l = 1 To 3
                    Rmcob(i, j, k, l) = 0
                Next l
            Next k
        Next j
    Next i
    'Inicio de proceso de calculo
    topobe = 0
    If (Cober <= 3 Or (Cober >= 13 And Cober <= 15)) And (Navig = 0 Or Nmvig = 0 Or Ndvig = 0) Then
        Navig = 1985
        Nmvig = 12
        Ndvig = 28
        Indi = 1
        Mesdif = 0
        Alt = 1
        Mesgar = 0
    End If
    
    'ISTA = 1 'NUPEN0
    'Vigencia de la poliza
    '6 -> Vigente          7 -> Vigente con Benef. designados
    '8 -> Vigente Difer.   9 -> no vigente
    If vigpen = 9 Then
        Npnv = Npnv + 1
        Exit Function
    End If
        vlFechaNacCausante = ""
    
''    'Daniela 08/05/2004
''    'Poliza con retroaceptacion Operacion de Reaseguro = "B"
''    'Por lo tanto no se realiza calculo de Reserva
''    If oprea = "B" Then
''        Npnv_B = Npnv_B + 1
''        Exit Function
''    End If
''    'Fin daniela
    i = 1
    'Datos de los Beneficiarios
    'Datos de los Beneficiarios
    If (Vuelta = 1) Then
    
        vgSql = "SELECT "
        vgSql = vgSql & "num_poliza,Num_Orden,Cod_Sexo,Cod_Par,Cod_SitInv,"
        vgSql = vgSql & "Fec_NacBen,cod_estpension,Cod_DerPen,Fec_NacHM,"
        vgSql = vgSql & "PRC_pension as prc_legal,Mto_Pension,Cod_DerCre,Cod_GruFam "
        vgSql = vgSql & ",fec_fallben, fec_matrimonio "
        vgSql = vgSql & "FROM PP_TMAE_BEN WHERE "
        vgSql = vgSql & "num_poliza = '" & Npolca & "' and "
        'vgSql = vgSql & "cod_cliente = " & vgCliente & "  and "
        vgSql = vgSql & "num_endoso = " & Numend & " "
        vgSql = vgSql & "order by num_orden "
        Set vlRegistro = vgConexionBD.Execute(vgSql)
        While Not (vlRegistro.EOF)
            Numor(i) = Trim(vlRegistro!Num_Orden)
            Sexobe(i) = Trim(vlRegistro!Cod_Sexo)
            Ncorbe(i) = Trim(vlRegistro!Cod_Par)
            'I--- ABV 15/03/2005 ---
            If (Ncorbe(i) = 99) Or (Ncorbe(i) = 0) Then
                vlFechaNacCausante = vlRegistro!Fec_NacBen
                vlSexoCausante = Trim(vlRegistro!Cod_Sexo)
            End If
            'F--- ABV 15/03/2005 ---
            
            Coinbe(i) = Trim(vlRegistro!Cod_SitInv)
            fecha1 = DateSerial(Mid(vlRegistro!Fec_NacBen, 1, 4), Mid(vlRegistro!Fec_NacBen, 5, 2), Mid(vlRegistro!Fec_NacBen, 7, 2))
            If Not IsNull(vlRegistro!Fec_NacBen) Then
                Nanbe(i) = Mid(vlRegistro!Fec_NacBen, 1, 4)
                Nmnbe(i) = Mid(vlRegistro!Fec_NacBen, 5, 2)
                Ndnbe(i) = Mid(vlRegistro!Fec_NacBen, 7, 2)
            End If
            
            If Not IsNull(vlRegistro!Fec_NacHM) Then
                Ijam(i) = Mid(vlRegistro!Fec_NacHM, 1, 4)
                Ijmn(i) = Mid(vlRegistro!Fec_NacHM, 5, 2)
                ijdn(i) = Mid(vlRegistro!Fec_NacHM, 7, 2)
            End If
            Porcbe(i) = Trim(vlRegistro!PRC_LEGAL)
            'I--- ABV 21/06/2005 ---
            'Penben(i) = Trim(vlRegistro!Mto_Pension)
            Penben(i) = CDbl(Format(penbase * (Porcbe(i) / 100), "#0.00"))
            'I--- ABV 21/06/2005 ---
            Codcbe(i) = Trim(vlRegistro!Cod_DerCre)
            igfh(i) = Trim(vlRegistro!Cod_GruFam)
            
            NuBenL = NuBenL + 1
            
            
            'I--- ABV 14/04/2005 ---
            'Dº Potencial a Pensión de Sobrevivencia
            'Se debería considerar el campo de Estado Pensión, sin embargo, se debe
            'considerar el potencial Dº a recibir, por ende sería correcto determinar
            'dicho Derecho desde el cálculo
            'Derpen(i) = Trim(vlRegistro!Cod_DerPen)
            vlFechaFallecimiento = IIf(IsNull(vlRegistro!Fec_FallBen), "", Trim(vlRegistro!Fec_FallBen))
            vlFechaMatrimonio = IIf(IsNull(vlRegistro!Fec_Matrimonio), "", Trim(vlRegistro!Fec_Matrimonio))
            If (Ncorbe(i) >= 30 And Ncorbe(i) <= 39) Then
                'Si se trata de Hijos, se debe validar la fecha de Nacimiento
                'por si son mayores de 24 años
                
                If (vlFechaFallecimiento <> "") Or (vlFechaMatrimonio <> "") Then
                    derpen(i) = clCodSinDerPen
                Else
                    nrel = 0
                    nibe = 0
                    Select Case (Coinbe(i))
                        Case "S", "T": nibe = 1
                        Case "N": nibe = 2
                        Case "P": nibe = 3
                        Case Else
                            vgError = 1017
                            Exit Function
                    End Select
                    nsbe = 0
                    Select Case (Sexobe(i))
                        Case "M", "T": nsbe = 1
                        Case "F": nsbe = 2
                        Case Else
                            vgError = 1018
                            Exit Function
                    End Select
                    Fechan = Nanbe(i) * 12 + Nmnbe(i)
                    edabe = Fechap - Fechan
                    difdia = idp - Ndnbe(i)
                    If difdia > 15 Then edabe = edabe + 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If edabe < 1 Then edabe = 1
                    If (edabe > L24) Then
                        If (nibe = 2) Then
                            derpen(i) = clCodSinDerPen
                        Else
                            derpen(i) = clCodConDerPen
                        End If
                    Else
                        derpen(i) = clCodConDerPen
                    End If
                End If
                
            Else
                If (vlFechaFallecimiento <> "" Or vlFechaMatrimonio <> "") Then
                    derpen(i) = clCodSinDerPen
                Else
                    derpen(i) = clCodConDerPen
                End If
            End If
            
            If derpen(i) <> 10 Then topobe = topobe + Porcbe(i)
            If Ncorbe(i) = 77 Then
                If vigpen <> 7 Then vigpen = 7
            End If
            Porcbe(i) = Porcbe(i) / 100
            i = i + 1
            vlRegistro.MoveNext
        Wend
        vlRegistro.Close
    Else
        If (Msf_BMGrilla.rows > 1) Then
            i = 1
            While i <= (Msf_BMGrilla.rows - 1)
                Numor(i) = Trim(Msf_BMGrilla.TextMatrix(i, 0))
                Sexobe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 9))
                Ncorbe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 7))
                
                'I--- ABV 15/03/2005 ---
                If (Ncorbe(i) = 99) Or (Ncorbe(i) = 0) Then
                    'vlFechaNacCausante = Trim(Msf_BMGrilla.TextMatrix(i, 14))
                    vlFechaNacCausante = Format(Trim(Msf_BMGrilla.TextMatrix(i, 16)), "yyyymmdd")
                    vlSexoCausante = Trim(Msf_BMGrilla.TextMatrix(i, 9))
                End If
                'F--- ABV 15/03/2005 ---
                        
                Coinbe(i) = Msf_BMGrilla.TextMatrix(i, 10)
                'fecha1 = DateSerial(Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4), Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2), Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2))
                vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 16)), "yyyymmdd")
                'If Trim(Msf_BMGrilla.TextMatrix(i, 14)) <> "" Then
                If Trim(vlFechaAux) <> "" Then
                    'Nanbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4)
                    'Nmnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2)
                    'Ndnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2)
                    Nanbe(i) = Mid(vlFechaAux, 1, 4)
                    Nmnbe(i) = Mid(vlFechaAux, 5, 2)
                    Ndnbe(i) = Mid(vlFechaAux, 7, 2)
                End If
                
                
                'If Not IsNull(Msf_BMGrilla.TextMatrix(i, 15)) And ((Msf_BMGrilla.TextMatrix(i, 15)) <> "") Then
                If (Trim(Msf_BMGrilla.TextMatrix(i, 17)) <> "") Then
                    'Ijam(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 1, 4)
                    'Ijmn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 5, 2)
                    'ijdn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 7, 2)
                    vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 17)), "yyyymmdd")
                    
                    Ijam(i) = Mid(vlFechaAux, 1, 4)
                    Ijmn(i) = Mid(vlFechaAux, 5, 2)
                    ijdn(i) = Mid(vlFechaAux, 7, 2)
                End If
                Porcbe(i) = IIf(Msf_BMGrilla.TextMatrix(i, 20) = "", 0, Msf_BMGrilla.TextMatrix(i, 20))
                'Determinar el monto de la Pensión del Beneficiario
                'Penben(i) = IIf(Msf_BMGrilla.TextMatrix(vlI, 17) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 17))
                Penben(i) = CDbl(Format(penbase * (Porcbe(i) / 100), "#0.00"))
                
                Codcbe(i) = Msf_BMGrilla.TextMatrix(i, 12)
                igfh(i) = Msf_BMGrilla.TextMatrix(i, 8)
                
                NuBenL = NuBenL + 1
                
                
                'I--- ABV 14/04/2005 ---
                'Dº Potencial a Pensión de Sobrevivencia
                'Se debería considerar el campo de Estado Pensión, sin embargo, se debe
                'considerar el potencial Dº a recibir, por ende sería correcto determinar
                'dicho Derecho desde el cálculo
                ''Derpen(i) = Msf_BMGrilla.TextMatrix(i, 9)
                'Derpen(i) = Msf_BMGrilla.TextMatrix(i, 20)
                
                'vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 19) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 19)))
                'vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 27) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 27)))
                vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 21) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 21)), "yyyymmdd"))
                vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 29) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 29)), "yyyymmdd"))
                
                If (Ncorbe(i) >= 30 And Ncorbe(i) <= 39) Then
                    'Si se trata de Hijos, se debe validar la fecha de Nacimiento
                    'por si son mayores de 24 años
                    
                    If (vlFechaFallecimiento <> "") Or (vlFechaMatrimonio <> "") Then
                        derpen(i) = clCodSinDerPen
                    Else
                        nrel = 0
                        nibe = 0
                        Select Case (Coinbe(i))
                            Case "S", "T": nibe = 1
                            Case "N": nibe = 2
                            Case "P": nibe = 3
                            Case Else
                                vgError = 1017
                                Exit Function
                        End Select
                        nsbe = 0
                        Select Case (Sexobe(i))
                            Case "M", "T": nsbe = 1
                            Case "F": nsbe = 2
                            Case Else
                                vgError = 1018
                                Exit Function
                        End Select
                        Fechan = Nanbe(i) * 12 + Nmnbe(i)
                        edabe = Fechap - Fechan
                        difdia = idp - Ndnbe(i)
                        If difdia > 15 Then edabe = edabe + 1
                        If edabe > Fintab Then
                            vgError = 1023
                            Exit Function
                        End If
                        If edabe < 1 Then edabe = 1
                        If (edabe > L24) Then
                            If (nibe = 2) Then
                                derpen(i) = clCodSinDerPen
                            Else
                                derpen(i) = clCodConDerPen
                            End If
                        Else
                            derpen(i) = clCodConDerPen
                        End If
                    End If
                    
                Else
                    'El resto de los Beneficiarios que no sean Hijos, solo se dejan como
                    'Sin Derecho a Pensión cuando están fallecidos
                    'If (vlFechaFallecimiento <> "" Or vlFechaMatrimonio <> "") Then
                    If (vlFechaFallecimiento <> "") Then
                        derpen(i) = clCodSinDerPen
                    Else
                        derpen(i) = clCodConDerPen
                    End If
                End If
                
                'Modificar el estado de Derecho a Pensión en la Grilla
                'De acuerdo a lo calculado
                Msf_BMGrilla.TextMatrix(i, 22) = derpen(i)
                
                'F--- ABV 14/04/2005 ---
                
                
                If derpen(i) <> 10 Then topobe = topobe + Porcbe(i)
                If Ncorbe(i) = 77 Then
                    If vigpen <> 7 Then vigpen = 7
                End If
                Porcbe(i) = Porcbe(i) / 100
                i = i + 1
            Wend
        Else
            'Error ya que deben existir beneficiarios en la Grilla de Modificación
            
        End If
    End If
    
    'Validar el Número de Beneficiarios
    If NuBenL = 0 Then
        vgError = 1003
        Exit Function         'Registrarlo como un Error de la Póliza
    End If
    Nben = i - 1
        
    'Se calculan igualmente todas las Pólizas, las cuales se distinguen por
    'el Código del Tipo de Reserva al cual pertenecen (COD_RESERVA)
    'If (Cober <= 3)
    '-------------------------------------------------
    'Leer Tabla de Mortalidad
    '-------------------------------------------------
    If (fgBuscarMortalidadNormativa(Navig, Nmvig, Ndvig, Nap, Nmp, Ndp, vlSexoCausante, vlFechaNacCausante) = False) Then
        'Se produjeron errores en la obtención de una de las Tablas de Mortalidad
        Exit Function
    End If
    
    'Validacion de pension de referencia y de pension de beneficiarios
    'de sobrevivencia
    If penbase = 0 Then
        vgError = 1033
        Exit Function
    End If
    If vigpen = 6 Or vigpen = 8 Then
        If Cober = 3 Or Cober = 8 Or Cober = 9 Or Cober = 10 Or _
            Cober = 11 Or Cober = 1 Or Cober = 13 Then
            For i = 1 To Nben
                If Ncorbe(i) <> 99 Then
                    If derpen(i) <> 10 And Penben(i) = 0 Then
                        vgError = 1034
                        Exit Function
                    End If
                End If
            Next i
        End If
        If Cober = 2 Or Cober = 4 Or Cober = 5 Or Cober = 6 Or Cober = 7 Or Cober = 14 _
            Then
                For i = 1 To Nben
                    If Ncorbe(i) = 99 And derpen(i) = 10 Then
                        vgError = 1074
                        Exit Function
                    End If
                Next i
        End If
        If Cober = 2 Or Cober = 4 Or Cober = 5 Or Cober = 6 Or Cober = 7 Or Cober = 14 Then
            'I - Inicio Daj 13/08/2004
            contcausante = 0
            For i = 1 To Nben
                If Ncorbe(i) = 99 Then contcausante = contcausante + 1
            Next i
            If contcausante = 0 Then
                vgError = 1075
                Exit Function
            End If
            'F - Fin Daj 13/08/2004
        End If

    End If
    'Inicializacion de variables por poliza
    Porret = Porret / 100
    FactorPorRet = Porret
    'If Porret > 0 Then FactorPorRet = Porret
    
    rmpol = 0: RmpolC = 0: RmpolR = 0
    vlPolCed = 0: vlPolRet = 0
    vlBenCed = 0: vlBenRet = 0

    'Tasa minima entra la tasa de venta y la tasa de costo equivalente
    If Cober = 1 Or Cober = 2 Or Cober = 3 Or Cober > 12 Then
        tmin = tce
    Else
        If Tvta <= 0 Then
            tmin = tce
        Else
            tmin = fgMinimo(tce, Tvta)
        End If
    End If
    If oprea = "C" And modore = "N" And IVigrea_a <= 1993 Then
        If Tcrj = 0 Then Tcrj = fgMinimo(tce, Tvta)
    End If
    'Mensualizacion de tasas
    'Tasa mensual de reserva base
    tmtce = (1 + tmin / 100) ^ (1 / 12)
    'Tasa mensual a TCRj
    If fgMinimo(Tvta, tce) = tce Then Tcrj1 = Tcrj
    If fgMinimo(Tvta, tce) = Tvta Then Tcrj1 = Tvta
    If Tvta = tce Then Tcrj1 = Tvta
    
    TmTcr = (1 + Tcrj1 / 100) ^ (1 / 12)

    'Circular Nº 528
    '---------------
    'Coberturas -->
    '01 --> Sobrevivencia, 02 --> Invalidez, 03 --> Sobrevivencia de invalidez
    'Rentas Vitalicias
    '-----------------
    '04 --> Vejez Normal        05 --> Vejez Anticipada
    '06 --> Invalidez Total     07 --> Invalidez Parcial
    '08 --> Sobrevivencia
    '09 --> Sobrevivencia de 04 (VN),   10 --> Sobrevivencia de 05 (VA)
    '11 --> Sobrevivencia de 06 (IT),   12 --> Sobrevivencia de 07 (IP)
    '13 --> Sobrevivencia por traspaso o compra de cartera
    '14 --> Invalidez por traspaso o compra de cartera
    '15 --> Sobrevivencia de invalidez por traspaso o compra de cartera de 14
    
    'Tipo de cobertura o riesgo
    ncobe = 0
    ncobe = fgNCobe(Cober)
    If ncobe = 0 Then
        vgError = 1015
        Exit Function
    End If
    'Polizas del mes y de meses anteriores
    nv = 1
    If Navig = Nap And Nmvig = Nmp Then nv = 2
    'Definicion del periodo garantizado en 0 para las alternativas Simple o pensiones con distinto porcentaje legal
    If Alt = 1 Or (Alt = 4 And Mesgar = 0) Then Mesgar = 0
    'Cobertura Inmediata
    If Indi = 1 Then
        perdif = 0
        If Mesdif > 0 Then
            vgError = 1030
            Exit Function
        End If
        If Alt = 3 Or (Alt = 4 And Mesgar > 0) Then
            Mesgar = Mesgar - ((Nap * 12 + Nmp) - (Navig * 12 + Nmvig))
            Mesgar = fgMaximo(Mesgar, 0)
        End If
    Else
    'Cobertura diferida
        If Indi = 2 Then
            perdif = ((Navig * 12) + Nmvig) + Mesdif - Fechap - 1
            If perdif <= 0 Then
                If Alt = 3 Or (Alt = 4 And Mesgar > 0) Then
                    Mesgar = Mesgar + perdif
                    Mesgar = fgMaximo(Mesgar, 0)
                End If
                perdif = 0
            End If
        End If
    End If
    nmdiga = perdif + Mesgar
    'Periodo no consumido para reaseguros no proporcionales
    mesnoc = fgMesNoC(Iare, Imre, Navig, Nmvig, Nap, Nmp)
    MesesReaTemporal = 0
    mesnocRea = 0
    nmrea = 0
    If fare <> 0 Then
        MesesReaTemporal = (CLng(fare) * 12 + CLng(fmre)) - (Iare * 12 + Imre)
        nmrea = MesesReaTemporal + mesnoc
        nmrea = fgMaximo(0, nmrea)
    End If
    
    For i = 0 To Fintab
        FacReaseg(i) = FactorPorRet
        If i < mesnoc Then
            FacReaseg(i) = 1
        Else
            If i > nmrea Then
                FacReaseg(i) = 1
            Else
                FacReaseg(i) = FactorPorRet
            End If
        End If
    Next i
    Cober = CInt(Cober)
    'Impresion de datos basicos de la poliza
    
    'RESERVA DE SOBREVIVENCIA
    If Cober = 1 Or Cober = 3 Or Cober = 8 Or Cober = 9 Or _
       Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 13 Or Cober = 15 Then

        'Calculo porcentajes para beneficiarios
        If vigpen <> 9 Then
            If Cober = 1 Or Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 13 Then
                If vigpen = 7 And topobe = 100 And nmdiga > 0 Then GoTo 543
                If nmdiga > 0 Then
                    icont10 = 0:  icont20 = 0
                    icont30 = 0: icont35 = 0
                    icont40 = 0: icont77 = 0
                    For j = 1 To Nben
                        If derpen(j) <> 10 And Ncorbe(j) <> 99 Then
                            nrel = 0: nibe = 0
                            nibe = fgCodInvalidez(Coinbe(j))
                            If nibe = 0 Then
                                vgError = 1017
                                Exit Function
                            End If
                            nsbe = 0
                            nsbe = fgSexo(Sexobe(j))
                            If nsbe = 0 Then
                                vgError = 1018
                                Exit Function
                            End If
                            edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                            If edabe < 1 Then edabe = 1
                            If edabe > Fintab Then
                                vgError = 1023
                                Exit Function
                            End If
                            If edabe < 1 Then edabe = 1
                            If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Then icont10 = icont10 + 1
                            If Ncorbe(j) = 20 Or Ncorbe(j) = 21 Then icont20 = icont20 + 1
                            If Ncorbe(j) = 30 Then icont30 = icont30 + 1
                            If Ncorbe(j) = 35 Then icont35 = icont35 + 1
                            If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then icont40 = icont40 + 1
                            If Ncorbe(j) = 77 Then icont77 = icont77 + 1
                        End If  'Fin (DERPEN(j) <> 10 And ncorbe(j) <> 99)
                    Next j
        
                    For igf = 0 To 10
                        For j = 1 To Nben
                            If (igfh(j) = igf) Then
                                If derpen(j) <> 10 And Ncorbe(j) <> 99 Then
                                    nrel = 0: nibe = 0
                                    nibe = fgCodInvalidez(Coinbe(j))
                                    If nibe = 0 Then
                                        vgError = 1017
                                        Exit Function
                                    End If
                                    nsbe = 0
                                    nsbe = fgSexo(Sexobe(j))
                                    If nsbe = 0 Then
                                        vgError = 1018
                                        Exit Function
                                    End If
                                    edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                                    If edabe < 1 Then edabe = 1
                                    If edabe > Fintab Then
                                        vgError = 1023
                                        Exit Function
                                    End If
                                    If edabe < 1 Then edabe = 1
                                    If Ncorbe(j) = 10 Then
                                        If ((Ncorbe(j) = 10 And nsbe = 2) Or (Ncorbe(j) = 10 And (nsbe = 1 And nibe = 1))) Then
                                            If (icont10 > 0) Then porceb(j) = 60 / icont10
                                        Else
                                            If (Ncorbe(j) = 10 And nsbe = 1 And nibe = 3) Then
                                                If (icont10 > 0) Then porceb(j) = 43 / icont10
                                            End If
                                        End If
                                    End If
                                    If Ncorbe(j) = 20 Then
                                        If icont20 > 0 Then porceb(j) = 36 / icont20
                                    End If
                                    If Ncorbe(j) = 21 Then
                                        If icont20 > 0 Then porceb(j) = 30 / icont20
                                    End If
                                    If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then porceb(j) = 50
                                    If Ncorbe(j) = 77 Then porceb(j) = 100 / icont77
                                    If Ncorbe(j) = 11 Then
                                        If Ncorbe(j) = 11 And nsbe = 2 Then porceb(j) = 50 / icont10
                                        If Ncorbe(j) = 11 And nsbe = 1 And nibe = 1 Then
                                           porceb(j) = 50 / icont10
                                        Else
                                           If (Ncorbe(j) = 11 And nsbe = 1 And nibe = 3) Then porceb(j) = 36 / icont10
                                        End If
                                    End If
                                    If Ncorbe(j) = 30 Then
                                        porceb(j) = 15
                                        If nibe = 1 And edabe > L24 Then porceb(j) = 15
                                        If nibe = 3 And edabe > L24 Then porceb(j) = 11
                                    End If
                                    If Ncorbe(j) = 35 Then
                                        If icont10 = 0 Then
                                            porceb(j) = 15 + (50 / (icont35))
                                            If (nibe = 3 And edabe > L24) Then porceb(j) = 11 + (50 / icont35)
                                        End If
                                    End If
                                End If  'Fin (DERPEN(j) <> 10 and ncorbe(j) <> 99)
                            End If  'Fin (igfh(j) = igf)
                        Next j
                    Next igf
                    tobe = 0
                    For j1 = 1 To Nben
                        If derpen(j1) <> 10 Then
                            tobe = tobe + porceb(j1)
                        Else
                            If derpen(j1) = 10 Then porceb(j1) = 0
                            porceb(j1) = 0
                        End If
                    Next j1
                    If tobe <= 100 Then
                        For j = 1 To Nben
                            If Porcbe(j) <> 0 Then Porcbe(j) = porceb(j) / 100
                            If derpen(j) <> 10 Then Porcbe(j) = porceb(j) / 100
                        Next j
                    End If
                End If
            End If
        End If
        'SOBREVIVENCIAS GARANTIZADAS
        ixx = 0
        If Cober = 8 And nmdiga > 0 And vigpen <> 9 Then
            For j = 1 To Nben
                If Ncorbe(j) >= 10 And Ncorbe(j) <= 21 Then
                    If derpen(j) = 10 Then ixx = 1
                End If
            Next j
            icont10 = 0: icont20 = 0
            icont30 = 0: icont35 = 0
            icont40 = 0: icont77 = 0
            repa1 = 0
            repa2 = 0
            For j = 1 To Nben
                If derpen(j) = 10 And Ncorbe(j) = 10 Then repa1 = 50
                If derpen(j) = 10 And Ncorbe(j) = 11 Then repa1 = 50
                If derpen(j) = 10 And Ncorbe(j) = 20 Then repa2 = 30
                If derpen(j) = 10 And Ncorbe(j) = 21 Then repa2 = 30
                If Ncorbe(j) <> 99 Then
                    nrel = 0: nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If edabe < 1 Then edabe = 1
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Then icont10 = icont10 + 1
                    If Ncorbe(j) = 20 Or Ncorbe(j) = 21 Then icont20 = icont20 + 1
                    If Ncorbe(j) = 30 Then icont30 = icont30 + 1
                    If Ncorbe(j) = 35 Then icont35 = icont35 + 1
                    If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then icont40 = icont40 + 1
                    If Ncorbe(j) = 77 Then icont77 = icont77 + 1
                End If  'Fin ncorbe(j) <> 99
            Next j
            For igf = 0 To 10
                For j = 1 To Nben
                    If igfh(j) = igf And derpen(j) <> 10 And Ncorbe(j) <> 99 Then
                        nrel = 0: nibe = 0
                        nibe = fgCodInvalidez(Coinbe(j))
                        If nibe = 0 Then
                            vgError = 1017
                            Exit Function
                        End If
                        nsbe = 0
                        nsbe = fgSexo(Sexobe(j))
                        If nsbe = 0 Then
                            vgError = 1018
                            Exit Function
                        End If
                        edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                        If edabe < 1 Then edabe = 1
                        If edabe > Fintab Then
                            vgError = 1023
                            Exit Function
                        End If
                        If edabe < 1 Then edabe = 1
                        If Ncorbe(j) = 10 Then
                            If ((Ncorbe(j) = 10 And nsbe = 2) Or (Ncorbe(j) = 10 And (nsbe = 1 And nibe = 1))) Then
                                If icont10 > 0 Then porceb(j) = 60 / icont10
                            Else
                                If (Ncorbe(j) = 10 And nsbe = 1 And nibe = 3) Then
                                    If icont10 > 0 Then porceb(j) = 43 / icont10
                                End If
                            End If
                        End If
                        If Ncorbe(j) = 20 Then
                            If icont20 > 0 Then porceb(j) = 36 / icont20
                        End If
                        If (Ncorbe(j) = 21) Then
                            If (icont20 > 0) Then porceb(j) = 30 / icont20
                        End If
                        If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then porceb(j) = 50
                        If Ncorbe(j) = 77 Then porceb(j) = 100 / icont77
                        If Ncorbe(j) = 11 Then
                            If Ncorbe(j) = 11 And nsbe = 2 Then porceb(j) = 50 / icont10
                            If Ncorbe(j) = 11 And nsbe = 1 And nibe = 1 Then
                                porceb(j) = 50 / icont10
                            Else
                                If Ncorbe(j) = 11 And nsbe = 1 And nibe = 3 Then porceb(j) = 36 / icont10
                            End If
                        End If
                        If Ncorbe(j) = 30 Then
                            porceb(j) = 15
                            If nibe = 1 And edabe > L24 Then porceb(j) = 15
                            If nibe = 3 And edabe > L24 Then porceb(j) = 11
                        End If
                        If Ncorbe(j) = 35 Then
                            If icont10 = 0 Then
                                porceb(j) = 15 + (50 / icont35)
                                If nibe = 3 And edabe > L24 Then porceb(j) = 11 + (50 / icont35)
                            End If
                        End If
                    End If  'Fin igfh(j) = igf And DERPEN(j) <> 10 And ncorbe(j) <> 99
                Next j
            Next igf
            tobe = 0
            For j1 = 1 To Nben
                If derpen(j1) <> 10 Then
                    tobe = tobe + porceb(j1)
                Else
                    If derpen(j1) = 10 Then porceb(j1) = 0
                    porceb(j1) = 0
                End If
            Next j1
            If tobe <= 100 And ixx = 1 Then
                For j = 1 To Nben
                    If Porcbe(j) <> 0 Then Porcbe(j) = porceb(j) / 100
                    If derpen(j) <> 10 Then Porcbe(j) = porceb(j) / 100
                Next j
            End If
        End If
        'FIN CICLO PORCENTAJE DE PENSIONES LEGALES
543:
    'Inicio Distribucion de Pensiones - Daniela 20050818
        If Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Then
            If nmdiga > 0 Then
                tobe = 0
                tobepension = 0
                For j1 = 1 To Nben
                    If derpen(j1) <> 10 Then
                        tobe = tobe + porceb(j1)
                        tobepension = tobepension + Penben(j1)
                    End If
                Next j1
                If tobepension < penbase Then
                    difpension = penbase - tobepension
                    If tobe > 0 Then
                        newpension = difpension / (tobe / 100)
                    Else
                        newpension = 0
                    End If
                    For j1 = 1 To Nben
                        If derpen(j1) <> 10 Then
                            Penben(j1) = Penben(j1) + (porceb(j1) / 100 * newpension)
                        End If
                    Next j1
                End If
            End If
        End If
        'Fin Distribucion de Pensiones - Daniela 20050818

        'Inicio Distribucion de Pensiones - Daniela 20050903
        If Cober = 8 Then
            icontcony_mhn_muertas = 0
            For j1 = 1 To Nben
                If derpen(j1) = 10 And _
                    (Ncorbe(j1) = 10 Or Ncorbe(j1) = 11) Then
                    icontcony_mhn_muertas = icontcony_mhn_muertas + 1
                End If
            Next j1

            If nmdiga > 0 And icontcony_mhn_muertas > 0 Then
                tobe = 0: tobepension = 0
                For j1 = 1 To Nben
                    If derpen(j1) <> 10 Then
                        tobe = tobe + porceb(j1)
                        tobepension = tobepension + Penben(j1)
                    End If
                Next j1
                newpension = 0
                If icont35 > 0 Then
                    porcedistr = 0.5
                Else
                    porcedistr = 0.6
                End If
                difpension = penbase * porcedistr
                If tobe > 0 Then newpension = difpension / (tobe / 100)
                 If tobepension > (penbase * porcedistr) Then
                    For j1 = 1 To Nben
                        If derpen(j1) <> 10 Then
                            If icont35 > 0 Or icont77 > 0 Then
                                Penben(j1) = (porceb(j1) / 100 * newpension)
                            Else
                                
                                Penben(j1) = (penbase * porceb(j1) / 100) + (porceb(j1) / 100 * newpension)
                            End If
                        End If
                    Next j1
                Else
'                    difpension = penbase * 0.5
'                    newpension = 0
'                    If tobe > 0 Then newpension = difpension / (tobe / 100)
                    For j1 = 1 To Nben
                        If derpen(j1) <> 10 Then
                            If icont35 > 0 Or icont77 > 0 Then
                                Penben(j1) = (porceb(j1) / 100 * newpension)
                            Else
                                Penben(j1) = Penben(j1) + (porceb(j1) / 100 * newpension)
                            End If
                        End If
                    Next j1
                End If
            End If
        End If
        'Fin Distribucion de Pensiones - Daniela 20050903
        'Calculo valor presente de pensiones garantizadas de sobrevivencia de vejez o invalidez
        'Calculo de Beneficiarios Designados
        'Vigencia de la poliza: 7 -> Vigente con Benef. designados
        If vigpen = 7 And nmdiga > 0 Then
            RmTot = 0: RmpolR = 0: Rmben = 0
            RmBenT = 0: RmbenR = 0: RmbenC = 0
            For j = 1 To Nben
                Factor = 0: factoa = 0: edabe = 0
                RmBenT = 0: Rmben = 0: RmbenR = 0: RmbenC = 0
                sumapx = 0: sumapxr = 0: sumapxc = 0
                If Ncorbe(j) = 77 And derpen(j) = 99 Then
                    Nubenp = Nubenp + 1
'                    RmbenR = (Penben(j) * ((1 - (tmtce) ^ (-1 * Mesgar)) / (tmtce - 1)) * tmtce)
                    'I - Daj 02/04/2005
                    limite1 = nmdiga - 1
                    For i = 0 To limite1
                        py = 1
                        If i < perdif Then py = 0
                        Pension = Penben(j)
                        If Nciare > 0 Then
                            'ACEPTACION
                            If oprea = "A" Or oprea = "D" Then
                                If modore = "N" Then
                                     If i >= mesnoc And i < nmrea Then
                                        sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * Pension
                                        sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * Pension
                                    End If
                                Else
                                    If modore = "P" Then
                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * Pension
                                        sumapx = sumapx + (py * Porret / tmtce ^ i) * Pension
                                    End If
                                End If
                            Else
                                If modore = "N" Then
                                    sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * Pension
                                    sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * Pension
                                    sumapx = sumapxc + sumapxr
                                Else
                                    If modore = "P" Then
                                        sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * Pension
                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * Pension
                                        sumapx = sumapx + (py / tmtce ^ i) * Pension
                                    End If
                                End If
                            End If
                        Else
                            If Nciare = 0 Then
                                sumapxr = sumapxr + (py / tmtce ^ i) * Pension
                                sumapx = sumapx + (py / tmtce ^ i) * Pension
                            End If
                        End If
                    Next i
                    Factor = sumapx / Pension
                    factorr = sumapxr / Pension
                    factorc = sumapxc / Pension
                    Rmben = sumapx
                    RmbenR = sumapxr
                    RmbenC = sumapxc
                    'F - Daj 02/04/2005
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
                    RmBenT = RmbenR + RmbenC
                    RmTot = RmTot + RmBenT
                    'I--- ABV 25/01/2005 ---
                    RmpolR = RmpolR + RmbenR
                    'F--- ABV 25/01/2005 ---
                    'Ani - Daj
                    If Nciare = 0 Then
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlBenRet = vlBenRet + 1
                        Else
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(RmBenT, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(RmBenT, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(1) & ""
                    'vgConexionBD.Execute (vgQuery)
                End If
            Next j
            If Nciare = 0 Then
                Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                Else
                    Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
                End If
            End If
            NumPro = NumPro + 1
            If Nciare = 0 Then
                vlPolRet = vlPolRet + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    vlPolRet = vlPolRet + 1
                Else
                    vlPolCed = vlPolCed + 1
                End If
            End If
            
            ''Grabar los Totales en la Póliza
            'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
            'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
            'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
            'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
            'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
            'vgQuery = vgQuery & "mto_resEND = " & Str(Format(RmBenT, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmbenC, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(RmBenT, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & " "
            'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
            'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
            'vgQuery = vgQuery & "num_endoso = " & Numend & " "
            'vgConexionBD.Execute (vgQuery)
            
            If (Vuelta = 1) Then
                vlReservaOriginal = Format(RmBenT, "#0.00")
            Else
                vlReservaCalculada = Format(RmBenT, "#0.00")
            End If
            
            Exit Function
        End If
        'Calculo de Pension de Sobrevivencia
        rmpol = 0: RmpolR = 0: RmpolC = 0
        For j = 1 To Nben
            swg = "N"
            Factor = 0: factorr = 0: factorc = 0
            factoa = 0: factoar = 0: factoac = 0
            Rmben = 0: edabe = 0
            RmbenR = 0: RmbenC = 0: RmBenT = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            rmb1 = 0: rmb1r = 0: rmb1c = 0
            rmb2 = 0: rmb2r = 0: rmb2c = 0
            If derpen(j) <> 10 And Ncorbe(j) <> 99 Then
                Nubenp = Nubenp + 1
                nrel = 0
                nibe = 0
                nibe = fgCodInvalidez(Coinbe(j))
                If nibe = 0 Then
                    vgError = 1017
                    Exit Function
                End If
                nsbe = 0
                nsbe = fgSexo(Sexobe(j))
                If nsbe = 0 Then
                    vgError = 1018
                    Exit Function
                End If
                Fechan = Nanbe(j) * 12 + Nmnbe(j)
                edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                If edabe < 1 Then edabe = 1
                If edabe > Fintab Then
                    vgError = 1023
                    Exit Function
                End If
                If edabe < 1 Then edabe = 1
                If Ncorbe(j) = 10 Or Ncorbe(j) = 20 Then nrel = 1
                If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then nrel = 2
                'RESERVA SOBREVIVENCIA VITALICIA
                If Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or _
                    Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                    ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And _
                    (Coinbe(j) <> "N")) Then
                    Pension = Penben(j)
                    limite1 = Fintab - edabe - 1
                    For i = 0 To limite1
                        edalbe = edabe + i
                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                        If i < nmdiga And nrel = 1 Then py = 1
                        If i < perdif Then py = 0
                        If i > nmdiga Then Pension = penbase * Porcbe(j)
                        If Nciare > 0 Then
                            'ACEPTACION
                            If oprea = "A" Or oprea = "D" Then
                                If modore = "N" Then
                                    If i >= mesnoc And i < nmrea Then
                                        sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * Pension
                                        sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * Pension
                                    End If
                                Else
                                    If modore = "P" Then
                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * Pension
                                        sumapx = sumapx + (py * Porret / tmtce ^ i) * Pension
                                    End If
                                End If
                            Else
                                If modore = "N" Then
                                    sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * Pension
                                    sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * Pension
                                    sumapx = sumapxc + sumapxr
                                Else
                                    If modore = "P" Then
                                        sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * Pension
                                        sumapxr = sumapxr + (py * Porret / tmtce ^ i) * Pension
                                        sumapx = sumapx + (py / tmtce ^ i) * Pension
                                    End If
                                End If
                            End If
                        Else
                            If Nciare = 0 Then
                                sumapxr = sumapxr + (py / tmtce ^ i) * Pension
                                sumapx = sumapx + (py / tmtce ^ i) * Pension
                            End If
                        End If
                    Next i
                    Factor = sumapx / Pension
                    factorr = sumapxr / Pension
                    factorc = sumapxc / Pension
                    Rmben = sumapx
                    RmbenR = sumapxr
                    RmbenC = sumapxc
                Else
                    'BENEFICIARIOS PENSION VITALICIA
                    If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
                        edhm = fgEdad(Fechap, idp, Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
                        limite1 = Fintab - edabe - 1
                        Pension = Penben(j)
                        For i = 0 To limite1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            If i < nmdiga And nrel = 2 Then py = 1
                            If i < perdif Then py = 0
                            If i > nmdiga Then Pension = penbase * Porcbe(j)
                            If Nciare > 0 Then
                                'ACEPTACION
                                If oprea = "A" Or oprea = "D" Then
                                    If modore = "N" Then
                                        If i >= mesnoc And i < nmrea Then
                                            sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * Pension
                                            sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * Pension
                                        End If
                                    Else
                                        If modore = "P" Then
                                            sumapxr = sumapxr + (py * Porret / tmtce ^ i) * Pension
                                            sumapx = sumapx + (py * Porret / tmtce ^ i) * Pension
                                        End If
                                    End If
                                Else
                                    If modore = "N" Then
                                        sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * Pension
                                        sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * Pension
                                        sumapx = sumapxc + sumapxr
                                    Else
                                        If modore = "P" Then
                                            sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * Pension
                                            sumapxr = sumapxr + (py * Porret / tmtce ^ i) * Pension
                                            sumapx = sumapx + (py / tmtce ^ i) * Pension
                                        End If
                                    End If
                                End If
                            Else
                                If Nciare = 0 Then
                                    sumapxr = sumapxr + (py / tmtce ^ i) * Pension
                                    sumapx = sumapx + (py / tmtce ^ i) * Pension
                                End If
                            End If
                        Next i
                        Factor = sumapx / Pension
                        factorr = sumapxr / Pension
                        factorc = sumapxc / Pension
                        rmb1 = sumapx
                        rmb1r = sumapxr
                        rmb1c = sumapxc
                        Rmben = sumapx
                        RmbenR = sumapxr
                        RmbenC = sumapxc
                        'DERECHO A ACRECER DE PENSIONES VITALICIAS
                        If Codcbe(j) <> "N" Then
                            If edhm > L24 Then
                                mdif = 0
                            Else
                                If edhm >= L18 Then
                                    mdif = L24 - edhm
                                Else
                                    mdif = L21 - edhm
                                End If
                            End If
                            nmdif = mdif
                            If Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 15 Then
                                nmdif = fgMaximo(mdif, nmdiga)
                            End If
                            sumapx = 0
                            sumapxr = 0
                            sumapxc = 0
                            Ecadif = edabe + nmdif
                            limite1 = Fintab - Ecadif - 1
                            Pension = Penben(j) * 0.2
                            If Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 15 Then
                                If nmdiga > 0 Then Pension = 0
                            End If
                            For i = 0 To limite1
                                edcadi = Ecadif + i
                                py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
                                nmdifi = nmdif + i
                                If nmdifi < nmdiga And nrel = 2 Then py = 1
                                If nmdifi < perdif Then py = 0
                                If nmdifi >= nmdiga Then Pension = penbase * Porcbe(j) * 0.2
                                If Nciare > 0 Then
                                    'ACEPTACION
                                    If oprea = "A" Or oprea = "D" Then
                                        If modore = "N" Then
                                            If nmdifi >= mesnoc And nmdifi < nmrea Then
                                                sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ nmdifi) * Pension
                                                sumapx = sumapx + (py * FactorPorRet / tmtce ^ nmdifi) * Pension
                                            End If
                                        Else
                                            If modore = "P" Then
                                                sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * Pension
                                                sumapx = sumapx + (py * Porret / tmtce ^ nmdifi) * Pension
                                            End If
                                        End If
                                    Else
                                        If modore = "N" Then
                                            sumapxr = sumapxr + (py * FacReaseg(nmdifi) / TmTcr ^ nmdifi) * Pension
                                            sumapxc = sumapxc + (py * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi) * Pension
                                            sumapx = sumapxc + sumapxr
                                        Else
                                            If modore = "P" Then
                                                sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ nmdifi) * Pension
                                                sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * Pension
                                                sumapx = sumapx + (py / tmtce ^ nmdifi) * Pension
                                            End If
                                        End If
                                    End If
                                Else
                                    If Nciare = 0 Then
                                        sumapxr = sumapxr + (py / tmtce ^ nmdifi) * Pension
                                        sumapx = sumapx + (py / tmtce ^ nmdifi) * Pension
                                    End If
                                End If
                            Next i
                            rmb2 = sumapx
                            rmb2r = sumapxr
                            rmb2c = sumapxc
                    
                            factoa = sumapx / Pension
                            factoar = sumapxr / Pension
                            factoac = sumapxc / Pension
                    
                            Rmben = rmb1 + rmb2
                            RmbenR = rmb1r + rmb2r
                            RmbenC = rmb1c + rmb2c
                        End If
                    Else
                        'RESERVA DE PENSIONES TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe < L24 Then
                                If edabe >= L18 Then
                                    mdif = L24 - edabe
                                Else
                                    mdif = L21 - edabe
                                End If
                                nmdif = mdif - 1
                                If Cober = 3 Or Cober = 9 Or Cober = 10 Or _
                                    Cober = 11 Or Cober = 12 Or Cober = 15 Then
                                    nmdif = fgMaximo(mdif, nmdiga)
                                    If nmdiga > 0 Then swg = "S"
                                End If
                                Pension = Penben(j)
                                For i = 0 To nmdif
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    If swg = "S" And i < nmdiga Then py = 1
                                    If i < perdif Then py = 0
                                    If i >= nmdiga Then Pension = penbase * Porcbe(j)
                                    If Nciare > 0 Then
                                        'ACEPTACION
                                        If oprea = "A" Or oprea = "D" Then
                                            If modore = "N" Then
                                                If i >= mesnoc And i < nmrea Then
                                                    sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ i) * Pension
                                                    sumapx = sumapx + (py * FactorPorRet / tmtce ^ i) * Pension
                                                End If
                                            Else
                                                If modore = "P" Then
                                                    sumapxr = sumapxr + (py * Porret / tmtce ^ i) * Pension
                                                    sumapx = sumapx + (py * Porret / tmtce ^ i) * Pension
                                                End If
                                            End If
                                        Else
                                            If modore = "N" Then
                                                sumapxr = sumapxr + (py * FacReaseg(i) / TmTcr ^ i) * Pension
                                                sumapxc = sumapxc + (py * (1 - FacReaseg(i)) / tmtce ^ i) * Pension
                                                sumapx = sumapxc + sumapxr
                                            Else
                                                If modore = "P" Then
                                                    sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ i) * Pension
                                                    sumapxr = sumapxr + (py * Porret / tmtce ^ i) * Pension
                                                    sumapx = sumapx + (py / tmtce ^ i) * Pension
                                                End If
                                            End If
                                        End If
                                    Else
                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + (py / tmtce ^ i) * Pension
                                            sumapx = sumapx + (py / tmtce ^ i) * Pension
                                        End If
                                    End If
                                Next i
                                Factor = sumapx / Pension
                                factorr = sumapxr / Pension
                                factorc = sumapxc / Pension
 
                                rmb1 = sumapx
                                rmb1r = sumapxr
                                rmb1c = sumapxc

                                Reser = sumapx
                                ReserR = sumapxr
                                ReserC = sumapxc
                                'RESERVA DE HIJOS INVALIDOS
                                If Coinbe(j) <> "N" Then
                                    kdif = mdif
                                    If Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 15 Then
                                        kdif = fgMaximo(mdif, nmdiga)
                                    End If
                                    edbedi = edabe + kdif
                                    limite3 = Fintab - edbedi - 1
                                    sumapx = 0
                                    sumapxr = 0
                                    sumapxc = 0
                                    Pension = Penben(j)
                                    paso = 0.15
                                    For i = 0 To limite3
                                        edalbe = edbedi + i
                                        nmdifi = i + kdif
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        If nmdifi < perdif Then py = 0
                                        If Navig > 1990 Then paso = Porcbe(j)
                                        If Navig = 1990 And Nmvig >= 8 Then paso = Porcbe(j)
                                        If nmdifi >= nmdiga Then Pension = penbase * paso
                                        If Nciare > 0 Then
                                            'ACEPTACION
                                            If oprea = "A" Or oprea = "D" Then
                                                If modore = "N" Then
                                                    If nmdifi >= mesnoc And nmdifi < nmrea Then
                                                        sumapxr = sumapxr + (py * FactorPorRet / tmtce ^ nmdifi) * Pension
                                                        sumapx = sumapx + (py * FactorPorRet / tmtce ^ nmdifi) * Pension
                                                    End If
                                                Else
                                                    If modore = "P" Then
                                                        sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * Pension
                                                        sumapx = sumapx + (py * Porret / tmtce ^ nmdifi) * Pension
                                                    End If
                                                End If
                                            Else
                                                If modore = "N" Then
                                                    sumapxc = sumapxc + (py * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi) * Pension
                                                    sumapxr = sumapxr + (py * FacReaseg(nmdifi) / TmTcr ^ nmdifi) * Pension
                                                    sumapx = sumapxc + sumapxr
                                                Else
                                                    If modore = "P" Then
                                                        sumapxc = sumapxc + (py * (1 - Porret) / tmtce ^ nmdifi) * Pension
                                                        sumapxr = sumapxr + (py * Porret / tmtce ^ nmdifi) * Pension
                                                        sumapx = sumapx + (py / tmtce ^ nmdifi) * Pension
                                                    End If
                                                End If
                                            End If
                                        Else
                                            If Nciare = 0 Then
                                                sumapxr = sumapxr + (py / tmtce ^ nmdifi) * Pension
                                                sumapx = sumapx + (py / tmtce ^ nmdifi) * Pension
                                            End If
                                        End If
                                    Next i
                                    rmb2 = sumapx
                                    rmb2r = sumapxr
                                    rmb2c = sumapxc
                                    factoa = sumapx / Pension
                                    factoar = sumapxr / Pension
                                    factoac = sumapxc / Pension
                                    Rmben = rmb1 + rmb2
                                    RmbenR = rmb1r + rmb2r
                                    RmbenC = rmb1c + rmb2c
                                Else
                                    If Coinbe(j) = "N" Then
                                        Rmben = rmb1
                                        RmbenR = rmb1r
                                        RmbenC = rmb1c
                                    End If
                                End If
                            End If  'Fin    EDABE < L24
                        End If  'Fin ncorbe(j) >= 30 And ncorbe(j) < 40
                    End If  'Fin    ncorbe(j) = 11 Or ncorbe(j) = 21
                End If  '10
            End If  'Fin DERPEN(j) <> 10 and ncorbe(j) <>99
            RmBenT = RmbenR + RmbenC
            If Nciare = 0 Then
                Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                Else
                    Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                End If
            End If
            Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
            Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
    
            rmpol = rmpol + RmBenT
            RmpolR = RmpolR + RmbenR
            RmpolC = RmpolC + RmbenC
            'Ani - Daj
            ''Grabar los datos de los Beneficiarios calculados
            'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
            'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
            'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
            'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
            ''vgQuery = vgQuery & "mto_cnREND = " & Str(Format(RMBEN - RMBENC, "#0.00")) & ", "
            'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
            'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(Rmben, "#0.00")) & " "
            'vgQuery = vgQuery & "where "
            'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
            'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
            'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
            'vgConexionBD.Execute (vgQuery)
            If Nciare = 0 Then
                vlBenRet = vlBenRet + 1
            Else
                If oprea = "A" Or oprea = "D" Then
                    vlBenRet = vlBenRet + 1
                Else
                    vlBenCed = vlBenCed + 1
                End If
            End If
        Next j
        If Nciare = 0 Then
            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
        Else
            If oprea = "A" Or oprea = "D" Then
                Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
            Else
                Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
            End If
        End If
        NumPro = NumPro + 1
        If Nciare = 0 Then
            vlPolRet = vlPolRet + 1
        Else
            If oprea = "A" Or oprea = "D" Then
                vlPolRet = vlPolRet + 1
            Else
                vlPolCed = vlPolCed + 1
            End If
        End If
        
        'Ani - Daj
'        vlPolRet = vlPolRet + 1
        
        ''Grabar los Totales en la Póliza
        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
        'vgConexionBD.Execute (vgQuery)
        
        If (Vuelta = 1) Then
            vlReservaOriginal = Format(rmpol, "#0.00")
        Else
            vlReservaCalculada = Format(rmpol, "#0.00")
        End If
        
        Exit Function
    Else
        'RESERVA MATEMATICA PARA VEJEZ E INVALIDEZ
        If Alt = 3 Or (Alt = 4 And Mesgar > 0) Then
            If topobe > 200 And Mesgar > 0 Then GoTo 1000
        End If
        For j = 1 To Nben
            'Definicion de pension del beneficiario
            'como pension de referencia por porcentaje de pension
            Penben(j) = penbase * Porcbe(j)
            RmBenT = 0: edabe = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            sumaqx = 0: Sumaqxr = 0: Sumaqxc = 0
            Rmcau = 0: RmcauC = 0: RmcauR = 0
            Cmcau = 0: CmcauR = 0: CmcauC = 0
            Factor = 0: factorr = 0: factorc = 0
            factoa = 0: factoar = 0: factoac = 0
            Rmben = 0: RmbenR = 0: RmbenC = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            Supxpy = 0: Supxpyr = 0: Supxpyc = 0
            rmb1 = 0: rmb1r = 0: rmb1c = 0
            rmb2 = 0: rmb2r = 0: rmb2c = 0
            If derpen(j) <> 10 Then
                Nubenp = Nubenp + 1
                'CALCULO DE LA RESERVA DEL AFILIADO
                If Ncorbe(j) = 99 And j = 1 Then
                    ni = 0
                    ni = fgCodInvalidez(Coinbe(j))
                    If ni = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    ns = 0
                    ns = fgSexo(Sexobe(j))
                    If ns = 0 Then
                        vgError = 1018
                        Exit Function
                    End If

                    'Calculo de edad del causante
                    edaca = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edaca <= 216 Then edaca = 216
                    If edaca > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    limite1 = Fintab - edaca - 1
                    For i = 0 To limite1
                        edacai = edaca + i
                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
                        If i < nmdiga Then px = 1
                        If i < perdif Then px = 0
                        edacas = edacai + 1
                        Qx = ((Lx(ns, ni, edacai) - Lx(ns, ni, edacas))) / Lx(ns, ni, edaca)
                        If i < perdif Then Qx = 0
                        If Nciare > 0 Then
                            'ACEPTACION
                            If oprea = "A" Or oprea = "D" Then
                                If modore = "N" Then
                                    If i >= mesnoc And i < nmrea Then
                                        sumapxr = (sumapxr + px * FactorPorRet / tmtce ^ i)
                                        Sumaqxr = (Sumaqxr + Qx * FactorPorRet / tmtce ^ (0.5 + i))
                                        sumapx = (sumapx + px * FactorPorRet / tmtce ^ i)
                                        sumaqx = (sumaqx + Qx * FactorPorRet / tmtce ^ (0.5 + i))
                                    End If
                                Else
                                    If modore = "P" Then
                                        sumapxr = sumapxr + px * Porret / tmtce ^ i
                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
                                        sumapx = sumapx + px * Porret / tmtce ^ i
                                        sumaqx = sumaqx + Qx * Porret / tmtce ^ (0.5 + i)
                                    End If
                                End If
                            Else
                                If modore = "N" Then
                                    sumapxr = sumapxr + px * FacReaseg(i) / TmTcr ^ i
                                    Sumaqxr = Sumaqxr + Qx * FacReaseg(i) / TmTcr ^ (0.5 + i)
                                    sumapxc = sumapxc + px * (1 - FacReaseg(i)) / tmtce ^ i
                                    Sumaqxc = Sumaqxc + Qx * (1 - FacReaseg(i)) / tmtce ^ (0.5 + i)
                                    sumapx = sumapxc + sumapxr
                                    sumaqx = Sumaqxc + Sumaqxr
                                Else
                                    If modore = "P" Then
                                        sumapxc = sumapxc + px * (1 - Porret) / tmtce ^ i
                                        Sumaqxc = Sumaqxc + Qx * (1 - Porret) / tmtce ^ (0.5 + i)
                                        sumapxr = sumapxr + px * Porret / tmtce ^ i
                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
                                        sumapx = sumapx + px / tmtce ^ i
                                        sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
                                    End If
                                End If
                            End If
                        Else
                            If Nciare = 0 Then
                                sumapxr = sumapxr + px / tmtce ^ i
                                Sumaqxr = Sumaqxr + Qx / tmtce ^ (0.5 + i)
                                sumapx = sumapx + px / tmtce ^ i
                                sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
                            End If
                        End If
                    Next i
                    Cmcau = GtoFun * sumaqx
                    CmcauR = GtoFun * Sumaqxr
                    CmcauC = GtoFun * Sumaqxc
                    RmcauR = sumapxr * Penben(j) + CmcauR
                    RmcauC = sumapxc * Penben(j) + CmcauC
                    Rmcau = sumapx * Penben(j) + Cmcau
                    rmpol = Rmcau
                    RmpolR = RmcauR
                    RmpolC = RmcauC
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmcauR
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmcauC
                    RmBenT = RmcauR + RmcauC
                    If Nciare = 0 Then
                        vlPolRet = vlPolRet + 1
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlPolRet = vlPolRet + 1
                            vlBenRet = vlBenRet + 1
                        Else
                            vlPolCed = vlPolCed + 1
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                    'NUMOR(J),NCORBE(J),SEXOBE(J),COINBE(J),NANBE(J),NMNBE(J),EDACA,PENBEN(J),SUMAPX,CMCAU,RMCAU
                    'Ani - Daj
                    
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edaca, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format((sumapx + sumapx_g), "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(Cmcau, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmcauC, "#0.00")) & ", "
                    ''vgQuery = vgQuery & "mto_cnREND = " & Str(Format(Rmcau - RMCAUC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmcau, "#0.00")) - CDbl(Format(RmcauC, "#0.00"))) & ", "
                    ''vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(Rmcau, "#0.00")) & " "
                    'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(rmpol, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                Else
                    'RESERVA DE LOS BENEFICIARIOS
                    nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de la edad del beneficiario
                    edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or Ncorbe(j) = 20 Or Ncorbe(j) = 21 Or _
                        Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                        'RESERVA VIDAS CONJUNTAS VITALICIAS
                        'Probabilidad del beneficiario solo
                        limite1 = Fintab - edabe - 1
                        For i = 0 To limite1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            If i < nmdiga Then py = 0
                            If i < perdif Then py = 0
                            If Nciare > 0 Then
                                'ACEPTACION
                                If oprea = "A" Or oprea = "D" Then
                                    If modore = "N" Then
                                        If i >= mesnoc And i < nmrea Then
                                            sumapxr = (sumapxr + py * FactorPorRet / tmtce ^ i)
                                            sumapx = (sumapx + py * FactorPorRet / tmtce ^ i)
                                        End If
                                    Else
                                        If modore = "P" Then
                                            sumapxr = sumapxr + py * Porret / tmtce ^ i
                                            sumapx = sumapx + py * Porret / tmtce ^ i
                                        End If
                                    End If
                                Else
                                    If modore = "N" Then
                                        sumapxr = sumapxr + py * FacReaseg(i) / TmTcr ^ i
                                        sumapxc = sumapxc + py * (1 - FacReaseg(i)) / tmtce ^ i
                                        sumapx = sumapxc + sumapxr
                                    Else
                                        If modore = "P" Then
                                            sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ i
                                            sumapxr = sumapxr + py * Porret / tmtce ^ i
                                            sumapx = sumapxc + sumapxr
                                        End If
                                    End If
                                End If
                            Else
                                If Nciare = 0 Then
                                    sumapxr = sumapxr + py / tmtce ^ i
                                    sumapx = sumapx + py / tmtce ^ i
                                End If
                            End If
                        Next i
                        'Probabilidad conjunta de causante y beneficiario
                        limite2 = Fintab - edaca - 1
                        limite = fgMinimo(limite1, limite2)
                        For i = 0 To limite
                            edalca = edaca + i
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                            If i < nmdiga Then py = 0
                            If i < perdif Then py = 0
                            If Nciare > 0 Then
                                'ACEPTACION
                                If oprea = "A" Or oprea = "D" Then
                                    If modore = "N" Then
                                        If i >= mesnoc And i < nmrea Then
                                            Supxpyr = (Supxpyr + (py * px * FactorPorRet) / tmtce ^ i)
                                            Supxpy = (Supxpy + (py * px * FactorPorRet) / tmtce ^ i)
                                        End If
                                    Else
                                        If modore = "P" Then
                                            Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
                                            Supxpy = Supxpy + (py * px) * Porret / tmtce ^ i
                                        End If
                                    End If
                                Else
                                    If modore = "N" Then
                                        Supxpyr = Supxpyr + (py * px) * FacReaseg(i) / TmTcr ^ i
                                        Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(i)) / tmtce ^ i
                                        Supxpy = Supxpyr + Supxpyc
                                    Else
                                        If modore = "P" Then
                                            Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ i
                                            Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
                                            Supxpy = Supxpy + (py * px) / tmtce ^ i
                                        End If
                                    End If
                                End If
                            Else
                                If Nciare = 0 Then
                                    Supxpyr = Supxpyr + (py * px) / tmtce ^ i
                                    Supxpy = Supxpy + (py * px) / tmtce ^ i
                                End If
                            End If
                        Next i
                        Factor = sumapx - Supxpy
                        factorr = sumapxr - Supxpyr
                        factorc = sumapxc - Supxpyc
                        rmb1 = Factor * Penben(j)
                        rmb1r = factorr * Penben(j)
                        rmb1c = factorc * Penben(j)
                        Rmben = rmb1
                        RmbenR = rmb1r
                        RmbenC = rmb1c
                        If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
                            'RESERVA POR DERECHO A ACRECER
                            edhm = fgEdad(Fechap, idp, Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
                            If Codcbe(j) <> "N" Then
                                If edhm > L24 Then
                                    nmdif = 0
                                Else
                                    If edhm >= L18 Then
                                        nmdif = L24 - edhm
                                    Else
                                        nmdif = L21 - edhm
                                    End If
                                End If
                                Ebedif = edabe + nmdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad del beneficiario solo
                                limite1 = Fintab - Ebedif - 1
                                For i = 0 To limite1
                                    edcadi = Ebedif + i
                                    py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
                                    inmdif = i + nmdif
                                    If inmdif < nmdiga Then py = 0
                                    If inmdif < perdif Then py = 0
                                    If Nciare > 0 Then
                                        'ACEPTACION
                                        If oprea = "A" Or oprea = "D" Then
                                            If modore = "N" Then
                                                If inmdif >= mesnoc And inmdif < nmrea Then
                                                    sumapxr = (sumapxr + py * FactorPorRet / tmtce ^ inmdif)
                                                    sumapx = (sumapx + py * FactorPorRet / tmtce ^ inmdif)
                                                End If
                                            Else
                                                If modore = "P" Then
                                                    sumapxr = sumapxr + py * Porret / tmtce ^ inmdif
                                                    sumapx = sumapx + py * Porret / tmtce ^ inmdif
                                                End If
                                            End If
                                        Else
                                            If modore = "N" Then
                                                sumapxr = sumapxr + py * FacReaseg(inmdif) / TmTcr ^ inmdif
                                                sumapxc = sumapxc + py * (1 - FacReaseg(inmdif)) / tmtce ^ inmdif
                                                sumapx = sumapxr + sumapxc
                                            Else
                                                If modore = "P" Then
                                                    sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ inmdif
                                                    sumapxr = sumapxr + py * Porret / tmtce ^ inmdif
                                                    sumapx = sumapx + py / tmtce ^ inmdif
                                                End If
                                            End If
                                        End If
                                    Else
                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py / tmtce ^ inmdif
                                            sumapx = sumapx + py / tmtce ^ inmdif
                                        End If
                                    End If
                                Next i
                                'Probabilidad conjunta del causante y beneficiario
                                Ecadif = edaca + nmdif
                                limite4 = Fintab - Ecadif - 1
                                limite = fgMinimo(limite1, limite4)
                                For i = 0 To limite
                                    edalca = Ecadif + i
                                    edalbe = Ebedif + i
                                    nmdifi = nmdif + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If nmdifi < nmdiga Then py = 0
                                    If nmdifi < perdif Then py = 0
                                    If Nciare > 0 Then
                                        'ACEPTACION
                                        If oprea = "A" Or oprea = "D" Then
                                            If modore = "N" Then
                                                If nmdifi >= mesnoc And nmdifi < nmrea Then
                                                    Supxpyr = Supxpyr + (py * px * FactorPorRet) / tmtce ^ nmdifi
                                                    Supxpy = Supxpy + (py * px * FactorPorRet) / (tmtce ^ nmdifi)
                                                End If
                                            Else
                                                If modore = "P" Then
                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
                                                    Supxpy = Supxpy + (py * px) * Porret / (tmtce ^ nmdifi)
                                                End If
                                            End If
                                        Else
                                            If modore = "N" Then
                                                Supxpyr = Supxpyr + (py * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
                                                Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
                                                Supxpy = Supxpyr + Supxpyc
                                            Else
                                                If modore = "P" Then
                                                    Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ nmdifi
                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
                                                    Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
                                                End If
                                            End If
                                        End If
                                    Else
                                        If Nciare = 0 Then
                                            Supxpyr = Supxpyr + (py * px) / tmtce ^ nmdifi
                                            Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
                                        End If
                                    End If
                                Next i
                                vipen = 0.2 * Penben(j)
                                factoa = sumapx - Supxpy
                                factoar = sumapxr - Supxpyr
                                factoac = sumapxc - Supxpyc
                                rmb2 = factoa * vipen
                                rmb2r = factoar * vipen
                                rmb2c = factoac * vipen
                                Rmben = rmb1 + rmb2
                                RmbenR = rmb1r + rmb2r
                                RmbenC = rmb1c + rmb2c
                            End If  'Fin Codcbe(j) <> "N"
                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
                    Else
                        'RESERVA RENTAS TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe < L24 Then
                                If edabe >= L18 Then
                                    mdif = L24 - edabe
                                Else
                                    mdif = L21 - edabe
                                End If
                                nmdif = mdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad conjunta del causante y beneficiario
                                limite2 = Fintab - edaca
                                limite = fgMinimo(nmdif, limite2) - 1
                                For i = 0 To limite
                                    edalca = edaca + i
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If i < nmdiga Then py = 0
                                    If i < perdif Then py = 0
                                    If Nciare > 0 Then
                                        'ACEPTACION
                                        If oprea = "A" Or oprea = "D" Then
                                            If modore = "N" Then
                                                If i >= mesnoc And i < nmrea Then
                                                    sumapxr = sumapxr + py * FactorPorRet / tmtce ^ i
                                                    Supxpyr = Supxpyr + (py * px * FactorPorRet) / tmtce ^ i
                                                    sumapx = sumapx + py * FactorPorRet / tmtce ^ i
                                                    Supxpy = Supxpy + (py * px * FactorPorRet) / (tmtce ^ i)
                                                  
                                                End If
                                            Else
                                                If modore = "P" Then
                                                    sumapxr = sumapxr + py * Porret / tmtce ^ i
                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
                                                    sumapx = sumapx + py * Porret / tmtce ^ i
                                                    Supxpy = Supxpy + (py * px) * Porret / (tmtce ^ i)
                                                   
                                                End If
                                            End If
                                        Else
                                            If modore = "N" Then
                                                sumapxr = sumapxr + py * FacReaseg(i) / TmTcr ^ i
                                                Supxpyr = Supxpyr + (py * px) * FacReaseg(i) / TmTcr ^ i
                                                sumapxc = sumapxc + py * (1 - FacReaseg(i)) / tmtce ^ i
                                                Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(i)) / tmtce ^ i
                                                sumapx = sumapxr + sumapxc
                                                Supxpy = Supxpyr + Supxpyc
                                            Else
                                                If modore = "P" Then
                                                    sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ i
                                                    Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ i
                                                    sumapxr = sumapxr + py * Porret / tmtce ^ i
                                                    Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ i
                                                    sumapx = sumapx + py / tmtce ^ i
                                                    Supxpy = Supxpy + (py * px) / (tmtce ^ i)
                                                End If
                                            End If
                                        End If
                                    Else
                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py / tmtce ^ i
                                            Supxpyr = Supxpyr + (py * px) / tmtce ^ i
                                            sumapx = sumapx + py / tmtce ^ i
                                            Supxpy = Supxpy + (py * px) / (tmtce ^ i)
                                        End If
                                    End If
                                Next i
                                Factor = sumapx - Supxpy
                                factorr = sumapxr - Supxpyr
                                factorc = sumapxc - Supxpyc
                                rmb1 = Factor * Penben(j)
                                rmb1r = factorr * Penben(j)
                                rmb1c = factorc * Penben(j)
                                'RESERVA DEL HIJO INVALIDO
                                If Coinbe(j) <> "N" Then
                                    sumapx = 0: sumapxr = 0: sumapxc = 0
                                    Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                    'Probabilidad conjunta del causante y beneficiario
                                    edbedi = edabe + nmdif
                                    limite3 = Fintab - edbedi - 1
                                    limite4 = Fintab - (edaca + nmdif) - 1
                                    For i = 0 To limite3
                                        nmdifi = nmdif + i
                                        edalca = edaca + nmdif + i
                                        edalbe = edbedi + i
                                        edalca = fgMinimo(edalca, Fintab)
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                        If nmdifi < nmdiga Then py = 0
                                        If nmdifi < perdif Then py = 0
                                        If Nciare > 0 Then
                                            'ACEPTACION
                                            If oprea = "A" Or oprea = "D" Then
                                                If modore = "N" Then
                                                    If nmdifi >= mesnoc And nmdifi < nmrea Then
                                                        sumapxr = sumapxr + py * FactorPorRet / tmtce ^ nmdifi
                                                        Supxpyr = Supxpyr + (py * px * FactorPorRet) / tmtce ^ nmdifi
                                                        sumapx = sumapx + py * FactorPorRet / tmtce ^ nmdifi
                                                        Supxpy = Supxpy + (py * px * FactorPorRet) / (tmtce ^ nmdifi)
                                                    End If
                                                Else
                                                    If modore = "P" Then
                                                        sumapxr = sumapxr + py * Porret / tmtce ^ nmdifi
                                                        Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
                                                        sumapx = sumapx + py * Porret / tmtce ^ nmdifi
                                                        Supxpy = Supxpy + (py * px) * Porret / (tmtce ^ nmdifi)
                                                    End If
                                                End If
                                            Else
                                                If modore = "N" Then
                                                    sumapxr = sumapxr + py * FacReaseg(nmdifi) / TmTcr ^ nmdifi
                                                    Supxpyr = Supxpyr + (py * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
                                                    sumapxc = sumapxc + py * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
                                                    Supxpyc = Supxpyc + (py * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
                                                    sumapx = sumapxr + sumapxc
                                                    Supxpy = Supxpyr + Supxpyc
                                                Else
                                                    If modore = "P" Then
                                                        sumapxc = sumapxc + py * (1 - Porret) / tmtce ^ nmdifi
                                                        Supxpyc = Supxpyc + (py * px) * (1 - Porret) / tmtce ^ nmdifi
                                                        sumapxr = sumapxr + py * Porret / tmtce ^ nmdifi
                                                        Supxpyr = Supxpyr + (py * px) * Porret / tmtce ^ nmdifi
                                                        sumapx = sumapx + py / tmtce ^ nmdifi
                                                        Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
                                                    End If
                                                End If
                                            End If
                                        Else
                                            If Nciare = 0 Then
                                                sumapxr = sumapxr + py / tmtce ^ nmdifi
                                                Supxpyr = Supxpyr + (py * px) / tmtce ^ nmdifi
                                                sumapx = sumapx + py / tmtce ^ nmdifi
                                                Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
                                            End If
                                        End If
                                    Next i
                                    factoa = sumapx - Supxpy
                                    factoar = sumapxr - Supxpyr
                                    factoac = sumapxc - Supxpyc
                                    vipen = penbase * 0.15
                                    If Navig = 1990 And Nmvig >= 8 Then vipen = Penben(j)
                                    If Navig > 1990 Then vipen = Penben(j)
                                    Rmben = rmb1 + factoa * vipen
                                    RmbenR = rmb1r + factoar * vipen
                                    RmbenC = rmb1c + factoac * vipen
                                Else
                                    If Coinbe(j) = "N" Then
                                        Rmben = rmb1
                                        RmbenR = rmb1r
                                        RmbenC = rmb1c
                                    End If
                                End If  'Fin    coinbe(j) <> "N"
                            End If  'Fin    Edabe < L24
                        End If  'Fin    ncorbe(j) >= 30 And ncorbe(j) < 40
                    End If  'Fin ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
                    rmpol = rmpol + Rmben
                    RmpolR = RmpolR + RmbenR
                    RmpolC = RmpolC + RmbenC
                    RmBenT = RmbenR + RmbenC
                    'Ani - Dani
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                    If Nciare = 0 Then
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlBenRet = vlBenRet + 1
                        Else
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                End If  'Fin Ncorbe(j) = 99 And j = 1
            End If  'Fin
        Next j
            NumPro = NumPro + 1
            'Ani - Dani
            
        ''Grabar los Totales en la Póliza
        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
        'vgConexionBD.Execute (vgQuery)
        
        If (Vuelta = 1) Then
            vlReservaOriginal = Format(rmpol, "#0.00")
        Else
            vlReservaCalculada = Format(rmpol, "#0.00")
        End If
        
    Exit Function
        'PORCENTAJE MAYOR AL 100%
1000:
        For ib = 1 To Fintab
            flumax(ib) = 0
        Next ib
        'FLUJOS DE RENTAS VITALICIAS DE VEJEZ E INVALIDEZ
        For j = 1 To Nben
            If derpen(j) <> 10 Then
                Penben(j) = penbase * Porcbe(j)
                Nbpr = Nbpr + 1
                'CALCULO DE LA RESERVA DEL AFILIADO
                If Ncorbe(j) = 99 And j = 1 Then
                    ni = 0
                    ni = fgCodInvalidez(Coinbe(j))
                    If ni = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    ns = 0
                    ns = fgSexo(Sexobe(j))
                    If ns = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de edad del causante
                    edaca = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edaca <= 216 Then edaca = 216
                    If edaca > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    limite1 = Fintab - edaca - 1
                    For i = 0 To limite1
                        imas1 = i + 1
                        edacai = edaca + i
                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
                        edacas = edacai + 1
                        flumax(imas1) = flumax(imas1) + (px * Penben(j))
                    Next i
                Else
                    'RESERVA DE LOS BENEFICIARIOS
                    nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de la edad del beneficiario
                    edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or Ncorbe(j) = 20 Or Ncorbe(j) = 21 Or _
                        Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                        'FLUJOS DE VIDAS CONJUNTAS VITALICIAS
                        'Probabilidad del beneficiario solo
                        limite1 = Fintab - edabe - 1
                        For i = 0 To limite1
                            imas1 = i + 1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            flumax(imas1) = flumax(imas1) + (py * Penben(j))
                        Next i
                        'Probabilidad conjunta de causante y beneficiario
                        limite2 = Fintab - edaca - 1
                        limite = fgMinimo(limite1, limite2)
                        For i = 0 To limite
                            imas1 = i + 1
                            edalca = edaca + i
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                            flumax(imas1) = flumax(imas1) - (py * px * Penben(j))
                        Next i
                        If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
                            'FLUJO POR DERECHO A ACRECER
                            edhm = fgEdad(Fechap, idp, Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
                            If Codcbe(j) <> "N" Then
                                If edhm > L24 Then
                                    nmdif = 0
                                Else
                                    If edhm >= L18 Then
                                        nmdif = L24 - edhm
                                    Else
                                        nmdif = L21 - edhm
                                    End If
                                End If
                                Ebedif = edabe + nmdif
                                'Probabilidad del beneficiario solo
                                limite1 = Fintab - Ebedif - 1
                                For i = 0 To limite1
                                    edalbe = Ebedif + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    nmdifi = nmdif + i
                                    imas1 = nmdifi + 1
                                    flumax(imas1) = flumax(imas1) + (py * Penben(j) * 0.2)
                                Next i
                                'Probabilidad conjunta del causante y beneficiario
                                Ecadif = edaca + nmdif
                                limite4 = Fintab - Ecadif - 1
                                limite = fgMinimo(limite1, limite4)
                                For i = 0 To limite
                                    edalca = Ecadif + i
                                    edalbe = Ebedif + i
                                    nmdifi = nmdif + i
                                    imas1 = nmdifi + 1
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    flumax(imas1) = flumax(imas1) - (py * px * Penben(j) * 0.2)
                                Next i
                            End If  'Fin    codcbe(j) <> "N"
                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
                    Else
                        'RESERVA RENTAS TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe < L24 Then
                                If edabe >= L18 Then
                                    mdif = L24 - edabe
                                Else
                                    mdif = L21 - edabe
                                End If
                                nmdif = mdif
                                'Probabilidad conjunta del causante y beneficiario
                                limite2 = Fintab - edaca
                                limite = fgMinimo(nmdif, limite2) - 1
                                For i = 0 To limite
                                    imas1 = i + 1
                                    edalca = edaca + i
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    flumax(imas1) = flumax(imas1) + (py * Penben(j) - py * px * Penben(j))
                                Next i
                                'RESERVA DEL HIJO INVALIDO
                                If Coinbe(j) <> "N" Then
                                    'Probabilidad conjunta del causante y beneficiario
                                    edbedi = edabe + nmdif
                                    limite3 = Fintab - edbedi - 1
                                    limite4 = Fintab - (edaca + nmdif) - 1
                                    For i = 0 To limite3
                                        nmdifi = nmdif + i
                                        imas1 = nmdifi + 1
                                        edalca = edaca + nmdif + i
                                        edalbe = edbedi + i
                                        edalca = fgMinimo(edalca, Fintab)
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                        vipen = penbase * 0.15
                                        If Navig = 1990 And Nmvig >= 8 Then vipen = penbase * Porcbe(j)
                                        If Navig > 1990 Then vipen = penbase * Porcbe(j)
                                        flumax(imas1) = flumax(imas1) + (py - py * px) * vipen
                                    Next i
                                End If  'Fin    coinbe(j) <> "N"
                            End If  'Fin    Edabe < L24
                        End If  'Fin    (ncorbe(j) >= 30 And ncorbe(j) < 40)
                    End If  'Fin    ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or
                End If  'Fin    ncorbe(j) = 99 And j = 1
            End If  'fIN DERECHO A PENSION
        Next j
        If topobe > 200 Then
            For ll = 1 To nmdiga
                If (penbase > flumax(ll)) Then GoTo 1003
            Next ll
1003:       limgar = ll
        End If
        
        'CALCULO DE RESERVA BASE A POLIZAS CON PORCENTAJE MAYOR AL 100%
        'RESERVA MATEMATICA PARA VEJEZ E INVALIDEZ
        For j = 1 To Nben
            Penben(j) = penbase * Porcbe(j)
            edabe = 0: RmBenT = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            sumaqx = 0: Sumaqxr = 0: Sumaqxc = 0
            Rmcau = 0: RmcauC = 0: RmcauR = 0
            Cmcau = 0: CmcauR = 0: CmcauC = 0
            Factor = 0: factorr = 0: factorc = 0
            factoa = 0: factoar = 0: factoac = 0
            Rmben = 0: RmbenR = 0: RmbenC = 0
            sumapx = 0: sumapxr = 0: sumapxc = 0
            Supxpy = 0: Supxpyr = 0: Supxpyc = 0
            rmb1 = 0: rmb1r = 0: rmb1c = 0
            rmb2 = 0: rmb2r = 0: rmb2c = 0
            If derpen(j) <> 10 Then
                Nubenp = Nubenp + 1
                'CALCULO DE LA RESERVA DEL AFILIADO
                If Ncorbe(j) = 99 And j = 1 Then
                    ni = 0
                    ni = fgCodInvalidez(Coinbe(j))
                    If ni = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    ns = 0
                    ns = fgSexo(Sexobe(j))
                    If ns = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de edad del causante
                    edaca = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edaca <= 216 Then edaca = 216
                    If edaca > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    limite1 = Fintab - edaca - 1
                    For i = 0 To limite1
                        edacai = edaca + i
                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
                        If i < limgar Then
                            px1 = px
                        Else
                            If i >= limgar And i < nmdiga Then
                                px1 = 1
                            Else
                                px1 = px
                            End If
                        End If
                        If i < perdif Then px1 = 0
                        edacas = edacai + 1
                        Qx = ((Lx(ns, ni, edacai) - Lx(ns, ni, edacas))) / Lx(ns, ni, edaca)
                        If i < perdif Then Qx = 0
                        If Nciare > 0 Then
                            'ACEPTACION
                            If oprea = "A" Or oprea = "D" Then
                                If modore = "N" Then
                                    If i >= mesnoc And i < nmrea Then
                                        sumapxr = sumapxr + px1 * FactorPorRet / tmtce ^ i
                                        Sumaqxr = Sumaqxr + Qx * FactorPorRet / tmtce ^ (0.5 + i)
                                        sumapx = sumapx + px1 * FactorPorRet / tmtce ^ i
                                        sumaqx = sumaqx + Qx * FactorPorRet / tmtce ^ (0.5 + i)
                                    End If
                                Else
                                    If modore = "P" Then
                                        sumapxr = sumapxr + px1 * Porret / tmtce ^ i
                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
                                        sumapx = sumapx + px1 * Porret / tmtce ^ i
                                        sumaqx = sumaqx + Qx * Porret / tmtce ^ (0.5 + i)
                                    End If
                                End If
                            Else
                                If modore = "N" Then
                                    sumapxr = sumapxr + px1 * FacReaseg(i) / TmTcr ^ i
                                    Sumaqxr = Sumaqxr + Qx * FacReaseg(i) / TmTcr ^ (0.5 + i)
                                    sumapxc = sumapxc + px1 * (1 - FacReaseg(i)) / tmtce ^ i
                                    Sumaqxc = Sumaqxc + Qx * (1 - FacReaseg(i)) / tmtce ^ (0.5 + i)
                                    sumapx = sumapxr + sumapxc
                                    sumaqx = Sumaqxr + Sumaqxc
                                Else
                                    If modore = "P" Then
                                        sumapxc = sumapxc + px1 * (1 - Porret) / tmtce ^ i
                                        Sumaqxc = Sumaqxc + Qx * (1 - Porret) / tmtce ^ (0.5 + i)
                                        sumapxr = sumapxr + px1 * Porret / tmtce ^ i
                                        Sumaqxr = Sumaqxr + Qx * Porret / tmtce ^ (0.5 + i)
                                        sumapx = sumapx + px1 / tmtce ^ i
                                        sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
                                    End If
                                End If
                            End If
                        Else
                            If Nciare = 0 Then
                                sumapxr = sumapxr + px1 / tmtce ^ i
                                Sumaqxr = Sumaqxr + Qx / tmtce ^ (0.5 + i)
                                sumapx = sumapx + px1 / tmtce ^ i
                                sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
                            End If
                        End If
                    Next i
                    Cmcau = GtoFun * sumaqx
                    CmcauR = GtoFun * Sumaqxr
                    CmcauC = GtoFun * Sumaqxc
                    RmcauR = sumapxr * Penben(j) + CmcauR
                    RmcauC = sumapxc * Penben(j) + CmcauC
                    Rmcau = sumapx * Penben(j) + Cmcau
                    rmpol = Rmcau
                    RmpolR = RmcauR
                    RmpolC = RmcauC
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 1) = Rmcob(nv, 2, ncobe, 1) + 1
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmcauR
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmcauC
                    RmBenT = RmcauR + RmcauC
                    If Nciare = 0 Then
                        vlPolRet = vlPolRet + 1
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlPolRet = vlPolRet + 1
                            vlBenRet = vlBenRet + 1
                        Else
                            vlPolCed = vlPolCed + 1
                            vlBenCed = vlBenCed + 1
                        End If
                    End If
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                Else
                    'RESERVA DE LOS BENEFICIARIOS
                    nibe = 0
                    nibe = fgCodInvalidez(Coinbe(j))
                    If nibe = 0 Then
                        vgError = 1017
                        Exit Function
                    End If
                    nsbe = 0
                    nsbe = fgSexo(Sexobe(j))
                    If nsbe = 0 Then
                        vgError = 1018
                        Exit Function
                    End If
                    'Calculo de la edad del beneficiario
                    edabe = fgEdad(Fechap, idp, Nanbe(j), Nmnbe(j), Ndnbe(j), Ncorbe(j))
                    If edabe < 1 Then edabe = 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or _
                        Ncorbe(j) = 20 Or Ncorbe(j) = 21 Or _
                        Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And (Coinbe(j) <> "N")) Then
                        'RESERVA VIDAS CONJUNTAS VITALICIAS
                        'Probabilidad del beneficiario solo
                        limite1 = Fintab - edabe - 1
                        For i = 0 To limite1
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            If i < limgar Then
                              py1 = py
                            Else
                                If (i >= limgar And i < nmdiga) Then
                                    py1 = 0
                                Else
                                    py1 = py
                                End If
                            End If
                            If i < perdif Then py1 = 0
                            If Nciare > 0 Then
                                'ACEPTACION
                                If oprea = "A" Or oprea = "D" Then
                                    If modore = "N" Then
                                        If i >= mesnoc And i < nmrea Then
                                            sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ i
                                            sumapx = sumapx + py1 * FactorPorRet / tmtce ^ i
                                        End If
                                    Else
                                        If modore = "P" Then
                                            sumapxr = sumapxr + py1 * Porret / tmtce ^ i
                                            sumapx = sumapx + py1 * Porret / tmtce ^ i
                                        End If
                                    End If
                                Else
                                    If modore = "N" Then
                                        sumapxr = sumapxr + py1 * FacReaseg(i) / TmTcr ^ i
                                        sumapxc = sumapxc + py1 * (1 - FacReaseg(i)) / tmtce ^ i
                                        sumapx = sumapxr + sumapxc
                                    Else
                                        If modore = "P" Then
                                            sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ i
                                            sumapxr = sumapxr + py1 * Porret / tmtce ^ i
                                            sumapx = sumapx + py1 / tmtce ^ i
                                        End If
                                    End If
                                End If
                            Else
                                If Nciare = 0 Then
                                    sumapxr = sumapxr + py1 / tmtce ^ i
                                    sumapx = sumapx + py1 / tmtce ^ i
                                End If
                            End If
                        Next i
                        'Probabilidad conjunta de causante y beneficiario
                        limite2 = Fintab - edaca - 1
                        limite = fgMinimo(limite1, limite2)
                        For i = 0 To limite
                            edalca = edaca + i
                            edalbe = edabe + i
                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                    
                            If i < limgar Then
                                py1 = py
                            Else
                                If i >= limgar And i < nmdiga Then
                                    py1 = 0
                                Else
                                    py1 = py
                                End If
                            End If
                            If i < perdif Then py1 = 0
                            If Nciare > 0 Then
                                'ACEPTACION
                                If oprea = "A" Or oprea = "D" Then
                                    If modore = "N" Then
                                        If i >= mesnoc And i < nmrea Then
                                            Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ i
                                            Supxpy = Supxpy + (py1 * px * FactorPorRet) / tmtce ^ i
                                        End If
                                    Else
                                        If modore = "P" Then
                                            Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
                                            Supxpy = Supxpy + (py1 * px) * Porret / tmtce ^ i
                                        End If
                                    End If
                                Else
                                    If modore = "N" Then
                                        Supxpyr = Supxpyr + (py1 * px) * FacReaseg(i) / TmTcr ^ i
                                        Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(i)) / tmtce ^ i
                                        Supxpy = Supxpyr + Supxpyc
                                    Else
                                        If modore = "P" Then
                                            Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ i
                                            Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
                                            Supxpy = Supxpy + (py1 * px) / tmtce ^ i
                                        End If
                                    End If
                                End If
                            Else
                                If Nciare = 0 Then
                                    Supxpyr = Supxpyr + (py1 * px) / tmtce ^ i
                                    Supxpy = Supxpy + (py1 * px) / tmtce ^ i
                                End If
                            End If
                        Next i
                        Factor = sumapx - Supxpy
                        factorr = sumapxr - Supxpyr
                        factorc = sumapxc - Supxpyc
                        rmb1 = Factor * Penben(j)
                        rmb1r = factorr * Penben(j)
                        rmb1c = factorc * Penben(j)
                        Rmben = rmb1: RmbenR = rmb1r: RmbenC = rmb1c
                        'RESERVA POR DERECHO A ACRECER
                        If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
                            edhm = fgEdad(Fechap, idp, Ijam(j), Ijmn(j), ijdn(j), Ncorbe(j))
                            If Codcbe(j) <> "N" Then
                                If edhm > L24 Then
                                    nmdif = 0
                                Else
                                    If edhm >= L18 Then
                                        nmdif = L24 - edhm
                                    Else
                                        nmdif = L21 - edhm
                                    End If
                                End If
                                Ebedif = edabe + nmdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad del beneficiario solo
                                limite1 = Fintab - Ebedif - 1
                                For i = 0 To limite1
                                    edcadi = Ebedif + i
                                    py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
                                    inmdif = i + nmdif
                                    If inmdif < limgar Then
                                        py1 = py
                                    Else
                                        If inmdif >= limgar And inmdif < nmdiga Then
                                            py1 = 0
                                        Else
                                            py1 = py
                                        End If
                                    End If
                                    If inmdif < perdif Then py1 = 0
                                    If Nciare > 0 Then
                                        'ACEPTACION
                                        If oprea = "A" Or oprea = "D" Then
                                            If modore = "N" Then
                                                If inmdif >= mesnoc And inmdif < nmrea Then
                                                    sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ inmdif
                                                    sumapx = sumapx + py1 * FactorPorRet / tmtce ^ inmdif
                                                End If
                                            Else
                                                If modore = "P" Then
                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ inmdif
                                                    sumapx = sumapx + py1 * Porret / tmtce ^ inmdif
                                                End If
                                            End If
                                        Else
                                            If modore = "N" Then
                                                sumapxr = sumapxr + py1 * FacReaseg(inmdif) / TmTcr ^ inmdif
                                                sumapxc = sumapxc + py1 * (1 - FacReaseg(inmdif)) / tmtce ^ inmdif
                                                sumapx = sumapxc + sumapxr
                                            Else
                                                If modore = "P" Then
                                                    sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ inmdif
                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ inmdif
                                                    sumapx = sumapx + py1 / tmtce ^ inmdif
                                                End If
                                            End If
                                        End If
                                    Else
                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py1 / tmtce ^ inmdif
                                            sumapx = sumapx + py1 / tmtce ^ inmdif
                                        End If
                                    End If
                                Next i
                                'Probabilidad conjunta del causante y beneficiario
                                Ecadif = edaca + nmdif
                                limite4 = Fintab - Ecadif - 1
                                limite = fgMinimo(limite1, limite4)
                                For i = 0 To limite
                                    edalca = Ecadif + i
                                    edalbe = Ebedif + i
                                    nmdifi = nmdif + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If nmdifi < limgar Then
                                        py1 = py
                                    Else
                                        If nmdifi >= limgar And nmdifi < nmdiga Then
                                            py1 = 0
                                        Else
                                            py1 = py
                                        End If
                                    End If
                                    If nmdifi < perdif Then py1 = 0
                                    If Nciare > 0 Then
                                        'ACEPTACION
                                        If oprea = "A" Or oprea = "D" Then
                                            If modore = "N" Then
                                                If nmdifi >= mesnoc And nmdifi < nmrea Then
                                                    Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ nmdifi
                                                    Supxpy = Supxpy + (py1 * px * FactorPorRet) / (tmtce ^ nmdifi)
                                                End If
                                            Else
                                                If modore = "P" Then
                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
                                                    Supxpy = Supxpy + (py1 * px) * Porret / (tmtce ^ nmdifi)
                                                End If
                                            End If
                                        Else
                                            If modore = "N" Then
                                                Supxpyr = Supxpyr + (py1 * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
                                                Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
                                                Supxpy = Supxpyr + Supxpyc
                                            Else
                                                If modore = "P" Then
                                                    Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ nmdifi
                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
                                                    Supxpy = Supxpy + (py1 * px) / tmtce ^ nmdifi
                                                End If
                                            End If
                                        End If
                                    Else
                                        If Nciare = 0 Then
                                            Supxpyr = Supxpyr + (py1 * px) / tmtce ^ nmdifi
                                            Supxpy = Supxpy + (py1 * px) / (tmtce ^ nmdifi)
                                        End If
                                    End If
                                Next i
                                vipen = 0.2 * Penben(j)
                                factoa = sumapx - Supxpy
                                factoar = sumapxr - Supxpyr
                                factoac = sumapxc - Supxpyc
                                rmb2 = factoa * vipen
                                rmb2r = factoar * vipen
                                rmb2c = factoac * vipen
                                Rmben = rmb1 + rmb2
                                RmbenR = rmb1r + rmb2r
                                RmbenC = rmb1c + rmb2c
                            End If  'Fin CODCBE(j) <> "N"
                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
                    Else
                        'RESERVA RENTAS TEMPORALES
                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
                            If edabe < L24 Then
                                If edabe >= L18 Then
                                    mdif = L24 - edabe
                                Else
                                    mdif = L21 - edabe
                                End If
                                nmdif = mdif
                                sumapx = 0: sumapxr = 0: sumapxc = 0
                                Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                'Probabilidad conjunta del causante y beneficiario
                                limite2 = Fintab - edaca
                                limite = fgMinimo(nmdif, limite2) - 1
                                For i = 0 To limite
                                    edalca = edaca + i
                                    edalbe = edabe + i
                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                    If i < limgar Then
                                      py1 = py
                                    Else
                                        If i >= limgar And i < nmdiga Then
                                            py1 = 0
                                        Else
                                            py1 = py
                                        End If
                                    End If
                                    If i < perdif Then py1 = 0
                                    If Nciare > 0 Then
                                        'ACEPTACION
                                        If oprea = "A" Or oprea = "D" Then
                                            If modore = "N" Then
                                                If i >= mesnoc And i < nmrea Then
                                                    sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ i
                                                    Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ i
                                                    sumapx = sumapx + py1 * FactorPorRet / tmtce ^ i
                                                    Supxpy = Supxpy + (py1 * px * FactorPorRet) / (tmtce ^ i)
                                                End If
                                            Else
                                                If modore = "P" Then
                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ i
                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
                                                    sumapx = sumapx + py1 * Porret / tmtce ^ i
                                                    Supxpy = Supxpy + (py1 * px) * Porret / (tmtce ^ i)
                                                End If
                                            End If
                                        Else
                                            If modore = "N" Then
                                                sumapxr = sumapxr + py1 * FacReaseg(i) / TmTcr ^ i
                                                Supxpyr = Supxpyr + (py1 * px) * FacReaseg(i) / TmTcr ^ i
                                                sumapxc = sumapxc + py1 * (1 - FacReaseg(i)) / tmtce ^ i
                                                Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(i)) / tmtce ^ i
                                                sumapx = sumapxr + sumapxc
                                                Supxpy = Supxpyr + Supxpyc
                                            Else
                                                If modore = "P" Then
                                                    sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ i
                                                    Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ i
                                                    sumapxr = sumapxr + py1 * Porret / tmtce ^ i
                                                    Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ i
                                                    sumapx = sumapx + py1 / tmtce ^ i
                                                    Supxpy = Supxpy + (py1 * px) / tmtce ^ i
                                                End If
                                            End If
                                        End If
                                    Else
                                        If Nciare = 0 Then
                                            sumapxr = sumapxr + py1 / tmtce ^ i
                                            Supxpyr = Supxpyr + (py1 * px) / tmtce ^ i
                                            sumapx = sumapx + py1 / tmtce ^ i
                                            Supxpy = Supxpy + (py1 * px) / tmtce ^ i
                                        End If
                                    End If
                                Next i
                                Factor = sumapx - Supxpy
                                factorr = sumapxr - Supxpyr
                                factorc = sumapxc - Supxpyc
                                rmb1 = Factor * Penben(j)
                                rmb1r = factorr * Penben(j)
                                rmb1c = factorc * Penben(j)
                                'RESERVA DEL HIJO INVALIDO
                                If Coinbe(j) <> "N" Then
                                    sumapx = 0: sumapxr = 0: sumapxc = 0
                                    Supxpy = 0: Supxpyr = 0: Supxpyc = 0
                                    'Probabilidad conjunta del causante y beneficiario
                                    edbedi = edabe + nmdif
                                    limite3 = Fintab - edbedi - 1
                                    limite4 = Fintab - (edaca + nmdif) - 1
                                    For i = 0 To limite3
                                        nmdifi = nmdif + i
                                        edalca = edaca + nmdif + i
                                        edalbe = edbedi + i
                                        edalca = fgMinimo(edalca, Fintab)
                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
                                        If nmdifi < limgar Then
                                            py1 = py
                                        Else
                                            If nmdifi >= limgar And nmdifi < nmdiga Then
                                                py1 = 0
                                            Else
                                                py1 = py
                                            End If
                                        End If
                                        If nmdifi < perdif Then py1 = 0
                                        If Nciare > 0 Then
                                            'ACEPTACION
                                            If oprea = "A" Or oprea = "D" Then
                                                If modore = "N" Then
                                                    If nmdifi >= mesnoc And nmdifi < nmrea Then
                                                        sumapxr = sumapxr + py1 * FactorPorRet / tmtce ^ nmdifi
                                                        Supxpyr = Supxpyr + (py1 * px * FactorPorRet) / tmtce ^ nmdifi
                                                        sumapx = sumapx + py1 * FactorPorRet / tmtce ^ nmdifi
                                                        Supxpy = Supxpy + (py1 * px * FactorPorRet) / (tmtce ^ nmdifi)
                                                    End If
                                                Else
                                                    If modore = "P" Then
                                                        sumapxr = sumapxr + py1 * Porret / tmtce ^ nmdifi
                                                        Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
                                                        sumapx = sumapx + py1 * Porret / tmtce ^ nmdifi
                                                        Supxpy = Supxpy + (py1 * px) * Porret / (tmtce ^ nmdifi)
                                                    End If
                                                End If
                                            Else
                                                If modore = "N" Then
                                                    sumapxr = sumapxr + py1 * FacReaseg(nmdifi) / TmTcr ^ nmdifi
                                                    Supxpyr = Supxpyr + (py1 * px) * FacReaseg(nmdifi) / TmTcr ^ nmdifi
                                                    sumapxc = sumapxc + py1 * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
                                                    Supxpyc = Supxpyc + (py1 * px) * (1 - FacReaseg(nmdifi)) / tmtce ^ nmdifi
                                                    sumapx = sumapxr + sumapxc
                                                    Supxpy = Supxpyr + Supxpyc
                                                Else
                                                    If modore = "P" Then
                                                        sumapxc = sumapxc + py1 * (1 - Porret) / tmtce ^ nmdifi
                                                        Supxpyc = Supxpyc + (py1 * px) * (1 - Porret) / tmtce ^ nmdifi
                                                        sumapxr = sumapxr + py1 * Porret / tmtce ^ nmdifi
                                                        Supxpyr = Supxpyr + (py1 * px) * Porret / tmtce ^ nmdifi
                                                        sumapx = sumapx + py1 / tmtce ^ nmdifi
                                                        Supxpy = Supxpy + (py1 * px) / tmtce ^ nmdifi
                                                    End If
                                                End If
                                            End If
                                        Else
                                            If Nciare = 0 Then
                                                sumapxr = sumapxr + py1 / tmtce ^ nmdifi
                                                Supxpyr = Supxpyr + (py1 * px) / tmtce ^ nmdifi
                                                sumapx = sumapx + py1 / tmtce ^ nmdifi
                                                Supxpy = Supxpy + (py1 * px) / (tmtce ^ nmdifi)
                                            End If
                                        End If
                                    Next i
                                    factoa = sumapx - Supxpy
                                    factoar = sumapxr - Supxpyr
                                    factoac = sumapxc - Supxpyc
                                    vipen = penbase * 0.15
                                    
                                    If Navig = 1990 And Nmvig >= 8 Then vipen = Penben(j)
                                    If Navig > 1990 Then vipen = Penben(j)
                                    
                                    Rmben = rmb1 + factoa * vipen
                                    RmbenR = rmb1r + factoar * vipen
                                    RmbenC = rmb1c + factoac * vipen
                                Else
                                    If Coinbe(j) = "N" Then
                                        Rmben = rmb1
                                        RmbenR = rmb1r
                                        RmbenC = rmb1c
                                    End If
                                End If
                            End If  'Fin EDABE < L24
                        End If  'Fin ncorbe(j) >= 30 And ncorbe(j) < 40
                    End If  'Fin ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or _
                    RmBenT = RmbenR + RmbenC
                    If Nciare = 0 Then
                        Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
                        Else
                            Rmcob(nv, 2, ncobe, 2) = Rmcob(nv, 2, ncobe, 2) + 1
                        End If
                    End If
                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
                    rmpol = rmpol + Rmben
                    RmpolR = RmpolR + RmbenR
                    RmpolC = RmpolC + RmbenC
                    'Ani - Dani
                    
                    ''Grabar los datos de los Beneficiarios calculados
                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
                    'vgQuery = vgQuery & "where "
                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
                    'vgConexionBD.Execute (vgQuery)
                    If Nciare = 0 Then
                        vlBenRet = vlBenRet + 1
                    Else
                        If oprea = "A" Or oprea = "D" Then
                            vlBenRet = vlBenRet + 1
                        Else
                            vlBenCed = vlBenCed + 1
                    End If
                    End If
                End If  'Fin    ncorbe(j) = 99 And j = 1
            End If  'FIN    If derpen(j) = 10 Then
        Next j
        NumPro = NumPro + 1
        'Ani - Dani
        ''Grabar los Totales en la Póliza
        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
        'vgConexionBD.Execute (vgQuery)
    
        If (Vuelta = 1) Then
            vlReservaOriginal = Format(rmpol, "#0.00")
        Else
            vlReservaCalculada = Format(rmpol, "#0.00")
        End If
    
    End If  'Fin Sob/Vejez/inval
Exit Function
Err_Base:
    'Screen.MousePointer = 0
    Select Case Err
        Case Else
        'ProgressBar.Value = 0
        MsgBox "Error Grave en la Póliza '" & Npolca & "' : [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
        vgError = 5000
    End Select
End Function

Function fgBasDos_20070925(iCartera, Npolca, Numend, Nap, Nmp, Ndp, Nben, Cober, vigpen, _
Navig, Nmvig, Ndvig, SalCta, penbase, Indi, Mesdif, Alt, Mesgar, _
Nciare, oprea, modore, Iare, Imre, Idre, Porret, tce, Tvta, Tcrj, _
GtoFun, IVigrea_d, IVigrea_m, IVigrea_a, Vuelta)

''RESERVA TECNICA BASE DE RENTAS VITALICIAS
''TASA BASE PARA CADA UNA DE LAS POLIZAS
'
'Dim Numor(1 To 20)  As Integer, Ncorbe(1 To 20) As Integer
'Dim Nanbe(1 To 20) As Integer, Nmnbe(1 To 20) As Integer, Ndnbe(1 To 20) As Integer
'Dim Sexobe(1 To 20) As String
'Dim Coinbe(1 To 20) As String, Codcbe(1 To 20) As String
'Dim Ijam(1 To 20) As Integer, Ijmn(1 To 20) As Integer, ijdn(1 To 20) As Integer
'
'Dim igfh(1 To 20) As Integer
'Dim Derpen(1 To 20) As Integer
'Dim porceb(1 To 20) As Double, Porcbe(1 To 20) As Double, Penben(1 To 20) As Double
'Dim Npolbe(1 To 20) As String
'
'Dim swg As String
'Dim Ecadif As Long, edcadi As Long, nmdifi As Long, kdif As Long
'Dim edbedi As Long, limite3 As Long, edacai As Long, edacas As Long
'Dim edaca As Long, edabe As Long, edalca As Long, edalbe As Long
'
'Dim Fechan As Long, Fechap As Long
'Dim perdif As Long, diftem  As Long, difdia As Long
'Dim TmTcr As Double, tmtce As Double
'Dim Rmcob(1 To 3, 1 To 3, 1 To 5, 1 To 3) As Double
'Dim iagno As Integer, idbis As Integer, idp As Integer
'Dim numrec As Long, Nubenp As Long, NuBenL As Long, NumPro As Long
'Dim Npnv As Long
'
'Dim ncobe   As Integer, nv As Integer
'Dim nmdiga  As Long, mescon As Long, mesnoc As Long
'
'Dim icont10 As Integer, icont20 As Integer, icont30 As Integer
'Dim icont35 As Integer, icont40 As Integer, icont77 As Integer
'
'Dim nrel As Integer, nibe As Integer, nsbe As Integer, ns As Integer, ni As Integer
'Dim limite1 As Long, edhm As Long, mdif As Long, nmdif As Long
'
'Dim limite2 As Long, limite As Long, Ebedif As Long, inmdif As Long
'Dim limite4 As Long, Nbpr As Long, imas1 As Long, ll As Long
'Dim i As Long, j As Long, k As Long, l As Long
'Dim igf As Integer, j1 As Long, ixx As Long, ia As Long, ib As Long
'
'Dim limgar As Long, i1 As Long, i2 As Long
'
'Dim topobe As Double
'Dim tmin  As Double, tobe As Double, repa1 As Double, repa2 As Double
'
'Dim RmTot As Double
'Dim Rmben As Double, RmBenT As Double, RmbenR As Double, RmbenC As Double
'Dim rmpol As Double, RmpolC As Double, RmpolR As Double
'Dim paso As Double
'Dim factor As Double, factorr As Double, factorc As Double
'Dim factoa As Double, factoar  As Double, factoac As Double
'
'Dim Reser As Double, ReserR As Double, ReserC As Double
'Dim Cmcau As Double, CmcauR As Double, CmcauC As Double
'Dim Rmcau  As Double, RmcauC As Double, RmcauR As Double
'Dim sumapx As Double, sumapxr As Double, sumapxc As Double
'Dim Supxpy As Double, Supxpyr As Double, Supxpyc As Double
'Dim sumaqx As Double, Sumaqxr As Double, Sumaqxc As Double
'Dim rmb1 As Double, rmb1r As Double, rmb1c As Double
'Dim rmb2 As Double, rmb2r As Double, rmb2c As Double
'Dim vipen As Double, px1 As Double, py1  As Double
'Dim Qx As Double, px As Double, py As Double
'Dim pension As Double
'
'Dim vlBenCed As Long, vlBenRet As Long
'Dim vlPolCed As Long, vlPolRet As Long
''I---- ABV 15-03-2005 ----
'Dim vlFechaNacCausante As String
'Dim vlSexoCausante     As String
'Dim vlRegistro         As ADODB.Recordset
'Dim fecha1             As String
'Dim vlI  As Long
'Dim contcausante As Long
'
'Dim vlFechaFallecimiento As String
'Dim vlFechaMatrimonio    As String
'Dim vlFechaAux           As String
''I---- ABV 15-03-2005 ----
'
'Dim flumax() As Double
'
'On Error GoTo Err_Base
'
'ReDim flumax(1 To Fintab) As Double
'    Fechap = Nap * 12 + Nmp
'    'Año bisietro - modulo 4
'    iagno = Nap Mod 4
'    If iagno > 0 Then
'        idbis = 365
'    Else
'        idbis = 366
'    End If
'    Select Case (Nmp)
'        Case (2)
'          If (idbis = 365) Then
'            idp = 28
'          Else
'            idp = 29
'          End If
'        Case 1, 3, 5, 7, 8, 10, 12
'            idp = 31
'        Case Else
'            idp = 30
'    End Select
'
'        'Inicializacion de variables
'        numrec = -1
'        Nubenp = 0
'        NuBenL = 0
'        NumPro = 0
'        Npnv = 0
'        For i = 1 To 3
'        For j = 1 To 3
'        For k = 1 To 5
'        For l = 1 To 3
'            Rmcob(i, j, k, l) = 0
'        Next l
'        Next k
'        Next j
'        Next i
'
'    topobe = 0
'    If (Cober <= 3) Or (Cober >= 13 And Cober <= 15) Then
'        If (Navig = 0 Or Nmvig = 0 Or Ndvig = 0) Then
'            Navig = 1985
'            Nmvig = 12
'            Ndvig = 28
'            Indi = 1
'            Mesdif = 0
'            Alt = 1
'            Mesgar = 0
'        End If
'    End If
'    'ISTA = 1 'NUPEN0
'    'Vigencia de la poliza
'    '6 -> Vigente          7 -> Vigente con Benef. designados
'    '8 -> Vigente Difer.   9 -> no vigente
'    If vigpen = 9 Then
'        Npnv = Npnv + 1
'        Exit Function
'    End If
'    vlFechaNacCausante = ""
'
'''    'Daniela 08/05/2004
'''    'Poliza con retroaceptacion Operacion de Reaseguro = "B"
'''    'Por lo tanto no se realiza calculo de Reserva
'''    If oprea = "B" Then
'''        Npnv_B = Npnv_B + 1
'''        Exit Function
'''    End If
'''    'Fin daniela
'    i = 1
'
'    'Datos de los Beneficiarios
'    'Datos de los Beneficiarios
'    If (Vuelta = 1) Then
'
'        vgSql = "SELECT "
'        vgSql = vgSql & "num_poliza,Num_Orden,Cod_Sexo,Cod_Par,Cod_SitInv,"
'        vgSql = vgSql & "Fec_NacBen,cod_estpension,Cod_DerPen,Fec_NacHM,"
'        vgSql = vgSql & "PRC_pension as prc_legal,Mto_Pension,Cod_DerCre,Cod_GruFam "
'        vgSql = vgSql & ",fec_fallben, fec_matrimonio "
'        vgSql = vgSql & "FROM PP_TMAE_BEN WHERE "
'        vgSql = vgSql & "num_poliza = '" & Npolca & "' and "
'        'vgSql = vgSql & "cod_cliente = " & vgCliente & "  and "
'        vgSql = vgSql & "num_endoso = " & Numend & " "
'        vgSql = vgSql & "order by num_orden "
'        Set vlRegistro = vgConexionBD.Execute(vgSql)
'        While Not (vlRegistro.EOF)
'            Numor(i) = Trim(vlRegistro!Num_Orden)
'            Sexobe(i) = Trim(vlRegistro!Cod_Sexo)
'            Ncorbe(i) = Trim(vlRegistro!Cod_Par)
'            'I--- ABV 15/03/2005 ---
'            If (Ncorbe(i) = 99) Or (Ncorbe(i) = 0) Then
'                vlFechaNacCausante = vlRegistro!Fec_NacBen
'                vlSexoCausante = Trim(vlRegistro!Cod_Sexo)
'            End If
'            'F--- ABV 15/03/2005 ---
'
'            Coinbe(i) = Trim(vlRegistro!Cod_SitInv)
'
'            fecha1 = DateSerial(Mid(vlRegistro!Fec_NacBen, 1, 4), Mid(vlRegistro!Fec_NacBen, 5, 2), Mid(vlRegistro!Fec_NacBen, 7, 2))
'            If Not IsNull(vlRegistro!Fec_NacBen) Then
'                Nanbe(i) = Mid(vlRegistro!Fec_NacBen, 1, 4)
'                Nmnbe(i) = Mid(vlRegistro!Fec_NacBen, 5, 2)
'                Ndnbe(i) = Mid(vlRegistro!Fec_NacBen, 7, 2)
'            End If
'
'            If Not IsNull(vlRegistro!Fec_NacHM) Then
'                Ijam(i) = Mid(vlRegistro!Fec_NacHM, 1, 4)
'                Ijmn(i) = Mid(vlRegistro!Fec_NacHM, 5, 2)
'                ijdn(i) = Mid(vlRegistro!Fec_NacHM, 7, 2)
'            End If
'            Porcbe(i) = Trim(vlRegistro!PRC_LEGAL)
'            'I--- ABV 21/06/2005 ---
'            'Penben(i) = Trim(vlRegistro!Mto_Pension)
'            Penben(i) = CDbl(Format(penbase * (Porcbe(i) / 100), "#0.00"))
'            'I--- ABV 21/06/2005 ---
'            Codcbe(i) = Trim(vlRegistro!Cod_DerCre)
'            igfh(i) = Trim(vlRegistro!Cod_GruFam)
'
'            NuBenL = NuBenL + 1
'
'
'            'I--- ABV 14/04/2005 ---
'            'Dº Potencial a Pensión de Sobrevivencia
'            'Se debería considerar el campo de Estado Pensión, sin embargo, se debe
'            'considerar el potencial Dº a recibir, por ende sería correcto determinar
'            'dicho Derecho desde el cálculo
'            'Derpen(i) = Trim(vlRegistro!Cod_DerPen)
'            vlFechaFallecimiento = IIf(IsNull(vlRegistro!Fec_FallBen), "", Trim(vlRegistro!Fec_FallBen))
'            vlFechaMatrimonio = IIf(IsNull(vlRegistro!Fec_Matrimonio), "", Trim(vlRegistro!Fec_Matrimonio))
'            If (Ncorbe(i) >= 30 And Ncorbe(i) <= 39) Then
'                'Si se trata de Hijos, se debe validar la fecha de Nacimiento
'                'por si son mayores de 24 años
'
'                If (vlFechaFallecimiento <> "") Or (vlFechaMatrimonio <> "") Then
'                    Derpen(i) = clCodSinDerPen
'                Else
'                    nrel = 0
'                    nibe = 0
'                    Select Case (Coinbe(i))
'                        Case "S", "T": nibe = 1
'                        Case "N": nibe = 2
'                        Case "P": nibe = 3
'                        Case Else
'                            vgError = 1017
'                            Exit Function
'                    End Select
'                    nsbe = 0
'                    Select Case (Sexobe(i))
'                        Case "M", "T": nsbe = 1
'                        Case "F": nsbe = 2
'                        Case Else
'                            vgError = 1018
'                            Exit Function
'                    End Select
'                    Fechan = Nanbe(i) * 12 + Nmnbe(i)
'                    edabe = Fechap - Fechan
'                    difdia = idp - Ndnbe(i)
'                    If difdia > 15 Then edabe = edabe + 1
'                    If edabe > Fintab Then
'                        vgError = 1023
'                        Exit Function
'                    End If
'                    If edabe < 1 Then edabe = 1
'                    If (edabe > L24) Then
'                        If (nibe = 2) Then
'                            Derpen(i) = clCodSinDerPen
'                        Else
'                            Derpen(i) = clCodConDerPen
'                        End If
'                    Else
'                        Derpen(i) = clCodConDerPen
'                    End If
'                End If
'
'            Else
'                If (vlFechaFallecimiento <> "" Or vlFechaMatrimonio <> "") Then
'                    Derpen(i) = clCodSinDerPen
'                Else
'                    Derpen(i) = clCodConDerPen
'                End If
'            End If
'
'            If Derpen(i) <> 10 Then topobe = topobe + Porcbe(i)
'            If Ncorbe(i) = 77 Then
'                If vigpen <> 7 Then vigpen = 7
'            End If
'            Porcbe(i) = Porcbe(i) / 100
'            i = i + 1
'            vlRegistro.MoveNext
'        Wend
'        vlRegistro.Close
'    Else
'        If (Msf_BMGrilla.Rows > 1) Then
'            i = 1
'            While i <= (Msf_BMGrilla.Rows - 1)
'                Numor(i) = Trim(Msf_BMGrilla.TextMatrix(i, 0))
'                Sexobe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 7))
'                Ncorbe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 5))
'
'                'I--- ABV 15/03/2005 ---
'                If (Ncorbe(i) = 99) Or (Ncorbe(i) = 0) Then
'                    'vlFechaNacCausante = Trim(Msf_BMGrilla.TextMatrix(i, 14))
'                    vlFechaNacCausante = Format(Trim(Msf_BMGrilla.TextMatrix(i, 14)), "yyyymmdd")
'                    vlSexoCausante = Trim(Msf_BMGrilla.TextMatrix(i, 7))
'                End If
'                'F--- ABV 15/03/2005 ---
'
'                Coinbe(i) = Msf_BMGrilla.TextMatrix(i, 8)
'                'fecha1 = DateSerial(Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4), Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2), Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2))
'                vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 14)), "yyyymmdd")
'                'If Trim(Msf_BMGrilla.TextMatrix(i, 14)) <> "" Then
'                If Trim(vlFechaAux) <> "" Then
'                    'Nanbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4)
'                    'Nmnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2)
'                    'Ndnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2)
'                    Nanbe(i) = Mid(vlFechaAux, 1, 4)
'                    Nmnbe(i) = Mid(vlFechaAux, 5, 2)
'                    Ndnbe(i) = Mid(vlFechaAux, 7, 2)
'                End If
'
'
'                'If Not IsNull(Msf_BMGrilla.TextMatrix(i, 15)) And ((Msf_BMGrilla.TextMatrix(i, 15)) <> "") Then
'                If (Trim(Msf_BMGrilla.TextMatrix(i, 15)) <> "") Then
'                    'Ijam(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 1, 4)
'                    'Ijmn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 5, 2)
'                    'ijdn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 7, 2)
'                    vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 15)), "yyyymmdd")
'
'                    Ijam(i) = Mid(vlFechaAux, 1, 4)
'                    Ijmn(i) = Mid(vlFechaAux, 5, 2)
'                    ijdn(i) = Mid(vlFechaAux, 7, 2)
'                End If
'                Porcbe(i) = IIf(Msf_BMGrilla.TextMatrix(i, 18) = "", 0, Msf_BMGrilla.TextMatrix(i, 18))
'                'Determinar el monto de la Pensión del Beneficiario
'                'Penben(i) = IIf(Msf_BMGrilla.TextMatrix(vlI, 17) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 17))
'                Penben(i) = CDbl(Format(penbase * (Porcbe(i) / 100), "#0.00"))
'
'                Codcbe(i) = Msf_BMGrilla.TextMatrix(i, 10)
'                igfh(i) = Msf_BMGrilla.TextMatrix(i, 6)
'
'                NuBenL = NuBenL + 1
'
'
'                'I--- ABV 14/04/2005 ---
'                'Dº Potencial a Pensión de Sobrevivencia
'                'Se debería considerar el campo de Estado Pensión, sin embargo, se debe
'                'considerar el potencial Dº a recibir, por ende sería correcto determinar
'                'dicho Derecho desde el cálculo
'                ''Derpen(i) = Msf_BMGrilla.TextMatrix(i, 9)
'                'Derpen(i) = Msf_BMGrilla.TextMatrix(i, 20)
'
'                'vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 19) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 19)))
'                'vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 27) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 27)))
'                vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 19) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 19)), "yyyymmdd"))
'                vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 27) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 27)), "yyyymmdd"))
'
'                If (Ncorbe(i) >= 30 And Ncorbe(i) <= 39) Then
'                    'Si se trata de Hijos, se debe validar la fecha de Nacimiento
'                    'por si son mayores de 24 años
'
'                    If (vlFechaFallecimiento <> "") Or (vlFechaMatrimonio <> "") Then
'                        Derpen(i) = clCodSinDerPen
'                    Else
'                        nrel = 0
'                        nibe = 0
'                        Select Case (Coinbe(i))
'                            Case "S", "T": nibe = 1
'                            Case "N": nibe = 2
'                            Case "P": nibe = 3
'                            Case Else
'                                vgError = 1017
'                                Exit Function
'                        End Select
'                        nsbe = 0
'                        Select Case (Sexobe(i))
'                            Case "M", "T": nsbe = 1
'                            Case "F": nsbe = 2
'                            Case Else
'                                vgError = 1018
'                                Exit Function
'                        End Select
'                        Fechan = Nanbe(i) * 12 + Nmnbe(i)
'                        edabe = Fechap - Fechan
'                        difdia = idp - Ndnbe(i)
'                        If difdia > 15 Then edabe = edabe + 1
'                        If edabe > Fintab Then
'                            vgError = 1023
'                            Exit Function
'                        End If
'                        If edabe < 1 Then edabe = 1
'                        If (edabe > L24) Then
'                            If (nibe = 2) Then
'                                Derpen(i) = clCodSinDerPen
'                            Else
'                                Derpen(i) = clCodConDerPen
'                            End If
'                        Else
'                            Derpen(i) = clCodConDerPen
'                        End If
'                    End If
'
'                Else
'                    'El resto de los Beneficiarios que no sean Hijos, solo se dejan como
'                    'Sin Derecho a Pensión cuando están fallecidos
'                    'If (vlFechaFallecimiento <> "" Or vlFechaMatrimonio <> "") Then
'                    If (vlFechaFallecimiento <> "") Then
'                        Derpen(i) = clCodSinDerPen
'                    Else
'                        Derpen(i) = clCodConDerPen
'                    End If
'                End If
'
'                'Modificar el estado de Derecho a Pensión en la Grilla
'                'De acuerdo a lo calculado
'                Msf_BMGrilla.TextMatrix(i, 20) = Derpen(i)
'
'                'F--- ABV 14/04/2005 ---
'
'
'                If Derpen(i) <> 10 Then topobe = topobe + Porcbe(i)
'                If Ncorbe(i) = 77 Then
'                    If vigpen <> 7 Then vigpen = 7
'                End If
'                Porcbe(i) = Porcbe(i) / 100
'                i = i + 1
'            Wend
'        Else
'            'Error ya que deben existir beneficiarios en la Grilla de Modificación
'
'        End If
'    End If
'
'    'Validar el Número de Beneficiarios
'    If NuBenL = 0 Then
'        vgError = 1003
'        Exit Function         'Registrarlo como un Error de la Póliza
'    End If
'    Nben = i - 1
'
'    'Se calculan igualmente todas las Pólizas, las cuales se distinguen por
'    'el Código del Tipo de Reserva al cual pertenecen (COD_RESERVA)
'    'If (Cober <= 3) Then
'    '-------------------------------------------------
'    'Leer Tabla de Mortalidad
'    '-------------------------------------------------
'    If (fgBuscarMortalidad(Navig, Nmvig, Ndvig, Nap, Nmp, Ndp, vlSexoCausante, vlFechaNacCausante) = False) Then
'        'Se produjeron errores en la obtención de una de las Tablas de Mortalidad
'        Exit Function
'    End If
'
'    'Validacion de pension de referencia y de pension de beneficiarios
'    'de sobrevivencia
'    If penbase = 0 Then
'        vgError = 1033
'        Exit Function
'    End If
'    If vigpen = 6 Or vigpen = 8 Then
'        If Cober = 3 Or Cober = 8 Or Cober = 9 Or Cober = 10 Or _
'            Cober = 11 Or Cober = 1 Or Cober = 13 Then
'            For i = 1 To Nben
'                If Ncorbe(i) <> 99 Then
'                    If Derpen(i) <> 10 And Penben(i) = 0 Then
'                        vgError = 1034
'                        Exit Function
'                    End If
'                End If
'            Next i
'        End If
'        If Cober = 2 Or Cober = 4 Or Cober = 5 Or Cober = 6 Or Cober = 7 Or Cober = 14 _
'             Then
'             For i = 1 To Nben
'                If Ncorbe(i) = 99 And Derpen(i) = 10 Then
'                    vgError = 1074
'                    Exit Function
'                End If
'            Next i
'        End If
'        If Cober = 2 Or Cober = 4 Or Cober = 5 Or Cober = 6 Or Cober = 7 Or Cober = 14 Then
'            'I - Inicio Daj 13/08/2004
'            contcausante = 0
'            For i = 1 To Nben
'                If Ncorbe(i) = 99 Then contcausante = contcausante + 1
'            Next i
'            If contcausante = 0 Then
'                vgError = 1075
'                Exit Function
'            End If
'            'F - Fin Daj 13/08/2004
'        End If
'
'    End If
'    'Inicializacion de variables por poliza
'    Porret = Porret / 100
'    rmpol = 0
'    RmpolC = 0
'    RmpolR = 0
'    vlPolCed = 0
'    vlPolRet = 0
'    vlBenCed = 0
'    vlBenRet = 0
'
'    'Tasa minima entra la tasa de venta y la tasa de costo equivalente
'    If Tvta <= 0 Then
'        tmin = tce
'    Else
'        'I--- ABV 18/04/2005 ---
'        'tmin = amin0(tce, Tvta)
'        tmin = amin1(tce, Tvta)
'        'F--- ABV 18/04/2005 ---
'    End If
'    If oprea = "C" And modore = "N" And IVigrea_a <= 1993 Then
'        If Tcrj = 0 Then Tcrj = amin0(tce, Tvta)
'    End If
'    'Mensualizacion de tasas
'    'Tasa mensual de reserva base
'    tmtce = (1 + tmin / 100) ^ (1 / 12)
'    'Tasa mensual a TCRj
'    TmTcr = (1 + Tcrj / 100) ^ (1 / 12)
'
'    tmtce = (1 + 3 / 100) ^ (1 / 12)
'    TmTcr = (1 + 3 / 100) ^ (1 / 12)
'
'    'Circular N§ 528
'    '---------------
'    'Coberturas -->
'    '01 --> Sobrevivencia
'    '02 --> Invalidez
'    '03 --> Sobrevivencia de invalidez
'
'    'Rentas Vitalicias
'    '-----------------
'    '04 --> Vejez Normal
'    '05 --> Vejez Anticipada
'    '06 --> Invalidez Total
'    '07 --> Invalidez Parcial
'    '08 --> Sobrevivencia
'    '09 --> Sobrevivencia de 04 (VN)
'    '10 --> Sobrevivencia de 05 (VA)
'    '11 --> Sobrevivencia de 06 (IT)
'    '12 --> Sobrevivencia de 07 (IP)
'    '13 --> Sobrevivencia por traspaso o compra de cartera
'    '14 --> Invalidez por traspaso o compra de cartera
'    '15 --> Sobrevivencia de invalidez por traspaso o compra
'    '       de cartera de 14
'
'    'Tipo de cobertura o riesgo
'    ncobe = 0
'    If Cober = 4 Or Cober = 9 Then ncobe = 1
'    If Cober = 5 Or Cober = 10 Then ncobe = 1
'    If Cober = 2 Or Cober = 3 Then ncobe = 2
'    If Cober = 6 Or Cober = 11 Then ncobe = 2
'    If Cober = 14 Or Cober = 15 Then ncobe = 2
'    If Cober = 8 Or Cober = 13 Then ncobe = 3
'    If Cober = 1 Then ncobe = 3
'    If Cober = 7 Or Cober = 12 Then ncobe = 4
'    If ncobe = 0 Then
'        vgError = 1015
'        Exit Function
'    End If
'    'Polizas del mes y de meses anteriores
'    nv = 1
'    If Navig = Nap And Nmvig = Nmp Then nv = 2
'    'Definicion del periodo garantizado en 0 para las
'    'alternativas Simple o pensiones con distinto porcentaje legal
'    If Alt = 1 Or (Alt = 4 And Mesgar = 0) Then Mesgar = 0
'    'Cobertura Inmediata
'    If Indi = 1 Then
'        perdif = 0
'        If Mesdif > 0 Then
'            vgError = 1030
'            Exit Function
'        End If
'        If Alt = 3 Or (Alt = 4 And Mesgar > 0) Then
'            Mesgar = Mesgar - ((Nap * 12 + Nmp) - (Navig * 12 + Nmvig))
'            Mesgar = amax0(Mesgar, 0)
'        End If
'    Else
'    'Cobertura diferida
'        If Indi = 2 Then
'            perdif = ((Navig * 12) + Nmvig) + Mesdif - Fechap - 1
'            If perdif <= 0 Then
'                If Alt = 3 Or (Alt = 4 And Mesgar > 0) Then
'                    Mesgar = Mesgar + perdif
'                    Mesgar = amax0(Mesgar, 0)
'                End If
'                perdif = 0
'            End If
'        End If
'    End If
'    nmdiga = perdif + Mesgar
'    'Periodo no consumido para reaseguros no proporcionales
'    diftem = ((Iare * 12) + Imre) - ((Navig * 12) + Nmvig)
'    mescon = ((Nap * 12) + Nmp) - ((Navig * 12) + Nmvig)
'    mesnoc = diftem - mescon - 1
'    mesnoc = amax0(0, mesnoc)
'    Cober = CInt(Cober)
'    'Impresion de datos basicos de la poliza
'    'NPOLCA,SALCTA,COBER,ALT,MESGAR,PERDIF,TCE,TVTA,PENBASE,NDVIG,NMVIG,NAVIG
'
'    'RESERVA DE SOBREVIVENCIA
'    If Cober = 1 Or Cober = 3 Or Cober = 8 Or Cober = 9 Or _
'       Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 13 Or Cober = 15 Then
'
'        'Calculo porcentajes para beneficiarios
'        If vigpen <> 9 Then
'            If (Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 1 Or Cober = 13) Then
'                If nmdiga > 0 Then
'                    icont10 = 0
'                    icont20 = 0
'                    icont30 = 0
'                    icont35 = 0
'                    icont40 = 0
'                    icont77 = 0
'                    For j = 1 To Nben
'                        If Derpen(j) <> 10 And Ncorbe(j) <> 99 Then
'                            nrel = 0
'                            nibe = 0
'                            Select Case (Coinbe(j))
'                                Case "S", "T": nibe = 1
'                                Case "N": nibe = 2
'                                Case "P": nibe = 3
'                                Case Else
'                                    vgError = 1017
'                                    Exit Function
'                            End Select
'                            nsbe = 0
'                            Select Case (Sexobe(j))
'                                Case "M", "T": nsbe = 1
'                                Case "F": nsbe = 2
'                                Case Else
'                                    vgError = 1018
'                                    Exit Function
'                            End Select
'                            Fechan = Nanbe(j) * 12 + Nmnbe(j)
'                            edabe = Fechap - Fechan
'                            difdia = idp - Ndnbe(j)
'                            If difdia > 15 Then edabe = edabe + 1
'                            If edabe > Fintab Then
'                                vgError = 1023
'                                Exit Function
'                            End If
'                            If edabe < 1 Then edabe = 1
'                            If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Then icont10 = icont10 + 1
'                            If Ncorbe(j) = 20 Or Ncorbe(j) = 21 Then icont20 = icont20 + 1
'                            If Ncorbe(j) = 30 Then icont30 = icont30 + 1
'                            If Ncorbe(j) = 35 Then icont35 = icont35 + 1
'                            If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then icont40 = icont40 + 1
'                            If Ncorbe(j) = 77 Then icont77 = icont77 + 1
'                        End If  'Fin (DERPEN(j) <> 10 And ncorbe(j) <> 99)
'                    Next j
'
'                    For igf = 0 To 10
'                        For j = 1 To Nben
'                            If (igfh(j) = igf) Then
'                                If Derpen(j) <> 10 And Ncorbe(j) <> 99 Then
'                                    nrel = 0
'                                    nibe = 0
'                                    Select Case (Coinbe(j))
'                                        Case "S", "T": nibe = 1
'                                        Case "N": nibe = 2
'                                        Case "P": nibe = 3
'                                        Case Else
'                                            vgError = 1017
'                                            Exit Function
'                                    End Select
'                                    nsbe = 0
'                                    Select Case (Sexobe(j))
'                                        Case "M", "T": nsbe = 1
'                                        Case "F": nsbe = 2
'                                        Case Else
'                                            vgError = 1018
'                                            Exit Function
'                                    End Select
'                                    Fechan = Nanbe(j) * 12 + Nmnbe(j)
'                                    edabe = Fechap - Fechan
'                                    difdia = idp - Ndnbe(j)
'                                    If difdia > 15 Then edabe = edabe + 1
'                                    If edabe > Fintab Then
'                                        vgError = 1023
'                                        Exit Function
'                                    End If
'                                    If edabe < 1 Then edabe = 1
'                                    If Ncorbe(j) = 10 Then
'                                        If ((Ncorbe(j) = 10 And nsbe = 2) Or (Ncorbe(j) = 10 And (nsbe = 1 And nibe = 1))) Then
'                                            If (icont10 > 0) Then porceb(j) = 60 / icont10
'                                        Else
'                                            If (Ncorbe(j) = 10 And nsbe = 1 And nibe = 3) Then
'                                                If (icont10 > 0) Then porceb(j) = 43 / icont10
'                                            End If
'                                        End If
'                                    End If
'                                    If Ncorbe(j) = 20 Then
'                                        If (icont20 > 0) Then porceb(j) = 36 / icont20
'                                    End If
'                                    If Ncorbe(j) = 21 Then
'                                        If (icont20 > 0) Then porceb(j) = 30 / icont20
'                                    End If
'                                    If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then porceb(j) = 50
'                                    If Ncorbe(j) = 77 Then porceb(j) = 100 / icont77
'                                    If Ncorbe(j) = 11 Then
'                                        If Ncorbe(j) = 11 And nsbe = 2 Then porceb(j) = 50 / icont10
'                                        If (Ncorbe(j) = 11 And nsbe = 1 And nibe = 1) Then
'                                            porceb(j) = 50 / icont10
'                                        Else
'                                            If (Ncorbe(j) = 11 And nsbe = 1 And nibe = 3) Then porceb(j) = 36 / icont10
'                                        End If
'                                    End If
'                                    If Ncorbe(j) = 30 Then
'                                        porceb(j) = 15
'                                        If nibe = 1 And edabe > L24 Then porceb(j) = 15
'                                        If nibe = 3 And edabe > L24 Then porceb(j) = 11
'                                    End If
'                                    If Ncorbe(j) = 35 Then
'                                        If icont10 = 0 Then
'                                            porceb(j) = 15 + (50 / (icont35))
'                                            If (nibe = 3 And edabe > L24) Then porceb(j) = 11 + (50 / icont35)
'                                        End If
'                                    End If
'                                End If  'Fin (DERPEN(j) <> 10 and ncorbe(j) <> 99)
'                            End If  'Fin (igfh(j) = igf)
'                        Next j
'                    Next igf
'                    tobe = 0
'                    For j1 = 1 To Nben
'                        If Derpen(j1) <> 10 Then
'                            tobe = tobe + porceb(j1)
'                        Else
'                            If Derpen(j1) = 10 Then porceb(j1) = 0
'                            porceb(j1) = 0
'                        End If
'                    Next j1
'                    If tobe <= 100 Then
'                        For j = 1 To Nben
'                            If Porcbe(j) <> 0 Then Porcbe(j) = porceb(j) / 100
'                            If Derpen(j) <> 10 Then Porcbe(j) = porceb(j) / 100
'                        Next j
'                    End If
'                End If
'            End If
'        End If
'        'SOBREVIVENCIAS GARANTIZADAS
'        ixx = 0
'        If Cober = 8 And nmdiga > 0 And vigpen <> 9 Then
'            For j = 1 To Nben
'                If Ncorbe(j) >= 10 And Ncorbe(j) <= 21 Then
'                    If Derpen(j) = 10 Then ixx = 1
'                End If
'            Next j
'            icont10 = 0
'            icont20 = 0
'            icont30 = 0
'            icont35 = 0
'            icont40 = 0
'            icont77 = 0
'            repa1 = 0
'            repa2 = 0
'            For j = 1 To Nben
'                If Derpen(j) = 10 And Ncorbe(j) = 10 Then repa1 = 50
'                If Derpen(j) = 10 And Ncorbe(j) = 11 Then repa1 = 50
'                If Derpen(j) = 10 And Ncorbe(j) = 20 Then repa2 = 30
'                If Derpen(j) = 10 And Ncorbe(j) = 21 Then repa2 = 30
'                If Ncorbe(j) <> 99 Then
'                    nrel = 0
'                    nibe = 0
'                    Select Case (Coinbe(j))
'                        Case "S", "T": nibe = 1
'                        Case "N": nibe = 2
'                        Case "P": nibe = 3
'                        Case Else
'                            vgError = 1017
'                            Exit Function
'                    End Select
'                    nsbe = 0
'                    Select Case (Sexobe(j))
'                        Case "M", "T": nsbe = 1
'                        Case "F": nsbe = 2
'                        Case Else
'                            vgError = 1018
'                            Exit Function
'                    End Select
'                    Fechan = Nanbe(j) * 12 + Nmnbe(j)
'                    edabe = Fechap - Fechan
'                    difdia = idp - Ndnbe(j)
'                    If difdia > 15 Then edabe = edabe + 1
'                    If edabe > Fintab Then
'                        vgError = 1023
'                        Exit Function
'                    End If
'                    If edabe < 1 Then edabe = 1
'                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Then icont10 = icont10 + 1
'                    If Ncorbe(j) = 20 Or Ncorbe(j) = 21 Then icont20 = icont20 + 1
'                    If Ncorbe(j) = 30 Then icont30 = icont30 + 1
'                    If Ncorbe(j) = 35 Then icont35 = icont35 + 1
'                    If Ncorbe(j) > 40 And Ncorbe(j) < 50 Then icont40 = icont40 + 1
'                    If Ncorbe(j) = 77 Then icont77 = icont77 + 1
'                End If  'Fin ncorbe(j) <> 99
'            Next j
'            For igf = 0 To 10
'                For j = 1 To Nben
'                    If igfh(j) = igf And Derpen(j) <> 10 And Ncorbe(j) <> 99 Then
'                        nrel = 0
'                        nibe = 0
'                        Select Case (Coinbe(j))
'                            Case "S", "T": nibe = 1
'                            Case "N": nibe = 2
'                            Case "P": nibe = 3
'                            Case Else
'                                vgError = 1017
'                                Exit Function
'                        End Select
'                        nsbe = 0
'                        Select Case (Sexobe(j))
'                            Case "M", "T": nsbe = 1
'                            Case "F": nsbe = 2
'                            Case Else
'                                vgError = 1018
'                                Exit Function
'                        End Select
'                        Fechan = Nanbe(j) * 12 + Nmnbe(j)
'                        edabe = Fechap - Fechan
'                        difdia = idp - Ndnbe(j)
'                        If difdia > 15 Then edabe = edabe + 1
'                        If edabe > Fintab Then
'                            vgError = 1023
'                            Exit Function
'                        End If
'                        If edabe < 1 Then edabe = 1
'                        If Ncorbe(j) = 10 Then
'                            If ((Ncorbe(j) = 10 And nsbe = 2) Or (Ncorbe(j) = 10 And (nsbe = 1 And nibe = 1))) Then
'                                If (icont10 > 0) Then porceb(j) = 60 / icont10
'                            Else
'                                If (Ncorbe(j) = 10 And nsbe = 1 And nibe = 3) Then
'                                    If (icont10 > 0) Then porceb(j) = 43 / icont10
'                                End If
'                            End If
'                        End If
'                        If (Ncorbe(j) = 20) Then
'                            If (icont20 > 0) Then porceb(j) = 36 / icont20
'                        End If
'                        If (Ncorbe(j) = 21) Then
'                            If (icont20 > 0) Then porceb(j) = 30 / icont20
'                        End If
'                        If (Ncorbe(j) > 40 And Ncorbe(j) < 50) Then porceb(j) = 50
'                        If (Ncorbe(j) = 77) Then porceb(j) = 100 / icont77
'                        If (Ncorbe(j) = 11) Then
'                            If (Ncorbe(j) = 11 And nsbe = 2) Then porceb(j) = 50 / icont10
'                            If (Ncorbe(j) = 11 And nsbe = 1 And nibe = 1) Then
'                                porceb(j) = 50 / icont10
'                            Else
'                                If (Ncorbe(j) = 11 And nsbe = 1 And nibe = 3) Then porceb(j) = 36 / icont10
'                            End If
'                        End If
'                        If Ncorbe(j) = 30 Then
'                            porceb(j) = 15
'                            If nibe = 1 And edabe > L24 Then porceb(j) = 15
'                            If nibe = 3 And edabe > L24 Then porceb(j) = 11
'                        End If
'                        If Ncorbe(j) = 35 Then
'                            If icont10 = 0 Then
'                                porceb(j) = 15 + (50 / icont35)
'                                If nibe = 3 And edabe > L24 Then porceb(j) = 11 + (50 / icont35)
'                            End If
'                        End If
'                    End If  'Fin igfh(j) = igf And DERPEN(j) <> 10 And ncorbe(j) <> 99
'                Next j
'            Next igf
'            tobe = 0
'            For j1 = 1 To Nben
'                If Derpen(j1) <> 10 Then
'                    tobe = tobe + porceb(j1)
'                Else
'                    If Derpen(j1) = 10 Then porceb(j1) = 0
'                    porceb(j1) = 0
'                End If
'            Next j1
'            If tobe <= 100 And ixx = 1 Then
'                For j = 1 To Nben
'                    If Porcbe(j) <> 0 Then Porcbe(j) = porceb(j) / 100
'                    If Derpen(j) <> 10 Then Porcbe(j) = porceb(j) / 100
'                Next j
'            End If
'        End If
'        'FIN CICLO PORCENTAJE DE PENSIONES LEGALES
'        'Calculo de Beneficiarios Designados
'        'Vigencia de la poliza
'        '7 -> Vigente con Benef. designados
'        If vigpen = 7 And nmdiga > 0 Then
'            RmTot = 0
'            Rmben = 0
'            RmBenT = 0
'            RmbenR = 0
'            RmbenC = 0
'            For j = 1 To Nben
'                factor = 0
'                factoa = 0
'                edabe = 0
'                RmBenT = 0
'                Rmben = 0
'                RmbenR = 0
'                RmbenC = 0
'                If Ncorbe(j) = 77 And Derpen(j) = 99 Then
'                    Nubenp = Nubenp + 1
'                    RmbenR = (Penben(j) * ((1 - (tmtce) ^ (-1 * Mesgar)) / (tmtce - 1)) * tmtce)
'                    RmBenT = RmbenR + RmbenC
'                    RmTot = RmTot + RmBenT
'                    ''Grabar los datos de los Beneficiarios calculados
'                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
'                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
'                    'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(RmBenT, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(RmBenT, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & " "
'                    'vgQuery = vgQuery & "where "
'                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
'                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
'                    'vgQuery = vgQuery & "num_orden = " & Numor(1) & ""
'                    'vgConexionBD.Execute (vgQuery)
'                End If
'            Next j
'            Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
'            NumPro = NumPro + 1
'            ' RMTOT
'            'Ani -Daj
'            vlPolRet = vlPolRet + 1
'
'            ''Grabar los Totales en la Póliza
'            'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
'            'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
'            'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'            'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
'            'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
'            'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
'            'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
'            'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
'            'vgQuery = vgQuery & "mto_resEND = " & Str(Format(RmBenT, "#0.00")) & ", "
'            'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmbenC, "#0.00")) & ", "
'            'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(RmBenT, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & " "
'            'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
'            'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
'            'vgQuery = vgQuery & "num_endoso = " & Numend & " "
'            'vgConexionBD.Execute (vgQuery)
'
'            If (Vuelta = 1) Then
'                vlReservaOriginal = Format(RmBenT, "#0.00")
'            Else
'                vlReservaCalculada = Format(RmBenT, "#0.00")
'            End If
'
'            Exit Function
'        End If
'        'Calculo de Pension de Sobrevivencia
'        rmpol = 0
'        RmpolR = 0
'        RmpolC = 0
'        For j = 1 To Nben
'            swg = "N"
'            factor = 0
'            factorr = 0
'            factorc = 0
'            factoa = 0
'            factoar = 0
'            factoac = 0
'            Rmben = 0
'            RmbenR = 0
'            RmbenC = 0
'            RmBenT = 0
'            sumapx = 0
'            sumapxr = 0
'            sumapxc = 0
'            rmb1 = 0
'            rmb1r = 0
'            rmb1c = 0
'            rmb2 = 0
'            rmb2r = 0
'            rmb2c = 0
'            edabe = 0
'            If Derpen(j) <> 10 And Ncorbe(j) <> 99 Then
'                Nubenp = Nubenp + 1
'                nrel = 0
'                nibe = 0
'                Select Case (Coinbe(j))
'                    Case "S", "T": nibe = 1
'                    Case "N": nibe = 2
'                    Case "P": nibe = 3
'                    Case Else
'                        vgError = 1017
'                        Exit Function
'                End Select
'                nsbe = 0
'                Select Case (Sexobe(j))
'                    Case "M", "T": nsbe = 1
'                    Case "F": nsbe = 2
'                    Case Else
'                        vgError = 1018
'                        Exit Function
'                End Select
'                Fechan = Nanbe(j) * 12 + Nmnbe(j)
'                edabe = Fechap - Fechan
'                difdia = idp - Ndnbe(j)
'                If difdia > 15 Then edabe = edabe + 1
'                If edabe > Fintab Then
'                    vgError = 1023
'                    Exit Function
'                End If
'                If edabe < 1 Then edabe = 1
'                If Ncorbe(j) = 10 Or Ncorbe(j) = 20 Then nrel = 1
'                If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then nrel = 2
'                'RESERVA SOBREVIVENCIA VITALICIA
'                If Ncorbe(j) = 10 Or Ncorbe(j) = 20 Or _
'                    Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
'                    ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And _
'                    (Coinbe(j) <> "N" And edabe > L24)) Then
'                    pension = Penben(j)
'                    limite1 = Fintab - edabe - 1
'                    For i = 0 To limite1
'                        edalbe = edabe + i
'                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                        If i < nmdiga And nrel = 1 Then py = 1
'                        If i < perdif Then py = 0
'                        If i > nmdiga Then pension = penbase * Porcbe(j)
'                        sumapxr = sumapxr + (py / tmtce ^ i) * pension
'                        sumapx = sumapx + (py / tmtce ^ i) * pension
'                    Next i
'                    factor = sumapx / pension
'                    factorr = sumapxr / pension
'                    factorc = sumapxc / pension
'                    Rmben = sumapx
'                    RmbenR = sumapxr
'                    RmbenC = sumapxc
'                Else
'                    'BENEFICIARIOS PENSION VITALICIA
'                    If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
'                        edhm = (Fechap - (Ijam(j) * 12 + Ijmn(j)))
'                        difdia = idp - ijdn(j)
'                        If difdia > 15 Then edhm = edhm + 1
'                        limite1 = Fintab - edabe - 1
'                        pension = Penben(j)
'                        For i = 0 To limite1
'                            edalbe = edabe + i
'                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                            If i < nmdiga And nrel = 2 Then py = 1
'                            If i < perdif Then py = 0
'                            If i > nmdiga Then pension = penbase * Porcbe(j)
'                            sumapxr = sumapxr + (py / tmtce ^ i) * pension
'                            sumapx = sumapx + (py / tmtce ^ i) * pension
'                        Next i
'                        factor = sumapx / pension
'                        factorr = sumapxr / pension
'                        factorc = sumapxc / pension
'                        rmb1 = sumapx
'                        rmb1r = sumapxr
'                        rmb1c = sumapxc
'                        Rmben = sumapx
'                        RmbenR = sumapxr
'                        RmbenC = sumapxc
'                        'DERECHO A ACRECER DE PENSIONES VITALICIAS
'                        If Codcbe(j) <> "N" Then
'                            If edhm > L24 Then
'                                mdif = 0
'                            Else
'                                If edhm >= L18 Then
'                                    mdif = L24 - edhm
'                                Else
'                                    mdif = L21 - edhm
'                                End If
'                            End If
'                            nmdif = mdif
'                            If Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 _
'                                Or Cober = 12 Or Cober = 15 Then
'                                nmdif = amax0(mdif, nmdiga)
'                            End If
'                            sumapx = 0
'                            sumapxr = 0
'                            sumapxc = 0
'                            Ecadif = edabe + nmdif
'                            limite1 = Fintab - Ecadif - 1
'                            pension = Penben(j) * 0.2
'                            If Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 _
'                                Or Cober = 12 Or Cober = 15 Then
'                                If nmdiga > 0 Then pension = 0
'                            End If
'                            For i = 0 To limite1
'                                edcadi = Ecadif + i
'                                py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
'                                nmdifi = nmdif + i
'                                If nmdifi < nmdiga And nrel = 2 Then py = 1
'                                If nmdifi < perdif Then py = 0
'                                If nmdifi >= nmdiga Then pension = penbase * Porcbe(j) * 0.2
'                                sumapxr = sumapxr + (py / tmtce ^ nmdifi) * pension
'                                sumapx = sumapx + (py / tmtce ^ nmdifi) * pension
'                            Next i
'                            rmb2 = sumapx
'                            rmb2r = sumapxr
'                            rmb2c = sumapxc
'
'                            factoa = sumapx / pension
'                            factoar = sumapxr / pension
'                            factoac = sumapxc / pension
'
'                            Rmben = rmb1 + rmb2
'                            RmbenR = rmb1r + rmb2r
'                            RmbenC = rmb1c + rmb2c
'                        End If
'                    Else
'                        'RESERVA DE PENSIONES TEMPORALES
'                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
'                            If edabe <= L24 Then
'                                If edabe >= L18 Then
'                                    mdif = L24 - edabe
'                                Else
'                                    mdif = L21 - edabe
'                                End If
'                                nmdif = mdif - 1
'                                If Cober = 3 Or Cober = 9 Or Cober = 10 Or _
'                                    Cober = 11 Or Cober = 12 Or Cober = 15 Then
'                                    nmdif = amax0(mdif, nmdiga)
'                                    If nmdiga > 0 Then swg = "S"
'                                End If
'                                pension = Penben(j)
'                                For i = 0 To nmdif
'                                    edalbe = edabe + i
'                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                    If swg = "S" And i < nmdiga Then py = 1
'                                    If i < perdif Then py = 0
'                                    If i >= nmdiga Then pension = penbase * Porcbe(j)
'                                    sumapxr = sumapxr + (py / tmtce ^ i) * pension
'                                    sumapx = sumapx + (py / tmtce ^ i) * pension
'                                Next i
'                                factor = sumapx / pension
'                                factorr = sumapxr / pension
'                                factorc = sumapxc / pension
'
'                                rmb1 = sumapx
'                                rmb1r = sumapxr
'                                rmb1c = sumapxc
'
'                                Reser = sumapx
'                                ReserR = sumapxr
'                                ReserC = sumapxc
'                                'RESERVA DE HIJOS INVALIDOS
'                                If Coinbe(j) <> "N" Then
'                                    kdif = mdif
'                                    If Cober = 3 Or Cober = 9 Or Cober = 10 Or Cober = 11 Or Cober = 12 Or Cober = 15 Then
'                                        kdif = amax0(mdif, nmdiga)
'                                    End If
'                                    edbedi = edabe + kdif
'                                    limite3 = Fintab - edbedi - 1
'                                    sumapx = 0
'                                    sumapxr = 0
'                                    sumapxc = 0
'                                    pension = Penben(j)
'                                    paso = 0.15
'                                    For i = 0 To limite3
'                                        edalbe = edbedi + i
'                                        nmdifi = i + kdif
'                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                        If nmdifi < perdif Then py = 0
'                                        If (Navig > 1990) Then paso = Porcbe(j)
'                                        If (Navig = 1990 And Nmvig >= 8) Then paso = Porcbe(j)
'                                        If (nmdifi >= nmdiga) Then pension = penbase * paso
'                                        sumapxr = sumapxr + (py / tmtce ^ nmdifi) * pension
'                                        sumapx = sumapx + (py / tmtce ^ nmdifi) * pension
'                                    Next i
'                                    rmb2 = sumapx
'                                    rmb2r = sumapxr
'                                    rmb2c = sumapxc
'                                    factoa = sumapx / pension
'                                    factoar = sumapxr / pension
'                                    factoac = sumapxc / pension
'                                    Rmben = rmb1 + rmb2
'                                    RmbenR = rmb1r + rmb2r
'                                    RmbenC = rmb1c + rmb2c
'                                Else
'                                    If Coinbe(j) = "N" Then
'                                        Rmben = rmb1
'                                        RmbenR = rmb1r
'                                        RmbenC = rmb1c
'                                    End If
'                                End If
'                            End If  'Fin    EDABE <= L24
'                        End If  'Fin ncorbe(j) >= 30 And ncorbe(j) < 40
'                    End If  'Fin    ncorbe(j) = 11 Or ncorbe(j) = 21
'                End If  '10
'            End If  'Fin DERPEN(j) <> 10 and ncorbe(j) <>99
'            RmBenT = RmbenR + RmbenC
'            'NPOLCA,NUMOR(J),RMBENT,RMBENR,RMBENC
'            'NUMOR(J),NCORBE(J),SEXOBE(J),COINBE(J),NANBE(J),NMNBE(J),EDABE,PENBEN(J),FACTOR,FACTOA,RMBEN
'            Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
'            Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
'            Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
'
'            rmpol = rmpol + Rmben
'            RmpolR = RmpolR + RmbenR
'            RmpolC = RmpolC + RmbenC
'
'            'Ani - Daj
'            ''Grabar los datos de los Beneficiarios calculados
'            'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
'            'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'            'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
'            'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
'            'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
'            'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
'            ''vgQuery = vgQuery & "mto_cnREND = " & Str(Format(RMBEN - RMBENC, "#0.00")) & ", "
'            'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
'            'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(Rmben, "#0.00")) & " "
'            'vgQuery = vgQuery & "where "
'            'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
'            'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
'            'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
'            'vgConexionBD.Execute (vgQuery)
'            vlBenRet = vlBenRet + 1
'        Next j
'        Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
'        ' RMPOL
'        NumPro = NumPro + 1
'
'        'Ani - Daj
'        vlPolRet = vlPolRet + 1
'
'        ''Grabar los Totales en la Póliza
'        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
'        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
'        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
'        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
'        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
'        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
'        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
'        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
'        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
'        'vgConexionBD.Execute (vgQuery)
'
'        If (Vuelta = 1) Then
'            vlReservaOriginal = Format(rmpol, "#0.00")
'        Else
'            vlReservaCalculada = Format(rmpol, "#0.00")
'        End If
'
'        Exit Function
'    Else
'        'RESERVA MATEMATICA PARA VEJEZ E INVALIDEZ
'        If Alt = 3 Or (Alt = 4 And Mesgar > 0) Then
'            If topobe > 200 And Mesgar > 0 Then GoTo 1000
'        End If
'        For j = 1 To Nben
'            'Definicion de pension del beneficiario
'            'como pension de referencia por porcentaje de pension
'            Penben(j) = penbase * Porcbe(j)
'            RmBenT = 0
'            sumapx = 0
'            sumapxr = 0
'            sumapxc = 0
'            sumaqx = 0
'            Sumaqxr = 0
'            Sumaqxc = 0
'            Rmcau = 0
'            RmcauC = 0
'            RmcauR = 0
'            Cmcau = 0
'            CmcauR = 0
'            CmcauC = 0
'            factor = 0
'            factorr = 0
'            factorc = 0
'            factoa = 0
'            factoar = 0
'            factoac = 0
'            Rmben = 0
'            RmbenR = 0
'            RmbenC = 0
'            sumapx = 0
'            sumapxr = 0
'            sumapxc = 0
'            Supxpy = 0
'            Supxpyr = 0
'            Supxpyc = 0
'            rmb1 = 0
'            rmb1r = 0
'            rmb1c = 0
'            rmb2 = 0
'            rmb2r = 0
'            rmb2c = 0
'            edabe = 0
'            If Derpen(j) <> 10 Then
'                Nubenp = Nubenp + 1
'                'CALCULO DE LA RESERVA DEL AFILIADO
'                If Ncorbe(j) = 99 And j = 1 Then
'                    ni = 0
'                    Select Case (Coinbe(j))
'                        Case "S", "T": ni = 1
'                        Case "N": ni = 2
'                        Case "P": ni = 3
'                        Case Else
'                            vgError = 1017
'                            Exit Function
'                    End Select
'                    ns = 0
'                    Select Case (Sexobe(j))
'                        Case "M": ns = 1
'                        Case "F": ns = 2
'                        Case Else
'                            vgError = 1018
'                            Exit Function
'                    End Select
'                    'Calculo de edad del causante
'                    Fechan = Nanbe(j) * 12 + Nmnbe(j)
'                    edaca = Fechap - Fechan
'                    difdia = idp - Ndnbe(j)
'                    If difdia > 15 Then edaca = edaca + 1
'                    If edaca <= 216 Then edaca = 216
'                    If edaca > Fintab Then
'                        vgError = 1023
'                        Exit Function
'                    End If
'                    limite1 = Fintab - edaca - 1
'                    For i = 0 To limite1
'                        edacai = edaca + i
'                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
'                        If i < nmdiga Then px = 1
'                        If i < perdif Then px = 0
'                        edacas = edacai + 1
'                        Qx = ((Lx(ns, ni, edacai) - Lx(ns, ni, edacas))) / Lx(ns, ni, edaca)
'                        If i < perdif Then Qx = 0
'                        sumapxr = sumapxr + px / tmtce ^ i
'                        Sumaqxr = Sumaqxr + Qx / tmtce ^ (0.5 + i)
'                        sumapx = sumapx + px / tmtce ^ i
'                        sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                    Next i
'                    Cmcau = GtoFun * sumaqx
'                    CmcauR = GtoFun * Sumaqxr
'                    CmcauC = GtoFun * Sumaqxc
'                    RmcauR = sumapxr * Penben(j) + CmcauR
'                    RmcauC = sumapxc * Penben(j) + CmcauC
'                    Rmcau = sumapx * Penben(j) + Cmcau
'                    rmpol = Rmcau
'                    RmpolR = RmcauR
'                    RmpolC = RmcauC
'                    Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
'                    Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
'                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmcauR
'                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmcauC
'                    RmBenT = RmcauR + RmcauC
'                    'NPOLCA,NUMOR(J),RMBENT,RMCAUR,RMCAUC
'                    'NUMOR(J),NCORBE(J),SEXOBE(J),COINBE(J),NANBE(J),NMNBE(J),EDACA,PENBEN(J),SUMAPX,CMCAU,RMCAU
'                    'Ani - Daj
'                    vlPolRet = vlPolRet + 1
'                    vlBenRet = vlBenRet + 1
'
'                    ''Grabar los datos de los Beneficiarios calculados
'                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
'                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edaca, "#0")) & ", "
'                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format((sumapx + sumapx_g), "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(Cmcau, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmcauC, "#0.00")) & ", "
'                    ''vgQuery = vgQuery & "mto_cnREND = " & Str(Format(Rmcau - RMCAUC, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmcau, "#0.00")) - CDbl(Format(RmcauC, "#0.00"))) & ", "
'                    ''vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(Rmcau, "#0.00")) & " "
'                    'vgQuery = vgQuery & "mto_cnTEND = " & Str(Format(rmpol, "#0.00")) & " "
'                    'vgQuery = vgQuery & "where "
'                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
'                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
'                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
'                    'vgConexionBD.Execute (vgQuery)
'            Else
'                    'RESERVA DE LOS BENEFICIARIOS
'                    nibe = 0
'                    Select Case (Coinbe(j))
'                        Case "S", "T": nibe = 1
'                        Case "N": nibe = 2
'                        Case "P": nibe = 3
'                        Case Else
'                            vgError = 1017
'                            Exit Function
'                    End Select
'                    nsbe = 0
'                    Select Case (Sexobe(j))
'                        Case "M", "T": nsbe = 1
'                        Case "F": nsbe = 2
'                        Case Else
'                            vgError = 1018
'                            Exit Function
'                    End Select
'                    'Calculo de la edad del beneficiario
'                    Fechan = (Nanbe(j) * 12 + Nmnbe(j))
'                    edabe = Fechap - Fechan
'                    difdia = idp - Ndnbe(j)
'                    If difdia > 15 Then edabe = edabe + 1
'                    If edabe < 1 Then edabe = 1
'                    If edabe > Fintab Then
'                        vgError = 1023
'                        Exit Function
'                    End If
'                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or Ncorbe(j) = 20 Or _
'                        Ncorbe(j) = 21 Or Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
'                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And _
'                        (Coinbe(j) <> "N" And edabe > L24)) Then
'                        'RESERVA VIDAS CONJUNTAS VITALICIAS
'                        'Probabilidad del beneficiario solo
'                        limite1 = Fintab - edabe - 1
'                        For i = 0 To limite1
'                            edalbe = edabe + i
'                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                            If i < nmdiga Then py = 0
'                            If i < perdif Then py = 0
'                            sumapxr = sumapxr + py / tmtce ^ i
'                            sumapx = sumapx + py / tmtce ^ i
'                        Next i
'                        'Probabilidad conjunta de causante y beneficiario
'                        limite2 = Fintab - edaca - 1
'                        limite = amin0(limite1, limite2)
'                        For i = 0 To limite
'                            edalca = edaca + i
'                            edalbe = edabe + i
'                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                            If i < nmdiga Then py = 0
'                            If i < perdif Then py = 0
'                            Supxpyr = Supxpyr + (py * px) / tmtce ^ i
'                            Supxpy = Supxpy + (py * px) / tmtce ^ i
'                        Next i
'                        factor = sumapx - Supxpy
'                        factorr = sumapxr - Supxpyr
'                        factorc = sumapxc - Supxpyc
'                        rmb1 = factor * Penben(j)
'                        rmb1r = factorr * Penben(j)
'                        rmb1c = factorc * Penben(j)
'                        Rmben = rmb1
'                        RmbenR = rmb1r
'                        RmbenC = rmb1c
'                        If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
'                            'RESERVA POR DERECHO A ACRECER
'                            edhm = (Fechap - (Ijam(j) * 12 + Ijmn(j)))
'                            difdia = idp - ijdn(j)
'                            If difdia > 15 Then edhm = edhm + 1
'                            If Codcbe(j) <> "N" Then
'                                If edhm > L24 Then
'                                    nmdif = 0
'                                Else
'                                    If edhm >= L18 Then
'                                        nmdif = L24 - edhm
'                                    Else
'                                        nmdif = L21 - edhm
'                                    End If
'                                End If
'                                Ebedif = edabe + nmdif
'                                sumapx = 0
'                                sumapxr = 0
'                                sumapxc = 0
'                                Supxpy = 0
'                                Supxpyr = 0
'                                Supxpyc = 0
'                                'Probabilidad del beneficiario solo
'                                limite1 = Fintab - Ebedif - 1
'                                For i = 0 To limite1
'                                    edcadi = Ebedif + i
'                                    py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
'                                    inmdif = i + nmdif
'                                    If inmdif < nmdiga Then py = 0
'                                    If inmdif < perdif Then py = 0
'                                    sumapxr = sumapxr + py / tmtce ^ inmdif
'                                    sumapx = sumapx + py / tmtce ^ inmdif
'                                Next i
'                                'Probabilidad conjunta del causante y beneficiario
'                                Ecadif = edaca + nmdif
'                                limite4 = Fintab - Ecadif - 1
'                                limite = amin0(limite1, limite4)
'                                For i = 0 To limite
'                                    edalca = Ecadif + i
'                                    edalbe = Ebedif + i
'                                    nmdifi = nmdif + i
'                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                                    If nmdifi < nmdiga Then py = 0
'                                    If nmdifi < perdif Then py = 0
'                                    Supxpyr = Supxpyr + (py * px) / tmtce ^ nmdifi
'                                    Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
'                                Next i
'                                vipen = 0.2 * Penben(j)
'                                factoa = sumapx - Supxpy
'                                factoar = sumapxr - Supxpyr
'                                factoac = sumapxc - Supxpyc
'                                rmb2 = factoa * vipen
'                                rmb2r = factoar * vipen
'                                rmb2c = factoac * vipen
'                                Rmben = rmb1 + rmb2
'                                RmbenR = rmb1r + rmb2r
'                                RmbenC = rmb1c + rmb2c
'                            End If  'Fin Codcbe(j) <> "N"
'                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
'                    Else
'                        'RESERVA RENTAS TEMPORALES
'                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
'                            If edabe <= L24 Then
'                                If edabe >= L18 Then
'                                    mdif = L24 - edabe
'                                Else
'                                    mdif = L21 - edabe
'                                End If
'                                nmdif = mdif
'                                sumapx = 0
'                                sumapxr = 0
'                                sumapxc = 0
'                                Supxpy = 0
'                                Supxpyr = 0
'                                Supxpyc = 0
'                                'Probabilidad conjunta del causante y beneficiario
'                                limite2 = Fintab - edaca
'                                limite = amin0(nmdif, limite2) - 1
'                                For i = 0 To limite
'                                    edalca = edaca + i
'                                    edalbe = edabe + i
'                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                                    If i < nmdiga Then py = 0
'                                    If i < perdif Then py = 0
'                                    sumapxr = sumapxr + py / tmtce ^ i
'                                    Supxpyr = Supxpyr + (py * px) / tmtce ^ i
'                                    sumapx = sumapx + py / tmtce ^ i
'                                    Supxpy = Supxpy + (py * px) / (tmtce ^ i)
'                                Next i
'                                factor = sumapx - Supxpy
'                                factorr = sumapxr - Supxpyr
'                                factorc = sumapxc - Supxpyc
'                                rmb1 = factor * Penben(j)
'                                rmb1r = factorr * Penben(j)
'                                rmb1c = factorc * Penben(j)
'                                'RESERVA DEL HIJO INVALIDO
'                                If Coinbe(j) <> "N" Then
'                                    sumapx = 0
'                                    sumapxr = 0
'                                    sumapxc = 0
'                                    Supxpy = 0
'                                    Supxpyr = 0
'                                    Supxpyc = 0
'                                    'Probabilidad conjunta del causante y beneficiario
'                                    edbedi = edabe + nmdif
'                                    limite3 = Fintab - edbedi - 1
'                                    limite4 = Fintab - (edaca + nmdif) - 1
'                                    For i = 0 To limite3
'                                        nmdifi = nmdif + i
'                                        edalca = edaca + nmdif + i
'                                        edalbe = edbedi + i
'                                        edalca = amin0(edalca, Fintab)
'                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                                        If nmdifi < nmdiga Then py = 0
'                                        If nmdifi < perdif Then py = 0
'                                        sumapxr = sumapxr + py / tmtce ^ nmdifi
'                                        Supxpyr = Supxpyr + (py * px) / tmtce ^ nmdifi
'                                        sumapx = sumapx + py / tmtce ^ nmdifi
'                                        Supxpy = Supxpy + (py * px) / (tmtce ^ nmdifi)
'                                    Next i
'                                    factoa = sumapx - Supxpy
'                                    factoar = sumapxr - Supxpyr
'                                    factoac = sumapxc - Supxpyc
'                                    vipen = penbase * 0.15
'                                    If (Navig = 1990 And Nmvig >= 8) Then vipen = Penben(j)
'                                    If (Navig > 1990) Then vipen = Penben(j)
'                                    Rmben = rmb1 + factoa * vipen
'                                    RmbenR = rmb1r + factoar * vipen
'                                    RmbenC = rmb1c + factoac * vipen
'                                Else
'                                    If Coinbe(j) = "N" Then
'                                        Rmben = rmb1
'                                        RmbenR = rmb1r
'                                        RmbenC = rmb1c
'                                    End If
'206:
'                                End If  'Fin    coinbe(j) <> "N"
'                            End If  'Fin    Edabe < L24
'                        End If  'Fin    ncorbe(j) >= 30 And ncorbe(j) < 40
'                    End If  'Fin ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or _
'                            ncorbe(j) = 21 Or ncorbe(j) = 41 Or ncorbe(j) = 42 Or _
'                            ((ncorbe(j) >= 30 And ncorbe(j) < 40) And _
'                            (coinbe(j) <> "N" And Edabe > L24))
'                    RmBenT = RmbenR + RmbenC
'                    'NPOLCA,NUMOR(J),RMBENT,RMBENR,RMBENC
'                    'NUMOR(J),NCORBE(J),SEXOBE(J),COINBE(J),NANBE(J),NMNBE(J),EDABE,PENBEN(J),FACTOR,FACTOA,RMBEN
'                    Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
'                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
'                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
'                    rmpol = rmpol + Rmben
'                    RmpolR = RmpolR + RmbenR
'                    RmpolC = RmpolC + RmbenC
'
'                    'Ani - Dani
'                    ''Grabar los datos de los Beneficiarios calculados
'                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
'                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
'                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
'                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
'                    'vgQuery = vgQuery & "where "
'                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
'                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
'                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
'                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
'                    'vgConexionBD.Execute (vgQuery)
'                    vlBenRet = vlBenRet + 1
'102:
'                End If  'Fin Ncorbe(j) = 99 And j = 1
'            End If  'Fin
'        Next j
'            ' RMPOL
'            NumPro = NumPro + 1
'            'Ani - Dani
'
'        ''Grabar los Totales en la Póliza
'        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
'        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
'        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
'        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
'        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
'        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
'        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
'        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
'        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
'        'vgConexionBD.Execute (vgQuery)
'
'        If (Vuelta = 1) Then
'            vlReservaOriginal = Format(rmpol, "#0.00")
'        Else
'            vlReservaCalculada = Format(rmpol, "#0.00")
'        End If
'
'    Exit Function
'        'PORCENTAJE MAYOR AL 100%
'1000:
'        For ib = 1 To Fintab
'            flumax(ib) = 0
'        Next ib
'        'FLUJOS DE RENTAS VITALICIAS DE VEJEZ E INVALIDEZ
'        For j = 1 To Nben
'            If Derpen(j) <> 10 Then
'                Penben(j) = penbase * Porcbe(j)
'                Nbpr = Nbpr + 1
'                'CALCULO DE LA RESERVA DEL AFILIADO
'                If Ncorbe(j) = 99 And j = 1 Then
'                    ni = 0
'                    Select Case (Coinbe(j))
'                        Case "S", "T": ni = 1
'                        Case "N": ni = 2
'                        Case "P": ni = 3
'                        Case Else
'                            vgError = 1017
'                            Exit Function
'                    End Select
'                    ns = 0
'                    Select Case (Sexobe(j))
'                        Case "M": ns = 1
'                        Case "F": ns = 2
'                        Case Else
'                            vgError = 1018
'                            Exit Function
'                    End Select
'                    'Calculo de edad del causante
'                    Fechan = Nanbe(j) * 12 + Nmnbe(j)
'                    edaca = Fechap - Fechan
'                    difdia = idp - Ndnbe(j)
'                    If difdia > 15 Then edaca = edaca + 1
'                    If edaca <= 216 Then edaca = 216
'                    If edaca > Fintab Then
'                        vgError = 1023
'                        Exit Function
'                    End If
'                    limite1 = Fintab - edaca - 1
'                    For i = 0 To limite1
'                        imas1 = i + 1
'                        edacai = edaca + i
'                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
'                        edacas = edacai + 1
'                        flumax(imas1) = flumax(imas1) + (px * Penben(j))
'                    Next i
'                Else
'                    'RESERVA DE LOS BENEFICIARIOS
'                    nibe = 0
'                    Select Case (Coinbe(j))
'                        Case "S", "T": nibe = 1
'                        Case "N": nibe = 2
'                        Case "P": nibe = 3
'                        Case Else
'                            vgError = 1017 'VGerrOR = 2
'                            'salir de la funcion
'                            Exit Function
'                    End Select
'                    nsbe = 0
'                    Select Case (Sexobe(j))
'                        Case "M", "T": nsbe = 1
'                        Case "F": nsbe = 2
'                        Case Else
'                            vgError = 1018 'VGerrOR = 3
'                            'salir de la funcion
'                            Exit Function
'                    End Select
'                    'Calculo de la edad del beneficiario
'                    Fechan = (Nanbe(j) * 12 + Nmnbe(j))
'                    edabe = Fechap - Fechan
'                    difdia = idp - Ndnbe(j)
'                    If difdia > 15 Then edabe = edabe + 1
'                    If edabe < 1 Then edabe = 1
'                    If edabe > Fintab Then
'                        vgError = 1023
'                        Exit Function
'                    End If
'                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or Ncorbe(j) = 20 Or _
'                        Ncorbe(j) = 21 Or Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
'                        ((Ncorbe(j) >= 30 And Ncorbe(j) < 40) And _
'                        (Coinbe(j) <> "N" And edabe > L24)) Then
'                        'FLUJOS DE VIDAS CONJUNTAS VITALICIAS
'                        'Probabilidad del beneficiario solo
'                        limite1 = Fintab - edabe - 1
'                        For i = 0 To limite1
'                            imas1 = i + 1
'                            edalbe = edabe + i
'                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                            flumax(imas1) = flumax(imas1) + (py * Penben(j))
'                        Next i
'                        'Probabilidad conjunta de causante y beneficiario
'                        limite2 = Fintab - edaca - 1
'                        limite = amin0(limite1, limite2)
'                        For i = 0 To limite
'                            imas1 = i + 1
'                            edalca = edaca + i
'                            edalbe = edabe + i
'                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                            flumax(imas1) = flumax(imas1) - (py * px * Penben(j))
'                        Next i
'                        If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
'                            'FLUJO POR DERECHO A ACRECER
'                            edhm = (Fechap - (Ijam(j) * 12 + Ijmn(j)))
'                            difdia = idp - ijdn(j)
'                            If difdia > 15 Then edhm = edhm + 1
'                            If Codcbe(j) <> "N" Then
'                                If edhm > L24 Then
'                                    nmdif = 0
'                                Else
'                                    If edhm >= L18 Then
'                                        nmdif = L24 - edhm
'                                    Else
'                                        nmdif = L21 - edhm
'                                    End If
'                                End If
'                                Ebedif = edabe + nmdif
'                                'Probabilidad del beneficiario solo
'                                limite1 = Fintab - Ebedif - 1
'                                For i = 0 To limite1
'                                    edalbe = Ebedif + i
'                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                    nmdifi = nmdif + i
'                                    imas1 = nmdifi + 1
'                                    flumax(imas1) = flumax(imas1) + (py * Penben(j) * 0.2)
'                                Next i
'                                'Probabilidad conjunta del causante y beneficiario
'                                Ecadif = edaca + nmdif
'                                limite4 = Fintab - Ecadif - 1
'                                limite = amin0(limite1, limite4)
'                                For i = 0 To limite
'                                    edalca = Ecadif + i
'                                    edalbe = Ebedif + i
'                                    nmdifi = nmdif + i
'                                    imas1 = nmdifi + 1
'                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                                    flumax(imas1) = flumax(imas1) - (py * px * Penben(j) * 0.2)
'                                Next i
'                            End If  'Fin    codcbe(j) <> "N"
'                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
'                    Else
'                        'RESERVA RENTAS TEMPORALES
'                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
'                            If edabe <= L24 Then
'                                If edabe >= L18 Then
'                                    mdif = L24 - edabe
'                                Else
'                                    mdif = L21 - edabe
'                                End If
'                                nmdif = mdif
'                                'Probabilidad conjunta del causante y beneficiario
'                                limite2 = Fintab - edaca
'                                limite = amin0(nmdif, limite2) - 1
'                                For i = 0 To limite
'                                    imas1 = i + 1
'                                    edalca = edaca + i
'                                    edalbe = edabe + i
'                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                                    flumax(imas1) = flumax(imas1) + (py * Penben(j) - py * px * Penben(j))
'                                Next i
'                                'RESERVA DEL HIJO INVALIDO
'                                If Coinbe(j) <> "N" Then
'                                    'Probabilidad conjunta del causante y beneficiario
'                                    edbedi = edabe + nmdif
'                                    limite3 = Fintab - edbedi - 1
'                                    limite4 = Fintab - (edaca + nmdif) - 1
'                                    For i = 0 To limite3
'                                        nmdifi = nmdif + i
'                                        imas1 = nmdifi + 1
'                                        edalca = edaca + nmdif + i
'                                        edalbe = edbedi + i
'                                        edalca = amin0(edalca, Fintab)
'                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                                        vipen = penbase * 0.15
'                                        If (Navig = 1990 And Nmvig >= 8) Then vipen = penbase * Porcbe(j)
'                                        If (Navig > 1990) Then vipen = penbase * Porcbe(j)
'                                        flumax(imas1) = flumax(imas1) + (py - py * px) * vipen
'                                    Next i
'                                End If  'Fin    coinbe(j) <> "N"
'                            End If  'Fin    Edabe < L24
'                        End If  'Fin    (ncorbe(j) >= 30 And ncorbe(j) < 40)
'                    End If  'Fin    ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or _
'                                    ncorbe(j) = 21 Or ncorbe(j) = 41 Or ncorbe(j) = 42 Or _
'                                    ((ncorbe(j) >= 30 And ncorbe(j) < 40) And _
'                                    (coinbe(j) <> "N" And Edabe > L24))
'                End If  'Fin    ncorbe(j) = 99 And j = 1
'            End If  'fIN DERECHO A PENSION
'        Next j
'        If (topobe > 200) Then
'            For ll = 1 To nmdiga
'                If (penbase > flumax(ll)) Then GoTo 1003
'            Next ll
'1003:       limgar = ll
'        End If
'
'        'CALCULO DE RESERVA BASE A POLIZAS CON PORCENTAJE MAYOR AL 100%
'        'RESERVA MATEMATICA PARA VEJEZ E INVALIDEZ
'        For j = 1 To Nben
'            Penben(j) = penbase * Porcbe(j)
'            edabe = 0
'            sumapx = 0
'            sumapxr = 0
'            sumapxc = 0
'            sumaqx = 0
'            Sumaqxr = 0
'            Sumaqxc = 0
'            Rmcau = 0
'            RmcauC = 0
'            RmcauR = 0
'            Cmcau = 0
'            CmcauR = 0
'            CmcauC = 0
'            factor = 0
'            factorr = 0
'            factorc = 0
'            factoa = 0
'            factoar = 0
'            factoac = 0
'            Rmben = 0
'            RmbenR = 0
'            RmbenC = 0
'            sumapx = 0
'            sumapxr = 0
'            sumapxc = 0
'            Supxpy = 0
'            Supxpyr = 0
'            Supxpyc = 0
'            RmBenT = 0
'            rmb1 = 0
'            rmb1r = 0
'            rmb1c = 0
'            rmb2 = 0
'            rmb2r = 0
'            rmb2c = 0
'            If Derpen(j) <> 10 Then
'                Nubenp = Nubenp + 1
'                'CALCULO DE LA RESERVA DEL AFILIADO
'                If Ncorbe(j) = 99 And j = 1 Then
'                    ni = 0
'                    Select Case (Coinbe(j))
'                        Case "S", "T": ni = 1
'                        Case "N": ni = 2
'                        Case "P": ni = 3
'                        Case Else
'                            vgError = 1017
'                            Exit Function
'                    End Select
'                    ns = 0
'                    Select Case (Sexobe(j))
'                        Case "M": ns = 1
'                        Case "F": ns = 2
'                        Case Else
'                            vgError = 1018
'                            Exit Function
'                    End Select
'                    'Calculo de edad del causante
'                    Fechan = Nanbe(j) * 12 + Nmnbe(j)
'                    edaca = Fechap - Fechan
'                    difdia = idp - Ndnbe(j)
'                    If difdia > 15 Then edaca = edaca + 1
'                    If edaca <= 216 Then edaca = 216
'                    If edaca > Fintab Then
'                        vgError = 1023
'                        Exit Function
'                    End If
'                    limite1 = Fintab - edaca - 1
'                    For i = 0 To limite1
'                        edacai = edaca + i
'                        px = Lx(ns, ni, edacai) / Lx(ns, ni, edaca)
'                        If i < limgar Then
'                            px1 = px
'                        Else
'                            If (i >= limgar And i < nmdiga) Then
'                                px1 = 1
'                            Else
'                                px1 = px
'                            End If
'                        End If
'                        If i < perdif Then px1 = 0
'                        edacas = edacai + 1
'                        Qx = ((Lx(ns, ni, edacai) - Lx(ns, ni, edacas))) / Lx(ns, ni, edaca)
'                        If i < perdif Then Qx = 0
'                        sumapxr = sumapxr + px1 / tmtce ^ i
'                        Sumaqxr = Sumaqxr + Qx / tmtce ^ (0.5 + i)
'                        sumapx = sumapx + px1 / tmtce ^ i
'                        sumaqx = sumaqx + Qx / tmtce ^ (0.5 + i)
'                    Next i
'                    Cmcau = GtoFun * sumaqx
'                    CmcauR = GtoFun * Sumaqxr
'                    CmcauC = GtoFun * Sumaqxc
'                    RmcauR = sumapxr * Penben(j) + CmcauR
'                    RmcauC = sumapxc * Penben(j) + CmcauC
'                    Rmcau = sumapx * Penben(j) + Cmcau
'                    rmpol = Rmcau
'                    RmpolR = RmcauR
'                    RmpolC = RmcauC
'                    Rmcob(nv, 1, ncobe, 1) = Rmcob(nv, 1, ncobe, 1) + 1
'                    Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
'                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmcauR
'                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmcauC
'                    RmBenT = RmcauR + RmcauC
'                    ' NPOLCA,NUMOR(J),RMBENT,RMCAUR,RMCAUC
'                    ' NUMOR(J),NCORBE(J),SEXOBE(J),COINBE(J),NANBE(J),NMNBE(J),EDACA,PENBEN(J),SUMAPX,CMCAU,RMCAU
'                    'Ani - Dani
'                    vlPolRet = vlPolRet + 1
'                    vlBenRet = vlBenRet + 1
'
'                    ''Grabar los datos de los Beneficiarios calculados
'                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
'                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
'                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
'                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
'                    'vgQuery = vgQuery & "where "
'                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
'                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
'                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
'                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
'                    'vgConexionBD.Execute (vgQuery)
'                Else
'                    'RESERVA DE LOS BENEFICIARIOS
'                    nibe = 0
'                    Select Case (Coinbe(j))
'                        Case "S", "T": nibe = 1
'                        Case "N": nibe = 2
'                        Case "P": nibe = 3
'                        Case Else
'                            vgError = 1017
'                            Exit Function
'                    End Select
'                    nsbe = 0
'                    Select Case (Sexobe(j))
'                        Case "M", "T": nsbe = 1
'                        Case "F": nsbe = 2
'                        Case Else
'                            vgError = 1018
'                            Exit Function
'                    End Select
'                    'Calculo de la edad del beneficiario
'                    Fechan = (Nanbe(j) * 12 + Nmnbe(j))
'                    edabe = Fechap - Fechan
'                    difdia = idp - Ndnbe(j)
'                    If difdia > 15 Then edabe = edabe + 1
'                    If edabe < 1 Then edabe = 1
'                    If edabe > Fintab Then
'                        vgError = 1023
'                        Exit Function
'                    End If
'                    If Ncorbe(j) = 10 Or Ncorbe(j) = 11 Or Ncorbe(j) = 20 Or _
'                        Ncorbe(j) = 21 Or Ncorbe(j) = 41 Or Ncorbe(j) = 42 Or _
'                        ((Coinbe(j) <> "N" And edabe > L24) And _
'                        (Ncorbe(j) >= 30 And Ncorbe(j) < 40)) Then
'                        'RESERVA VIDAS CONJUNTAS VITALICIAS
'                        'Probabilidad del beneficiario solo
'                        limite1 = Fintab - edabe - 1
'                        For i = 0 To limite1
'                            edalbe = edabe + i
'                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                            If i < limgar Then
'                              py1 = py
'                            Else
'                                If (i >= limgar And i < nmdiga) Then
'                                    py1 = 0
'                                Else
'                                    py1 = py
'                                End If
'                            End If
'                            If i < perdif Then py1 = 0
'                            sumapxr = sumapxr + py1 / tmtce ^ i
'                            sumapx = sumapx + py1 / tmtce ^ i
'                        Next i
'                        'Probabilidad conjunta de causante y beneficiario
'                        limite2 = Fintab - edaca - 1
'                        limite = amin0(limite1, limite2)
'                        For i = 0 To limite
'                            edalca = edaca + i
'                            edalbe = edabe + i
'                            py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                            px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'
'                            If i < limgar Then
'                                py1 = py
'                            Else
'                                If (i >= limgar And i < nmdiga) Then
'                                    py1 = 0
'                                Else
'                                    py1 = py
'                                End If
'                            End If
'                            If i < perdif Then py1 = 0
'                            Supxpyr = Supxpyr + (py1 * px) / tmtce ^ i
'                            Supxpy = Supxpy + (py1 * px) / tmtce ^ i
'                        Next i
'                        factor = sumapx - Supxpy
'                        factorr = sumapxr - Supxpyr
'                        factorc = sumapxc - Supxpyc
'                        rmb1 = factor * Penben(j)
'                        rmb1r = factorr * Penben(j)
'                        rmb1c = factorc * Penben(j)
'                        Rmben = rmb1
'                        RmbenR = rmb1r
'                        RmbenC = rmb1c
'                        'RESERVA POR DERECHO A ACRECER
'                        If Ncorbe(j) = 11 Or Ncorbe(j) = 21 Then
'                            edhm = (Fechap - (Ijam(j) * 12 + Ijmn(j)))
'                            difdia = idp - ijdn(j)
'                            If difdia > 15 Then edhm = edhm + 1
'                            If Codcbe(j) <> "N" Then
'                                If edhm > L24 Then
'                                    nmdif = 0
'                                Else
'                                    If edhm >= L18 Then
'                                        nmdif = L24 - edhm
'                                    Else
'                                        nmdif = L21 - edhm
'                                    End If
'                                End If
'                                Ebedif = edabe + nmdif
'                                sumapx = 0
'                                sumapxr = 0
'                                sumapxc = 0
'                                Supxpy = 0
'                                Supxpyr = 0
'                                Supxpyc = 0
'                                'Probabilidad del beneficiario solo
'                                limite1 = Fintab - Ebedif - 1
'                                For i = 0 To limite1
'                                    edcadi = Ebedif + i
'                                    py = Ly(nsbe, nibe, edcadi) / Ly(nsbe, nibe, edabe)
'                                    inmdif = i + nmdif
'                                    If inmdif < limgar Then
'                                        py1 = py
'                                    Else
'                                        If inmdif >= limgar And inmdif < nmdiga Then
'                                            py1 = 0
'                                        Else
'                                            py1 = py
'                                        End If
'                                    End If
'                                    If inmdif < perdif Then py1 = 0
'                                    sumapxr = sumapxr + py1 / tmtce ^ inmdif
'                                    sumapx = sumapx + py1 / tmtce ^ inmdif
'                                Next i
'                                'Probabilidad conjunta del causante y beneficiario
'                                Ecadif = edaca + nmdif
'                                limite4 = Fintab - Ecadif - 1
'                                limite = amin0(limite1, limite4)
'                                For i = 0 To limite
'                                    edalca = Ecadif + i
'                                    edalbe = Ebedif + i
'                                    nmdifi = nmdif + i
'                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                                    If nmdifi < limgar Then
'                                        py1 = py
'                                    Else
'                                        If nmdifi >= limgar And nmdifi < nmdiga Then
'                                            py1 = 0
'                                        Else
'                                            py1 = py
'                                        End If
'                                    End If
'                                    If nmdifi < perdif Then py1 = 0
'                                    Supxpyr = Supxpyr + (py1 * px) / tmtce ^ nmdifi
'                                    Supxpy = Supxpy + (py1 * px) / (tmtce ^ nmdifi)
'                                Next i
'                                vipen = 0.2 * Penben(j)
'                                factoa = sumapx - Supxpy
'                                factoar = sumapxr - Supxpyr
'                                factoac = sumapxc - Supxpyc
'                                rmb2 = factoa * vipen
'                                rmb2r = factoar * vipen
'                                rmb2c = factoac * vipen
'                                Rmben = rmb1 + rmb2
'                                RmbenR = rmb1r + rmb2r
'                                RmbenC = rmb1c + rmb2c
'                            End If  'Fin CODCBE(j) <> "N"
'                        End If  'Fin ncorbe(j) = 11 Or ncorbe(j) = 21
'                    Else
'                        'RESERVA RENTAS TEMPORALES
'                        If Ncorbe(j) >= 30 And Ncorbe(j) < 40 Then
'                            If edabe <= L24 Then
'                                If edabe >= L18 Then
'                                    mdif = L24 - edabe
'                                Else
'                                    mdif = L21 - edabe
'                                End If
'                                nmdif = mdif
'                                sumapx = 0
'                                sumapxr = 0
'                                sumapxc = 0
'                                Supxpy = 0
'                                Supxpyr = 0
'                                Supxpyc = 0
'                                'Probabilidad conjunta del causante y beneficiario
'                                limite2 = Fintab - edaca
'                                limite = amin0(nmdif, limite2) - 1
'                                For i = 0 To limite
'                                    edalca = edaca + i
'                                    edalbe = edabe + i
'                                    py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                    px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                                    If i < limgar Then
'                                      py1 = py
'                                    Else
'                                        If (i >= limgar And i < nmdiga) Then
'                                            py1 = 0
'                                        Else
'                                            py1 = py
'                                        End If
'                                    End If
'                                    If i < perdif Then py1 = 0
'                                    sumapxr = sumapxr + py1 / tmtce ^ i
'                                    Supxpyr = Supxpyr + (py1 * px) / tmtce ^ i
'                                Next i
'                                factor = sumapx - Supxpy
'                                factorr = sumapxr - Supxpyr
'                                factorc = sumapxc - Supxpyc
'                                rmb1 = factor * Penben(j)
'                                rmb1r = factorr * Penben(j)
'                                rmb1c = factorc * Penben(j)
'                                'RESERVA DEL HIJO INVALIDO
'                                If Coinbe(j) <> "N" Then
'                                    sumapx = 0
'                                    sumapxr = 0
'                                    sumapxc = 0
'                                    Supxpy = 0
'                                    Supxpyr = 0
'                                    Supxpyc = 0
'                                    'Probabilidad conjunta del causante y beneficiario
'                                    edbedi = edabe + nmdif
'                                    limite3 = Fintab - edbedi - 1
'                                    limite4 = Fintab - (edaca + nmdif) - 1
'                                    For i = 0 To limite3
'                                        nmdifi = nmdif + i
'                                        edalca = edaca + nmdif + i
'                                        edalbe = edbedi + i
'                                        edalca = amin0(edalca, Fintab)
'                                        py = Ly(nsbe, nibe, edalbe) / Ly(nsbe, nibe, edabe)
'                                        px = Lx(ns, ni, edalca) / Lx(ns, ni, edaca)
'                                        If nmdifi < limgar Then
'                                            py1 = py
'                                        Else
'                                            If nmdifi >= limgar And nmdifi < nmdiga Then
'                                                py1 = 0
'                                            Else
'                                                py1 = py
'                                            End If
'                                        End If
'                                        If nmdifi < perdif Then py1 = 0
'
'                                        sumapxr = sumapxr + py1 / tmtce ^ nmdifi
'                                        Supxpyr = Supxpyr + (py1 * px) / tmtce ^ nmdifi
'                                        sumapx = sumapx + py1 / tmtce ^ nmdifi
'                                        Supxpy = Supxpy + (py1 * px) / (tmtce ^ nmdifi)
'                                    Next i
'                                    factoa = sumapx - Supxpy
'                                    factoar = sumapxr - Supxpyr
'                                    factoac = sumapxc - Supxpyc
'                                    vipen = penbase * 0.15
'                                    If (Navig = 1990 And Nmvig >= 8) Then vipen = Penben(j)
'                                    If (Navig > 1990) Then vipen = Penben(j)
'                                    Rmben = rmb1 + factoa * vipen
'                                    RmbenR = rmb1r + factoar * vipen
'                                    RmbenC = rmb1c + factoac * vipen
'                                Else
'                                    If Coinbe(j) = "N" Then
'                                        Rmben = rmb1
'                                        RmbenR = rmb1r
'                                        RmbenC = rmb1c
'                                    End If
'                                End If
'                            End If  'Fin EDABE < L24
'                        End If  'Fin ncorbe(j) >= 30 And ncorbe(j) < 40
'                    End If  'Fin ncorbe(j) = 10 Or ncorbe(j) = 11 Or ncorbe(j) = 20 Or _
'                            ncorbe(j) = 21 Or ncorbe(j) = 41 Or ncorbe(j) = 42 Or _
'                            ((coinbe(j) <> "N" And Edabe > L24) And _
'                            (ncorbe(j) >= 30 And ncorbe(j) < 40))
'                    RmBenT = RmbenR + RmbenC
'                    'NPOLCA,NUMOR(J),RMBENT,RMBENR,RMBENC
'                    'NUMOR(J),NCORBE(J),SEXOBE(J),COINBE(J),NANBE(J),NMNBE(J),EDABE,PENBEN(J),FACTOR,FACTOA,RMBEN
'                    Rmcob(nv, 1, ncobe, 2) = Rmcob(nv, 1, ncobe, 2) + 1
'                    Rmcob(nv, 2, ncobe, 3) = Rmcob(nv, 2, ncobe, 3) + RmbenC
'                    Rmcob(nv, 1, ncobe, 3) = Rmcob(nv, 1, ncobe, 3) + RmbenR
'                    rmpol = rmpol + Rmben
'                    RmpolR = RmpolR + RmbenR
'                    RmpolC = RmpolC + RmbenC
'                    'Ani - Dani
'
'                    ''Grabar los datos de los Beneficiarios calculados
'                    'vgQuery = "UPDATE PR_TMAE_ENDOSOBEN set "
'                    'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'                    'vgQuery = vgQuery & "NUM_EDAD = " & Str(Format(edabe, "#0")) & ", "
'                    'vgQuery = vgQuery & "mto_cnuEND = " & Str(Format(factor, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnaEND = " & Str(Format(factoa, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnCEND = " & Str(Format(RmbenC, "#0.00")) & ", "
'                    'vgQuery = vgQuery & "mto_cnREND = " & Str(CDbl(Format(Rmben, "#0.00")) - CDbl(Format(RmbenC, "#0.00"))) & ", "
'                    'vgQuery = vgQuery & "mto_cntEND = " & Str(Format(Rmben, "#0.00")) & " "
'                    'vgQuery = vgQuery & "where "
'                    'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
'                    'vgQuery = vgQuery & "num_poliza = '" & Npolca & "' and "
'                    'vgQuery = vgQuery & "num_endoso = " & Numend & " and "
'                    'vgQuery = vgQuery & "num_orden = " & Numor(j) & ""
'                    'vgConexionBD.Execute (vgQuery)
'                    vlBenRet = vlBenRet + 1
'                End If  'Fin    ncorbe(j) = 99 And j = 1
'            End If  'FIN    If derpen(j) = 10
'        Next j
'        ' RMPOL
'        NumPro = NumPro + 1
'
'        'Ani - Dani
'        ''Grabar los Totales en la Póliza
'        'vgQuery = "UPDATE PR_TMAE_ENDOSO set "
'        'vgQuery = vgQuery & "num_cargas = " & Nben & ", "
'        'vgQuery = vgQuery & "cod_ENDOSO = 'S', "
'        'vgQuery = vgQuery & "NUM_BENPROEND = " & Str(Format(Nubenp, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_POLENDCED = " & Str(Format(vlPolCed, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_POLENDRET = " & Str(Format(vlPolRet, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_BENENDCED = " & Str(Format(vlBenCed, "#0")) & ", "
'        'vgQuery = vgQuery & "NUM_BENENDRET = " & Str(Format(vlBenRet, "#0")) & ", "
'        'vgQuery = vgQuery & "mto_resEND = " & Str(Format(rmpol, "#0.00")) & ", "
'        'vgQuery = vgQuery & "mto_resENDced = " & Str(Format(RmpolC, "#0.00")) & ", "
'        'vgQuery = vgQuery & "mto_resENDret = " & Str(CDbl(Format(rmpol, "#0.00")) - CDbl(Format(RmpolC, "#0.00"))) & " "
'        'vgQuery = vgQuery & "where num_poliza = '" & Npolca & "' and "
'        'vgQuery = vgQuery & "cod_cliente = " & vgCliente & " and "
'        'vgQuery = vgQuery & "num_endoso = " & Numend & " "
'        'vgConexionBD.Execute (vgQuery)
'
'        If (Vuelta = 1) Then
'            vlReservaOriginal = Format(rmpol, "#0.00")
'        Else
'            vlReservaCalculada = Format(rmpol, "#0.00")
'        End If
'
'    End If  'Fin Sob/Vejez/inval
'
'Exit Function
'Err_Base:
'    'Screen.MousePointer = 0
'    Select Case Err
'        Case Else
'        'ProgressBar.Value = 0
'        MsgBox "Error Grave en la Póliza '" & Npolca & "' : [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
'        vgError = 5000
'    End Select
End Function

Function fgBasDosSinDif(iCartera, Npolca, Numend, Nap, Nmp, Ndp, Nben, Cober, vigpen, _
Navig, Nmvig, Ndvig, SalCta, penbase, Indi, Mesdif, Alt, Mesgar, _
tce, Tvta)

'RESERVA TECNICA BASE DE RENTAS VITALICIAS
'TASA BASE PARA CADA UNA DE LAS POLIZAS

Dim Numor(1 To 20)  As Integer, Ncorbe(1 To 20) As Integer
Dim Nanbe(1 To 20) As Integer, Nmnbe(1 To 20) As Integer, Ndnbe(1 To 20) As Integer
Dim Sexobe(1 To 20) As String
Dim Coinbe(1 To 20) As String, Codcbe(1 To 20) As String
Dim Ijam(1 To 20) As Integer, Ijmn(1 To 20) As Integer, ijdn(1 To 20) As Integer
Dim igfh(1 To 20) As Integer
Dim derpen(1 To 20) As Integer
Dim porceb(1 To 20) As Double, Porcbe(1 To 20) As Double, Penben(1 To 20) As Double
Dim Npolbe(1 To 20) As String

Dim edabe As Long
Dim Fechan As Long, Fechap As Long
Dim difdia As Long
Dim iagno As Integer, idbis As Integer, idp As Integer
Dim NuBenL As Long
Dim Npnv As Long

Dim nrel As Integer, nibe As Integer, nsbe As Integer
Dim i As Long

Dim topobe As Double

'I---- ABV 15-03-2005 ----
Dim vlFechaNacCausante As String
Dim vlSexoCausante     As String

Dim vlFechaFallecimiento As String
Dim vlFechaMatrimonio    As String
Dim vlFechaAux           As String
'I---- ABV 15-03-2005 ----
        
On Error GoTo Err_Base
    
ReDim flumax(1 To Fintab) As Double

    Fechap = Nap * 12 + Nmp
    'Año bisietro - modulo 4
    iagno = Nap Mod 4
    If iagno > 0 Then
        idbis = 365
    Else
        idbis = 366
    End If
    Select Case (Nmp)
        Case (2)
          If (idbis = 365) Then
            idp = 28
          Else
            idp = 29
          End If
        Case 1, 3, 5, 7, 8, 10, 12
            idp = 31
        Case Else
            idp = 30
    End Select

    topobe = 0
    If (Cober <= 3) Or (Cober >= 13 And Cober <= 15) Then
        If (Navig = 0 Or Nmvig = 0 Or Ndvig = 0) Then
            Navig = 1985
            Nmvig = 12
            Ndvig = 28
            Indi = 1
            Mesdif = 0
            Alt = 1
            Mesgar = 0
        End If
    End If
    'ISTA = 1 'NUPEN0
    'Vigencia de la poliza
    '6 -> Vigente          7 -> Vigente con Benef. designados
    '8 -> Vigente Difer.   9 -> no vigente
    If vigpen = 9 Then
        Npnv = Npnv + 1
        Exit Function
    End If
    vlFechaNacCausante = ""
    
    i = 1
    
    'Datos de los Beneficiarios
    If (Msf_BMGrilla.rows > 1) Then
        i = 1
        While i <= (Msf_BMGrilla.rows - 1)
            Numor(i) = Trim(Msf_BMGrilla.TextMatrix(i, 0))
            Sexobe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 9))
            Ncorbe(i) = Trim(Msf_BMGrilla.TextMatrix(i, 7))
            
            'I--- ABV 15/03/2005 ---
            If (Ncorbe(i) = 99) Or (Ncorbe(i) = 0) Then
                'vlFechaNacCausante = Trim(Msf_BMGrilla.TextMatrix(i, 14))
                vlFechaNacCausante = Format(Trim(Msf_BMGrilla.TextMatrix(i, 16)), "yyyymmdd")
                vlSexoCausante = Trim(Msf_BMGrilla.TextMatrix(i, 9))
            End If
            'F--- ABV 15/03/2005 ---
                    
            Coinbe(i) = Msf_BMGrilla.TextMatrix(i, 10)
            'fecha1 = DateSerial(Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4), Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2), Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2))
            vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 16)), "yyyymmdd")
            'If Trim(Msf_BMGrilla.TextMatrix(i, 14)) <> "" Then
            If Trim(vlFechaAux) <> "" Then
                'Nanbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 1, 4)
                'Nmnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 5, 2)
                'Ndnbe(i) = Mid(Msf_BMGrilla.TextMatrix(i, 14), 7, 2)
                Nanbe(i) = Mid(vlFechaAux, 1, 4)
                Nmnbe(i) = Mid(vlFechaAux, 5, 2)
                Ndnbe(i) = Mid(vlFechaAux, 7, 2)
            End If
            
            
            'If Not IsNull(Msf_BMGrilla.TextMatrix(i, 15)) And ((Msf_BMGrilla.TextMatrix(i, 15)) <> "") Then
            If (Trim(Msf_BMGrilla.TextMatrix(i, 17)) <> "") Then
                'Ijam(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 1, 4)
                'Ijmn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 5, 2)
                'ijdn(i) = Mid(Format(Msf_BMGrilla.TextMatrix(i, 15), "yyyymmdd"), 7, 2)
                vlFechaAux = Format(Trim(Msf_BMGrilla.TextMatrix(i, 15)), "yyyymmdd")
                
                Ijam(i) = Mid(vlFechaAux, 1, 4)
                Ijmn(i) = Mid(vlFechaAux, 5, 2)
                ijdn(i) = Mid(vlFechaAux, 7, 2)
            End If
            Porcbe(i) = IIf(Msf_BMGrilla.TextMatrix(i, 20) = "", 0, Msf_BMGrilla.TextMatrix(i, 20))
            'Determinar el monto de la Pensión del Beneficiario
            'Penben(i) = IIf(Msf_BMGrilla.TextMatrix(vlI, 17) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 17))
            Penben(i) = CDbl(Format(penbase * (Porcbe(i) / 100), "#0.00"))
            
            Codcbe(i) = Msf_BMGrilla.TextMatrix(i, 12)
            igfh(i) = Msf_BMGrilla.TextMatrix(i, 8)
            
            NuBenL = NuBenL + 1
            
            
            'I--- ABV 14/04/2005 ---
            'Dº Potencial a Pensión de Sobrevivencia
            'Se debería considerar el campo de Estado Pensión, sin embargo, se debe
            'considerar el potencial Dº a recibir, por ende sería correcto determinar
            'dicho Derecho desde el cálculo
            ''Derpen(i) = Msf_BMGrilla.TextMatrix(i, 9)
            'Derpen(i) = Msf_BMGrilla.TextMatrix(i, 20)
            
            'vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 19) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 19)))
            'vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 27) = "", "", Trim(Msf_BMGrilla.TextMatrix(i, 27)))
            vlFechaFallecimiento = IIf(Msf_BMGrilla.TextMatrix(i, 21) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 21)), "yyyymmdd"))
            vlFechaMatrimonio = IIf(Msf_BMGrilla.TextMatrix(i, 29) = "", "", Format(Trim(Msf_BMGrilla.TextMatrix(i, 29)), "yyyymmdd"))
            
            If (Ncorbe(i) >= 30 And Ncorbe(i) <= 39) Then
                'Si se trata de Hijos, se debe validar la fecha de Nacimiento
                'por si son mayores de 24 años
                
                If (vlFechaFallecimiento <> "") Or (vlFechaMatrimonio <> "") Then
                    derpen(i) = clCodSinDerPen
                Else
                    nrel = 0
                    nibe = 0
                    Select Case (Coinbe(i))
                        Case "S", "T": nibe = 1
                        Case "N": nibe = 2
                        Case "P": nibe = 3
                        Case Else
                            vgError = 1017
                            Exit Function
                    End Select
                    nsbe = 0
                    Select Case (Sexobe(i))
                        Case "M", "T": nsbe = 1
                        Case "F": nsbe = 2
                        Case Else
                            vgError = 1018
                            Exit Function
                    End Select
                    Fechan = Nanbe(i) * 12 + Nmnbe(i)
                    edabe = Fechap - Fechan
                    difdia = idp - Ndnbe(i)
                    If difdia > 15 Then edabe = edabe + 1
                    If edabe > Fintab Then
                        vgError = 1023
                        Exit Function
                    End If
                    If edabe < 1 Then edabe = 1
                    If (edabe > L24) Then
                        If (nibe = 2) Then
                            derpen(i) = clCodSinDerPen
                        Else
                            derpen(i) = clCodConDerPen
                        End If
                    Else
                        derpen(i) = clCodConDerPen
                    End If
                End If
                
            Else
                'El resto de los Beneficiarios que no sean Hijos, solo se dejan como
                'Sin Derecho a Pensión cuando están fallecidos
                'If (vlFechaFallecimiento <> "" Or vlFechaMatrimonio <> "") Then
                If (vlFechaFallecimiento <> "") Then
                    derpen(i) = clCodSinDerPen
                Else
                    derpen(i) = clCodConDerPen
                End If
            End If
            
            'Modificar el estado de Derecho a Pensión en la Grilla
            'De acuerdo a lo calculado
            'Msf_BMGrilla.TextMatrix(i, 22) = 100 'derpen(i)
            
            'F--- ABV 14/04/2005 ---
            
            If derpen(i) <> 10 Then topobe = topobe + Porcbe(i)
            If Ncorbe(i) = 77 Then
                If vigpen <> 7 Then vigpen = 7
            End If
            Porcbe(i) = Porcbe(i) / 100
            i = i + 1
        Wend
    End If
    
    'Validar el Número de Beneficiarios
    If NuBenL = 0 Then
        vgError = 1003
        Exit Function         'Registrarlo como un Error de la Póliza
    End If
    Nben = i - 1
        
    ''Validacion de pension de referencia y de pension de beneficiarios
    ''de sobrevivencia
    'If penbase = 0 Then
    '    vgError = 1033
    '    Exit Function
    'End If
    
    vlReservaOriginal = Format(1, "#0.00")
    vlReservaCalculada = Format(1, "#0.00")

Exit Function
Err_Base:
    'Screen.MousePointer = 0
    Select Case Err
        Case Else
        'ProgressBar.Value = 0
        MsgBox "Error Grave en la Póliza '" & Npolca & "' : [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
        vgError = 5000
    End Select
End Function

'Función que permite realizar el cálculo de la Pensión
Function flCalcularPension(iFechaProceso As String, iCodCausalEndoso As String) As Boolean
Dim vlDiaPro        As Integer, vlMesPro        As Integer, vlAñoPro        As Integer
Dim vlNumPol        As String, vlNumEndoso     As Long
Dim vlNumBen        As Long
Dim vlcobertura     As String, vlPlan          As String
Dim vlCodEstado     As String
Dim vlIDVigencia    As Integer, vlIMVigencia    As Integer, vlIAVigencia    As Integer
Dim vlPrima         As Double, vlPension       As Double
Dim vlTipoRenta     As String, vlMesesDif      As Long
Dim vlModalidad     As String, vlMesesGar      As Long
Dim vlCiareaseguro  As String, vlOpeReaseguro  As String, vlModReaseguro  As String
Dim vlIDReaseguro   As Integer, vlIMReaseguro   As Integer, vlIAReaseguro   As Integer
Dim vlIDVigRea      As Integer, vlIMVigRea      As Integer, vlIAVigRea      As Integer
Dim vlPrcRetenido   As Double, vlTasaCE        As Double
Dim vlTasaVta       As Double, vlTasaCret      As Double
Dim vlPolCodDerCre  As String
Dim vlPolCodDerGra  As String
Dim vlPolCodCobercon As String
Dim vlPolMtoFacPenElla As Double
Dim vlPolPrcFacPenElla As Double
Dim vlIDDevengue    As Integer, vlIMDevengue    As Integer, vlIADevengue    As Integer
Dim vlIDCotizacion  As Integer, vlIMCotizacion  As Integer, vlIACotizacion  As Integer

Dim vlVuelta     As Integer
Dim vlI          As Integer

'I--- ABV 15/11/2005 ---
Dim vlFDReaseguro   As Integer, vlFMReaseguro   As Integer, vlFAReaseguro   As Integer
'F--- ABV 15/11/2005 ---

Dim vlSwDerPerGar As Boolean
Dim vlSumaPension As Double, vlSumaPensionGar As Double, vlDiferencia As Double
Dim vlPorcBenefSuma As Integer

Dim vlPensionGar As Double
Dim vlPensionAct As Double
Dim vlPensionGarAct As Double

'On Error GoTo Err_Calcular

    flCalcularPension = False
    vgFechaTexto = Format(iFechaProceso, "yyyymmdd")
    
'**********************************************************************
    'vgCarga = 0
    
'    'Verificar cálculo a realizar
'    vgRes = MsgBox("¿ Está seguro que desea realizar el Proceso de Cálculo ?", 4 + 32 + 256, "Confirmación")
'    If vgRes <> 6 Then
'        Screen.MousePointer = 0
'        Exit Function
'    End If
        
    ''Buscar el Número Correlativo de las Tablas de Mortalidad
    ''Mujeres - RV
    'vgI = Cmb_MortalVit_F.ListIndex
    'vgMortalVit_F = Cmb_MortalVit_F.ItemData(vgI)
    'vgPalabra_MortalVit_F = Cmb_MortalVit_F.List(vgI)
    ''Mujeres - IT
    'vgI = Cmb_MortalTot_F.ListIndex
    'vgMortalTot_F = Cmb_MortalTot_F.ItemData(vgI)
    'vgPalabra_MortalTot_F = Cmb_MortalTot_F.List(vgI)
    ''Mujeres - IP
    'vgI = Cmb_MortalPar_F.ListIndex
    'vgMortalPar_F = Cmb_MortalPar_F.ItemData(vgI)
    'vgPalabra_MortalPar_F = Cmb_MortalPar_F.List(vgI)
    ''Mujeres - BEN
    'vgI = Cmb_MortalBen_F.ListIndex
    'vgMortalBen_F = Cmb_MortalBen_F.ItemData(vgI)
    'vgPalabra_MortalBen_F = Cmb_MortalBen_F.List(vgI)
   
    ''Hombres - RV
    'vgI = Cmb_MortalVit_M.ListIndex
    'vgMortalVit_M = Cmb_MortalVit_M.ItemData(vgI)
    'vgPalabra_MortalVit_M = Cmb_MortalVit_M.List(vgI)
    ''Hombres - IT
    'vgI = Cmb_MortalTot_M.ListIndex
    'vgMortalTot_M = Cmb_MortalTot_M.ItemData(vgI)
    'vgPalabra_MortalTot_M = Cmb_MortalTot_M.List(vgI)
    ''Hombres - IP
    'vgI = Cmb_MortalPar_M.ListIndex
    'vgMortalPar_M = Cmb_MortalPar_M.ItemData(vgI)
    'vgPalabra_MortalPar_M = Cmb_MortalPar_M.List(vgI)
    ''Hombres - BEN
    'vgI = Cmb_MortalBen_M.ListIndex
    'vgMortalBen_M = Cmb_MortalBen_M.ItemData(vgI)
    'vgPalabra_MortalBen_M = Cmb_MortalBen_M.List(vgI)
   
    'Valida la Existencia de Parámetros de Cálculo
    '---------------------------------------------
    'Determinar los valores de Parámetros de Cálculo
    vgGtoFun = fgCarga_CuoMor(vgFechaTexto, vgMonedaCodOfi)
    If (vgGtoFun = (-1000)) Then
        MsgBox "No existe valor de Cuota Mortuoria para la Fecha de Proceso registrada.", vbCritical, "Proceso Cancelado"
        Exit Function
    End If
    
    ''Determinar los Finales de Tablas de Mortalidad para cada Tipo
    ''FinTab = fgCarga_Param("PC", "LIMM")
    ''Validar Tablas de Mujeres
    'vgFinTabVit_F = fgFinTab_Mortal(vgMortalVit_F)
    'If (vgFinTabVit_F = -1) Then
    '    MsgBox "No existe la Edad Final de la Tabla de Mortalidad de Rtas. Vitalicias de Mujeres.", vbCritical, "Proceso Cancelado"
    '    Exit Sub
    'End If
    'vgFinTabTot_F = fgFinTab_Mortal(vgMortalTot_F)
    'If (vgFinTabTot_F = -1) Then
    '    MsgBox "No existe la Edad Final de la Tabla de Mortalidad de Inv. Total de Mujeres.", vbCritical, "Proceso Cancelado"
    '    Exit Sub
    'End If
    'vgFinTabPar_F = fgFinTab_Mortal(vgMortalPar_F)
    'If (vgFinTabPar_F = -1) Then
    '    MsgBox "No existe la Edad Final de la Tabla de Mortalidad de Inv. Parcial de Mujeres.", vbCritical, "Proceso Cancelado"
    '    Exit Sub
    'End If
    'vgFinTabBen_F = fgFinTab_Mortal(vgMortalBen_F)
    'If (vgFinTabBen_F = -1) Then
    '    MsgBox "No existe la Edad Final de la Tabla de Mortalidad de Beneficiarios de Mujeres.", vbCritical, "Proceso Cancelado"
    '    Exit Sub
    'End If
    ''Validar Tablas de Hombres
    'vgFinTabVit_M = fgFinTab_Mortal(vgMortalVit_M)
    'If (vgFinTabVit_M = -1) Then
    '    MsgBox "No existe la Edad Final de la Tabla de Mortalidad de Rtas. Vitalicias de Hombres.", vbCritical, "Proceso Cancelado"
    '    Exit Sub
    'End If
    'vgFinTabTot_M = fgFinTab_Mortal(vgMortalTot_M)
    'If (vgFinTabTot_M = -1) Then
    '    MsgBox "No existe la Edad Final de la Tabla de Mortalidad de Inv. Total de Hombres.", vbCritical, "Proceso Cancelado"
    '    Exit Sub
    'End If
    'vgFinTabPar_M = fgFinTab_Mortal(vgMortalPar_M)
    'If (vgFinTabPar_M = -1) Then
    '    MsgBox "No existe la Edad Final de la Tabla de Mortalidad de Inv. Parcial de Hombres.", vbCritical, "Proceso Cancelado"
    '    Exit Sub
    'End If
    'vgFinTabBen_M = fgFinTab_Mortal(vgMortalBen_M)
    'If (vgFinTabBen_M = -1) Then
    '    MsgBox "No existe la Edad Final de la Tabla de Mortalidad de Beneficiarios de Hombres.", vbCritical, "Proceso Cancelado"
    '    Exit Sub
    'End If
    
    ''Falta validar que el FinTab tome el mayor valor de Tablas de Mortalidad
    ''Tomar el Mayor valor para el Término de la Tabla de Mortalidad
    'vlValor = amax1(vgFinTabVit_F, vgFinTabTot_F)
    'vlValor = amax1(vlValor, vgFinTabPar_F)
    'vlValor = amax1(vlValor, vgFinTabBen_F)
    'vlValor = amax1(vlValor, vgFinTabVit_M)
    'vlValor = amax1(vlValor, vgFinTabTot_M)
    'vlValor = amax1(vlValor, vgFinTabPar_M)
    'vlValor = amax1(vlValor, vgFinTabBen_M)
    vlValor = 1332
    Fintab = vlValor
    
    ReDim Lx(1 To 2, 1 To 3, 1 To Fintab) As Double
    ReDim Ly(1 To 2, 1 To 3, 1 To Fintab) As Double
    
    'Validar los Topes de Edad de Pago de Pensiones
    If (fgCarga_Param("LI", "L24", vgFechaTexto) = False) Then
        MsgBox "No existe Edad de tope para los 24 años.", vbCritical, "Proceso Cancelado"
        Exit Function
    Else
        L24 = vgValorParametro
    End If
    If (fgCarga_Param("LI", "L21", vgFechaTexto) = False) Then
        MsgBox "No existe Edad de tope para los 21 años.", vbCritical, "Proceso Cancelado"
        Exit Function
    Else
        L21 = vgValorParametro
    End If
    If (fgCarga_Param("LI", "L18", vgFechaTexto) = False) Then
        MsgBox "No existe Edad de tope para los 18 años.", vbCritical, "Proceso Cancelado"
        Exit Function
    Else
        L18 = vgValorParametro
    End If
    'Las Edades de Tope se encuentran como Anuales, por lo que hay que Mensualizarlas
    L24 = L24 * 12
    L21 = L21 * 12
    L18 = L18 * 12
    
    'Verificar la Existencia de Pólizas
    'If (flExistenciaPolizas = False) Then
    '    MsgBox "No existen datos de Pólizas para la realización del Proceso de Cálculo.", vbCritical, "Operación Cancelada"
    '    Screen.MousePointer = 0
    '    Exit Sub
    'End If
    
    '--------------------------------------------------
    'Proceso de Cálculos de Reservas seleccionadas
    '--------------------------------------------------
    
    'vgFechaInicioMortal = ""
    'vgFechaFinMortal = ""
    vgFechaIniMortalVit_F = ""
    vgFechaIniMortalTot_F = ""
    vgFechaIniMortalPar_F = ""
    vgFechaIniMortalBen_F = ""
    vgFechaIniMortalVit_M = ""
    vgFechaIniMortalTot_M = ""
    vgFechaIniMortalPar_M = ""
    vgFechaIniMortalBen_M = ""
    
    vgFechaFinMortalVit_F = ""
    vgFechaFinMortalTot_F = ""
    vgFechaFinMortalPar_F = ""
    vgFechaFinMortalBen_F = ""
    vgFechaFinMortalVit_M = ""
    vgFechaFinMortalTot_M = ""
    vgFechaFinMortalPar_M = ""
    vgFechaFinMortalBen_M = ""
    
    'I--- ABV 15/03/2005 ---
    vgIndicadorTipoMovimiento_F = ""
    vgIndicadorTipoMovimiento_M = ""
    'F--- ABV 15/03/2005 ---
    
    vgFechaAnterior = ""
    vlDiaPro = Mid(vgFechaTexto, 7, 2)
    vlMesPro = Mid(vgFechaTexto, 5, 2)
    vlAñoPro = Mid(vgFechaTexto, 1, 4)
    vlReservaOriginal = 0
    vlReservaCalculada = 0
    vlFactor = 0
    
'I--- ABV 01/11/2007 ---
    vlIDCotizacion = Mid(vlFecCotizacion, 7, 2)
    vlIMCotizacion = Mid(vlFecCotizacion, 5, 2)
    vlIACotizacion = Mid(vlFecCotizacion, 1, 4)
    vlIDDevengue = Mid(vlFecDevengue, 7, 2)
    vlIMDevengue = Mid(vlFecDevengue, 5, 2)
    vlIADevengue = Mid(vlFecDevengue, 1, 4)
'F--- ABV 01/11/2007 ---
    
    'Calcular Reserva de Prima Única de Bautizo de Pólizas
    'Call flCalcularEndoso
    vlI = 1
    
    'Determinar las Pólizas a calcular
    'While (vlI <= 2)
                       
        vgError = 0
        
        'Limpiar las variables
        vlNumPol = ""
        vlNumBen = 0
        vlPlan = 0
        'vlCobertura = ""
        vlCodEstado = 0
        vlIDVigencia = 0: vlIMVigencia = 0: vlIAVigencia = 0
        vlPrima = 0
        vlPension = 0
        vlTipoRenta = "": vlMesesDif = 0
        vlModalidad = "": vlMesesGar = 0
        vlCiareaseguro = 0
        vlOpeReaseguro = ""
        vlModReaseguro = ""
        vlIDReaseguro = 0: vlIMReaseguro = 0: vlIAReaseguro = 0
'I--- ABV 15/11/2005 ---
        vlFDReaseguro = 0
        vlFMReaseguro = 0
        vlFAReaseguro = 0

        vlIDVigRea = 0
        vlIMVigRea = 0
        vlIAVigRea = 0
'F--- ABV 15/11/2005 ---
        vlPrcRetenido = 0
        vlTasaCE = 0
        vlTasaVta = 0
        vlTasaCret = 0
        
        vlNumPol = UCase(Trim(Txt_PenPoliza))
        vlNumEndoso = UCase(Trim(Lbl_End))
        
        If (vlI = 1) Then
        
            vlVuelta = vlI
            
            'Determinar las Pólizas a calcular
            vgSql = "SELECT num_poliza,num_endoso,cod_tippension,Num_Cargas, "
            vgSql = vgSql & "Cod_Estado,Fec_Vigencia,Mto_Prima,Mto_Pension,Cod_TipRen,"
            vgSql = vgSql & "Cod_Modalidad,Num_MesDif,Num_MesGar,'0' as COD_CIAREA,"
            vgSql = vgSql & "'' as cod_operea, '' as COD_MODREA, "
            vgSql = vgSql & "'' as FEC_INIREA, "
'I--- ABV 15/11/2005 ---
            vgSql = vgSql & "'' as FEC_FINREA,'' as FEC_REA, "
'F--- ABV 15/11/2005 ---
            vgSql = vgSql & "0 as PRC_TASARET, 0 as prc_tasacre, "
            vgSql = vgSql & "Prc_TasaCe, Prc_TasaVta "
            vgSql = vgSql & ",p.cod_dercre as cod_dercrepol "
            vgSql = vgSql & ",p.cod_dergra as cod_dergrapol,p.cod_cobercon,p.mto_facpenella,prc_facpenella, p.mto_pensiongar "
            vgSql = vgSql & "FROM PP_TMAE_POLIZA p "
            vgSql = vgSql & "WHERE "
            vgSql = vgSql & "num_poliza = '" & vlNumPol & "' "
            vgSql = vgSql & "AND num_endoso = " & vlNumEndoso & " "
            Set vgRs = vgConexionBD.Execute(vgSql)
            If Not vgRs.EOF Then
            
                'vlNumPol = vgRs!Num_Poliza
                'vlNumEndoso = vgRs!num_endoso
                If Not IsNull(vgRs!Cod_TipPension) Then vlPlan = Trim(vgRs!Cod_TipPension)
                If Not IsNull(vgRs!Num_Cargas) Then vlNumBen = vgRs!Num_Cargas
                'If Not IsNull(vgRs!COD_COBERTURA) Then vlCobertura = Trim(vgRs!COD_COBERTURA)
                If Not IsNull(vgRs!Cod_Estado) Then vlCodEstado = (Trim(vgRs!Cod_Estado))
                If Not IsNull(vgRs!Fec_Vigencia) Then
                    vlIDVigencia = Mid(vgRs!Fec_Vigencia, 7, 2)
                    vlIMVigencia = Mid(vgRs!Fec_Vigencia, 5, 2)
                    vlIAVigencia = Mid(vgRs!Fec_Vigencia, 1, 4)
                End If
                If Not IsNull(vgRs!Mto_Prima) Then vlPrima = vgRs!Mto_Prima
'I--- ABV 27/09/2007 ---
''                If Not IsNull(vgRs!Mto_Pension) Then vlPension = vgRs!Mto_Pension
                vlPension = vlMtoPensionActOriginal
                vlPensionGar = vgRs!Mto_PensionGar
'F--- ABV 27/09/2007 ---
                If Not IsNull(vgRs!Cod_TipRen) Then vlTipoRenta = Trim(vgRs!Cod_TipRen)
                If Not IsNull(vgRs!Cod_Modalidad) Then vlModalidad = Trim(vgRs!Cod_Modalidad)
                If Not IsNull(vgRs!Num_MesDif) Then vlMesesDif = vgRs!Num_MesDif
                If Not IsNull(vgRs!Num_MesGar) Then vlMesesGar = vgRs!Num_MesGar
                
                If Not IsNull(vgRs!COD_CIAREA) Then vlCiareaseguro = Trim(vgRs!COD_CIAREA)
                If Not IsNull(vgRs!cod_operea) Then vlOpeReaseguro = Trim(vgRs!cod_operea)
                If Not IsNull(vgRs!COD_MODREA) Then vlModReaseguro = Trim(vgRs!COD_MODREA)
                If Not IsNull(vgRs!FEC_INIREA) Then
                    vlIDReaseguro = Mid(vgRs!FEC_INIREA, 7, 2)
                    vlIMReaseguro = Mid(vgRs!FEC_INIREA, 5, 2)
                    vlIAReaseguro = Mid(vgRs!FEC_INIREA, 1, 4)
                End If

'I--- ABV 15/11/2005 ---
                'DANIELA 07/07/2005
                If Not IsNull(vgRs!FEC_REA) Then
                    vlIDVigRea = Mid(vgRs!FEC_REA, 7, 2)
                    vlIMVigRea = Mid(vgRs!FEC_REA, 5, 2)
                    vlIAVigRea = Mid(vgRs!FEC_REA, 1, 4)
                End If
                'FIN 07/07/2005

                If Not IsNull(vgRs!FEC_FINREA) Then
                    vlFDReaseguro = Mid(vgRs!FEC_FINREA, 7, 2)
                    vlFMReaseguro = Mid(vgRs!FEC_FINREA, 5, 2)
                    vlFAReaseguro = Mid(vgRs!FEC_FINREA, 1, 4)
                End If
'F--- ABV 15/11/2005 ---
                
                If Not IsNull(vgRs!PRC_TASARET) Then vlPrcRetenido = vgRs!PRC_TASARET
                If Not IsNull(vgRs!prc_tasacre) Then vlTasaCret = vgRs!prc_tasacre
                
                If Not IsNull(vgRs!Prc_TasaCe) Then vlTasaCE = vgRs!Prc_TasaCe
                If Not IsNull(vgRs!Prc_TasaVta) Then vlTasaVta = vgRs!Prc_TasaVta
            
                vlPolCodDerCre = Trim(vgRs!cod_dercrepol)
                vlPolCodDerGra = Trim(vgRs!Cod_Dergrapol)
                vlPolCodCobercon = Trim(vgRs!Cod_CoberCon)
                vlPolMtoFacPenElla = (vgRs!Mto_FacPenElla)
                vlPolPrcFacPenElla = (vgRs!Prc_FacPenElla)
            
            End If
            vgRs.Close
        Else

            vlVuelta = vlI
            
            vlNumero = InStr(Cmb_PMTipPen.Text, "-")
            vlPlan = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
            vlNumBen = Lbl_PMNumCar
            vlNumero = InStr(Cmb_PMEstVig.Text, "-")
            vlCodEstado = Trim(Mid(Cmb_PMEstVig.Text, 1, vlNumero - 1))
            vlFecVigencia = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
            vlIDVigencia = Mid(vlFecVigencia, 7, 2)
            vlIMVigencia = Mid(vlFecVigencia, 5, 2)
            vlIAVigencia = Mid(vlFecVigencia, 1, 4)
            
            vlPrima = (Txt_PMMtoPrima)
            
            'I--- ABV 20/04/2005 ---
            'vlPension = Lbl_POMtoPen
            vlPension = vlMontoPensionPrima
            'F--- ABV 20/04/2005 ---
                        
            vlNumero = InStr(Cmb_PMTipRta.Text, "-")
            vlTipoRenta = Trim(Mid(Cmb_PMTipRta.Text, 1, vlNumero - 1))
            
            vlNumero = InStr(Cmb_PMMod.Text, "-")
            vlModalidad = Trim(Mid(Cmb_PMMod.Text, 1, vlNumero - 1))
            
            vlMesesDif = Txt_PMMesDif
            vlMesesGar = Txt_PMMesGar
                        
            vlCiareaseguro = "0"
            vlOpeReaseguro = ""
            vlModReaseguro = ""
            vlIDReaseguro = 0
            vlIMReaseguro = 0
            vlIAReaseguro = 0
            
'I--- ABV 15/11/2005 ---
            vlIDVigRea = 0
            vlIMVigRea = 0
            vlIAVigRea = 0

            vlFDReaseguro = 0
            vlFMReaseguro = 0
            vlFAReaseguro = 0
'F--- ABV 15/11/2005 ---
            
            vlPrcRetenido = 0
            vlTasaCret = 0
                    
            vlTasaCE = CDbl(Txt_PMTasaCto) 'Str(Txt_PMTasaCto)
            vlTasaVta = CDbl(Txt_PMTasaVta) 'Str(Txt_PMTasaVta)
        
            vlPolCodDerCre = Trim(Lbl_PMDerCrecer)
            vlPolCodDerGra = Trim(Lbl_PMDerGratificacion)
            vlPolCodCobercon = Trim(Lbl_PMCoberCon)
            vlPolMtoFacPenElla = (Lbl_PMMtoFacPenElla)
            vlPolPrcFacPenElla = (Lbl_PMPrcFacPenElla)
        
        End If
        
        'Llamar a función de Reserva Fija
        'vgCliente
        'Call fgBasDos(vgCliente, vlNumPol, vlNumEndoso, vlAñoPro, vlMesPro, vlDiaPro, vlNumBen, vlPlan, _
        vlCodEstado, vlIAVigencia, vlIMVigencia, vlIDVigencia, vlPrima, vlPension, _
        vlTipoRenta, vlMesesDif, vlModalidad, vlMesesGar, vlCiareaseguro, _
        vlOpeReaseguro, vlModReaseguro, vlIAReaseguro, vlIMReaseguro, vlIDReaseguro, _
        vlPrcRetenido, vlTasaCE, vlTasaVta, vlTasaCret, vgGtoFun, _
        vlIDReaseguro, vlIMReaseguro, vlIAReaseguro)
'I--- ABV 01/11/2007 ---
'        Call fgBasDos(1, vlNumPol, vlNumEndoso, vlAñoPro, vlMesPro, vlDiaPro, vlNumBen, vlPlan, _
'        vlCodEstado, vlIAVigencia, vlIMVigencia, vlIDVigencia, vlPrima, vlPension, _
'        vlTipoRenta, vlMesesDif, vlModalidad, vlMesesGar, vlCiareaseguro, _
'        vlOpeReaseguro, vlModReaseguro, vlIAReaseguro, vlIMReaseguro, vlIDReaseguro, _
'        vlFAReaseguro, vlFMReaseguro, vlFDReaseguro, _
'        vlPrcRetenido, vlTasaCE, vlTasaVta, vlTasaCret, vgGtoFun, _
'        vlIDVigRea, vlIMVigRea, vlIAVigRea, vlVuelta, iCodCausalEndoso _
'        , vlPolCodDerCre, vlPolCodDerGra, vlPolCodCobercon, vlPolMtoFacPenElla _
'        , vlPolPrcFacPenElla)
'Rutina indefinida comentada por el momento  RRR
        'Call fgBasDos(1, vlNumPol, vlNumEndoso, vlAñoPro, vlMesPro, vlDiaPro, vlNumBen, vlPlan, _
        'vlCodEstado, vlIADevengue, vlIMDevengue, vlIDDevengue, vlPrima, vlPension, _
        'vlTipoRenta, vlMesesDif, vlModalidad, vlMesesGar, vlCiareaseguro, _
        'vlOpeReaseguro, vlModReaseguro, vlIAReaseguro, vlIMReaseguro, vlIDReaseguro, _
        'vlFAReaseguro, vlFMReaseguro, vlFDReaseguro, _
        'vlPrcRetenido, vlTasaCE, vlTasaVta, vlTasaCret, vgGtoFun, _
        'vlIDVigRea, vlIMVigRea, vlIAVigRea, vlVuelta, iCodCausalEndoso _
        ', vlPolCodDerCre, vlPolCodDerGra, vlPolCodCobercon, vlPolMtoFacPenElla _
        ', vlPolPrcFacPenElla _
        ', vlIACotizacion, vlIMCotizacion, vlIDCotizacion)
'F--- ABV 01/11/2007 ---
        
        'If (vgError <> 0) Then
        '    'Definir termino del Cálculo de Endoso
        '    MsgBox "Error producido durante el proceso de cálculo de la Pensión.", vbCritical, "Proceso abortado"
        '    Exit Function
        'End If

        'vlI = vlI + 1
    'Wend

   

    'Determinar el nuevo valor de la Pensión
    'I--- ABV 20/04/2005 ---
    'vlPension = Lbl_POMtoPen
    'vlPension = vlMontoPensionPrima
    'F--- ABV 20/04/2005 ---
    
     'If CDbl(txt_EndMtoPensionCalc) <> CDbl(txt_EndMtoPensionCalcGar) Then
    vlPension = CDbl(Lbl_EndMtoPensionOrig)
    vlPensionGar = CDbl(lbl_EndMtoPensionOrigGar)
        
'        vlPensionAct = CDbl(Lbl_EndMtoPensionCalc)
'        vlPensionGarAct = CDbl(lbl_EndMtoPensionCalcGar)
        
    If Mid(Cmb_EndTipoEnd, 1, 1) = "A" Then
        Lbl_EndMtoPensionCalc = txt_EndMtoPensionCalc
        lbl_EndMtoPensionCalcGar = txt_EndMtoPensionCalcGar
    End If
    
    vlPensionAct = Lbl_EndMtoPensionCalc
    vlPensionGarAct = lbl_EndMtoPensionCalcGar
    'End If
    
    
'    If Mid(Cmb_EndTipoEnd, 1, 1) = "A" Then
'        vlPension = txt_EndMtoPensionCalc
'    End If
    
    
'    If (vlReservaCalculada <> 0) Then
'        vlFactor = vlReservaOriginal / vlReservaCalculada
'    End If
    ''--RRR
    'vlMontoPensionFinal = Format(vlPension * vlFactor, "#0.00")
    vlMontoPensionFinal = Format(vlPensionAct, "#,#0.00")
    '--RRR
    'Lbl_EndMtoPensionCalc = Format(vlMontoPensionFinal, "#,#0.00")
    
     'Determinar el Tipo de Pensión
    vlNumero = InStr(Cmb_PMTipPen.Text, "-")
    vlPlan = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
    

'I--- ABV 19/10/2007 ---
    'Determinar el Tipo de Pensión
    vlNumero = InStr(Cmb_PMTipPen.Text, "-")
    vlPlan = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
'F--- ABV 19/10/2007 ---
    vlSumaPension = 0
    vlSumaPensionGar = 0
                
    'suma porcentajes 'mvg 20170706
    vlPorcBenefSuma = 100
    If vlPlan = "08" Or vlPlan = "09" Or vlPlan = "10" Or vlPlan = "11" Or vlPlan = "12" Then
        vlPorcBenefSuma = 0
        vlI = 1
        If (Msf_BMGrilla.rows > 1) Then
            While vlI <= (Msf_BMGrilla.rows - 1)
                If (Msf_BMGrilla.TextMatrix(vlI, 11) <> "10") Then
                    vlPorcBenefSuma = vlPorcBenefSuma + Format(IIf(Msf_BMGrilla.TextMatrix(vlI, 20) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 20)), "#,#0.00")
                End If
                vlI = vlI + 1
            Wend
        End If
    End If
    
'    'Saca la sumatoria de % de pensiones
'    vlI = 1
'    If (Msf_BMGrilla.rows > 1) Then
'        While vlI <= (Msf_BMGrilla.rows - 1)
'            If (Msf_BMGrilla.TextMatrix(vlI, 11) <> "10") Then
'                vlPorcBenefSuma = vlPorcBenefSuma + Format(IIf(Msf_BMGrilla.TextMatrix(vlI, 20) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 20)), "#,#0.00")
'            End If
'            vlI = vlI + 1
'        Wend
'    End If
    
    'vlPorcBenefSuma = 100
    'Actualizar los montos de las Pensiones
    vlI = 1
    If (Msf_BMGrilla.rows > 1) Then
        While vlI <= (Msf_BMGrilla.rows - 1)
            
            vlPorcBenef = 0
            vlPorcGarBenef = 0
            vlPenBenef = 0
            vlPenGarBenef = 0
            vlSwDerPerGar = False
                    
            If (vlMesesGar > 0) Then
                If (flObtenerDerechoPeriodoGarantizado(vlPlan, Msf_BMGrilla.TextMatrix(vlI, 7)) = True) Then
                    vlSwDerPerGar = True
                End If
            End If
    
'I--- ABV 16/10/2007 ---
'            'Verificar el Estado de Derecho a Pensión (Cod_EstPension)
'            If (Msf_BMGrilla.TextMatrix(vlI, 11) <> "10") Then
            'Verificar el Estado de Derecho a Pensión (Cod_EstPension)
            If (Msf_BMGrilla.TextMatrix(vlI, 11) <> "10") Then
'F--- ABV 16/10/2007 ---
                vlPorcBenef = Format(IIf(Msf_BMGrilla.TextMatrix(vlI, 20) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 20)), "#,#0.00")
                If vlPorcBenef <> 100 Then
                    If vlPlan = "08" Or vlPlan = "09" Or vlPlan = "10" Or vlPlan = "11" Or vlPlan = "12" Then
                        vlPorcGarBenef = Round((vlPorcBenef / vlPorcBenefSuma) * 100, 6)  'Format(IIf(Msf_BMGrilla.TextMatrix(vlI, 30) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 30)), "#,#0.00")
                    End If
                Else
                    vlPorcGarBenef = 100
                End If
                'Determinar el monto de la Pensión del Beneficiario
                'Penben(i) = IIf(Msf_BMGrilla.TextMatrix(vlI, 17) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 17))
                vlPenBenef = Format(vlPensionAct * (vlPorcBenef / 100), "#0.00")
            
                'Definir la Pensión del Garantizado
            '*************************************
                'vlPenGarBenef = CDbl(Msf_BMGrilla.TextMatrix(vlI, 24))
'                'I--- ABV 20/04/2005 ---
'                vlNumero = InStr(Cmb_PMTipPen.Text, "-")
'                vgPalabra = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
'
'                vgI = InStr(1, clPensionInvVejez, vgPalabra)
'                If (vgI <> 0) Then
'                    'Valida que sea un caso de Invalidez o Vejez
'                    vlPenGarBenef = vlPenBenef
'                End If
'                vgI = InStr(1, clPensionSobOrigen, vgPalabra)
'                If (vgI <> 0) Then
'                    'Valida que sea un caso de Sobrevivencia por Origen
'                    'Se supone que la Cónyuge o Madre es la única que Garantiza su pensión
'                    'vlNumero = InStr(Cmb_BMPar.Text, "-")
'                    vgPalabraAux = Trim(Msf_BMGrilla.TextMatrix(vlI, 7))
'
'                    vgX = InStr(1, clParConyugeMadre, vgPalabraAux)
'                    If (vgX <> 0) Then
'                        vlPenGarBenef = vlPenBenef
'                    'Else
'                    '    Txt_BMMtoPensionGar.Enabled = True
'                    End If
'                End If
'
'                vgI = InStr(1, clPensionSobTransf, vgPalabra)
'                If (vgI <> 0) Then
'                    ''Valida que sea un caso de Invalidez o Vejez
'                    'Txt_BMMtoPensionGar.Enabled = True
'                End If
'
'                'F--- ABV 19/04/2005 ---
            '*************************************
                  'Actualizar el Monto de la Pensión
                Msf_BMGrilla.TextMatrix(vlI, 19) = Format(vlPenBenef, "#,#0.00")
            
            
            'Actualizar el Monto de la Pensión Garantizada
            'Calcular el Porcentaje del Periodo Garantizado
            '############ mvg 20170706 aqui va posible cambio para garantizado solo para sobrevivencia pura
                If vlPlan = "08" Or vlPlan = "09" Or vlPlan = "10" Or vlPlan = "11" Or vlPlan = "12" Then
                    If (vlMesesGar > 0) And Msf_BMGrilla.TextMatrix(vlI, 22) <> "10" Then
                        'If (vlSwDerPerGar = True) Then
                            vlPenGarBenef = vlPensionGarAct * (vlPorcGarBenef / 100) ' (vlPensionGar * (vlPorcBenefSuma / 100)) * (vlPorcGarBenef / 100)
                            Msf_BMGrilla.TextMatrix(vlI, 24) = Format(vlPenGarBenef, "#,#0.00")
                            Txt_BMMtoPensionGar = Format(vlPenGarBenef, "#,#0.00")
                            Msf_BMGrilla.TextMatrix(vlI, 30) = Format(vlPorcGarBenef, "#,#0.00")
                    Else
                        If vlMesesGar > 0 Then
                             If lblFecTerPerGar.Caption > vgFechaTexto Then
                                vlPenGarBenef = vlPensionGarAct * (vlPorcGarBenef / 100)
                                Msf_BMGrilla.TextMatrix(vlI, 24) = Format(vlPenGarBenef, "#,#0.00")
                                Txt_BMMtoPensionGar = Format(vlPenGarBenef, "#,#0.00")
                                Msf_BMGrilla.TextMatrix(vlI, 30) = Format(vlPorcGarBenef, "#,#0.00")
                            Else
                                Msf_BMGrilla.TextMatrix(vlI, 24) = Format(0, "#,#0.00")
                                Msf_BMGrilla.TextMatrix(vlI, 30) = Format(0, "#,#0.00")
                            End If
                        Else
                            Msf_BMGrilla.TextMatrix(vlI, 24) = Format(0, "#,#0.00")
                            Msf_BMGrilla.TextMatrix(vlI, 30) = Format(0, "#,#0.00")
                        End If
                       
                    End If

                Else
                If (vlMesesGar > 0) And Msf_BMGrilla.TextMatrix(vlI, 22) <> "10" Then
                    'If (vlSwDerPerGar = True) Then
                        vlPenGarBenef = vlPensionGarAct * (vlPorcGarBenef / 100)
                        Msf_BMGrilla.TextMatrix(vlI, 24) = Format(vlPenGarBenef, "#,#0.00")
                        Txt_BMMtoPensionGar = Format(vlPenGarBenef, "#,#0.00")
                        Msf_BMGrilla.TextMatrix(vlI, 30) = Format(vlPorcGarBenef, "#,#0.00")
                Else
                    If vlMesesGar > 0 Then
                         If lblFecTerPerGar.Caption > vgFechaTexto Then
                            vlPenGarBenef = vlPensionGarAct * (vlPorcGarBenef / 100)
                            Msf_BMGrilla.TextMatrix(vlI, 24) = Format(vlPenGarBenef, "#,#0.00")
                            Txt_BMMtoPensionGar = Format(vlPenGarBenef, "#,#0.00")
                            Msf_BMGrilla.TextMatrix(vlI, 30) = Format(vlPorcGarBenef, "#,#0.00")
                        Else
                            Msf_BMGrilla.TextMatrix(vlI, 24) = Format(0, "#,#0.00")
                            Msf_BMGrilla.TextMatrix(vlI, 30) = Format(0, "#,#0.00")
                        End If
                    Else
                        Msf_BMGrilla.TextMatrix(vlI, 24) = Format(0, "#,#0.00")
                        Msf_BMGrilla.TextMatrix(vlI, 30) = Format(0, "#,#0.00")
                    End If
                   
                End If
                End If
            Else
                Msf_BMGrilla.TextMatrix(vlI, 19) = Format(0, "#,#0.00")
                Msf_BMGrilla.TextMatrix(vlI, 20) = Format(0, "#,#0.00")
                Msf_BMGrilla.TextMatrix(vlI, 24) = Format(0, "#,#0.00")
                Msf_BMGrilla.TextMatrix(vlI, 30) = Format(0, "#,#0.00")
            End If
            
      
            
            If (Msf_BMGrilla.TextMatrix(vlI, 7) <> "99") And (Msf_BMGrilla.TextMatrix(vlI, 22) <> "10") Then
                vlSumaPension = vlSumaPension + vlPenBenef
                vlSumaPensionGar = vlSumaPensionGar + vlPenGarBenef
            End If
            
            vlI = vlI + 1
        Wend
    Else
        'Error ya que deben existir beneficiarios en la Grilla de Modificación
        
    End If
    
    vlDiferencia = vlSumaPension - vlMontoPensionFinal
    If (vlDiferencia > 0) Then
        For vlI = 1 To Msf_BMGrilla.rows - 1
            If (Msf_BMGrilla.TextMatrix(vlI, 7) <> "99") And (Msf_BMGrilla.TextMatrix(vlI, 22) <> "10") Then
                'Arregla la información en la Grilla
                Msf_BMGrilla.TextMatrix(vlI, 19) = CDbl(Msf_BMGrilla.TextMatrix(vlI, 19)) - vlDiferencia
                'Arregla la información en la Estructura
                'stBeneficiariosOri(vgI).Mto_Pension = vlMtoPensionActBenef
                Exit For
            End If
        Next vlI
    End If
        
    'if a <> b then vlMontoPensionFinal=vlMontoPension
        
    If (vlMesesGar > 0) Then
        vlDiferencia = vlSumaPensionGar - vlMontoPensionFinal
        If (vlDiferencia > 0) Then 'Or (vlDiferencia < 0) Then
            For vlI = 1 To Msf_BMGrilla.rows - 1
                If (Msf_BMGrilla.TextMatrix(vlI, 7) <> "99") And (Msf_BMGrilla.TextMatrix(vlI, 22) <> "10") Then
                    
'                        vlDerechoPerGar = False
'                        If (stPolizaOri.Num_MesGar > 0) Then
'                            If (flObtenerDerechoPeriodoGarantizado(vlTipoPension, Msf_BMGrilla.TextMatrix(vgI, 7)) = True) Then
'                                vlDerechoPerGar = True
'                            End If
'                        End If
'
'                        If (vlDerechoPerGar = True) Then
                    If (CDbl(Msf_BMGrilla.TextMatrix(vlI, 24)) <> 0) Then
                        'Arregla la información en la Grilla
                        Msf_BMGrilla.TextMatrix(vlI, 24) = CDbl(Msf_BMGrilla.TextMatrix(vlI, 24)) - vlDiferencia
                        'Arregla la información en la Estructura
                        'stBeneficiariosOri(vgI).Mto_PensionGar = CDbl(Msf_BMGrilla.TextMatrix(vgI, 24)) - vlDiferencia 'vlMtoPensionActGarBenef
                        
        '                vlPorcGarBenef = Format((vlPenGarBenef * 100) / vlPension, "#0.000000000")
                        vlPorcGarBenef = Format(CDbl((Msf_BMGrilla.TextMatrix(vlI, 24) * 100) / vlMontoPensionFinal), "#0.00")
                        Msf_BMGrilla.TextMatrix(vlI, 30) = Format(vlPorcGarBenef, "#0.000000000")
                        
                        Exit For
                    End If
                End If
            Next vlI
        End If
    End If

'**********************************************************************
    Txt_BMMtoPensionGar = Format(0, "#,#0.00")
    flCalcularPension = True

'Exit Function
'Err_Calcular:
'    Screen.MousePointer = 0
'    Select Case Err
'        Case Else
'        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
'    End Select
End Function

'Función que permite realizar el cálculo de la Pensión
Function flCalcularPensionGarantizada(iFechaProceso) As Boolean
Dim vlI As Long
On Error GoTo Err_Calcular

    flCalcularPensionGarantizada = False

    'Actualizar los montos de las Pensiones
    vlI = 1
    If (Msf_BMGrilla.rows > 1) Then
        While vlI <= (Msf_BMGrilla.rows - 1)
            
            vlPorcBenef = 0
            vlPenBenef = 0
            
            If (Msf_BMGrilla.TextMatrix(vlI, 9) <> "10") Then
                vlPorcBenef = IIf(Msf_BMGrilla.TextMatrix(vlI, 18) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 18))
                'Determinar el monto de la Pensión del Beneficiario
                'Penben(i) = IIf(Msf_BMGrilla.TextMatrix(vlI, 17) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 17))
                vlPenBenef = vlMontoPensionFinal * (vlPorcBenef / 100)
            End If
            Msf_BMGrilla.TextMatrix(vlI, 22) = Format(vlPenBenef, "#,#0.00")
            
            vlI = vlI + 1
        Wend
    Else
        'Error ya que deben existir beneficiarios en la Grilla de Modificación
        
    End If
    
    flCalcularPensionGarantizada = True
    
Exit Function
Err_Calcular:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flCalculaFechaEfecto(iFechaEfectoIngresada As String) As String
Dim iFecha As String
Dim iFechaCierre As String
Dim iFechaEfecto As String

On Error GoTo Err_ValidaFechaEfecto
    
    flCalculaFechaEfecto = ""
    If (Trim(iFechaEfectoIngresada) <> "") Then
        If Not IsDate(iFechaEfectoIngresada) Then
            Exit Function
        End If
        
        iFechaCierre = Format(fgValidaFechaEfecto(Trim(iFechaEfectoIngresada), vlNumPoliza, vlNumOrden), "yyyymmdd")
        iFechaEfecto = Format(CDate(iFechaEfectoIngresada), "yyyymmdd")
        If (iFechaCierre > iFechaEfecto) Then
            'MsgBox "La Fecha de Efecto es anterior a la Fecha del último cierre, el cual corresponde a :" & _
            DateSerial(CInt(Mid(iFechaCierre, 1, 4)), CInt(Mid(iFechaCierre, 5, 2)), CInt(Mid(iFechaCierre, 7, 2))), vbInformation, "Fecha Errónea"
            Exit Function
        Else
            flCalculaFechaEfecto = DateSerial(CInt(Mid(iFechaEfecto, 1, 4)), CInt(Mid(iFechaEfecto, 5, 2)), CInt(Mid(iFechaEfecto, 7, 2)))
        End If
    Else
        
        'Determinar el menor periodo de Proceso que se encuentre Abierto
        
        'Determinar si el periodo a registrar es posterior al que se desea ingresar
        vgSql = "SELECT NUM_PERPAGO,COD_ESTADOREG " ',COD_ESTADOPRI
        vgSql = vgSql & "FROM PP_TMAE_PROPAGOPEN "
        vgSql = vgSql & "WHERE "
        'vgSql = vgSql & "num_perpago >= '" & iFecha & "' AND "
        vgSql = vgSql & "cod_estadoreg <> 'C' "
        'vgSql = vgSql & "or cod_estadopri <> 'C' "
        vgSql = vgSql & "ORDER BY num_perpago ASC"
        Set vgRs2 = vgConexionBD.Execute(vgSql)
        If Not vgRs2.EOF Then
            iFecha = DateSerial(CInt(Mid(vgRs2!Num_PerPago, 1, 4)), CInt(Mid(vgRs2!Num_PerPago, 5, 2)), 1)
        Else
            iFecha = fgBuscaFecServ
        End If
        vgRs2.Close
        
        flCalculaFechaEfecto = fgValidaFechaEfecto(Trim(iFecha), vlNumPoliza, vlNumOrden)
    End If

Exit Function
Err_ValidaFechaEfecto:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flBenefConFecFall()
On Error GoTo Err_flBenefConFecFall
'Función que permite validar el ingreso de fecha de fallecimiento al
'beneficiario causante de la póliza. Además se realiza el cambio de
'tipo de pensión a el tipo de sobrevivencia que corresponda.
Dim vlIsGar As String
    
    'I--- ABV 20/04/2005 ---
    'Validar que la Póliza no sea por Origen una Sobrevivencia
    vlNumero = InStr(Cmb_PMTipPen.Text, "-")
    vgPalabra = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
    
    vgI = InStr(1, clPensionSobOrigen, vgPalabra)
    If (vgI <> 0) Then
        'Verificar el Parentesco
        vlNumero = InStr(Cmb_BMPar.Text, "-")
        vlOpcion = Trim(Mid(Cmb_BMPar.Text, 1, vlNumero - 1))
        
        If vlOpcion = clCodParCau Then
        
            If (Trim(Txt_BMFecFall) = "") Then
                MsgBox "Fecha de Fallecimiento asignada al Causante no es una Fecha Válida," & Chr(13) & "de acuerdo al Tipo de Pensión.", vbCritical, "Error de Datos"
                Txt_BMFecFall.SetFocus
                vlSwCalIntOK = False
                Exit Function
            End If
                
            'Verificar el Estado a Pensión
            'Cambiar el Estado de Pensión a Sin Derecho
            vlNumero = InStr(Cmb_BMDerPen.Text, "-")
            vlOpcion = Trim(Mid(Cmb_BMDerPen.Text, 1, vlNumero - 1))
            
            If vlOpcion = clCodConDerPen Then
                MsgBox "El código de Derecho a Pensión no es válido, ya que el Causante se encuentra fallecido.", vbCritical, "Error de Datos"
                Cmb_BMDerPen.SetFocus
                vlSwCalIntOK = False
                Exit Function
            End If
        Else
            
            If (Trim(Txt_BMFecFall) <> "") Then
                'Verificar el Estado a Pensión
                'Cambiar el Estado de Pensión a Sin Derecho
                vlNumero = InStr(Cmb_BMDerPen.Text, "-")
                vlOpcion = Trim(Mid(Cmb_BMDerPen.Text, 1, vlNumero - 1))
                
                If vlOpcion = clCodConDerPen Then
                    MsgBox "El código de Derecho a Pensión no es válido, ya que el " & Chr(13) & "Beneficiario se encuentra fallecido.", vbCritical, "Error de Datos"
                    Cmb_BMDerPen.SetFocus
                    vlSwCalIntOK = False
                    Exit Function
                End If
            End If
        End If
    End If
    'F--- ABV 20/04/2005 ---
    
    
    
    If (Trim(Txt_BMFecFall) <> "") Then
        If Not IsDate(Txt_BMFecFall.Text) Then
           MsgBox "La Fecha Ingresada No es una Fecha Válida.", vbCritical, "Error de Datos"
           Txt_BMFecFall.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        If (CDate(Txt_BMFecFall) > CDate(Date)) Then
           MsgBox "La Fecha Ingresada es Mayor a la Fecha Actual", vbCritical, "Error de Datos"
           Txt_BMFecFall.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        If (Year(Txt_BMFecFall) < 1900) Then
           MsgBox "La Fecha Ingresada es Inferior a la Fecha Mínima de Ingreso (1900).", vbCritical, "Error de Datos"
           Txt_BMFecFall.SetFocus
           vlSwCalIntOK = False
           Exit Function
        End If
        Txt_BMFecFall.Text = Format(CDate(Trim(Txt_BMFecFall)), "yyyymmdd")
        Txt_BMFecFall.Text = DateSerial(Mid((Txt_BMFecFall.Text), 1, 4), Mid((Txt_BMFecFall.Text), 5, 2), Mid((Txt_BMFecFall.Text), 7, 2))
        
        'Validar que la Fecha de Fallecimiento no sea anterior a la Fecha de Vigencia Póliza
        
        'Validar que la Fe
        
        
'Confirmar si parentesco del beneficiario modificado es Causante
        vlNumero = InStr(Cmb_BMPar.Text, "-")
        vlOpcion = Trim(Mid(Cmb_BMPar.Text, 1, vlNumero - 1))
        vlIsGar = Trim(InStr(Cmb_PMMod.Text, "-"))
        
        'RRR 20/11/2018
        vlNumero = InStr(Cmb_EndCauEnd.Text, "-")
        vlCodCauEndoso = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))
        
        If vlOpcion = clCodParCau Then
        
            If (vlIsGar <> "3" Or (Msf_BMGrilla.rows - 1) > 1) Then
                vlNumero = InStr(Lbl_POTipPen, "-")
                vlOpcion = Trim(Mid(Lbl_POTipPen, 1, vlNumero - 1))
                'Revisar tipo de pension que el beneficiario tiene (en label de ficha de poliza original)
                'Para asignar  el tipo de pension de Sobrevivencia que corresponda
                
                If Trim(vlOpcion) = clTipPension04 Then
                    Cmb_PMTipPen.ListIndex = fgBuscarPosicionCodigoCombo(clTipPension09, Cmb_PMTipPen)
                End If
                If Trim(vlOpcion) = clTipPension05 Then
                    Cmb_PMTipPen.ListIndex = fgBuscarPosicionCodigoCombo(clTipPension10, Cmb_PMTipPen)
                End If
                If Trim(vlOpcion) = clTipPension06 Then
                    Cmb_PMTipPen.ListIndex = fgBuscarPosicionCodigoCombo(clTipPension11, Cmb_PMTipPen)
                End If
                If Trim(vlOpcion) = clTipPension07 Then
                    Cmb_PMTipPen.ListIndex = fgBuscarPosicionCodigoCombo(clTipPension12, Cmb_PMTipPen)
                End If
                
                Cmb_PMTipPen.Enabled = False
                
                'Cambiar el Estado de Pensión a Sin Derecho
                Cmb_BMDerPen.ListIndex = fgBuscarPosicionCodigoCombo(clCodSinDerPen, Cmb_BMDerPen)
            Else
                If (vlIsGar = "3" Or (Msf_BMGrilla.rows - 1) = 1) Then
                    If vlCodCauEndoso = "07" Then
                        Cmb_BMDerPen.ListIndex = 0
                        cmbExcluesion.ListIndex = 1
                    End If
                End If
            End If
          
            
        End If
        
    Else
        
        vlNumero = InStr(Cmb_BMPar.Text, "-")
        vlOpcion = Trim(Mid(Cmb_BMPar.Text, 1, vlNumero - 1))
        If vlOpcion = clCodParCau Then
            vlNumero = InStr(Lbl_POTipPen, "-")
            vlOpcion = Trim(Mid(Lbl_POTipPen, 1, vlNumero - 1))
            'Revisar tipo de pension que el beneficiario tiene (en label de ficha de poliza original)
            'Para asignar  el tipo de pension de vejez o invalidez que corresponda
            If Trim(vlOpcion) = clTipPension09 Then
                Cmb_PMTipPen.ListIndex = fgBuscarPosicionCodigoCombo(clTipPension04, Cmb_PMTipPen)
            End If
            If Trim(vlOpcion) = clTipPension10 Then
                Cmb_PMTipPen.ListIndex = fgBuscarPosicionCodigoCombo(clTipPension05, Cmb_PMTipPen)
            End If
            If Trim(vlOpcion) = clTipPension11 Then
                Cmb_PMTipPen.ListIndex = fgBuscarPosicionCodigoCombo(clTipPension06, Cmb_PMTipPen)
            End If
            If Trim(vlOpcion) = clTipPension12 Then
                Cmb_PMTipPen.ListIndex = fgBuscarPosicionCodigoCombo(clTipPension07, Cmb_PMTipPen)
            End If
            
            'Cmb_PMTipPen.Enabled = True
            
            'Cambiar el Estado de Pensión a Vigente
            Cmb_BMDerPen.ListIndex = fgBuscarPosicionCodigoCombo(clCodConDerPen, Cmb_BMDerPen)
            
        End If
        
    End If

    Cmb_PMTipPen.Enabled = False

Exit Function
Err_flBenefConFecFall:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flCalcularPrimaPension(iMtoPrimaOri As Double, iMtoPrimaModi As Double, iMtoPensionOri As Double) As Boolean
Dim vlCalculo As Double
On Error GoTo Err_CalcularPriPen

    flCalcularPrimaPension = False
    vlMontoPensionPrima = 0
    
    'Determinar si existe diferencia entre la Prima Original y Modificada
    If (iMtoPrimaOri <> iMtoPrimaModi) Then
        vlCalculo = (iMtoPrimaModi) / (iMtoPrimaOri / iMtoPensionOri)
        vlMontoPensionPrima = Format(vlCalculo, "#0.00")
    Else
        vlMontoPensionPrima = iMtoPensionOri
    End If
    
    flCalcularPrimaPension = True

Exit Function
Err_CalcularPriPen:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flHabilitarPenGar()

    'I--- ABV 20/04/2005 ---
    vlNumero = InStr(Cmb_PMTipPen.Text, "-")
    vgPalabra = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
    
    vgI = InStr(1, clPensionInvVejez, vgPalabra)
    If (vgI <> 0) Then
        'Valida que sea un caso de Invalidez o Vejez
        Txt_BMMtoPensionGar.Enabled = False
    End If
    
    vgI = InStr(1, clPensionSobOrigen, vgPalabra)
    If (vgI <> 0) Then
'I--- ABV 17/11/2007 ---
'        'Valida que sea un caso de Sobrevivencia por Origen
'        'Se supone que la Cónyuge o Madre es la única que Garantiza su pensión
'        vlNumero = InStr(Cmb_BMPar.Text, "-")
'        vgPalabraAux = Trim(Mid(Cmb_BMPar.Text, 1, vlNumero - 1))
'
'        vgX = InStr(1, clParConyugeMadre, vgPalabraAux)
'        If (vgX <> 0) Then
'            Txt_BMMtoPensionGar.Enabled = False
'        Else
'            Txt_BMMtoPensionGar.Enabled = True
'        End If
        Txt_BMMtoPensionGar.Enabled = True
'F--- ABV 17/11/2007 ---
    End If
    
    vgI = InStr(1, clPensionSobTransf, vgPalabra)
    If (vgI <> 0) Then
        'Valida que sea un caso que cambio de estado a una Sobrevivencia de ..
        Txt_BMMtoPensionGar.Enabled = True
    End If
    
    'F--- ABV 19/04/2005 ---

End Function

Function flCalcularDatosAsignarMatriz(iNumPoliza As String, iFechaEfecto As String, iFechaVigencia As String, _
iMesDif As Long, iMesGar As Long, iCodTipoPension _
, iCodCausalEndoso As String, iFecDevengue As String) As Boolean
Dim ilContarBenefGrillaOri As Integer
Dim ilContarBenefGrillaMod As Integer
Dim ilFechaIngreso As String, ilFechaIniPago As String, ilFechaTerPagoGar As String
Dim ilDireccion    As String, ilCodDireccion As String
Dim ilCodInsSalud  As String, ilCodModSalud  As String, ilMtoSalud     As Double
Dim ilCodCajaCom   As String
Dim ilCodVia       As String, ilCodBanco     As String, ilCodTipoCta   As String
Dim ilNumCta       As String, ilCodSucursal  As String
Dim ilCodMotReqPen As String
Dim ilCodCauSus    As String, ilFecSus       As String
Dim ilFechaDiferida As String
Dim vlAño As Integer, vlMes As Integer, vlDia As Integer
Dim vlI   As Long

'Datos de Validación de Causal
Dim ilAuxFecFal As String
Dim ilAuxFecMat As String
Dim ilAuxCodPar As String
Dim ilAuxDerPen As String
Dim ilAuxEstPen As String
Dim ilSwNueva   As Boolean

On Error GoTo Err_CalcularDatosPendientes

    flCalcularDatosAsignarMatriz = False
    
    ilContarBenefGrillaOri = 0
    ilContarBenefGrillaMod = 0
    ilContarBenefGrillaOri = Msf_BOGrilla.rows - 1
    ilContarBenefGrillaMod = Msf_BMGrilla.rows - 1
    
    If (ilContarBenefGrillaOri <= 0) Then
        MsgBox "No existen Beneficiarios en la Póliza Original.", vbCritical, "Error de Datos"
        Exit Function
    End If
    If (ilContarBenefGrillaOri > ilContarBenefGrillaOri) Then
        MsgBox "Existen diferencias en la Cantidad de Beneficiarios Originales contra los Nuevos.", vbCritical, "Error de Datos"
        Exit Function
    End If
    
'    'Determinar los Antecedentes de Salud
'    vgSql = "select cod_inssalud,cod_modsalud,cod_viapago,"
'    vgSql = vgSql & "cod_tipcuenta, cod_banco, num_cuenta,cod_sucursal "
'    vgSql = vgSql & "from MA_TCOD_GENERAL"
'    Set vgRs4 = vgConexionBD.Execute(vgSql)
'    If Not vgRs4.EOF Then
'        If IsNull(vgRs4!Cod_InsSalud) Then
'            ilCodInsSalud = "13"
'        Else
'            ilCodInsSalud = vgRs4!Cod_InsSalud
'        End If
'        If IsNull(vgRs4!cod_modsalud) Then
'            ilCodModSalud = "PRCIM"
'        Else
'            ilCodModSalud = vgRs4!cod_modsalud
'        End If
'    Else
'        ilCodInsSalud = "13"
'        ilCodModSalud = "PRCIM"
'    End If
'    vgRs4.Close
'
'    'Luego se obtiene el Monto a descontar por Salud
'    vgSql = "select mto_elemento from MA_TPAR_TABCODVIG "
'    vgSql = vgSql & "where cod_tabla= '" & vgCodTabla_PrcSal & "' and "
'    vgSql = vgSql & "cod_elemento = 'PSM' and "
'    vgSql = vgSql & "fec_inivig <= '" & iFechaVigencia & "' and "
'    vgSql = vgSql & "fec_tervig >= '" & iFechaVigencia & "'"
'    Set vgRs4 = vgConexionBD.Execute(vgSql)
'    If Not vgRs4.EOF Then
'        ilMtoSalud = Format(vgRs4!mto_elemento, "#0.00")
'    Else
'        ilMtoSalud = 0
'    End If
'    vgRs4.Close
    
    'Definición de Valores Estandar a Aplicar a los Beneficiarios
    'Fecha de Ingreso del Beneficiario
    ilFechaIngreso = Format(Date, "yyyymmdd")
    
    If (iCodCausalEndoso <> cgCodCausalEndPagoDif) Then
        'Fecha de Termino del Periodo Diferido
        ilFechaDiferida = fgCalcularFechaFinPerDiferido(iFecDevengue, CLng(iMesDif))
        'Fecha de Termino del Periodo Garantizado
        ilFechaTerPagoGar = fgCalcularFechaFinPerGarantizado(iFecDevengue, CLng(iMesDif), CLng(iMesGar))
        'Fecha de Inicio del Pago de Pensiones por Parte de la Compañía
        ilFechaIniPago = fgCalcularFechaIniPagoPensiones(iFecDevengue, CLng(iMesDif))
        
        'Determinar la Fecha de Inicio de Pago del Periodo Diferido
        If (iMesDif > 0) Then
            If (iFechaEfecto > ilFechaDiferida) Then
                ilFechaIniPago = iFechaEfecto
            Else
                ilFechaIniPago = ilFechaDiferida
            End If
        End If
    Else
    
        'Si la causal del Endoso corresponde a un adelanto de un periodo diferido entonces se debe determinar
        'la Fecha de Inicio de Pago y termino del Periodo de Diferido de acuerdo a la Fecha de Efecto
        
        'Fecha de Termino del Periodo Diferido
        ilFechaDiferida = fgCalcularFechaFinPerDiferido(iFechaEfecto, CLng(0))
        'Fecha de Termino del Periodo Garantizado
        ilFechaTerPagoGar = fgCalcularFechaFinPerGarantizado(iFechaEfecto, CLng(0), CLng(iMesGar))
        'Fecha de Inicio del Pago de Pensiones por Parte de la Compañía
        ilFechaIniPago = fgCalcularFechaIniPagoPensiones(iFechaEfecto, CLng(0))
        
'        'Determinar la Fecha de Inicio de Pago del Periodo Diferido
'        If (iMesDif > 0) Then
'            If (iFechaEfecto > ilFechaDiferida) Then
'                ilFechaIniPago = iFechaEfecto
'            Else
'                ilFechaIniPago = ilFechaDiferida
'            End If
'        End If
    End If
    
    
    'Fecha de Inicio del Pago de Pensión
''''''    ilFechaDiferida = ""
''''''    If (iMesDif = 0) Then
''''''        ilFechaIniPago = iFechaVigencia
''''''        ilFechaDiferida = iFechaVigencia
''''''    Else
''''''        vlAño = Mid(Trim(iFechaVigencia), 1, 4)
''''''        vlMes = Mid(Trim(iFechaVigencia), 5, 2)
''''''        vlMes = CInt(vlMes) + (iMesDif)
''''''        vlDia = Mid(Trim(iFechaVigencia), 7, 2)
''''''        ilFechaDiferida = Format(DateSerial(vlAño, vlMes, vlDia), "yyyymmdd")
''''''
''''''        If (iFechaEfecto > ilFechaDiferida) Then
''''''            ilFechaIniPago = iFechaEfecto
''''''        Else
''''''            ilFechaIniPago = ilFechaDiferida
''''''        End If
''''''    End If
''''''
''''''    'Determinación de Fecha de Período Garantizado
''''''    ilFechaTerPagoGar = ""
''''''    vlAnno = Mid(Trim(ilFechaDiferida), 1, 4)
''''''    vlMes = Mid(Trim(ilFechaDiferida), 5, 2)
''''''    vlDia = Mid(Trim(ilFechaDiferida), 7, 2)
''''''    If (iMesGar > 0) Then
''''''        ilFechaTerPagoGar = DateSerial(vlAnno, vlMes + (iMesGar), vlDia - 1)
''''''        ilFechaTerPagoGar = Format(CDate(ilFechaTerPagoGar), "yyyymmdd")
''''''    Else
''''''        ilFechaTerPagoGar = ""
''''''    End If
    
'    'Definición de Cajas de compensación y Vías de Pago
'    ilCodCajaCom = "00"
'    ilCodVia = "00"
'    ilCodBanco = "00"
'    ilCodTipoCta = "00"
'    ilNumCta = ""
'    ilCodSucursal = "0000"
'
'    'Determinar la Dirección del Causante de la Póliza
'
'    ilDireccion = ""
'    ilCodDireccion = "292"
'
'    'Determinar los Antecedentes de Salud
'    vgSql = "select cod_direccion,gls_direccion "
'    vgSql = vgSql & "from PP_TMAE_BEN where cod_par = " & clCodParCau & " "
'    vgSql = vgSql & "order by num_endoso desc "
'    Set vgRs4 = vgConexionBD.Execute(vgSql)
'    If Not vgRs4.EOF Then
'        If Not IsNull(vgRs4!Cod_Direccion) Then
'            ilCodDireccion = vgRs4!Cod_Direccion
'        End If
'        If Not IsNull(vgRs4!Gls_Direccion) Then
'            ilDireccion = vgRs4!Gls_Direccion
'        End If
'    End If
'    vgRs4.Close
    
    'Buscar los valores correspondientes a estos campos (determinar su situación)
    ilCodMotReqPen = clCodMotReqNoCons
    ilCodCauSus = clCodCauSusSin
    ilFecSus = ""
    
    'Actualizar los datos de los Beneficiarios, de acuerdo a los cambios realizados
    vlI = 1
    If (Msf_BMGrilla.rows > 1) Then
        
        While vlI <= (Msf_BMGrilla.rows - 1)
            
            ilAuxFecFal = Msf_BMGrilla.TextMatrix(vlI, 21)
            ilAuxFecMat = Msf_BMGrilla.TextMatrix(vlI, 29)
            ilAuxCodPar = Msf_BMGrilla.TextMatrix(vlI, 7)
            ilAuxDerPen = Msf_BMGrilla.TextMatrix(vlI, 22)
            ilAuxEstPen = Msf_BMGrilla.TextMatrix(vlI, 11)
            ilSwNueva = False
            
            'Verificar si se trata de un Nuevo Beneficiario a través del Nº Orden
            If ((Msf_BOGrilla.rows - 1) < vlI) Then
'                'Para los Nuevos Casos se debe determinar lo sgte:
'                '1N.Fecha Ingreso
'                '2N.Dirección  : Dirección y Código de Dirección
'                '3N.Salud      : Institución, Modalidad, Monto o Porcentaje
'                '4N.Cajas Compensación
'                ilCodCajaCom
'                '5N.Pagos      : Vía, Banco, Tipo Cta, Nº Cta, Sucursal
'                ilCodVia
'                ilCodBanco
'                ilCodTipoCta
'                ilNumCta
'                ilCodSucursal

                '6N.Fecha Inicio Pago
                If (iFechaEfecto > ilFechaIniPago) Then
                    Msf_BMGrilla.TextMatrix(vlI, 27) = DateSerial(Mid(iFechaEfecto, 1, 4), Mid(iFechaEfecto, 5, 2), Mid(iFechaEfecto, 7, 2))
                Else
                    Msf_BMGrilla.TextMatrix(vlI, 27) = DateSerial(Mid(ilFechaIniPago, 1, 4), Mid(ilFechaIniPago, 5, 2), Mid(ilFechaIniPago, 7, 2))
                End If
                'Msf_BMGrilla.TextMatrix(vlI, 25) = DateSerial(Mid(ilFechaIniPago, 1, 4), Mid(ilFechaIniPago, 5, 2), Mid(ilFechaIniPago, 7, 2))

                '7N.Fecha Termino Pago Garantizado
                'If (ilFechaTerPagoGar <> "") Then
                If (CDbl(Msf_BMGrilla.TextMatrix(vlI, 24)) > 0) Then
                    If (ilFechaTerPagoGar <> "") Then
                        Msf_BMGrilla.TextMatrix(vlI, 28) = DateSerial(Mid(ilFechaTerPagoGar, 1, 4), Mid(ilFechaTerPagoGar, 5, 2), Mid(ilFechaTerPagoGar, 7, 2))
                    Else
                        Msf_BMGrilla.TextMatrix(vlI, 28) = ilFechaTerPagoGar
                    End If
                Else
                    Msf_BMGrilla.TextMatrix(vlI, 28) = ""
                End If
                
                ilSwNueva = True
            End If
            
            
            If (ilAuxEstPen = clCodSinDerPen) Then
                
                'Nota: el Requisito de Pensión no se justifica cuando el Beneficiario se
                'encuentra muerto, solo se informa como 1 No Constituye Excepción
                If (ilAuxFecFal <> "") Then
                    ilCodMotReqPen = clCodMotReqNoCons
                    ilCodCauSus = clCodCauSusFall
                    ilFecSus = ilAuxFecFal
                Else
                    vgX = InStr(1, iCodTipoPension, clPensionInvVejez)
                    If (vgX <> 0) Then
                        Select Case ilAuxCodPar
                            Case 30 To 39
                                'Determinar si se trata de un Hijo
                                'Determinar las Causales de Suspensión y Mot. Req. Pensión
                                'If (ilAuxFecMat <> "") Then
                                    ilCodMotReqPen = clCodMotReqHijSinD
                                    ilCodCauSus = clCodCauSusMatHij
                                    ilFecSus = ilAuxFecMat
                                'Else
                                '   Es lo mismo que la otra, no existen más
                                'End If
                                
                            Case 77
                                'Determinar si es un Beneficiario Designado
                                ilCodMotReqPen = clCodMotReqExBenDes
                                ilCodCauSus = clCodCauSusRenBen
                                ilFecSus = Format(DateSerial(Mid(iFechaEfecto, 1, 4), Mid(iFechaEfecto, 5, 2), Mid(iFechaEfecto, 7, 2) - 1), "yyyymmdd")
                                
                            Case 10 To 19
                                'Verificar si se trata de una Cónyuge
                                If (ilSwNueva = True) Then
                                    ilCodMotReqPen = clCodMotReqConyPos
                                    ilCodCauSus = clCodCauSusNulMat
                                    ilFecSus = Format(DateSerial(Mid(iFechaEfecto, 1, 4), Mid(iFechaEfecto, 5, 2), Mid(iFechaEfecto, 7, 2) - 1), "yyyymmdd")
                                Else
                                    ilCodMotReqPen = clCodMotReqExCony
                                    ilCodCauSus = clCodCauSusNulMat
                                    ilFecSus = Format(DateSerial(Mid(iFechaEfecto, 1, 4), Mid(iFechaEfecto, 5, 2), Mid(iFechaEfecto, 7, 2) - 1), "yyyymmdd")
                                End If
                            
                            Case 20 To 29
                                ilCodMotReqPen = clCodMotReqExMadre
                                ilCodCauSus = clCodCauSusRenBen
                                ilFecSus = Format(DateSerial(Mid(iFechaEfecto, 1, 4), Mid(iFechaEfecto, 5, 2), Mid(iFechaEfecto, 7, 2) - 1), "yyyymmdd")
                                
                            Case Else
                                ilCodMotReqPen = clCodMotReqNoCons
                                ilCodCauSus = clCodCauSusSin
                                ilFecSus = ""
                        
                        End Select
                    Else
                        ilCodMotReqPen = clCodMotReqNoCons
                        ilCodCauSus = clCodCauSusSin
                        ilFecSus = ""
                    End If
                End If
            Else
                ilCodMotReqPen = clCodMotReqNoCons
                ilCodCauSus = clCodCauSusSin
                ilFecSus = ""
            End If
                    
            'Asignar a las Columnas de la Grilla
            'Motivo de Requisito Pensión
            Msf_BMGrilla.TextMatrix(vlI, 23) = ilCodMotReqPen
            'Código Causa Suspensión
            Msf_BMGrilla.TextMatrix(vlI, 25) = ilCodCauSus
            'Fecha Suspensión
            Msf_BMGrilla.TextMatrix(vlI, 26) = ilFecSus
            'Fecha Inicio Pago
            If (ilSwNueva = True) Then
                If (iFechaEfecto > ilFechaIniPago) Then
                    Msf_BMGrilla.TextMatrix(vlI, 27) = DateSerial(Mid(iFechaEfecto, 1, 4), Mid(iFechaEfecto, 5, 2), Mid(iFechaEfecto, 7, 2))
                Else
                    Msf_BMGrilla.TextMatrix(vlI, 27) = DateSerial(Mid(ilFechaIniPago, 1, 4), Mid(ilFechaIniPago, 5, 2), Mid(ilFechaIniPago, 7, 2))
                End If
            Else
                Msf_BMGrilla.TextMatrix(vlI, 27) = DateSerial(Mid(ilFechaIniPago, 1, 4), Mid(ilFechaIniPago, 5, 2), Mid(ilFechaIniPago, 7, 2))
            End If
            'Fecha Termino Pago Garantizada
'            If (ilFechaTerPagoGar <> "") And (ilAuxEstPen <> clCodSinDerPen) Then
            If (CDbl(Msf_BMGrilla.TextMatrix(vlI, 24)) > 0) Then
                If (ilFechaTerPagoGar <> "") And (ilAuxEstPen <> clCodSinDerPen) Then
                    Msf_BMGrilla.TextMatrix(vlI, 28) = DateSerial(Mid(ilFechaTerPagoGar, 1, 4), Mid(ilFechaTerPagoGar, 5, 2), Mid(ilFechaTerPagoGar, 7, 2))
                Else
                    Msf_BMGrilla.TextMatrix(vlI, 28) = "" 'ilFechaTerPagoGar ABV 16/10/2007
                End If
            Else
                Msf_BMGrilla.TextMatrix(vlI, 28) = ""
            End If

            vlI = vlI + 1
            
        Wend
        
        flCalcularDatosAsignarMatriz = True

    Else
        'Error ya que deben existir beneficiarios en la Grilla de Modificación
    End If

Exit Function
Err_CalcularDatosPendientes:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flBuscarDatosEndosoPreliminar(iNumPoliza As String, inumendoso As Integer) As Boolean
'Permite Buscar y Actualizar los valores obtenidos en la Etapa de Preliminar
'de la Póliza que se desea endosar
'Datos de Entrada :
' - iNumPoliza : Número de Póliza a buscar
' - iNumEndoso : Número de Endosos a buscar
On Error GoTo Err_BuscarEndoso
Dim vgRSPre As New ADODB.Recordset
    flBuscarDatosEndosoPreliminar = False
    
    vgQuery = "SELECT "
    vgQuery = vgQuery & "fec_solendoso,fec_endoso,cod_cauendoso,fec_efecto, "
    vgQuery = vgQuery & "mto_diferencia,mto_pensionori,mto_pensioncal,"
    vgQuery = vgQuery & "prc_factor,gls_observacion,cod_tipendoso "
    vgQuery = vgQuery & "FROM PP_TMAE_ENDOSO "
    vgQuery = vgQuery & "WHERE "
    vgQuery = vgQuery & "num_poliza = '" & iNumPoliza & "' AND "
    vgQuery = vgQuery & "num_endoso = " & inumendoso & " "
    Set vgRSPre = vgConexionBD.Execute(vgQuery)
    If Not vgRSPre.EOF Then
        Cmb_EndTipoEnd.ListIndex = fgBuscarPosicionCodigoCombo(Trim(vgRSPre!cod_tipendoso), Cmb_EndTipoEnd)
        Cmb_EndCauEnd.ListIndex = fgBuscarPosicionCodigoCombo(Trim(vgRSPre!cod_cauendoso), Cmb_EndCauEnd)
        
        If Not IsNull(vgRSPre!FEC_EFECTO) Then
            Txt_EndFecEfecto = DateSerial(Mid(vgRSPre!FEC_EFECTO, 1, 4), Mid(vgRSPre!FEC_EFECTO, 5, 2), Mid(vgRSPre!FEC_EFECTO, 7, 2))
        End If
        If Not IsNull(vgRSPre!fec_solendoso) Then
            Txt_EndFecEnd = DateSerial(Mid(vgRSPre!fec_solendoso, 1, 4), Mid(vgRSPre!fec_solendoso, 5, 2), Mid(vgRSPre!fec_solendoso, 7, 2))
        End If
        Lbl_EndCrear = inumendoso + 1
        If Not IsNull(vgRSPre!GLS_OBSERVACION) Then
            Txt_EndObs = Trim(vgRSPre!GLS_OBSERVACION)
        Else
            Txt_EndObs = ""
        End If
        Lbl_EndMtoPensionOrig = Format(vgRSPre!mto_pensionori, "#,#0.00")
        Lbl_EndMtoPensionCalc = Format(vgRSPre!mto_pensioncal, "#,#0.00")
        
        vlMtoPensionActOriginal = vgRSPre!mto_pensionori
        vlMtoPensionActModificada = vgRSPre!mto_pensioncal
        
        txt_EndMtoPensionOrig = Format(vlMtoPensionActOriginal, "#,#0.00")
        txt_EndMtoPensionCalc = Format(vlMtoPensionActModificada, "#,#0.00")
    Else
        If (Cmb_EndTipoEnd.ListCount > 0) Then
            Cmb_EndTipoEnd.ListIndex = 0
        End If
        If (Cmb_EndCauEnd.ListCount > 0) Then
            Cmb_EndCauEnd.ListIndex = 0
        End If
        Txt_EndFecEfecto = ""
        Txt_EndFecEnd = ""
        Lbl_EndCrear = ""
        Txt_EndObs = ""
        Lbl_EndMtoPensionOrig = ""
        Lbl_EndMtoPensionCalc = ""
    End If
    vgRSPre.Close
    Set vgRSPre = Nothing
    flBuscarDatosEndosoPreliminar = True

Exit Function
Err_BuscarEndoso:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flGrabarAprobacionPoliza(iNumPoliza As String, inumendoso As String) As Boolean
'Permite realizar la Aprobación con el manejo de Transacciones para realizar
'la vuelta atrás si es que se produce algún problema durante la grabación
On Error GoTo Err_Aprobar

    'Guardar el Código de la Causal del Endoso
     vlCodCauEndoso = fgObtenerCodigo_TextoCompuesto(Cmb_EndCauEnd.Text)

    flGrabarAprobacionPoliza = False
    
    'Abrir la Conexión
    If Not fgConexionBaseDatos(vgConectarBD) Then
        MsgBox "Falló la conexión con la Base de Datos.", vbCritical, "Error de Conexión"
        Exit Function
    End If
    
    'Comenzar la Transacción
    vgConectarBD.BeginTrans
    
    'POLIZA
    If (flFormatearDatosPolizaDef = False) Then
        'Deshacer la Transacción
        vgConectarBD.RollbackTrans
        
        'Cerrar Conexión
        vgConectarBD.Close
        
        Cmd_Salir.SetFocus
        Screen.MousePointer = 0
        Exit Function
    End If
            
    
    
    'Verificar existencia de regitro de poliza
    vgSql = ""
    vgSql = "SELECT num_poliza  FROM PP_TMAE_POLIZA "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & vlGlobalNumEndosoCrear & " "
    Set vgRegistro = vgConectarBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        'Deshacer la Transacción
        vgConectarBD.RollbackTrans
        
         'Cerrar Conexión
        vgConectarBD.Close
        
        MsgBox "El Nuevo Endoso a crear ya se encuentra Registrado en la Base de Datos." & Chr(13) & "Vuelva a comenzar nuevamente el proceso, realizando la búsqueda del caso para obtener su Nuevo Endoso.", vbCritical, "Proceso Cancelado"
        Cmd_Salir.SetFocus
        Screen.MousePointer = 0
        
        Exit Function
    End If
    vgRegistro.Close
    
    'Validar que el Endoso registrado por Pantalla sea el mismo
    'que el Calculado
    If (vlGlobalNumEndosoCrear <> Lbl_EndCrear) Then
        'Deshacer la Transacción
        vgConectarBD.RollbackTrans
        
        'Cerrar Conexión
        vgConectarBD.Close
        
        MsgBox "Vuelva a realizar el Proceso de Cálculo, ya que el Número de " & Chr(13) & _
               "Endoso no corresponde al último creado.", vbCritical, "Proceso Cancelado"
        Cmd_Salir.SetFocus
        Screen.MousePointer = 0
        Exit Function
    End If
    
    'BENEFICIARIOS
    '--------------------------
    'Obtener los valores por defecto que se asignarán a los Beneficiarios Nvos.
    '1. Fecha Ingreso
    vlFecIngreso = fgBuscaFecServ
    vlFecIngreso = Format(CDate(Trim(vlFecIngreso)), "yyyymmdd")
    
    '2. Obtener Dirección del Causante
   
    
    
    If Cmd_Calcular.Enabled = True Then
        vgSql = "SELECT gls_dirben,cod_direccion "
        vgSql = vgSql & "FROM PP_TMAE_BEN "
        vgSql = vgSql & "WHERE "
        vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
        vgSql = vgSql & "num_endoso = " & vlGlobalNumEndoso & " AND "
        vgSql = vgSql & "cod_par = " & Trim(clCodParCau) & " "
        Set vgRegistro = vgConectarBD.Execute(vgSql)
        If Not vgRegistro.EOF Then
            If Not IsNull(vgRegistro!Cod_Direccion) Then
                vlDefCodDireccion = (vgRegistro!Cod_Direccion)
            End If
            If Not IsNull(vgRegistro!Gls_DirBen) Then
                vlDefGlsDirBen = Trim(vgRegistro!Gls_DirBen)
            End If
        End If
        vgRegistro.Close
    Else
       vlDefCodDireccion = txtcodDirBen.Text
       vlDefGlsDirBen = txt_dirben.Text
       vlDefGlsFonoBen = txtTelBen.Text
       vlDefGlsCorreoBen = txtBenEmail.Text
       vlDefglsTelben2 = txtTelfon2.Text
    End If
    
    
    
    '3. Salud      : Institución, Modalidad, Monto o Porcentaje
    '4. Vías de Pago:
    vlDefCodInsSalud = "13"
    vlDefCodModSalud = "PORCE"
    vlDefMtoPlanSalud = 0
    
    vlDefCodViaPago = "00"
    vlDefCodBanco = "00"
    vlDefCodTipCuenta = "00"
    vlDefNumCuenta = ""
    vlDefCodSucursal = "000"
    
    vgSql = "SELECT cod_inssalud,cod_modsalud,cod_viapago,cod_tipcuenta,"
    vgSql = vgSql & "cod_banco,num_cuenta,cod_sucursal "
    vgSql = vgSql & "FROM MA_TCOD_GENERAL "
    Set vgRegistro = vgConectarBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        'Datos de Salud
        If Not IsNull(vgRegistro!Cod_InsSalud) Then vlDefCodInsSalud = vgRegistro!Cod_InsSalud
        If Not IsNull(vgRegistro!Cod_ModSalud) Then vlDefCodModSalud = vgRegistro!Cod_ModSalud
        
        'Datos de Vías de Pago
        If Not IsNull(vgRegistro!Cod_ViaPago) Then vlDefCodViaPago = vgRegistro!Cod_ViaPago
        If Not IsNull(vgRegistro!Cod_Sucursal) Then vlDefCodSucursal = vgRegistro!Cod_Sucursal
        If Not IsNull(vgRegistro!Cod_TipCuenta) Then vlDefCodTipCuenta = vgRegistro!Cod_TipCuenta
        If Not IsNull(vgRegistro!Cod_Banco) Then vlDefCodBanco = vgRegistro!Cod_Banco
        If Not IsNull(vgRegistro!Num_Cuenta) Then vlDefNumCuenta = vgRegistro!Num_Cuenta
    End If
    vgRegistro.Close

    '31.Salud      : Monto o Porcentaje
    If (fgObtieneParametroVigencia(vgCodTabla_PrcSal, clCodTablaSaludPrc, vlFecVigencia, vlDefMtoPlanSalud) = False) Then
        vlDefMtoPlanSalud = 0
    End If
    
    '4. Cajas Compensación
    vlDefCodCajaCompen = Trim(clCCAFSinInfo)
    'Fin de Valores por defecto
    '----------------------------------
    
    '----------------------------------
    'Insertar los datos de la Póliza
    'If (flInsertarPolizaDef = False) Then
    '    Cmd_Salir.SetFocus
    '    Screen.MousePointer = 0
    '    Exit Function
    'End If
    
    vlFecEfectoEnd = Format(CDate(Trim(Txt_EndFecEfecto)), "yyyymmdd")
    
    'Insertar Póliza
    Call flInsertarPolizaDef
    'Actualiza ultimo pensionAct
    Call flActualizaPensionAct
    'Inserta Polizas en Produccion
    Call flInsertaPolizasProdDef
    
    'If Cmd_Calcular.Enabled = True Then
'        'inserta certificado interno y el nuevo de 6 meses
'        Call CreaCertificado
    'End If
    
   
    
    'Registrar los datos de cada Beneficiario
    If Msf_BMGrilla.rows > 1 Then
       vlPos = 1
       Msf_BMGrilla.Col = 0
       
       While vlPos <= (Msf_BMGrilla.rows - 1)
            Msf_BMGrilla.row = vlPos
             
            If (flFormatearDatosBeneficiarioDef(Msf_BMGrilla.row) = False) Then
                'Deshacer la Transacción
                vgConectarBD.RollbackTrans
                
                'Cerrar Conexión
                vgConectarBD.Close
                
                Cmd_Salir.SetFocus
                Screen.MousePointer = 0
                Exit Function
            End If
             
            Msf_BMGrilla.Col = 0
             
            vgSql = "SELECT num_poliza FROM PP_TMAE_BEN "
            vgSql = vgSql & "WHERE "
            vgSql = vgSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
            vgSql = vgSql & "num_endoso = " & vlGlobalNumEndosoCrear & " AND "
            vgSql = vgSql & "num_orden  = " & vlNumOrden & " "
            Set vgRegistro = vgConectarBD.Execute(vgSql)
            If vgRegistro.EOF Then


    'Implementacion GobiernoDeDatos(se cargan los datos de direccion en las variables y se insertan en las tablas)_
            Call flCargarDatosBeneficiariosModDirec(Msf_BMGrilla.row)
            Call flInsertarBeneficiarioDirec("PP_TMAE_BEN_DIRECCION", "PP_TMAE_BEN_TELEFONO")
     'Fin Implementacion GobiernoDeDatos()_
                
                Call flInsertarBeneficiarioDef
                
                Call flInsertarBeneficiarioProdDef
                
'                If (vlBenefNuevo = True) Then
'
'                End If
            Else
                'Deshacer la Transacción
                vgConectarBD.RollbackTrans
                
                'Cerrar Conexión
                vgConectarBD.Close
                
                'AQUI DEBIERA ELIMINAR TODO LO REALIZADO HASTA EL MOMENTO
                MsgBox "El Beneficiario ya se encuentra registrado para un mismo Endoso.", vbCritical, "Proceso Cancelado"
                Cmd_Salir.SetFocus
                Screen.MousePointer = 0
                Exit Function
            End If
            vgRegistro.Close
            
            vlPos = vlPos + 1
       Wend
       
    End If
    
    'Se mueve aqui la creacion de Certificados
    'luego de haber grabado en pp_tmae_ben
     'inserta certificado interno y el nuevo de 6 meses
     Call CreaCertificado
  
'    ''''''''''''''''''''''''''''''''''''''''''''''modificar / cambiar para el caso de los repactos'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'    '''''''''''''''''''''''''''''''''''''OBTEIENE EL FACTOR DE AJUSTE POR FECHA DE DEVENGE PARA CASOS DE REPACTO RRR 15/04/2014
'    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'hay que chambear aqui
    Dim esActuarial As Boolean
           
    esActuarial = False
        
    If Mid(Cmb_EndTipoEnd, 1, 1) = "A" Then
        esActuarial = True
    End If
           
    If esActuarial = True Then
        vlFecDevengue = Format(CDate(Trim(Txt_EndFecEnd)), "yyyymmdd")
        vlFecEfectoEnd = Format(CDate(Trim(Txt_EndFecEfecto)), "yyyymmdd")
        vlMtoPension = (txt_EndMtoPensionCalc)
        vlMtoPensionGar = (txt_EndMtoPensionCalcGar)
    Else
        vlFecEfectoEnd = Format(CDate(Trim(Txt_EndFecEfecto)), "yyyymmdd")
        vlMtoPension = (Lbl_EndMtoPensionOrig)
        vlMtoPensionGar = (lbl_EndMtoPensionOrigGar)
    End If
    
    'If (vlCodMoneda = vgMonedaCodOfi) Then
    If vlCodTipReajuste <> cgSINAJUSTE Then 'hqr 13/01/2011
    
        Dim FedDesde As String
        Dim vlExistePensionAct As Boolean

        vlExistePensionAct = False

        Sql = "SELECT mto_pension, mto_pensiongar, fec_desde FROM pp_tmae_pensionact a"
        Sql = Sql & " WHERE a.num_poliza = '" & vlGlobalNumPoliza & "'"
        If esActuarial = True Then
            Sql = Sql & " AND a.num_endoso = " & vlGlobalNumEndosoCrear
        End If
        Sql = Sql & " AND a.fec_desde = "
        Sql = Sql & " (SELECT max(fec_desde) FROM pp_tmae_pensionact b"
        Sql = Sql & " WHERE b.num_poliza = a.num_poliza"
        Sql = Sql & " AND b.num_endoso = a.num_endoso "
        Sql = Sql & " AND b.fec_desde <= '" & vlFecEfectoEnd & "')"
            
        Set vgRegistro = vgConectarBD.Execute(Sql)
        If Not vgRegistro.EOF Then
            vlExistePensionAct = True
            FedDesde = vgRegistro!fec_desde
        End If

        If vlExistePensionAct = False Then
'             'If (vlNumMesDif > 0 And vlFecPriPago = vlFecIniPenCia And vlFecPriPago = vlFecEfectoEnd) Then  'Format(vlFecIniPago, "yyyymmdd")) Then
'                    'Obtiene Factores de actualización
'                    vlFactorAjusteDif = 1 'Sin Ajuste
'                    'hqr  03/03/2011
'                    'If clAjusteDesdeFechaDevengamiento Then
'                    vlFecDesdeAjustePension = Mid(vlFecDevengue, 1, 6) & "01" 'Fecha de Devengamiento, se deja en dia 01 para que el while de las vueltas correctas
'                    'Else
'                    '    vlFecDesdeAjustePension = vlTB!Fec_Vigencia 'Fecha de Inicio de Vigencia de la Póliza
'                    'End If
'
'                    vlFechaIniDif = DateSerial(Mid(vlFecDesdeAjustePension, 1, 4), Mid(vlFecDesdeAjustePension, 5, 2) + 1, Mid(vlFecDesdeAjustePension, 7, 2)) 'hqr 03/03/2011
'
'                    vlFecIniPago = DateSerial(Mid(vlFecEfectoEnd, 1, 4), Mid(vlFecEfectoEnd, 5, 2) + 1, Mid(vlFecEfectoEnd, 7, 2)) 'hqr 03/03/2011
'                    'vlFecEfectoEnd
'                    'vlFecIniPagoPen
'                    'vlFecIniPago
'                    vlFechaFinDif = DateAdd("m", -1, vlFecIniPago)
'                    vlNumPension = 2 'hqr 18/02/2011
'                    vlPasaTrimestre = False 'hqr 18/02/2011
'                    Do While vlFechaFinDif >= vlFechaIniDif
'                        vlMesDif = Month(vlFechaIniDif)
'                        vlAñoDif = Year(vlFechaIniDif)
'                        If (((vlMesDif Mod 3) - 1) = 0) Then
'                            If ((vlAñoDif <> Mid(vlFecDesdeAjustePension, 1, 4) Or vlMesDif <> Mid(vlFecDesdeAjustePension, 5, 2))) Then 'No se ajusta el primer mes
'                                'inicio hqr 03/12/2010
'                                If vlCodTipReajuste = cgAJUSTETASAFIJA Then
'                                    If (vlNumPension >= 2 And vlNumPension <= 3) And (Not (vlPasaTrimestre)) Then
'                                        vlFactorAjusteDif = (1 + (vlMtoValReajusteMen / 100))
'                                    Else
'                                        vlFactorAjusteDif = (1 + (vlMtoValReajusteTri / 100))
'                                    End If
'                                Else
'                                'fin hqr 03/12/2010
'                                    'Obtiene Factor de Ajuste Anterior
'                                   'If vlPrimerMesAjuste Then
'                                    vlFechaAjuste = Format(DateSerial(Year(vlFechaIniDif), Month(vlFechaIniDif) - 4, 1), "yyyymmdd")
'                                    'Obtener Factor anterior
'                                    If Not fgObtieneFactorAjuste(vlFechaAjuste, vlFactorAjusteDif) Then
'                                        MsgBox "No se encuentra Factor de Ajuste del Periodo: " & DateSerial(Mid(vlFechaAjuste, 1, 4), Mid(vlFechaAjuste, 5, 2), Mid(vlFechaAjuste, 7, 2)), vbCritical, Me.Caption
'                                        'GoTo Deshacer
'                                    End If
'                                    'End If
'                                    'vlPrimerMesAjuste = False
'
'                                    'Obtiene Factor de Ajuste Actual
'                                    vlFechaAjuste = Format(DateSerial(Year(vlFechaIniDif), Month(vlFechaIniDif) - 1, 1), "yyyymmdd")
'                                    'Factor de Ajuste Mes actual
'                                    If Not fgObtieneFactorAjuste(vlFechaAjuste, vlFactorAjusteDif2) Then
'                                        MsgBox "No se encuentra Factor de Ajuste del Periodo: " & DateSerial(Mid(vlFechaAjuste, 1, 4), Mid(vlFechaAjuste, 5, 2), Mid(vlFechaAjuste, 7, 2)), vbCritical, Me.Caption
'                                        'GoTo Deshacer
'                                    End If
'                                    vlFactorAjusteDif = vlFactorAjusteDif2 / vlFactorAjusteDif 'Format(vlFactorAjusteDif2 / vlFactorAjusteDif, "##0.0000")
'                                End If
'                                vlMtoPension = Format(vlFactorAjusteDif * vlMtoPension, "#0.00") 'La última Actualización
'                                vlMtoPensionGar = Format(vlFactorAjusteDif * vlMtoPensionGar, "#0.00") 'La última Actualización RRR
'                                If vlCodTipReajuste <> cgAJUSTETASAFIJA Then
'                                    vlFactorAjusteDif = vlFactorAjusteDif2
'                                End If
'                                vlPasaTrimestre = True 'hqr 14/02/2011
'                            End If 'hqr 03/12/2010
'                            vlFecDesdeAjuste = vlFechaIniDif
'                            vlFactorAjusteDif = vlFactorAjusteDif2
'                        Else 'No está en mes del trimestre
'                            If (vlCodTipReajuste = cgAJUSTETASAFIJA) And (vlNumPension >= 2 And vlNumPension <= 3) And (Not (vlPasaTrimestre)) Then
'                                vlFactorAjusteDif = (1 + (vlMtoValReajusteMen / 100))
'                                vlMtoPension = Format(vlFactorAjusteDif * vlMtoPension, "#0.00") 'La última Actualización
'                                vlMtoPensionGar = Format(vlFactorAjusteDif * vlMtoPensionGar, "#0.00") 'La última Actualización RRR
'                                vlFecDesdeAjuste = vlFechaIniDif
'                            End If
'                        End If
'                        vlFechaIniDif = DateAdd("m", 1, vlFechaIniDif)
'                        vlNumPension = vlNumPension + 1 'hqr 14/02/2011
'                    Loop
'
'
'                    vlSql = "INSERT INTO pp_tmae_pensionact "
'                    vlSql = vlSql & "(num_poliza, num_endoso, fec_desde, mto_pension, cod_tipopago, mto_pensiongar) "
'                    vlSql = vlSql & "VALUES ("
'                    vlSql = vlSql & "'" & vlGlobalNumPoliza & "', "
'                    vlSql = vlSql & " " & vlGlobalNumEndosoCrear & ", "
'                    vlSql = vlSql & "'" & vlFecEfectoEnd & "', "
'                    vlSql = vlSql & " " & str(vlMtoPension) & ","
'                    vlSql = vlSql & "'R',"
'                    vlSql = vlSql & " " & str(vlMtoPensionGar) & ")"
'                    vgConectarBD.Execute (vlSql)
'
'            'Else
'            '        vlSql = "INSERT INTO pp_tmae_pensionact "
'            '        vlSql = vlSql & "(num_poliza, num_endoso , fec_desde, mto_pension, cod_tipopago, mto_pensiongar) "
'            '        vlSql = vlSql & "SELECT num_poliza, " & vlGlobalNumEndosoCrear & ", "
'            '        vlSql = vlSql & "fec_desde, mto_pension, cod_tipopago, mto_pensiongar "
'            '        vlSql = vlSql & "FROM   pp_tmae_pensionact "
'            '        vlSql = vlSql & "WHERE "
'            '        vlSql = vlSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
'            '        vlSql = vlSql & "num_endoso = " & vlGlobalNumEndosoCrear - 1 & " "
'            '        vgConectarBD.Execute (vlSql)
'            'End If
        Else
                vlSql = "INSERT INTO pp_tmae_pensionact "
                vlSql = vlSql & "(num_poliza, num_endoso , fec_desde, mto_pension, cod_tipopago, mto_pensiongar) "
                vlSql = vlSql & "SELECT num_poliza, " & vlGlobalNumEndosoCrear & ", "
                vlSql = vlSql & "fec_desde, mto_pension, cod_tipopago, mto_pensiongar "
                vlSql = vlSql & "FROM   pp_tmae_pensionact "
                vlSql = vlSql & "WHERE "
                vlSql = vlSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
                vlSql = vlSql & "num_endoso = " & vlGlobalNumEndosoCrear - 1 & " "
                vgConectarBD.Execute (vlSql)
        End If

       

       
        'If (vlGlobalNumEndosoCrear > 1) Then
        '    'Crear Pensiones Actualizadas Repetidas del Endoso Anterior con el Nuevo Número de Endoso
        '    vlSql = "INSERT INTO pp_tmae_pensionact "
        '    vlSql = vlSql & "(num_poliza, num_endoso , fec_desde, mto_pension, cod_tipopago, mto_pensiongar) "
        '    vlSql = vlSql & "SELECT num_poliza, " & vlGlobalNumEndosoCrear & ", "
        '    vlSql = vlSql & "fec_desde, mto_pension, cod_tipopago, mto_pensiongar "
        '    vlSql = vlSql & "FROM   pp_tmae_pensionact "
        '    vlSql = vlSql & "WHERE "
        '    vlSql = vlSql & "num_poliza = '" & vlGlobalNumPoliza & "' AND "
        '    vlSql = vlSql & "num_endoso = " & vlGlobalNumEndosoCrear - 1 & " "
        '    vgConectarBD.Execute (vlSql)
        'Else
        '    'Copiar el Monto de la Pensión de Referencia Nueva en la Tabla de Pensiones Actualizadas
        '    'cuando es en Soles
        '    'Graba último Ajuste
        '    vlSql = "INSERT INTO pp_tmae_pensionact "
        '    vlSql = vlSql & "(num_poliza, num_endoso, fec_desde, mto_pension, cod_tipopago, mto_pensiongar) "
        '    vlSql = vlSql & "VALUES ("
        '    vlSql = vlSql & "'" & vlGlobalNumPoliza & "', "
        '    vlSql = vlSql & " " & vlGlobalNumEndosoCrear & ", "
        '    vlSql = vlSql & "'" & vlFecEfectoEnd & "', "
        '    vlSql = vlSql & " " & Str(vlMtoPension) & ","
        '    vlSql = vlSql & " " & Str(vlMtoPensionGar) & ","
        '    vlSql = vlSql & "'R')"
        '    vgConectarBD.Execute (vlSql)
        '
        'End If
    
        
    End If
    
    '*******************************************************************
    'CMV-20051024 I
    'Actualizar Datos de Fecha Fin Efecto del Endoso
    vgSql = ""
    vgSql = "SELECT num_poliza,num_endoso  FROM pp_tmae_endoso "
    vgSql = vgSql & "WHERE num_poliza = '" & vlGlobalNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & (CInt(vlGlobalNumEndoso) - 1) & " "
    Set vgRegistro = vgConectarBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        If (vgRegistro!num_endoso) >= 1 Then
            'Fecha de Efecto del Ultimo Endoso, es decir, el Endoso actual
            vlFecEfectoEnd = Format(CDate(Trim(Txt_EndFecEfecto)), "yyyymmdd")
            vlAnno = Mid(vlFecEfectoEnd, 1, 4)
            vlMes = Mid(vlFecEfectoEnd, 5, 2)
            vlDia = Mid(vlFecEfectoEnd, 7, 2)
            'Obtener fecha de fin de efecto del endoso anterior (ya grabado)
            vlFecFinEfecto = DateSerial(vlAnno, vlMes, vlDia - 1)
            vlFecFinEfecto = Format(CDate(Trim(vlFecFinEfecto)), "yyyymmdd")
            'Actualizar fecha de fin de efecto del endoso anterior, ya grabado
            vgSql = ""
            vgSql = "UPDATE pp_tmae_endoso SET "
            vgSql = vgSql & "fec_finefecto = " & Trim(vlFecFinEfecto) & ", "
            vgSql = vgSql & "cod_usuariomodi = '" & vlGlsUsuarioModi & "', "
            vgSql = vgSql & "fec_modi = '" & vlFecModi & "', "
            vgSql = vgSql & "hor_modi = '" & vlHorModi & "' "
            vgSql = vgSql & "WHERE "
            vgSql = vgSql & "num_poliza = '" & Trim(vlGlobalNumPoliza) & "' AND "
            vgSql = vgSql & "num_endoso = " & (CInt(vlGlobalNumEndoso) - 1) & " "
            vgConectarBD.Execute vgSql
        End If
    End If
    vgRegistro.Close
    'CMV-20051024 F
    
    'CMV-20051025 I
    'Actualizar Indicador Codigo de Estado del Endoso
    'Debe Pasar de PreEndoso "P", a Endoso "E".
    vlCodEstadoEndoso = clCodEstadoE
    vgSql = ""
    vgSql = "UPDATE pp_tmae_endoso SET "
    vgSql = vgSql & "cod_estado = '" & Trim(vlCodEstadoEndoso) & "', "
    vgSql = vgSql & "cod_usuariomodi = '" & vlGlsUsuarioModi & "', "
    vgSql = vgSql & "fec_modi = '" & vlFecModi & "', "
    vgSql = vgSql & "hor_modi = '" & vlHorModi & "' "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & Trim(vlGlobalNumPoliza) & "' AND "
    vgSql = vgSql & "num_endoso = " & (CInt(vlGlobalNumEndoso)) & " "
    vgConectarBD.Execute vgSql
    'CMV-20051025 F
    
    '*******************************************************************
    
    
    
    ''*********************************************************
    ''Actualizar Datos del Encabezado de Endoso
    ''Actualizar el Número de Endoso al Nuevo Número Creado
    'If (flInsertarEndosoDef = False) Then
    '    'Deshacer la Transacción
    '    vgConectarBD.RollbackTrans
    '
    '    'Cerrar Conexión
    '    vgConectarBD.Close
    '
    '    MsgBox "El Nuevo Endoso a crear no pudo ser generado en la BD, vuelva a intertarlo.", vbCritical, "Proceso Cancelado"
    '    Cmd_Salir.SetFocus
    '    Screen.MousePointer = 0
    '
    '    Exit Function
    'End If
    ''*********************************************************
    
    'Eliminar contenido de Tablas para Generación de Endoso
    'MsgBox "No eliminar", vbCritical, "No hacer"
    Call flEliminarRegistrosTempEnd(iNumPoliza, inumendoso)


    
If Not VSw_Pruebas Then

'Implementacion GobiernoDeDatos(Se envia los datos al gestor para guardar la informacion)_
  Dim vlCodCauEndos As String
  Dim error As Integer
  vlCodCauEndos = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))
  If Mid(Cmb_EndTipoEnd, 1, 1) = "O" Then
    If vlCodCauEndos <> "28" Then
            Dim RpstServicio As Boolean
            If Msf_BMGrilla.rows > 1 Then
               vlPos = 1
               Msf_BMGrilla.Col = 0
               While vlPos <= (Msf_BMGrilla.rows - 1)
                    Msf_BMGrilla.row = vlPos
                    If (flFormatearDatosBeneficiarioDefDirc(Msf_BMGrilla.row) = False) Then
                        Cmd_Salir.SetFocus
                        Screen.MousePointer = 0
                        RpstServicio = False
                    End If
                    Msf_BMGrilla.Col = 0
                    Call flCargarDatosBeneficiariosModDirec(Msf_BMGrilla.row)
                    
                   If Msf_BMGrilla.TextMatrix(vlPos, 48) = "1" Then 'Se envia solo si se ha modificado
                   
                        Dim MsgResponse As String
                        RpstServicio = EnviarGestorCliente(MsgResponse, "Grabar")
                        If (RpstServicio = False) Then
                          Screen.MousePointer = 0
                          error = 1
                         MsgBox MsgResponse & " Benef #" & vlPos
                        ' Exit Sub
                        End If
                    
                    End If
                    
                    
                 vlPos = vlPos + 1
            Wend
            End If
         End If
      End If
      If error = 1 Then
                vgConectarBD.RollbackTrans
                MsgBox "Ocurrio un problema al grabar el endoso", vbCritical, "Proceso Gestor Cliente"
                'Cerrar Conexión
                vgConectarBD.Close
                Cmd_Salir.SetFocus
                Screen.MousePointer = 0
      End If
      
End If
'Fin Implementacion GobiernoDeDatos()_
     

    'Ejecutar el Commit de la Transacción
    vgConectarBD.CommitTrans
    
    'Cerrar Conexión
    vgConectarBD.Close
    
    
    If Mid(Cmb_EndCauEnd.Text, 1, 2) = "07" Or Mid(Cmb_EndCauEnd.Text, 1, 2) = "09" Then
        Call Ins_causa_Final(vlNumPoliza, vlNumEndoso)
    End If
    

    flGrabarAprobacionPoliza = True
    
    
    
    
Exit Function
Err_Aprobar:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        
        'If (vgConectarBD.State = adStateOpen) Then
        
        'Deshacer la Transacción
        vgConectarBD.RollbackTrans
        
        'Cerrar Conexión
        vgConectarBD.Close
        
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flEliminarRegistroEndoso(iNumPoliza As String, inumendoso As String)
'*On Error GoTo Err_flEliminarRegistrosTempEnd
    
    vgSql = "DELETE PP_TMAE_ENDOSO "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    vgConectarBD.Execute (vgSql)

Exit Function
Err_flEliminarRegistrosTempEnd:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flEliminarPreliminar() As Boolean
On Error GoTo Err_flEliminarPreliminar
    
    flEliminarPreliminar = False
    
    'Abrir una nueva Conexión
    If Not fgConexionBaseDatos(vgConectarBD) Then
        MsgBox "Falló la conexión con la Base de Datos.", vbCritical, "Error de Conexión"
        Exit Function
    End If
    
    'Comenzar la Trnasacción
    vgConectarBD.BeginTrans
    
    Call flEliminarRegistrosTempEnd(vlGlobalNumPoliza, vlGlobalNumEndoso)
    Call flEliminarRegistroEndoso(vlGlobalNumPoliza, vlGlobalNumEndoso)
    
'Implementacion GobiernoDeDatos(Se elimina las tablas temporales de direccion y telefono)_
    Call flEliminarRegistrosTempEndDirc(vlGlobalNumPoliza, vlGlobalNumEndoso)
'Implementacion GobiernoDeDatos()_

    'Ejecutar el Commit de la Transacción
    vgConectarBD.CommitTrans
    
    'Cerrar Conexión
    vgConectarBD.Close
    
    flEliminarPreliminar = True

Exit Function
Err_flEliminarPreliminar:
    Screen.MousePointer = 0
    
    'Ejecutar el Commit de la Transacción
    vgConectarBD.RollbackTrans
    
    'Cerrar Conexión
    vgConectarBD.Close
    
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flInsertarEndosoDef() As Boolean

    flInsertarEndosoDef = False
    
    Call flFormatearDatosEndoso
    
    vgSql = ""
    vgSql = "UPDATE PP_TMAE_ENDOSO SET "
    vgSql = vgSql & " num_endoso = " & vlGlobalNumEndosoCrear & ", "
    vgSql = vgSql & " cod_usuariomodi = '" & vlGlsUsuarioModi & "' , "
    vgSql = vgSql & " fec_modi = '" & vlFecModi & "' , "
    vgSql = vgSql & " hor_modi = '" & vlHorModi & "' "
    vgSql = vgSql & " WHERE "
    vgSql = vgSql & " num_poliza = '" & vlGlobalNumPoliza & "' AND "
    vgSql = vgSql & " num_endoso = " & vlGlobalNumEndoso & " "
    vgConectarBD.Execute vgSql
    
    'Verificar existencia de registro de endoso Creado
    vgSql = ""
    vgSql = "SELECT num_poliza  FROM PP_TMAE_ENDOSO "
    vgSql = vgSql & "WHERE num_poliza = '" & vlGlobalNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & vlGlobalNumEndosoCrear & " "
    Set vgRegistro = vgConectarBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        flInsertarEndosoDef = True
    End If
    vgRegistro.Close

End Function

Function flGrabarPreliminarPoliza(iNumPoliza As String, inumendoso As String) As Boolean
'Permite realizar la Grabación con el manejo de Transacciones para realizar
'la vuelta atrás si es que se produce algún problema durante la grabación
On Error GoTo Err_Aprobar

    flGrabarPreliminarPoliza = False
    
    'Abrir la Conexión
    If Not fgConexionBaseDatos(vgConectarBD) Then
        MsgBox "Falló la conexión con la Base de Datos.", vbCritical, "Error de Conexión"
        Exit Function
    End If
    
    'Comenzar la Transacción
    vgConectarBD.BeginTrans
    
    'Grabar Información
    'ENDOSO
    Call flFormatearDatosEndoso
    
    'Verificar existencia de registro de endoso
    vgSql = "SELECT num_poliza  FROM PP_TMAE_ENDOSO "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    Set vgRegistro = vgConectarBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        Call flActualizarEndoso
    Else
        Call flInsertarEndoso
    End If
    vgRegistro.Close

    'POLIZA
    Call flFormatearDatosPoliza
    'Verificar existencia de regitro de poliza
    vgSql = "SELECT num_poliza  FROM PP_TMAE_ENDPOLIZA "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    Set vgRegistro = vgConectarBD.Execute(vgSql)
    If Not vgRegistro.EOF Then
        Call flActualizarPoliza
    Else
        Call flInsertarPoliza
    End If
    vgRegistro.Close
    
    
    'SOLO PARA LSO ENDOSO ORDINARIOS AQUI DEBE INSERTAR EN LA TABLA DE PRODUCCION EN LA POLIZA PD
'
'    If Cmd_Calcular.Enabled = False Then
'
'        'POLIZA
'        Call flFormatearDatosPoliza
'        'Verificar existencia de regitro de poliza
'        vgSql = "SELECT num_poliza  FROM PP_TMAE_ENDPOLIZA "
'        vgSql = vgSql & "WHERE "
'        vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
'        vgSql = vgSql & "num_endoso = " & inumendoso & " "
'        Set vgRegistro = vgConectarBD.Execute(vgSql)
'        If Not vgRegistro.EOF Then
'            Call flActualizarPoliza
'        Else
'            Call flInsertarPoliza
'        End If
'        vgRegistro.Close
'
'
'    End If
    
    
    
    
    'BENEFICIARIOS
    '---------------------
    'Eliminar Beneficiario
    vgSql = "DELETE FROM PP_TMAE_ENDBEN "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    vgSql = vgSql & "AND num_orden <> 1 "
    vgConectarBD.Execute vgSql
    
    
    vlLog_tabla = "PP_TMAE_ENDBEN"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.NUM_ORDEN"
    vlLog_valtabla = "" & iNumPoliza & "." & inumendoso & ",1"
    vlLog_trans = "DLT"
    Call flLog_Tabla
    

'Implementacion GobiernoDeDatos(se elminan las tablas endben de direccion y telefono y se genera un log)

     'Eliminar Beneficiario TELEFONO
    vgSql = "DELETE FROM PP_TMAE_ENDBEN_TELEFONO "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    'vgSql = vgSql & "AND num_orden <> 1 "
    vgConectarBD.Execute vgSql
    
    vlLog_tabla = "PP_TMAE_ENDBEN_TELEFONO"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.NUM_ORDEN"
    vlLog_valtabla = "" & iNumPoliza & "." & inumendoso & ",1"
    vlLog_trans = "DLT"
    Call flLog_Tabla
    
    
     'Eliminar Beneficiario Direccion
    vgSql = "DELETE FROM PP_TMAE_ENDBEN_DIRECCION "
    vgSql = vgSql & "WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    'vgSql = vgSql & "AND num_orden <> 1 "
    vgConectarBD.Execute vgSql
    
    vlLog_tabla = "PP_TMAE_ENDBEN_DIRECCION"
    vlLog_idtabla = "NUM_POLIZA.NUM_ENDOSO.NUM_ORDEN"
    vlLog_valtabla = "" & iNumPoliza & "." & inumendoso & ",1"
    vlLog_trans = "DLT"
    Call flLog_Tabla
    'Fin Implementacion GobiernoDeDatos()
    'vgConectarBD.RollbackTrans
    'Ingresar los Beneficiarios
    If Msf_BMGrilla.rows > 1 Then
        vlPos = 1
        Msf_BMGrilla.Col = 0
        While vlPos <= (Msf_BMGrilla.rows - 1)
            Msf_BMGrilla.row = vlPos
            Call flFormatearDatosBeneficiario(Msf_BMGrilla.row)
            Msf_BMGrilla.Col = 0
            'Implementacion GobiernoDeDatos(se insertan en las tablas endben de direccion y telefono)
            Call flCargarDatosBeneficiariosModDirec(Msf_BMGrilla.row)
            Call flInsertarBeneficiarioDirec("PP_TMAE_ENDBEN_DIRECCION", "PP_TMAE_ENDBEN_TELEFONO")
            'Implementacion GobiernoDeDatos()_
            vgSql = ""
            vgSql = "SELECT num_poliza  FROM PP_TMAE_ENDBEN "
            vgSql = vgSql & "WHERE "
            vgSql = vgSql & "num_poliza = '" & Trim(Txt_PenPoliza) & "' AND "
            vgSql = vgSql & "num_endoso = " & Trim(Lbl_End) & " AND "
            vgSql = vgSql & "num_orden = " & (vlNumOrden) & " "
            Set vgRegistro = vgConectarBD.Execute(vgSql)
            If Not vgRegistro.EOF Then
                Call flActualizarBeneficiario
            Else
                Call flInsertarBeneficiario
            End If
            vlPos = vlPos + 1
        Wend
        vlSwGrabar = True
    Else
    
    'SOLO PARA LOS ENDOSO ORDINARIOS AQUI DEBE INSERTAR EN LA TABLA DE PRODUCCION EN LA POLIZA_BENEFICIARIO PD
    
    
        'Deshacer la Transacción
        vgConectarBD.RollbackTrans
        
        'Cerrar Conexión
        vgConectarBD.Close
        
        MsgBox "No existen Beneficiarios a cargar desde la Grilla de Beneficiarios Modificados.", vbCritical, "Beneficiarios Inexistentes"
        
        Screen.MousePointer = 0
        Exit Function
    
    End If
    
   
    
    'Ejecutar el Commit de la Transacción
    vgConectarBD.CommitTrans
    
    'Cerrar Conexión
    vgConectarBD.Close
    
    If Mid(Cmb_EndCauEnd.Text, 1, 2) = "07" Or Mid(Cmb_EndCauEnd.Text, 1, 2) = "09" Then
        Call Ins_causa_preliminar(vlNumPoliza, vlNumEndoso, vlCodCauEndoso, Vl_numOrdCausaFac, VlcodCausaFac)
    
    End If
 
   
    flGrabarPreliminarPoliza = True
    
Exit Function
Err_Aprobar:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        
        'If (vgConectarBD.State = adStateOpen) Then
        
        'Deshacer la Transacción
        vgConectarBD.RollbackTrans
        
        'Cerrar Conexión
        vgConectarBD.Close
        
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Function flValidarDifCalculoPension(iNumPol As String, inumendoso As Integer, iSeCalculaPension As Boolean) As Boolean
'Permite validar si existen diferencias en los Datos de la Póliza y/o
'Beneficiarios, lo cual implique un recálculo de la Pensión
'No se recalcula Pensión cuando:
'- Fallece el Causante de la Póliza y el Grupo Familiar se activa
'- Cuando sale un Beneficiario del GF (fallecio, se caso, o murio)
'- Cuando cambia la Situación de Invalidez de los Beneficiarios
Dim viDiferenciasPol As Boolean
Dim viDiferenciasBen As Boolean
Dim viOriTipPension As String, viModTipPension As String
Dim viOriCodEstado  As String, viModCodEstado  As String
Dim viOriPrima      As Double, viModPrima      As Double
Dim viOriTipoRenta  As String, viModTipoRenta  As String
Dim viOriModalidad  As String, viModModalidad  As String
Dim viOriMesesDif  As Integer, viModMesesDif   As Integer
Dim viOriMesesGar  As Integer, viModMesesGar   As Integer
Dim viOriTasaCE     As Double, viModTasaCE     As Double
Dim viOriTasaVta    As Double, viModTasaVta    As Double
Dim viOriTasaPerGar As Double, viModTasaPerGar As Double

Dim viOriNumBenef   As Integer, viModNumBenef  As Integer
On Error GoTo Err_CalcularDif

    flValidarDifCalculoPension = False
    viDiferenciasPol = False
    viDiferenciasBen = False
    
    '----------------------------------------------------------
    'Verificar si existen diferencias en los Datos de la Póliza
    '----------------------------------------------------------
    If (viDiferenciasPol = False) Then
        '1. Obtener los Datos de la Póliza Original
        vgSql = "SELECT num_poliza,num_endoso,cod_tippension,Num_Cargas, "
        vgSql = vgSql & "Cod_Estado,Fec_Vigencia,Mto_Prima,Mto_Pension,Cod_TipRen,"
        vgSql = vgSql & "Cod_Modalidad,Num_MesDif,Num_MesGar,'0' as COD_CIAREA,"
        vgSql = vgSql & "'' as cod_operea, '' as COD_MODREA, '' as FEC_INIREA, "
        vgSql = vgSql & "'' as FEC_INIREA, 0 as PRC_TASARET, 0 as prc_tasacre, "
        vgSql = vgSql & "Prc_TasaCe, Prc_TasaVta, prc_tasaintpergar "
        vgSql = vgSql & "FROM PP_TMAE_POLIZA "
        vgSql = vgSql & "WHERE "
        vgSql = vgSql & "num_poliza = '" & iNumPol & "' "
        vgSql = vgSql & "AND num_endoso = " & inumendoso & " "
        Set vgRs = vgConexionBD.Execute(vgSql)
        If Not vgRs.EOF Then
            If Not IsNull(vgRs!Cod_TipPension) Then viOriTipPension = Trim(vgRs!Cod_TipPension)
            'If Not IsNull(vgRs!Num_Cargas) Then iNumBen = vgRs!Num_Cargas
            If Not IsNull(vgRs!Cod_Estado) Then viOriCodEstado = (Trim(vgRs!Cod_Estado))
            'If Not IsNull(vgRs!Fec_Vigencia) Then
            '    iIDVigencia = Mid(vgRs!Fec_Vigencia, 7, 2)
            '    iIMVigencia = Mid(vgRs!Fec_Vigencia, 5, 2)
            '    iIAVigencia = Mid(vgRs!Fec_Vigencia, 1, 4)
            'End If
            If Not IsNull(vgRs!Mto_Prima) Then viOriPrima = vgRs!Mto_Prima
            'If Not IsNull(vgRs!Mto_Pension) Then iPension = vgRs!Mto_Pension
            If Not IsNull(vgRs!Cod_TipRen) Then viOriTipoRenta = Trim(vgRs!Cod_TipRen)
            If Not IsNull(vgRs!Cod_Modalidad) Then viOriModalidad = Trim(vgRs!Cod_Modalidad)
            If Not IsNull(vgRs!Num_MesDif) Then viOriMesesDif = vgRs!Num_MesDif
            If Not IsNull(vgRs!Num_MesGar) Then viOriMesesGar = vgRs!Num_MesGar
            
            'If Not IsNull(vgRs!COD_CIAREA) Then iCiareaseguro = Trim(vgRs!COD_CIAREA)
            'If Not IsNull(vgRs!cod_operea) Then iOpeReaseguro = Trim(vgRs!cod_operea)
            'If Not IsNull(vgRs!COD_MODREA) Then iModReaseguro = Trim(vgRs!COD_MODREA)
            'If Not IsNull(vgRs!FEC_INIREA) Then
            '    iIDReaseguro = Mid(vgRs!FEC_INIREA, 7, 2)
            '    iIMReaseguro = Mid(vgRs!FEC_INIREA, 5, 2)
            '    iIAReaseguro = Mid(vgRs!FEC_INIREA, 1, 4)
            'End If
            'If Not IsNull(vgRs!PRC_TASARET) Then iPrcRetenido = vgRs!PRC_TASARET
            'If Not IsNull(vgRs!prc_tasacre) Then iTasaCret = vgRs!prc_tasacre
            
            If Not IsNull(vgRs!Prc_TasaCe) Then viOriTasaCE = vgRs!Prc_TasaCe
            If Not IsNull(vgRs!Prc_TasaVta) Then viOriTasaVta = vgRs!Prc_TasaVta
            If Not IsNull(vgRs!Prc_TasaIntPerGar) Then viOriTasaPerGar = vgRs!Prc_TasaIntPerGar
        End If
        vgRs.Close
        
        '2. Obtener los Datos de la Póliza Modificada
        vlNumero = InStr(Cmb_PMTipPen.Text, "-")
        viModTipPension = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
        'iNumBen = Lbl_PMNumCar
        vlNumero = InStr(Cmb_PMEstVig.Text, "-")
        viModCodEstado = Trim(Mid(Cmb_PMEstVig.Text, 1, vlNumero - 1))
        'iFecVigencia = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
        'iIDVigencia = Mid(iFecVigencia, 7, 2)
        'iIMVigencia = Mid(iFecVigencia, 5, 2)
        'iIAVigencia = Mid(iFecVigencia, 1, 4)
                
        viModPrima = (Txt_PMMtoPrima)
                
        'I--- ABV 20/04/2005 ---
        'iPension = Lbl_POMtoPen
        'iPension = iMontoPensionPrima
        'F--- ABV 20/04/2005 ---
                
        vlNumero = InStr(Cmb_PMTipRta.Text, "-")
        viModTipoRenta = Trim(Mid(Cmb_PMTipRta.Text, 1, vlNumero - 1))
        
        vlNumero = InStr(Cmb_PMMod.Text, "-")
        viModModalidad = Trim(Mid(Cmb_PMMod.Text, 1, vlNumero - 1))
        
        viModMesesDif = Txt_PMMesDif
        viModMesesGar = Txt_PMMesGar
                    
        'iCiareaseguro = "0"
        'iOpeReaseguro = ""
        'viModReaseguro = ""
        'iIDReaseguro = 0
        'iIMReaseguro = 0
        'iIAReaseguro = 0
        'iPrcRetenido = 0
        'iTasaCret = 0
                        
        viModTasaCE = CDbl(Txt_PMTasaCto)  'Str(Txt_PMTasaCto)
        viModTasaVta = CDbl(Txt_PMTasaVta)  'Str(Txt_PMTasaVta)
        viModTasaPerGar = CDbl(Txt_PMTasaPerGar)  'Str(Txt_PMTasaPerGar)
        
        'Verificar las Diferencias Uno a Uno
        'If (viOriTipPension <> viModTipPension) Then viDiferenciasPol = True
        'If (viOriCodEstado <> viModCodEstado) Then viDiferenciasPol = True
        If (CStr(viOriPrima) <> CStr(viModPrima)) Then viDiferenciasPol = True
        If (viOriTipoRenta <> viModTipoRenta) Then viDiferenciasPol = True
        If (viOriModalidad <> viModModalidad) Then viDiferenciasPol = True
        If (viOriMesesDif <> viModMesesDif) Then viDiferenciasPol = True
        If (viOriMesesGar <> viModMesesGar) Then viDiferenciasPol = True
        If (Round(viOriTasaCE, 2) <> Round(viModTasaCE, 2)) Then viDiferenciasPol = True
        If (CDec(viOriTasaVta) <> viModTasaVta) Then viDiferenciasPol = True
        If (viOriTasaPerGar <> viModTasaPerGar) Then viDiferenciasPol = True
        
    End If
    
    'Validar si existen diferencias en los Beneficiarios
    '--------------------------------------------------------------
    'que implique un recálculo de la Pensión de Referencia Original
    'Se asume que el ingreso de Nuevos Beneficiarios implica un Recalculo
    If (viDiferenciasPol = False) Then
        '1. Obtener el Número de Beneficiarios de la Póliza Original
        vgSql = "SELECT count(1) as numero "
        vgSql = vgSql & "FROM PP_TMAE_BEN "
        vgSql = vgSql & "WHERE "
        vgSql = vgSql & "num_poliza = '" & iNumPol & "' "
        vgSql = vgSql & "AND num_endoso = " & inumendoso & " "
        Set vgRs = vgConexionBD.Execute(vgSql)
        If Not vgRs.EOF Then
            If Not IsNull(vgRs!numero) Then viOriNumBenef = (vgRs!numero)
        End If
        vgRs.Close
        
        '2. Obtener el Número de Beneficiarios de la Póliza Modificada
        viModNumBenef = (Msf_BMGrilla.rows - 1)
        
        If (viOriNumBenef <> viModNumBenef) Then viDiferenciasBen = True
        
'I--- ABV 17/11/2005 ---
        If (viDiferenciasBen = False) Then
            '3. Validar que los Parentescos sean los mismos a los informados Originalmente
            vgSql = "SELECT num_poliza,num_orden,cod_par "
            vgSql = vgSql & "FROM PP_TMAE_BEN "
            vgSql = vgSql & "WHERE "
            vgSql = vgSql & "num_poliza = '" & iNumPol & "' "
            vgSql = vgSql & "AND num_endoso = " & inumendoso & " "
            Set vgRs = vgConexionBD.Execute(vgSql)
            While Not vgRs.EOF
                If (viDiferenciasBen = False) Then
                    For vgI = 1 To viModNumBenef
                        If (Trim(vgRs!Num_Orden) = Trim(Msf_BMGrilla.TextMatrix(vgI, 0))) Then
                            If (Trim(vgRs!Cod_Par) <> Trim(Msf_BMGrilla.TextMatrix(vgI, 7))) Then
                                viDiferenciasBen = True
                            End If
                            Exit For
                        End If
                    Next vgI
                End If
                vgRs.MoveNext
            Wend
            vgRs.Close
        End If
'F--- ABV 17/11/2005 ---
    End If
    
    If (viDiferenciasPol = True Or viDiferenciasBen = True) Then
        iSeCalculaPension = True
    Else
        iSeCalculaPension = False
    End If
    
    flValidarDifCalculoPension = True

Exit Function
Err_CalcularDif:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

'Función que permite realizar el cálculo de la Pensión
Function flCalcularPensionSinDif(iFechaProceso) As Boolean
Dim vlDiaPro        As Integer
Dim vlMesPro        As Integer
Dim vlAñoPro        As Integer
Dim vlNumPol        As String
Dim vlNumEndoso     As Long
Dim vlNumBen        As Long
Dim vlcobertura     As String
Dim vlPlan          As String
Dim vlCodEstado     As String
Dim vlIDVigencia    As Integer
Dim vlIMVigencia    As Integer
Dim vlIAVigencia    As Integer
Dim vlPrima         As Double
Dim vlPension       As Double
Dim vlTipoRenta     As String
Dim vlMesesDif      As Long
Dim vlModalidad     As String
Dim vlMesesGar      As Long
Dim vlCiareaseguro  As String
Dim vlOpeReaseguro  As String
Dim vlModReaseguro  As String
Dim vlIDReaseguro   As Integer
Dim vlIMReaseguro   As Integer
Dim vlIAReaseguro   As Integer
Dim vlPrcRetenido   As Double
Dim vlTasaCE        As Double
Dim vlTasaVta       As Double
Dim vlTasaCret      As Double

Dim vlPensionGar As Double
Dim vlPensionAct As Double
Dim vlPensionGarAct As Double

Dim vlVuelta     As Integer
Dim vlI          As Integer

Dim vlSwDerPerGar As Boolean

On Error GoTo Err_Calcular

    flCalcularPensionSinDif = False
    vgFechaTexto = Format(iFechaProceso, "yyyymmdd")
    
'**********************************************************************
    'Valida la Existencia de Parámetros de Cálculo
    '---------------------------------------------
    'Determinar los valores de Parámetros de Cálculo
    vlValor = 1332
    Fintab = vlValor
    
    ReDim Lx(1 To 2, 1 To 3, 1 To Fintab) As Double
    ReDim Ly(1 To 2, 1 To 3, 1 To Fintab) As Double
    
    'Validar los Topes de Edad de Pago de Pensiones
    If (fgCarga_Param("LI", "L24", vgFechaTexto) = False) Then
        MsgBox "No existe Edad de tope para los 24 años.", vbCritical, "Proceso Cancelado"
        Exit Function
    Else
        L24 = vgValorParametro
    End If
    If (fgCarga_Param("LI", "L21", vgFechaTexto) = False) Then
        MsgBox "No existe Edad de tope para los 21 años.", vbCritical, "Proceso Cancelado"
        Exit Function
    Else
        L21 = vgValorParametro
    End If
    If (fgCarga_Param("LI", "L18", vgFechaTexto) = False) Then
        MsgBox "No existe Edad de tope para los 18 años.", vbCritical, "Proceso Cancelado"
        Exit Function
    Else
        L18 = vgValorParametro
    End If
    
    'Las Edades de Tope se encuentran como Anuales, por lo que hay que Mensualizarlas
    L24 = L24 * 12
    L21 = L21 * 12
    L18 = L18 * 12
    
    '--------------------------------------------------
    'Proceso de Cálculos de Reservas seleccionadas
    '--------------------------------------------------
    'I--- ABV 15/03/2005 ---
    vgIndicadorTipoMovimiento_F = ""
    vgIndicadorTipoMovimiento_M = ""
    'F--- ABV 15/03/2005 ---
    
    vgFechaAnterior = ""
    vlDiaPro = Mid(vgFechaTexto, 7, 2)
    vlMesPro = Mid(vgFechaTexto, 5, 2)
    vlAñoPro = Mid(vgFechaTexto, 1, 4)
    vlReservaOriginal = 0
    vlReservaCalculada = 0
    vlFactor = 0
    
    'Calcular Reserva de Prima Única de Bautizo de Pólizas
    'Call flCalcularEndoso
    vlI = 1
    
    If (vlI = 1) Then
        'Determinar las Pólizas a calcular
        vgError = 0
            
        'Limpiar las variables
        vlNumPol = ""
        vlNumBen = 0
        vlPlan = 0
        'vlCobertura = ""
        vlCodEstado = 0
        vlIDVigencia = 0: vlIMVigencia = 0: vlIAVigencia = 0
        vlPrima = 0
        vlPension = 0
        vlTipoRenta = "": vlMesesDif = 0
        vlModalidad = "": vlMesesGar = 0
        'vlCiareaseguro = 0
        'vlOpeReaseguro = ""
        'vlModReaseguro = ""
        'vlIDReaseguro = 0: vlIMReaseguro = 0: vlIAReaseguro = 0
        'vlPrcRetenido = 0
        vlTasaCE = 0
        vlTasaVta = 0
        'vlTasaCret = 0
            
        vlNumPol = UCase(Trim(Txt_PenPoliza))
        vlNumEndoso = UCase(Trim(Lbl_End))
            
        vlNumero = InStr(Cmb_PMTipPen.Text, "-")
        vlPlan = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
        vlNumBen = Lbl_PMNumCar
        vlNumero = InStr(Cmb_PMEstVig.Text, "-")
        vlCodEstado = Trim(Mid(Cmb_PMEstVig.Text, 1, vlNumero - 1))
        vlFecVigencia = Format(CDate(Trim(Txt_PMIniVig)), "yyyymmdd")
        vlIDVigencia = Mid(vlFecVigencia, 7, 2)
        vlIMVigencia = Mid(vlFecVigencia, 5, 2)
        vlIAVigencia = Mid(vlFecVigencia, 1, 4)
        
        vlPrima = (Txt_PMMtoPrima)
            
        'I--- ABV 20/04/2005 ---
        'vlPension = Lbl_POMtoPen
        vlPension = vlMontoPensionPrima
        'F--- ABV 20/04/2005 ---
        
        vlNumero = InStr(Cmb_PMTipRta.Text, "-")
        vlTipoRenta = Trim(Mid(Cmb_PMTipRta.Text, 1, vlNumero - 1))
        
        vlNumero = InStr(Cmb_PMMod.Text, "-")
        vlModalidad = Trim(Mid(Cmb_PMMod.Text, 1, vlNumero - 1))
        
        vlMesesDif = Txt_PMMesDif
        vlMesesGar = Txt_PMMesGar
                    
        'vlCiareaseguro = "0"
        'vlOpeReaseguro = ""
        'vlModReaseguro = ""
        'vlIDReaseguro = 0
        'vlIMReaseguro = 0
        'vlIAReaseguro = 0
        'vlPrcRetenido = 0
        'vlTasaCret = 0
                
        vlTasaCE = CDbl(Txt_PMTasaCto)  'Str(Txt_PMTasaCto)
        vlTasaVta = CDbl(Txt_PMTasaVta)  'Str(Txt_PMTasaVta)
            
        'Llamar a función de Reserva Fija
        'vgCliente
        Call fgBasDosSinDif(1, vlNumPol, vlNumEndoso, vlAñoPro, vlMesPro, vlDiaPro, vlNumBen, vlPlan, _
        vlCodEstado, vlIAVigencia, vlIMVigencia, vlIDVigencia, vlPrima, vlPension, _
        vlTipoRenta, vlMesesDif, vlModalidad, vlMesesGar, vlTasaCE, vlTasaVta)
            
        If (vgError <> 0) Then
            'Definir termino del Cálculo de Endoso
            MsgBox "Error producido durante el proceso de cálculo de la Pensión.", vbCritical, "Proceso abortado"
            Exit Function
        End If
    End If

    'Determinar el nuevo valor de la Pensión
    'I--- ABV 20/04/2005 ---
    'vlPension = Lbl_POMtoPen
    'vlPension = vlMontoPensionPrima
    
'    If vlMesesGar > 0 Then
'        vlPension = lbl_EndMtoPensionCalcGar
'    Else
'        vlPension = Lbl_EndMtoPensionCalc
'    End If
    vlPension = Lbl_EndMtoPensionOrig
    vlPensionGar = lbl_EndMtoPensionOrigGar
    
    If Mid(Cmb_EndTipoEnd, 1, 1) = "A" Then
        Lbl_EndMtoPensionCalc = txt_EndMtoPensionCalc
        lbl_EndMtoPensionCalcGar = txt_EndMtoPensionCalcGar
    End If
    
    vlPensionAct = Lbl_EndMtoPensionCalc
    vlPensionGarAct = lbl_EndMtoPensionCalcGar
    
    'F--- ABV 20/04/2005 ---
    
    'If (vlReservaCalculada <> 0) Then
        'vlFactor = vlReservaOriginal / vlReservaCalculada
    'End If
    'vlMontoPensionFinal = Format(vlPensionAct * vlFactor, "#0.00")
    vlMontoPensionFinal = Format(vlPensionAct, "#0.00")
    
    'Lbl_EndMtoPensionCalc = Format(vlMontoPensionFinal, "#,#0.00")
    'lbl_EndMtoPensionCalcGar = Format(lbl_EndMtoPensionCalcGar, "#,#0.00")
'I--- ABV 19/10/2007 ---
    'Determinar el Tipo de Pensión
    vlNumero = InStr(Cmb_PMTipPen.Text, "-")
    vlPlan = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
'F--- ABV 19/10/2007 ---
    
    'Actualizar los montos de las Pensiones
    vlI = 1
    If (Msf_BMGrilla.rows > 1) Then
        While vlI <= (Msf_BMGrilla.rows - 1)
            
            vlPorcBenef = 0
            vlPenBenef = 0
            vlPenGarBenef = 0
            vlSwDerPerGar = False
                    
            If (vlMesesGar > 0) Then
                If (flObtenerDerechoPeriodoGarantizado(vlPlan, Msf_BMGrilla.TextMatrix(vlI, 7)) = True) Then
                    vlSwDerPerGar = True
                End If
            End If
                    
'            'Verificar el Estado de Derecho a Pensión (Cod_EstPension)
'            If (Msf_BMGrilla.TextMatrix(vlI, 11) <> "10") Then
            'Verificar el Estado de Derecho a Pensión (Cod_DerPen)
            If (Msf_BMGrilla.TextMatrix(vlI, 11) <> "10") Then
                vlPorcBenef = IIf(Msf_BMGrilla.TextMatrix(vlI, 20) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 20))
                'Determinar el monto de la Pensión del Beneficiario
                'Penben(i) = IIf(Msf_BMGrilla.TextMatrix(vlI, 17) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 17))
            
                vlPenBenef = vlPensionAct * (vlPorcBenef / 100)
            
                'Msf_BMGrilla.TextMatrix(vlI, 20) = vlPenBenef
            
                'Definir la Pensión del Garantizado
                '*************************************
                'Msf_BMGrilla.TextMatrix(vlI, 24) = vlPenBenef
                
                'vlPenGarBenef = CDbl(Msf_BMGrilla.TextMatrix(vlI, 24))

'                'I--- ABV 20/04/2005 ---
'                vlNumero = InStr(Cmb_PMTipPen.Text, "-")
'                vgPalabra = Trim(Mid(Cmb_PMTipPen.Text, 1, vlNumero - 1))
'
'                vgI = InStr(1, clPensionInvVejez, vgPalabra)
'                If (vgI <> 0) Then
'                    'Valida que sea un caso de Invalidez o Vejez
'                    vlPenGarBenef = vlPenBenef
'                End If
'
'                vgI = InStr(1, clPensionSobOrigen, vgPalabra)
'                If (vgI <> 0) Then
'                    'Valida que sea un caso de Sobrevivencia por Origen
'                    'Se supone que la Cónyuge o Madre es la única que Garantiza su pensión
'                    'vlNumero = InStr(Cmb_BMPar.Text, "-")
'                    vgPalabraAux = Trim(Msf_BMGrilla.TextMatrix(vlI, 7))
'
'                    vgX = InStr(1, clParConyugeMadre, vgPalabraAux)
'                    If (vgX <> 0) Then
'                        vlPenGarBenef = vlPenBenef
'                    'Else
'                    '    Txt_BMMtoPensionGar.Enabled = True
'                    End If
'                End If
'
'                vgI = InStr(1, clPensionSobTransf, vgPalabra)
'                If (vgI <> 0) Then
'                    ''Valida que sea un caso de Invalidez o Vejez
'                    'Txt_BMMtoPensionGar.Enabled = True
'                End If
            
                'F--- ABV 19/04/2005 ---
            '*************************************
            Else
            
            End If
            
            'Actualizar el Monto de la Pensión
            Msf_BMGrilla.TextMatrix(vlI, 19) = Format(vlPenBenef, "#,#0.00")
            
            'Actualizar el Monto de la Pensión Garantizada
            'Calcular el Porcentaje del Periodo Garantizado
            'If (vlMesesGar > 0) Then
            If (vlSwDerPerGar = True) Then
                vlPorcGarBenef = IIf(Msf_BMGrilla.TextMatrix(vlI, 30) = "", 0, Msf_BMGrilla.TextMatrix(vlI, 30))
                vlPenGarBenef = vlPensionGarAct * (vlPorcGarBenef / 100)
                Msf_BMGrilla.TextMatrix(vlI, 24) = Format(vlPenGarBenef, "#,#0.00")
'                Msf_BMGrilla.TextMatrix(vlI, 24) = Format(vlPenGarBenef, "#,#0.00")
'                vlPorcGarBenef = Format((vlPenGarBenef * 100) / vlPension, "#0.000000000")
'                Msf_BMGrilla.TextMatrix(vlI, 30) = vlPorcGarBenef
            Else
                Msf_BMGrilla.TextMatrix(vlI, 24) = Format(0, "#,#0.00")
                Msf_BMGrilla.TextMatrix(vlI, 30) = 0
            End If
            
            vlI = vlI + 1
        Wend
    Else
        'Error ya que deben existir beneficiarios en la Grilla de Modificación
        
    End If
'**********************************************************************
    
    flCalcularPensionSinDif = True

Exit Function
Err_Calcular:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function


Function flCalcularPorcentajePenGarBeneficiario(iFila As Integer)
'*On Error GoTo Err_flFormatearDatosBeneficiario

    Msf_BMGrilla.row = iFila
    
    Msf_BMGrilla.Col = 0
    vlNumOrden = Msf_BMGrilla.Text
    Msf_BMGrilla.Col = 1
    vlCodTipoIdenBen = fgObtenerCodigo_TextoCompuesto(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 2
    vlNumIdenBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 3
    vlNomBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 4
    vlNomSegBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 5
    vlPaternoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 6
    vlMaternoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 7
    vlCodPar = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 8
    vlCodGruFam = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 9
    vlCodSexo = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 10
    vlCodSitInv = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 11
    vlCodEstPension = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 12
    vlCodDerCre = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 13
    vlNumPoliza = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 14
    vlNumEndoso = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 15
    vlCodCauInv = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 16
    'I--- ABV 25/04/2005 ---
    vlFecNacBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Msf_BMGrilla.Col = 17
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecNacHM = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecNacHM = ""
    End If
    Msf_BMGrilla.Col = 18
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecInvBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecInvBen = ""
    End If
    'F--- ABV 25/04/2005 ---
    Msf_BMGrilla.Col = 19
    vlMtoPension = (Trim(Msf_BMGrilla.Text))
    Msf_BMGrilla.Col = 20
    vlPrcPension = (Trim(Msf_BMGrilla.Text))
    Msf_BMGrilla.Col = 21
    'I--- ABV 25/04/2005 ---
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecFallBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecFallBen = ""
    End If
    'F--- ABV 25/04/2005 ---
    Msf_BMGrilla.Col = 22
    vlCodDerpen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 23
    vlCodMotReqPen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 24
    vlMtoPensionGar = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 25
    vlCodCauSusBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 26
    'I--- ABV 25/04/2005 ---
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecSusBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecSusBen = ""
    End If
    Msf_BMGrilla.Col = 27
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecIniPagoPen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecIniPagoPen = ""
    End If
    Msf_BMGrilla.Col = 28
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecTerPagoPenGar = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecTerPagoPenGar = ""
    End If
    Msf_BMGrilla.Col = 29
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecMatrimonio = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecMatrimonio = ""
    End If
    
    Msf_BMGrilla.Col = 30
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlPrcPensionGar = (Msf_BMGrilla.Text)
    Else
        vlPrcPensionGar = 0
    End If
    Msf_BMGrilla.Col = 31
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlPrcPensionLeg = (Msf_BMGrilla.Text)
    Else
        vlPrcPensionLeg = 0
    End If
    'F--- ABV 25/04/2005 ---

Exit Function
Err_flFormatearDatosBeneficiario:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Function

Function flBuscarPensionActualizadaEndosoOriginal(iTablaPoliza As String, iFechaEfecto As String, iNumPoliza As String, inumendoso As Integer) As Double
Dim vlNumMesDif As Integer, vlNumMesGar As Integer
Dim vlFecPriPago As String, vlFecIniPenCia As String, vlFecDevengue As String, vlFecVigencia As String
Dim vlMtoPensionAct As Double
Dim vlMtoPensionActBenef As Double, vlMtoPensionActGarBenef As Double
Dim vlPrcPensionBenef As Double, vlPrcPensionGarBenef As Double
Dim vlSumaPension As Double, vlSumaPensionGar As Double
Dim vlDiferencia As Double
Dim vlFecEfectoPol As String
Dim vlCodMoneda As String, vlMtoPension As Double
Dim vlDerechoPerGar As Boolean, vlTipoPension As String
Dim vlCodTipReajuste As String, vlMtoValReajusteTri As Double, vlMtoValReajusteMen As Double

    flBuscarPensionActualizadaEndosoOriginal = 0
    
    vgSql = "SELECT num_endoso,num_poliza,cod_tippension "
    vgSql = vgSql & ",Cod_Moneda,Num_MesDif,Num_MesGar,Fec_PriPago,Fec_dev,Fec_IniPenCia"
    vgSql = vgSql & ",mto_pension ,NULL as fec_efecto  "
    vgSql = vgSql & ",cod_tipreajuste, mto_valreajustetri, mto_valreajustemen, fec_vigencia, mto_pensiongar, fec_finpergar " 'hqr 13/01/2011
    vgSql = vgSql & "FROM " & iTablaPoliza & " p WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    Set vlRegistro = vgConexionBD.Execute(vgSql)
    If Not vlRegistro.EOF Then
        vlNumMesDif = (vlRegistro!Num_MesDif)
        vlNumMesGar = (vlRegistro!Num_MesGar)
        vlFecPriPago = (vlRegistro!Fec_PriPago)
        vlFecIniPenCia = (vlRegistro!Fec_IniPenCia)
        vlFecDevengue = (vlRegistro!fec_dev)
        vlMtoPensionAct = (vlRegistro!Mto_Pension)
        vlFecEfectoPol = IIf(IsNull(vlRegistro!FEC_EFECTO), "", vlRegistro!FEC_EFECTO)
        vlCodMoneda = vlRegistro!Cod_Moneda
        vlMtoPension = vlRegistro!Mto_Pension
        vlTipoPension = vlRegistro!Cod_TipPension
        vlCodTipReajuste = vlRegistro!Cod_TipReajuste
        vlMtoValReajusteTri = vlRegistro!Mto_ValReajusteTri
        vlMtoValReajusteMen = vlRegistro!Mto_ValReajusteMen
        vlFecFigencia = vlRegistro!Fec_Vigencia
        vlMtoPensionGar = vlRegistro!Mto_PensionGar
        vlFecFinPerGar = IIf(IsNull(vlRegistro!fec_finpergar), 0, vlRegistro!fec_finpergar)
    End If
    vlRegistro.Close
    
    If vlNumMesGar > 0 Then
        vlFecEfecto = Mid(iFechaEfecto, 7, 2) & "/" & Mid(iFechaEfecto, 5, 2) & "/" & Mid(iFechaEfecto, 1, 4)
        vlFecFinPerGar = Mid(vlFecFinPerGar, 7, 2) & "/" & Mid(vlFecFinPerGar, 5, 2) & "/" & Mid(vlFecFinPerGar, 1, 4)
            
        If CDate(vlFecEfecto) < CDate(vlFecFinPerGar) Then
            vlMtoPension = vlMtoPensionGar
        End If
    End If
   
    
    flBuscarPensionActualizadaEndosoOriginal = vlMtoPension
    
    'If (vlCodMoneda = vgMonedaCodOfi) Then
'    If (vlCodTipReajuste <> cgSINAJUSTE) Then 'hqr 13/01/2011
'
'        'Determinar el Monto de la Pensión Actualizada
'        If (fgBuscarRegistroPensionActualizada(iNumPoliza, iFechaEfecto, vlMtoPensionAct, vlFecEfectoPol) = False) Then
'        End If
'
'        'Actualizar la Pensión a la Fecha de Efecto
'        vlMtoPensionAct = fgCalcularPensionActualizada(vlCodMoneda, vlNumMesDif, vlFecPriPago, vlFecIniPenCia, vlFecEfectoPol, vlFecDevengue, vlMtoPensionAct, iFechaEfecto, vlCodTipReajuste, vlMtoValReajusteTri, vlMtoValReajusteMen, vlFecVigencia) 'hqr 12/01/2011 Pendiente ABV agregar los datos de los dos ultimos parametros
'
''1. Corregir Póliza
'        'Corregir la información de la Pensión de Referencia en el Objeto que recibe la Pensión
'        Lbl_POMtoPen = Format(vlMtoPensionAct, "#0.00")
'        'Corregir la información de la Pensión de Referencia en la Estructura que recibe la Pensión
'        stPolizaOri.Mto_Pension = vlMtoPensionAct
'        If (stPolizaOri.Num_MesGar > 0) Then
'            stPolizaOri.Mto_PensionGar = vlMtoPensionAct
'        Else
'            stPolizaOri.Mto_PensionGar = 0
'        End If
'
''2. Corregir Beneficiarios
'        vlSumaPension = 0
'        vlSumaPensionGar = 0
'        vlDiferencia = 0
'
'        'Corregir la información de las Pensiones de los Beneficiarios en la Grilla
'        For vgI = 1 To Msf_BOGrilla.Rows - 1
'
'            vlDerechoPerGar = False
'            If (stPolizaOri.Num_MesGar > 0) Then
'                If (flObtenerDerechoPeriodoGarantizado(vlTipoPension, Msf_BOGrilla.TextMatrix(vgI, 7)) = True) Then
'                    vlDerechoPerGar = True
'                End If
'            End If
'
'            vlPrcPensionBenef = Msf_BOGrilla.TextMatrix(vgI, 20)
'            vlPrcPensionGarBenef = Msf_BOGrilla.TextMatrix(vgI, 31)
'            vlMtoPensionActBenef = Format((vlPrcPensionBenef / 100) * vlMtoPensionAct, "#0.00")
'
''I--- ABV 19/10/2007
'            If (stPolizaOri.Num_MesGar > 0) Then
''            If (vlDerechoPerGar = True) Then
''F--- ABV 19/10/2007
'                If (CDbl(Msf_BOGrilla.TextMatrix(vgI, 24)) <> 0) Then
'                    vlMtoPensionActGarBenef = Format((vlPrcPensionGarBenef / 100) * vlMtoPensionAct, "#0.00")
'                Else
'                    vlMtoPensionActGarBenef = 0
'                End If
'            Else
'                vlMtoPensionActGarBenef = 0
'            End If
'
'            'Arregla la información en la Grilla
'            Msf_BOGrilla.TextMatrix(vgI, 19) = vlMtoPensionActBenef
'            Msf_BOGrilla.TextMatrix(vgI, 24) = vlMtoPensionActGarBenef
'            'Arregla la información en la Estructura
'            stBeneficiariosOri(vgI).Mto_Pension = vlMtoPensionActBenef
'            stBeneficiariosOri(vgI).Mto_PensionGar = vlMtoPensionActGarBenef
'
'            If (Msf_BOGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BOGrilla.TextMatrix(vgI, 22) <> "10") Then
'                vlSumaPension = vlSumaPension + vlMtoPensionActBenef
'                vlSumaPensionGar = vlSumaPensionGar + vlMtoPensionActGarBenef
'            End If
'        Next
'
'        vlDiferencia = vlSumaPension - vlMtoPensionAct
'        If (vlDiferencia > 0) Then
'            For vgI = 1 To Msf_BOGrilla.Rows - 1
'                If (Msf_BOGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BOGrilla.TextMatrix(vgI, 22) <> "10") Then
'                    'Arregla la información en la Grilla
'                    Msf_BOGrilla.TextMatrix(vgI, 19) = CDbl(Msf_BOGrilla.TextMatrix(vgI, 19)) - vlDiferencia
'                    'Arregla la información en la Estructura
'                    stBeneficiariosOri(vgI).Mto_Pension = vlMtoPensionActBenef
'                    Exit For
'                End If
'            Next vgI
'        End If
'
'        If (stPolizaOri.Num_MesGar > 0) Then
'            vlDiferencia = vlSumaPensionGar - vlMtoPensionAct
'            If (vlDiferencia > 0) Then 'Or (vlDiferencia < 0) Then
'                For vgI = 1 To Msf_BOGrilla.Rows - 1
'                    If (Msf_BOGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BOGrilla.TextMatrix(vgI, 22) <> "10") Then
'
''                        vlDerechoPerGar = False
''                        If (stPolizaOri.Num_MesGar > 0) Then
''                            If (flObtenerDerechoPeriodoGarantizado(vlTipoPension, Msf_BMGrilla.TextMatrix(vgI, 7)) = True) Then
''                                vlDerechoPerGar = True
''                            End If
''                        End If
''
''                        If (vlDerechoPerGar = True) Then
'                        If (CDbl(Msf_BOGrilla.TextMatrix(vgI, 24)) <> 0) Then
'                            'Arregla la información en la Grilla
'                            Msf_BOGrilla.TextMatrix(vgI, 24) = CDbl(Msf_BOGrilla.TextMatrix(vgI, 24)) - vlDiferencia
'                            'Arregla la información en la Estructura
'                            stBeneficiariosOri(vgI).Mto_PensionGar = CDbl(Msf_BOGrilla.TextMatrix(vgI, 24)) - vlDiferencia 'vlMtoPensionActGarBenef
'                            Exit For
'                        End If
'                    End If
'                Next vgI
'            End If
'        End If
'
'        flBuscarPensionActualizadaEndosoOriginal = vlMtoPensionAct
'        Lbl_BOMtoPension = Format(vlMtoPensionAct, "#0.00")
'
'    End If

End Function

Function flBuscarPensionActualizadaEndosoModificada(iTablaPoliza As String, iFechaEfecto As String, iNumPoliza As String, inumendoso As Integer) As Double
Dim vlNumMesDif As Integer, vlNumMesGar As Integer
Dim vlFecPriPago As String, vlFecIniPenCia As String, vlFecDevengue As String, vlFecFigencia As String
Dim vlMtoPensionAct As Double
Dim vlMtoPensionActBenef As Double, vlMtoPensionActGarBenef As Double
Dim vlPrcPensionBenef As Double, vlPrcPensionGarBenef As Double
Dim vlSumaPension As Double, vlSumaPensionGar As Double
Dim vlDiferencia As Double
Dim vlFecEfectoPol As String
Dim vlCodMoneda As String, vlMtoPension As Double
Dim vlDerechoPerGar As Boolean, vlTipoPension As String
Dim vlCodTipReajuste As String, vlMtoValReajusteTri As Double, vlMtoValReajusteMen As Double
Dim vlFecEfecto, vlFecFinPerGar As String


    flBuscarPensionActualizadaEndosoModificada = 0
    
    vgSql = "SELECT num_endoso,num_poliza,cod_tippension "
    vgSql = vgSql & ",Cod_Moneda,Num_MesDif,Num_MesGar,Fec_PriPago,Fec_dev,Fec_IniPenCia"
    vgSql = vgSql & ",mto_pension ,NULL as fec_efecto  "
    vgSql = vgSql & ",cod_tipreajuste, mto_valreajustetri, mto_valreajustemen, fec_vigencia, mto_pensiongar, fec_finpergar " 'hqr 13/01/2011
    vgSql = vgSql & "FROM " & iTablaPoliza & " p WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    vgSql = vgSql & "num_endoso = " & inumendoso & " "
    Set vlRegistro = vgConexionBD.Execute(vgSql)
    If Not vlRegistro.EOF Then
        vlNumMesDif = (vlRegistro!Num_MesDif)
        vlNumMesGar = (vlRegistro!Num_MesGar)
        vlFecPriPago = (vlRegistro!Fec_PriPago)
        vlFecIniPenCia = (vlRegistro!Fec_IniPenCia)
        vlFecDevengue = (vlRegistro!fec_dev)
        vlMtoPensionAct = (vlRegistro!Mto_Pension)
        vlFecEfectoPol = IIf(IsNull(vlRegistro!FEC_EFECTO), "", vlRegistro!FEC_EFECTO)
        vlCodMoneda = vlRegistro!Cod_Moneda
        vlMtoPension = vlRegistro!Mto_Pension
        vlTipoPension = vlRegistro!Cod_TipPension
        vlCodTipReajuste = vlRegistro!Cod_TipReajuste
        vlMtoValReajusteTri = vlRegistro!Mto_ValReajusteTri
        vlMtoValReajusteMen = vlRegistro!Mto_ValReajusteMen
        vlFecFigencia = vlRegistro!Fec_Vigencia
        vlMtoPensionGar = vlRegistro!Mto_PensionGar
        vlFecFinPerGar = IIf(IsNull(vlRegistro!fec_finpergar), 0, vlRegistro!fec_finpergar)
    End If
    vlRegistro.Close
    
    If vlNumMesGar > 0 Then
        vlFecEfecto = Mid(iFechaEfecto, 7, 2) & "/" & Mid(iFechaEfecto, 5, 2) & "/" & Mid(iFechaEfecto, 1, 4)
        vlFecFinPerGar = Mid(vlFecFinPerGar, 7, 2) & "/" & Mid(vlFecFinPerGar, 5, 2) & "/" & Mid(vlFecFinPerGar, 1, 4)
            
        If CDate(vlFecEfecto) < CDate(vlFecFinPerGar) Then
            vlMtoPension = vlMtoPensionGar
        End If
    End If
    
    flBuscarPensionActualizadaEndosoModificada = vlMtoPension
    
    'If (vlCodMoneda = vgMonedaCodOfi) Then
    If (vlCodTipReajuste <> cgSINAJUSTE) Then 'hqr 13/01/2011
    
        'Determinar el Monto de la Pensión Actualizada
        If (fgBuscarRegistroPensionActualizada(iNumPoliza, iFechaEfecto, vlMtoPensionAct, vlFecEfectoPol) = False) Then
        End If
        'DETERMINA SI SE VARIO LA PENSION POR CAUSA DE INCLUCION DE BENEF
        vgSql = " select max(fec_efecto) as fec_devengenew from pp_tmae_endoso"
        vgSql = vgSql & " Where num_poliza = '" & iNumPoliza & "' "
        vgSql = vgSql & " and cod_cauendoso in ('01', '02', '05', '13')"
        Set vlRegistro = vgConexionBD.Execute(vgSql)
        If Not vlRegistro.EOF Then
            vlFecDevengue = IIf(IsNull(vlRegistro!fec_devengenew) = True, vlFecDevengue, vlRegistro!fec_devengenew) '(vlRegistro!fec_devengenew)
        End If
        vlRegistro.Close
    
        'Actualizar la Pensión a la Fecha de Efecto
        vlMtoPensionAct = fgCalcularPensionActualizada(vlCodMoneda, vlNumMesDif, vlFecPriPago, vlFecIniPenCia, vlFecEfectoPol, vlFecDevengue, vlMtoPensionAct, iFechaEfecto, vlCodTipReajuste, vlMtoValReajusteTri, vlMtoValReajusteMen, vlFecFigencia) 'hqr 12/01/2011
        
'1. Corregir Póliza
        'Corregir la información de la Pensión de Referencia en el Objeto que recibe la Pensión
        'Lbl_EndMtoPensionOrig = Format(vlMtoPensionAct, "#0.00")
        'Corregir la información de la Pensión de Referencia en la Estructura que recibe la Pensión
        stPolizaMod.Mto_Pension = vlMtoPensionAct
        If (stPolizaMod.Num_MesGar > 0) Then
            stPolizaMod.Mto_PensionGar = vlMtoPensionAct
        Else
            stPolizaMod.Mto_PensionGar = 0
        End If
        
'2. Corregir Beneficiarios
        vlSumaPension = 0
        vlSumaPensionGar = 0
        vlDiferencia = 0
        
        'Corregir la información de las Pensiones de los Beneficiarios en la Grilla
        For vgI = 1 To Msf_BMGrilla.rows - 1
            
            vlDerechoPerGar = False
            If (stPolizaOri.Num_MesGar > 0) Then
                If (flObtenerDerechoPeriodoGarantizado(vlTipoPension, Msf_BMGrilla.TextMatrix(vgI, 7)) = True) Then
                    vlDerechoPerGar = True
                End If
            End If
            
            vlPrcPensionBenef = Msf_BMGrilla.TextMatrix(vgI, 20)
            vlPrcPensionGarBenef = Msf_BMGrilla.TextMatrix(vgI, 31)
            vlMtoPensionActBenef = Format((vlPrcPensionBenef / 100) * vlMtoPensionAct, "#0.00")
'I--- ABV 19/10/2007
'            If (stPolizaOri.Num_MesGar > 0) Then
            If (vlDerechoPerGar = True) Then
'F--- ABV 19/10/2007
                vlMtoPensionActGarBenef = Format((vlPrcPensionGarBenef / 100) * vlMtoPensionAct, "#0.00")
            Else
                vlMtoPensionActGarBenef = 0
            End If
            'Arregla la información en la Grilla
            Msf_BMGrilla.TextMatrix(vgI, 19) = vlMtoPensionActBenef
            Msf_BMGrilla.TextMatrix(vgI, 24) = vlMtoPensionActGarBenef
            'Arregla la información en la Estructura
            stBeneficiariosMod(vgI).Mto_Pension = vlMtoPensionActBenef
            stBeneficiariosMod(vgI).Mto_PensionGar = vlMtoPensionActGarBenef
            
            If (Msf_BMGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BMGrilla.TextMatrix(vgI, 22) <> "10") Then
                vlSumaPension = vlSumaPension + vlMtoPensionActBenef
                vlSumaPensionGar = vlSumaPensionGar + vlMtoPensionActGarBenef
            End If
        Next
        
        vlDiferencia = vlSumaPension - vlMtoPensionAct
        If (vlDiferencia > 0) Then
            For vgI = 1 To Msf_BMGrilla.rows - 1
                If (Msf_BMGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BMGrilla.TextMatrix(vgI, 22) <> "10") Then
                    'Arregla la información en la Grilla
                    Msf_BMGrilla.TextMatrix(vgI, 19) = CDbl(Msf_BMGrilla.TextMatrix(vgI, 19)) - vlDiferencia
                    'Arregla la información en la Estructura
                    stBeneficiariosMod(vgI).Mto_Pension = CDbl(Msf_BMGrilla.TextMatrix(vgI, 19)) - vlDiferencia 'vlMtoPensionActBenef
                    Exit For
                End If
            Next vgI
        End If
        
        If (stPolizaOri.Num_MesGar > 0) Then
            vlDiferencia = vlSumaPensionGar - vlMtoPensionAct
            If (vlDiferencia > 0) Then 'Or (vlDiferencia < 0) Then
                For vgI = 1 To Msf_BMGrilla.rows - 1
                    If (Msf_BMGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BMGrilla.TextMatrix(vgI, 22) <> "10") Then

                        vlDerechoPerGar = False
                        If (stPolizaOri.Num_MesGar > 0) Then
                            If (flObtenerDerechoPeriodoGarantizado(vlTipoPension, Msf_BMGrilla.TextMatrix(vgI, 7)) = True) Then
                                vlDerechoPerGar = True
                            End If
                        End If

                        If (vlDerechoPerGar = True) Then
                            'Arregla la información en la Grilla
                            Msf_BMGrilla.TextMatrix(vgI, 24) = CDbl(Msf_BMGrilla.TextMatrix(vgI, 24)) - vlDiferencia
                            'Arregla la información en la Estructura
                            stBeneficiariosMod(vgI).Mto_PensionGar = CDbl(Msf_BMGrilla.TextMatrix(vgI, 24)) - vlDiferencia 'vlMtoPensionActGarBenef
                            Exit For
                        End If
                    End If
                Next vgI
            End If
        End If

        flBuscarPensionActualizadaEndosoModificada = vlMtoPensionAct
        Lbl_BMMtoPension = Format(vlMtoPensionAct, "#0.00")
        'txt_EndMtoPensionCalc = Format(vlMtoPensionAct, "#0.00")
        'Lbl_EndMtoPensionCalc = Format(vlMtoPensionAct, "#0.00")
    End If

End Function

Function flObtenerDerechoPeriodoGarantizado(iTipoPension As String, iCodPar As String) As Boolean
Dim vlI As Integer
    
    flObtenerDerechoPeriodoGarantizado = False
    
    vgPalabra = iTipoPension
    
    vlI = InStr(1, clPensionInvVejez, vgPalabra)
    If (vlI <> 0) Then
        'No tiene Derecho si es un caso de Invalidez o Vejez
        flObtenerDerechoPeriodoGarantizado = True
    End If
    
    vlI = InStr(1, clPensionSobOrigen, vgPalabra)
    If (vlI <> 0) Then
'I--- ABV 17/11/2007 ---
'        'Valida que sea un caso de Sobrevivencia por Origen
'        'Se supone que la Cónyuge o Madre es la única que Garantiza su pensión
'        vgPalabraAux = iCodPar
'
'        vgX = InStr(1, clParConyugeMadre, vgPalabraAux)
'        If (vgX <> 0) Then
'            'No tiene Derecho a Pago de Periodo Garantizado
'            flObtenerDerechoPeriodoGarantizado = False
'        Else
'            'Si tiene Derecho a Periodo Garantizado
'            flObtenerDerechoPeriodoGarantizado = True
'        End If
        flObtenerDerechoPeriodoGarantizado = True
'I--- ABV 17/11/2007 ---
    End If
    
    vlI = InStr(1, clPensionSobTransf, vgPalabra)
    If (vlI <> 0) Then
        'Valida que sea un caso que cambio de estado a una Sobrevivencia de ..
        flObtenerDerechoPeriodoGarantizado = True
    End If
    
End Function

'RRR 11/04/2013'

Function flCargaDatosBeneficiariosModDatGen(iPosicion As Integer)
On Error GoTo Err_flCargaDatosBeneficiariosMod
    
    If iPosicion <> 1 Then
        txtCusspBen.Enabled = False
        txtCusspBen.BackColor = &H80000000
        txtFecdevBen.Enabled = False
        txtFecdevBen.BackColor = &H80000000
        cmbAfpBen.Enabled = False
        cmbTipoPreBen.Enabled = False
   
        
    Else
        txtCusspBen.Enabled = True
        txtCusspBen.BackColor = &H80000004
        txtFecdevBen.Enabled = True
        txtFecdevBen.BackColor = &H80000004
        cmbAfpBen.Enabled = True
        cmbTipoPreBen.Enabled = True
    End If
    
    
    vgSql = "select gls_dirben, cod_direccion, gls_fonoben, gls_correoben from pp_tmae_ben where num_poliza='" & Txt_PenPoliza & "' "
    vgSql = vgSql & " and num_endoso=" & Lbl_End & " and num_orden=" & iPosicion & ""
    Set vlRegistro = vgConexionBD.Execute(vgSql)
    If Not vlRegistro.EOF Then
        txtTelBen = IIf(IsNull(vlRegistro!Gls_FonoBen) = True, "", vlRegistro!Gls_FonoBen)
        txt_dirben = vlRegistro!Gls_DirBen
        txtcodDirBen = vlRegistro!Cod_Direccion
        txtBenEmail = IIf(IsNull(vlRegistro!Gls_CorreoBen) = True, "", vlRegistro!Gls_CorreoBen)
    End If
    'vlRegistro.Close

'Implementacion GobiernoDeDatos(se agregaron unos campos necesarios para la envia de data al servicio)
 Msf_BMGrilla.Col = 32
    txtcodDirBen = Trim(Msf_BMGrilla.Text)
    
    vgSql = "select gls_comuna || '/' || gls_provincia || '/' || gls_region as distrito "
    '15052019_
    vgSql = vgSql & ",c.cod_Region as cod_Region ,b.cod_provincia as cod_provincia, a.cod_comuna as cod_comuna "
    vgSql = vgSql & " from ma_tpar_comuna a join ma_tpar_provincia b on a.cod_provincia=b.cod_provincia"
    vgSql = vgSql & " join ma_tpar_region c on a.cod_region=c.cod_region"
    vgSql = vgSql & " Where Cod_Direccion = '" & txtcodDirBen & "'"
    Set vlRegistro = vgConexionBD.Execute(vgSql)
    If Not vlRegistro.EOF Then
        txtDistritoBen.Text = vlRegistro!distrito
      '____
        codComuna = vlRegistro!cod_comuna
        codRegion = vlRegistro!cod_region
        codProvincia = vlRegistro!cod_provincia
'Fin Implementacion GobiernoDeDatos()_
        
        'Lbl_Distrito.Refresh
    End If
    'vlRegistro.Close
    'Posicionar Combos
    Msf_BMGrilla.row = iPosicion
    Msf_BMGrilla.Col = 7
    Cmb_BMPar.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMPar)
    Msf_BMGrilla.Col = 8
    Cmb_BMGrupFam.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMGrupFam)
    Msf_BMGrilla.Col = 9
    Cmb_BMSexo.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), cmbSexoBen)
    Msf_BMGrilla.Col = 10
    Cmb_BMSitInv.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMSitInv)
    Msf_BMGrilla.Col = 15
'    Cmb_BMCauInv.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMCauInv)
    Lbl_BMCauInv = Trim(Msf_BMGrilla.Text) & " - " & Trim(flBuscarGlosaCauInv(Trim(Msf_BMGrilla.Text)))
    Msf_BMGrilla.Col = 11
    'Cmb_BMDerPen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMDerPen)
    'Mostrar Datos
    Msf_BMGrilla.Col = 0
    Lbl_BMNumOrd = Msf_BMGrilla.Text
    
    Msf_BMGrilla.Col = 1
''    Cmb_BMNumIdent = (Msf_BMGrilla.Text)
    Cmb_BMNumIdent.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Mid(Msf_BMGrilla.Text, 1, (InStr(1, Msf_BMGrilla.Text, "-") - 1))), Cmb_BMNumIdent)

    Msf_BMGrilla.Col = 2
    Txt_BMNumIden = Trim(Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 3
    txtNomben = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 4
    txtNomsegBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 5
    txtApepatBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 6
    txtApematBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 18
       
    'I--- ABV 16/04/2005 ---
    'Las Fechas se encuentran formateadas de acuerdo a la configuración del PC
    'Por ende solo se deben traspasar las Fechas directamente
    If (Msf_BMGrilla.Text) = "" Then
       Txt_BMFecInv = ""
    Else
        Txt_BMFecInv = Trim(Msf_BMGrilla.Text)
        'Txt_BMFecInv = DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    End If
    Msf_BMGrilla.Col = 16
    'txtFecnacBen = Trim(Msf_BMGrilla.Text)
    Txt_BMFecNac = Trim(Msf_BMGrilla.Text) 'DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    
    
    Lbl_Distrito = ""
    
    
    
    
    Msf_BMGrilla.Col = 21
    If (Msf_BMGrilla.Text) = "" Then
       Txt_BMFecFall = ""
    Else
        Txt_BMFecFall = Trim(Msf_BMGrilla.Text)
        'Txt_BMFecFall = DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    End If
    
    Msf_BMGrilla.Col = 11
    cmbExcluesion.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), cmbExcluesion)
    
    Msf_BMGrilla.Col = 22
    Cmb_BMDerPen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_BMDerPen)

    Msf_BMGrilla.Col = 17
    If (Msf_BMGrilla.Text) = "" Then
       Lbl_BMFecNHM = ""
    Else
        Lbl_BMFecNHM = Trim(Msf_BMGrilla.Text)
        'Lbl_BMFecNHM = DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    End If
    Msf_BMGrilla.Col = 12
    Lbl_BMDerAcrecer = Trim(Msf_BMGrilla.Text)
    
    
    
    Msf_BMGrilla.Col = 20
    lbl_BMPrc = Format(Msf_BMGrilla.Text, "##0.00")
    txt_BMPrc = Format(Msf_BMGrilla.Text, "##0.00")
    
    Msf_BMGrilla.Col = 30
    lbl_BMPrcGar = Format(Msf_BMGrilla.Text, "##0.00")
    txt_BMPrcGar = Format(Msf_BMGrilla.Text, "##0.00")
    
    Msf_BMGrilla.Col = 31
    Lbl_BMPrcLegal = Format(Msf_BMGrilla.Text, "##0.00")
    'txt_BMPrcGar = Format(Msf_BMGrilla.Text, "##0.00")
    
    Msf_BMGrilla.Col = 19
    Lbl_BMMtoPension = Format(Msf_BMGrilla.Text, "###,###,##0.00")
    txt_BMMtoPension = Format(Msf_BMGrilla.Text, "###,###,##0.00")
    

    Msf_BMGrilla.Col = 13
    vlNumPoliza = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 14
    vlNumEndoso = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 22
    vlCodDerpen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 23
    vlCodMotReqPen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 24
    vlMtoPensionGar = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 25
    vlCodCauSusBen = Trim(Msf_BMGrilla.Text)
    
    'vlNumOrden = vlNumOrden
    
    Msf_BMGrilla.Col = 26
    vlFecSusBen = Trim(Msf_BMGrilla.Text)

    Msf_BMGrilla.Col = 27
    vlFecIniPagoPen = Trim(Msf_BMGrilla.Text)

    Msf_BMGrilla.Col = 28
    vlFecTerPagoPenGar = Trim(Msf_BMGrilla.Text)

    Msf_BMGrilla.Col = 29
    If (Msf_BMGrilla.Text) = "" Then
        Txt_BMFecMat = ""
    Else
        Txt_BMFecMat = Trim(Msf_BMGrilla.Text)
        'Txt_BMFecMat = DateSerial(Mid((Msf_BMGrilla.Text), 1, 4), Mid((Msf_BMGrilla.Text), 5, 2), Mid((Msf_BMGrilla.Text), 7, 2))
    End If
    
    'I--- ABV 20/04/2005 ---
    'Call flHabilitarPenGar
'    If flObtenerDerechoPeriodoGarantizado(fgObtenerCodigo_TextoCompuesto(Cmb_PMTipPen), fgObtenerCodigo_TextoCompuesto(Cmb_BMPar)) = True Then
'        Txt_BMMtoPensionGar.Enabled = True
'    Else
'        Txt_BMMtoPensionGar.Enabled = False
'    End If
    'F--- ABV 20/04/2005 ---

    If CInt(Txt_PMMesGar.Text) <> 0 Then
        Txt_BMMtoPensionGar.Enabled = True
        txt_BMPrcGar.Enabled = True
    Else
        Txt_BMMtoPensionGar.Enabled = False
        txt_BMPrcGar.Enabled = False
    End If


    Msf_BMGrilla.Col = 24
    vlMtoPensionGar = IIf(Trim(Msf_BMGrilla.Text) = "", 0, Trim(Msf_BMGrilla.Text))
    Txt_BMMtoPensionGar = Format(vlMtoPensionGar, "#,#0.00")
    'F--- ABV 19/04/2005 ---

    'Msf_BMGrilla.Col = 30
    'vlPrcPensionGar = Trim(Msf_BMGrilla.Text)
    
    'Msf_BMGrilla.Col = 31
    'vlPrcPensionLeg = Trim(Msf_BMGrilla.Text)

    Msf_BMGrilla.Col = 32
    txtcodDirBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 33
    txt_dirben = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 34
    txtTelBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 35
    txtBenEmail = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 36
    txtTelfon2 = Trim(Msf_BMGrilla.Text)
    
    'Para bancos RRR
    
'    Msf_BMGrilla.Col = 37
'    If Len(Msf_BMGrilla.Text) <> 0 Then cmbBancoCtaBen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), cmbBancoCtaBen)
'    Msf_BMGrilla.Col = 38
'    If Len(Msf_BMGrilla.Text) <> 0 Then cmbTipoCtaBen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), cmbTipoCtaBen)
'    Msf_BMGrilla.Col = 39
'    If Len(Msf_BMGrilla.Text) <> 0 Then cmbMonctaBen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), cmbMonctaBen)
    Msf_BMGrilla.Col = 40
'    txtNumctaBen = Trim(Msf_BMGrilla.Text)
'    'mvg 20170904
'    Msf_BMGrilla.Col = 41
'    chkEnvioBolElec.Value = IIf(Trim(Msf_BMGrilla.Text) = "N", 0, 1)
    
'    'INICIO GCP-FRACTAL 20190104
'     Msf_BMGrilla.Col = 42
'     txt_CCI = Trim(Msf_BMGrilla.Text)

    Msf_BMGrilla.Col = 43
    If Len(Msf_BMGrilla.Text) <> 0 Then Cmb_ViaPago.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_ViaPago)

    '09  SOBREVIVENCIA DE JUB. LEGAL
    '10  SOBREVIVENCIA DE JUB. ANTICIPADA
    '04  JUBILACION LEGAL - -habiltada
    '05  JUBILACION ANTICIPADA - -habiltada
    If Mid(Cmb_EndCauEnd, 1, 2) = "28" And Mid(Cmb_EndTipoEnd, 1, 1) = "O" And _
        (Mid(vlTipoPen, 1, 3) = 9 Or Mid(vlTipoPen, 1, 3) = 10 Or Mid(vlTipoPen, 1, 3) = 4 Or Mid(vlTipoPen, 1, 3) = 5) Then
        Msf_BMGrilla.Col = 49 'COD_MODTIPOCUENTA_MANC
        If Len(Msf_BMGrilla.Text) <> 0 Then Cmb_ModTipCta.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_ModTipCta)
        
        Msf_BMGrilla.Col = 50 'COD_TIPODOC_MANC
        If Len(Msf_BMGrilla.Text) <> 0 Then Cmb_TipDoc.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_TipDoc)
        
        Msf_BMGrilla.Col = 51 'NUM_DOC_MANC
        If Len(Msf_BMGrilla.Text) <> 0 Then
            Txt_NroDocSecundario = Trim(Msf_BMGrilla.Text)
        Else
            Txt_NroDocSecundario.Text = ""
        End If
        
        Msf_BMGrilla.Col = 52 'NOMBRE_MANC
        If Len(Msf_BMGrilla.Text) <> 0 Then
            Txt_NombreSecundario = Trim(Msf_BMGrilla.Text)
        Else
            Txt_NombreSecundario.Text = ""
        End If
        
        Msf_BMGrilla.Col = 53 'APELLIDO_MANC
        If Len(Msf_BMGrilla.Text) <> 0 Then
            Txt_ApellidosSecundario = Trim(Msf_BMGrilla.Text)
        Else
            Txt_ApellidosSecundario.Text = ""
        End If
    End If
     
    'Cmb_ViaPago.Clear
    fgComboGeneral vgCodTabla_ViaPago, Cmb_ViaPago
      
    Dim VPosCod As Integer
    Dim vTip_pension As String

    VPosCod = InStr(1, Lbl_POTipPen, "-")
    vTip_pension = Trim(Mid(Lbl_POTipPen, 1, VPosCod - 1))

    If (vTip_pension = "04" Or vTip_pension = "05" Or vTip_pension = "09" Or vTip_pension = "10") Then
       'Se Remueve el via pago TRANSFERENCIA AFP
       Call RemoveItemCombo(Cmb_ViaPago, "TRANSFERENCIA AFP")

    Else
       Call RemoveItemCombo(Cmb_ViaPago, "DEPOSITO EN CUENTA")
    End If
      
    Msf_BMGrilla.Col = 43
    If Len(Msf_BMGrilla.Text) <> 0 Then Cmb_ViaPago.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_ViaPago)
      
    Call VerificaViapago
    
       
    If Cmb_Sucursal.Enabled = True Then
       Msf_BMGrilla.Col = 44
        If Len(Msf_BMGrilla.Text) <> 0 Then Cmb_Sucursal.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), Cmb_Sucursal)
    End If
    Msf_BMGrilla.Col = 38
    If Len(Msf_BMGrilla.Text) <> 0 Then cmbTipoCtaBen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), cmbTipoCtaBen)
    Msf_BMGrilla.Col = 39
    If Len(Msf_BMGrilla.Text) <> 0 Then cmbMonctaBen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), cmbMonctaBen)
    Msf_BMGrilla.Col = 37
    If Len(Msf_BMGrilla.Text) <> 0 Then cmbBancoCtaBen.ListIndex = fgBuscarPosicionCodigoCombo(Trim(Msf_BMGrilla.Text), cmbBancoCtaBen)
    Msf_BMGrilla.Col = 40
    txtNumctaBen = Trim(Msf_BMGrilla.Text)
    'mvg 20170904
    Msf_BMGrilla.Col = 41
    chkEnvioBolElec.Value = IIf(Trim(Msf_BMGrilla.Text) = "N", 0, 1)
    'INICIO GCP-FRACTAL 20190104
    Msf_BMGrilla.Col = 42
    txt_CCI = Trim(Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 45
    chkConTratDatos_Ben.Value = IIf(Msf_BMGrilla.Text = "0", 0, 1)
    
    Msf_BMGrilla.Col = 46
    chkConUsoDatosCom_Ben.Value = IIf(Msf_BMGrilla.Text = "0", 0, 1)
    
     
    'FIN GCP-FRACTAL 20190104
  
    
Exit Function
Err_flCargaDatosBeneficiariosMod:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

 'INICIO GCP-FRACTAL 10052019
 
 Sub RemoveItemCombo(ByRef gCombo As ComboBox, ByVal Item As String)
        Dim i As Integer

        For i = gCombo.ListCount - 1 To 0 Step -1
            gCombo.ListIndex = i
            If InStr(1, gCombo.Text, Item) > 0 Then
              gCombo.RemoveItem i
            End If
        Next

 End Sub
 'FIN GCP-FRACTAL 10052019
Private Sub VerificaViapago()

       
   On Error GoTo Err_CmbViaPagoClick

If Cmb_ViaPago.Enabled = True Then

    vlNumero = InStr(Cmb_ViaPago.Text, "-")
    vlOpcion = Trim(Mid(Cmb_ViaPago.Text, 1, vlNumero - 1))
    
'Opción 01 = Via de Pago CAJA
    If vlSw = False Then
       
        If vlOpcion = "00" Or vlOpcion = "05" Or vlOpcion = "08" Then
            Cmb_Sucursal.Enabled = False
            cmbTipoCtaBen.Enabled = False
            cmbBancoCtaBen.Enabled = False
            cmbMonctaBen.Enabled = False
            txtNumctaBen.Enabled = False
            txt_CCI.Enabled = False
            Cmb_Sucursal.ListIndex = 0
            cmbTipoCtaBen.ListIndex = 0
            cmbBancoCtaBen.ListIndex = 0
            txtNumctaBen.Text = ""
            txt_CCI.Text = ""
        Else
            If vlOpcion = "01" Or vlOpcion = "04" Then
'                If (vlOpcion = "04") Then
'                    vgTipoSucursal = cgTipoSucursalAfp
'                Else
'                    vgTipoSucursal = cgTipoSucursalSuc
'                End If
                'fgComboSucursal Cmb_Sucursal, vgTipoSucursal
                fgComboSucursal Cmb_Sucursal, "A"
                
                Cmb_Sucursal.Enabled = True
                cmbTipoCtaBen.Enabled = False
                cmbBancoCtaBen.Enabled = False
                cmbMonctaBen.Enabled = False
                txtNumctaBen.Enabled = False
                cmbTipoCtaBen.ListIndex = 0
                cmbBancoCtaBen.ListIndex = 0
                If (vlOpcion = "04") Then
                  '  vgPalabra = fgObtenerCodigo_TextoCompuesto(vlAfp)
                  '  Call fgBuscarPosicionCodigoCombo(vgPalabra, Cmb_Sucursal)
                End If
               ' txtNumctaBen.Text = ""
            Else
                If (vlOpcion = "02") Then
                   Call fgComboGeneral(vgCodTabla_Bco, cmbBancoCtaBen)
                   Cmb_Sucursal.Enabled = False
                   cmbTipoCtaBen.Enabled = True
                   cmbBancoCtaBen.Enabled = True
                   cmbMonctaBen.Enabled = True
                   txtNumctaBen.Enabled = True
                   txt_CCI.Enabled = True
                   Cmb_Sucursal.ListIndex = 0
                   
'                   Txt_NumCuenta.Text = ""

                ElseIf (vlOpcion = "07") Then
                   Call fgComboGeneral(vgCodTabla_Bco, cmbBancoCtaBen)
                   Cmb_Sucursal.Enabled = False
                   cmbTipoCtaBen.Enabled = True
                   cmbBancoCtaBen.Enabled = True
                   cmbMonctaBen.Enabled = True
                   txtNumctaBen.Enabled = True
                   txt_CCI.Enabled = True
                   Cmb_Sucursal.ListIndex = 0
'                   Txt_NumCuenta.Text = ""
                ElseIf (vlOpcion = "06") Then
                    Cmb_Sucursal.Enabled = False
                    cmbTipoCtaBen.Enabled = False
                    Call DejarBcoPrinicipales(cmbBancoCtaBen)
                    cmbBancoCtaBen.Enabled = True
                    cmbMonctaBen.Enabled = False
                    cmbMonctaBen.ListIndex = fgBuscarPosicionCodigoCombo(Lbl_MonPension(2).Caption, cmbMonctaBen)
                    txtNumctaBen.Enabled = False
                    Cmb_Sucursal.ListIndex = 0
                    cmbTipoCtaBen.ListIndex = 0
                    cmbBancoCtaBen.ListIndex = 0
                    txtNumctaBen.Text = ""
'                Else
'                    Cmb_Sucursal.Enabled = False
'                    cmbTipoCtaBen.Enabled = False
'                    cmbBancoCtaBen.Enabled = False
'                    cmbMonctaBen.Enabled = False
'                    txtNumctaBen.Enabled = False
'                    Cmb_Sucursal.ListIndex = 0
'                    cmbTipoCtaBen.ListIndex = 0
'                    cmbBancoCtaBen.ListIndex = 0
'                    txtNumctaBen.Text = ""
'                    txt_CCI.Text = ""
                End If
            End If
        End If
    End If
End If
    
Exit Sub
Err_CmbViaPagoClick:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select

End Sub




Function flRecibeDireccion(iNomDepartamento As String, iNomProvincia As String, iNomDistrito As String, iCodDir As String)
'FUNCION QUE RECIBE LOS DATOS DEL FORMULARIO DE BUSQUEDA de Dirección
    
'    Lbl_Departamento = Trim(iNomDepartamento)
'    Lbl_Provincia = Trim(iNomProvincia)
'    Lbl_Distrito = Trim(iNomDistrito)
'    vlCodDireccion = iCodDir
'    vgCodDireccion = iCodDir

    Dim vStringDep As String
    Dim vStringProv As String
    Dim vStringDis As String
    Dim vlCodDir As String

    vStringDep = Trim(iNomDepartamento)
    vStringProv = Trim(iNomProvincia)
    vStringDis = Trim(iNomDistrito)
    vlCodDir = iCodDir

    txtcodDirBen = vlCodDir
    txtDistritoBen.Text = vStringDis & "/" & vStringProv & "/" & vStringDep

End Function


Function flBuscarPensionBase(iTablaPoliza As String, iFechaEfecto As String, iNumPoliza As String, inumendoso As Integer, opt As String) As Double
Dim vlNumMesDif As Integer, vlNumMesGar As Integer
Dim vlFecPriPago As String, vlFecIniPenCia As String, vlFecDevengue As String, vlFecVigencia As String
Dim vlMtoPensionAct As Double
Dim vlMtoPensionActBenef As Double, vlMtoPensionActGarBenef As Double
Dim vlPrcPensionBenef As Double, vlPrcPensionGarBenef As Double
Dim vlSumaPension As Double, vlSumaPensionGar As Double
Dim vlDiferencia As Double
Dim vlFecEfectoPol As String
Dim vlCodMoneda As String, vlMtoPension As Double
Dim vlDerechoPerGar As Boolean, vlTipoPension As String
Dim vlCodTipReajuste As String, vlMtoValReajusteTri As Double, vlMtoValReajusteMen As Double
Dim vlEndoAct As New ADODB.Recordset
Dim vlexisteA As Integer

    vlexisteA = 0

    vgSql = "select max(num_endoso) + 1 as num_endoso from pp_tmae_endoso where num_poliza= '" & iNumPoliza & "' and cod_tipendoso='A'"
    Set vlEndoAct = vgConexionBD.Execute(vgSql)
    If Not vlEndoAct.EOF Then
        vlexisteA = IIf(IsNull(vlEndoAct!num_endoso), 0, vlEndoAct!num_endoso)
    End If

    flBuscarPensionBase = 0
    
    vgSql = "SELECT num_endoso,num_poliza,cod_tippension "
    vgSql = vgSql & ",Cod_Moneda,Num_MesDif,Num_MesGar,Fec_PriPago,Fec_dev,Fec_IniPenCia"
    vgSql = vgSql & ",mto_pension ,NULL as fec_efecto  "
    vgSql = vgSql & ",cod_tipreajuste, mto_valreajustetri, mto_valreajustemen, fec_vigencia, mto_pensiongar, fec_finpergar " 'hqr 13/01/2011
    vgSql = vgSql & "FROM " & iTablaPoliza & " p WHERE "
    vgSql = vgSql & "num_poliza = '" & iNumPoliza & "' AND "
    If vlexisteA > 0 Then
        vgSql = vgSql & "num_endoso = " & vlexisteA & " "
    Else
        vgSql = vgSql & "num_endoso = " & inumendoso & " "
    End If
    
    Set vlRegistro = vgConexionBD.Execute(vgSql)
    If Not vlRegistro.EOF Then
        vlMtoPensionAct = vlRegistro!Mto_Pension
        vlMtoPensionGar = vlRegistro!Mto_PensionGar
    End If
    vlRegistro.Close
    
    If opt = "O" Then
         flBuscarPensionBase = vlMtoPensionAct
    Else
         flBuscarPensionBase = vlMtoPensionGar
    End If
    
'    If vlNumMesGar > 0 Then
'        vlFecEfecto = Mid(iFechaEfecto, 7, 2) & "/" & Mid(iFechaEfecto, 5, 2) & "/" & Mid(iFechaEfecto, 1, 4)
'        vlFecFinPerGar = Mid(vlFecFinPerGar, 7, 2) & "/" & Mid(vlFecFinPerGar, 5, 2) & "/" & Mid(vlFecFinPerGar, 1, 4)
'
'        If CDate(vlFecEfecto) < CDate(vlFecFinPerGar) Then
'            vlMtoPension = vlMtoPensionGar
'        End If
'    End If
'
    
   
    
    'If (vlCodMoneda = vgMonedaCodOfi) Then
'    If (vlCodTipReajuste <> cgSINAJUSTE) Then 'hqr 13/01/2011
'
'        'Determinar el Monto de la Pensión Actualizada
'        If (fgBuscarRegistroPensionActualizada(iNumPoliza, iFechaEfecto, vlMtoPensionAct, vlFecEfectoPol) = False) Then
'        End If
'
'        'Actualizar la Pensión a la Fecha de Efecto
'        vlMtoPensionAct = fgCalcularPensionActualizada(vlCodMoneda, vlNumMesDif, vlFecPriPago, vlFecIniPenCia, vlFecEfectoPol, vlFecDevengue, vlMtoPensionAct, iFechaEfecto, vlCodTipReajuste, vlMtoValReajusteTri, vlMtoValReajusteMen, vlFecVigencia) 'hqr 12/01/2011 Pendiente ABV agregar los datos de los dos ultimos parametros
'
''1. Corregir Póliza
'        'Corregir la información de la Pensión de Referencia en el Objeto que recibe la Pensión
'        Lbl_POMtoPen = Format(vlMtoPensionAct, "#0.00")
'        'Corregir la información de la Pensión de Referencia en la Estructura que recibe la Pensión
'        stPolizaOri.Mto_Pension = vlMtoPensionAct
'        If (stPolizaOri.Num_MesGar > 0) Then
'            stPolizaOri.Mto_PensionGar = vlMtoPensionAct
'        Else
'            stPolizaOri.Mto_PensionGar = 0
'        End If
'
''2. Corregir Beneficiarios
'        vlSumaPension = 0
'        vlSumaPensionGar = 0
'        vlDiferencia = 0
'
'        'Corregir la información de las Pensiones de los Beneficiarios en la Grilla
'        For vgI = 1 To Msf_BOGrilla.Rows - 1
'
'            vlDerechoPerGar = False
'            If (stPolizaOri.Num_MesGar > 0) Then
'                If (flObtenerDerechoPeriodoGarantizado(vlTipoPension, Msf_BOGrilla.TextMatrix(vgI, 7)) = True) Then
'                    vlDerechoPerGar = True
'                End If
'            End If
'
'            vlPrcPensionBenef = Msf_BOGrilla.TextMatrix(vgI, 20)
'            vlPrcPensionGarBenef = Msf_BOGrilla.TextMatrix(vgI, 31)
'            vlMtoPensionActBenef = Format((vlPrcPensionBenef / 100) * vlMtoPensionAct, "#0.00")
'
''I--- ABV 19/10/2007
'            If (stPolizaOri.Num_MesGar > 0) Then
''            If (vlDerechoPerGar = True) Then
''F--- ABV 19/10/2007
'                If (CDbl(Msf_BOGrilla.TextMatrix(vgI, 24)) <> 0) Then
'                    vlMtoPensionActGarBenef = Format((vlPrcPensionGarBenef / 100) * vlMtoPensionAct, "#0.00")
'                Else
'                    vlMtoPensionActGarBenef = 0
'                End If
'            Else
'                vlMtoPensionActGarBenef = 0
'            End If
'
'            'Arregla la información en la Grilla
'            Msf_BOGrilla.TextMatrix(vgI, 19) = vlMtoPensionActBenef
'            Msf_BOGrilla.TextMatrix(vgI, 24) = vlMtoPensionActGarBenef
'            'Arregla la información en la Estructura
'            stBeneficiariosOri(vgI).Mto_Pension = vlMtoPensionActBenef
'            stBeneficiariosOri(vgI).Mto_PensionGar = vlMtoPensionActGarBenef
'
'            If (Msf_BOGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BOGrilla.TextMatrix(vgI, 22) <> "10") Then
'                vlSumaPension = vlSumaPension + vlMtoPensionActBenef
'                vlSumaPensionGar = vlSumaPensionGar + vlMtoPensionActGarBenef
'            End If
'        Next
'
'        vlDiferencia = vlSumaPension - vlMtoPensionAct
'        If (vlDiferencia > 0) Then
'            For vgI = 1 To Msf_BOGrilla.Rows - 1
'                If (Msf_BOGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BOGrilla.TextMatrix(vgI, 22) <> "10") Then
'                    'Arregla la información en la Grilla
'                    Msf_BOGrilla.TextMatrix(vgI, 19) = CDbl(Msf_BOGrilla.TextMatrix(vgI, 19)) - vlDiferencia
'                    'Arregla la información en la Estructura
'                    stBeneficiariosOri(vgI).Mto_Pension = vlMtoPensionActBenef
'                    Exit For
'                End If
'            Next vgI
'        End If
'
'        If (stPolizaOri.Num_MesGar > 0) Then
'            vlDiferencia = vlSumaPensionGar - vlMtoPensionAct
'            If (vlDiferencia > 0) Then 'Or (vlDiferencia < 0) Then
'                For vgI = 1 To Msf_BOGrilla.Rows - 1
'                    If (Msf_BOGrilla.TextMatrix(vgI, 7) <> "99") And (Msf_BOGrilla.TextMatrix(vgI, 22) <> "10") Then
'
''                        vlDerechoPerGar = False
''                        If (stPolizaOri.Num_MesGar > 0) Then
''                            If (flObtenerDerechoPeriodoGarantizado(vlTipoPension, Msf_BMGrilla.TextMatrix(vgI, 7)) = True) Then
''                                vlDerechoPerGar = True
''                            End If
''                        End If
''
''                        If (vlDerechoPerGar = True) Then
'                        If (CDbl(Msf_BOGrilla.TextMatrix(vgI, 24)) <> 0) Then
'                            'Arregla la información en la Grilla
'                            Msf_BOGrilla.TextMatrix(vgI, 24) = CDbl(Msf_BOGrilla.TextMatrix(vgI, 24)) - vlDiferencia
'                            'Arregla la información en la Estructura
'                            stBeneficiariosOri(vgI).Mto_PensionGar = CDbl(Msf_BOGrilla.TextMatrix(vgI, 24)) - vlDiferencia 'vlMtoPensionActGarBenef
'                            Exit For
'                        End If
'                    End If
'                Next vgI
'            End If
'        End If
'
'        flBuscarPensionActualizadaEndosoOriginal = vlMtoPensionAct
'        Lbl_BOMtoPension = Format(vlMtoPensionAct, "#0.00")
'
'    End If

End Function

Function flBuscarPensionActual(iFechaEfecto As String, iNumPoliza As String, inumendoso As Integer, opt As String) As Double

Dim vlMtoPensionAct, vlMtoPensionGar As Double
    
    flBuscarPensionActual = 0
    
'    vlSql = "SELECT mto_pension, mto_pensiongar FROM pp_tmae_pensionact a"
'    vlSql = vlSql & " WHERE a.num_poliza = '" & iNumPoliza & "'"
'    vlSql = vlSql & " AND a.num_endoso = " & inumendoso
'    vlSql = vlSql & " AND a.fec_desde = "
'    vlSql = vlSql & " (SELECT max(fec_desde) FROM pp_tmae_pensionact b"
'    vlSql = vlSql & " WHERE b.num_poliza = a.num_poliza"
'    'vlSql = vlSql & " AND b.num_endoso = a.num_endoso"
'    vlSql = vlSql & " and b.num_endoso = a.num_endoso )" '(SELECT MAX (num_endoso) as numero "
'    'vlSql = vlSql & "FROM pp_tmae_poliza "
'    'vlSql = vlSql & "WHERE num_poliza = b.num_poliza) "
'    'vlSql = vlSql & " AND b.fec_desde < '" & Format(vgFecIniPag, "yyyymmdd") & "')"
'
'    vlSql = "SELECT"
'    vlSql = vlSql & " nvl(a.mto_pension, b.mto_pension) as mto_pension,"
'    vlSql = vlSql & " nvl(a.Mto_PensionGar, b.Mto_PensionGar) As mto_Pensiongar"
'    vlSql = vlSql & " FROM pp_tmae_pensionact a"
'    vlSql = vlSql & " full join pp_tmae_poliza b on a.num_poliza=b.num_poliza and a.num_endoso=b.num_endoso"
'    vlSql = vlSql & " WHERE b.num_poliza = '" & iNumPoliza & "'"
'    vlSql = vlSql & " AND b.num_endoso = " & inumendoso
'    vlSql = vlSql & " and fec_desde=(select max(fec_desde) from pp_tmae_pensionact where num_poliza=a.num_poliza)"
    'vlSql = vlSql & " group by b.mto_pension, b.mto_pensiongar"
    
    vlSql = "SELECT nvl(a.mto_pension, b.mto_pension) as mto_pension, nvl(a.Mto_PensionGar, b.Mto_PensionGar) As mto_Pensiongar"
    vlSql = vlSql & " FROM pp_tmae_pensionact a"
    vlSql = vlSql & " left join pp_tmae_poliza b on a.num_poliza=b.num_poliza"
    vlSql = vlSql & " WHERE b.num_poliza = '" & iNumPoliza & "'"
    vlSql = vlSql & " AND b.num_endoso = (select max(num_endoso) from pp_tmae_poliza where num_poliza=a.num_poliza)"
    vlSql = vlSql & " and fec_desde=(select max(fec_desde) from pp_tmae_pensionact where num_poliza=a.num_poliza)"
    
    Set vlRegistro = vgConexionBD.Execute(vlSql)
    If Not vlRegistro.EOF Then
        vlMtoPensionAct = vlRegistro!Mto_Pension
        vlMtoPensionGar = vlRegistro!Mto_PensionGar
    Else
        vlSql = "SELECT a.mto_pension as mto_pension, a.Mto_PensionGar as mto_Pensiongar"
        vlSql = vlSql & " FROM pp_tmae_poliza a"
        vlSql = vlSql & " WHERE a.num_poliza = '" & iNumPoliza & "'"
        vlSql = vlSql & " AND a.num_endoso = (select max(num_endoso) from pp_tmae_poliza where num_poliza=a.num_poliza)"
        Set vlRegistro = vgConexionBD.Execute(vlSql)
        If Not vlRegistro.EOF Then
            vlMtoPensionAct = vlRegistro!Mto_Pension
            vlMtoPensionGar = vlRegistro!Mto_PensionGar
        End If
    End If
    vlRegistro.Close
    
    If opt = "O" Then
         flBuscarPensionActual = vlMtoPensionAct
    Else
         flBuscarPensionActual = vlMtoPensionGar
    End If
    

End Function


Private Sub txtNumctaBen_KeyPress(KeyAscii As Integer)
Dim KeyChar As String
If KeyAscii > 31 Then
    KeyChar = Chr(KeyAscii)
    If Not IsNumeric(KeyChar) Then
        KeyAscii = 0
    End If
End If
End Sub

'Implementacion GobiernoDeDatos(Metodos y funciones necesarias para el envio al servicio de gestor)
Public Function EnviarGestorCliente(MsgRespuesta As String, operacion As String) As Boolean
On Error GoTo Err_ServicioGestor
Dim texto  As String
Dim RutaServicio  As String
Dim JsonRequest As String
Dim httpURL As Object
Dim Jsonresponse As String
Dim ObjResp As Object
Dim CodResponse As String
Dim MsgResponse As String


Set httpURL = CreateObject("WinHttp.WinHttpRequest.5.1")


    If operacion = "Validar" Then
    'RutaServicio = "http://10.10.1.51/WSGClientesDesarrollo/Api/Cliente/ValidarCliente"
    'RutaServicio = "https://soatservicios.protectasecurity.pe/WSGestorCliente/Api/Cliente/ValidarCliente"
    RutaServicio = "http://10.10.1.58/WSGestorCliente/Api/Cliente/ValidarCliente"
    Else
    'RutaServicio = "http://10.10.1.51/WSGClientesDesarrollo/Api/Cliente/GestionarCliente"
    'RutaServicio = "https://soatservicios.protectasecurity.pe/WSGestorCliente/Api/Cliente/GestionarCliente"
    RutaServicio = "http://10.10.1.58/WSGestorCliente/Api/Cliente/GestionarCliente"
    End If

'Arma la estructura JSON a enviar
JsonRequest = CreateJSON

 httpURL.Open "POST", RutaServicio, False
 httpURL.SetRequestHeader "Content-Type", "application/json"
 httpURL.Send JsonRequest
 Jsonresponse = httpURL.ResponseText
  
'Serializa los objetos de respuesta_
 Set ObjResp = JSON.parse(Jsonresponse)
 MsgResponse = ObjResp.Item("P_SMESSAGE")
 CodResponse = ObjResp.Item("P_NCODE")
 MsgRespuesta = MsgResponse
If CodResponse = "1" Then
EnviarGestorCliente = False
Else
EnviarGestorCliente = True
End If

Exit Function
Err_ServicioGestor:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Private Function CreateJSON() As String
'indice2_
Dim texto As String
'JSON DATOS CLIENTE_


If vlCodDireccion > 0 Then
fgBuscarCodigos (vlCodDireccion)
End If

Dim TipoEnd As String
TipoEnd = Mid(Cmb_EndTipoEnd, 1, 1)
Dim CodEnd As String
CodEnd = Trim(Mid(Cmb_EndCauEnd.Text, 1, vlNumero - 1))


Dim prueba As String
            
        If vlFecNacBen <> "" Then
        vlFecNacBen = ChangeFechaFormat(vlFecNacBen)
        End If
        
        texto = "{" + _
        "p_CodAplicacion : 'SEACSA', " + _
        "p_TipOper : 'INS', " + _
        "P_NUSERCODE : '" + vgUsuario + "', " + _
        "P_NIDDOC_TYPE : '" + vlCodTipoIdenBen + "', " + _
        "P_SIDDOC : '" + vlNumIdenBen + "', " + _
        "P_SFIRSTNAME : '" + UCase(Trim(vlNomBen & " " & vlNomSegBen)) + "', " + _
        "P_SLASTNAME : '" + vlPaternoBen + "', " + _
        "P_SLASTNAME2 : '" + vlMaternoBen + "', " + _
        "P_SLEGALNAME : '" + vlNomBen + "', " + _
        "P_SSEXCLIEN : '" + vlCodSexo + "', " + _
        "P_NINCAPACITY : '" + vlCodSitInv + "', " + _
        "P_DBIRTHDAT : '" + vlFecNacBen + "', "
        
        
        texto = texto + _
        "p_DINCAPACITY : '" + vlFecInvBen + "', " + _
        "p_DWEDD : '" + "" + "', " + _
        "P_NSPECIALITY : '99', " + _
        "P_NCIVILSTA : '" + "" + "', " + _
        "P_NTITLE : '99', " + _
        "P_NAFP : '" + vlCodPar + "', " + _
        "P_NNATIONALITY : '" + "1" + "', " + _
                "P_SBAJAMAIL_IND  : '" + IIf(Trim(vl_ConUsoDatosCom_Ben) = "1", "1", "2") + "', " + _
        "P_SPROTEG_DATOS_IND  : '" + IIf(Trim(vl_ConTratDatos_Ben) = "1", "1", "2") + "', " + _
        "P_SISCLIENT_IND : '1', " + _
        "P_SISRENIEC_IND : '2' , "
        ' "P_SPOLIZA_ELECT_IND : '1', " +
        ' "P_SPROTEG_DATOS_IND : '1', " + _
        ' "P_COD_CUSPP : '123456789012', " + _

       
'JSON DATOS DIRECCION _

If (CodEnd = "15" Or CodEnd = "27") Then

    texto = texto + "EListAddresClient : [ "
    
    
    If stPolizaBenDirecOri(vlPos).pTipoVia <> pTipoVia Or stPolizaBenDirecOri(vlPos).pConcatDirec <> vlGlsDirBen Or stPolizaBenDirecOri(vlPos).Cod_Direccion <> vlCodDireccion Then
      Dim pvCodComuna As String
    Dim pvCodProvincia As String
    Dim pvCodRegion As String
    If (stPolizaBenDirecOri(vlPos).Cod_Direccion <> "") Then
    Call fgBuscarCodigosResponse(stPolizaBenDirecOri(vlPos).Cod_Direccion, pvCodComuna, pvCodProvincia, pvCodRegion)
    End If
    
     texto = texto + _
         "{" + _
         "P_TIPOPER : 'DEL', " + _
         "P_SRECTYPE : '2', " + _
         "P_NCOUNTRY : '1', " + _
         "P_NPROVINCE : '" + pvCodRegion + "', " + _
         "P_NLOCAL : '" + pvCodProvincia + "', " + _
         "P_NMUNICIPALITY : '" + pvCodComuna + "', " + _
         "P_STI_DIRE : '" + stPolizaBenDirecOri(vlPos).pTipoVia + "', " + _
         "P_SNOM_DIRECCION : '" + IIf(stPolizaBenDirecOri(vlPos).pvalEndosoGS = "1", stPolizaBenDirecOri(vlPos).pDireccion, stPolizaBenDirecOri(vlPos).pConcatDirec) + "', " + _
         "P_SNUM_DIRECCION : '" + stPolizaBenDirecOri(vlPos).pNumero + "', " + _
         "P_STI_BLOCKCHALET : '" + stPolizaBenDirecOri(vlPos).pTipoBlock + "', " + _
         "P_SBLOCKCHALET : '" + stPolizaBenDirecOri(vlPos).pNumBlock + "', " + _
         "P_STI_INTERIOR : '" + stPolizaBenDirecOri(vlPos).pTipoPref + "', " + _
         "P_SNUM_INTERIOR : '" + stPolizaBenDirecOri(vlPos).pInterior + "', " + _
         "P_STI_CJHT : '" + stPolizaBenDirecOri(vlPos).pTipoConj + "', " + _
         "P_SNOM_CJHT : '" + stPolizaBenDirecOri(vlPos).pConjHabit + "', " + _
         "P_SETAPA  : '" + stPolizaBenDirecOri(vlPos).pEtapa + "', " + _
         "P_SMANZANA : '" + stPolizaBenDirecOri(vlPos).pManzana + "', " + _
         "P_SLOTE : '" + stPolizaBenDirecOri(vlPos).pLote + "', " + _
         "P_SREFERENCIA : '" + stPolizaBenDirecOri(vlPos).pReferencia + "'" + _
         "},"
    
    End If
         
    If Trim(vlGlsDirBen) <> "" Then
    
    texto = texto + _
         "{" + _
         "P_SRECTYPE : '2', " + _
         "P_NCOUNTRY : '1', " + _
         "P_NPROVINCE : '" + codRegion + "', " + _
         "P_NLOCAL : '" + codProvincia + "', " + _
         "P_NMUNICIPALITY : '" + codComuna + "', " + _
         "P_STI_DIRE : '" + pTipoVia + "', " + _
         "P_SNOM_DIRECCION : '" + pDireccion + "', " + _
         "P_SNUM_DIRECCION : '" + pNumero + "', " + _
         "P_STI_BLOCKCHALET : '" + pTipoBlock + "', " + _
         "P_SBLOCKCHALET : '" + pNumBlock + "', " + _
         "P_STI_INTERIOR : '" + pTipoPref + "', " + _
         "P_SNUM_INTERIOR : '" + pInterior + "', " + _
         "P_STI_CJHT : '" + pTipoConj + "', " + _
         "P_SNOM_CJHT : '" + pConjHabit + "', " + _
         "P_SETAPA  : '" + pEtapa + "', " + _
         "P_SMANZANA : '" + pManzana + "', " + _
         "P_SLOTE : '" + pLote + "', " + _
         "P_SREFERENCIA : '" + pReferencia + "'" + _
         "}"
         
     Else
     texto = Mid(texto, 1, Len(texto) - 1)
    End If
    texto = texto + "],"
End If
'JSON DATOS TELEFONO_
If (CodEnd = "16" Or CodEnd = "27") Then

  texto = texto + " EListPhoneClient : [ "
        
        If stPolizaBenDirecOri(vlPos).Gls_FonoBen <> pNumTelefono Then
        texto = texto + _
        "{" + _
        "P_TIPOPER : 'DEL', " + _
        "P_NAREA_CODE : '" + stPolizaBenDirecOri(vlPos).cod_area_fonoben + "', " + _
        "P_SPHONE : '" + stPolizaBenDirecOri(vlPos).Gls_FonoBen + "', " + _
        "P_NPHONE_TYPE : '" + pTipoTelefono + "'" + _
        "},"
        End If
        
        If stPolizaBenDirecOri(vlPos).Gls_Telben2 <> pNumTelefono2 Then
        
        texto = texto + _
        "{" + _
        "P_TIPOPER : 'DEL', " + _
        "P_SPHONE : '" + stPolizaBenDirecOri(vlPos).Gls_Telben2 + "', " + _
        "P_NPHONE_TYPE : '" + pTipoTelefono2 + "'" + _
        "},"
        
        End If
            
        
        If pNumTelefono <> "" Then
        texto = texto + _
        "{" + _
        "P_NAREA_CODE : '" + pCodigoTelefono + "', " + _
        "P_SPHONE : '" + pNumTelefono + "', " + _
        "P_NPHONE_TYPE : '" + pTipoTelefono + "'" + _
        "},"
        End If
        
        If pNumTelefono2 <> "" Then
        texto = texto + _
        "{" + _
        "P_SPHONE : '" + pNumTelefono2 + "', " + _
        "P_NPHONE_TYPE : '" + pTipoTelefono2 + "'" + _
        "}"
        Else
        texto = Mid(texto, 1, Len(texto) - 1)
        End If
        

'JSON DATOS CORREO_
texto = texto + "],"
End If

If (CodEnd = "27") Then
    texto = texto + "EListEmailClient : [ "
    
    If Trim(stPolizaBenDirecOri(vlPos).pGlsCorreo) <> Trim(vlGlsCorreoBen) Then
    texto = texto + _
        "{" + _
        "P_SRECTYPE : '4', " + _
        "P_TIPOPER : 'DEL', " + _
        "P_SE_MAIL : '" + UCase(stPolizaBenDirecOri(vlPos).pGlsCorreo) + "'  " + _
        "},"
    End If
        
    If vlGlsCorreoBen <> "" Then
    texto = texto + _
        "{" + _
        "P_SRECTYPE : '4', " + _
        "P_SE_MAIL : '" + UCase(vlGlsCorreoBen) + "'  " + _
        "}"
    Else
    texto = Mid(texto, 1, Len(texto) - 1)
    End If
    
    
    texto = texto + "],"
End If


'JSON DATOS CONTACTO_
        
If (CodEnd = "16" Or CodEnd = "27") Then
    texto = texto + "EListContactClient : [ "
       
    If vlCodPar = "99" Then
           If Msf_BMGrilla.rows > 1 Then
           
                  Dim TelefonoTitular As String
                  Dim CorreoTitular As String
                  
                  
                  Dim vlPos2 As String
                  vlPos2 = 1
                  
                  Msf_BMGrilla.Col = 0
                  While vlPos2 <= (Msf_BMGrilla.rows - 1)
                       Msf_BMGrilla.row = vlPos2
                       If (flFormatearDatosBeneficiarioDefDirc(Msf_BMGrilla.row) = False) Then
                       Exit Function
                       End If
                       Msf_BMGrilla.Col = 0
                       Call flCargarDatosBeneficiariosModDirec(Msf_BMGrilla.row)
                       
                       If vlCodPar = "99" Then
                       TelefonoTitular = pNumTelefono
                       CorreoTitular = vlGlsCorreoBen
                       End If
                       
                       
                       If vlCodPar <> "99" Then
                       Dim TelefonoContacto As String
                       
                       If pNumTelefono = "" Then
                       TelefonoContacto = pNumTelefono2
                       Else
                       TelefonoContacto = pNumTelefono
                       End If
                       
                       texto = texto + _
                       "{" + _
                       "P_TIPOPER: 'DEL'," + _
                       "P_NTIPCONT : ' " & vlCodPar & "', " + _
                       "P_NIDDOC_TYPE : '" & vlCodTipoIdenBen & "', " + _
                       "P_SIDDOC : '" & vlNumIdenBen & "' " + _
                       "},"
                       
                       
                       texto = texto + _
                       "{" + _
                       "P_NTIPCONT : ' " & vlCodPar & "', " + _
                       "P_NIDDOC_TYPE : '" & vlCodTipoIdenBen & "', " + _
                       "P_SIDDOC : '" & vlNumIdenBen & "', " + _
                       "P_SNOMBRES :'" & vlNomBen & "', " + _
                       "P_SAPEPAT :'" & vlPaternoBen & "', " + _
                       "P_SAPEMAT :'" & vlMaternoBen & "', " + _
                       "P_SE_MAIL :'" & IIf(vlGlsCorreoBen = "", UCase(CorreoTitular), UCase(vlGlsCorreoBen)) & "', " + _
                       "P_SPHONE : '" & IIf(TelefonoContacto = "", TelefonoTitular, TelefonoContacto) & "' " + _
                       "}"
                           If vlPos2 <> Msf_BMGrilla.rows - 1 Then
                           texto = texto + ","
                           End If
                       End If
                    vlPos2 = vlPos2 + 1
                    Wend
           End If
    End If
  texto = texto + "],"
 End If
 texto = texto + _
         "EListCIIUClient : Null " + _
         "}"
Dim valor As Object
Set valor = JSON.parse(texto)
'txtprueba.Text = JSON.toString(valor)
CreateJSON = JSON.toString(valor)
'Set CreateJSON = JSON.tostring(valor)_
End Function

'15052019_
Function flFormatearDatosBeneficiarioDefDirc(iFila As Integer) As Boolean
'*On Error GoTo Err_flFormatearDatosBeneficiarioDef

    flFormatearDatosBeneficiarioDefDirc = False
    vlBenefNuevo = False
    
    Msf_BMGrilla.row = iFila
    
    Msf_BMGrilla.Col = 0
    vlNumOrden = Msf_BMGrilla.Text
    Msf_BMGrilla.Col = 1
    vlCodTipoIdenBen = fgObtenerCodigo_TextoCompuesto(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 2
    vlNumIdenBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 3
    vlNomBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 4
    vlNomSegBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 5
    vlPaternoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 6
    vlMaternoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 7
    vlCodPar = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 8
    vlCodGruFam = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 9
    vlCodSexo = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 10
    vlCodSitInv = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 11
    vlCodDerpen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 12
    vlCodDerCre = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 13
    vlNumPoliza = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 14
    vlNumEndoso = (Msf_BMGrilla + 1)
    Msf_BMGrilla.Col = 15
    vlCodCauInv = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 16
    vlFecNacBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Msf_BMGrilla.Col = 17
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecNacHM = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecNacHM = ""
    End If
    Msf_BMGrilla.Col = 18
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecInvBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecInvBen = ""
    End If
    
  
    
    Msf_BMGrilla.Col = 21
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecFallBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecFallBen = ""
    End If
    Msf_BMGrilla.Col = 22
    vlCodEstPension = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 23
    vlCodMotReqPen = Trim(Msf_BMGrilla.Text)
  
    Msf_BMGrilla.Col = 25
    vlCodCauSusBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 26
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecSusBen = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecSusBen = ""
    End If
    Msf_BMGrilla.Col = 27
    vlFecIniPagoPen = Format(Trim(Msf_BMGrilla.Text), "yyyymmdd")
    Msf_BMGrilla.Col = 28
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecTerPagoPenGar = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecTerPagoPenGar = ""
    End If
    Msf_BMGrilla.Col = 29
    If (Trim(Msf_BMGrilla.Text) <> "") Then
        vlFecMatrimonio = Format(CDate(Msf_BMGrilla.Text), "yyyymmdd")
    Else
        vlFecMatrimonio = ""
    End If
    
    ' Obtiene el Pension gar
    Msf_BMGrilla.Col = 30
    vlPrcPensionGar = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 24
    vlMtoPensionGarB = Format(CDbl(vlMtoPensionGar) * (vlPrcPensionGar / 100), "###0.00") ' Trim(Msf_BMGrilla.Text)
    '*************
    
    ' Obtiene Pension
    Msf_BMGrilla.Col = 20
    vlPrcPension = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 19
    vlMtoPensionB = Format(CDbl(vlMtoPension) * (vlPrcPension / 100), "###0.00")  'Trim(Msf_BMGrilla.Text)
    '*******************
    
    Msf_BMGrilla.Col = 31
    vlPrcPensionLeg = (Msf_BMGrilla.Text)
    
    'Variables a completar, de acuerdo a si se trata de un nvo.
    'Beneficiario o uno ya existente
    'vlCodDireccion = ""
    'vlGlsDirBen = ""
    'vlGlsFonoBen = ""
    'vlGlsCorreoBen = ""
    '
    'vlCodInsSalud = ""
    'vlCodModSalud = ""
    'vlMtoPlanSalud = 0
    '
    'vlCodViaPago = ""
    'vlCodBanco = ""
    'vlCodTipCuenta = ""
    'vlNumCuenta = ""
    'vlCodSucursal = ""
    'vlCodCajaCompen = ""
    
    Msf_BMGrilla.Col = 32
    vlCodDireccion = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 33
    vlGlsDirBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 34
    vlGlsFonoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 35
    vlGlsCorreoBen = Trim(Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 36
    vlGlsTelben2 = Trim(Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 37
    vlCodBanco = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 38
    vlCodTipcta = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 39
    vlcodmonbco = (Msf_BMGrilla.Text)
    Msf_BMGrilla.Col = 40
    vlnumctabco = (Msf_BMGrilla.Text)
    'mvg 20170904
    Msf_BMGrilla.Col = 41
    vlBolelec = (Msf_BMGrilla.Text)
    
    Msf_BMGrilla.Col = 43
    vlCodViaPago = (Msf_BMGrilla.Text)
                
    Msf_BMGrilla.Col = 44
    vlCodSucursal = (Msf_BMGrilla.Text)
     
    Msf_BMGrilla.Col = 45
    vl_ConTratDatos_Ben = (Msf_BMGrilla.Text)
     
    Msf_BMGrilla.Col = 46
    vl_ConUsoDatosCom_Ben = (Msf_BMGrilla.Text)
    
      
    vlCodInsSalud = vlDefCodInsSalud
    vlCodModSalud = vlDefCodModSalud
    vlMtoPlanSalud = vlDefMtoPlanSalud
    
    'vlCodViaPago = vlDefCodViaPago
    'vlcodbanco = vlDefCodBanco
    'vlCodTipCuenta = vlDefCodTipCuenta
    'vlNumCuenta = vlDefNumCuenta
    'vlCodSucursal = vlDefCodSucursal
    vlCodCajaCompen = vlDefCodCajaCompen
    
    'Verificar si se trata de un nuevo Beneficiario para asignarles los valores por defecto
    'o si se deben obtener los datos del Beneficiario desde el Endoso anterior
    
    
    flFormatearDatosBeneficiarioDefDirc = True
    
Exit Function
Err_flFormatearDatosBeneficiarioDef:
    Screen.MousePointer = 0
    Select Case Err
        Case Else
        MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
    End Select
End Function

Private Function ChangeFechaFormat(ByVal fecha As String) As String
Dim dia As String
Dim mes As String
Dim Periodo As String
If fecha <> "" Then
dia = Mid(fecha, 7, 2)
mes = Mid(fecha, 5, 2)
Periodo = Mid(fecha, 1, 4)
ChangeFechaFormat = dia & "-" & mes & "-" & Periodo
Else
ChangeFechaFormat = fecha
End If
End Function

Function fgBuscarCodigos(vlCodDir As String) As String
Dim vlRegistroDir As ADODB.Recordset
On Error GoTo Err_Buscar
     
    vgSql = "SELECT c.cod_comuna,c.cod_provincia,c.cod_region  "
    vgSql = vgSql & " FROM MA_TPAR_COMUNA c "
    vgSql = vgSql & " Where c.Cod_Direccion = '" & vlCodDir & "'"
    
    Set vlRegistroDir = vgConexionBD.Execute(vgSql)
    If Not vlRegistroDir.EOF Then
       codComuna = (vlRegistroDir!cod_comuna)
       codProvincia = (vlRegistroDir!cod_provincia)
       codRegion = (vlRegistroDir!cod_region)
    End If
    vlRegistroDir.Close
Exit Function
Err_Buscar:
   Screen.MousePointer = 0
   Select Case Err
       Case Else
       MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
   End Select
End Function


Function fgBuscarCodigosResponse(vlCodDir As String, pvCodComuna As String, pvCodProvincia As String, pvCodRegion As String) As String
Dim vlRegistroDir As ADODB.Recordset
On Error GoTo Err_Buscar
     
    vgSql = "SELECT c.cod_comuna,c.cod_provincia,c.cod_region  "
    vgSql = vgSql & " FROM MA_TPAR_COMUNA c "
    vgSql = vgSql & " Where c.Cod_Direccion = '" & vlCodDir & "'"
    
    Set vlRegistroDir = vgConexionBD.Execute(vgSql)
    If Not vlRegistroDir.EOF Then
       pvCodComuna = (vlRegistroDir!cod_comuna)
       pvCodProvincia = (vlRegistroDir!cod_provincia)
       pvCodRegion = (vlRegistroDir!cod_region)
    End If
    vlRegistroDir.Close
Exit Function
Err_Buscar:
   Screen.MousePointer = 0
   Select Case Err
       Case Else
       MsgBox "Error Grave [ " & Err & Space(4) & Err.Description & " ]", vbCritical, "¡ERROR!..."
   End Select
End Function

'Fin Implementacion GobiernoDeDatos()_


Private Sub Ins_causa_preliminar(ByVal pnum_poliza As String, _
                      ByVal pnum_endoso As Integer, _
                      ByVal pCOD_CAUENDOSO As String, _
                      ByVal pnum_orden As Integer, _
                      ByVal pCOD_CAUSINIESTRO As String)

On Error GoTo GestionError

       Dim conn    As ADODB.Connection
       Dim RS As ADODB.Recordset
       Set conn = New ADODB.Connection
       Set RS = New ADODB.Recordset ' CreateObject("ADODB.Recordset")
       
       Dim param1 As ADODB.Parameter
       Dim param2 As ADODB.Parameter
       Dim param3 As ADODB.Parameter
       Dim param4 As ADODB.Parameter
       Dim param5 As ADODB.Parameter
       Dim param6 As ADODB.Parameter
       Dim param7 As ADODB.Parameter
       Dim param8 As ADODB.Parameter
                
       
       Set objCmd = New ADODB.Command ' CreateObject("ADODB.Command")

       conn.Provider = "OraOLEDB.Oracle"
       conn.ConnectionString = "PLSQLRSet=1;Data Source=" & vgNombreBaseDatos & ";" & "User ID=" & vgNombreUsuario & ";Password=" & vgPassWord & ";"
       conn.CursorLocation = adUseClient
       conn.Open
       
       Set objCmd = CreateObject("ADODB.Command")
       Set objCmd.ActiveConnection = conn
       
       objCmd.CommandText = "PKG_CauSiniestro.Ins_CodCausa_preliminar"
       objCmd.CommandType = adCmdStoredProc
       
         Set param1 = objCmd.CreateParameter("pNUM_POLIZA", adVarChar, adParamInput, 10, pnum_poliza)
        objCmd.Parameters.Append param1
                
        Set param2 = objCmd.CreateParameter("pNUM_ENDOSO", adInteger, adParamInput, 3, pnum_endoso)
        objCmd.Parameters.Append param2
        
        Set param3 = objCmd.CreateParameter("pCOD_CAUENDOSO", adVarChar, adParamInput, 5, pCOD_CAUENDOSO)
        objCmd.Parameters.Append param3
        
        Set param4 = objCmd.CreateParameter("pNUM_ORDEN", adInteger, adParamInput, 2, pnum_orden)
        objCmd.Parameters.Append param4
        
        Set param5 = objCmd.CreateParameter("pCOD_CAUSINIESTRO", adVarChar, adParamInput, 5, pCOD_CAUSINIESTRO)
        objCmd.Parameters.Append param5
        
        Set param6 = objCmd.CreateParameter("pCOD_USUARIO", adVarChar, adParamInput, 10, vgUsuario)
        objCmd.Parameters.Append param6
        
        Set param7 = objCmd.CreateParameter("p_outNumError", adDouble, adParamOutput)
        objCmd.Parameters.Append param7
        
        Set param8 = objCmd.CreateParameter("p_outMsgError", adVarChar, adParamOutput, 200)
        objCmd.Parameters.Append param8
        
                           
        Set RS = objCmd.Execute
        
        If Not IsNull(objCmd.Parameters.Item("p_outMsgError").Value) Then
          Mensaje = objCmd.Parameters.Item("p_outMsgError").Value
            Err.Raise -2222, "Ins_Causa", Mensaje
        Else
          Mensaje = ""
        End If
   
       
        conn.Close
        Set objCmd = Nothing
        Set RS = Nothing
        Set conn = Nothing
        
        Exit Sub
        
  
GestionError:
    
    MsgBox "Se ha producido un error. Tipo de error = " & Err.Number & ". Descripción: " & Err.Description, vbCritical
    

End Sub
Private Sub Ins_causa_Final(ByVal pnum_poliza As String, _
                      ByVal pnum_endoso As Integer)

On Error GoTo GestionError

       Dim conn    As ADODB.Connection
       Dim RS As ADODB.Recordset
       Set conn = New ADODB.Connection
       Set RS = New ADODB.Recordset ' CreateObject("ADODB.Recordset")
       
       Dim param1 As ADODB.Parameter
       Dim param2 As ADODB.Parameter
       Dim param3 As ADODB.Parameter
       Dim param4 As ADODB.Parameter
   
       
       Set objCmd = New ADODB.Command ' CreateObject("ADODB.Command")

       conn.Provider = "OraOLEDB.Oracle"
       conn.ConnectionString = "PLSQLRSet=1;Data Source=" & vgNombreBaseDatos & ";" & "User ID=" & vgNombreUsuario & ";Password=" & vgPassWord & ";"
       conn.CursorLocation = adUseClient
       conn.Open
       
       Set objCmd = CreateObject("ADODB.Command")
       Set objCmd.ActiveConnection = conn
       
       objCmd.CommandText = "PKG_CauSiniestro.Ins_CodCausa_Final"
       objCmd.CommandType = adCmdStoredProc
       
        Set param1 = objCmd.CreateParameter("pNUM_POLIZA", adVarChar, adParamInput, 10, pnum_poliza)
        objCmd.Parameters.Append param1
                
        Set param2 = objCmd.CreateParameter("pNUM_ENDOSO", adInteger, adParamInput, 3, pnum_endoso)
        objCmd.Parameters.Append param2
     
        Set param7 = objCmd.CreateParameter("p_outNumError", adDouble, adParamOutput)
        objCmd.Parameters.Append param7
        
        Set param8 = objCmd.CreateParameter("p_outMsgError", adVarChar, adParamOutput, 200)
        objCmd.Parameters.Append param8
           
        Set RS = objCmd.Execute
        
        If Not IsNull(objCmd.Parameters.Item("p_outMsgError").Value) Then
          Mensaje = objCmd.Parameters.Item("p_outMsgError").Value
            Err.Raise -2222, "Ins_Causa", Mensaje
        Else
          Mensaje = ""
        End If
   
       
        conn.Close
        Set objCmd = Nothing
        Set RS = Nothing
        Set conn = Nothing
        
        Exit Sub
        
  
GestionError:
    
    MsgBox "Se ha producido un error. Tipo de error = " & Err.Number & ". Descripción: " & Err.Description, vbCritical
    

End Sub




